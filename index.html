<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blocks</title>
  <link rel="stylesheet" href="/src/style.css">
</head>
<body>
  <div id="app">
    <canvas id="viewport"></canvas>

    <!-- Top Menu Bar -->
    <div id="menubar">
      <button id="btn-new" title="New Project">New</button>
      <button id="btn-save" title="Save Project">Save</button>
      <button id="btn-load" title="Load Project">Load</button>
      <button id="btn-clear" title="Clear All">Clear</button>
      <span class="separator"></span>
      <button id="btn-templates" title="Browse Templates">Templates</button>
      <span class="separator"></span>
      <button id="btn-export" title="Export GLTF/GLB">Export</button>
      <button id="btn-bake" title="Bake Lighting">Bake Light</button>
      <button id="btn-clear-bake" title="Clear Baked Lighting">Clear Bake</button>
      <span class="separator"></span>
      <button id="btn-undo" title="Undo (Ctrl+Z)">Undo</button>
      <button id="btn-redo" title="Redo (Ctrl+Y)">Redo</button>
      <span class="separator"></span>
      <button id="btn-toggle-timeline" title="Toggle Timeline">Timeline</button>
      <span class="separator"></span>
      <button id="btn-vj" title="VJ Mode (Audio Reactive)">VJ</button>
      <span class="separator"></span>
      <button id="btn-toggle-panel" title="Toggle Right Panel (P)" class="panel-toggle active">Panel</button>
      <span class="separator"></span>
      <button id="btn-about" title="About">About</button>
    </div>

    <!-- Left Toolbar -->
    <div id="toolbar">
      <div class="toolbar-section" id="tools-section">
        <span class="section-label">Tools</span>
        <div class="tools-grid">
          <button class="tool active" data-tool="place" title="Place Block (1)">
            <span>+</span>
          </button>
          <button class="tool" data-tool="delete" title="Delete Block (2)">
            <span>‚àí</span>
          </button>
          <button class="tool" data-tool="select" title="Select (3)">
            <span>‚óª</span>
          </button>
          <button class="tool" data-tool="paint" title="Paint (4)">
            <span>üñå</span>
          </button>
          <button class="tool" data-tool="pick" title="Pick Color (5)">
            <span>üíâ</span>
          </button>
          <button class="tool" data-tool="shape" title="Shape Brush (6)">
            <span>‚óç</span>
          </button>
          <button class="tool" data-tool="scatter" title="Generative Scatter (7)">
            <span>‚ú¶</span>
          </button>
        </div>
      </div>

      <div class="toolbar-section" id="paint-section" style="display: none;">
        <span class="section-label">Paint Mode</span>
        <div class="paint-options">
          <button class="paint-mode active" data-mode="face" title="Paint single face">Face</button>
          <button class="paint-mode" data-mode="block" title="Paint entire block">Block</button>
        </div>
      </div>

      <div class="toolbar-section" id="shape-section" style="display: none;">
        <span class="section-label">Shape Brush</span>
        <div class="shape-grid">
          <button class="shape-type active" data-shape="sphere" title="Sphere">‚óè</button>
          <button class="shape-type" data-shape="cube" title="Filled Cube">‚ñ†</button>
          <button class="shape-type" data-shape="hollowCube" title="Hollow Cube">‚ñ°</button>
          <button class="shape-type" data-shape="cylinder" title="Cylinder">‚óØ</button>
          <button class="shape-type" data-shape="disc" title="Disc">‚óâ</button>
          <button class="shape-type" data-shape="circle" title="Circle">‚óã</button>
          <button class="shape-type" data-shape="dome" title="Dome">‚ó†</button>
          <button class="shape-type" data-shape="line3d" title="3D Line">‚ï±</button>
          <button class="shape-type" data-shape="wall" title="Wall">‚ñ≠</button>
        </div>
      </div>

      <div class="toolbar-section" id="scatter-section" style="display: none;">
        <span class="section-label">Scatter</span>
        <div class="scatter-row">
          <label>Preset:</label>
          <select id="scatter-preset"></select>
        </div>
        <div class="scatter-row">
          <label>Algorithm:</label>
          <select id="scatter-algorithm"></select>
        </div>
        <div class="scatter-row">
          <label>Count:</label>
          <input type="range" id="scatter-count" min="10" max="200" value="50">
          <span id="scatter-count-val">50</span>
        </div>
        <div class="scatter-row">
          <label>Branch:</label>
          <input type="range" id="scatter-branch" min="0" max="0.5" step="0.05" value="0.2">
          <span id="scatter-branch-val">20%</span>
        </div>
        <div class="scatter-row">
          <label>Scale Mix:</label>
          <input type="range" id="scatter-scale-ratio" min="0" max="1" step="0.1" value="0.8">
          <span id="scatter-scale-ratio-val">80% 1√ó</span>
        </div>
        <div class="scatter-row">
          <label>Colors:</label>
          <select id="scatter-harmony">
            <option value="analogous">Analogous</option>
            <option value="complementary">Complementary</option>
            <option value="triadic">Triadic</option>
            <option value="monochrome">Monochrome</option>
            <option value="split">Split</option>
          </select>
        </div>
        <div class="scatter-hint">Click to generate from point</div>
      </div>

      <!-- Block Palette - dynamically generated -->
      <div class="toolbar-section">
        <span class="section-label">Blocks</span>
        <input type="text" id="block-search" placeholder="Search blocks..." autocomplete="off">
      </div>
      <div id="block-palette"></div>

      <div class="toolbar-section">
        <span class="section-label">Transform</span>
        <button id="btn-rotate" title="Rotate 90¬∞ (R)">‚Üª</button>
        <div class="scale-toggle">
          <button id="btn-scale-1x" class="scale-btn active" title="Normal blocks (1x1)">1√ó</button>
          <button id="btn-scale-2x" class="scale-btn" title="Large blocks (2x2)">2√ó</button>
          <button id="btn-scale-4x" class="scale-btn" title="Extra large blocks (4x4)">4√ó</button>
          <button id="btn-scale-6x" class="scale-btn" title="Huge blocks (6x6)">6√ó</button>
          <button id="btn-scale-8x" class="scale-btn" title="Massive blocks (8x8)">8√ó</button>
        </div>
      </div>

      <div class="toolbar-section">
        <span class="section-label">Mirror Selected</span>
        <div class="mirror-buttons">
          <button id="btn-mirror-x" class="mirror-btn" title="Mirror across X axis">X</button>
          <button id="btn-mirror-y" class="mirror-btn" title="Mirror across Y axis">Y</button>
          <button id="btn-mirror-z" class="mirror-btn" title="Mirror across Z axis">Z</button>
        </div>
      </div>
    </div>

    <!-- Right Panel - Colors & Properties -->
    <div id="right-panel">
      <div class="panel-section collapsible" data-section="view">
        <div class="section-header collapsible-header">
          <span class="section-label">View</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="section-content">
        <div class="view-row">
          <input type="checkbox" id="show-edges" checked>
          <label for="show-edges">Show Edges</label>
        </div>
        <div class="view-row">
          <label>Edge Opacity:</label>
          <input type="range" id="edge-opacity" min="0.1" max="1" step="0.1" value="0.3">
        </div>
        </div>
      </div>

      <!-- Placement Options -->
      <div class="panel-section collapsible" data-section="placement">
        <div class="section-header collapsible-header">
          <span class="section-label">Placement</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="section-content">
        <div class="view-row">
          <input type="checkbox" id="free-placement">
          <label for="free-placement">Free Placement (Allow Overlap)</label>
        </div>
        <div class="view-row">
          <label>Grid Snap:</label>
          <select id="grid-snap-increment">
            <option value="1.0" selected>1.0 (Standard)</option>
            <option value="0.5">0.5 (Half Grid)</option>
            <option value="0.25">0.25 (Quarter Grid)</option>
            <option value="0">Off (Free)</option>
          </select>
        </div>
        </div>
      </div>

      <!-- Stylized Render Mode -->
      <div class="panel-section collapsible" id="tattoo-section" data-section="stylized">
        <div class="section-header collapsible-header">
          <span class="section-label">Stylized Render</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="section-content">
        <div class="tattoo-row">
          <input type="checkbox" id="tattoo-enabled">
          <label for="tattoo-enabled">Enable Stylized View</label>
        </div>
        <div class="tattoo-row">
          <input type="checkbox" id="gpu-acceleration" checked>
          <label for="gpu-acceleration">GPU Acceleration</label>
        </div>
        <div class="tattoo-row">
          <label>Style:</label>
          <select id="render-style">
            <option value="clean">Clean</option>
            <option value="saturated">Saturated</option>
            <option value="sketch">Sketch</option>
            <option value="ink">Ink</option>
            <option value="crosshatch">Cross-Hatch</option>
            <option value="blueprint">Blueprint</option>
            <option value="comic">Comic</option>
            <option value="neon">Neon / Tron</option>
            <option value="scifi">Sci-Fi</option>
            <option value="watercolor">Watercolor</option>
            <option value="noir">Noir</option>
            <option value="synthwave">Synthwave</option>
            <option value="ascii">ASCII Art</option>
          </select>
        </div>
        <div class="tattoo-row">
          <input type="checkbox" id="tattoo-inverted">
          <label for="tattoo-inverted">Invert Colors</label>
        </div>
        <div class="tattoo-row">
          <input type="checkbox" id="tattoo-grayscale">
          <label for="tattoo-grayscale">Grayscale</label>
        </div>
        <div class="tattoo-row">
          <input type="checkbox" id="tattoo-fills" checked>
          <label for="tattoo-fills">Show Fills</label>
        </div>
        <div class="tattoo-row">
          <label>Quality:</label>
          <select id="render-quality">
            <option value="low">Low (Fast)</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High (Slow)</option>
          </select>
        </div>
        <div class="tattoo-row">
          <label>Threshold:</label>
          <input type="range" id="tattoo-threshold" min="0" max="1" step="0.05" value="0.5">
          <span id="tattoo-threshold-val">0.5</span>
        </div>
        <div class="tattoo-row">
          <label>Line Width:</label>
          <input type="range" id="tattoo-line-width" min="1" max="8" step="0.5" value="2">
          <span id="tattoo-line-width-val">2</span>
        </div>
        <div class="tattoo-actions">
          <button id="btn-tattoo-png" title="Save as PNG">Save PNG</button>
          <button id="btn-tattoo-svg" title="Export as SVG">Export SVG</button>
        </div>
        <div class="tattoo-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button id="btn-flatten" title="Merge touching blocks into single meshes" style="width: 100%;">Flatten Blocks</button>
        </div>
        </div>
      </div>

      <div class="panel-section collapsible" data-section="camera">
        <div class="section-header collapsible-header">
          <span class="section-label">Camera Presets</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="section-content">
        <div class="camera-presets">
          <button class="preset-btn" data-preset="front" title="Front View">F</button>
          <button class="preset-btn" data-preset="back" title="Back View">B</button>
          <button class="preset-btn" data-preset="left" title="Left View">L</button>
          <button class="preset-btn" data-preset="right" title="Right View">R</button>
          <button class="preset-btn" data-preset="top" title="Top View">T</button>
          <button class="preset-btn" data-preset="iso" title="Isometric View">3D</button>
        </div>
        <div class="bookmark-controls">
          <button id="btn-save-view" title="Save current view">Save View</button>
        </div>
        <div id="camera-bookmarks"></div>
        </div>
      </div>

      <div class="panel-section collapsible" data-section="camera-anim">
        <div class="section-header collapsible-header">
          <span class="section-label">Camera Animation</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="section-content">
        <div style="margin-bottom: 8px; font-size: 11px; opacity: 0.7;">
          Save 2+ camera views above, then render animation
        </div>
        <div class="prop-row" style="margin-bottom: 8px;">
          <label>Frames:</label>
          <input type="number" id="camera-anim-frames" value="300" min="10" max="3600" step="10" style="width: 80px;">
        </div>
        <div class="prop-row" style="margin-bottom: 8px;">
          <label>FPS:</label>
          <input type="number" id="camera-anim-fps" value="30" min="15" max="60" step="5" style="width: 60px;">
          <span id="camera-anim-duration" style="margin-left: 8px; font-size: 11px; opacity: 0.7;">10.0s</span>
        </div>
        <div class="prop-row" style="margin-bottom: 8px;">
          <label>Curve:</label>
          <select id="camera-anim-curve" style="flex: 1;">
            <option value="linear">Linear</option>
            <option value="easeInOut" selected>Ease In-Out</option>
            <option value="easeIn">Ease In</option>
            <option value="easeOut">Ease Out</option>
            <option value="smoothstep">Smoothstep</option>
          </select>
        </div>
        <button id="btn-camera-preview" style="width: 100%; margin-bottom: 8px;">Preview Animation</button>
        <button id="btn-camera-export-jpg" style="width: 100%; margin-bottom: 4px;">Export JPG Sequence (ZIP)</button>
        <button id="btn-camera-export-mp4" style="width: 100%;">Export as Video (WebM)</button>
        <div id="camera-anim-progress" style="display: none; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px;">
          <div style="font-size: 11px; margin-bottom: 4px;">Rendering frames...</div>
          <div style="background: rgba(255,255,255,0.1); height: 20px; border-radius: 4px; overflow: hidden;">
            <div id="camera-anim-progress-bar" style="background: #5588cc; height: 100%; width: 0%; transition: width 0.2s;"></div>
          </div>
          <div id="camera-anim-progress-text" style="font-size: 11px; margin-top: 4px; text-align: center;">0%</div>
        </div>
        </div>
      </div>

      <div class="panel-section collapsible" data-section="color">
        <div class="section-header collapsible-header">
          <span class="section-label">Color</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="section-content">
        <div id="color-picker">
          <input type="color" id="current-color" value="#5588cc">
        </div>
        <div id="color-palette"></div>
        </div>
      </div>

      <div class="panel-section collapsible" data-section="emissive">
        <div class="section-header collapsible-header">
          <span class="section-label">Emissive (Glow)</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="section-content">
        <div class="emissive-row">
          <input type="checkbox" id="emissive-enabled">
          <label for="emissive-enabled">Enable Glow</label>
        </div>
        <div class="emissive-row">
          <label>Color:</label>
          <input type="color" id="emissive-color" value="#ffaa00">
        </div>
        <div class="emissive-row">
          <label>Intensity:</label>
          <input type="range" id="emissive-intensity" min="0.1" max="5" step="0.1" value="1">
          <span id="emissive-intensity-val">1.0</span>
        </div>
        <div class="emissive-row">
          <label>Radius:</label>
          <input type="range" id="emissive-radius" min="1" max="10" step="0.5" value="3">
          <span id="emissive-radius-val">3.0</span>
        </div>
        </div>
      </div>

      <!-- Layer Panel -->
      <div class="panel-section collapsible" id="layers-section" data-section="layers">
        <div class="section-header collapsible-header">
          <span class="section-label">Layers</span>
          <span class="collapse-icon">‚ñº</span>
          <button id="btn-add-layer" title="Add Layer">+</button>
        </div>
        <div class="section-content">
        <div id="layer-list"></div>
        </div>
      </div>

      <div class="panel-section collapsible" id="selection-props" data-section="selection" style="display: none;">
        <div class="section-header collapsible-header">
          <span class="section-label">Selected Block</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="section-content">
        <div class="prop-row">
          <label>Type:</label>
          <span id="prop-type">-</span>
        </div>
        <div class="prop-row">
          <label>Position:</label>
          <span id="prop-position">-</span>
        </div>
        <div class="prop-row">
          <label>Rotation:</label>
          <span id="prop-rotation">-</span>
        </div>
        <div class="move-controls">
          <span class="section-label">Move (Arrow Keys)</span>
          <div class="move-grid">
            <button class="move-btn" data-dir="up" title="Move +Z">&#9650;</button>
            <button class="move-btn" data-dir="left" title="Move -X">&#9664;</button>
            <button class="move-btn" data-dir="down" title="Move -Z">&#9660;</button>
            <button class="move-btn" data-dir="right" title="Move +X">&#9654;</button>
          </div>
          <div class="move-vertical">
            <button class="move-btn" data-dir="raise" title="Move +Y (PgUp)">+Y</button>
            <button class="move-btn" data-dir="lower" title="Move -Y (PgDn)">-Y</button>
          </div>
        </div>
        <div class="prop-actions">
          <button id="btn-copy" title="Copy (Ctrl+C)">Copy</button>
          <button id="btn-delete-sel" title="Delete (Del)">Delete</button>
        </div>
        </div>
      </div>
    </div>

    <!-- Bottom Timeline -->
    <div id="timeline-panel">
      <div id="timeline-controls">
        <button id="btn-add-anim" title="New Animation">+ Anim</button>
        <button id="btn-delete-anim" title="Delete Animation">√ó Anim</button>
        <select id="anim-select">
          <option value="">-- No Animation --</option>
        </select>
        <button id="btn-play" title="Play/Pause (Space)">‚ñ∂</button>
        <button id="btn-stop" title="Stop">‚ñ†</button>
        <span id="time-display">0.00s</span>
        <label class="timeline-label">Duration:</label>
        <input type="number" id="anim-duration" value="2000" min="100" max="60000" step="100" title="Duration in ms">
        <label class="timeline-label">Speed:</label>
        <select id="anim-speed" title="Playback Speed">
          <option value="0.25">0.25x</option>
          <option value="0.5">0.5x</option>
          <option value="1" selected>1x</option>
          <option value="2">2x</option>
          <option value="4">4x</option>
        </select>
        <label class="timeline-label">Curve:</label>
        <select id="anim-curve" title="Interpolation Curve">
          <option value="linear">Linear</option>
          <option value="easeInOut" selected>Ease In-Out</option>
          <option value="easeIn">Ease In</option>
          <option value="easeOut">Ease Out</option>
          <option value="smoothstep">Smoothstep</option>
        </select>
        <input type="checkbox" id="anim-loop">
        <label for="anim-loop">Loop</label>
      </div>
      <div id="timeline-track">
        <div id="timeline-scrubber"></div>
        <div id="keyframes-container"></div>
        <input type="range" id="timeline-slider" min="0" max="2000" value="0">
      </div>
      <div id="timeline-actions">
        <button id="btn-add-keyframe" title="Add Keyframe (+/=/K)">+ Key</button>
        <button id="btn-remove-keyframe" title="Remove Keyframe (-)">- Key</button>
      </div>
    </div>

    <!-- Status Bar -->
    <div id="info">
      <span id="grid-pos">Grid: 0, 0, 0</span>
      <span id="block-count">Blocks: 0</span>
      <span id="tool-hint">Left-click: place | Shift+click: fill line/rect | Middle-click: delete | Right-drag: rotate | Shift+Right-drag: pan | Scroll: zoom | U: hide UI</span>
    </div>

    <!-- Hidden file input for loading -->
    <input type="file" id="file-input" accept=".blocks,.json" style="display: none;">

    <!-- VJ Panel -->
    <div id="vj-panel" style="display: none;">
      <div class="panel-section">
        <span class="section-label">VJ Mode</span>
        <div class="vj-row">
          <label>Preset:</label>
          <select id="vj-preset">
            <option value="chill">Chill</option>
            <option value="hard" selected>Hard</option>
            <option value="psychedelic">Psychedelic</option>
            <option value="trippy">Trippy</option>
          </select>
        </div>
        <div class="vj-row">
          <label>Camera:</label>
          <select id="vj-camera-mode">
            <option value="orbit">Orbit</option>
            <option value="drift">Drift</option>
            <option value="lock">Lock</option>
            <option value="rail">Rail</option>
            <option value="chaos">Chaos</option>
            <option value="still">Still (Calm)</option>
            <option value="follow">Follow Paint</option>
          </select>
        </div>
      </div>
      <div class="panel-section">
        <span class="section-label">Audio</span>
        <div class="vj-row">
          <label>Gain:</label>
          <input type="range" id="vj-gain" min="0" max="3" step="0.1" value="1">
        </div>
        <div class="vj-row">
          <label>Sensitivity:</label>
          <input type="range" id="vj-sensitivity" min="0.1" max="3" step="0.1" value="1">
        </div>
        <div id="vj-meter">
          <div id="vj-meter-bar"></div>
        </div>
      </div>
      <div class="panel-section">
        <span class="section-label">Distortion</span>
        <div class="vj-row">
          <label>Block:</label>
          <input type="range" id="vj-block-distort" min="0" max="1" step="0.05" value="0.5">
          <span id="vj-block-distort-val">0.5</span>
        </div>
        <div class="vj-row">
          <label>Vertex:</label>
          <input type="range" id="vj-vertex-distort" min="0" max="1" step="0.05" value="0.5">
          <span id="vj-vertex-distort-val">0.5</span>
        </div>
        <div class="vj-row">
          <label>Move:</label>
          <select id="vj-movement-mode">
            <option value="bounce">Bounce</option>
            <option value="jump">Jump</option>
            <option value="wave">Wave</option>
            <option value="scatter">Scatter</option>
          </select>
        </div>
        <div class="vj-row">
          <label>Color:</label>
          <input type="range" id="vj-color-react" min="0" max="1" step="0.05" value="0.5">
          <span id="vj-color-react-val">0.5</span>
        </div>
      </div>
      <div class="panel-section">
        <span class="section-label">Reactivity</span>
        <div class="vj-row">
          <label>Master:</label>
          <input type="range" id="vj-reactivity" min="0.1" max="3" step="0.1" value="1">
          <span id="vj-reactivity-val">1.0</span>
        </div>
      </div>
      <div class="panel-section">
        <span class="section-label">Post Effects</span>
        <div class="vj-row" style="flex-wrap: wrap; gap: 4px;">
          <label style="flex: 0 0 100%; margin-bottom: 4px; font-weight: bold;">Enable:</label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-bloom">
            <span>Bloom</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-feedback">
            <span>Feedback</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-chromatic">
            <span>Chromatic</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-glitch">
            <span>Glitch</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-hueshift">
            <span>Hue Shift</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-vignette">
            <span>Vignette</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-kaleidoscope">
            <span>Kaleidoscope</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-mirror">
            <span>Mirror</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-pixelate">
            <span>Pixelate</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-rgbsplit">
            <span>RGB Split</span>
          </label>
          <label style="flex: 0 0 48%; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vj-effect-invert">
            <span>Invert</span>
          </label>
        </div>
        <div class="vj-row">
          <label>Bloom:</label>
          <input type="range" id="vj-bloom-strength" min="0" max="3" step="0.1" value="0" disabled>
          <span id="vj-bloom-val">0.0</span>
        </div>
        <div class="vj-row">
          <label>Feedback:</label>
          <input type="range" id="vj-feedback-amount" min="0" max="1" step="0.05" value="0" disabled>
          <span id="vj-feedback-val">0.0</span>
        </div>
        <div class="vj-row">
          <label>Kaleidoscope:</label>
          <input type="range" id="vj-kaleidoscope-segments" min="3" max="12" step="1" value="6" disabled>
          <span id="vj-kaleidoscope-val">6</span>
        </div>
        <div class="vj-row">
          <label>Pixelate:</label>
          <input type="range" id="vj-pixelate-size" min="1" max="20" step="1" value="1" disabled>
          <span id="vj-pixelate-val">1</span>
        </div>
      </div>
      <div class="panel-section">
        <span class="section-label">Scenes</span>
        <div class="vj-row">
          <label id="vj-scene-label">No scenes</label>
          <input type="file" id="vj-scene-folder" webkitdirectory style="display:none">
          <button id="vj-load-scenes" title="Load folder of .blocks files">Load</button>
        </div>
        <div class="vj-row">
          <button id="vj-scene-prev" title="Previous scene (B)">&#9664;</button>
          <span id="vj-scene-index" style="flex:1; text-align:center;">-</span>
          <button id="vj-scene-next" title="Next scene (N)">&#9654;</button>
        </div>
      </div>
      <div class="panel-section">
        <span class="section-label">Audio Spawn Blocks</span>
        <div class="vj-row">
          <label>Spawn:</label>
          <input type="checkbox" id="vj-block-spawn-enabled">
          <label style="margin-left:4px">Rate:</label>
          <input type="range" id="vj-block-spawn-rate" min="1" max="10" step="1" value="3" disabled>
          <span id="vj-block-spawn-rate-val">3</span>
        </div>
        <div class="vj-row">
          <label>Radius:</label>
          <input type="range" id="vj-block-spawn-radius" min="5" max="30" step="1" value="8" disabled>
          <span id="vj-block-spawn-radius-val">8</span>
        </div>
      </div>
      <div class="panel-section">
        <span class="section-label">Generative (X)</span>
        <div class="vj-row">
          <label>Grow:</label>
          <input type="checkbox" id="vj-generative-enabled">
          <button id="vj-generative-clear" title="Clear generated blocks">Clear</button>
        </div>
        <div class="vj-row">
          <label>Rate:</label>
          <input type="range" id="vj-gen-rate" min="1" max="8" step="1" value="3">
          <span id="vj-gen-rate-val">3</span>
        </div>
        <div class="vj-row">
          <label>TTL:</label>
          <input type="range" id="vj-gen-ttl" min="5" max="60" step="5" value="20">
          <span id="vj-gen-ttl-val">20s</span>
        </div>
      </div>
      <div class="panel-section">
        <span class="section-label">Color Reactivity (K)</span>
        <div class="vj-row">
          <label>Enable:</label>
          <input type="checkbox" id="vj-color-reactivity">
          <span style="margin-left: 8px; font-size: 0.9em; opacity: 0.7;">All blocks react to audio</span>
        </div>
      </div>
      <div class="panel-section">
        <span class="section-label">Generative Paint (G)</span>
        <div class="vj-row">
          <label>Enable:</label>
          <input type="checkbox" id="vj-paint-enabled">
        </div>
        <div class="vj-row">
          <label>Blocks/Beat:</label>
          <input type="range" id="vj-paint-density" min="3" max="30" step="1" value="10" disabled>
          <span id="vj-paint-density-val">10</span>
        </div>
        <div class="vj-row">
          <label>Preset:</label>
          <select id="vj-paint-preset" disabled>
            <option value="pipes">Pipes</option>
            <option value="cables">Cables</option>
            <option value="rocks">Rocks</option>
            <option value="crystals">Crystals</option>
            <option value="trees">Trees</option>
            <option value="alien">Alien</option>
            <option value="fusion">Fusion</option>
          </select>
        </div>
        <div class="vj-row">
          <label>Algorithm:</label>
          <select id="vj-paint-algorithm" disabled>
            <option value="walk">Random Walk</option>
            <option value="cluster">Cluster</option>
            <option value="spiral">Spiral</option>
            <option value="crystal">Crystal</option>
            <option value="wave">Wave</option>
            <option value="drunk">Drunkard</option>
            <option value="tree">Tree</option>
            <option value="vine">Vine</option>
          </select>
        </div>
        <div class="vj-row">
          <label>Lifetime:</label>
          <input type="range" id="vj-paint-lifetime" min="10" max="120" step="10" value="30" disabled>
          <span id="vj-paint-lifetime-val">30s</span>
        </div>
        <div class="vj-row">
          <label>Decay:</label>
          <select id="vj-paint-decay" disabled>
            <option value="fadeAndShrink">Fade & Shrink</option>
            <option value="floatUp">Float Up</option>
            <option value="dissolve">Dissolve</option>
            <option value="shrink">Shrink Only</option>
            <option value="fade">Fade Only</option>
          </select>
        </div>
      </div>
      <div class="panel-section">
        <button id="vj-fullscreen" style="width: 100%; padding: 6px; cursor: pointer;">Fullscreen (F)</button>
      </div>
    </div>

    <!-- VJ Performance Overlay (shown in fullscreen mode) -->
    <div id="vj-overlay" style="display: none;">
      <div id="vj-overlay-top">
        <span id="vj-style-name">clean</span>
        <span id="vj-camera-name">orbit</span>
        <span id="vj-preset-name">hard</span>
      </div>
      <div id="vj-overlay-meter">
        <div id="vj-overlay-meter-bar"></div>
      </div>
      <div id="vj-message"></div>
      <button id="vj-exit-fullscreen">EXIT</button>
    </div>

    <!-- Toast notifications container -->
    <div id="notifications"></div>

    <!-- Splash Screen -->
    <div id="splash-screen" class="splash-screen">
      <div class="splash-content">
        <div class="splash-logo">BLOCKS</div>
        <div class="splash-subtitle">3D Block Editor & VJ Tool</div>
        <div class="splash-version">PRE-ALPHA</div>
        <div class="splash-credits">
          <p>Developed by <strong>svdk / CrashServer</strong></p>
          <p><a href="https://crashserver.fr" target="_blank" rel="noopener">crashserver.fr</a></p>
        </div>
        <button class="splash-button" id="splash-continue">Click to Start</button>
        <div class="splash-footer">
          Press <kbd>H</kbd> to toggle UI ¬∑ Press <kbd>U</kbd> to hide UI
        </div>
      </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal" style="display: none;">
      <div class="modal-content about-modal-content">
        <div class="modal-header">
          <h3>About Blocks</h3>
          <button class="modal-close" id="about-modal-close">&times;</button>
        </div>
        <div class="modal-body about-modal-body">
          <div class="about-logo">BLOCKS</div>
          <div class="about-version">Version PRE-ALPHA</div>

          <div class="about-section">
            <h4>Developer</h4>
            <p><strong>svdk / CrashServer</strong></p>
            <p><a href="https://crashserver.fr" target="_blank" rel="noopener">crashserver.fr</a></p>
          </div>

          <div class="about-section">
            <h4>Description</h4>
            <p>A 3D block editor with GPU-accelerated stylized rendering, animation system, and audio-reactive VJ mode.</p>
          </div>

          <div class="about-section">
            <h4>Tech Stack</h4>
            <ul>
              <li>Three.js v0.170 - 3D rendering</li>
              <li>Vite v6 - Build system</li>
              <li>WebGL shaders - GPU effects</li>
              <li>Web Audio API - VJ audio reactivity</li>
            </ul>
          </div>

          <div class="about-section">
            <h4>Status</h4>
            <p>This software is in <strong>pre-alpha</strong> development. Features are experimental and subject to change.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Templates Modal -->
    <div id="templates-modal" class="modal" style="display: none;">
      <div class="modal-content templates-modal-content">
        <div class="modal-header">
          <h3>Templates</h3>
          <button class="modal-close" id="templates-modal-close">&times;</button>
        </div>
        <div class="modal-body" id="templates-list">
          <!-- Categories will be dynamically populated -->
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Export Settings</h3>
          <button class="modal-close" id="export-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="export-section">
            <span class="section-label">Format</span>
            <div class="export-row">
              <label>
                <input type="radio" name="export-format" value="glb" checked>
                GLB (Binary)
              </label>
              <label>
                <input type="radio" name="export-format" value="gltf">
                GLTF (JSON)
              </label>
            </div>
          </div>

          <div class="export-section">
            <span class="section-label">Optimization</span>
            <div class="export-row">
              <input type="checkbox" id="opt-face-cull" checked>
              <label for="opt-face-cull">Cull hidden faces</label>
              <span class="hint">Remove faces between adjacent blocks</span>
            </div>
            <div class="export-row">
              <input type="checkbox" id="opt-merge-cubes" checked>
              <label for="opt-merge-cubes">Merge adjacent cubes</label>
              <span class="hint">Combine same-color cubes into larger meshes</span>
            </div>
            <div class="export-row">
              <input type="checkbox" id="opt-material-batch" checked>
              <label for="opt-material-batch">Batch by material</label>
              <span class="hint">Group geometry by color for fewer draw calls</span>
            </div>
            <div class="export-row">
              <input type="checkbox" id="opt-deduplicate" checked>
              <label for="opt-deduplicate">Deduplicate vertices</label>
              <span class="hint">Merge duplicate vertices to reduce mesh size</span>
            </div>
            <div class="export-row">
              <input type="checkbox" id="opt-merge-all">
              <label for="opt-merge-all">Merge all into single mesh</label>
              <span class="hint">Combine everything using vertex colors (1 draw call)</span>
            </div>
            <div class="export-row">
              <input type="checkbox" id="opt-instancing">
              <label for="opt-instancing">Use GPU instancing</label>
              <span class="hint">Best for scenes with many identical block types</span>
            </div>
          </div>

          <div class="export-section">
            <span class="section-label">Include</span>
            <div class="export-row">
              <input type="checkbox" id="inc-animations" checked>
              <label for="inc-animations">Animations</label>
            </div>
            <div class="export-row">
              <input type="checkbox" id="inc-baked-lighting">
              <label for="inc-baked-lighting">Baked lighting texture</label>
              <span class="hint">Include lightmap if baked</span>
            </div>
          </div>

          <div class="export-section">
            <span class="section-label">Debug Exports</span>
            <div class="export-row">
              <input type="checkbox" id="dbg-lightmap">
              <label for="dbg-lightmap">Export lightmap PNG</label>
            </div>
            <div class="export-row">
              <input type="checkbox" id="dbg-colors">
              <label for="dbg-colors">Export debug colors PNG</label>
            </div>
            <div class="export-row">
              <input type="checkbox" id="dbg-palette">
              <label for="dbg-palette">Export color palette PNG</label>
            </div>
            <div class="export-row">
              <input type="checkbox" id="dbg-json">
              <label for="dbg-json">Also export GLTF JSON</label>
              <span class="hint">For debugging structure</span>
            </div>
          </div>

          <div class="export-stats" id="export-stats">
            <span class="section-label">Statistics</span>
            <div class="stats-row">
              <span>Blocks:</span>
              <span id="stat-blocks">0</span>
            </div>
            <div class="stats-row">
              <span>Estimated faces:</span>
              <span id="stat-faces">0</span>
            </div>
            <div class="stats-row">
              <span>After optimization:</span>
              <span id="stat-optimized">0</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="export-cancel">Cancel</button>
          <button id="export-confirm" class="primary">Export</button>
        </div>
      </div>
    </div>
  </div>
  <script type="module" src="/src/main.js"></script>
</body>
</html>
