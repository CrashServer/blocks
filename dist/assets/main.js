var br=Object.defineProperty;var zr=(y,t,e)=>t in y?br(y,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):y[t]=e;var Xe=(y,t,e)=>zr(y,typeof t!="symbol"?t+"":t,e);import{C as vr,V as U,M as ae,T as Ke,Q as Ne,S as Ms,a as nt,R as mi,P as xi,b as gt,c as ri,d as ot,e as jn,W as Fr,f as wr,g as kr,A as Br,D as Cr,H as Ar,G as ps,h as Mr,i as gi,j as Ae,k as Dt,B as le,L as to,l as eo,m as kt,n as Er,o as ai,E as Fo,p as _r,q as oo,r as io,s as Yn,t as Ao,u as Es,v as hs,w as Sr,N as me,x as ys,y as Rt,z as Ot,F as us,I as wi,J as Tr,K as Dr,O as ds,U as li,X as Pr,Y as Ir,Z as Rr,_ as wo,$ as Lr,a0 as Or,a1 as Nr,a2 as Ur,a3 as Xr,a4 as Zr,a5 as _t,a6 as bi,a7 as Gn,a8 as ko,a9 as $n,aa as jr,ab as fs,ac as Yr,ad as Gr,ae as $r,af as Vn,ag as Vr,ah as Je,ai as ci,aj as Ce,ak as Qo,al as Hr,am as Wr,an as qr,ao as Kr,ap as Jr,aq as Qr,ar as ta,as as ea,at as oa,au as ia,av as sa,aw as se,ax as Kt,ay as jt,az as na,aA as _s,aB as Ue,aC as Ss}from"./BlockTypes.js";const Ts={type:"change"},ms={type:"start"},Hn={type:"end"},Mo=new mi,Ds=new xi,ra=Math.cos(70*gt.DEG2RAD),Ct=new U,Zt=2*Math.PI,ut={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},ki=1e-6;class aa extends vr{constructor(t,e=null){super(t,e),this.state=ut.NONE,this.enabled=!0,this.target=new U,this.cursor=new U,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:ae.ROTATE,MIDDLE:ae.DOLLY,RIGHT:ae.PAN},this.touches={ONE:Ke.ROTATE,TWO:Ke.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new U,this._lastQuaternion=new Ne,this._lastTargetPosition=new U,this._quat=new Ne().setFromUnitVectors(t.up,new U(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new Ms,this._sphericalDelta=new Ms,this._scale=1,this._panOffset=new U,this._rotateStart=new nt,this._rotateEnd=new nt,this._rotateDelta=new nt,this._panStart=new nt,this._panEnd=new nt,this._panDelta=new nt,this._dollyStart=new nt,this._dollyEnd=new nt,this._dollyDelta=new nt,this._dollyDirection=new U,this._mouse=new nt,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=ca.bind(this),this._onPointerDown=la.bind(this),this._onPointerUp=pa.bind(this),this._onContextMenu=xa.bind(this),this._onMouseWheel=ua.bind(this),this._onKeyDown=da.bind(this),this._onTouchStart=fa.bind(this),this._onTouchMove=ma.bind(this),this._onMouseDown=ha.bind(this),this._onMouseMove=ya.bind(this),this._interceptControlDown=ga.bind(this),this._interceptControlUp=ba.bind(this),this.domElement!==null&&this.connect(),this.update()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(t){t.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=t}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(Ts),this.update(),this.state=ut.NONE}update(t=null){const e=this.object.position;Ct.copy(e).sub(this.target),Ct.applyQuaternion(this._quat),this._spherical.setFromVector3(Ct),this.autoRotate&&this.state===ut.NONE&&this._rotateLeft(this._getAutoRotationAngle(t)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let o=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(o)&&isFinite(i)&&(o<-Math.PI?o+=Zt:o>Math.PI&&(o-=Zt),i<-Math.PI?i+=Zt:i>Math.PI&&(i-=Zt),o<=i?this._spherical.theta=Math.max(o,Math.min(i,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(o+i)/2?Math.max(o,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let s=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const n=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),s=n!=this._spherical.radius}if(Ct.setFromSpherical(this._spherical),Ct.applyQuaternion(this._quatInverse),e.copy(this.target).add(Ct),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let n=null;if(this.object.isPerspectiveCamera){const r=Ct.length();n=this._clampDistance(r*this._scale);const a=r-n;this.object.position.addScaledVector(this._dollyDirection,a),this.object.updateMatrixWorld(),s=!!a}else if(this.object.isOrthographicCamera){const r=new U(this._mouse.x,this._mouse.y,0);r.unproject(this.object);const a=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),s=a!==this.object.zoom;const l=new U(this._mouse.x,this._mouse.y,0);l.unproject(this.object),this.object.position.sub(l).add(r),this.object.updateMatrixWorld(),n=Ct.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;n!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(n).add(this.object.position):(Mo.origin.copy(this.object.position),Mo.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(Mo.direction))<ra?this.object.lookAt(this.target):(Ds.setFromNormalAndCoplanarPoint(this.object.up,this.target),Mo.intersectPlane(Ds,this.target))))}else if(this.object.isOrthographicCamera){const n=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),n!==this.object.zoom&&(this.object.updateProjectionMatrix(),s=!0)}return this._scale=1,this._performCursorZoom=!1,s||this._lastPosition.distanceToSquared(this.object.position)>ki||8*(1-this._lastQuaternion.dot(this.object.quaternion))>ki||this._lastTargetPosition.distanceToSquared(this.target)>ki?(this.dispatchEvent(Ts),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(t){return t!==null?Zt/60*this.autoRotateSpeed*t:Zt/60/60*this.autoRotateSpeed}_getZoomScale(t){const e=Math.abs(t*.01);return Math.pow(.95,this.zoomSpeed*e)}_rotateLeft(t){this._sphericalDelta.theta-=t}_rotateUp(t){this._sphericalDelta.phi-=t}_panLeft(t,e){Ct.setFromMatrixColumn(e,0),Ct.multiplyScalar(-t),this._panOffset.add(Ct)}_panUp(t,e){this.screenSpacePanning===!0?Ct.setFromMatrixColumn(e,1):(Ct.setFromMatrixColumn(e,0),Ct.crossVectors(this.object.up,Ct)),Ct.multiplyScalar(t),this._panOffset.add(Ct)}_pan(t,e){const o=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;Ct.copy(i).sub(this.target);let s=Ct.length();s*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*t*s/o.clientHeight,this.object.matrix),this._panUp(2*e*s/o.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(t*(this.object.right-this.object.left)/this.object.zoom/o.clientWidth,this.object.matrix),this._panUp(e*(this.object.top-this.object.bottom)/this.object.zoom/o.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(t,e){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const o=this.domElement.getBoundingClientRect(),i=t-o.left,s=e-o.top,n=o.width,r=o.height;this._mouse.x=i/n*2-1,this._mouse.y=-(s/r)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(t){return Math.max(this.minDistance,Math.min(this.maxDistance,t))}_handleMouseDownRotate(t){this._rotateStart.set(t.clientX,t.clientY)}_handleMouseDownDolly(t){this._updateZoomParameters(t.clientX,t.clientX),this._dollyStart.set(t.clientX,t.clientY)}_handleMouseDownPan(t){this._panStart.set(t.clientX,t.clientY)}_handleMouseMoveRotate(t){this._rotateEnd.set(t.clientX,t.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const e=this.domElement;this._rotateLeft(Zt*this._rotateDelta.x/e.clientHeight),this._rotateUp(Zt*this._rotateDelta.y/e.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(t){this._dollyEnd.set(t.clientX,t.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(t){this._panEnd.set(t.clientX,t.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(t){this._updateZoomParameters(t.clientX,t.clientY),t.deltaY<0?this._dollyIn(this._getZoomScale(t.deltaY)):t.deltaY>0&&this._dollyOut(this._getZoomScale(t.deltaY)),this.update()}_handleKeyDown(t){let e=!1;switch(t.code){case this.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateUp(Zt*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,this.keyPanSpeed),e=!0;break;case this.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateUp(-Zt*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,-this.keyPanSpeed),e=!0;break;case this.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateLeft(Zt*this.rotateSpeed/this.domElement.clientHeight):this._pan(this.keyPanSpeed,0),e=!0;break;case this.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateLeft(-Zt*this.rotateSpeed/this.domElement.clientHeight):this._pan(-this.keyPanSpeed,0),e=!0;break}e&&(t.preventDefault(),this.update())}_handleTouchStartRotate(t){if(this._pointers.length===1)this._rotateStart.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),o=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);this._rotateStart.set(o,i)}}_handleTouchStartPan(t){if(this._pointers.length===1)this._panStart.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),o=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);this._panStart.set(o,i)}}_handleTouchStartDolly(t){const e=this._getSecondPointerPosition(t),o=t.pageX-e.x,i=t.pageY-e.y,s=Math.sqrt(o*o+i*i);this._dollyStart.set(0,s)}_handleTouchStartDollyPan(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enablePan&&this._handleTouchStartPan(t)}_handleTouchStartDollyRotate(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enableRotate&&this._handleTouchStartRotate(t)}_handleTouchMoveRotate(t){if(this._pointers.length==1)this._rotateEnd.set(t.pageX,t.pageY);else{const o=this._getSecondPointerPosition(t),i=.5*(t.pageX+o.x),s=.5*(t.pageY+o.y);this._rotateEnd.set(i,s)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const e=this.domElement;this._rotateLeft(Zt*this._rotateDelta.x/e.clientHeight),this._rotateUp(Zt*this._rotateDelta.y/e.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(t){if(this._pointers.length===1)this._panEnd.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),o=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);this._panEnd.set(o,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(t){const e=this._getSecondPointerPosition(t),o=t.pageX-e.x,i=t.pageY-e.y,s=Math.sqrt(o*o+i*i);this._dollyEnd.set(0,s),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const n=(t.pageX+e.x)*.5,r=(t.pageY+e.y)*.5;this._updateZoomParameters(n,r)}_handleTouchMoveDollyPan(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enablePan&&this._handleTouchMovePan(t)}_handleTouchMoveDollyRotate(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enableRotate&&this._handleTouchMoveRotate(t)}_addPointer(t){this._pointers.push(t.pointerId)}_removePointer(t){delete this._pointerPositions[t.pointerId];for(let e=0;e<this._pointers.length;e++)if(this._pointers[e]==t.pointerId){this._pointers.splice(e,1);return}}_isTrackingPointer(t){for(let e=0;e<this._pointers.length;e++)if(this._pointers[e]==t.pointerId)return!0;return!1}_trackPointer(t){let e=this._pointerPositions[t.pointerId];e===void 0&&(e=new nt,this._pointerPositions[t.pointerId]=e),e.set(t.pageX,t.pageY)}_getSecondPointerPosition(t){const e=t.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[e]}_customWheelEvent(t){const e=t.deltaMode,o={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(e){case 1:o.deltaY*=16;break;case 2:o.deltaY*=100;break}return t.ctrlKey&&!this._controlActive&&(o.deltaY*=10),o}}function la(y){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(y.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(y)&&(this._addPointer(y),y.pointerType==="touch"?this._onTouchStart(y):this._onMouseDown(y)))}function ca(y){this.enabled!==!1&&(y.pointerType==="touch"?this._onTouchMove(y):this._onMouseMove(y))}function pa(y){switch(this._removePointer(y),this._pointers.length){case 0:this.domElement.releasePointerCapture(y.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(Hn),this.state=ut.NONE;break;case 1:const t=this._pointers[0],e=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:e.x,pageY:e.y});break}}function ha(y){let t;switch(y.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case ae.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(y),this.state=ut.DOLLY;break;case ae.ROTATE:if(y.ctrlKey||y.metaKey||y.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(y),this.state=ut.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(y),this.state=ut.ROTATE}break;case ae.PAN:if(y.ctrlKey||y.metaKey||y.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(y),this.state=ut.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(y),this.state=ut.PAN}break;default:this.state=ut.NONE}this.state!==ut.NONE&&this.dispatchEvent(ms)}function ya(y){switch(this.state){case ut.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(y);break;case ut.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(y);break;case ut.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(y);break}}function ua(y){this.enabled===!1||this.enableZoom===!1||this.state!==ut.NONE||(y.preventDefault(),this.dispatchEvent(ms),this._handleMouseWheel(this._customWheelEvent(y)),this.dispatchEvent(Hn))}function da(y){this.enabled===!1||this.enablePan===!1||this._handleKeyDown(y)}function fa(y){switch(this._trackPointer(y),this._pointers.length){case 1:switch(this.touches.ONE){case Ke.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(y),this.state=ut.TOUCH_ROTATE;break;case Ke.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(y),this.state=ut.TOUCH_PAN;break;default:this.state=ut.NONE}break;case 2:switch(this.touches.TWO){case Ke.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(y),this.state=ut.TOUCH_DOLLY_PAN;break;case Ke.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(y),this.state=ut.TOUCH_DOLLY_ROTATE;break;default:this.state=ut.NONE}break;default:this.state=ut.NONE}this.state!==ut.NONE&&this.dispatchEvent(ms)}function ma(y){switch(this._trackPointer(y),this.state){case ut.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(y),this.update();break;case ut.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(y),this.update();break;case ut.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(y),this.update();break;case ut.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(y),this.update();break;default:this.state=ut.NONE}}function xa(y){this.enabled!==!1&&y.preventDefault()}function ga(y){y.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function ba(y){y.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}class za{constructor(t){Xe(this,"animate",()=>{requestAnimationFrame(this.animate);const t=this.clock.getDelta();this.controls.update(),this.onUpdate&&this.onUpdate(t),this.onVJUpdate&&this.onVJUpdate(t),this.customRender?this.customRender():this.renderer.render(this.scene,this.camera)});this.canvas=t,this.scene=new ri,this.scene.background=new ot(1710638),this.setupRenderer(),this.setupCamera(),this.setupLights(),this.setupControls(),this.clock=new jn,this.onUpdate=null,this.onVJUpdate=null,this.customRender=null,window.addEventListener("resize",()=>this.onResize()),this.onResize()}setupRenderer(){this.renderer=new Fr({canvas:this.canvas,antialias:!0}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=wr}setupCamera(){this.camera=new kr(60,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(10,10,10),this.camera.lookAt(0,0,0)}setupLights(){const t=new Br(16777215,.4);this.scene.add(t);const e=new Cr(16777215,.8);e.position.set(10,20,10),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-20,e.shadow.camera.right=20,e.shadow.camera.top=20,e.shadow.camera.bottom=-20,this.scene.add(e);const o=new Ar(8900331,3550502,.3);this.scene.add(o)}setupControls(){this.controls=new aa(this.camera,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.1,this.controls.minDistance=5,this.controls.maxDistance=50,this.controls.maxPolarAngle=Math.PI/2-.05,this.controls.mouseButtons={LEFT:null,MIDDLE:ae.DOLLY,RIGHT:ae.ROTATE},this.controls.enablePan=!0,window.addEventListener("keydown",t=>{t.key==="Shift"&&(this.controls.mouseButtons.RIGHT=ae.PAN)}),window.addEventListener("keyup",t=>{t.key==="Shift"&&(this.controls.mouseButtons.RIGHT=ae.ROTATE)})}onResize(){const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}start(){this.animate()}}class va{constructor(t,e={}){this.scene=t,this.cellSize=e.cellSize||1,this.gridSize=e.gridSize||20,this.gridGroup=new ps,this.gridGroup.name="grid",this.scene.add(this.gridGroup),this.createGridPlane(),this.createMultiLevelGrid()}createGridPlane(){const t=new Mr(this.gridSize*this.cellSize*2,this.gridSize*this.cellSize*2),e=new gi({visible:!1,side:Ae});this.plane=new Dt(t,e),this.plane.rotation.x=-Math.PI/2,this.plane.position.y=0,this.plane.name="gridPlane",this.scene.add(this.plane)}createMultiLevelGrid(){const e=this.gridSize*this.cellSize;this.fineGrid=this.createGridLevel(e,1,3816010,.6),this.fineGrid.position.y=.001,this.gridGroup.add(this.fineGrid),this.mediumGrid=this.createGridLevel(e,5,4868714,.6),this.mediumGrid.position.y=.002,this.gridGroup.add(this.mediumGrid),this.majorGrid=this.createGridLevel(e,10,6974106,.8),this.majorGrid.position.y=.003,this.gridGroup.add(this.majorGrid),this.createOriginAxes(e)}createGridLevel(t,e,o,i){const s=[];for(let a=-t;a<=t;a+=e){const l=e<5&&a%5===0,p=e<10&&a%10===0;l||p||(s.push(new U(-t,0,a)),s.push(new U(t,0,a)),s.push(new U(a,0,-t)),s.push(new U(a,0,t)))}const n=new le().setFromPoints(s),r=new to({color:o,transparent:!0,opacity:i});return new eo(n,r)}createOriginAxes(t){const e=[new U(-t,0,0),new U(t,0,0)],o=new le().setFromPoints(e),i=new to({color:8930372,transparent:!0,opacity:.7});this.xAxis=new eo(o,i),this.xAxis.position.y=.004,this.gridGroup.add(this.xAxis);const s=[new U(0,0,-t),new U(0,0,t)],n=new le().setFromPoints(s),r=new to({color:4473992,transparent:!0,opacity:.7});this.zAxis=new eo(n,r),this.zAxis.position.y=.004,this.gridGroup.add(this.zAxis)}snapToGrid(t){return new U(Math.round(t.x/this.cellSize)*this.cellSize,Math.round(t.y/this.cellSize)*this.cellSize,Math.round(t.z/this.cellSize)*this.cellSize)}worldToGrid(t){return{x:Math.round(t.x/this.cellSize),y:Math.round(t.y/this.cellSize),z:Math.round(t.z/this.cellSize)}}gridToWorld(t){return new U(t.x*this.cellSize,t.y*this.cellSize,t.z*this.cellSize)}getRaycastPlane(){return this.plane}dispose(){this.scene.remove(this.plane),this.scene.remove(this.gridGroup),this.plane.geometry.dispose(),this.plane.material.dispose(),[this.fineGrid,this.mediumGrid,this.majorGrid,this.xAxis,this.zAxis].forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose())})}}const Pe=["east","west","top","bottom","south","north"],Fa={east:0,west:1,top:2,bottom:3,south:4,north:5};class wa{constructor(t){this.textureManager=t,this.selectedFace=null}getFaceFromNormal(t){const e=Math.abs(t.x),o=Math.abs(t.y),i=Math.abs(t.z);return e>o&&e>i?t.x>0?"east":"west":o>e&&o>i?t.y>0?"top":"bottom":t.z>0?"south":"north"}applyMaterialToFace(t,e,o){return Fa[e]===void 0?!1:(t.faces[e]={direction:e,materialId:o,uvRotation:0,uvFlip:{x:!1,y:!1}},this.updateBlockMaterials(t),!0)}applyMaterialToAllFaces(t,e){Pe.forEach(o=>{t.faces[o]={direction:o,materialId:e,uvRotation:0,uvFlip:{x:!1,y:!1}}}),this.updateBlockMaterials(t)}updateBlockMaterials(t){const e=Pe.map(o=>{const i=t.faces[o];if(i&&i.materialId){const s=this.textureManager.createThreeMaterial(i.materialId);if(s)return s}return new kt({color:t.color,roughness:.7,metalness:.1})});Array.isArray(t.mesh.material)?t.mesh.material.forEach(o=>o.dispose()):t.mesh.material&&t.mesh.material.dispose(),t.mesh.material=e}rotateFaceUV(t,e,o=90){const i=t.faces[e];i&&(i.uvRotation=(i.uvRotation+o)%360,this.updateBlockMaterials(t))}flipFaceUV(t,e,o="x"){const i=t.faces[e];i&&(i.uvFlip[o]=!i.uvFlip[o],this.updateBlockMaterials(t))}pickMaterialFromFace(t,e){const o=t.faces[e];return o?o.materialId:null}}let ka=0;class xs{constructor(t={}){this.id=t.id||`block_${++ka}`,this.type=t.type||"cube",this.gridPosition=t.position||{x:0,y:0,z:0},this.dimensions=t.dimensions||{w:1,h:1,d:1},this.rotation=t.rotation||{x:0,y:0,z:0},this.color=t.color||"#5588cc",this.layerId=t.layerId||"default",this.scale=t.scale||1,this.emissive=t.emissive||{enabled:!1,color:"#ffaa00",intensity:1,radius:3},this.faces={},t.faces?Pe.forEach(e=>{t.faces[e]?this.faces[e]={...t.faces[e]}:this.faces[e]={direction:e,materialId:null,color:null,uvRotation:0,uvFlip:{x:!1,y:!1}}}):Pe.forEach(e=>{this.faces[e]={direction:e,materialId:null,color:null,uvRotation:0,uvFlip:{x:!1,y:!1}}}),this.mesh=null,this.light=null,this.createMesh()}createMesh(){const e=(ai[this.type]||ai.cube)(this.dimensions);this.scale>1&&e.scale(this.scale,this.scale,this.scale);const o=e.groups&&e.groups.length===6;let i;o?i=Pe.map(s=>{const n=this.faces[s],r=n&&n.color?n.color:this.color,a=new kt({color:r,roughness:.7,metalness:.1,side:Ae});return this.emissive.enabled&&(a.emissive=new ot(this.emissive.color),a.emissiveIntensity=this.emissive.intensity),a}):(i=new kt({color:this.color,roughness:.7,metalness:.1,side:Ae}),this.emissive.enabled&&(i.emissive=new ot(this.emissive.color),i.emissiveIntensity=this.emissive.intensity)),this.mesh=new Dt(e,i),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.mesh.userData.blockId=this.id,this.mesh.userData.block=this,this.createEdges(e),this.emissive.enabled&&this.createLight(),this.updateTransform()}createEdges(t){const e=new Fo(t,30),o=new to({color:0,transparent:!0,opacity:.3});this.edges=new eo(e,o),this.mesh.add(this.edges)}setEdgesVisible(t){this.edges&&(this.edges.visible=t)}setEdgesOpacity(t){this.edges&&(this.edges.material.opacity=t)}createLight(){this.light&&(this.mesh.remove(this.light),this.light.dispose()),this.light=new _r(new ot(this.emissive.color),this.emissive.intensity*2,this.emissive.radius*2,1),this.light.castShadow=!1,this.mesh.add(this.light)}removeLight(){this.light&&(this.mesh.remove(this.light),this.light.dispose(),this.light=null)}updateTransform(){const t=oo[this.type]||1,e=io[this.type]||0,o=this.dimensions.h*t*this.scale,i=e*this.scale+o/2;this.mesh.position.set(this.gridPosition.x+this.dimensions.w*this.scale/2,this.gridPosition.y+i,this.gridPosition.z+this.dimensions.d*this.scale/2),this.mesh.rotation.set(gt.degToRad(this.rotation.x),gt.degToRad(this.rotation.y),gt.degToRad(this.rotation.z))}setPosition(t){this.gridPosition={...t},this.updateTransform()}setRotation(t){this.rotation={...t},this.updateTransform()}rotateY(t){this.rotation.y=(this.rotation.y+t)%360,this.updateTransform()}setColor(t){this.color=t,Array.isArray(this.mesh.material)?this.mesh.material.forEach((e,o)=>{const i=Pe[o];(!this.faces[i]||!this.faces[i].color)&&e.color.set(t)}):this.mesh.material.color.set(t)}setFaceColor(t,e){if(!Array.isArray(this.mesh.material)){this.color=e,this.mesh.material.color.set(e);return}const o=Pe.indexOf(t);o!==-1&&(this.faces[t]||(this.faces[t]={direction:t,materialId:null,color:null,uvRotation:0,uvFlip:{x:!1,y:!1}}),this.faces[t].color=e,this.mesh.material[o].color.set(e))}getFaceColor(t){if(!Array.isArray(this.mesh.material))return this.color;const e=this.faces[t];return e&&e.color?e.color:this.color}supportsPerFacePainting(){return Array.isArray(this.mesh.material)&&this.mesh.material.length===6}setEmissive(t,e=null,o=null,i=null){this.emissive.enabled=t,e!==null&&(this.emissive.color=e),o!==null&&(this.emissive.intensity=o),i!==null&&(this.emissive.radius=i);const s=n=>{t?(n.emissive=new ot(this.emissive.color),n.emissiveIntensity=this.emissive.intensity):(n.emissive=new ot(0),n.emissiveIntensity=0)};Array.isArray(this.mesh.material)?this.mesh.material.forEach(s):s(this.mesh.material),t?this.createLight():this.removeLight()}updateLight(){this.light&&(this.light.color.set(this.emissive.color),this.light.intensity=this.emissive.intensity*2,this.light.distance=this.emissive.radius*2)}setSelected(t){if(this.emissive.enabled){const o=i=>{i.emissiveIntensity=t?this.emissive.intensity*1.5:this.emissive.intensity};Array.isArray(this.mesh.material)?this.mesh.material.forEach(o):o(this.mesh.material);return}const e=(o,i)=>{o.emissive&&o.emissive.set(i)};Array.isArray(this.mesh.material)?this.mesh.material.forEach(o=>e(o,t?3355443:0)):e(this.mesh.material,t?3355443:0)}clone(){return new xs({type:this.type,position:{...this.gridPosition},dimensions:{...this.dimensions},rotation:{...this.rotation},color:this.color,emissive:{...this.emissive},faces:JSON.parse(JSON.stringify(this.faces)),layerId:this.layerId,scale:this.scale})}toJSON(){return{id:this.id,type:this.type,position:this.gridPosition,dimensions:this.dimensions,rotation:this.rotation,color:this.color,emissive:this.emissive,faces:this.faces,layerId:this.layerId,scale:this.scale}}dispose(){this.removeLight(),this.edges&&(this.edges.geometry.dispose(),this.edges.material.dispose()),this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach(t=>t.dispose()):this.mesh.material.dispose()}}Er();const Wn=new Set;for(const y of Object.values(Yn))for(const t of y.types)Wn.add(t);function Ba(y){return typeof y=="string"&&Wn.has(y)}function Ca(y){return!y||typeof y!="object"?!1:typeof y.x=="number"&&isFinite(y.x)&&typeof y.y=="number"&&isFinite(y.y)&&typeof y.z=="number"&&isFinite(y.z)}function Aa(y){return!y||typeof y!="object"?!1:typeof y.w=="number"&&y.w>0&&isFinite(y.w)&&typeof y.h=="number"&&y.h>0&&isFinite(y.h)&&typeof y.d=="number"&&y.d>0&&isFinite(y.d)}function Ma(y){return!y||typeof y!="object"?!1:typeof y.x=="number"&&isFinite(y.x)&&typeof y.y=="number"&&isFinite(y.y)&&typeof y.z=="number"&&isFinite(y.z)}function qn(y){return typeof y!="string"?!1:/^#[0-9A-Fa-f]{6}$/.test(y)}function Ea(y){return!(!y||typeof y!="object"||typeof y.enabled!="boolean"||y.enabled&&(!qn(y.color)||typeof y.intensity!="number"||y.intensity<0||typeof y.radius!="number"||y.radius<0))}function Kn(y){const t=[];return!y||typeof y!="object"?{valid:!1,errors:["Block data must be an object"]}:(y.type?Ba(y.type)||t.push(`Invalid block type: ${y.type}`):t.push("Block type is required"),y.position?Ca(y.position)||t.push("Invalid block position"):t.push("Block position is required"),y.dimensions&&!Aa(y.dimensions)&&t.push("Invalid block dimensions"),y.rotation&&!Ma(y.rotation)&&t.push("Invalid block rotation"),y.color&&!qn(y.color)&&t.push("Invalid block color"),y.emissive&&!Ea(y.emissive)&&t.push("Invalid emissive settings"),{valid:t.length===0,errors:t})}function _a(y){const t=[],e=[];return!y||typeof y!="object"?{valid:!1,errors:["Project data must be an object"],warnings:[]}:(y.version&&y.version!=="1.0"&&e.push(`Project version ${y.version} may not be fully compatible`),y.blocks&&(Array.isArray(y.blocks)?y.blocks.forEach((o,i)=>{const s=Kn(o);s.valid||t.push(`Block ${i}: ${s.errors.join(", ")}`)}):t.push("Project blocks must be an array")),y.animations&&(Array.isArray(y.animations)||t.push("Project animations must be an array")),{valid:t.length===0,errors:t,warnings:e})}function Sa(y){const t={...y};return t.dimensions=t.dimensions||{w:1,h:1,d:1},t.rotation=t.rotation||{x:0,y:0,z:0},t.color=t.color||"#5588cc",t.emissive=t.emissive||{enabled:!1,color:"#ffaa00",intensity:1,radius:3},t.position&&(t.position.x=Math.max(-1e3,Math.min(1e3,t.position.x)),t.position.y=Math.max(-1e3,Math.min(1e3,t.position.y)),t.position.z=Math.max(-1e3,Math.min(1e3,t.position.z))),t}function Ta(y){if(!Array.isArray(y))return{blocks:[],invalidCount:0};const t=[];let e=0;for(const o of y){const i=Kn(o);i.valid?t.push(Sa(o)):(e++,console.warn("Skipping invalid block:",i.errors.join(", ")))}return{blocks:t,invalidCount:e}}const Ps={pillar:"Y",pillar2:"Y",pillar4:"Y",pillarRound:"Y",pillarRound2:"Y",post:"Y",bollard:"Y",downspout:"Y",antenna:"Y",torch:"Y",chain:"Y",finial:"Y",banner:"Y",derrickLeg:"Y",wellHead:"Y",beamX:"X",beam2X:"X",beam4X:"X",beamXLow:"X",beam2XLow:"X",pipeX:"X",conduit:"X",cableX:"X",pipelineX:"X",ductX:"X",moldingX:"X",beamZ:"Z",beam2Z:"Z",beam4Z:"Z",beamZLow:"Z",beam2ZLow:"Z",pipeZ:"Z",cableZ:"Z",pipelineZ:"Z",ductZ:"Z",moldingZ:"Z",pipeY:"Y",cableY:"Y",cableDroop:"Y",cableLoop:"Y",beamDiag:"XZ"},Is=["slab","quarter","wedgeLow","wedgeFlat","wedgeCornerLow","wedgeCornerFlat","slabSlope","ledge","gutter","capital","base","channel","channelCorner","channelEnd","rampCurvedLow","roofPeakLow","step","platform","landing","stairsSingle","spiralStep","drain","grate","grateFloor","pallet","derrickPlatform","pumpBase","awning","canopy","tarp","lightFixture","shelf"],Rs=["beamX","beam2X","beam4X","beamZ","beam2Z","beam4Z","beamDiag","slabTop","wedgeLowTop","wedgeFlatTop","slabSlopeTop","crossBeam","derrickCross"],Ls=["pillar","pillar2","pillar4","pillarRound","pillarRound2","fence","fenceZ","railing","railingZ","wall","wall4","wall8","panel","post","bollard","downspout","antenna","torch","chain","finial","banner","conduit","conduitCorner","cable","cableX","cableY","cableZ","cableElbow","cableElbowY","cableT","cableHanging","cableDroop","cableLoop","pipeX","pipeY","pipeZ","pipeElbowXZ","pipeElbowXZ2","pipeElbowXZ3","pipeElbowXZ4","pipeElbowXY","pipeElbowXY2","pipeElbowYZ","pipeElbowYZ2","pipeCross","pipeT","pipeTY","pipeTZ","derrickLeg","wellHead","pipelineX","pipelineZ"],Os=["pipeX","pipeY","pipeZ","pipeElbowXZ","pipeElbowXZ2","pipeElbowXZ3","pipeElbowXZ4","pipeElbowXY","pipeElbowXY2","pipeElbowYZ","pipeElbowYZ2","pipeCross","pipeT","pipeTY","pipeTZ","conduit","conduitCorner","conduitElbow","conduitElbowY","conduitT","cableX","cableY","cableZ","cableElbow","cableElbowY","cableT"];function Ns(y,t){const e=Ps[y],o=Ps[t],i=Is.includes(y),s=Is.includes(t),n=Rs.includes(y),r=Rs.includes(t),a=Ls.includes(y),l=Ls.includes(t),p=Os.includes(y),h=Os.includes(t);return p&&h||i&&r||s&&n||i&&l||s&&a||p&&s||h&&i?!0:!(n&&r||i&&s||!e||!o||e===o||e==="XZ"||o==="XZ")}class Da{constructor(t){this.scene=t,this.blocks=new Map,this.mergedMeshes=new Map,this.blockGroup=new ps,this.blockGroup.name="blocks",this.scene.add(this.blockGroup),this.selectedBlocks=new Set,this.onBlockCountChange=null,this.onSelectionChange=null}get selectedBlock(){return this.selectedBlocks.size===0?null:this.selectedBlocks.values().next().value}set selectedBlock(t){this.deselectAll(),t&&(this.selectedBlocks.add(t),t.setSelected(!0))}addBlock(t){const e=new xs(t);return this.wouldOverlap(e)?(e.dispose(),null):(this.blocks.set(e.id,e),this.blockGroup.add(e.mesh),this.notifyBlockCountChange(),e)}wouldOverlap(t,e=null){const o=Ao(t);for(const i of this.blocks.values()){if(e&&i.id===e)continue;const s=Ao(i);if(Es(o,s)){if(Ns(t.type,i.type))continue;return!0}}return!1}wouldOverlapAt(t,e,o={w:1,h:1,d:1},i=null,s=1,n={x:0,y:0,z:0}){const a=Ao({type:t,gridPosition:e,dimensions:o,scale:s,rotation:n}),l=i instanceof Set?i:i?new Set([i]):new Set;for(const p of this.blocks.values()){if(l.has(p.id))continue;const h=Ao(p);if(Es(a,h)){if(Ns(t,p.type))continue;return!0}}return!1}removeBlock(t){const e=this.blocks.get(t);return e?(this.blockGroup.remove(e.mesh),e.dispose(),this.blocks.delete(t),this.selectedBlocks.has(e)&&(this.selectedBlocks.delete(e),this.notifySelectionChange()),this.notifyBlockCountChange(),!0):!1}removeBlockAtPosition(t){const e=this.getBlockAtPosition(t);return e?this.removeBlock(e.id):!1}getBlockAtPosition(t){for(const e of this.blocks.values()){const o=e.gridPosition;if(o.x===t.x&&o.y===t.y&&o.z===t.z)return e}return null}getBlockByMesh(t){return t.userData.block?t.userData.block:null}selectBlock(t,e=!1){e||this.deselectAll(),t&&(this.selectedBlocks.add(t),t.setSelected(!0)),this.notifySelectionChange()}addToSelection(t){t&&!this.selectedBlocks.has(t)&&(this.selectedBlocks.add(t),t.setSelected(!0),this.notifySelectionChange())}removeFromSelection(t){t&&this.selectedBlocks.has(t)&&(this.selectedBlocks.delete(t),t.setSelected(!1),this.notifySelectionChange())}toggleSelection(t){this.selectedBlocks.has(t)?this.removeFromSelection(t):this.addToSelection(t)}isSelected(t){return this.selectedBlocks.has(t)}getSelectedBlocks(){return Array.from(this.selectedBlocks)}getSelectionCount(){return this.selectedBlocks.size}selectBlocksInBox(t,e){for(const o of this.blocks.values()){const i=o.gridPosition;i.x>=t.x&&i.x<=e.x&&i.y>=t.y&&i.y<=e.y&&i.z>=t.z&&i.z<=e.z&&(this.selectedBlocks.add(o),o.setSelected(!0))}this.notifySelectionChange()}deselectAll(){for(const t of this.selectedBlocks)t.setSelected(!1);this.selectedBlocks.clear(),this.notifySelectionChange()}notifySelectionChange(){this.onSelectionChange&&this.onSelectionChange(this.getSelectedBlocks())}getBlockMeshes(){return this.blockGroup.children}getAllBlocks(){return Array.from(this.blocks.values())}getBlockById(t){return this.blocks.get(t)||null}positionKey(t){return`${t.x},${t.y},${t.z}`}getBlockCount(){return this.blocks.size}notifyBlockCountChange(){this.onBlockCountChange&&this.onBlockCountChange(this.blocks.size)}clear(){for(const t of this.blocks.values())this.blockGroup.remove(t.mesh),t.dispose();this.blocks.clear();for(const t of this.mergedMeshes.values())this.blockGroup.remove(t.mesh),t.dispose();this.mergedMeshes.clear(),this.selectedBlocks.clear(),this.notifyBlockCountChange(),this.notifySelectionChange()}addMergedMesh(t){return this.mergedMeshes.set(t.id,t),this.blockGroup.add(t.mesh),this.notifyBlockCountChange(),t}removeMergedMesh(t){const e=this.mergedMeshes.get(t);return e?(this.blockGroup.remove(e.mesh),e.dispose(),this.mergedMeshes.delete(t),this.notifyBlockCountChange(),!0):!1}getMergedMeshes(){return Array.from(this.mergedMeshes.values())}getMergedMeshByMesh(t){return t.userData.merged?t.userData.merged:null}toJSON(){return Array.from(this.blocks.values()).map(t=>t.toJSON())}fromJSON(t){this.clear();const{blocks:e,invalidCount:o}=Ta(t);o>0&&console.warn(`Skipped ${o} invalid block(s) during load`);for(const i of e)this.addBlock({type:i.type,position:i.position,dimensions:i.dimensions,rotation:i.rotation,color:i.color,emissive:i.emissive,faces:i.faces,layerId:i.layerId||"default",scale:i.scale||1});return{loadedCount:e.length,invalidCount:o}}}class Pa{constructor(t,e){Xe(this,"handleMouseMove",t=>{this.updateMouse(t);const e=this.raycast();if(this.isDragging&&this.currentTool==="shape"&&this.onShapeDrag){if(e&&this.dragStartPos){const o=e.placementPosition;this.onShapeDrag(this.dragStartPos,o)}return}if(this.isPainting&&this.currentTool==="paint"&&this.onPaint&&e&&e.block){const i=`${e.block.id}_${e.normal.x}_${e.normal.y}_${e.normal.z}`;i!==this.lastPaintedBlock&&(this.onPaint(e,!1),this.lastPaintedBlock=i)}this.onMouseMove&&this.onMouseMove(e)});Xe(this,"handleMouseDown",t=>{if(t.button!==0&&t.button!==1)return;this.updateMouse(t);const e=this.raycast();if(e){if(t.button===1){this.onDelete&&e.block&&this.onDelete(e.block);return}if(t.ctrlKey&&e.block){this.onReplace&&this.onReplace(e.block);return}if(t.altKey&&e.block){this.onPickBlock&&this.onPickBlock(e.block);return}switch(this.currentTool){case"place":this.onPlace&&this.onPlace(e,t.shiftKey);break;case"delete":this.onDelete&&e.block&&this.onDelete(e.block);break;case"select":this.onSelect&&this.onSelect(e.block||null,t.shiftKey);break;case"paint":if(this.onPaint&&e.block){this.isPainting=!0;const i=`${e.block.id}_${e.normal.x}_${e.normal.y}_${e.normal.z}`;this.lastPaintedBlock=i,this.onPaint(e,t.shiftKey)}break;case"pick":this.onPick&&e.block&&this.onPick(e);break;case"shape":this.isDragging=!0,this.dragStartPos=e.placementPosition,this.dragStartResult=e,this.onShapeDrag&&this.onShapeDrag(this.dragStartPos,this.dragStartPos);break;case"scatter":this.onScatterPlace&&this.onScatterPlace(e);break}}});Xe(this,"handleMouseUp",t=>{if(t.button===0){if(this.isDragging&&this.currentTool==="shape"){this.updateMouse(t);const e=this.raycast();if(e&&this.dragStartPos&&this.onShapePlace){const o=e.placementPosition;this.onShapePlace(this.dragStartPos,o)}this.isDragging=!1,this.dragStartPos=null,this.dragStartResult=null}this.isPainting&&(this.isPainting=!1,this.lastPaintedBlock=null)}});Xe(this,"handleKeyDown",t=>{});this.canvas=t,this.camera=e,this.raycaster=new hs,this.mouse=new nt,this.currentTool="place",this.onPlace=null,this.onDelete=null,this.onSelect=null,this.onPaint=null,this.onPick=null,this.onMouseMove=null,this.onReplace=null,this.onPickBlock=null,this.onShapeDrag=null,this.onShapePlace=null,this.onScatterPlace=null,this.isDragging=!1,this.dragStartPos=null,this.dragStartResult=null,this.isPainting=!1,this.lastPaintedBlock=null,this.raycastTargets=[],this.gridPlane=null,this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),window.addEventListener("keydown",this.handleKeyDown)}setGridPlane(t){this.gridPlane=t}setRaycastTargets(t){this.raycastTargets=t}setTool(t){this.currentTool=t}updateMouse(t){const e=this.canvas.getBoundingClientRect();this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-((t.clientY-e.top)/e.height)*2+1}raycast(){this.raycaster.setFromCamera(this.mouse,this.camera);const t=this.raycaster.intersectObjects(this.raycastTargets,!1);if(t.length>0){const e=t[0],o=e.object.userData.block,i=e.object.userData.merged,s=e.face.normal.clone();if(s.transformDirection(e.object.matrixWorld),s.x=Math.abs(s.x)>.5?Math.sign(s.x):0,s.y=Math.abs(s.y)>.5?Math.sign(s.y):0,s.z=Math.abs(s.z)>.5?Math.sign(s.z):0,i&&!o){const n=e.point;let r={x:Math.floor(n.x+s.x*.5),y:Math.floor(n.y+s.y*.5),z:Math.floor(n.z+s.z*.5)};return s.y>0&&(r.y=Math.floor(n.y),r.surfaceY=n.y),{type:"merged",point:e.point,normal:s,block:null,merged:i,placementPosition:r,faceIndex:e.faceIndex}}if(o){const n=o,r=n.gridPosition,a=n.dimensions,l=n.scale||1,p=oo[n.type]||1,h=(io[n.type]||0)*l,u=a.h*p*l;let c={x:r.x,y:r.y,z:r.z};if(s.y>0){const f=r.y+h+u;c.y=Math.floor(f),c.surfaceY=f}else s.y<0?c.y=r.y-1:s.x!==0?c.x=r.x+s.x*a.w*l:s.z!==0&&(c.z=r.z+s.z*a.d*l);return{type:"block",point:e.point,normal:s,block:o,placementPosition:c,faceIndex:e.faceIndex}}}if(this.gridPlane){const e=this.raycaster.intersectObject(this.gridPlane,!1);if(e.length>0){const o=e[0],i={x:Math.floor(o.point.x),y:0,z:Math.floor(o.point.z)};return{type:"grid",point:o.point,normal:new U(0,1,0),block:null,placementPosition:i}}}return null}dispose(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mouseup",this.handleMouseUp),window.removeEventListener("keydown",this.handleKeyDown)}}class Ia{constructor(t){this.scene=t,this.visible=!1,this.currentType="cube",this.currentScale=1,this.group=new ps,this.scene.add(this.group),this.mesh=null,this.wireframe=null,this.createMesh("cube")}createMesh(t){this.mesh&&(this.group.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.wireframe&&(this.wireframe.geometry.dispose(),this.wireframe.material.dispose()));const e=this.createGeometry(t),o=new gi({color:5605580,transparent:!0,opacity:.4,depthWrite:!1});this.mesh=new Dt(e,o),this.mesh.visible=this.visible;const i=new Fo(e),s=new to({color:16777215,transparent:!0,opacity:.6});this.wireframe=new eo(i,s),this.mesh.add(this.wireframe),this.group.add(this.mesh),this.currentType=t}createGeometry(t){const o=(ai[t]||ai.cube)({w:1,h:1,d:1});return this.currentScale>1&&o.scale(this.currentScale,this.currentScale,this.currentScale),o}show(){this.mesh.visible=!0,this.visible=!0}hide(){this.mesh.visible=!1,this.visible=!1}setPosition(t){const e=oo[this.currentType]||1,o=io[this.currentType]||0,i=e*this.currentScale,s=o*this.currentScale+i/2,n=this.currentScale/2;this.group.position.set(t.x+n,t.y+s,t.z+n)}setBlockType(t){t!==this.currentType&&(this.createMesh(t),this.mesh.visible=this.visible)}setScale(t){t!==this.currentScale&&(this.currentScale=t,this.createMesh(this.currentType),this.mesh.visible=this.visible)}setRotation(t){this.group.rotation.y=gt.degToRad(t)}setColor(t){this.mesh.material.color.set(t)}setValid(t){t?(this.mesh.material.color.set(5605580),this.mesh.material.opacity=.4):(this.mesh.material.color.set(16729156),this.mesh.material.opacity=.6)}dispose(){this.scene.remove(this.group),this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose()),this.wireframe&&(this.wireframe.geometry.dispose(),this.wireframe.material.dispose())}}class Ra{constructor(){this.atlases=new Map,this.materials=new Map,this.loader=new Sr,this.createDefaultMaterials()}createDefaultMaterials(){[{id:"white",name:"White",color:"#ffffff"},{id:"gray",name:"Gray",color:"#888888"},{id:"black",name:"Black",color:"#222222"},{id:"red",name:"Red",color:"#e74c3c"},{id:"orange",name:"Orange",color:"#e67e22"},{id:"yellow",name:"Yellow",color:"#f1c40f"},{id:"green",name:"Green",color:"#2ecc71"},{id:"cyan",name:"Cyan",color:"#1abc9c"},{id:"blue",name:"Blue",color:"#3498db"},{id:"purple",name:"Purple",color:"#9b59b6"},{id:"pink",name:"Pink",color:"#e91e63"},{id:"brown",name:"Brown",color:"#795548"}].forEach(e=>{this.materials.set(e.id,{id:e.id,name:e.name,baseColor:e.color,albedoTile:null,roughness:.7,metallic:0,emission:null,emissionStrength:0})})}async loadAtlas(t,e,o,i,s){return new Promise((n,r)=>{this.loader.load(e,a=>{a.magFilter=me,a.minFilter=me,a.colorSpace=ys;const l={id:t,texture:a,tileSize:o,columns:i,rows:s,totalTiles:i*s};this.atlases.set(t,l),this.createAtlasMaterials(l),n(l)},void 0,r)})}createAtlasMaterials(t){for(let e=0;e<t.totalTiles;e++){const o=e%t.columns,i=Math.floor(e/t.columns),s=`${t.id}_tile_${e}`;this.materials.set(s,{id:s,name:`Tile ${e}`,baseColor:"#ffffff",albedoTile:{atlasId:t.id,index:e,col:o,row:i},roughness:.8,metallic:0,emission:null,emissionStrength:0})}}getMaterial(t){return this.materials.get(t)}getAllMaterials(){return Array.from(this.materials.values())}getColorMaterials(){return Array.from(this.materials.values()).filter(t=>!t.albedoTile)}getAtlasMaterials(t){return Array.from(this.materials.values()).filter(e=>e.albedoTile&&e.albedoTile.atlasId===t)}createThreeMaterial(t){const e=this.materials.get(t);if(!e)return null;const o={color:e.baseColor,roughness:e.roughness,metalness:e.metallic};if(e.albedoTile){const i=this.atlases.get(e.albedoTile.atlasId);if(i){const s=i.texture.clone();s.needsUpdate=!0,s.repeat.set(1/i.columns,1/i.rows),s.offset.set(e.albedoTile.col/i.columns,1-(e.albedoTile.row+1)/i.rows),o.map=s}}return e.emission&&(o.emissive=new ot(e.emission),o.emissiveIntensity=e.emissionStrength),new kt(o)}createFaceMaterial(t,e=0,o={x:!1,y:!1}){const i=this.createThreeMaterial(t);return i?(i.userData={uvRotation:e,uvFlip:o},i):null}}class La{constructor(t=50){this.undoStack=[],this.redoStack=[],this.maxSize=t,this.onChange=null}push(t){this.undoStack.push(t),this.redoStack=[],this.undoStack.length>this.maxSize&&this.undoStack.shift(),this.notify()}undo(){if(this.undoStack.length===0)return!1;const t=this.undoStack.pop();return t.undo(),this.redoStack.push(t),this.notify(),!0}redo(){if(this.redoStack.length===0)return!1;const t=this.redoStack.pop();return t.redo(),this.undoStack.push(t),this.notify(),!0}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}clear(){this.undoStack=[],this.redoStack=[],this.notify()}notify(){this.onChange&&this.onChange({canUndo:this.canUndo(),canRedo:this.canRedo()})}}function co(y,t,e){return{type:"addBlock",data:t,undo:()=>{y.removeBlock(e.id)},redo:()=>{y.addBlock(t)}}}function Bi(y,t){const e=t.toJSON();return{type:"removeBlock",data:e,undo:()=>{y.addBlock(e)},redo:()=>{y.removeBlockAtPosition(e.position)}}}function Oa(y,t,e,o){return{type:"paintFaceColor",data:{blockId:y.id,faceDirection:t,oldColor:e,newColor:o},undo:()=>{if(e===null){if(y.faces[t].color=null,Array.isArray(y.mesh.material)){const s=["east","west","top","bottom","south","north"].indexOf(t);s!==-1&&y.mesh.material[s].color.set(y.color)}}else y.setFaceColor(t,e)},redo:()=>{y.setFaceColor(t,o)}}}function Na(y,t,e,o){return{type:"paintBlockColor",data:{blockId:y.id,oldColor:t,newColor:e},undo:()=>{y.setColor(t),o&&Object.entries(o).forEach(([s,n])=>{n&&n.color&&y.setFaceColor(s,n.color)})},redo:()=>{y.setColor(e)}}}function Us(y){return{type:"batchPaint",data:{count:y.length},undo:()=>{for(let t=y.length-1;t>=0;t--)y[t].undo()},redo:()=>{y.forEach(t=>t.redo())}}}function Ua(y,t,e){return{type:"flatten",data:{blockCount:t.length,mergedCount:e.length},undo:()=>{for(const o of e)y.removeMergedMesh(o);for(const o of t)y.addBlock(o)},redo:()=>{const o=y.getAllBlocks().filter(i=>t.some(s=>s.position.x===i.gridPosition.x&&s.position.y===i.gridPosition.y&&s.position.z===i.gridPosition.z));for(const i of o)y.removeBlock(i.id)}}}class pi{constructor(t={}){this.id=t.id||`anim_${Date.now()}`,this.name=t.name||"Animation",this.duration=t.duration||1e3,this.loop=t.loop||!1,this.curve=t.curve||"easeInOut",this.keyframes=t.keyframes||[]}addKeyframe(t,e,o){this.keyframes=this.keyframes.filter(i=>!(i.time===t&&i.blockId===e)),this.keyframes.push({time:t,blockId:e,properties:o}),this.keyframes.sort((i,s)=>i.time-s.time)}removeKeyframe(t,e){this.keyframes=this.keyframes.filter(o=>!(o.time===t&&o.blockId===e))}getKeyframesForBlock(t){return this.keyframes.filter(e=>e.blockId===t)}getKeyframesAtTime(t){return this.keyframes.filter(e=>e.time===t)}toJSON(){return{id:this.id,name:this.name,duration:this.duration,loop:this.loop,curve:this.curve,keyframes:this.keyframes}}static fromJSON(t){return new pi(t)}}class Xa{constructor(t){this.blockManager=t,this.animations=new Map,this.currentAnimation=null,this.isPlaying=!1,this.currentTime=0,this.playbackSpeed=1,this.originalStates=new Map,this.onTimeUpdate=null,this.onPlayStateChange=null}createAnimation(t="New Animation",e=2e3){const o=new pi({name:t,duration:e});return this.animations.set(o.id,o),o}deleteAnimation(t){var e;this.animations.delete(t),((e=this.currentAnimation)==null?void 0:e.id)===t&&(this.currentAnimation=null,this.stop())}setCurrentAnimation(t){this.stop(),this.currentAnimation=this.animations.get(t)||null,this.currentTime=0}captureInitialState(){if(this.currentAnimation){this.originalStates.clear();for(const t of this.blockManager.blocks.values())this.originalStates.set(t.id,{position:{...t.gridPosition},rotation:{...t.rotation},scale:{...t.dimensions},color:t.color,emissive:t.emissive?{...t.emissive}:null})}}addKeyframe(t){return!this.currentAnimation||!t?0:(this.currentAnimation.addKeyframe(this.currentTime,t.id,{position:{...t.gridPosition},rotation:{...t.rotation},scale:{...t.dimensions},color:t.color,emissive:t.emissive?{...t.emissive}:null}),1)}addKeyframesForSelection(t){if(!this.currentAnimation||!t||t.length===0)return 0;let e=0;for(const o of t)this.currentAnimation.addKeyframe(this.currentTime,o.id,{position:{...o.gridPosition},rotation:{...o.rotation},scale:{...o.dimensions},color:o.color,emissive:o.emissive?{...o.emissive}:null}),e++;return e}removeKeyframe(t){if(!this.currentAnimation)return 0;const e=this.currentAnimation.keyframes.length;return this.currentAnimation.removeKeyframe(this.currentTime,t),e-this.currentAnimation.keyframes.length}removeKeyframesForSelection(t){if(!this.currentAnimation||!t||t.length===0)return 0;let e=0;for(const o of t){const i=this.currentAnimation.keyframes.length;this.currentAnimation.removeKeyframe(this.currentTime,o),this.currentAnimation.keyframes.length<i&&e++}return e}hasKeyframesAtCurrentTime(t){return this.currentAnimation?this.currentAnimation.getKeyframesAtTime(this.currentTime).some(o=>t.includes(o.blockId)):!1}play(){this.currentAnimation&&(this.captureInitialState(),this.isPlaying=!0,this.lastTime=performance.now(),this.onPlayStateChange&&this.onPlayStateChange(!0))}pause(){this.isPlaying=!1,this.onPlayStateChange&&this.onPlayStateChange(!1)}stop(){this.isPlaying=!1,this.currentTime=0,this.restoreOriginalStates(),this.onPlayStateChange&&this.onPlayStateChange(!1),this.onTimeUpdate&&this.onTimeUpdate(0)}restoreOriginalStates(){for(const[t,e]of this.originalStates){const o=this.blockManager.blocks.get(t);o&&(o.setPosition(e.position),o.setRotation(e.rotation),o.setColor(e.color),e.emissive&&o.setEmissive&&o.setEmissive(e.emissive))}}setTime(t){var e;this.currentTime=Math.max(0,Math.min(t,((e=this.currentAnimation)==null?void 0:e.duration)||0)),this.updateBlocks(),this.onTimeUpdate&&this.onTimeUpdate(this.currentTime)}update(t){!this.isPlaying||!this.currentAnimation||(this.currentTime+=t*1e3*this.playbackSpeed,this.currentTime>=this.currentAnimation.duration&&(this.currentAnimation.loop?this.currentTime=this.currentTime%this.currentAnimation.duration:(this.currentTime=this.currentAnimation.duration,this.pause())),this.updateBlocks(),this.onTimeUpdate&&this.onTimeUpdate(this.currentTime))}updateBlocks(){if(!this.currentAnimation)return;const t=new Map;for(const e of this.currentAnimation.keyframes)t.has(e.blockId)||t.set(e.blockId,[]),t.get(e.blockId).push(e);for(const[e,o]of t){const i=this.blockManager.blocks.get(e);if(!i||o.length===0)continue;let s=null,n=null;for(const r of o)r.time<=this.currentTime?s=r:n||(n=r);if(s&&n){const r=(this.currentTime-s.time)/(n.time-s.time);this.interpolateBlock(i,s.properties,n.properties,r)}else if(s)this.applyProperties(i,s.properties);else if(n){const r=this.originalStates.get(e);r&&(i.setPosition(r.position),i.setRotation(r.rotation))}}}interpolateBlock(t,e,o,i){const s=this.applyCurve(i);if(e.position&&o.position&&t.setPosition({x:Math.round(this.lerp(e.position.x,o.position.x,s)),y:Math.round(this.lerp(e.position.y,o.position.y,s)),z:Math.round(this.lerp(e.position.z,o.position.z,s))}),e.rotation&&o.rotation&&t.setRotation({x:this.lerp(e.rotation.x,o.rotation.x,s),y:this.lerp(e.rotation.y,o.rotation.y,s),z:this.lerp(e.rotation.z,o.rotation.z,s)}),e.color&&o.color){const n=new ot(e.color),r=new ot(o.color);n.lerp(r,s),t.setColor("#"+n.getHexString())}if(e.emissive&&o.emissive&&t.setEmissive){const n=new ot(e.emissive.color||"#000000"),r=new ot(o.emissive.color||"#000000");n.lerp(r,s),t.setEmissive({enabled:o.emissive.enabled,color:"#"+n.getHexString(),intensity:this.lerp(e.emissive.intensity||0,o.emissive.intensity||0,s),radius:this.lerp(e.emissive.radius||0,o.emissive.radius||0,s)})}else if(o.emissive&&t.setEmissive)t.setEmissive(o.emissive);else if(e.emissive&&!o.emissive&&t.setEmissive){const n=new ot(e.emissive.color||"#000000");t.setEmissive({enabled:s<.5?e.emissive.enabled:!1,color:"#"+n.getHexString(),intensity:this.lerp(e.emissive.intensity||0,0,s),radius:e.emissive.radius||0})}}applyProperties(t,e){e.position&&t.setPosition(e.position),e.rotation&&t.setRotation(e.rotation),e.color&&t.setColor(e.color),e.emissive&&t.setEmissive&&t.setEmissive(e.emissive)}lerp(t,e,o){return t+(e-t)*o}applyCurve(t){if(!this.currentAnimation)return t;switch(this.currentAnimation.curve||"easeInOut"){case"linear":return t;case"easeIn":return t*t;case"easeOut":return 1-Math.pow(1-t,2);case"easeInOut":return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;case"smoothstep":return t*t*(3-2*t);default:return t}}getAllAnimations(){return Array.from(this.animations.values())}toJSON(){var t;return{animations:Array.from(this.animations.values()).map(e=>e.toJSON()),currentAnimationId:((t=this.currentAnimation)==null?void 0:t.id)||null}}fromJSON(t){this.animations.clear();for(const e of t.animations||[]){const o=pi.fromJSON(e);this.animations.set(o.id,o)}t.currentAnimationId&&this.setCurrentAnimation(t.currentAnimationId)}clear(){this.stop(),this.animations.clear(),this.currentAnimation=null,this.originalStates.clear()}}class Za{constructor(t,e,o,i=null){this.blockManager=t,this.animator=e,this.textureManager=o,this.layerManager=i,this.currentProjectName="Untitled",this.onError=null}setLayerManager(t){this.layerManager=t}notifyError(t,e=null){console.error(t,e),this.onError&&this.onError(t,e)}save(){try{const t=this.currentProjectName||"Untitled",e=prompt("Save project as:",t);if(e===null)return!1;const o=e.trim()||"Untitled";this.currentProjectName=o;const i={version:"1.0",name:o,createdAt:new Date().toISOString(),blocks:this.blockManager.toJSON(),animations:this.animator.toJSON(),layers:this.layerManager?this.layerManager.toJSON():null},s=JSON.stringify(i,null,2),n=new Blob([s],{type:"application/json"}),r=URL.createObjectURL(n),a=document.createElement("a");return a.href=r,a.download=`${o.replace(/\s+/g,"_")}.blocks`,a.click(),URL.revokeObjectURL(r),!0}catch(t){return this.notifyError("Failed to save project",t),!1}}async load(t){return new Promise((e,o)=>{if(!t){const s=new Error("No file provided");this.notifyError("No file provided for loading",s),o(s);return}const i=new FileReader;i.onload=s=>{try{const n=s.target.result;if(!n||n.trim()==="")throw new Error("File is empty");const r=JSON.parse(n);if(!r||typeof r!="object")throw new Error("Invalid project format");const a=_a(r);if(!a.valid)throw new Error(`Invalid project: ${a.errors.join(", ")}`);for(const l of a.warnings)console.warn("Project warning:",l);if(this.currentProjectName=r.name||"Loaded Project",r.blocks&&Array.isArray(r.blocks)){const l=this.blockManager.fromJSON(r.blocks);l.invalidCount>0&&console.warn(`Loaded ${l.loadedCount} blocks, skipped ${l.invalidCount} invalid blocks`)}else console.warn("No blocks found in project file");r.animations&&this.animator.fromJSON(r.animations),r.layers&&this.layerManager&&this.layerManager.fromJSON(r.layers),e(r)}catch(n){this.notifyError(`Failed to parse project file: ${n.message}`,n),o(n)}},i.onerror=s=>{const n=new Error("Failed to read file");this.notifyError("Failed to read project file",n),o(n)},i.readAsText(t)})}newProject(){try{return this.currentProjectName="Untitled",this.blockManager.clear(),this.animator.animations.clear(),this.animator.currentAnimation=null,this.layerManager&&this.layerManager.clear(),!0}catch(t){return this.notifyError("Failed to create new project",t),!1}}setProjectName(t){this.currentProjectName=t}}const Xs={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};let hi=class{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(t){return new Ja(t)}),this.register(function(t){return new Qa(t)}),this.register(function(t){return new il(t)}),this.register(function(t){return new sl(t)}),this.register(function(t){return new nl(t)}),this.register(function(t){return new rl(t)}),this.register(function(t){return new tl(t)}),this.register(function(t){return new el(t)}),this.register(function(t){return new ol(t)}),this.register(function(t){return new al(t)}),this.register(function(t){return new ll(t)}),this.register(function(t){return new cl(t)}),this.register(function(t){return new pl(t)}),this.register(function(t){return new hl(t)})}register(t){return this.pluginCallbacks.indexOf(t)===-1&&this.pluginCallbacks.push(t),this}unregister(t){return this.pluginCallbacks.indexOf(t)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}setTextureUtils(t){return this.textureUtils=t,this}parse(t,e,o,i){const s=new Ka,n=[];for(let r=0,a=this.pluginCallbacks.length;r<a;r++)n.push(this.pluginCallbacks[r](s));s.setPlugins(n),s.setTextureUtils(this.textureUtils),s.writeAsync(t,e,i).catch(o)}parseAsync(t,e){const o=this;return new Promise(function(i,s){o.parse(t,i,s,e)})}};const lt={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},Ci="KHR_mesh_quantization",Yt={};Yt[me]=lt.NEAREST;Yt[Ir]=lt.NEAREST_MIPMAP_NEAREST;Yt[Rr]=lt.NEAREST_MIPMAP_LINEAR;Yt[wo]=lt.LINEAR;Yt[Lr]=lt.LINEAR_MIPMAP_NEAREST;Yt[Or]=lt.LINEAR_MIPMAP_LINEAR;Yt[Nr]=lt.CLAMP_TO_EDGE;Yt[Ur]=lt.REPEAT;Yt[Xr]=lt.MIRRORED_REPEAT;const Zs={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},ja=new ot,js=12,Ya=1179937895,Ga=2,Ys=8,$a=1313821514,Va=5130562;function bo(y,t){return y.length===t.length&&y.every(function(e,o){return e===t[o]})}function Ha(y){return new TextEncoder().encode(y).buffer}function Wa(y){return bo(y.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function qa(y,t,e){const o={min:new Array(y.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(y.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let i=t;i<t+e;i++)for(let s=0;s<y.itemSize;s++){let n;y.itemSize>4?n=y.array[i*y.itemSize+s]:(s===0?n=y.getX(i):s===1?n=y.getY(i):s===2?n=y.getZ(i):s===3&&(n=y.getW(i)),y.normalized===!0&&(n=gt.normalize(n,y.array))),o.min[s]=Math.min(o.min[s],n),o.max[s]=Math.max(o.max[s],n)}return o}function Jn(y){return Math.ceil(y/4)*4}function Ai(y,t=0){const e=Jn(y.byteLength);if(e!==y.byteLength){const o=new Uint8Array(e);if(o.set(new Uint8Array(y)),t!==0)for(let i=y.byteLength;i<e;i++)o[i]=t;return o.buffer}return y}function Gs(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function $s(y,t){if(y.toBlob!==void 0)return new Promise(o=>y.toBlob(o,t));let e;return t==="image/jpeg"?e=.92:t==="image/webp"&&(e=.8),y.convertToBlob({type:t,quality:e})}class Ka{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+us}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(t){this.plugins=t}setTextureUtils(t){this.textureUtils=t}async writeAsync(t,e,o={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},o),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(t),await Promise.all(this.pending);const i=this,s=i.buffers,n=i.json;o=i.options;const r=i.extensionsUsed,a=i.extensionsRequired,l=new Blob(s,{type:"application/octet-stream"}),p=Object.keys(r),h=Object.keys(a);if(p.length>0&&(n.extensionsUsed=p),h.length>0&&(n.extensionsRequired=h),n.buffers&&n.buffers.length>0&&(n.buffers[0].byteLength=l.size),o.binary===!0){const u=new FileReader;u.readAsArrayBuffer(l),u.onloadend=function(){const c=Ai(u.result),f=new DataView(new ArrayBuffer(Ys));f.setUint32(0,c.byteLength,!0),f.setUint32(4,Va,!0);const d=Ai(Ha(JSON.stringify(n)),32),m=new DataView(new ArrayBuffer(Ys));m.setUint32(0,d.byteLength,!0),m.setUint32(4,$a,!0);const x=new ArrayBuffer(js),g=new DataView(x);g.setUint32(0,Ya,!0),g.setUint32(4,Ga,!0);const b=js+m.byteLength+d.byteLength+f.byteLength+c.byteLength;g.setUint32(8,b,!0);const z=new Blob([x,m,d,f,c],{type:"application/octet-stream"}),v=new FileReader;v.readAsArrayBuffer(z),v.onloadend=function(){e(v.result)}}}else if(n.buffers&&n.buffers.length>0){const u=new FileReader;u.readAsDataURL(l),u.onloadend=function(){const c=u.result;n.buffers[0].uri=c,e(n)}}else e(n)}serializeUserData(t,e){if(Object.keys(t.userData).length===0)return;const o=this.options,i=this.extensionsUsed;try{const s=JSON.parse(JSON.stringify(t.userData));if(o.includeCustomExtensions&&s.gltfExtensions){e.extensions===void 0&&(e.extensions={});for(const n in s.gltfExtensions)e.extensions[n]=s.gltfExtensions[n],i[n]=!0;delete s.gltfExtensions}Object.keys(s).length>0&&(e.extras=s)}catch(s){console.warn("THREE.GLTFExporter: userData of '"+t.name+"' won't be serialized because of JSON.stringify error - "+s.message)}}getUID(t,e=!1){if(this.uids.has(t)===!1){const i=new Map;i.set(!0,this.uid++),i.set(!1,this.uid++),this.uids.set(t,i)}return this.uids.get(t).get(e)}isNormalizedNormalAttribute(t){if(this.cache.attributesNormalized.has(t))return!1;const o=new U;for(let i=0,s=t.count;i<s;i++)if(Math.abs(o.fromBufferAttribute(t,i).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(t){const e=this.cache;if(e.attributesNormalized.has(t))return e.attributesNormalized.get(t);const o=t.clone(),i=new U;for(let s=0,n=o.count;s<n;s++)i.fromBufferAttribute(o,s),i.x===0&&i.y===0&&i.z===0?i.setX(1):i.normalize(),o.setXYZ(s,i.x,i.y,i.z);return e.attributesNormalized.set(t,o),o}applyTextureTransform(t,e){let o=!1;const i={};(e.offset.x!==0||e.offset.y!==0)&&(i.offset=e.offset.toArray(),o=!0),e.rotation!==0&&(i.rotation=e.rotation,o=!0),(e.repeat.x!==1||e.repeat.y!==1)&&(i.scale=e.repeat.toArray(),o=!0),o&&(t.extensions=t.extensions||{},t.extensions.KHR_texture_transform=i,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(t,e){if(t===e)return t;function o(c){return c.colorSpace===ys?function(d){return d<.04045?d*.0773993808:Math.pow(d*.9478672986+.0521327014,2.4)}:function(d){return d}}t instanceof wi&&(t=await this.decompressTextureAsync(t)),e instanceof wi&&(e=await this.decompressTextureAsync(e));const i=t?t.image:null,s=e?e.image:null,n=Math.max(i?i.width:0,s?s.width:0),r=Math.max(i?i.height:0,s?s.height:0),a=Gs();a.width=n,a.height=r;const l=a.getContext("2d",{willReadFrequently:!0});l.fillStyle="#00ffff",l.fillRect(0,0,n,r);const p=l.getImageData(0,0,n,r);if(i){l.drawImage(i,0,0,n,r);const c=o(t),f=l.getImageData(0,0,n,r).data;for(let d=2;d<f.length;d+=4)p.data[d]=c(f[d]/256)*256}if(s){l.drawImage(s,0,0,n,r);const c=o(e),f=l.getImageData(0,0,n,r).data;for(let d=1;d<f.length;d+=4)p.data[d]=c(f[d]/256)*256}l.putImageData(p,0,0);const u=(t||e).clone();return u.source=new Tr(a),u.colorSpace=Dr,u.channel=(t||e).channel,t&&e&&t.channel!==e.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),u}async decompressTextureAsync(t,e=1/0){if(this.textureUtils===null)throw new Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(t,e)}processBuffer(t){const e=this.json,o=this.buffers;return e.buffers||(e.buffers=[{byteLength:0}]),o.push(t),0}processBufferView(t,e,o,i,s){const n=this.json;n.bufferViews||(n.bufferViews=[]);let r;switch(e){case lt.BYTE:case lt.UNSIGNED_BYTE:r=1;break;case lt.SHORT:case lt.UNSIGNED_SHORT:r=2;break;default:r=4}let a=t.itemSize*r;s===lt.ARRAY_BUFFER&&(a=Math.ceil(a/4)*4);const l=Jn(i*a),p=new DataView(new ArrayBuffer(l));let h=0;for(let f=o;f<o+i;f++){for(let d=0;d<t.itemSize;d++){let m;t.itemSize>4?m=t.array[f*t.itemSize+d]:(d===0?m=t.getX(f):d===1?m=t.getY(f):d===2?m=t.getZ(f):d===3&&(m=t.getW(f)),t.normalized===!0&&(m=gt.normalize(m,t.array))),e===lt.FLOAT?p.setFloat32(h,m,!0):e===lt.INT?p.setInt32(h,m,!0):e===lt.UNSIGNED_INT?p.setUint32(h,m,!0):e===lt.SHORT?p.setInt16(h,m,!0):e===lt.UNSIGNED_SHORT?p.setUint16(h,m,!0):e===lt.BYTE?p.setInt8(h,m):e===lt.UNSIGNED_BYTE&&p.setUint8(h,m),h+=r}h%a!==0&&(h+=a-h%a)}const u={buffer:this.processBuffer(p.buffer),byteOffset:this.byteOffset,byteLength:l};return s!==void 0&&(u.target=s),s===lt.ARRAY_BUFFER&&(u.byteStride=a),this.byteOffset+=l,n.bufferViews.push(u),{id:n.bufferViews.length-1,byteLength:0}}processBufferViewImage(t){const e=this,o=e.json;return o.bufferViews||(o.bufferViews=[]),new Promise(function(i){const s=new FileReader;s.readAsArrayBuffer(t),s.onloadend=function(){const n=Ai(s.result),r={buffer:e.processBuffer(n),byteOffset:e.byteOffset,byteLength:n.byteLength};e.byteOffset+=n.byteLength,i(o.bufferViews.push(r)-1)}})}processAccessor(t,e,o,i){const s=this.json,n={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"};let r;if(t.array.constructor===Float32Array)r=lt.FLOAT;else if(t.array.constructor===Int32Array)r=lt.INT;else if(t.array.constructor===Uint32Array)r=lt.UNSIGNED_INT;else if(t.array.constructor===Int16Array)r=lt.SHORT;else if(t.array.constructor===Uint16Array)r=lt.UNSIGNED_SHORT;else if(t.array.constructor===Int8Array)r=lt.BYTE;else if(t.array.constructor===Uint8Array)r=lt.UNSIGNED_BYTE;else throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+t.array.constructor.name);if(o===void 0&&(o=0),(i===void 0||i===1/0)&&(i=t.count),i===0)return null;const a=qa(t,o,i);let l;e!==void 0&&(l=t===e.index?lt.ELEMENT_ARRAY_BUFFER:lt.ARRAY_BUFFER);const p=this.processBufferView(t,r,o,i,l),h={bufferView:p.id,byteOffset:p.byteOffset,componentType:r,count:i,max:a.max,min:a.min,type:n[t.itemSize]};return t.normalized===!0&&(h.normalized=!0),s.accessors||(s.accessors=[]),s.accessors.push(h)-1}processImage(t,e,o,i="image/png"){if(t!==null){const s=this,n=s.cache,r=s.json,a=s.options,l=s.pending;n.images.has(t)||n.images.set(t,{});const p=n.images.get(t),h=i+":flipY/"+o.toString();if(p[h]!==void 0)return p[h];r.images||(r.images=[]);const u={mimeType:i},c=Gs();c.width=Math.min(t.width,a.maxTextureSize),c.height=Math.min(t.height,a.maxTextureSize);const f=c.getContext("2d",{willReadFrequently:!0});if(o===!0&&(f.translate(0,c.height),f.scale(1,-1)),t.data!==void 0){e!==ds&&console.error("GLTFExporter: Only RGBAFormat is supported.",e),(t.width>a.maxTextureSize||t.height>a.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",t);const m=new Uint8ClampedArray(t.height*t.width*4);for(let x=0;x<m.length;x+=4)m[x+0]=t.data[x+0],m[x+1]=t.data[x+1],m[x+2]=t.data[x+2],m[x+3]=t.data[x+3];f.putImageData(new ImageData(m,t.width,t.height),0,0)}else if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas)f.drawImage(t,0,0,c.width,c.height);else throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");a.binary===!0?l.push($s(c,i).then(m=>s.processBufferViewImage(m)).then(m=>{u.bufferView=m})):c.toDataURL!==void 0?u.uri=c.toDataURL(i):l.push($s(c,i).then(m=>new FileReader().readAsDataURL(m)).then(m=>{u.uri=m}));const d=r.images.push(u)-1;return p[h]=d,d}else throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(t){const e=this.json;e.samplers||(e.samplers=[]);const o={magFilter:Yt[t.magFilter],minFilter:Yt[t.minFilter],wrapS:Yt[t.wrapS],wrapT:Yt[t.wrapT]};return e.samplers.push(o)-1}async processTextureAsync(t){const o=this.options,i=this.cache,s=this.json;if(i.textures.has(t))return i.textures.get(t);s.textures||(s.textures=[]),t instanceof wi&&(t=await this.decompressTextureAsync(t,o.maxTextureSize));let n=t.userData.mimeType;n==="image/webp"&&(n="image/png");const r={sampler:this.processSampler(t),source:this.processImage(t.image,t.format,t.flipY,n)};t.name&&(r.name=t.name),await this._invokeAllAsync(async function(l){l.writeTexture&&await l.writeTexture(t,r)});const a=s.textures.push(r)-1;return i.textures.set(t,a),a}async processMaterialAsync(t){const e=this.cache,o=this.json;if(e.materials.has(t))return e.materials.get(t);if(t.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;o.materials||(o.materials=[]);const i={pbrMetallicRoughness:{}};t.isMeshStandardMaterial!==!0&&t.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const s=t.color.toArray().concat([t.opacity]);if(bo(s,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=s),t.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=t.metalness,i.pbrMetallicRoughness.roughnessFactor=t.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),t.metalnessMap||t.roughnessMap){const r=await this.buildMetalRoughTextureAsync(t.metalnessMap,t.roughnessMap),a={index:await this.processTextureAsync(r),texCoord:r.channel};this.applyTextureTransform(a,r),i.pbrMetallicRoughness.metallicRoughnessTexture=a}if(t.map){const r={index:await this.processTextureAsync(t.map),texCoord:t.map.channel};this.applyTextureTransform(r,t.map),i.pbrMetallicRoughness.baseColorTexture=r}if(t.emissive){const r=t.emissive;if(Math.max(r.r,r.g,r.b)>0&&(i.emissiveFactor=t.emissive.toArray()),t.emissiveMap){const l={index:await this.processTextureAsync(t.emissiveMap),texCoord:t.emissiveMap.channel};this.applyTextureTransform(l,t.emissiveMap),i.emissiveTexture=l}}if(t.normalMap){const r={index:await this.processTextureAsync(t.normalMap),texCoord:t.normalMap.channel};t.normalScale&&t.normalScale.x!==1&&(r.scale=t.normalScale.x),this.applyTextureTransform(r,t.normalMap),i.normalTexture=r}if(t.aoMap){const r={index:await this.processTextureAsync(t.aoMap),texCoord:t.aoMap.channel};t.aoMapIntensity!==1&&(r.strength=t.aoMapIntensity),this.applyTextureTransform(r,t.aoMap),i.occlusionTexture=r}t.transparent?i.alphaMode="BLEND":t.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=t.alphaTest),t.side===Ae&&(i.doubleSided=!0),t.name!==""&&(i.name=t.name),this.serializeUserData(t,i),await this._invokeAllAsync(async function(r){r.writeMaterialAsync&&await r.writeMaterialAsync(t,i)});const n=o.materials.push(i)-1;return e.materials.set(t,n),n}async processMeshAsync(t){const e=this.cache,o=this.json,i=[t.geometry.uuid];if(Array.isArray(t.material))for(let z=0,v=t.material.length;z<v;z++)i.push(t.material[z].uuid);else i.push(t.material.uuid);const s=i.join(":");if(e.meshes.has(s))return e.meshes.get(s);const n=t.geometry;let r;t.isLineSegments?r=lt.LINES:t.isLineLoop?r=lt.LINE_LOOP:t.isLine?r=lt.LINE_STRIP:t.isPoints?r=lt.POINTS:r=t.material.wireframe?lt.LINES:lt.TRIANGLES;const a={},l={},p=[],h=[],u={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},c=n.getAttribute("normal");c!==void 0&&!this.isNormalizedNormalAttribute(c)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),n.setAttribute("normal",this.createNormalizedNormalAttribute(c)));let f=null;for(let z in n.attributes){if(z.slice(0,5)==="morph")continue;const v=n.attributes[z];if(z=u[z]||z.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(z)||(z="_"+z),e.attributes.has(this.getUID(v))){l[z]=e.attributes.get(this.getUID(v));continue}f=null;const B=v.array;z==="JOINTS_0"&&!(B instanceof Uint16Array)&&!(B instanceof Uint8Array)?(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),f=new Ot(new Uint16Array(B),v.itemSize,v.normalized)):(B instanceof Uint32Array||B instanceof Int32Array)&&!z.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${z}" converted to type FLOAT.`),f=hi.Utils.toFloat32BufferAttribute(v));const A=this.processAccessor(f||v,n);A!==null&&(z.startsWith("_")||this.detectMeshQuantization(z,v),l[z]=A,e.attributes.set(this.getUID(v),A))}if(c!==void 0&&n.setAttribute("normal",c),Object.keys(l).length===0)return null;if(t.morphTargetInfluences!==void 0&&t.morphTargetInfluences.length>0){const z=[],v=[],C={};if(t.morphTargetDictionary!==void 0)for(const B in t.morphTargetDictionary)C[t.morphTargetDictionary[B]]=B;for(let B=0;B<t.morphTargetInfluences.length;++B){const A={};let M=!1;for(const _ in n.morphAttributes){if(_!=="position"&&_!=="normal"){M||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),M=!0);continue}const P=n.morphAttributes[_][B],k=_.toUpperCase(),T=n.attributes[_];if(e.attributes.has(this.getUID(P,!0))){A[k]=e.attributes.get(this.getUID(P,!0));continue}const F=P.clone();if(!n.morphTargetsRelative)for(let D=0,J=P.count;D<J;D++)for(let Z=0;Z<P.itemSize;Z++)Z===0&&F.setX(D,P.getX(D)-T.getX(D)),Z===1&&F.setY(D,P.getY(D)-T.getY(D)),Z===2&&F.setZ(D,P.getZ(D)-T.getZ(D)),Z===3&&F.setW(D,P.getW(D)-T.getW(D));A[k]=this.processAccessor(F,n),e.attributes.set(this.getUID(T,!0),A[k])}h.push(A),z.push(t.morphTargetInfluences[B]),t.morphTargetDictionary!==void 0&&v.push(C[B])}a.weights=z,v.length>0&&(a.extras={},a.extras.targetNames=v)}const d=Array.isArray(t.material);if(d&&n.groups.length===0)return null;let m=!1;if(d&&n.index===null){const z=[];for(let v=0,C=n.attributes.position.count;v<C;v++)z[v]=v;n.setIndex(z),m=!0}const x=d?t.material:[t.material],g=d?n.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let z=0,v=g.length;z<v;z++){const C={mode:r,attributes:l};if(this.serializeUserData(n,C),h.length>0&&(C.targets=h),n.index!==null){let A=this.getUID(n.index);(g[z].start!==void 0||g[z].count!==void 0)&&(A+=":"+g[z].start+":"+g[z].count),e.attributes.has(A)?C.indices=e.attributes.get(A):(C.indices=this.processAccessor(n.index,n,g[z].start,g[z].count),e.attributes.set(A,C.indices)),C.indices===null&&delete C.indices}const B=await this.processMaterialAsync(x[g[z].materialIndex]);B!==null&&(C.material=B),p.push(C)}m===!0&&n.setIndex(null),a.primitives=p,o.meshes||(o.meshes=[]),await this._invokeAllAsync(function(z){z.writeMesh&&z.writeMesh(t,a)});const b=o.meshes.push(a)-1;return e.meshes.set(s,b),b}detectMeshQuantization(t,e){if(this.extensionsUsed[Ci])return;let o;switch(e.array.constructor){case Int8Array:o="byte";break;case Uint8Array:o="unsigned byte";break;case Int16Array:o="short";break;case Uint16Array:o="unsigned short";break;default:return}e.normalized&&(o+=" normalized");const i=t.split("_",1)[0];Xs[i]&&Xs[i].includes(o)&&(this.extensionsUsed[Ci]=!0,this.extensionsRequired[Ci]=!0)}processCamera(t){const e=this.json;e.cameras||(e.cameras=[]);const o=t.isOrthographicCamera,i={type:o?"orthographic":"perspective"};return o?i.orthographic={xmag:t.right*2,ymag:t.top*2,zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near}:i.perspective={aspectRatio:t.aspect,yfov:gt.degToRad(t.fov),zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near},t.name!==""&&(i.name=t.type),e.cameras.push(i)-1}processAnimation(t,e){const o=this.json,i=this.nodeMap;o.animations||(o.animations=[]),t=hi.Utils.mergeMorphTargetTracks(t.clone(),e);const s=t.tracks,n=[],r=[];for(let a=0;a<s.length;++a){const l=s[a],p=li.parseTrackName(l.name);let h=li.findNode(e,p.nodeName);const u=Zs[p.propertyName];if(p.objectName==="bones"&&(h.isSkinnedMesh===!0?h=h.skeleton.getBoneByName(p.objectIndex):h=void 0),!h||!u){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',l.name);continue}const c=1;let f=l.values.length/l.times.length;u===Zs.morphTargetInfluences&&(f/=h.morphTargetInfluences.length);let d;l.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(d="CUBICSPLINE",f/=3):l.getInterpolation()===Pr?d="STEP":d="LINEAR",r.push({input:this.processAccessor(new Ot(l.times,c)),output:this.processAccessor(new Ot(l.values,f)),interpolation:d}),n.push({sampler:r.length-1,target:{node:i.get(h),path:u}})}return o.animations.push({name:t.name||"clip_"+o.animations.length,samplers:r,channels:n}),o.animations.length-1}processSkin(t){const e=this.json,o=this.nodeMap,i=e.nodes[o.get(t)],s=t.skeleton;if(s===void 0)return null;const n=t.skeleton.bones[0];if(n===void 0)return null;const r=[],a=new Float32Array(s.bones.length*16),l=new Rt;for(let h=0;h<s.bones.length;++h)r.push(o.get(s.bones[h])),l.copy(s.boneInverses[h]),l.multiply(t.bindMatrix).toArray(a,h*16);return e.skins===void 0&&(e.skins=[]),e.skins.push({inverseBindMatrices:this.processAccessor(new Ot(a,16)),joints:r,skeleton:o.get(n)}),i.skin=e.skins.length-1}async processNodeAsync(t){const e=this.json,o=this.options,i=this.nodeMap;e.nodes||(e.nodes=[]);const s={};if(o.trs){const r=t.quaternion.toArray(),a=t.position.toArray(),l=t.scale.toArray();bo(r,[0,0,0,1])||(s.rotation=r),bo(a,[0,0,0])||(s.translation=a),bo(l,[1,1,1])||(s.scale=l)}else t.matrixAutoUpdate&&t.updateMatrix(),Wa(t.matrix)===!1&&(s.matrix=t.matrix.elements);if(t.name!==""&&(s.name=String(t.name)),this.serializeUserData(t,s),t.isMesh||t.isLine||t.isPoints){const r=await this.processMeshAsync(t);r!==null&&(s.mesh=r)}else t.isCamera&&(s.camera=this.processCamera(t));if(t.isSkinnedMesh&&this.skins.push(t),t.children.length>0){const r=[];for(let a=0,l=t.children.length;a<l;a++){const p=t.children[a];if(p.visible||o.onlyVisible===!1){const h=await this.processNodeAsync(p);h!==null&&r.push(h)}}r.length>0&&(s.children=r)}await this._invokeAllAsync(function(r){r.writeNode&&r.writeNode(t,s)});const n=e.nodes.push(s)-1;return i.set(t,n),n}async processSceneAsync(t){const e=this.json,o=this.options;e.scenes||(e.scenes=[],e.scene=0);const i={};t.name!==""&&(i.name=t.name),e.scenes.push(i);const s=[];for(let n=0,r=t.children.length;n<r;n++){const a=t.children[n];if(a.visible||o.onlyVisible===!1){const l=await this.processNodeAsync(a);l!==null&&s.push(l)}}s.length>0&&(i.nodes=s),this.serializeUserData(t,i)}async processObjectsAsync(t){const e=new ri;e.name="AuxScene";for(let o=0;o<t.length;o++)e.children.push(t[o]);await this.processSceneAsync(e)}async processInputAsync(t){const e=this.options;t=t instanceof Array?t:[t],await this._invokeAllAsync(function(i){i.beforeParse&&i.beforeParse(t)});const o=[];for(let i=0;i<t.length;i++)t[i]instanceof ri?await this.processSceneAsync(t[i]):o.push(t[i]);o.length>0&&await this.processObjectsAsync(o);for(let i=0;i<this.skins.length;++i)this.processSkin(this.skins[i]);for(let i=0;i<e.animations.length;++i)this.processAnimation(e.animations[i],t[0]);await this._invokeAllAsync(function(i){i.afterParse&&i.afterParse(t)})}async _invokeAllAsync(t){for(let e=0,o=this.plugins.length;e<o;e++)await t(this.plugins[e])}}class Ja{constructor(t){this.writer=t,this.name="KHR_lights_punctual"}writeNode(t,e){if(!t.isLight)return;if(!t.isDirectionalLight&&!t.isPointLight&&!t.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",t);return}const o=this.writer,i=o.json,s=o.extensionsUsed,n={};t.name&&(n.name=t.name),n.color=t.color.toArray(),n.intensity=t.intensity,t.isDirectionalLight?n.type="directional":t.isPointLight?(n.type="point",t.distance>0&&(n.range=t.distance)):t.isSpotLight&&(n.type="spot",t.distance>0&&(n.range=t.distance),n.spot={},n.spot.innerConeAngle=(1-t.penumbra)*t.angle,n.spot.outerConeAngle=t.angle),t.decay!==void 0&&t.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),t.target&&(t.target.parent!==t||t.target.position.x!==0||t.target.position.y!==0||t.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),s[this.name]||(i.extensions=i.extensions||{},i.extensions[this.name]={lights:[]},s[this.name]=!0);const r=i.extensions[this.name].lights;r.push(n),e.extensions=e.extensions||{},e.extensions[this.name]={light:r.length-1}}}class Qa{constructor(t){this.writer=t,this.name="KHR_materials_unlit"}async writeMaterialAsync(t,e){if(!t.isMeshBasicMaterial)return;const i=this.writer.extensionsUsed;e.extensions=e.extensions||{},e.extensions[this.name]={},i[this.name]=!0,e.pbrMetallicRoughness.metallicFactor=0,e.pbrMetallicRoughness.roughnessFactor=.9}}class tl{constructor(t){this.writer=t,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.clearcoat===0)return;const o=this.writer,i=o.extensionsUsed,s={};if(s.clearcoatFactor=t.clearcoat,t.clearcoatMap){const n={index:await o.processTextureAsync(t.clearcoatMap),texCoord:t.clearcoatMap.channel};o.applyTextureTransform(n,t.clearcoatMap),s.clearcoatTexture=n}if(s.clearcoatRoughnessFactor=t.clearcoatRoughness,t.clearcoatRoughnessMap){const n={index:await o.processTextureAsync(t.clearcoatRoughnessMap),texCoord:t.clearcoatRoughnessMap.channel};o.applyTextureTransform(n,t.clearcoatRoughnessMap),s.clearcoatRoughnessTexture=n}if(t.clearcoatNormalMap){const n={index:await o.processTextureAsync(t.clearcoatNormalMap),texCoord:t.clearcoatNormalMap.channel};t.clearcoatNormalScale.x!==1&&(n.scale=t.clearcoatNormalScale.x),o.applyTextureTransform(n,t.clearcoatNormalMap),s.clearcoatNormalTexture=n}e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class el{constructor(t){this.writer=t,this.name="KHR_materials_dispersion"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.dispersion===0)return;const i=this.writer.extensionsUsed,s={};s.dispersion=t.dispersion,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class ol{constructor(t){this.writer=t,this.name="KHR_materials_iridescence"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.iridescence===0)return;const o=this.writer,i=o.extensionsUsed,s={};if(s.iridescenceFactor=t.iridescence,t.iridescenceMap){const n={index:await o.processTextureAsync(t.iridescenceMap),texCoord:t.iridescenceMap.channel};o.applyTextureTransform(n,t.iridescenceMap),s.iridescenceTexture=n}if(s.iridescenceIor=t.iridescenceIOR,s.iridescenceThicknessMinimum=t.iridescenceThicknessRange[0],s.iridescenceThicknessMaximum=t.iridescenceThicknessRange[1],t.iridescenceThicknessMap){const n={index:await o.processTextureAsync(t.iridescenceThicknessMap),texCoord:t.iridescenceThicknessMap.channel};o.applyTextureTransform(n,t.iridescenceThicknessMap),s.iridescenceThicknessTexture=n}e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class il{constructor(t){this.writer=t,this.name="KHR_materials_transmission"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.transmission===0)return;const o=this.writer,i=o.extensionsUsed,s={};if(s.transmissionFactor=t.transmission,t.transmissionMap){const n={index:await o.processTextureAsync(t.transmissionMap),texCoord:t.transmissionMap.channel};o.applyTextureTransform(n,t.transmissionMap),s.transmissionTexture=n}e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class sl{constructor(t){this.writer=t,this.name="KHR_materials_volume"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.transmission===0)return;const o=this.writer,i=o.extensionsUsed,s={};if(s.thicknessFactor=t.thickness,t.thicknessMap){const n={index:await o.processTextureAsync(t.thicknessMap),texCoord:t.thicknessMap.channel};o.applyTextureTransform(n,t.thicknessMap),s.thicknessTexture=n}t.attenuationDistance!==1/0&&(s.attenuationDistance=t.attenuationDistance),s.attenuationColor=t.attenuationColor.toArray(),e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class nl{constructor(t){this.writer=t,this.name="KHR_materials_ior"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.ior===1.5)return;const i=this.writer.extensionsUsed,s={};s.ior=t.ior,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class rl{constructor(t){this.writer=t,this.name="KHR_materials_specular"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.specularIntensity===1&&t.specularColor.equals(ja)&&!t.specularIntensityMap&&!t.specularColorMap)return;const o=this.writer,i=o.extensionsUsed,s={};if(t.specularIntensityMap){const n={index:await o.processTextureAsync(t.specularIntensityMap),texCoord:t.specularIntensityMap.channel};o.applyTextureTransform(n,t.specularIntensityMap),s.specularTexture=n}if(t.specularColorMap){const n={index:await o.processTextureAsync(t.specularColorMap),texCoord:t.specularColorMap.channel};o.applyTextureTransform(n,t.specularColorMap),s.specularColorTexture=n}s.specularFactor=t.specularIntensity,s.specularColorFactor=t.specularColor.toArray(),e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class al{constructor(t){this.writer=t,this.name="KHR_materials_sheen"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.sheen==0)return;const o=this.writer,i=o.extensionsUsed,s={};if(t.sheenRoughnessMap){const n={index:await o.processTextureAsync(t.sheenRoughnessMap),texCoord:t.sheenRoughnessMap.channel};o.applyTextureTransform(n,t.sheenRoughnessMap),s.sheenRoughnessTexture=n}if(t.sheenColorMap){const n={index:await o.processTextureAsync(t.sheenColorMap),texCoord:t.sheenColorMap.channel};o.applyTextureTransform(n,t.sheenColorMap),s.sheenColorTexture=n}s.sheenRoughnessFactor=t.sheenRoughness,s.sheenColorFactor=t.sheenColor.toArray(),e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class ll{constructor(t){this.writer=t,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.anisotropy==0)return;const o=this.writer,i=o.extensionsUsed,s={};if(t.anisotropyMap){const n={index:await o.processTextureAsync(t.anisotropyMap)};o.applyTextureTransform(n,t.anisotropyMap),s.anisotropyTexture=n}s.anisotropyStrength=t.anisotropy,s.anisotropyRotation=t.anisotropyRotation,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class cl{constructor(t){this.writer=t,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(t,e){if(!t.isMeshStandardMaterial||t.emissiveIntensity===1)return;const i=this.writer.extensionsUsed,s={};s.emissiveStrength=t.emissiveIntensity,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class pl{constructor(t){this.writer=t,this.name="EXT_materials_bump"}async writeMaterialAsync(t,e){if(!t.isMeshStandardMaterial||t.bumpScale===1&&!t.bumpMap)return;const o=this.writer,i=o.extensionsUsed,s={};if(t.bumpMap){const n={index:await o.processTextureAsync(t.bumpMap),texCoord:t.bumpMap.channel};o.applyTextureTransform(n,t.bumpMap),s.bumpTexture=n}s.bumpFactor=t.bumpScale,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class hl{constructor(t){this.writer=t,this.name="EXT_mesh_gpu_instancing"}writeNode(t,e){if(!t.isInstancedMesh)return;const o=this.writer,i=t,s=new Float32Array(i.count*3),n=new Float32Array(i.count*4),r=new Float32Array(i.count*3),a=new Rt,l=new U,p=new Ne,h=new U;for(let c=0;c<i.count;c++)i.getMatrixAt(c,a),a.decompose(l,p,h),l.toArray(s,c*3),p.toArray(n,c*4),h.toArray(r,c*3);const u={TRANSLATION:o.processAccessor(new Ot(s,3)),ROTATION:o.processAccessor(new Ot(n,4)),SCALE:o.processAccessor(new Ot(r,3))};i.instanceColor&&(u._COLOR_0=o.processAccessor(i.instanceColor)),e.extensions=e.extensions||{},e.extensions[this.name]={attributes:u},o.extensionsUsed[this.name]=!0,o.extensionsRequired[this.name]=!0}}hi.Utils={insertKeyframe:function(y,t){const o=y.getValueSize(),i=new y.TimeBufferType(y.times.length+1),s=new y.ValueBufferType(y.values.length+o),n=y.createInterpolant(new y.ValueBufferType(o));let r;if(y.times.length===0){i[0]=t;for(let a=0;a<o;a++)s[a]=0;r=0}else if(t<y.times[0]){if(Math.abs(y.times[0]-t)<.001)return 0;i[0]=t,i.set(y.times,1),s.set(n.evaluate(t),0),s.set(y.values,o),r=0}else if(t>y.times[y.times.length-1]){if(Math.abs(y.times[y.times.length-1]-t)<.001)return y.times.length-1;i[i.length-1]=t,i.set(y.times,0),s.set(y.values,0),s.set(n.evaluate(t),y.values.length),r=i.length-1}else for(let a=0;a<y.times.length;a++){if(Math.abs(y.times[a]-t)<.001)return a;if(y.times[a]<t&&y.times[a+1]>t){i.set(y.times.slice(0,a+1),0),i[a+1]=t,i.set(y.times.slice(a+1),a+2),s.set(y.values.slice(0,(a+1)*o),0),s.set(n.evaluate(t),(a+1)*o),s.set(y.values.slice((a+1)*o),(a+2)*o),r=a+1;break}}return y.times=i,y.values=s,r},mergeMorphTargetTracks:function(y,t){const e=[],o={},i=y.tracks;for(let s=0;s<i.length;++s){let n=i[s];const r=li.parseTrackName(n.name),a=li.findNode(t,r.nodeName);if(r.propertyName!=="morphTargetInfluences"||r.propertyIndex===void 0){e.push(n);continue}if(n.createInterpolant!==n.InterpolantFactoryMethodDiscrete&&n.createInterpolant!==n.InterpolantFactoryMethodLinear){if(n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),n=n.clone(),n.setInterpolation(Zr)}const l=a.morphTargetInfluences.length,p=a.morphTargetDictionary[r.propertyIndex];if(p===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+r.propertyIndex);let h;if(o[a.uuid]===void 0){h=n.clone();const c=new h.ValueBufferType(l*h.times.length);for(let f=0;f<h.times.length;f++)c[f*l+p]=h.values[f];h.name=(r.nodeName||"")+".morphTargetInfluences",h.values=c,o[a.uuid]=h,e.push(h);continue}const u=n.createInterpolant(new n.ValueBufferType(1));h=o[a.uuid];for(let c=0;c<h.times.length;c++)h.values[c*l+p]=u.evaluate(h.times[c]);for(let c=0;c<n.times.length;c++){const f=this.insertKeyframe(h,n.times[c]);h.values[f*l+p]=n.values[c]}}return y.tracks=e,y},toFloat32BufferAttribute:function(y){const t=new Ot(new Float32Array(y.count*y.itemSize),y.itemSize,!1);if(!y.normalized&&!y.isInterleavedBufferAttribute)return t.array.set(y.array),t;for(let e=0,o=y.count;e<o;e++)for(let i=0;i<y.itemSize;i++)t.setComponent(e,i,y.getComponent(e,i));return t}};const Ze={east:{axis:"x",sign:1,opposite:"west"},west:{axis:"x",sign:-1,opposite:"east"},top:{axis:"y",sign:1,opposite:"bottom"},bottom:{axis:"y",sign:-1,opposite:"top"},south:{axis:"z",sign:1,opposite:"north"},north:{axis:"z",sign:-1,opposite:"south"}};class yl{constructor(){this.stats={originalFaces:0,optimizedFaces:0,culledFaces:0,mergedQuads:0}}optimize(t,e={}){const{cullFaces:o=!0,mergeCubes:i=!0,batchMaterials:s=!0,mergeAll:n=!1,deduplicateVertices:r=!0}=e;this.resetStats();const a=this.buildBlockMap(t),l=[],p=[];for(const u of t)u.type==="cube"?l.push(u):p.push(u);let h=[];if(l.length>0)if(i){const u=this.greedyMeshCubes(l,a,o,s);h.push(...u)}else if(o){const u=this.cullCubeFaces(l,a,s);h.push(...u)}else{const u=this.createSimpleMeshes(l,s);h.push(...u)}if(p.length>0){const u=this.processNonCubeBlocks(p,a,o,s);h.push(...u)}return n&&h.length>1&&(h=this.mergeAllMeshes(h)),r&&(h=h.map(u=>{const c=this.deduplicateGeometryVertices(u.geometry);return u.geometry.dispose(),u.geometry=c,u})),this.stats.finalMeshCount=h.length,this.stats.finalVertexCount=h.reduce((u,c)=>{var f;return u+(((f=c.geometry.getAttribute("position"))==null?void 0:f.count)||0)},0),this.stats.finalTriangleCount=h.reduce((u,c)=>{var d;const f=c.geometry.getIndex();return f?u+f.count/3:u+(((d=c.geometry.getAttribute("position"))==null?void 0:d.count)||0)/3},0),{meshes:h,stats:{...this.stats}}}resetStats(){this.stats={originalFaces:0,optimizedFaces:0,culledFaces:0,mergedQuads:0}}buildBlockMap(t){const e=new Map;for(const o of t){const i=o.gridPosition,s=`${i.x},${i.y},${i.z}`;e.set(s,o)}return e}hasNeighbor(t,e,o,i){return t.has(`${e},${o},${i}`)}getNeighbor(t,e,o,i){return t.get(`${e},${o},${i}`)}shouldCullFace(t,e,o){const i=t.gridPosition,s=Ze[e],n={x:i.x+(s.axis==="x"?s.sign:0),y:i.y+(s.axis==="y"?s.sign:0),z:i.z+(s.axis==="z"?s.sign:0)},r=this.getNeighbor(o,n.x,n.y,n.z);return r?r.type==="cube":!1}greedyMeshCubes(t,e,o,i){const s=new Map;for(const r of t){const a=r.color.toLowerCase();s.has(a)||s.set(a,[]),s.get(a).push(r)}const n=[];for(const[r,a]of s){const l=new Set;for(const h of a){const u=h.gridPosition;l.add(`${u.x},${u.y},${u.z}`)}const p=[];for(const[h,u]of Object.entries(Ze)){const c=this.greedyMeshFace(a,h,u,l,e,o);p.push(...c)}if(this.stats.originalFaces+=a.length*6,p.length>0){const h=this.createGeometryFromQuads(p),u=new Dt(h,new kt({color:new ot(r),roughness:.7,metalness:.1}));u.name=`merged_cubes_${r}`,n.push(u),this.stats.optimizedFaces+=p.length,this.stats.mergedQuads+=p.length}}return n}greedyMeshFace(t,e,o,i,s,n){const r=[],a=["x","y","z"].filter(u=>u!==o.axis),[l,p]=a,h=new Map;for(const u of t){const c=u.gridPosition,f=c[o.axis];h.has(f)||h.set(f,new Map);let d=!0;if(n){const m={x:c.x+(o.axis==="x"?o.sign:0),y:c.y+(o.axis==="y"?o.sign:0),z:c.z+(o.axis==="z"?o.sign:0)},x=`${m.x},${m.y},${m.z}`;i.has(x)?(d=!1,this.stats.culledFaces++):s.has(x)&&(d=!1,this.stats.culledFaces++)}if(d){const m=c[l],x=c[p];h.get(f).set(`${m},${x}`,{pos:c,cube:u})}}for(const[u,c]of h){const f=new Set,d=Array.from(c.keys()).map(m=>{const[x,g]=m.split(",").map(Number);return{u:x,v:g,key:m}}).sort((m,x)=>m.v-x.v||m.u-x.u);for(const{u:m,v:x,key:g}of d){if(f.has(g))continue;let b=1,z=1;for(;c.has(`${m+b},${x}`)&&!f.has(`${m+b},${x}`);)b++;t:for(;;){for(let C=0;C<b;C++){const B=`${m+C},${x+z}`;if(!c.has(B)||f.has(B))break t}z++}for(let C=0;C<b;C++)for(let B=0;B<z;B++)f.add(`${m+C},${x+B}`);const v=this.createQuad(e,o,u,m,x,b,z,l,p);r.push(v)}}return r}createQuad(t,e,o,i,s,n,r,a,l){const p=[],h=e.sign>0?1:0,u=[[0,0],[n,0],[n,r],[0,r]];e.sign<0&&u.reverse();for(const[c,f]of u){const d={x:0,y:0,z:0};d[e.axis]=o+h,d[a]=i+c,d[l]=s+f,p.push(d)}return{vertices:p,normal:{x:e.axis==="x"?e.sign:0,y:e.axis==="y"?e.sign:0,z:e.axis==="z"?e.sign:0}}}createGeometryFromQuads(t){const e=[],o=[],i=[];let s=0;for(const r of t){for(const a of r.vertices)e.push(a.x,a.y,a.z),o.push(r.normal.x,r.normal.y,r.normal.z);i.push(s,s+1,s+2,s,s+2,s+3),s+=4}const n=new le;return n.setAttribute("position",new _t(e,3)),n.setAttribute("normal",new _t(o,3)),n.setIndex(i),n}cullCubeFaces(t,e,o){const i=o?new Map:null,s=[];for(const n of t){const r=n.gridPosition,a=[];this.stats.originalFaces+=6;for(const[h,u]of Object.entries(Ze))this.shouldCullFace(n,h,e)?this.stats.culledFaces++:(a.push(h),this.stats.optimizedFaces++);if(a.length===0)continue;const l=this.createCubeWithFaces(r,a),p=n.color.toLowerCase();if(o)i.has(p)||i.set(p,[]),i.get(p).push(l);else{const h=new Dt(l,new kt({color:new ot(p),roughness:.7,metalness:.1}));s.push(h)}}if(o&&i)for(const[n,r]of i){const a=this.mergeGeometries(r),l=new Dt(a,new kt({color:new ot(n),roughness:.7,metalness:.1}));l.name=`culled_cubes_${n}`,s.push(l)}return s}createCubeWithFaces(t,e){const o=[];for(const i of e){const s=Ze[i],n=["x","y","z"].filter(r=>r!==s.axis);o.push(this.createQuad(i,s,t[s.axis],t[n[0]],t[n[1]],1,1,n[0],n[1]))}return this.createGeometryFromQuads(o)}mergeGeometries(t){const e=[],o=[],i=[];let s=0;for(const r of t){const a=r.getAttribute("position"),l=r.getAttribute("normal"),p=r.getIndex();for(let h=0;h<a.count;h++)e.push(a.getX(h),a.getY(h),a.getZ(h)),o.push(l.getX(h),l.getY(h),l.getZ(h));for(let h=0;h<p.count;h++)i.push(p.getX(h)+s);s+=a.count,r.dispose()}const n=new le;return n.setAttribute("position",new _t(e,3)),n.setAttribute("normal",new _t(o,3)),n.setIndex(i),n}processNonCubeBlocks(t,e,o,i){const s=[],n=i?new Map:null;for(const r of t){const a=r.mesh.geometry.clone(),l=new Rt;l.compose(r.mesh.position,r.mesh.quaternion,r.mesh.scale),a.applyMatrix4(l);const p=r.color.toLowerCase(),h=a.index?a.index.count:a.attributes.position.count;if(this.stats.originalFaces+=Math.floor(h/6),this.stats.optimizedFaces+=Math.floor(h/6),i)n.has(p)||n.set(p,[]),n.get(p).push(a);else{const u=new Dt(a,new kt({color:new ot(p),roughness:.7,metalness:.1}));s.push(u)}}if(i&&n)for(const[r,a]of n){const l=this.mergeNonIndexedGeometries(a),p=new Dt(l,new kt({color:new ot(r),roughness:.7,metalness:.1}));p.name=`other_blocks_${r}`,s.push(p)}return s}mergeNonIndexedGeometries(t){const e=[],o=[],i=[];let s=!1;for(const r of t){const a=r.getAttribute("position"),l=r.getAttribute("normal"),p=r.getAttribute("uv");if(p&&(s=!0),r.index){const h=r.index;for(let u=0;u<h.count;u++){const c=h.getX(u);e.push(a.getX(c),a.getY(c),a.getZ(c)),l&&o.push(l.getX(c),l.getY(c),l.getZ(c)),p&&i.push(p.getX(c),p.getY(c))}}else for(let h=0;h<a.count;h++)e.push(a.getX(h),a.getY(h),a.getZ(h)),l&&o.push(l.getX(h),l.getY(h),l.getZ(h)),p&&i.push(p.getX(h),p.getY(h));r.dispose()}const n=new le;return n.setAttribute("position",new _t(e,3)),o.length>0?n.setAttribute("normal",new _t(o,3)):n.computeVertexNormals(),s&&i.length>0&&n.setAttribute("uv",new _t(i,2)),n}createSimpleMeshes(t,e){const o=e?new Map:null,i=[];for(const s of t){const n=new bi(1,1,1);n.translate(s.gridPosition.x+.5,s.gridPosition.y+.5,s.gridPosition.z+.5),this.stats.originalFaces+=6,this.stats.optimizedFaces+=6;const r=s.color.toLowerCase();if(e)o.has(r)||o.set(r,[]),o.get(r).push(n);else{const a=new Dt(n,new kt({color:new ot(r),roughness:.7,metalness:.1}));i.push(a)}}if(e&&o)for(const[s,n]of o){const r=this.mergeGeometries(n),a=new Dt(r,new kt({color:new ot(s),roughness:.7,metalness:.1}));a.name=`simple_cubes_${s}`,i.push(a)}return i}estimateFaceCount(t){let e=0;for(const o of t)if(o.type==="cube")e+=6;else{const i=o.mesh.geometry,s=i.index?i.index.count:i.attributes.position.count;e+=Math.floor(s/6)}return e}createInstancedExport(t){const e=new Map;for(const l of t)e.has(l.type)||e.set(l.type,[]),e.get(l.type).push(l);const o=[],i=new Rt,s=new U,n=new Ne,r=new U(1,1,1),a=new ko;for(const[l,p]of e){if(p.length===0)continue;const u=p[0].mesh.geometry.clone(),c=new Gn(u,new kt({vertexColors:!0,roughness:.7,metalness:.1}),p.length),f=new Float32Array(p.length*3);p.forEach((d,m)=>{s.copy(d.mesh.position),a.set(gt.degToRad(d.rotation.x),gt.degToRad(d.rotation.y),gt.degToRad(d.rotation.z)),n.setFromEuler(a),i.compose(s,n,r),c.setMatrixAt(m,i);const x=new ot(d.color);f[m*3]=x.r,f[m*3+1]=x.g,f[m*3+2]=x.b}),c.instanceColor=new $n(f,3),c.instanceMatrix.needsUpdate=!0,c.name=`instanced_${l}`,c.castShadow=!0,c.receiveShadow=!0,o.push(c)}return{meshes:o,stats:{totalBlocks:t.length,uniqueTypes:e.size,drawCalls:o.length}}}estimateOptimizedCount(t,e={}){const{cullFaces:o=!0,mergeCubes:i=!0}=e;if(!o&&!i)return this.estimateFaceCount(t);const s=this.buildBlockMap(t);let n=0;for(const r of t)if(r.type==="cube")for(const a of Object.keys(Ze))(!o||!this.shouldCullFace(r,a,s))&&n++;else{const a=r.mesh.geometry,l=a.index?a.index.count:a.attributes.position.count;n+=Math.floor(l/6)}if(i){const r=t.filter(p=>p.type==="cube").length,a=n-(r>0?t.filter(p=>p.type==="cube").reduce((p,h)=>{let u=0;for(const c of Object.keys(Ze))(!o||!this.shouldCullFace(h,c,s))&&u++;return p+u},0):0),l=n-a;n=Math.floor(l*.4)+a}return n}mergeAllMeshes(t){if(t.length===0)return[];if(t.length===1)return t;const e=[];for(const n of t){const r=n.geometry.clone(),a=n.material.color||new ot(8421504),l=r.getAttribute("position").count,p=new Float32Array(l*3);for(let h=0;h<l;h++)p[h*3]=a.r,p[h*3+1]=a.g,p[h*3+2]=a.b;r.setAttribute("color",new Ot(p,3)),e.push(r),n.geometry.dispose(),n.material.dispose()}const o=jr(e,!1);e.forEach(n=>n.dispose());const i=new kt({vertexColors:!0,roughness:.7,metalness:.1}),s=new Dt(o,i);return s.name="merged_all",[s]}deduplicateGeometryVertices(t){const e=t.getAttribute("position"),o=t.getAttribute("normal"),i=t.getAttribute("color"),s=t.getAttribute("uv"),n=t.getIndex();if(!e)return t;const r=new Map,a=[],l=[],p=[],h=[],u=[],c=1e3,f=b=>{const z=Math.round(e.getX(b)*c),v=Math.round(e.getY(b)*c),C=Math.round(e.getZ(b)*c);let B=`${z},${v},${C}`;if(o){const A=Math.round(o.getX(b)*100),M=Math.round(o.getY(b)*100),_=Math.round(o.getZ(b)*100);B+=`|${A},${M},${_}`}if(i){const A=Math.round(i.getX(b)*255),M=Math.round(i.getY(b)*255),_=Math.round(i.getZ(b)*255);B+=`|${A},${M},${_}`}return B},d=b=>{const z=f(b);if(r.has(z))return r.get(z);const v=a.length/3;return r.set(z,v),a.push(e.getX(b),e.getY(b),e.getZ(b)),o&&l.push(o.getX(b),o.getY(b),o.getZ(b)),i&&p.push(i.getX(b),i.getY(b),i.getZ(b)),s&&h.push(s.getX(b),s.getY(b)),v};if(n)for(let b=0;b<n.count;b++){const z=n.getX(b),v=d(z);u.push(v)}else for(let b=0;b<e.count;b++){const z=d(b);u.push(z)}const m=new le;m.setAttribute("position",new _t(a,3)),l.length>0&&m.setAttribute("normal",new _t(l,3)),p.length>0&&m.setAttribute("color",new _t(p,3)),h.length>0&&m.setAttribute("uv",new _t(h,2)),m.setIndex(u);const x=e.count,g=a.length/3;return this.stats.verticesRemoved=(this.stats.verticesRemoved||0)+(x-g),m}}class ul{constructor(){this.exporter=new hi,this.optimizer=new yl}async exportScene(t,e={}){var g;const{binary:o=!0,includeAnimations:i=!1,animator:s=null,bakedTexture:n=null,uvData:r=null,cullFaces:a=!1,mergeCubes:l=!1,batchMaterials:p=!1,useInstancing:h=!1,mergeAll:u=!1,deduplicateVertices:c=!0}=e;if(t.blocks.size===0)throw new Error("No blocks to export");const f=new ri,d=t.getAllBlocks(),m=a||l||p||u;if(h&&!n){const b=this.optimizer.createInstancedExport(d);for(const z of b.meshes)f.add(z);console.log("Instancing stats:",b.stats)}else if(m&&!n){const b=this.optimizer.optimize(d,{cullFaces:a,mergeCubes:l,batchMaterials:p,mergeAll:u,deduplicateVertices:c});for(const z of b.meshes)f.add(z);console.log("Optimization stats:",b.stats)}else{let b=null;n&&(b=new fs(n),b.magFilter=me,b.minFilter=me,b.generateMipmaps=!1,b.flipY=!1,b.colorSpace=ys);const z=["east","west","top","bottom","south","north"];for(const v of d){const C=v.mesh.clone();C.name=v.id,C.geometry=v.mesh.geometry.clone();const B=Array.isArray(v.mesh.material)?v.mesh.material[0]:v.mesh.material;let A;if(b&&r&&r.has(v.id)){const M=r.get(v.id),_=C.geometry.getAttribute("uv");if(_&&M.faceUVs){for(let k=0;k<6;k++){const T=z[k],F=M.faceUVs[T];if(F)for(let D=0;D<4;D++){const J=k*4+D;_.setXY(J,F.u,F.v)}}_.needsUpdate=!0}A=new kt({map:b,roughness:B.roughness||.7,metalness:B.metalness||.1})}else A=new kt({color:new ot(v.color),roughness:B.roughness||.7,metalness:B.metalness||.1});(g=v.emissive)!=null&&g.enabled&&(A.emissive=new ot(v.emissive.color),A.emissiveIntensity=v.emissive.intensity),C.material=A,f.add(C)}}const x=[];if(i&&s&&s.getAllAnimations().length>0)for(const b of s.getAllAnimations()){const z=this.buildAnimationClip(b,t);z&&x.push(z)}try{const b=await this.exporter.parseAsync(f,{binary:o,animations:x});return this.disposeScene(f),b}catch(b){throw this.disposeScene(f),b}}disposeScene(t){t.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(o=>{o.map&&o.map.dispose(),o.dispose()}):(e.material.map&&e.material.map.dispose(),e.material.dispose()))})}buildAnimationClip(t,e){const o=[],i=new Map;for(const s of t.keyframes)i.has(s.blockId)||i.set(s.blockId,[]),i.get(s.blockId).push(s);for(const[s,n]of i){const r=e.blocks.get(s);if(!r)continue;const a=r.id,l=[],p=[],h=[],u=[];for(const c of n){const f=c.time/1e3;if(c.properties.position){l.push(f);const d=c.properties.position;p.push(d.x+.5,d.y+.5,d.z+.5)}if(c.properties.rotation){h.push(f);const d=new ko(gt.degToRad(c.properties.rotation.x),gt.degToRad(c.properties.rotation.y),gt.degToRad(c.properties.rotation.z)),m=new Ne().setFromEuler(d);u.push(m.x,m.y,m.z,m.w)}}l.length>0&&o.push(new Yr(`${a}.position`,l,p)),h.length>0&&o.push(new Gr(`${a}.quaternion`,h,u))}return o.length===0?null:new $r(t.name,t.duration/1e3,o)}downloadFile(t,e,o=!0){const i=o?new Blob([t],{type:"application/octet-stream"}):new Blob([JSON.stringify(t)],{type:"application/json"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=e,n.click(),URL.revokeObjectURL(s)}getOptimizationStats(t,e={}){const o=t.getAllBlocks(),i=this.optimizer.estimateFaceCount(o),s=this.optimizer.estimateOptimizedCount(o,e);return{blockCount:o.length,originalFaces:i,optimizedFaces:s,reduction:i>0?Math.round((1-s/i)*100):0}}}class dl{constructor(){this.raycaster=new hs,this.ambientLight=new ot(.15,.15,.15)}bake(t){const e=t.getAllBlocks(),o=e.filter(n=>{var r;return(r=n.emissive)==null?void 0:r.enabled}),i=e.map(n=>n.mesh);console.log(`Baking lighting: ${o.length} emissive blocks, ${e.length} total blocks`);const s=new Map;for(const n of e){const r=this.bakeBlockVertices(n,o,i);s.set(n.id,r)}return s}apply(t,e){for(const[o,i]of e){const s=t.getBlockById(o);if(!s)continue;s.mesh.geometry.setAttribute("color",new Ot(i,3));const r=a=>{a.vertexColors=!0,a.needsUpdate=!0};Array.isArray(s.mesh.material)?s.mesh.material.forEach(r):r(s.mesh.material)}}bakeBlockVertices(t,e,o){const i=t.mesh.geometry,s=i.getAttribute("position"),n=i.getAttribute("normal"),r=s.count,a=new Float32Array(r*3),l=new U,p=new U,h=new Vn().getNormalMatrix(t.mesh.matrixWorld);t.mesh.updateMatrixWorld();for(let u=0;u<r;u++){l.fromBufferAttribute(s,u),l.applyMatrix4(t.mesh.matrixWorld),n?(p.fromBufferAttribute(n,u),p.applyMatrix3(h).normalize()):p.set(0,1,0);const c=this.calculateLightAtPoint(l,p,e,o,t.mesh),f=new ot(t.color);a[u*3]=Math.min(1,f.r*c.r),a[u*3+1]=Math.min(1,f.g*c.g),a[u*3+2]=Math.min(1,f.b*c.b)}return a}calculateLightAtPoint(t,e,o,i,s){const n=this.ambientLight.clone();for(const r of o){const a=this.getBlockCenter(r),l=new U().subVectors(a,t),p=l.length();if(p>r.emissive.radius)continue;l.normalize();const h=Math.max(0,e.dot(l));if(h<=0||this.isOccluded(t,a,i,s,r.mesh))continue;const c=p/r.emissive.radius,f=Math.pow(1-c,2),d=new ot(r.emissive.color),m=r.emissive.intensity*h*f;n.r+=d.r*m,n.g+=d.g*m,n.b+=d.b*m}return n}getBlockCenter(t){const e=t.gridPosition,o=t.dimensions,i=oo[t.type]||1,s=io[t.type]||0,n=o.h*i;return new U(e.x+o.w/2,e.y+s+n/2,e.z+o.d/2)}isOccluded(t,e,o,i,s){const n=new U().subVectors(e,t),r=n.length();n.normalize();const a=t.clone().addScaledVector(n,.01);this.raycaster.set(a,n),this.raycaster.far=r-.02;const l=o.filter(h=>h!==i&&h!==s);return this.raycaster.intersectObjects(l,!1).length>0}clear(t){for(const e of t.getAllBlocks()){const o=e.mesh.geometry;o.hasAttribute("color")&&o.deleteAttribute("color");const i=s=>{s.vertexColors=!1,s.needsUpdate=!0};Array.isArray(e.mesh.material)?e.mesh.material.forEach(i):i(e.mesh.material)}}generateDebugTexture(t,e={}){const{cellSize:o=32,columns:i=8,showLighting:s=!0,showBaseColors:n=!0}=e,r=t.getAllBlocks(),a=Math.ceil(r.length/i),l=i*o,p=Math.max(a*o*(s&&n?2:1),o),h=document.createElement("canvas");h.width=l,h.height=p;const u=h.getContext("2d");return u.fillStyle="#000000",u.fillRect(0,0,l,p),r.forEach((c,f)=>{var g;const d=f%i,m=Math.floor(f/i),x=d*o;if(n){const b=m*o;u.fillStyle=c.color,u.fillRect(x+1,b+1,o-2,o-2),u.fillStyle="#ffffff",u.font="8px monospace",u.fillText(c.type.slice(0,4),x+2,b+10)}if(s){const b=(n?a+m:m)*o,z=c.mesh.geometry;if(z.hasAttribute("color")){const v=z.getAttribute("color");let C=0,B=0,A=0;for(let k=0;k<v.count;k++)C+=v.getX(k),B+=v.getY(k),A+=v.getZ(k);C/=v.count,B/=v.count,A/=v.count;const M=Math.round(C*255),_=Math.round(B*255),P=Math.round(A*255);u.fillStyle=`rgb(${M},${_},${P})`}else u.fillStyle=c.color;u.fillRect(x+1,b+1,o-2,o-2),(g=c.emissive)!=null&&g.enabled&&(u.strokeStyle=c.emissive.color,u.lineWidth=2,u.strokeRect(x+2,b+2,o-4,o-4))}}),u.fillStyle="#ffffff",u.font="10px monospace",n&&s&&(u.fillText("Base Colors",4,a*o-4),u.fillText("Baked",4,p-4)),h}generateLightmapTexture(t,e={}){const{cellSize:o=32,columns:i=8}=e,s=t.getAllBlocks(),n=Math.ceil(s.length/i),r=i*o,a=Math.max(n*o,o),l=document.createElement("canvas");l.width=r,l.height=a;const p=l.getContext("2d");return p.fillStyle="#808080",p.fillRect(0,0,r,a),s.forEach((h,u)=>{const c=u%i,f=Math.floor(u/i),d=c*o,m=f*o,x=h.mesh.geometry;if(x.hasAttribute("color")){const g=x.getAttribute("color"),b=new ot(h.color);let z=new ot(0,0,0),v=0;for(let M=0;M<g.count;M++){const _=g.getX(M),P=g.getY(M),k=g.getZ(M),T=b.r>.01?_/b.r:_,F=b.g>.01?P/b.g:P,D=b.b>.01?k/b.b:k;z.r+=T,z.g+=F,z.b+=D,v++}v>0&&(z.r/=v,z.g/=v,z.b/=v);const C=Math.round(Math.min(1,z.r)*255),B=Math.round(Math.min(1,z.g)*255),A=Math.round(Math.min(1,z.b)*255);p.fillStyle=`rgb(${C},${B},${A})`}else p.fillStyle="#262626";p.fillRect(d,m,o,o),p.strokeStyle="#333333",p.strokeRect(d,m,o,o)}),l}downloadCanvasAsPNG(t,e){const o=document.createElement("a");o.download=e,o.href=t.toDataURL("image/png"),o.click()}}class fl{constructor(){this.raycaster=new hs,this.ambientLight=new ot(.15,.15,.15),this.faceOrder=["east","west","top","bottom","south","north"],this.faceNormals={east:new U(1,0,0),west:new U(-1,0,0),top:new U(0,1,0),bottom:new U(0,-1,0),south:new U(0,0,1),north:new U(0,0,-1)}}bake(t){const e=t.getAllBlocks(),o=e.filter(c=>{var f;return(f=c.emissive)==null?void 0:f.enabled}),i=e.map(c=>c.mesh);o.length===0&&console.warn("No emissive blocks found for texture baking"),console.log(`Texture baking: ${o.length} emissive blocks, ${e.length} total blocks`);const n=e.length*6,r=Math.ceil(Math.sqrt(n)),a=Math.ceil(n/r);console.log(`Atlas size: ${r}x${a} (${n} pixels for ${e.length} blocks)`);const l=document.createElement("canvas");l.width=r,l.height=a;const p=l.getContext("2d");p.fillStyle="#000000",p.fillRect(0,0,r,a);const h=new Map;let u=0;for(const c of e){const f={};for(const d of this.faceOrder){const m=u%r,x=Math.floor(u/r),g=this.calculateFaceLighting(c,d,o,i),b=Math.round(Math.min(1,g.r)*255),z=Math.round(Math.min(1,g.g)*255),v=Math.round(Math.min(1,g.b)*255);p.fillStyle=`rgb(${b},${z},${v})`,p.fillRect(m,x,1,1),f[d]={u:(m+.5)/r,v:1-(x+.5)/a},u++}h.set(c.id,{faceUVs:f})}return{texture:l,uvData:h,atlasWidth:r,atlasHeight:a}}calculateFaceLighting(t,e,o,i){var p,h,u;const s=new ot(t.color),n=this.faceNormals[e].clone(),r=new ko(gt.degToRad(((p=t.rotation)==null?void 0:p.x)||0),gt.degToRad(((h=t.rotation)==null?void 0:h.y)||0),gt.degToRad(((u=t.rotation)==null?void 0:u.z)||0));n.applyEuler(r);const a=this.getFaceCenter(t,e),l=this.calculateLightAtPoint(a,n,o,i,t.mesh);return new ot(Math.min(1,s.r*l.r),Math.min(1,s.g*l.g),Math.min(1,s.b*l.b))}getFaceCenter(t,e){var h,u,c;const o=t.gridPosition,i=t.dimensions,s=oo[t.type]||1,n=io[t.type]||0,r=i.h*s,a=new U(o.x+i.w/2,o.y+n+r/2,o.z+i.d/2),l=new U;switch(e){case"east":l.set(i.w/2,0,0);break;case"west":l.set(-i.w/2,0,0);break;case"top":l.set(0,r/2,0);break;case"bottom":l.set(0,-r/2,0);break;case"south":l.set(0,0,i.d/2);break;case"north":l.set(0,0,-i.d/2);break}const p=new ko(gt.degToRad(((h=t.rotation)==null?void 0:h.x)||0),gt.degToRad(((u=t.rotation)==null?void 0:u.y)||0),gt.degToRad(((c=t.rotation)==null?void 0:c.z)||0));return l.applyEuler(p),a.add(l)}calculateLightAtPoint(t,e,o,i,s){const n=this.ambientLight.clone();for(const r of o){const a=this.getBlockCenter(r),l=new U().subVectors(a,t),p=l.length();if(p>r.emissive.radius)continue;l.normalize();const h=Math.max(0,e.dot(l));if(h<=0||this.isOccluded(t,a,i,s,r.mesh))continue;const c=p/r.emissive.radius,f=Math.pow(1-c,2),d=new ot(r.emissive.color),m=r.emissive.intensity*h*f;n.r+=d.r*m,n.g+=d.g*m,n.b+=d.b*m}return n}getBlockCenter(t){const e=t.gridPosition,o=t.dimensions,i=oo[t.type]||1,s=io[t.type]||0,n=o.h*i;return new U(e.x+o.w/2,e.y+s+n/2,e.z+o.d/2)}isOccluded(t,e,o,i,s){const n=new U().subVectors(e,t),r=n.length();n.normalize();const a=t.clone().addScaledVector(n,.01);this.raycaster.set(a,n),this.raycaster.far=r-.02;const l=o.filter(h=>h!==i&&h!==s);return this.raycaster.intersectObjects(l,!1).length>0}applyUVs(t,e){for(const[o,i]of e){const s=t.getBlockById(o);if(!s)continue;const r=s.mesh.geometry.getAttribute("uv");if(!r){console.warn(`Block ${o} has no UV attribute`);continue}const a=4;for(let l=0;l<6;l++){const p=this.faceOrder[l],h=i.faceUVs[p];for(let u=0;u<a;u++){const c=l*a+u;r.setXY(c,h.u,h.v)}}r.needsUpdate=!0}}createTexture(t){const e=new fs(t);return e.magFilter=me,e.minFilter=me,e.generateMipmaps=!1,e.flipY=!1,e}}const ml={city:{label:"City",templates:["cityBlock","skyscraper","apartmentBuilding","shoppingMall","trainStation"]},buildings:{label:"Buildings",templates:["cottage","townhouse","officeBuilding","warehouse"]},medieval:{label:"Medieval",templates:["castleWall","guardTower","dungeon","tavern"]},nature:{label:"Nature",templates:["oakTree","rockGarden","pond","campsite"]},industrial:{label:"Industrial",templates:["factory","pipeNetwork","storageYard","refinery","industrialComplex","powerPlant","warehouseDistrict"]},energy:{label:"Energy",templates:["solarArrayLarge","windTurbine","substationYard","coolingTowers"]},modern:{label:"Modern",templates:["rooftopTerrace","parkingLot","busStop","solarFarm","gasStation","helipad"]},furniture:{label:"Furniture",templates:["diningRoom","livingRoom","workshop","cellar"]},infrastructure:{label:"Infrastructure",templates:["stoneBridge","streetCorner","plaza","stairway","highway","harbor"]},oil:{label:"Oil & Gas",templates:["oilDerrick","pumpJackStation","oilStorageFacility","oilFieldSite","offshorePlatform","oilRefinery","tankerLoadingStation"]}},Ji={cottage:{name:"Cozy Cottage",category:"buildings",description:"A charming rustic cottage with detailed architecture",blocks:[...R(-1,0,-1,6,6,"#5D4037"),{type:"slab",position:{x:-1,y:0,z:-1},color:"#696969"},{type:"slab",position:{x:-1,y:0,z:4},color:"#696969"},{type:"slab",position:{x:4,y:0,z:-1},color:"#696969"},{type:"slab",position:{x:4,y:0,z:4},color:"#696969"},{type:"cube",position:{x:0,y:1,z:0},color:"#DEB887"},{type:"cube",position:{x:1,y:1,z:0},color:"#F5DEB3"},{type:"cube",position:{x:2,y:1,z:0},color:"#F5DEB3"},{type:"cube",position:{x:3,y:1,z:0},color:"#DEB887"},{type:"cube",position:{x:0,y:2,z:0},color:"#DEB887"},{type:"cube",position:{x:3,y:2,z:0},color:"#DEB887"},{type:"cube",position:{x:0,y:1,z:3},color:"#DEB887"},{type:"cube",position:{x:3,y:1,z:3},color:"#DEB887"},{type:"cube",position:{x:0,y:2,z:3},color:"#DEB887"},{type:"cube",position:{x:1,y:2,z:3},color:"#F5DEB3"},{type:"cube",position:{x:2,y:2,z:3},color:"#F5DEB3"},{type:"cube",position:{x:3,y:2,z:3},color:"#DEB887"},{type:"cube",position:{x:0,y:1,z:1},color:"#DEB887"},{type:"cube",position:{x:0,y:1,z:2},color:"#DEB887"},{type:"cube",position:{x:0,y:2,z:1},color:"#F5DEB3"},{type:"cube",position:{x:0,y:2,z:2},color:"#F5DEB3"},{type:"cube",position:{x:3,y:1,z:1},color:"#DEB887"},{type:"cube",position:{x:3,y:1,z:2},color:"#DEB887"},{type:"cube",position:{x:3,y:2,z:1},color:"#F5DEB3"},{type:"cube",position:{x:3,y:2,z:2},color:"#F5DEB3"},{type:"beam2X",position:{x:0,y:1,z:0},color:"#5D4037"},{type:"beam2X",position:{x:2,y:1,z:0},color:"#5D4037"},{type:"beam2Z",position:{x:0,y:1,z:0},color:"#5D4037"},{type:"beam2Z",position:{x:0,y:1,z:2},color:"#5D4037"},{type:"beam2Z",position:{x:3,y:1,z:0},color:"#5D4037"},{type:"beam2Z",position:{x:3,y:1,z:2},color:"#5D4037"},{type:"windowFrame",position:{x:1,y:2,z:0},color:"#8B4513"},{type:"windowFrame",position:{x:2,y:2,z:0},color:"#8B4513"},{type:"windowSill",position:{x:1,y:1,z:-1},color:"#5D4037"},{type:"windowSill",position:{x:2,y:1,z:-1},color:"#5D4037"},{type:"windowFrame",position:{x:0,y:2,z:2},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"doorFrame",position:{x:1,y:1,z:3},color:"#654321"},{type:"doorFrame",position:{x:2,y:1,z:3},color:"#654321"},{type:"step",position:{x:1,y:0,z:4},color:"#808080"},{type:"step",position:{x:2,y:0,z:4},color:"#808080"},{type:"wedge",position:{x:0,y:3,z:0},color:"#8B0000"},{type:"wedge",position:{x:1,y:3,z:0},color:"#8B0000"},{type:"wedge",position:{x:2,y:3,z:0},color:"#8B0000"},{type:"wedge",position:{x:3,y:3,z:0},color:"#8B0000"},{type:"wedge",position:{x:0,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:1,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:2,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:3,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},...Q(0,3,1,4,"X","slab","#8B0000"),...Q(0,3,2,4,"X","slab","#8B0000"),{type:"wedgeFlat",position:{x:-1,y:3,z:0},color:"#8B0000"},{type:"wedgeFlat",position:{x:4,y:3,z:0},color:"#8B0000"},{type:"wedgeFlat",position:{x:-1,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"wedgeFlat",position:{x:4,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"chimney",position:{x:3,y:3,z:1},color:"#8B4513"},{type:"chimney",position:{x:3,y:4,z:1},color:"#704214"},{type:"chimney",position:{x:3,y:5,z:1},color:"#5D3A1A"},{type:"slab",position:{x:1,y:0,z:-1},color:"#5D4037"},{type:"slab",position:{x:2,y:0,z:-1},color:"#5D4037"},{type:"pillar2",position:{x:1,y:0,z:-1},color:"#5D4037"},{type:"pillar2",position:{x:2,y:0,z:-1},color:"#5D4037"},{type:"beam2X",position:{x:1,y:1,z:-1},color:"#5D4037"},{type:"planter",position:{x:-1,y:0,z:1},color:"#8B4513"},{type:"flower",position:{x:-1,y:1,z:1},color:"#FF69B4"},{type:"planter",position:{x:-1,y:0,z:2},color:"#8B4513"},{type:"bush",position:{x:-1,y:1,z:2},color:"#228B22"},{type:"barrel",position:{x:4,y:0,z:2},color:"#8B4513"},{type:"rock",position:{x:4,y:0,z:0},color:"#696969"},{type:"fence",position:{x:-1,y:0,z:-1},color:"#DEB887"},{type:"fence",position:{x:0,y:0,z:-1},color:"#DEB887"},{type:"fence",position:{x:3,y:0,z:-1},color:"#DEB887"},{type:"fence",position:{x:4,y:0,z:-1},color:"#DEB887"}]},townhouse:{name:"Town House",category:"buildings",description:"A tall narrow townhouse with baluster railings",blocks:[...R(0,0,0,3,3,"#696969"),...ht(0,1,0,3,3,"#F5F5DC"),...ht(0,2,0,3,3,"#F5F5DC"),...ht(0,3,0,3,3,"#F5F5DC"),{type:"slab",position:{x:0,y:2,z:-1},color:"#808080"},{type:"slab",position:{x:1,y:2,z:-1},color:"#808080"},{type:"slab",position:{x:2,y:2,z:-1},color:"#808080"},{type:"baluster",position:{x:0,y:2,z:-1},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:2,z:-1},color:"#F5F5DC"},{type:"railing",position:{x:0,y:3,z:-1},color:"#F5F5DC"},{type:"railing",position:{x:1,y:3,z:-1},color:"#F5F5DC"},{type:"railing",position:{x:2,y:3,z:-1},color:"#F5F5DC"},{type:"cornice",position:{x:0,y:4,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:1,y:4,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:2,y:4,z:0},color:"#D3D3D3"},...R(0,4,0,3,3,"#2F4F4F"),{type:"slab",position:{x:0,y:0,z:-1},color:"#696969"},{type:"slab",position:{x:1,y:0,z:-1},color:"#696969"},{type:"slab",position:{x:2,y:0,z:-1},color:"#696969"},{type:"base",position:{x:0,y:0,z:-1},color:"#F5F5DC"},{type:"base",position:{x:2,y:0,z:-1},color:"#F5F5DC"},{type:"column",position:{x:0,y:1,z:-1},color:"#F5F5DC"},{type:"column",position:{x:2,y:1,z:-1},color:"#F5F5DC"},{type:"capital",position:{x:0,y:2,z:-1},color:"#F5F5DC"},{type:"capital",position:{x:2,y:2,z:-1},color:"#F5F5DC"}]},officeBuilding:{name:"Office Building",category:"buildings",description:"Modern office with AC units and antenna",blocks:[...R(0,0,0,5,5,"#333333"),...vt(0,1,0,5,5,"#E0E0E0","#4169E1"),...vt(0,2,0,5,5,"#E0E0E0","#4169E1"),...vt(0,3,0,5,5,"#E0E0E0","#4169E1"),...vt(0,4,0,5,5,"#E0E0E0","#4169E1"),...R(0,5,0,5,5,"#404040"),{type:"acUnit",position:{x:1,y:5,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:3,y:5,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:1,y:5,z:3},color:"#C0C0C0"},{type:"acUnit",position:{x:3,y:5,z:3},color:"#C0C0C0"},{type:"antenna",position:{x:2,y:5,z:2},color:"#808080"},{type:"antenna",position:{x:2,y:6,z:2},color:"#808080"},{type:"vent",position:{x:0,y:5,z:2},color:"#696969"}]},warehouse:{name:"Warehouse",category:"buildings",description:"Industrial warehouse with crates and barrels",blocks:[...R(0,0,0,6,4,"#808080"),...at(0,1,0,6,2,"#A9A9A9"),...at(0,1,3,6,2,"#A9A9A9"),...st(0,1,1,2,2,"#A9A9A9"),...st(5,1,1,2,2,"#A9A9A9"),{type:"iBeam",position:{x:2,y:1,z:1},color:"#696969"},{type:"iBeam",position:{x:2,y:2,z:1},color:"#696969"},{type:"iBeam",position:{x:2,y:1,z:2},color:"#696969"},{type:"iBeam",position:{x:2,y:2,z:2},color:"#696969"},...R(0,3,0,6,4,"#708090"),{type:"catwalk",position:{x:1,y:3,z:1},color:"#4A4A4A"},{type:"catwalk",position:{x:1,y:3,z:2},color:"#4A4A4A"},{type:"crate",position:{x:4,y:1,z:1},color:"#8B4513"},{type:"crate",position:{x:4,y:1,z:2},color:"#8B4513"},{type:"crate",position:{x:4,y:2,z:1},color:"#A0522D"},{type:"barrel",position:{x:3,y:1,z:1},color:"#654321"},{type:"barrel",position:{x:3,y:1,z:2},color:"#654321"}]},castleWall:{name:"Castle Wall",category:"medieval",description:"Fortified wall with merlons and arrow slits",blocks:[...at(0,0,0,8,3,"#808080"),{type:"merlon",position:{x:0,y:3,z:0},color:"#696969"},{type:"merlon",position:{x:2,y:3,z:0},color:"#696969"},{type:"merlon",position:{x:4,y:3,z:0},color:"#696969"},{type:"merlon",position:{x:6,y:3,z:0},color:"#696969"},{type:"arrowSlit",position:{x:1,y:1,z:0},color:"#505050"},{type:"arrowSlit",position:{x:3,y:1,z:0},color:"#505050"},{type:"arrowSlit",position:{x:5,y:1,z:0},color:"#505050"},{type:"arrowSlit",position:{x:7,y:1,z:0},color:"#505050"},...Q(0,2,1,8,"X","slab","#707070"),{type:"torch",position:{x:1,y:2,z:1},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:1.5,radius:4}},{type:"torch",position:{x:5,y:2,z:1},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:1.5,radius:4}},{type:"buttress",position:{x:0,y:0,z:1},color:"#606060"},{type:"buttress",position:{x:4,y:0,z:1},color:"#606060"},{type:"buttress",position:{x:7,y:0,z:1},color:"#606060"}]},guardTower:{name:"Guard Tower",category:"medieval",description:"Imposing medieval watchtower with battlements, arrow slits, and defensive features",blocks:[...R(0,0,0,5,5,"#505050"),{type:"cylinder",position:{x:2,y:1,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:2,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:3,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:4,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:5,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:6,z:2},color:"#505050"},{type:"arrowSlit",position:{x:2,y:2,z:0},color:"#3A3A3A"},{type:"arrowSlit",position:{x:0,y:3,z:2},color:"#3A3A3A",rotation:{x:0,y:90,z:0}},{type:"arrowSlit",position:{x:4,y:3,z:2},color:"#3A3A3A",rotation:{x:0,y:90,z:0}},{type:"arrowSlit",position:{x:2,y:4,z:4},color:"#3A3A3A",rotation:{x:0,y:180,z:0}},{type:"merlon",position:{x:1,y:6,z:1},color:"#505050"},{type:"merlon",position:{x:3,y:6,z:1},color:"#505050"},{type:"merlon",position:{x:1,y:6,z:3},color:"#505050"},{type:"merlon",position:{x:3,y:6,z:3},color:"#505050"},{type:"crenellation",position:{x:0,y:6,z:2},color:"#505050"},{type:"crenellation",position:{x:4,y:6,z:2},color:"#505050"},{type:"crenellation",position:{x:2,y:6,z:0},color:"#505050"},{type:"crenellation",position:{x:2,y:6,z:4},color:"#505050"},{type:"cone",position:{x:2,y:7,z:2},color:"#2F4F4F"},{type:"finial",position:{x:2,y:8,z:2},color:"#8B4513"},{type:"doorFrame",position:{x:2,y:1,z:0},color:"#5D4037"},{type:"archLow",position:{x:2,y:2,z:0},color:"#606060"},{type:"torch",position:{x:1,y:2,z:0},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"torch",position:{x:3,y:2,z:0},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"torch",position:{x:2,y:6,z:2},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:3,radius:8}},{type:"chain",position:{x:0,y:5,z:1},color:"#4A4A4A"},{type:"chain",position:{x:4,y:5,z:1},color:"#4A4A4A"},{type:"chain",position:{x:0,y:4,z:1},color:"#4A4A4A"},{type:"chain",position:{x:4,y:4,z:1},color:"#4A4A4A"},{type:"banner",position:{x:2,y:5,z:0},color:"#8B0000"},{type:"shield",position:{x:1,y:4,z:0},color:"#DAA520"},{type:"shield",position:{x:3,y:4,z:0},color:"#DAA520"},{type:"buttress",position:{x:0,y:0,z:1},color:"#606060"},{type:"buttress",position:{x:0,y:0,z:3},color:"#606060"},{type:"buttress",position:{x:4,y:0,z:1},color:"#606060"},{type:"buttress",position:{x:4,y:0,z:3},color:"#606060"},{type:"ladder",position:{x:1,y:1,z:1},color:"#8B4513"},{type:"ladder",position:{x:1,y:2,z:1},color:"#8B4513"},{type:"ladder",position:{x:1,y:3,z:1},color:"#8B4513"},{type:"ladder",position:{x:1,y:4,z:1},color:"#8B4513"},{type:"ladder",position:{x:1,y:5,z:1},color:"#8B4513"},{type:"rock",position:{x:0,y:0,z:0},color:"#696969"},{type:"rock",position:{x:4,y:0,z:4},color:"#707070"},{type:"boulder",position:{x:-1,y:0,z:3},color:"#5A5A5A"}]},dungeon:{name:"Dungeon Complex",category:"medieval",description:"Medieval dungeon with cells, torture chamber, guard post, and treasure room",blocks:[...R(0,0,4,12,3,"#3A3A3A"),...at(0,1,4,12,3,"#4A4A4A"),...at(0,1,6,12,3,"#4A4A4A"),...R(0,4,4,12,3,"#3A3A3A"),{type:"torch",position:{x:2,y:3,z:4},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},{type:"torch",position:{x:6,y:3,z:4},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},{type:"torch",position:{x:10,y:3,z:4},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},...R(0,0,0,4,4,"#3A3A3A"),...at(0,1,0,4,3,"#4A4A4A"),...st(0,1,1,3,3,"#4A4A4A"),...st(3,1,1,3,3,"#4A4A4A"),...R(0,4,0,4,4,"#3A3A3A"),{type:"fence",position:{x:0,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:1,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:2,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:3,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:0,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:1,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:2,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:3,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:0,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:1,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:2,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:3,y:3,z:3},color:"#2F2F2F"},{type:"chain",position:{x:1,y:2,z:0},color:"#4A4A4A"},{type:"chain",position:{x:2,y:2,z:0},color:"#4A4A4A"},{type:"chain",position:{x:1,y:1,z:0},color:"#4A4A4A"},{type:"chain",position:{x:2,y:1,z:0},color:"#4A4A4A"},{type:"slab",position:{x:0,y:1,z:1},color:"#8B7355"},...R(4,0,0,4,4,"#3A3A3A"),...at(4,1,0,4,3,"#4A4A4A"),...st(4,1,1,3,3,"#4A4A4A"),...st(7,1,1,3,3,"#4A4A4A"),...R(4,4,0,4,4,"#3A3A3A"),{type:"fence",position:{x:4,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:5,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:6,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:7,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:4,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:5,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:6,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:7,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:4,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:5,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:6,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:7,y:3,z:3},color:"#2F2F2F"},{type:"barrel",position:{x:4,y:1,z:1},color:"#3D2914"},{type:"chain",position:{x:6,y:2,z:0},color:"#4A4A4A"},...R(8,0,0,4,4,"#2F2F2F"),...at(8,1,0,4,3,"#4A4A4A"),...st(8,1,1,3,3,"#4A4A4A"),...st(11,1,1,3,3,"#4A4A4A"),...R(8,4,0,4,4,"#3A3A3A"),{type:"arch",position:{x:9,y:1,z:3},color:"#4A4A4A"},{type:"arch",position:{x:10,y:1,z:3},color:"#4A4A4A"},{type:"cross",position:{x:9,y:1,z:0},color:"#3D2914"},{type:"chain",position:{x:9,y:2,z:0},color:"#4A4A4A"},{type:"chain",position:{x:9,y:3,z:0},color:"#4A4A4A"},{type:"barrel",position:{x:11,y:1,z:1},color:"#2F2F2F"},{type:"cube",position:{x:11,y:2,z:1},color:"#FF4500",emissive:{enabled:!0,color:"#FF2200",intensity:1.5,radius:3}},{type:"shelf",position:{x:8,y:2,z:1},color:"#3D2914"},{type:"torch",position:{x:10,y:3,z:0},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},...R(0,0,7,5,5,"#4A4A3A"),...at(0,1,11,5,3,"#5A5A4A"),...st(0,1,7,4,3,"#5A5A4A"),...st(4,1,8,3,3,"#5A5A4A"),...R(0,4,7,5,5,"#3A3A3A"),{type:"doorFrame",position:{x:1,y:1,z:7},color:"#3D2914"},{type:"doorFrame",position:{x:1,y:2,z:7},color:"#3D2914"},{type:"table",position:{x:1,y:1,z:9},color:"#5C4033"},{type:"stool",position:{x:0,y:1,z:9},color:"#5C4033"},{type:"stool",position:{x:2,y:1,z:9},color:"#5C4033"},{type:"shelf",position:{x:0,y:2,z:11},color:"#3D2914"},{type:"shelf",position:{x:1,y:2,z:11},color:"#3D2914"},{type:"shield",position:{x:3,y:2,z:11},color:"#8B0000"},{type:"torch",position:{x:2,y:3,z:11},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},{type:"barrel",position:{x:4,y:1,z:10},color:"#5C4033"},{type:"chain",position:{x:4,y:2,z:8},color:"#B8860B"},...R(8,0,7,4,5,"#3A3A3A"),...at(8,1,11,4,3,"#4A4A4A"),...st(8,1,7,4,3,"#4A4A4A"),...st(11,1,7,4,3,"#4A4A4A"),...R(8,4,7,4,5,"#3A3A3A"),{type:"portcullis",position:{x:9,y:1,z:7},color:"#2F2F2F"},{type:"portcullis",position:{x:10,y:1,z:7},color:"#2F2F2F"},{type:"portcullis",position:{x:9,y:2,z:7},color:"#2F2F2F"},{type:"portcullis",position:{x:10,y:2,z:7},color:"#2F2F2F"},{type:"crate",position:{x:9,y:1,z:10},color:"#8B4513"},{type:"crate",position:{x:10,y:1,z:10},color:"#8B4513"},{type:"slab",position:{x:9,y:1,z:9},color:"#FFD700"},{type:"slab",position:{x:10,y:1,z:9},color:"#FFD700"},{type:"quarter",position:{x:9,y:2,z:9},color:"#FFD700"},{type:"sack",position:{x:8,y:1,z:9},color:"#8B7355"},{type:"sack",position:{x:11,y:1,z:9},color:"#8B7355"},{type:"torch",position:{x:9,y:3,z:11},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},{type:"arrowSlit",position:{x:4,y:2,z:6},color:"#4A4A4A"},{type:"arrowSlit",position:{x:8,y:2,z:6},color:"#4A4A4A"},{type:"grate",position:{x:3,y:0,z:5},color:"#2F2F2F"},{type:"grate",position:{x:7,y:0,z:5},color:"#2F2F2F"}]},tavern:{name:"Tavern Interior",category:"medieval",description:"Cozy medieval tavern with bar, fireplace, sleeping quarters, and rustic charm",blocks:[...R(0,0,0,7,6,"#8B4513"),{type:"slab",position:{x:6,y:0,z:0},color:"#505050"},{type:"slab",position:{x:6,y:0,z:1},color:"#505050"},{type:"slab",position:{x:6,y:0,z:2},color:"#505050"},...at(0,1,-1,7,3,"#606060"),...st(-1,1,0,6,3,"#8B4513"),...st(7,1,0,6,3,"#8B4513"),{type:"slab",position:{x:0,y:1,z:0},color:"#5D4037"},{type:"slab",position:{x:1,y:1,z:0},color:"#5D4037"},{type:"slab",position:{x:2,y:1,z:0},color:"#5D4037"},{type:"slab",position:{x:3,y:1,z:0},color:"#5D4037"},{type:"ledge",position:{x:0,y:1,z:1},color:"#654321"},{type:"ledge",position:{x:1,y:1,z:1},color:"#654321"},{type:"ledge",position:{x:2,y:1,z:1},color:"#654321"},{type:"ledge",position:{x:3,y:1,z:1},color:"#654321"},{type:"shelf",position:{x:0,y:2,z:-1},color:"#5D4037"},{type:"shelf",position:{x:1,y:2,z:-1},color:"#5D4037"},{type:"shelf",position:{x:2,y:2,z:-1},color:"#5D4037"},{type:"shelf",position:{x:3,y:2,z:-1},color:"#5D4037"},{type:"barrel",position:{x:0,y:1,z:-1},color:"#5C4033"},{type:"barrel",position:{x:1,y:1,z:-1},color:"#4A3728"},{type:"barrel",position:{x:2,y:1,z:-1},color:"#5C4033"},{type:"barrel",position:{x:3,y:1,z:-1},color:"#4A3728"},{type:"barrel",position:{x:0,y:2,z:-1},color:"#4A3728"},{type:"barrel",position:{x:2,y:2,z:-1},color:"#5C4033"},{type:"barrel",position:{x:0,y:0,z:5},color:"#5C4033"},{type:"barrel",position:{x:0,y:1,z:5},color:"#4A3728"},{type:"cube",position:{x:6,y:1,z:0},color:"#505050"},{type:"cube",position:{x:6,y:1,z:2},color:"#505050"},{type:"cube",position:{x:6,y:2,z:0},color:"#404040"},{type:"cube",position:{x:6,y:2,z:2},color:"#404040"},{type:"arch",position:{x:6,y:2,z:1},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"pillar4",position:{x:6,y:1,z:1},color:"#FF4500",emissive:{enabled:!0,color:"#FF6600",intensity:4,radius:5}},{type:"chimney",position:{x:6,y:3,z:1},color:"#505050"},{type:"chimney",position:{x:6,y:4,z:1},color:"#404040"},{type:"slab",position:{x:6,y:3,z:0},color:"#5D4037"},{type:"slab",position:{x:6,y:3,z:2},color:"#5D4037"},{type:"table",position:{x:2,y:1,z:3},color:"#8B4513"},{type:"chair",position:{x:1,y:1,z:3},color:"#654321",rotation:{x:0,y:90,z:0}},{type:"chair",position:{x:3,y:1,z:3},color:"#654321",rotation:{x:0,y:270,z:0}},{type:"stool",position:{x:2,y:1,z:2},color:"#654321"},{type:"stool",position:{x:2,y:1,z:4},color:"#654321"},{type:"bench",position:{x:4,y:1,z:4},color:"#654321"},{type:"bench",position:{x:5,y:1,z:5},color:"#654321",rotation:{x:0,y:90,z:0}},{type:"table",position:{x:5,y:1,z:4},color:"#8B4513"},{type:"stool",position:{x:1,y:1,z:1},color:"#5D4037"},{type:"stool",position:{x:2,y:1,z:1},color:"#5D4037"},{type:"stool",position:{x:3,y:1,z:1},color:"#5D4037"},{type:"beamX",position:{x:0,y:3,z:2},color:"#5D4037"},{type:"beamX",position:{x:2,y:3,z:2},color:"#5D4037"},{type:"beamX",position:{x:4,y:3,z:2},color:"#5D4037"},{type:"beamX",position:{x:0,y:3,z:4},color:"#5D4037"},{type:"beamX",position:{x:2,y:3,z:4},color:"#5D4037"},{type:"beamX",position:{x:4,y:3,z:4},color:"#5D4037"},{type:"torch",position:{x:-1,y:2,z:1},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"torch",position:{x:-1,y:2,z:4},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"torch",position:{x:4,y:2,z:-1},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"chain",position:{x:3,y:3,z:3},color:"#2F2F2F"},{type:"sphere",position:{x:3,y:2,z:3},color:"#FFD700",emissive:{enabled:!0,color:"#FFAA00",intensity:2,radius:3}},{type:"shield",position:{x:2,y:3,z:-1},color:"#8B0000"},{type:"beamDiag",position:{x:5,y:3,z:-1},color:"#C0C0C0"},{type:"banner",position:{x:0,y:3,z:-1},color:"#006400"},{type:"crate",position:{x:0,y:0,z:4},color:"#8B4513"},{type:"doorFrame",position:{x:3,y:1,z:5},color:"#5D4037"}]},oakTree:{name:"Oak Tree",category:"nature",description:"Majestic oak tree with detailed bark, branches, and forest floor",blocks:[{type:"slab",position:{x:0,y:0,z:0},color:"#4A3728"},{type:"slab",position:{x:1,y:0,z:0},color:"#3D2914"},{type:"slab",position:{x:2,y:0,z:0},color:"#4A3728"},{type:"slab",position:{x:3,y:0,z:0},color:"#3D2914"},{type:"slab",position:{x:0,y:0,z:1},color:"#3D2914"},{type:"slab",position:{x:3,y:0,z:1},color:"#4A3728"},{type:"slab",position:{x:0,y:0,z:2},color:"#4A3728"},{type:"slab",position:{x:3,y:0,z:2},color:"#3D2914"},{type:"slab",position:{x:0,y:0,z:3},color:"#3D2914"},{type:"slab",position:{x:1,y:0,z:3},color:"#4A3728"},{type:"slab",position:{x:2,y:0,z:3},color:"#3D2914"},{type:"slab",position:{x:3,y:0,z:3},color:"#4A3728"},{type:"rock",position:{x:1,y:0,z:1},color:"#5D4037"},{type:"rock",position:{x:2,y:0,z:1},color:"#5D4037"},{type:"rock",position:{x:1,y:0,z:2},color:"#5D4037"},{type:"rock",position:{x:2,y:0,z:2},color:"#5D4037"},{type:"pillar",position:{x:1,y:1,z:1},color:"#5D4037"},{type:"pillar",position:{x:2,y:1,z:1},color:"#4A3728"},{type:"pillar",position:{x:1,y:1,z:2},color:"#4A3728"},{type:"pillar",position:{x:2,y:1,z:2},color:"#5D4037"},{type:"pillar",position:{x:1,y:2,z:1},color:"#5D4037"},{type:"pillar",position:{x:2,y:2,z:2},color:"#5D4037"},{type:"pillar",position:{x:1,y:3,z:2},color:"#5D4037"},{type:"pillar",position:{x:2,y:3,z:1},color:"#5D4037"},{type:"logX",position:{x:0,y:3,z:1},color:"#5D4037"},{type:"logX",position:{x:3,y:3,z:2},color:"#5D4037"},{type:"logZ",position:{x:1,y:4,z:0},color:"#5D4037"},{type:"logZ",position:{x:2,y:4,z:3},color:"#5D4037"},{type:"sphere",position:{x:0,y:4,z:1},color:"#228B22"},{type:"sphere",position:{x:3,y:4,z:1},color:"#2E8B2E"},{type:"sphere",position:{x:0,y:4,z:2},color:"#2E8B2E"},{type:"sphere",position:{x:3,y:4,z:2},color:"#228B22"},{type:"sphere",position:{x:1,y:4,z:0},color:"#228B22"},{type:"sphere",position:{x:2,y:4,z:0},color:"#2E8B2E"},{type:"sphere",position:{x:1,y:4,z:3},color:"#2E8B2E"},{type:"sphere",position:{x:2,y:4,z:3},color:"#228B22"},{type:"sphere",position:{x:1,y:5,z:1},color:"#32CD32"},{type:"sphere",position:{x:2,y:5,z:1},color:"#228B22"},{type:"sphere",position:{x:1,y:5,z:2},color:"#228B22"},{type:"sphere",position:{x:2,y:5,z:2},color:"#32CD32"},{type:"sphere",position:{x:0,y:5,z:1},color:"#2E8B2E"},{type:"sphere",position:{x:3,y:5,z:2},color:"#2E8B2E"},{type:"sphere",position:{x:1,y:6,z:1},color:"#32CD32"},{type:"sphere",position:{x:2,y:6,z:2},color:"#32CD32"},{type:"sphere",position:{x:1,y:6,z:2},color:"#228B22"},{type:"sphere",position:{x:2,y:6,z:1},color:"#228B22"},{type:"sphere",position:{x:1,y:7,z:1},color:"#90EE90"},{type:"sphere",position:{x:2,y:7,z:2},color:"#90EE90"},{type:"bush",position:{x:0,y:0,z:0},color:"#228B22"},{type:"bush",position:{x:3,y:0,z:3},color:"#2E8B2E"},{type:"bush",position:{x:3,y:0,z:0},color:"#006400"},{type:"grass",position:{x:0,y:0,z:3},color:"#7CFC00"},{type:"grass",position:{x:3,y:0,z:1},color:"#90EE90"},{type:"flower",position:{x:0,y:0,z:2},color:"#FFD700"},{type:"flower",position:{x:2,y:0,z:3},color:"#FF69B4"},{type:"logX",position:{x:-1,y:0,z:0},color:"#5D4037"},{type:"stump",position:{x:-1,y:0,z:3},color:"#5D4037"},{type:"rock",position:{x:4,y:0,z:1},color:"#696969"},{type:"rock",position:{x:-1,y:0,z:1},color:"#707070"}]},rockGarden:{name:"Rock Garden",category:"nature",description:"Zen garden with rocks and plants",blocks:[...R(0,0,0,4,4,"#C2B280"),{type:"rock",position:{x:0,y:0,z:0},color:"#696969"},{type:"rock",position:{x:3,y:0,z:1},color:"#808080",rotation:{x:0,y:45,z:0}},{type:"rock",position:{x:1,y:0,z:3},color:"#707070",rotation:{x:0,y:90,z:0}},{type:"rock",position:{x:2,y:0,z:2},color:"#606060"},{type:"bush",position:{x:0,y:0,z:2},color:"#228B22"},{type:"bush",position:{x:3,y:0,z:3},color:"#2E8B2E"},{type:"planter",position:{x:2,y:0,z:0},color:"#8B4513"}]},pond:{name:"Pond",category:"nature",description:"Small pond with rocks and plants",blocks:[{type:"slab",position:{x:1,y:0,z:1},color:"#1E90FF"},{type:"slab",position:{x:2,y:0,z:1},color:"#1E90FF"},{type:"slab",position:{x:1,y:0,z:2},color:"#1E90FF"},{type:"slab",position:{x:2,y:0,z:2},color:"#1E90FF"},{type:"rock",position:{x:0,y:0,z:1},color:"#696969"},{type:"rock",position:{x:0,y:0,z:2},color:"#606060"},{type:"rock",position:{x:3,y:0,z:1},color:"#707070"},{type:"rock",position:{x:3,y:0,z:2},color:"#808080"},{type:"rock",position:{x:1,y:0,z:0},color:"#656565"},{type:"rock",position:{x:2,y:0,z:0},color:"#757575"},{type:"rock",position:{x:1,y:0,z:3},color:"#858585"},{type:"rock",position:{x:2,y:0,z:3},color:"#959595"},{type:"bush",position:{x:0,y:0,z:0},color:"#228B22"},{type:"bush",position:{x:3,y:0,z:3},color:"#2E8B2E"},{type:"logX",position:{x:1,y:1,z:1},color:"#5D4037"},{type:"logX",position:{x:2,y:1,z:1},color:"#5D4037"}]},campsite:{name:"Campsite",category:"nature",description:"Cozy wilderness campsite with tent, campfire, and outdoor gear",blocks:[...R(0,0,0,6,6,"#654321"),{type:"slab",position:{x:2,y:0,z:2},color:"#4A3728"},{type:"slab",position:{x:3,y:0,z:2},color:"#4A3728"},{type:"slab",position:{x:2,y:0,z:3},color:"#4A3728"},{type:"slab",position:{x:3,y:0,z:3},color:"#4A3728"},{type:"slab",position:{x:0,y:0,z:4},color:"#2F4F4F"},{type:"slab",position:{x:1,y:0,z:4},color:"#2F4F4F"},{type:"slab",position:{x:0,y:0,z:5},color:"#2F4F4F"},{type:"slab",position:{x:1,y:0,z:5},color:"#2F4F4F"},{type:"wedge",position:{x:0,y:1,z:4},color:"#3CB371"},{type:"wedge",position:{x:1,y:1,z:4},color:"#3CB371"},{type:"wedge",position:{x:0,y:1,z:5},color:"#2E8B57",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:1,y:1,z:5},color:"#2E8B57",rotation:{x:0,y:180,z:0}},{type:"pillar4",position:{x:0,y:1,z:4},color:"#8B4513"},{type:"pillar4",position:{x:1,y:1,z:5},color:"#8B4513"},{type:"rock",position:{x:2,y:0,z:2},color:"#404040"},{type:"rock",position:{x:3,y:0,z:2},color:"#505050"},{type:"rock",position:{x:2,y:0,z:3},color:"#505050"},{type:"rock",position:{x:3,y:0,z:3},color:"#404040"},{type:"pillar4",position:{x:2,y:0,z:2},color:"#FF4500",emissive:{enabled:!0,color:"#FF6600",intensity:4,radius:6}},{type:"pillar4",position:{x:3,y:0,z:3},color:"#FF8C00",emissive:{enabled:!0,color:"#FF4500",intensity:3,radius:4}},{type:"sphere",position:{x:2,y:1,z:2},color:"#3A3A3A"},{type:"logX",position:{x:1,y:0,z:1},color:"#5D4037"},{type:"logZ",position:{x:4,y:0,z:2},color:"#5D4037"},{type:"logZ",position:{x:4,y:0,z:3},color:"#5D4037"},{type:"logX",position:{x:1,y:0,z:4},color:"#5D4037"},{type:"pillar4",position:{x:3,y:1,z:2},color:"#2F2F2F"},{type:"barrel",position:{x:3,y:0,z:2},color:"#1A1A1A"},{type:"crate",position:{x:5,y:0,z:0},color:"#8B4513"},{type:"crate",position:{x:5,y:0,z:1},color:"#A0522D"},{type:"crate",position:{x:5,y:1,z:0},color:"#CD853F"},{type:"barrel",position:{x:5,y:0,z:2},color:"#4169E1"},{type:"sphere",position:{x:5,y:1,z:1},color:"#FFD700",emissive:{enabled:!0,color:"#FFAA00",intensity:2,radius:3}},{type:"pillar4",position:{x:0,y:0,z:0},color:"#8B4513"},{type:"pillar4",position:{x:0,y:1,z:0},color:"#8B4513"},{type:"barrel",position:{x:1,y:0,z:0},color:"#696969"},{type:"boulder",position:{x:0,y:0,z:2},color:"#696969"},{type:"rock",position:{x:4,y:0,z:5},color:"#707070"},{type:"bush",position:{x:5,y:0,z:4},color:"#228B22"},{type:"bush",position:{x:5,y:0,z:5},color:"#2E8B2E"},{type:"pillar",position:{x:-1,y:0,z:3},color:"#5D4037"},{type:"pillar",position:{x:-1,y:1,z:3},color:"#5D4037"},{type:"sphere",position:{x:-1,y:2,z:3},color:"#228B22"},{type:"grass",position:{x:0,y:0,z:1},color:"#7CFC00"},{type:"grass",position:{x:4,y:0,z:0},color:"#90EE90"},{type:"flower",position:{x:3,y:0,z:5},color:"#FFFF00"}]},factory:{name:"Factory Building",category:"industrial",description:"Detailed industrial facility with machinery, pipes, and electrical systems",blocks:[...R(0,0,0,8,6,"#505050"),{type:"grate",position:{x:3,y:0,z:3},color:"#404040"},{type:"grate",position:{x:4,y:0,z:3},color:"#404040"},...at(0,1,0,8,3,"#606060"),...at(0,1,5,8,3,"#606060"),...st(0,1,1,4,3,"#606060"),...st(7,1,1,4,3,"#606060"),...R(0,4,0,8,6,"#505050"),{type:"iBeam",position:{x:2,y:1,z:2},color:"#8B0000"},{type:"iBeam",position:{x:2,y:2,z:2},color:"#8B0000"},{type:"iBeam",position:{x:2,y:3,z:2},color:"#8B0000"},{type:"iBeam",position:{x:5,y:1,z:2},color:"#8B0000"},{type:"iBeam",position:{x:5,y:2,z:2},color:"#8B0000"},{type:"iBeam",position:{x:5,y:3,z:2},color:"#8B0000"},{type:"iBeam",position:{x:2,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:3,z:4},color:"#8B0000"},{type:"doorFrame",position:{x:3,y:1,z:0},color:"#FFD700"},{type:"doorFrame",position:{x:4,y:1,z:0},color:"#FFD700"},{type:"doorFrame",position:{x:3,y:2,z:0},color:"#FFD700"},{type:"doorFrame",position:{x:4,y:2,z:0},color:"#FFD700"},{type:"windowFrame",position:{x:1,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:2,z:5},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:2,z:5},color:"#4682B4"},{type:"tank",position:{x:1,y:4,z:1},color:"#C0C0C0"},{type:"tank",position:{x:1,y:5,z:1},color:"#B0B0B0"},{type:"tank",position:{x:6,y:4,z:1},color:"#808080"},{type:"tank",position:{x:6,y:5,z:1},color:"#707070"},{type:"vent",position:{x:3,y:4,z:3},color:"#4A4A4A"},{type:"vent",position:{x:4,y:4,z:3},color:"#4A4A4A"},{type:"acUnit",position:{x:1,y:4,z:4},color:"#909090"},{type:"acUnit",position:{x:6,y:4,z:4},color:"#909090"},{type:"chimney",position:{x:0,y:4,z:2},color:"#8B4513"},{type:"chimney",position:{x:0,y:5,z:2},color:"#704214"},{type:"chimney",position:{x:0,y:6,z:2},color:"#5D3A1A"},{type:"pipeX",position:{x:2,y:5,z:1},color:"#696969"},{type:"pipeX",position:{x:3,y:5,z:1},color:"#696969"},{type:"pipeX",position:{x:4,y:5,z:1},color:"#696969"},{type:"pipeX",position:{x:5,y:5,z:1},color:"#696969"},{type:"valve",position:{x:3,y:5,z:1},color:"#B22222"},{type:"pipeY",position:{x:4,y:4,z:1},color:"#696969"},{type:"fuseBox",position:{x:0,y:1,z:3},color:"#404040"},{type:"powerBox",position:{x:7,y:1,z:3},color:"#2F4F4F"},{type:"cableY",position:{x:0,y:2,z:3},color:"#696969"},{type:"cableY",position:{x:0,y:3,z:3},color:"#696969"},{type:"beamX",position:{x:1,y:3,z:3},color:"#404040"},{type:"beamX",position:{x:2,y:3,z:3},color:"#404040"},{type:"beamX",position:{x:3,y:3,z:3},color:"#404040"},{type:"beamX",position:{x:4,y:3,z:3},color:"#404040"},{type:"cableX",position:{x:1,y:3,z:3},color:"#1A1A1A"},{type:"cableX",position:{x:2,y:3,z:3},color:"#1A1A1A"},{type:"lightFixture",position:{x:3,y:3,z:3},color:"#FFFF00"},{type:"lightFixture",position:{x:4,y:3,z:3},color:"#FFFF00"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:4,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:4,y:1,z:2},color:"#4A4A4A"},{type:"catwalk",position:{x:3,y:2,z:2},color:"#3A3A3A"},{type:"catwalk",position:{x:4,y:2,z:2},color:"#3A3A3A"},{type:"railing",position:{x:3,y:3,z:2},color:"#505050"},{type:"railing",position:{x:4,y:3,z:2},color:"#505050"},{type:"ladder",position:{x:2,y:1,z:3},color:"#FFD700"},{type:"ladder",position:{x:2,y:2,z:3},color:"#FFD700"},{type:"crate",position:{x:6,y:0,z:2},color:"#8B4513"},{type:"crate",position:{x:6,y:0,z:3},color:"#A0522D"},{type:"crate",position:{x:6,y:1,z:2},color:"#CD853F"},{type:"barrel",position:{x:1,y:0,z:3},color:"#006400"},{type:"barrel",position:{x:1,y:0,z:4},color:"#2F4F4F"},{type:"barrier",position:{x:3,y:0,z:-1},color:"#FFD700"},{type:"barrier",position:{x:4,y:0,z:-1},color:"#FFD700"},{type:"trafficCone",position:{x:2,y:0,z:-1},color:"#FF4500"}]},pipeNetwork:{name:"Pipe Network",category:"industrial",description:"Industrial pipe and cable network showcase with all junction types",blocks:[...R(0,0,0,8,8,"#505050"),{type:"pipeX",position:{x:0,y:2,z:2},color:"#4682B4"},{type:"pipeX",position:{x:1,y:2,z:2},color:"#4682B4"},{type:"pipeX",position:{x:2,y:2,z:2},color:"#4682B4"},{type:"valve",position:{x:1,y:2,z:2},color:"#B22222"},{type:"pipeElbowXZ4",position:{x:3,y:2,z:2},color:"#4682B4"},{type:"pipeZ",position:{x:3,y:2,z:3},color:"#4682B4"},{type:"pipeZ",position:{x:3,y:2,z:4},color:"#4682B4"},{type:"pipeT",position:{x:3,y:2,z:5},color:"#4682B4"},{type:"pipeX",position:{x:2,y:2,z:5},color:"#4682B4"},{type:"pipeX",position:{x:4,y:2,z:5},color:"#4682B4"},{type:"valve",position:{x:4,y:2,z:5},color:"#B22222"},{type:"pipeY",position:{x:6,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:6,y:1,z:2},color:"#708090"},{type:"pipeY",position:{x:6,y:2,z:2},color:"#708090"},{type:"pipeElbowXY",position:{x:6,y:3,z:2},color:"#708090"},{type:"pipeX",position:{x:7,y:3,z:2},color:"#708090"},{type:"pipeTY",position:{x:5,y:2,z:2},color:"#708090"},{type:"pipeX",position:{x:4,y:2,z:2},color:"#708090"},{type:"pipeY",position:{x:5,y:3,z:2},color:"#708090"},{type:"vent",position:{x:5,y:4,z:2},color:"#606060"},{type:"pipeCross",position:{x:5,y:2,z:5},color:"#FF8C00"},{type:"pipeX",position:{x:6,y:2,z:5},color:"#FF8C00"},{type:"pipeZ",position:{x:5,y:2,z:6},color:"#FF8C00"},{type:"valve",position:{x:5,y:2,z:6},color:"#B22222"},{type:"cableX",position:{x:0,y:1,z:1},color:"#1A1A1A"},{type:"cableX",position:{x:1,y:1,z:1},color:"#1A1A1A"},{type:"cableX",position:{x:2,y:1,z:1},color:"#1A1A1A"},{type:"cableElbow",position:{x:3,y:1,z:1},color:"#1A1A1A"},{type:"cableZ",position:{x:3,y:1,z:2},color:"#1A1A1A"},{type:"cableZ",position:{x:3,y:1,z:3},color:"#1A1A1A"},{type:"cableT",position:{x:3,y:1,z:4},color:"#1A1A1A"},{type:"cableZ",position:{x:3,y:1,z:5},color:"#1A1A1A"},{type:"cableY",position:{x:1,y:0,z:6},color:"#8B0000"},{type:"cableY",position:{x:1,y:1,z:6},color:"#8B0000"},{type:"cableY",position:{x:1,y:2,z:6},color:"#8B0000"},{type:"cableElbowY",position:{x:1,y:3,z:6},color:"#8B0000"},{type:"cableX",position:{x:2,y:3,z:6},color:"#8B0000"},{type:"cableX",position:{x:3,y:3,z:6},color:"#8B0000"},{type:"conduitX",position:{x:5,y:0,z:0},color:"#696969"},{type:"conduitX",position:{x:6,y:0,z:0},color:"#696969"},{type:"conduitElbow",position:{x:7,y:0,z:0},color:"#696969"},{type:"conduitZ",position:{x:7,y:0,z:1},color:"#696969"},{type:"conduitT",position:{x:7,y:0,z:2},color:"#696969"},{type:"conduitZ",position:{x:7,y:0,z:3},color:"#696969"},{type:"pillar2",position:{x:0,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:0,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:0,z:5},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:5},color:"#4A4A4A"},{type:"pillar2",position:{x:5,y:0,z:5},color:"#4A4A4A"},{type:"pillar2",position:{x:5,y:1,z:5},color:"#4A4A4A"},{type:"fuseBox",position:{x:0,y:0,z:1},color:"#404040"},{type:"switchBox",position:{x:1,y:0,z:0},color:"#505050"},{type:"powerBox",position:{x:0,y:0,z:6},color:"#2F4F4F"},{type:"tank",position:{x:0,y:0,z:4},color:"#4682B4"},{type:"tank",position:{x:0,y:1,z:4},color:"#4682B4"},{type:"tank",position:{x:7,y:0,z:5},color:"#FF8C00"},{type:"tank",position:{x:7,y:1,z:5},color:"#FF8C00"},{type:"sign",position:{x:0,y:2,z:4},color:"#FFFF00"},{type:"sign",position:{x:7,y:2,z:5},color:"#FF4500"}]},storageYard:{name:"Storage Yard",category:"industrial",description:"Outdoor storage with crates and barrels",blocks:[...R(0,0,0,5,4,"#808080"),{type:"crate",position:{x:0,y:0,z:0},color:"#8B4513"},{type:"crate",position:{x:1,y:0,z:0},color:"#A0522D"},{type:"crate",position:{x:0,y:0,z:1},color:"#8B4513"},{type:"crate",position:{x:1,y:0,z:1},color:"#A0522D"},{type:"crate",position:{x:0,y:1,z:0},color:"#CD853F"},{type:"crate",position:{x:1,y:1,z:0},color:"#8B4513"},{type:"barrel",position:{x:3,y:0,z:0},color:"#2F4F4F"},{type:"barrel",position:{x:4,y:0,z:0},color:"#2F4F4F"},{type:"barrel",position:{x:3,y:0,z:1},color:"#006400"},{type:"barrel",position:{x:4,y:0,z:1},color:"#006400"},{type:"barrel",position:{x:3,y:1,z:0},color:"#2F4F4F"},{type:"barrier",position:{x:0,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:1,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:2,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:3,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:4,y:0,z:3},color:"#FFD700"}]},refinery:{name:"Refinery",category:"industrial",description:"Oil refinery with tanks and pipes",blocks:[...R(0,0,0,5,5,"#404040"),{type:"tank",position:{x:0,y:0,z:0},color:"#C0C0C0"},{type:"tank",position:{x:0,y:1,z:0},color:"#C0C0C0"},{type:"tank",position:{x:0,y:2,z:0},color:"#C0C0C0"},{type:"tank",position:{x:4,y:0,z:0},color:"#808080"},{type:"tank",position:{x:4,y:1,z:0},color:"#808080"},{type:"tank",position:{x:4,y:2,z:0},color:"#808080"},{type:"pipeX",position:{x:1,y:2,z:0},color:"#696969"},{type:"pipeX",position:{x:2,y:2,z:0},color:"#696969"},{type:"pipeX",position:{x:3,y:2,z:0},color:"#696969"},{type:"valve",position:{x:2,y:2,z:0},color:"#B22222"},{type:"cube",position:{x:2,y:0,z:2},color:"#505050"},{type:"cube",position:{x:2,y:1,z:2},color:"#505050"},{type:"vent",position:{x:2,y:2,z:2},color:"#404040"},{type:"pillar2",position:{x:1,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:1,y:1,z:2},color:"#4A4A4A"},{type:"catwalk",position:{x:1,y:2,z:2},color:"#3A3A3A"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#4A4A4A"},{type:"catwalk",position:{x:3,y:2,z:2},color:"#3A3A3A"},{type:"ladder",position:{x:0,y:0,z:1},color:"#FFD700"},{type:"ladder",position:{x:0,y:1,z:1},color:"#FFD700"},{type:"ladder",position:{x:0,y:2,z:1},color:"#FFD700"}]},industrialComplex:{name:"Industrial Complex",category:"industrial",description:"Large industrial facility with buildings, tanks, and pipe network",blocks:[...R(0,0,0,12,10,"#505050"),...at(0,1,0,5,3,"#606060"),...at(0,1,4,5,3,"#606060"),...st(0,1,1,3,3,"#606060"),...st(4,1,1,3,3,"#606060"),...R(0,4,0,5,5,"#404040"),{type:"doorFrame",position:{x:1,y:1,z:4},color:"#333333"},{type:"doorFrame",position:{x:2,y:1,z:4},color:"#333333"},{type:"doorFrame",position:{x:1,y:2,z:4},color:"#333333"},{type:"doorFrame",position:{x:2,y:2,z:4},color:"#333333"},{type:"windowFrame",position:{x:1,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:2,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:2,z:0},color:"#4682B4"},{type:"iBeam",position:{x:1,y:1,z:2},color:"#8B0000"},{type:"iBeam",position:{x:1,y:2,z:2},color:"#8B0000"},{type:"iBeam",position:{x:1,y:3,z:2},color:"#8B0000"},{type:"iBeam",position:{x:3,y:1,z:2},color:"#8B0000"},{type:"iBeam",position:{x:3,y:2,z:2},color:"#8B0000"},{type:"iBeam",position:{x:3,y:3,z:2},color:"#8B0000"},{type:"vent",position:{x:1,y:4,z:1},color:"#3A3A3A"},{type:"vent",position:{x:3,y:4,z:1},color:"#3A3A3A"},{type:"vent",position:{x:2,y:4,z:3},color:"#3A3A3A"},{type:"chimney",position:{x:0,y:4,z:0},color:"#8B4513"},{type:"chimney",position:{x:0,y:5,z:0},color:"#8B4513"},{type:"chimney",position:{x:0,y:6,z:0},color:"#8B4513"},{type:"chimney",position:{x:0,y:7,z:0},color:"#704214"},{type:"tank",position:{x:8,y:0,z:1},color:"#C0C0C0"},{type:"tank",position:{x:8,y:1,z:1},color:"#C0C0C0"},{type:"tank",position:{x:8,y:2,z:1},color:"#C0C0C0"},{type:"tank",position:{x:8,y:3,z:1},color:"#B0B0B0"},{type:"tank",position:{x:10,y:0,z:1},color:"#A0A0A0"},{type:"tank",position:{x:10,y:1,z:1},color:"#A0A0A0"},{type:"tank",position:{x:10,y:2,z:1},color:"#A0A0A0"},{type:"tank",position:{x:10,y:3,z:1},color:"#909090"},{type:"tank",position:{x:8,y:0,z:4},color:"#708090"},{type:"tank",position:{x:8,y:1,z:4},color:"#708090"},{type:"tank",position:{x:10,y:0,z:4},color:"#708090"},{type:"tank",position:{x:10,y:1,z:4},color:"#708090"},{type:"ladder",position:{x:8,y:0,z:0},color:"#FFD700"},{type:"ladder",position:{x:8,y:1,z:0},color:"#FFD700"},{type:"ladder",position:{x:8,y:2,z:0},color:"#FFD700"},{type:"ladder",position:{x:8,y:3,z:0},color:"#FFD700"},{type:"pipeX",position:{x:5,y:2,z:2},color:"#696969"},{type:"pipeX",position:{x:6,y:2,z:2},color:"#696969"},{type:"pipeX",position:{x:7,y:2,z:2},color:"#696969"},{type:"pipeElbowXZ4",position:{x:8,y:2,z:2},color:"#696969"},{type:"pipeZ",position:{x:8,y:2,z:1},color:"#696969"},{type:"pipeT",position:{x:7,y:2,z:2},color:"#696969"},{type:"pipeZ",position:{x:7,y:2,z:3},color:"#696969"},{type:"pipeZ",position:{x:7,y:2,z:4},color:"#696969"},{type:"pipeCross",position:{x:9,y:1,z:4},color:"#696969"},{type:"pipeX",position:{x:8,y:1,z:4},color:"#696969"},{type:"pipeX",position:{x:10,y:1,z:4},color:"#696969"},{type:"pipeY",position:{x:9,y:0,z:4},color:"#696969"},{type:"pipeTY",position:{x:9,y:2,z:4},color:"#696969"},{type:"valve",position:{x:6,y:2,z:2},color:"#B22222"},{type:"valve",position:{x:9,y:1,z:4},color:"#B22222"},{type:"pillar2",position:{x:5,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:5,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:1,z:2},color:"#4A4A4A"},{type:"catwalk",position:{x:9,y:3,z:1},color:"#3A3A3A"},{type:"railing",position:{x:9,y:4,z:1},color:"#505050"},{type:"pillar",position:{x:9,y:0,z:1},color:"#4A4A4A"},{type:"pillar",position:{x:9,y:1,z:1},color:"#4A4A4A"},{type:"pillar",position:{x:9,y:2,z:1},color:"#4A4A4A"},{type:"crate",position:{x:0,y:0,z:6},color:"#8B4513"},{type:"crate",position:{x:1,y:0,z:6},color:"#A0522D"},{type:"crate",position:{x:0,y:0,z:7},color:"#8B4513"},{type:"crate",position:{x:1,y:0,z:7},color:"#CD853F"},{type:"crate",position:{x:0,y:1,z:6},color:"#A0522D"},{type:"barrel",position:{x:3,y:0,z:6},color:"#2F4F4F"},{type:"barrel",position:{x:4,y:0,z:6},color:"#006400"},{type:"barrel",position:{x:3,y:0,z:7},color:"#8B0000"},{type:"barrel",position:{x:4,y:0,z:7},color:"#2F4F4F"},{type:"cube",position:{x:6,y:0,z:7},color:"#D3D3D3"},{type:"cube",position:{x:7,y:0,z:7},color:"#D3D3D3"},{type:"cube",position:{x:6,y:0,z:8},color:"#D3D3D3"},{type:"cube",position:{x:7,y:0,z:8},color:"#D3D3D3"},{type:"cube",position:{x:6,y:1,z:7},color:"#C0C0C0"},{type:"cube",position:{x:7,y:1,z:7},color:"#C0C0C0"},{type:"cube",position:{x:6,y:1,z:8},color:"#C0C0C0"},{type:"cube",position:{x:7,y:1,z:8},color:"#C0C0C0"},{type:"slab",position:{x:6,y:2,z:7},color:"#808080"},{type:"slab",position:{x:7,y:2,z:7},color:"#808080"},{type:"slab",position:{x:6,y:2,z:8},color:"#808080"},{type:"slab",position:{x:7,y:2,z:8},color:"#808080"},{type:"acUnit",position:{x:7,y:2,z:8},color:"#909090"},{type:"antenna",position:{x:6,y:2,z:7},color:"#606060"},{type:"doorFrame",position:{x:6,y:0,z:6},color:"#333333"},{type:"slab",position:{x:10,y:0,z:7},color:"#707070"},{type:"slab",position:{x:11,y:0,z:7},color:"#707070"},{type:"slab",position:{x:10,y:0,z:8},color:"#707070"},{type:"slab",position:{x:11,y:0,z:8},color:"#707070"},{type:"barrier",position:{x:10,y:0,z:6},color:"#FFD700"},{type:"barrier",position:{x:11,y:0,z:6},color:"#FFD700"},{type:"fence",position:{x:0,y:0,z:9},color:"#696969"},{type:"fence",position:{x:1,y:0,z:9},color:"#696969"},{type:"fence",position:{x:2,y:0,z:9},color:"#696969"},{type:"fence",position:{x:3,y:0,z:9},color:"#696969"},{type:"fence",position:{x:4,y:0,z:9},color:"#696969"},{type:"fence",position:{x:5,y:0,z:9},color:"#696969"},{type:"fence",position:{x:8,y:0,z:9},color:"#696969"},{type:"fence",position:{x:9,y:0,z:9},color:"#696969"},{type:"fence",position:{x:10,y:0,z:9},color:"#696969"},{type:"fence",position:{x:11,y:0,z:9},color:"#696969"}]},rooftopTerrace:{name:"Rooftop Terrace",category:"modern",description:"Modern rooftop with furniture and plants",blocks:[...R(0,0,0,5,4,"#D2B48C"),{type:"planter",position:{x:0,y:0,z:0},color:"#696969"},{type:"bush",position:{x:0,y:1,z:0},color:"#228B22"},{type:"planter",position:{x:4,y:0,z:0},color:"#696969"},{type:"bush",position:{x:4,y:1,z:0},color:"#2E8B2E"},{type:"planter",position:{x:0,y:0,z:3},color:"#696969"},{type:"bush",position:{x:0,y:1,z:3},color:"#32CD32"},{type:"planter",position:{x:4,y:0,z:3},color:"#696969"},{type:"bush",position:{x:4,y:1,z:3},color:"#228B22"},{type:"bench",position:{x:1,y:0,z:1},color:"#8B4513"},{type:"table",position:{x:2,y:0,z:1},color:"#A0522D"},{type:"chair",position:{x:3,y:0,z:1},color:"#8B4513"},{type:"acUnit",position:{x:2,y:0,z:3},color:"#C0C0C0"},{type:"solarPanel",position:{x:1,y:0,z:3},color:"#1a1a2e"},{type:"solarPanel",position:{x:3,y:0,z:3},color:"#1a1a2e"}]},parkingLot:{name:"Parking Lot",category:"modern",description:"Parking area with barriers and lights",blocks:[...R(0,0,0,6,4,"#2F2F2F"),{type:"slab",position:{x:1,y:0,z:0},color:"#FFFFFF"},{type:"slab",position:{x:3,y:0,z:0},color:"#FFFFFF"},{type:"slab",position:{x:5,y:0,z:0},color:"#FFFFFF"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:1},color:"#FF0000"},{type:"barrier",position:{x:0,y:0,z:2},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:3},color:"#FF0000"},{type:"pillar2",position:{x:2,y:0,z:3},color:"#808080"},{type:"pillar2",position:{x:2,y:1,z:3},color:"#808080"},{type:"pillar2",position:{x:2,y:2,z:3},color:"#808080"},{type:"solarPanel",position:{x:2,y:3,z:3},color:"#404040"},{type:"quarter",position:{x:2,y:2,z:3},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFAA",intensity:2,radius:6}},{type:"pillar2",position:{x:5,y:0,z:3},color:"#808080"},{type:"pillar2",position:{x:5,y:1,z:3},color:"#808080"},{type:"pillar2",position:{x:5,y:2,z:3},color:"#808080"},{type:"quarter",position:{x:5,y:2,z:3},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFAA",intensity:2,radius:6}}]},busStop:{name:"Bus Stop",category:"modern",description:"Modern bus shelter with bench",blocks:[{type:"slab",position:{x:0,y:0,z:0},color:"#808080"},{type:"slab",position:{x:1,y:0,z:0},color:"#808080"},{type:"slab",position:{x:2,y:0,z:0},color:"#808080"},{type:"slab",position:{x:0,y:0,z:1},color:"#808080"},{type:"slab",position:{x:1,y:0,z:1},color:"#808080"},{type:"slab",position:{x:2,y:0,z:1},color:"#808080"},{type:"pillar2",position:{x:0,y:0,z:0},color:"#4169E1"},{type:"pillar2",position:{x:0,y:1,z:0},color:"#4169E1"},{type:"pillar2",position:{x:2,y:0,z:0},color:"#4169E1"},{type:"pillar2",position:{x:2,y:1,z:0},color:"#4169E1"},{type:"slab",position:{x:0,y:2,z:0},color:"#4169E1"},{type:"slab",position:{x:1,y:2,z:0},color:"#4169E1"},{type:"slab",position:{x:2,y:2,z:0},color:"#4169E1"},{type:"slab",position:{x:0,y:2,z:1},color:"#4169E1"},{type:"slab",position:{x:1,y:2,z:1},color:"#4169E1"},{type:"slab",position:{x:2,y:2,z:1},color:"#4169E1"},{type:"bench",position:{x:1,y:0,z:0},color:"#8B4513"},{type:"quarter",position:{x:1,y:2,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:4}}]},solarFarm:{name:"Solar Farm",category:"modern",description:"Array of solar panels",blocks:[...R(0,0,0,5,4,"#90EE90"),{type:"solarPanel",position:{x:0,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:1,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:2,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:3,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:4,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:0,y:0,z:2},color:"#1a1a2e"},{type:"solarPanel",position:{x:1,y:0,z:2},color:"#1a1a2e"},{type:"solarPanel",position:{x:2,y:0,z:2},color:"#1a1a2e"},{type:"solarPanel",position:{x:3,y:0,z:2},color:"#1a1a2e"},{type:"solarPanel",position:{x:4,y:0,z:2},color:"#1a1a2e"},{type:"cube",position:{x:2,y:0,z:3},color:"#808080"},{type:"vent",position:{x:2,y:1,z:3},color:"#696969"},{type:"fence",position:{x:0,y:0,z:3},color:"#C0C0C0"},{type:"fence",position:{x:1,y:0,z:3},color:"#C0C0C0"},{type:"fence",position:{x:3,y:0,z:3},color:"#C0C0C0"},{type:"fence",position:{x:4,y:0,z:3},color:"#C0C0C0"}]},diningRoom:{name:"Dining Room",category:"furniture",description:"Dining set with table and chairs",blocks:[...R(0,0,0,4,4,"#DEB887"),{type:"table",position:{x:1,y:0,z:1},color:"#8B4513"},{type:"table",position:{x:2,y:0,z:1},color:"#8B4513"},{type:"table",position:{x:1,y:0,z:2},color:"#8B4513"},{type:"table",position:{x:2,y:0,z:2},color:"#8B4513"},{type:"chair",position:{x:0,y:0,z:1},color:"#654321",rotation:{x:0,y:90,z:0}},{type:"chair",position:{x:0,y:0,z:2},color:"#654321",rotation:{x:0,y:90,z:0}},{type:"chair",position:{x:3,y:0,z:1},color:"#654321",rotation:{x:0,y:270,z:0}},{type:"chair",position:{x:3,y:0,z:2},color:"#654321",rotation:{x:0,y:270,z:0}},{type:"chair",position:{x:1,y:0,z:0},color:"#654321",rotation:{x:0,y:180,z:0}},{type:"chair",position:{x:2,y:0,z:0},color:"#654321",rotation:{x:0,y:180,z:0}},{type:"chair",position:{x:1,y:0,z:3},color:"#654321"},{type:"chair",position:{x:2,y:0,z:3},color:"#654321"}]},livingRoom:{name:"Living Room",category:"furniture",description:"Cozy living room with sofa, fireplace, entertainment center, and decorations",blocks:[...R(0,0,0,8,7,"#DEB887"),{type:"slab",position:{x:2,y:0,z:2},color:"#8B0000"},{type:"slab",position:{x:3,y:0,z:2},color:"#8B0000"},{type:"slab",position:{x:4,y:0,z:2},color:"#8B0000"},{type:"slab",position:{x:2,y:0,z:3},color:"#A52A2A"},{type:"slab",position:{x:3,y:0,z:3},color:"#A52A2A"},{type:"slab",position:{x:4,y:0,z:3},color:"#A52A2A"},{type:"slab",position:{x:2,y:0,z:4},color:"#8B0000"},{type:"slab",position:{x:3,y:0,z:4},color:"#8B0000"},{type:"slab",position:{x:4,y:0,z:4},color:"#8B0000"},...st(0,1,0,7,3,"#F5F5DC"),...at(0,1,0,8,3,"#F5F5DC"),{type:"cube",position:{x:3,y:1,z:0},color:"#696969"},{type:"cube",position:{x:4,y:1,z:0},color:"#696969"},{type:"cube",position:{x:2,y:1,z:0},color:"#808080"},{type:"cube",position:{x:5,y:1,z:0},color:"#808080"},{type:"cube",position:{x:2,y:2,z:0},color:"#808080"},{type:"cube",position:{x:5,y:2,z:0},color:"#808080"},{type:"slab",position:{x:2,y:3,z:0},color:"#654321"},{type:"slab",position:{x:3,y:3,z:0},color:"#654321"},{type:"slab",position:{x:4,y:3,z:0},color:"#654321"},{type:"slab",position:{x:5,y:3,z:0},color:"#654321"},{type:"doorFrame",position:{x:3,y:1,z:0},color:"#1A1A1A"},{type:"doorFrame",position:{x:4,y:1,z:0},color:"#1A1A1A"},{type:"cube",position:{x:3,y:1,z:0},color:"#FF4500",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"chimney",position:{x:3,y:3,z:0},color:"#696969"},{type:"chimney",position:{x:4,y:3,z:0},color:"#696969"},{type:"pillar2",position:{x:2,y:3,z:0},color:"#FFD700"},{type:"pillar2",position:{x:5,y:3,z:0},color:"#FFD700"},{type:"bench",position:{x:2,y:0,z:5},color:"#4169E1"},{type:"bench",position:{x:3,y:0,z:5},color:"#4169E1"},{type:"bench",position:{x:4,y:0,z:5},color:"#4169E1"},{type:"halfZ",position:{x:2,y:1,z:6},color:"#3A5FCD"},{type:"halfZ",position:{x:3,y:1,z:6},color:"#3A5FCD"},{type:"halfZ",position:{x:4,y:1,z:6},color:"#3A5FCD"},{type:"halfX",position:{x:1,y:0,z:5},color:"#3A5FCD"},{type:"halfX",position:{x:5,y:0,z:5},color:"#3A5FCD",rotation:{x:0,y:180,z:0}},{type:"slab",position:{x:2,y:0,z:5},color:"#FFD700"},{type:"slab",position:{x:4,y:0,z:5},color:"#DC143C"},{type:"table",position:{x:3,y:0,z:3},color:"#8B4513"},{type:"slab",position:{x:3,y:1,z:3},color:"#228B22"},{type:"shelf",position:{x:0,y:0,z:2},color:"#2F2F2F"},{type:"shelf",position:{x:0,y:0,z:3},color:"#2F2F2F"},{type:"shelf",position:{x:0,y:0,z:4},color:"#2F2F2F"},{type:"monitor",position:{x:0,y:1,z:3},color:"#1A1A1A"},{type:"speaker",position:{x:0,y:1,z:2},color:"#2F2F2F"},{type:"speaker",position:{x:0,y:1,z:4},color:"#2F2F2F"},{type:"shelfUnit",position:{x:7,y:0,z:0},color:"#654321"},{type:"shelfUnit",position:{x:7,y:1,z:0},color:"#654321"},{type:"shelfUnit",position:{x:7,y:2,z:0},color:"#654321"},{type:"chair",position:{x:6,y:0,z:3},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"table",position:{x:6,y:0,z:5},color:"#A0522D"},{type:"pillar2",position:{x:6,y:1,z:5},color:"#B87333"},{type:"dome",position:{x:6,y:2,z:5},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:1.5,radius:4}},{type:"planter",position:{x:7,y:0,z:5},color:"#8B4513"},{type:"bush",position:{x:7,y:1,z:5},color:"#228B22"},{type:"bush",position:{x:7,y:2,z:5},color:"#2E8B57"},{type:"windowFrame",position:{x:0,y:2,z:5},color:"#F5F5DC"},{type:"windowFrame",position:{x:0,y:2,z:6},color:"#F5F5DC"},{type:"windowSill",position:{x:0,y:1,z:5},color:"#F5F5DC"},{type:"windowSill",position:{x:0,y:1,z:6},color:"#F5F5DC"},{type:"lightFixture",position:{x:3,y:3,z:3},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:5}}]},workshop:{name:"Workshop",category:"furniture",description:"Crafting workshop with tools",blocks:[...R(0,0,0,4,4,"#696969"),{type:"table",position:{x:0,y:0,z:0},color:"#8B4513"},{type:"table",position:{x:1,y:0,z:0},color:"#8B4513"},{type:"table",position:{x:2,y:0,z:0},color:"#8B4513"},{type:"valve",position:{x:0,y:1,z:0},color:"#B22222"},{type:"valve",position:{x:2,y:1,z:0},color:"#4169E1"},{type:"chair",position:{x:1,y:0,z:1},color:"#654321"},{type:"crate",position:{x:3,y:0,z:0},color:"#8B4513"},{type:"crate",position:{x:3,y:0,z:1},color:"#A0522D"},{type:"crate",position:{x:3,y:1,z:0},color:"#CD853F"},{type:"barrel",position:{x:0,y:0,z:3},color:"#2F4F4F"},{type:"barrel",position:{x:1,y:0,z:3},color:"#006400"},{type:"ladder",position:{x:3,y:0,z:3},color:"#8B4513"},{type:"ladder",position:{x:3,y:1,z:3},color:"#8B4513"}]},cellar:{name:"Wine Cellar",category:"furniture",description:"Underground cellar with barrels",blocks:[...R(0,0,0,4,3,"#505050"),{type:"barrel",position:{x:0,y:0,z:0},color:"#5C4033",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:1,y:0,z:0},color:"#5C4033",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:2,y:0,z:0},color:"#5C4033",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:0,y:1,z:0},color:"#4A3728",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:1,y:1,z:0},color:"#4A3728",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:2,y:1,z:0},color:"#4A3728",rotation:{x:90,y:0,z:0}},{type:"crate",position:{x:3,y:0,z:0},color:"#654321"},{type:"crate",position:{x:3,y:1,z:0},color:"#654321"},{type:"crate",position:{x:3,y:0,z:1},color:"#654321"},{type:"crate",position:{x:3,y:1,z:1},color:"#654321"},{type:"table",position:{x:1,y:0,z:2},color:"#8B4513"},{type:"torch",position:{x:0,y:1,z:2},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:1.5,radius:4}}]},stoneBridge:{name:"Stone Bridge",category:"infrastructure",description:"Grand arched stone bridge with decorative pillars, lanterns, and water below",blocks:[{type:"slab",position:{x:1,y:-1,z:0},color:"#4169E1"},{type:"slab",position:{x:2,y:-1,z:0},color:"#4682B4"},{type:"slab",position:{x:3,y:-1,z:0},color:"#4169E1"},{type:"slab",position:{x:4,y:-1,z:0},color:"#4682B4"},{type:"slab",position:{x:5,y:-1,z:0},color:"#4169E1"},{type:"slab",position:{x:1,y:-1,z:1},color:"#4682B4"},{type:"slab",position:{x:2,y:-1,z:1},color:"#4169E1"},{type:"slab",position:{x:3,y:-1,z:1},color:"#4682B4"},{type:"slab",position:{x:4,y:-1,z:1},color:"#4169E1"},{type:"slab",position:{x:5,y:-1,z:1},color:"#4682B4"},{type:"slab",position:{x:1,y:-1,z:-1},color:"#4682B4"},{type:"slab",position:{x:2,y:-1,z:-1},color:"#4169E1"},{type:"slab",position:{x:3,y:-1,z:-1},color:"#4682B4"},{type:"slab",position:{x:4,y:-1,z:-1},color:"#4169E1"},{type:"slab",position:{x:5,y:-1,z:-1},color:"#4682B4"},{type:"column",position:{x:0,y:-1,z:0},color:"#505050"},{type:"column",position:{x:0,y:0,z:0},color:"#606060"},{type:"column",position:{x:0,y:1,z:0},color:"#696969"},{type:"base",position:{x:0,y:-1,z:0},color:"#404040"},{type:"column",position:{x:8,y:-1,z:0},color:"#505050"},{type:"column",position:{x:8,y:0,z:0},color:"#606060"},{type:"column",position:{x:8,y:1,z:0},color:"#696969"},{type:"base",position:{x:8,y:-1,z:0},color:"#404040"},{type:"column",position:{x:4,y:-1,z:0},color:"#505050"},{type:"buttress",position:{x:4,y:0,z:0},color:"#606060"},{type:"arch",position:{x:2,y:0,z:0},color:"#707070",rotation:{x:0,y:90,z:0}},{type:"arch",position:{x:6,y:0,z:0},color:"#707070",rotation:{x:0,y:90,z:0}},...Q(0,2,0,9,"X","slab","#808080"),...Q(0,2,-1,9,"X","slab","#909090"),...Q(0,2,1,9,"X","slab","#909090"),{type:"slab",position:{x:1,y:2,z:0},color:"#707070"},{type:"slab",position:{x:3,y:2,z:0},color:"#707070"},{type:"slab",position:{x:5,y:2,z:0},color:"#707070"},{type:"slab",position:{x:7,y:2,z:0},color:"#707070"},{type:"baluster",position:{x:0,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:2,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:4,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:6,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:8,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:0,y:2,z:2},color:"#909090"},{type:"baluster",position:{x:2,y:2,z:2},color:"#909090"},{type:"baluster",position:{x:4,y:2,z:2},color:"#909090"},{type:"baluster",position:{x:6,y:2,z:2},color:"#909090"},{type:"baluster",position:{x:8,y:2,z:2},color:"#909090"},...Q(0,3,-2,9,"X","railing","#808080"),...Q(0,3,2,9,"X","railing","#808080"),{type:"cube",position:{x:0,y:2,z:-2},color:"#707070"},{type:"cube",position:{x:0,y:2,z:2},color:"#707070"},{type:"cube",position:{x:8,y:2,z:-2},color:"#707070"},{type:"cube",position:{x:8,y:2,z:2},color:"#707070"},{type:"finial",position:{x:0,y:3,z:-2},color:"#606060"},{type:"finial",position:{x:0,y:3,z:2},color:"#606060"},{type:"finial",position:{x:8,y:3,z:-2},color:"#606060"},{type:"finial",position:{x:8,y:3,z:2},color:"#606060"},{type:"pillar4",position:{x:0,y:3,z:0},color:"#2F2F2F"},{type:"sphere",position:{x:0,y:4,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFD700",intensity:2,radius:4}},{type:"pillar4",position:{x:8,y:3,z:0},color:"#2F2F2F"},{type:"sphere",position:{x:8,y:4,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFD700",intensity:2,radius:4}},{type:"pillar4",position:{x:4,y:3,z:0},color:"#2F2F2F"},{type:"sphere",position:{x:4,y:4,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFD700",intensity:2,radius:4}},{type:"wedge",position:{x:-1,y:1,z:0},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"wedge",position:{x:-1,y:1,z:-1},color:"#606060",rotation:{x:0,y:90,z:0}},{type:"wedge",position:{x:-1,y:1,z:1},color:"#606060",rotation:{x:0,y:90,z:0}},{type:"wedge",position:{x:9,y:1,z:0},color:"#505050",rotation:{x:0,y:-90,z:0}},{type:"wedge",position:{x:9,y:1,z:-1},color:"#606060",rotation:{x:0,y:-90,z:0}},{type:"wedge",position:{x:9,y:1,z:1},color:"#606060",rotation:{x:0,y:-90,z:0}},{type:"bush",position:{x:-1,y:0,z:-2},color:"#228B22"},{type:"bush",position:{x:9,y:0,z:2},color:"#2E8B2E"}]},streetCorner:{name:"Street Corner",category:"infrastructure",description:"Urban street corner with lamp",blocks:[...R(0,0,0,4,4,"#D3D3D3"),{type:"slab",position:{x:0,y:0,z:-1},color:"#2F2F2F"},{type:"slab",position:{x:1,y:0,z:-1},color:"#2F2F2F"},{type:"slab",position:{x:2,y:0,z:-1},color:"#2F2F2F"},{type:"slab",position:{x:3,y:0,z:-1},color:"#2F2F2F"},{type:"slab",position:{x:-1,y:0,z:0},color:"#2F2F2F"},{type:"slab",position:{x:-1,y:0,z:1},color:"#2F2F2F"},{type:"slab",position:{x:-1,y:0,z:2},color:"#2F2F2F"},{type:"slab",position:{x:-1,y:0,z:3},color:"#2F2F2F"},{type:"pillar2",position:{x:0,y:0,z:0},color:"#2F2F2F"},{type:"pillar2",position:{x:0,y:1,z:0},color:"#2F2F2F"},{type:"pillar2",position:{x:0,y:2,z:0},color:"#2F2F2F"},{type:"dome",position:{x:0,y:3,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:2,radius:6}},{type:"bench",position:{x:2,y:0,z:0},color:"#228B22"},{type:"planter",position:{x:3,y:0,z:0},color:"#8B4513"},{type:"bush",position:{x:3,y:1,z:0},color:"#228B22"},{type:"barrier",position:{x:0,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:1,y:0,z:3},color:"#FFD700"}]},plaza:{name:"Plaza",category:"infrastructure",description:"Grand public plaza with tiered fountain, outdoor seating, landscaping, and decorative lighting",blocks:[...R(0,0,0,12,12,"#B8B8B8"),...Q(0,0,0,12,"X","slab","#808080"),...Q(0,0,11,12,"X","slab","#808080"),{type:"slab",position:{x:0,y:0,z:1},color:"#808080"},{type:"slab",position:{x:0,y:0,z:2},color:"#808080"},{type:"slab",position:{x:0,y:0,z:3},color:"#808080"},{type:"slab",position:{x:0,y:0,z:4},color:"#808080"},{type:"slab",position:{x:0,y:0,z:5},color:"#808080"},{type:"slab",position:{x:0,y:0,z:6},color:"#808080"},{type:"slab",position:{x:0,y:0,z:7},color:"#808080"},{type:"slab",position:{x:0,y:0,z:8},color:"#808080"},{type:"slab",position:{x:0,y:0,z:9},color:"#808080"},{type:"slab",position:{x:0,y:0,z:10},color:"#808080"},{type:"slab",position:{x:11,y:0,z:1},color:"#808080"},{type:"slab",position:{x:11,y:0,z:2},color:"#808080"},{type:"slab",position:{x:11,y:0,z:3},color:"#808080"},{type:"slab",position:{x:11,y:0,z:4},color:"#808080"},{type:"slab",position:{x:11,y:0,z:5},color:"#808080"},{type:"slab",position:{x:11,y:0,z:6},color:"#808080"},{type:"slab",position:{x:11,y:0,z:7},color:"#808080"},{type:"slab",position:{x:11,y:0,z:8},color:"#808080"},{type:"slab",position:{x:11,y:0,z:9},color:"#808080"},{type:"slab",position:{x:11,y:0,z:10},color:"#808080"},{type:"slab",position:{x:4,y:0,z:4},color:"#606060"},{type:"slab",position:{x:5,y:0,z:4},color:"#606060"},{type:"slab",position:{x:6,y:0,z:4},color:"#606060"},{type:"slab",position:{x:7,y:0,z:4},color:"#606060"},{type:"slab",position:{x:4,y:0,z:7},color:"#606060"},{type:"slab",position:{x:5,y:0,z:7},color:"#606060"},{type:"slab",position:{x:6,y:0,z:7},color:"#606060"},{type:"slab",position:{x:7,y:0,z:7},color:"#606060"},{type:"slab",position:{x:4,y:0,z:5},color:"#606060"},{type:"slab",position:{x:4,y:0,z:6},color:"#606060"},{type:"slab",position:{x:7,y:0,z:5},color:"#606060"},{type:"slab",position:{x:7,y:0,z:6},color:"#606060"},{type:"quarter",position:{x:5,y:0,z:5},color:"#4169E1"},{type:"quarter",position:{x:6,y:0,z:5},color:"#4682B4"},{type:"quarter",position:{x:5,y:0,z:6},color:"#4682B4"},{type:"quarter",position:{x:6,y:0,z:6},color:"#4169E1"},{type:"cylinder",position:{x:5,y:0,z:5},color:"#A0A0A0"},{type:"cylinder",position:{x:5,y:1,z:5},color:"#909090"},{type:"bowl",position:{x:5,y:2,z:5},color:"#B0B0B0"},{type:"pillar2",position:{x:5,y:2,z:5},color:"#C0C0C0"},{type:"finial",position:{x:5,y:3,z:5},color:"#D4AF37"},{type:"base",position:{x:3,y:0,z:3},color:"#808080"},{type:"column",position:{x:3,y:1,z:3},color:"#D3D3D3"},{type:"capital",position:{x:3,y:2,z:3},color:"#D3D3D3"},{type:"base",position:{x:8,y:0,z:3},color:"#808080"},{type:"column",position:{x:8,y:1,z:3},color:"#D3D3D3"},{type:"capital",position:{x:8,y:2,z:3},color:"#D3D3D3"},{type:"base",position:{x:3,y:0,z:8},color:"#808080"},{type:"column",position:{x:3,y:1,z:8},color:"#D3D3D3"},{type:"capital",position:{x:3,y:2,z:8},color:"#D3D3D3"},{type:"base",position:{x:8,y:0,z:8},color:"#808080"},{type:"column",position:{x:8,y:1,z:8},color:"#D3D3D3"},{type:"capital",position:{x:8,y:2,z:8},color:"#D3D3D3"},{type:"bench",position:{x:3,y:0,z:1},color:"#8B4513",rotation:{x:0,y:180,z:0}},{type:"bench",position:{x:5,y:0,z:1},color:"#8B4513",rotation:{x:0,y:180,z:0}},{type:"bench",position:{x:7,y:0,z:1},color:"#8B4513",rotation:{x:0,y:180,z:0}},{type:"bench",position:{x:3,y:0,z:10},color:"#8B4513"},{type:"bench",position:{x:5,y:0,z:10},color:"#8B4513"},{type:"bench",position:{x:7,y:0,z:10},color:"#8B4513"},{type:"bench",position:{x:10,y:0,z:4},color:"#8B4513",rotation:{x:0,y:270,z:0}},{type:"bench",position:{x:10,y:0,z:6},color:"#8B4513",rotation:{x:0,y:270,z:0}},{type:"bench",position:{x:1,y:0,z:4},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"bench",position:{x:1,y:0,z:6},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"table",position:{x:9,y:0,z:9},color:"#8B4513"},{type:"chair",position:{x:9,y:0,z:8},color:"#8B4513",rotation:{x:0,y:180,z:0}},{type:"chair",position:{x:9,y:0,z:10},color:"#8B4513"},{type:"chair",position:{x:8,y:0,z:9},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"chair",position:{x:10,y:0,z:9},color:"#8B4513",rotation:{x:0,y:270,z:0}},{type:"umbrella",position:{x:9,y:1,z:9},color:"#DC143C"},{type:"planter",position:{x:1,y:0,z:1},color:"#696969"},{type:"planter",position:{x:2,y:0,z:1},color:"#696969"},{type:"planter",position:{x:1,y:0,z:2},color:"#696969"},{type:"logZ",position:{x:1,y:1,z:1},color:"#654321"},{type:"logZ",position:{x:1,y:2,z:1},color:"#654321"},{type:"bush",position:{x:1,y:3,z:1},color:"#228B22"},{type:"bush",position:{x:0,y:3,z:1},color:"#2E8B57"},{type:"bush",position:{x:1,y:3,z:0},color:"#2E8B57"},{type:"bush",position:{x:1,y:4,z:1},color:"#228B22"},{type:"planter",position:{x:9,y:0,z:1},color:"#696969"},{type:"planter",position:{x:10,y:0,z:1},color:"#696969"},{type:"planter",position:{x:10,y:0,z:2},color:"#696969"},{type:"logZ",position:{x:10,y:1,z:1},color:"#654321"},{type:"logZ",position:{x:10,y:2,z:1},color:"#654321"},{type:"bush",position:{x:10,y:3,z:1},color:"#228B22"},{type:"bush",position:{x:10,y:3,z:0},color:"#32CD32"},{type:"bush",position:{x:10,y:4,z:1},color:"#228B22"},{type:"planter",position:{x:2,y:0,z:5},color:"#696969"},{type:"flower",position:{x:2,y:1,z:5},color:"#FF6B6B"},{type:"planter",position:{x:2,y:0,z:6},color:"#696969"},{type:"flower",position:{x:2,y:1,z:6},color:"#FFD700"},{type:"planter",position:{x:9,y:0,z:5},color:"#696969"},{type:"flower",position:{x:9,y:1,z:5},color:"#DA70D6"},{type:"planter",position:{x:9,y:0,z:6},color:"#696969"},{type:"flower",position:{x:9,y:1,z:6},color:"#FF69B4"},{type:"pillar",position:{x:2,y:0,z:2},color:"#2F4F4F"},{type:"pillar",position:{x:2,y:1,z:2},color:"#2F4F4F"},{type:"pillar",position:{x:2,y:2,z:2},color:"#2F4F4F"},{type:"lightFixture",position:{x:2,y:3,z:2},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1.2,radius:4}},{type:"pillar",position:{x:9,y:0,z:2},color:"#2F4F4F"},{type:"pillar",position:{x:9,y:1,z:2},color:"#2F4F4F"},{type:"pillar",position:{x:9,y:2,z:2},color:"#2F4F4F"},{type:"lightFixture",position:{x:9,y:3,z:2},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1.2,radius:4}},{type:"pillar",position:{x:2,y:0,z:9},color:"#2F4F4F"},{type:"pillar",position:{x:2,y:1,z:9},color:"#2F4F4F"},{type:"pillar",position:{x:2,y:2,z:9},color:"#2F4F4F"},{type:"lightFixture",position:{x:2,y:3,z:9},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1.2,radius:4}},{type:"bin",position:{x:4,y:0,z:2},color:"#2F4F4F"},{type:"bin",position:{x:7,y:0,z:9},color:"#2F4F4F"},{type:"pediment",position:{x:1,y:0,z:9},color:"#808080"},{type:"pillar2",position:{x:1,y:1,z:9},color:"#A0A0A0"},{type:"sphere",position:{x:1,y:2,z:9},color:"#B87333"},{type:"grate",position:{x:3,y:0,z:5},color:"#404040"},{type:"grate",position:{x:8,y:0,z:6},color:"#404040"}]},stairway:{name:"Grand Stairway",category:"infrastructure",description:"Elegant staircase with balusters",blocks:[{type:"stairs",position:{x:1,y:0,z:0},color:"#D3D3D3"},{type:"stairs",position:{x:1,y:1,z:1},color:"#D3D3D3"},{type:"stairs",position:{x:1,y:2,z:2},color:"#D3D3D3"},{type:"stairs",position:{x:1,y:3,z:3},color:"#D3D3D3"},{type:"baluster",position:{x:0,y:0,z:0},color:"#F5F5DC"},{type:"baluster",position:{x:0,y:1,z:1},color:"#F5F5DC"},{type:"baluster",position:{x:0,y:2,z:2},color:"#F5F5DC"},{type:"baluster",position:{x:0,y:3,z:3},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:0,z:0},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:1,z:1},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:2,z:2},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:3,z:3},color:"#F5F5DC"},{type:"railing",position:{x:0,y:1,z:0},color:"#DAA520"},{type:"railing",position:{x:0,y:2,z:1},color:"#DAA520"},{type:"railing",position:{x:0,y:3,z:2},color:"#DAA520"},{type:"railing",position:{x:0,y:4,z:3},color:"#DAA520"},{type:"railing",position:{x:2,y:1,z:0},color:"#DAA520"},{type:"railing",position:{x:2,y:2,z:1},color:"#DAA520"},{type:"railing",position:{x:2,y:3,z:2},color:"#DAA520"},{type:"railing",position:{x:2,y:4,z:3},color:"#DAA520"},{type:"capital",position:{x:0,y:1,z:0},color:"#F5F5DC"},{type:"capital",position:{x:2,y:1,z:0},color:"#F5F5DC"},{type:"slab",position:{x:0,y:4,z:4},color:"#D3D3D3"},{type:"slab",position:{x:1,y:4,z:4},color:"#D3D3D3"},{type:"slab",position:{x:2,y:4,z:4},color:"#D3D3D3"}]},cityBlock:{name:"City Block",category:"city",description:"Detailed urban block with shops, apartments, offices, street furniture, and traffic elements",blocks:[...R(-2,0,-2,16,2,"#2F2F2F"),...R(-2,0,12,16,2,"#2F2F2F"),...R(-2,0,0,2,12,"#2F2F2F"),...R(12,0,0,2,12,"#2F2F2F"),{type:"slab",position:{x:3,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:5,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:7,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:9,y:0,z:-1},color:"#FFFFFF"},...R(0,0,0,12,12,"#B0B0B0"),{type:"slab",position:{x:0,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:1,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:11,y:0,z:-1},color:"#FFFFFF"},...R(0,0,0,4,5,"#404040"),...vt(0,1,0,4,5,"#303030","#4169E1"),...vt(0,2,0,4,5,"#303030","#4682B4"),...vt(0,3,0,4,5,"#303030","#4169E1"),...vt(0,4,0,4,5,"#303030","#4682B4"),...vt(0,5,0,4,5,"#303030","#4169E1"),...vt(0,6,0,4,5,"#303030","#4682B4"),...R(0,7,0,4,5,"#353535"),{type:"acUnit",position:{x:1,y:7,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:2,y:7,z:2},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:7,z:3},color:"#808080"},{type:"doorFrame",position:{x:1,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:2,y:1,z:0},color:"#4682B4"},{type:"awning",position:{x:1,y:2,z:-1},color:"#2F2F2F"},{type:"awning",position:{x:2,y:2,z:-1},color:"#2F2F2F"},...R(5,0,0,4,4,"#696969"),...ht(5,1,0,4,4,"#DEB887"),...ht(5,2,0,4,4,"#F5DEB3"),...R(5,3,0,4,4,"#8B4513"),{type:"doorFrame",position:{x:6,y:1,z:0},color:"#654321"},{type:"awning",position:{x:5,y:2,z:-1},color:"#DC143C"},{type:"awning",position:{x:6,y:2,z:-1},color:"#DC143C"},{type:"awning",position:{x:7,y:2,z:-1},color:"#DC143C"},{type:"windowFrame",position:{x:5,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:0},color:"#4682B4"},{type:"sign",position:{x:6,y:2,z:0},color:"#FFD700"},{type:"table",position:{x:5,y:0,z:-1},color:"#8B4513"},{type:"chair",position:{x:5,y:0,z:-2},color:"#8B4513"},...R(9,0,0,3,5,"#505050"),...ht(9,1,0,3,5,"#CD853F"),...ht(9,2,0,3,5,"#CD853F"),...ht(9,3,0,3,5,"#D2B48C"),...ht(9,4,0,3,5,"#D2B48C"),...ht(9,5,0,3,5,"#CD853F"),...R(9,6,0,3,5,"#8B0000"),{type:"windowFrame",position:{x:10,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:10,y:2,z:0},color:"#87CEEB"},{type:"windowFrame",position:{x:10,y:3,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:10,y:4,z:0},color:"#87CEEB"},{type:"windowFrame",position:{x:10,y:5,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:9,y:1,z:0},color:"#654321"},{type:"step",position:{x:9,y:0,z:-1},color:"#808080"},{type:"slab",position:{x:10,y:3,z:-1},color:"#808080"},{type:"railing",position:{x:10,y:4,z:-1},color:"#404040"},{type:"slab",position:{x:10,y:5,z:-1},color:"#808080"},{type:"railing",position:{x:10,y:6,z:-1},color:"#404040"},...R(0,0,7,7,5,"#606060"),...at(0,1,7,7,3,"#808080"),...at(0,1,11,7,3,"#808080"),...st(0,1,8,3,3,"#808080"),...st(6,1,8,3,3,"#808080"),...R(0,4,7,7,5,"#505050"),{type:"doorFrame",position:{x:2,y:1,z:7},color:"#4A4A4A"},{type:"doorFrame",position:{x:3,y:1,z:7},color:"#4A4A4A"},{type:"doorFrame",position:{x:2,y:2,z:7},color:"#4A4A4A"},{type:"doorFrame",position:{x:3,y:2,z:7},color:"#4A4A4A"},{type:"barrel",position:{x:5,y:1,z:9},color:"#2F4F4F"},{type:"barrel",position:{x:5,y:1,z:10},color:"#006400"},...R(8,0,6,4,6,"#3A3A3A"),{type:"slab",position:{x:8,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:8,y:0,z:9},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:9},color:"#FFFFFF"},{type:"barrier",position:{x:8,y:0,z:6},color:"#FFD700"},{type:"barrier",position:{x:11,y:0,z:6},color:"#FFD700"},{type:"pillar",position:{x:-1,y:0,z:3},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:1,z:3},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:2,z:3},color:"#2F2F2F"},{type:"lightFixture",position:{x:-1,y:3,z:3},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:1.5,radius:5}},{type:"pillar",position:{x:-1,y:0,z:8},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:1,z:8},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:2,z:8},color:"#2F2F2F"},{type:"lightFixture",position:{x:-1,y:3,z:8},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:1.5,radius:5}},{type:"pillar",position:{x:12,y:0,z:5},color:"#2F2F2F"},{type:"pillar",position:{x:12,y:1,z:5},color:"#2F2F2F"},{type:"pillar",position:{x:12,y:2,z:5},color:"#2F2F2F"},{type:"lightFixture",position:{x:12,y:3,z:5},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:1.5,radius:5}},{type:"bollard",position:{x:4,y:0,z:-1},color:"#FF0000"},{type:"bin",position:{x:0,y:0,z:-1},color:"#2F4F4F"},{type:"bin",position:{x:8,y:0,z:-1},color:"#2F4F4F"},{type:"bench",position:{x:4,y:0,z:5},color:"#8B4513"},{type:"pillar",position:{x:-1,y:0,z:-1},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:1,z:-1},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:2,z:-1},color:"#2F2F2F"},{type:"bulb",position:{x:-1,y:3,z:-1},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:1,radius:2}},{type:"pillar",position:{x:12,y:0,z:10},color:"#4169E1"},{type:"pillar",position:{x:12,y:1,z:10},color:"#4169E1"},{type:"sign",position:{x:12,y:2,z:10},color:"#FFD700"},{type:"bench",position:{x:11,y:0,z:10},color:"#808080",rotation:{x:0,y:90,z:0}},{type:"planter",position:{x:4,y:0,z:4},color:"#505050"},{type:"logZ",position:{x:4,y:1,z:4},color:"#654321"},{type:"bush",position:{x:4,y:2,z:4},color:"#228B22"},{type:"bush",position:{x:4,y:3,z:4},color:"#2E8B57"},{type:"planter",position:{x:7,y:0,z:5},color:"#505050"},{type:"logZ",position:{x:7,y:1,z:5},color:"#654321"},{type:"bush",position:{x:7,y:2,z:5},color:"#228B22"},{type:"bush",position:{x:7,y:3,z:5},color:"#32CD32"}]},skyscraper:{name:"Skyscraper",category:"city",description:"Modern glass tower with helipad, observation deck, and detailed infrastructure",blocks:[...R(-1,0,-1,8,8,"#2F2F2F"),{type:"planter",position:{x:-1,y:0,z:2},color:"#505050"},{type:"bush",position:{x:-1,y:1,z:2},color:"#228B22"},{type:"planter",position:{x:-1,y:0,z:4},color:"#505050"},{type:"bush",position:{x:-1,y:1,z:4},color:"#228B22"},{type:"bench",position:{x:6,y:0,z:2},color:"#808080"},...vt(0,1,0,6,6,"#303030","#4169E1"),...vt(0,2,0,6,6,"#303030","#4682B4"),...vt(0,3,0,6,6,"#303030","#4169E1"),...vt(0,4,0,6,6,"#303030","#4682B4"),...vt(0,5,0,6,6,"#303030","#4169E1"),...ht(0,6,0,6,6,"#252525"),...vt(0,7,0,6,6,"#303030","#4682B4"),...vt(0,8,0,6,6,"#303030","#4169E1"),...vt(0,9,0,6,6,"#303030","#4682B4"),...vt(0,10,0,6,6,"#303030","#4169E1"),...vt(1,11,1,4,4,"#404040","#4169E1"),...vt(1,12,1,4,4,"#404040","#4682B4"),...R(1,13,1,4,4,"#252525"),{type:"railing",position:{x:1,y:13,z:0},color:"#C0C0C0"},{type:"railing",position:{x:2,y:13,z:0},color:"#C0C0C0"},{type:"railing",position:{x:3,y:13,z:0},color:"#C0C0C0"},{type:"railing",position:{x:4,y:13,z:0},color:"#C0C0C0"},{type:"railing",position:{x:0,y:13,z:1},color:"#C0C0C0"},{type:"railing",position:{x:0,y:13,z:2},color:"#C0C0C0"},{type:"railing",position:{x:0,y:13,z:3},color:"#C0C0C0"},{type:"railing",position:{x:0,y:13,z:4},color:"#C0C0C0"},...R(1,14,1,4,4,"#404040"),{type:"slab",position:{x:2,y:14,z:2},color:"#FFFF00"},{type:"slab",position:{x:3,y:14,z:2},color:"#FFFF00"},{type:"slab",position:{x:2,y:14,z:3},color:"#FFFF00"},{type:"slab",position:{x:3,y:14,z:3},color:"#FFFF00"},{type:"sphere",position:{x:1,y:14,z:1},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:2}},{type:"sphere",position:{x:4,y:14,z:1},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:2}},{type:"sphere",position:{x:1,y:14,z:4},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:2}},{type:"sphere",position:{x:4,y:14,z:4},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:2}},{type:"pillar2",position:{x:2,y:15,z:2},color:"#C0C0C0"},{type:"pillar2",position:{x:2,y:16,z:2},color:"#C0C0C0"},{type:"pillar4",position:{x:2,y:17,z:2},color:"#C0C0C0"},{type:"pillar4",position:{x:2,y:18,z:2},color:"#C0C0C0"},{type:"antenna",position:{x:2,y:19,z:2},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:3,radius:5}},{type:"acUnit",position:{x:5,y:11,z:1},color:"#808080"},{type:"acUnit",position:{x:5,y:11,z:3},color:"#808080"},{type:"acUnit",position:{x:5,y:11,z:5},color:"#808080"},{type:"vent",position:{x:0,y:11,z:2},color:"#606060"},{type:"vent",position:{x:0,y:11,z:4},color:"#606060"},{type:"dome",position:{x:0,y:11,z:0},color:"#E0E0E0"},{type:"doorFrame",position:{x:2,y:1,z:0},color:"#B8860B"},{type:"doorFrame",position:{x:3,y:1,z:0},color:"#B8860B"},{type:"slab",position:{x:1,y:2,z:-1},color:"#303030"},{type:"slab",position:{x:2,y:2,z:-1},color:"#303030"},{type:"slab",position:{x:3,y:2,z:-1},color:"#303030"},{type:"slab",position:{x:4,y:2,z:-1},color:"#303030"},{type:"column",position:{x:1,y:1,z:0},color:"#D4AF37"},{type:"column",position:{x:4,y:1,z:0},color:"#D4AF37"},{type:"capital",position:{x:1,y:2,z:0},color:"#D4AF37"},{type:"capital",position:{x:4,y:2,z:0},color:"#D4AF37"},{type:"spotlight",position:{x:0,y:0,z:-1},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:2,radius:3}},{type:"spotlight",position:{x:5,y:0,z:-1},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:2,radius:3}},{type:"beam4X",position:{x:0,y:10,z:-1},color:"#404040"},{type:"beam4X",position:{x:2,y:10,z:-1},color:"#404040"},{type:"beam4X",position:{x:4,y:10,z:-1},color:"#404040"}]},apartmentBuilding:{name:"Apartment Building",category:"city",description:"Residential apartment with balconies, fire escape, rooftop amenities, and urban details",blocks:[...R(-1,0,-2,10,8,"#707070"),...R(0,0,0,8,5,"#505050"),...ht(0,1,0,8,5,"#8B4513"),...ht(0,2,0,8,5,"#DEB887"),...ht(0,3,0,8,5,"#DEB887"),...ht(0,4,0,8,5,"#DEB887"),...ht(0,5,0,8,5,"#E8D8B8"),...ht(0,6,0,8,5,"#E8D8B8"),...ht(0,7,0,8,5,"#E8D8B8"),...R(0,8,0,8,5,"#404040"),...Q(0,8,0,8,"X","ledge","#505050"),...Q(0,8,4,8,"X","ledge","#505050"),{type:"ledge",position:{x:0,y:8,z:1},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"ledge",position:{x:0,y:8,z:2},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"ledge",position:{x:0,y:8,z:3},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"ledge",position:{x:7,y:8,z:1},color:"#505050",rotation:{x:0,y:270,z:0}},{type:"ledge",position:{x:7,y:8,z:2},color:"#505050",rotation:{x:0,y:270,z:0}},{type:"ledge",position:{x:7,y:8,z:3},color:"#505050",rotation:{x:0,y:270,z:0}},{type:"tank",position:{x:1,y:8,z:2},color:"#2F4F4F"},{type:"tank",position:{x:1,y:9,z:2},color:"#2F4F4F"},{type:"acUnit",position:{x:5,y:8,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:6,y:8,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:5,y:8,z:3},color:"#C0C0C0"},{type:"antenna",position:{x:3,y:8,z:2},color:"#808080"},{type:"cube",position:{x:4,y:8,z:2},color:"#606060"},{type:"slab",position:{x:4,y:9,z:2},color:"#505050"},{type:"doorFrame",position:{x:4,y:8,z:1},color:"#404040"},{type:"slab",position:{x:1,y:2,z:-1},color:"#808080"},{type:"slab",position:{x:2,y:2,z:-1},color:"#808080"},{type:"railing",position:{x:1,y:3,z:-1},color:"#303030"},{type:"railing",position:{x:2,y:3,z:-1},color:"#303030"},{type:"planter",position:{x:1,y:2,z:-1},color:"#8B4513"},{type:"flower",position:{x:1,y:3,z:-1},color:"#FF6B6B"},{type:"slab",position:{x:5,y:2,z:-1},color:"#808080"},{type:"slab",position:{x:6,y:2,z:-1},color:"#808080"},{type:"railing",position:{x:5,y:3,z:-1},color:"#303030"},{type:"railing",position:{x:6,y:3,z:-1},color:"#303030"},{type:"chair",position:{x:6,y:2,z:-1},color:"#8B4513"},{type:"slab",position:{x:1,y:4,z:-1},color:"#808080"},{type:"slab",position:{x:2,y:4,z:-1},color:"#808080"},{type:"railing",position:{x:1,y:5,z:-1},color:"#303030"},{type:"railing",position:{x:2,y:5,z:-1},color:"#303030"},{type:"slab",position:{x:5,y:4,z:-1},color:"#808080"},{type:"slab",position:{x:6,y:4,z:-1},color:"#808080"},{type:"railing",position:{x:5,y:5,z:-1},color:"#303030"},{type:"railing",position:{x:6,y:5,z:-1},color:"#303030"},{type:"planter",position:{x:5,y:4,z:-1},color:"#8B4513"},{type:"bush",position:{x:5,y:5,z:-1},color:"#228B22"},{type:"slab",position:{x:1,y:6,z:-1},color:"#808080"},{type:"slab",position:{x:2,y:6,z:-1},color:"#808080"},{type:"railing",position:{x:1,y:7,z:-1},color:"#303030"},{type:"railing",position:{x:2,y:7,z:-1},color:"#303030"},{type:"slab",position:{x:5,y:6,z:-1},color:"#808080"},{type:"slab",position:{x:6,y:6,z:-1},color:"#808080"},{type:"railing",position:{x:5,y:7,z:-1},color:"#303030"},{type:"railing",position:{x:6,y:7,z:-1},color:"#303030"},{type:"planter",position:{x:6,y:6,z:-1},color:"#8B4513"},{type:"flower",position:{x:6,y:7,z:-1},color:"#FFD700"},{type:"grateFloor",position:{x:8,y:2,z:1},color:"#303030"},{type:"grateFloor",position:{x:8,y:2,z:2},color:"#303030"},{type:"railing",position:{x:8,y:3,z:1},color:"#404040"},{type:"stairs",position:{x:8,y:3,z:2},color:"#303030",rotation:{x:0,y:90,z:0}},{type:"grateFloor",position:{x:8,y:4,z:1},color:"#303030"},{type:"grateFloor",position:{x:8,y:4,z:2},color:"#303030"},{type:"railing",position:{x:8,y:5,z:1},color:"#404040"},{type:"stairs",position:{x:8,y:5,z:2},color:"#303030",rotation:{x:0,y:270,z:0}},{type:"grateFloor",position:{x:8,y:6,z:1},color:"#303030"},{type:"grateFloor",position:{x:8,y:6,z:2},color:"#303030"},{type:"railing",position:{x:8,y:7,z:1},color:"#404040"},{type:"ladder",position:{x:8,y:0,z:1},color:"#404040"},{type:"ladder",position:{x:8,y:1,z:1},color:"#404040"},{type:"windowFrame",position:{x:1,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:2,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:5,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:5,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:4,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:4,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:5,y:4,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:6,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:6,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:5,y:6,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:3,y:1,z:0},color:"#654321"},{type:"doorFrame",position:{x:4,y:1,z:0},color:"#654321"},{type:"awning",position:{x:3,y:2,z:-1},color:"#8B0000"},{type:"awning",position:{x:4,y:2,z:-1},color:"#8B0000"},{type:"step",position:{x:3,y:0,z:-1},color:"#606060"},{type:"step",position:{x:4,y:0,z:-1},color:"#606060"},{type:"locker",position:{x:0,y:1,z:-1},color:"#C0C0C0"},{type:"pillar",position:{x:-1,y:0,z:-1},color:"#404040"},{type:"pillar",position:{x:-1,y:1,z:-1},color:"#404040"},{type:"pillar",position:{x:-1,y:2,z:-1},color:"#404040"},{type:"lightFixture",position:{x:-1,y:3,z:-1},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1.2,radius:4}},{type:"bin",position:{x:7,y:0,z:-1},color:"#2F4F4F"},{type:"bollard",position:{x:8,y:0,z:-1},color:"#FF0000"},{type:"railing",position:{x:6,y:0,z:-1},color:"#808080"},{type:"powerBox",position:{x:0,y:1,z:1},color:"#808080"},{type:"cableY",position:{x:7,y:3,z:4},color:"#FFFFFF"},{type:"cableY",position:{x:7,y:4,z:4},color:"#FFFFFF"},{type:"cableY",position:{x:7,y:5,z:4},color:"#FFFFFF"},{type:"cableY",position:{x:7,y:6,z:4},color:"#FFFFFF"},{type:"cableY",position:{x:7,y:7,z:4},color:"#FFFFFF"},{type:"cornice",position:{x:0,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:1,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:2,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:5,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:6,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:7,y:2,z:0},color:"#D3D3D3"}]},shoppingMall:{name:"Shopping Mall",category:"city",description:"Two-story shopping center with stores, food court, escalators, and glass atrium",blocks:[...R(0,0,0,18,14,"#D8D8D8"),...R(7,0,0,4,14,"#E8E8E8"),...at(0,1,0,18,6,"#E0E0E0"),...at(0,1,13,18,6,"#E0E0E0"),...st(0,1,1,12,6,"#E0E0E0"),...st(17,1,1,12,6,"#E0E0E0"),{type:"doorFrame",position:{x:7,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:8,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:9,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:10,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:7,y:2,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:8,y:2,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:9,y:2,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:10,y:2,z:0},color:"#4682B4"},{type:"awning",position:{x:7,y:3,z:-1},color:"#E0E0E0"},{type:"awning",position:{x:8,y:3,z:-1},color:"#E0E0E0"},{type:"awning",position:{x:9,y:3,z:-1},color:"#E0E0E0"},{type:"awning",position:{x:10,y:3,z:-1},color:"#E0E0E0"},...st(1,1,1,3,3,"#F5F5DC"),...st(5,1,1,3,3,"#F5F5DC"),{type:"windowFrame",position:{x:2,y:1,z:1},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:1,z:1},color:"#4682B4"},{type:"windowFrame",position:{x:4,y:1,z:1},color:"#4682B4"},{type:"sign",position:{x:3,y:3,z:1},color:"#FF69B4"},{type:"shelf",position:{x:2,y:1,z:2},color:"#D2B48C"},{type:"shelf",position:{x:3,y:1,z:2},color:"#D2B48C"},{type:"shelf",position:{x:4,y:1,z:2},color:"#D2B48C"},...st(1,1,4,3,3,"#1E1E1E"),...st(5,1,4,3,3,"#1E1E1E"),{type:"windowFrame",position:{x:2,y:1,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:1,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:4,y:1,z:4},color:"#4682B4"},{type:"sign",position:{x:3,y:3,z:4},color:"#00BFFF"},{type:"monitor",position:{x:2,y:1,z:5},color:"#1E1E1E"},{type:"monitor",position:{x:4,y:1,z:5},color:"#1E1E1E"},{type:"table",position:{x:3,y:1,z:6},color:"#2F2F2F"},...st(12,1,1,3,3,"#8B4513"),...st(16,1,1,3,3,"#8B4513"),{type:"windowFrame",position:{x:13,y:1,z:1},color:"#4682B4"},{type:"windowFrame",position:{x:14,y:1,z:1},color:"#4682B4"},{type:"windowFrame",position:{x:15,y:1,z:1},color:"#4682B4"},{type:"sign",position:{x:14,y:3,z:1},color:"#228B22"},{type:"shelfUnit",position:{x:13,y:1,z:2},color:"#8B4513"},{type:"shelfUnit",position:{x:14,y:1,z:2},color:"#8B4513"},{type:"shelfUnit",position:{x:15,y:1,z:2},color:"#8B4513"},...st(12,1,4,3,3,"#FF4500"),...st(16,1,4,3,3,"#FF4500"),{type:"windowFrame",position:{x:13,y:1,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:14,y:1,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:15,y:1,z:4},color:"#4682B4"},{type:"sign",position:{x:14,y:3,z:4},color:"#FF4500"},{type:"shelf",position:{x:13,y:1,z:5},color:"#E0E0E0"},{type:"shelf",position:{x:15,y:1,z:5},color:"#E0E0E0"},{type:"cylinder",position:{x:8,y:0,z:3},color:"#708090"},{type:"cylinder",position:{x:9,y:0,z:3},color:"#708090"},{type:"cylinder",position:{x:8,y:0,z:4},color:"#708090"},{type:"cylinder",position:{x:9,y:0,z:4},color:"#708090"},{type:"slab",position:{x:8,y:0,z:3},color:"#87CEEB"},{type:"slab",position:{x:9,y:0,z:3},color:"#87CEEB"},{type:"slab",position:{x:8,y:0,z:4},color:"#87CEEB"},{type:"slab",position:{x:9,y:0,z:4},color:"#87CEEB"},{type:"pillar",position:{x:8,y:1,z:3},color:"#708090"},{type:"dome",position:{x:8,y:2,z:3},color:"#87CEEB"},{type:"stairs",position:{x:7,y:1,z:6},color:"#808080"},{type:"stairs",position:{x:7,y:2,z:7},color:"#808080"},{type:"stairs",position:{x:7,y:3,z:8},color:"#808080"},{type:"railing",position:{x:6,y:1,z:6},color:"#C0C0C0"},{type:"railing",position:{x:6,y:2,z:7},color:"#C0C0C0"},{type:"railing",position:{x:6,y:3,z:8},color:"#C0C0C0"},{type:"stairs",position:{x:10,y:1,z:8},color:"#808080",rotation:{x:0,y:180,z:0}},{type:"stairs",position:{x:10,y:2,z:7},color:"#808080",rotation:{x:0,y:180,z:0}},{type:"stairs",position:{x:10,y:3,z:6},color:"#808080",rotation:{x:0,y:180,z:0}},{type:"railing",position:{x:11,y:1,z:8},color:"#C0C0C0"},{type:"railing",position:{x:11,y:2,z:7},color:"#C0C0C0"},{type:"railing",position:{x:11,y:3,z:6},color:"#C0C0C0"},...R(0,4,0,6,6,"#D8D8D8"),...R(12,4,0,6,6,"#D8D8D8"),...R(0,4,8,18,6,"#D8D8D8"),...Q(6,4,0,6,"Z","railing","#C0C0C0"),...Q(11,4,0,6,"Z","railing","#C0C0C0"),...Q(0,4,8,6,"X","railing","#C0C0C0"),...Q(12,4,8,6,"X","railing","#C0C0C0"),...R(0,0,8,18,5,"#C0A080"),{type:"table",position:{x:2,y:1,z:10},color:"#FFFFFF"},{type:"chair",position:{x:1,y:1,z:10},color:"#FF6347"},{type:"chair",position:{x:3,y:1,z:10},color:"#FF6347"},{type:"table",position:{x:5,y:1,z:10},color:"#FFFFFF"},{type:"chair",position:{x:4,y:1,z:10},color:"#4169E1"},{type:"chair",position:{x:6,y:1,z:10},color:"#4169E1"},{type:"table",position:{x:12,y:1,z:10},color:"#FFFFFF"},{type:"chair",position:{x:11,y:1,z:10},color:"#32CD32"},{type:"chair",position:{x:13,y:1,z:10},color:"#32CD32"},{type:"table",position:{x:15,y:1,z:10},color:"#FFFFFF"},{type:"chair",position:{x:14,y:1,z:10},color:"#FFD700"},{type:"chair",position:{x:16,y:1,z:10},color:"#FFD700"},...Q(1,1,12,6,"X","slab","#808080"),...Q(11,1,12,6,"X","slab","#808080"),{type:"sign",position:{x:2,y:2,z:13},color:"#FF0000"},{type:"sign",position:{x:5,y:2,z:13},color:"#FFD700"},{type:"sign",position:{x:12,y:2,z:13},color:"#228B22"},{type:"sign",position:{x:15,y:2,z:13},color:"#FF69B4"},{type:"pillar",position:{x:8,y:1,z:1},color:"#404040"},{type:"monitor",position:{x:8,y:2,z:1},color:"#1E1E1E",emissive:{enabled:!0,color:"#4169E1",intensity:.5,radius:2}},{type:"column",position:{x:4,y:1,z:3},color:"#C0C0C0"},{type:"column",position:{x:4,y:2,z:3},color:"#C0C0C0"},{type:"column",position:{x:4,y:3,z:3},color:"#C0C0C0"},{type:"column",position:{x:13,y:1,z:3},color:"#C0C0C0"},{type:"column",position:{x:13,y:2,z:3},color:"#C0C0C0"},{type:"column",position:{x:13,y:3,z:3},color:"#C0C0C0"},{type:"column",position:{x:4,y:1,z:10},color:"#C0C0C0"},{type:"column",position:{x:4,y:2,z:10},color:"#C0C0C0"},{type:"column",position:{x:4,y:3,z:10},color:"#C0C0C0"},{type:"column",position:{x:13,y:1,z:10},color:"#C0C0C0"},{type:"column",position:{x:13,y:2,z:10},color:"#C0C0C0"},{type:"column",position:{x:13,y:3,z:10},color:"#C0C0C0"},...R(6,7,1,6,12,"#87CEEB"),...Q(6,7,0,6,"X","iBeam","#404040"),...Q(6,7,13,6,"X","iBeam","#404040"),...Q(6,7,0,14,"Z","iBeam","#404040"),...Q(11,7,0,14,"Z","iBeam","#404040"),...R(0,7,0,6,14,"#A0A0A0"),...R(12,7,0,6,14,"#A0A0A0"),{type:"planter",position:{x:3,y:0,z:3},color:"#8B4513"},{type:"bush",position:{x:3,y:1,z:3},color:"#228B22"},{type:"planter",position:{x:14,y:0,z:3},color:"#8B4513"},{type:"bush",position:{x:14,y:1,z:3},color:"#228B22"},{type:"bench",position:{x:5,y:0,z:5},color:"#A0522D"},{type:"bench",position:{x:12,y:0,z:5},color:"#A0522D"},{type:"bin",position:{x:6,y:0,z:1},color:"#2F2F2F"},{type:"bin",position:{x:11,y:0,z:1},color:"#2F2F2F"},{type:"bin",position:{x:8,y:0,z:9},color:"#2F2F2F"},{type:"pillar4",position:{x:4,y:4,z:3},color:"#C0C0C0"},{type:"pillar4",position:{x:4,y:5,z:3},color:"#C0C0C0"},{type:"lightFixture",position:{x:4,y:6,z:3},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:13,y:4,z:3},color:"#C0C0C0"},{type:"pillar4",position:{x:13,y:5,z:3},color:"#C0C0C0"},{type:"lightFixture",position:{x:13,y:6,z:3},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:4,y:4,z:10},color:"#C0C0C0"},{type:"pillar4",position:{x:4,y:5,z:10},color:"#C0C0C0"},{type:"lightFixture",position:{x:4,y:6,z:10},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:13,y:4,z:10},color:"#C0C0C0"},{type:"pillar4",position:{x:13,y:5,z:10},color:"#C0C0C0"},{type:"lightFixture",position:{x:13,y:6,z:10},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}}]},trainStation:{name:"Train Station",category:"city",description:"Grand railway station with platforms, canopy, clock tower, ticket hall, and period details",blocks:[...R(0,-1,3,18,4,"#4A4A4A"),...Q(0,0,3,18,"X","beamX","#505050"),...Q(0,0,4,18,"X","beamX","#505050"),...Q(0,0,5,18,"X","beamX","#505050"),...Q(0,0,6,18,"X","beamX","#505050"),{type:"beam2Z",position:{x:1,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:3,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:5,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:7,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:9,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:11,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:13,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:15,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:1,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:3,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:5,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:7,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:9,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:11,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:13,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:15,y:0,z:5},color:"#654321"},...R(0,0,0,18,3,"#A0A0A0"),...Q(0,0,2,18,"X","ledge","#FFD700"),{type:"grate",position:{x:8,y:0,z:1},color:"#606060"},{type:"grate",position:{x:9,y:0,z:1},color:"#606060"},...R(0,0,7,18,3,"#A0A0A0"),...Q(0,0,7,18,"X","ledge","#FFD700"),{type:"column",position:{x:2,y:0,z:1},color:"#2F4F4F"},{type:"column",position:{x:2,y:1,z:1},color:"#2F4F4F"},{type:"column",position:{x:2,y:2,z:1},color:"#2F4F4F"},{type:"capital",position:{x:2,y:3,z:1},color:"#3A5A5A"},{type:"column",position:{x:7,y:0,z:1},color:"#2F4F4F"},{type:"column",position:{x:7,y:1,z:1},color:"#2F4F4F"},{type:"column",position:{x:7,y:2,z:1},color:"#2F4F4F"},{type:"capital",position:{x:7,y:3,z:1},color:"#3A5A5A"},{type:"column",position:{x:12,y:0,z:1},color:"#2F4F4F"},{type:"column",position:{x:12,y:1,z:1},color:"#2F4F4F"},{type:"column",position:{x:12,y:2,z:1},color:"#2F4F4F"},{type:"capital",position:{x:12,y:3,z:1},color:"#3A5A5A"},{type:"column",position:{x:2,y:0,z:8},color:"#2F4F4F"},{type:"column",position:{x:2,y:1,z:8},color:"#2F4F4F"},{type:"column",position:{x:2,y:2,z:8},color:"#2F4F4F"},{type:"capital",position:{x:2,y:3,z:8},color:"#3A5A5A"},{type:"column",position:{x:7,y:0,z:8},color:"#2F4F4F"},{type:"column",position:{x:7,y:1,z:8},color:"#2F4F4F"},{type:"column",position:{x:7,y:2,z:8},color:"#2F4F4F"},{type:"capital",position:{x:7,y:3,z:8},color:"#3A5A5A"},{type:"column",position:{x:12,y:0,z:8},color:"#2F4F4F"},{type:"column",position:{x:12,y:1,z:8},color:"#2F4F4F"},{type:"column",position:{x:12,y:2,z:8},color:"#2F4F4F"},{type:"capital",position:{x:12,y:3,z:8},color:"#3A5A5A"},...R(1,4,0,16,10,"#2F4F4F"),{type:"archWide",position:{x:2,y:4,z:4},color:"#3A5A5A",rotation:{x:0,y:90,z:0}},{type:"archWide",position:{x:7,y:4,z:4},color:"#3A5A5A",rotation:{x:0,y:90,z:0}},{type:"archWide",position:{x:12,y:4,z:4},color:"#3A5A5A",rotation:{x:0,y:90,z:0}},{type:"truss",position:{x:3,y:3,z:4},color:"#2F4F4F"},{type:"truss",position:{x:8,y:3,z:4},color:"#2F4F4F"},{type:"truss",position:{x:13,y:3,z:4},color:"#2F4F4F"},...R(0,0,10,8,5,"#606060"),...ht(0,1,10,8,5,"#DEB887"),...ht(0,2,10,8,5,"#DEB887"),...ht(0,3,10,8,5,"#C9B896"),...R(0,4,10,8,5,"#8B4513"),{type:"wedge",position:{x:2,y:4,z:11},color:"#704214"},{type:"wedge",position:{x:3,y:4,z:11},color:"#704214"},{type:"wedge",position:{x:4,y:4,z:11},color:"#704214"},{type:"wedge",position:{x:5,y:4,z:11},color:"#704214"},{type:"wedge",position:{x:2,y:4,z:13},color:"#704214",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:3,y:4,z:13},color:"#704214",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:4,y:4,z:13},color:"#704214",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:5,y:4,z:13},color:"#704214",rotation:{x:0,y:180,z:0}},{type:"doorFrame",position:{x:3,y:1,z:10},color:"#654321"},{type:"doorFrame",position:{x:4,y:1,z:10},color:"#654321"},{type:"arch",position:{x:3,y:2,z:10},color:"#DEB887"},{type:"arch",position:{x:4,y:2,z:10},color:"#DEB887"},{type:"windowFrame",position:{x:1,y:2,z:10},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:2,z:10},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:3,z:10},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:3,z:10},color:"#4682B4"},{type:"cube",position:{x:3,y:4,z:12},color:"#8B4513"},{type:"cube",position:{x:4,y:4,z:12},color:"#8B4513"},{type:"cube",position:{x:3,y:5,z:12},color:"#704214"},{type:"cube",position:{x:4,y:5,z:12},color:"#704214"},{type:"windowFrame",position:{x:3,y:5,z:11},color:"#F5F5DC"},{type:"windowFrame",position:{x:4,y:5,z:11},color:"#F5F5DC"},{type:"pyramid",position:{x:3,y:6,z:12},color:"#2F4F4F"},{type:"finial",position:{x:3,y:7,z:12},color:"#FFD700"},{type:"bench",position:{x:4,y:0,z:0},color:"#8B4513"},{type:"bench",position:{x:9,y:0,z:0},color:"#8B4513"},{type:"bench",position:{x:14,y:0,z:0},color:"#8B4513"},{type:"bench",position:{x:4,y:0,z:9},color:"#8B4513"},{type:"bench",position:{x:9,y:0,z:9},color:"#8B4513"},{type:"bench",position:{x:14,y:0,z:9},color:"#8B4513"},{type:"pillar",position:{x:5,y:0,z:1},color:"#2F4F4F"},{type:"pillar",position:{x:5,y:1,z:1},color:"#2F4F4F"},{type:"lightFixture",position:{x:5,y:2,z:1},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:3}},{type:"pillar",position:{x:10,y:0,z:1},color:"#2F4F4F"},{type:"pillar",position:{x:10,y:1,z:1},color:"#2F4F4F"},{type:"lightFixture",position:{x:10,y:2,z:1},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:3}},{type:"pillar",position:{x:5,y:0,z:8},color:"#2F4F4F"},{type:"pillar",position:{x:5,y:1,z:8},color:"#2F4F4F"},{type:"lightFixture",position:{x:5,y:2,z:8},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:3}},{type:"pillar",position:{x:10,y:0,z:8},color:"#2F4F4F"},{type:"pillar",position:{x:10,y:1,z:8},color:"#2F4F4F"},{type:"lightFixture",position:{x:10,y:2,z:8},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:3}},{type:"locker",position:{x:1,y:0,z:0},color:"#2F4F4F"},{type:"locker",position:{x:16,y:0,z:9},color:"#2F4F4F"},{type:"bin",position:{x:6,y:0,z:0},color:"#404040"},{type:"bin",position:{x:11,y:0,z:9},color:"#404040"},{type:"sign",position:{x:3,y:2,z:1},color:"#000080"},{type:"sign",position:{x:3,y:2,z:8},color:"#000080"},{type:"pillar",position:{x:17,y:0,z:4},color:"#404040"},{type:"pillar",position:{x:17,y:1,z:4},color:"#404040"},{type:"pillar",position:{x:17,y:2,z:4},color:"#404040"},{type:"bulb",position:{x:17,y:3,z:4},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:1.5,radius:2}},{type:"crate",position:{x:15,y:0,z:1},color:"#8B4513"},{type:"crate",position:{x:15,y:1,z:1},color:"#A0522D"},{type:"stairs",position:{x:3,y:0,z:9},color:"#808080",rotation:{x:0,y:180,z:0}},{type:"stairs",position:{x:4,y:0,z:9},color:"#808080",rotation:{x:0,y:180,z:0}}]},solarArrayLarge:{name:"Large Solar Array",category:"energy",description:"Industrial solar panel installation",blocks:[...R(0,0,0,12,10,"#808080"),{type:"solarPanel",position:{x:0,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:1,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:2,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:3,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:4,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:5,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:6,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:7,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:8,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:9,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:10,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:11,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:0,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:1,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:2,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:3,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:4,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:5,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:6,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:7,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:8,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:9,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:10,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:11,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:0,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:1,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:2,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:3,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:4,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:5,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:6,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:7,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:8,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:9,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:10,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:11,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:0,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:1,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:2,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:3,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:4,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:5,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:6,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:7,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:8,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:9,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:10,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:11,y:0,z:6},color:"#283593"},{type:"cube",position:{x:0,y:0,z:8},color:"#606060"},{type:"cube",position:{x:1,y:0,z:8},color:"#606060"},{type:"cube",position:{x:0,y:1,z:8},color:"#505050"},{type:"cube",position:{x:1,y:1,z:8},color:"#505050"},{type:"vent",position:{x:0,y:2,z:8},color:"#404040"},{type:"vent",position:{x:1,y:2,z:8},color:"#404040"},...Q(0,0,9,12,"X","fence","#808080")]},windTurbine:{name:"Wind Turbine",category:"energy",description:"Modern wind turbine with detailed nacelle, blades, and electrical infrastructure",blocks:[...R(-1,0,-1,5,5,"#808080"),{type:"cylinder",position:{x:0,y:0,z:0},color:"#606060"},{type:"cylinder",position:{x:2,y:0,z:0},color:"#606060"},{type:"cylinder",position:{x:0,y:0,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:0,z:2},color:"#606060"},{type:"cylinder",position:{x:1,y:1,z:1},color:"#E8E8E8"},{type:"cylinder",position:{x:1,y:2,z:1},color:"#E8E8E8"},{type:"cylinder",position:{x:1,y:3,z:1},color:"#E8E8E8"},{type:"cylinder",position:{x:1,y:4,z:1},color:"#F0F0F0"},{type:"cylinder",position:{x:1,y:5,z:1},color:"#F0F0F0"},{type:"cylinder",position:{x:1,y:6,z:1},color:"#F0F0F0"},{type:"cylinder",position:{x:1,y:7,z:1},color:"#F0F0F0"},{type:"cylinder",position:{x:1,y:8,z:1},color:"#F5F5F5"},{type:"cylinder",position:{x:1,y:9,z:1},color:"#F5F5F5"},{type:"cylinder",position:{x:1,y:10,z:1},color:"#F5F5F5"},{type:"cylinder",position:{x:1,y:11,z:1},color:"#F5F5F5"},{type:"cube",position:{x:1,y:12,z:1},color:"#E0E0E0"},{type:"cube",position:{x:1,y:12,z:0},color:"#E0E0E0"},{type:"slab",position:{x:1,y:12,z:-1},color:"#D0D0D0"},{type:"dome",position:{x:1,y:13,z:0},color:"#E8E8E8"},{type:"sphere",position:{x:1,y:12,z:-2},color:"#D0D0D0"},{type:"wedgeFlat",position:{x:0,y:13,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:-1,y:14,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:-2,y:15,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:-3,y:16,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:2,y:13,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:3,y:14,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:4,y:15,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:5,y:16,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:1,y:11,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:1,y:10,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:1,y:9,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:1,y:8,z:-2},color:"#FFFFFF"},{type:"sphere",position:{x:1,y:13,z:1},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:3,radius:8}},{type:"sphere",position:{x:1,y:6,z:0},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:1,radius:3}},{type:"doorFrame",position:{x:1,y:1,z:-1},color:"#606060"},{type:"transformer",position:{x:3,y:0,z:1},color:"#556B2F"},{type:"conduitX",position:{x:2,y:0,z:1},color:"#505050"},{type:"conduitX",position:{x:3,y:0,z:1},color:"#505050"},{type:"powerBox",position:{x:3,y:0,z:2},color:"#404040"},{type:"ladder",position:{x:0,y:1,z:1},color:"#FFD700"},{type:"ladder",position:{x:0,y:2,z:1},color:"#FFD700"},{type:"pillar4",position:{x:-1,y:0,z:-1},color:"#CD7F32"},{type:"antenna",position:{x:1,y:13,z:2},color:"#808080"},{type:"slab",position:{x:1,y:0,z:3},color:"#A0A0A0"},{type:"slab",position:{x:1,y:0,z:4},color:"#909090"},{type:"post",position:{x:-1,y:0,z:3},color:"#FFFF00"},{type:"post",position:{x:3,y:0,z:3},color:"#FFFF00"}]},substationYard:{name:"Electrical Substation",category:"energy",description:"High-voltage power substation with transformers, insulators, bus bars, and control building",blocks:[...R(0,0,0,14,10,"#A0A0A0"),{type:"tank",position:{x:2,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:2,y:1,z:2},color:"#556B2F"},{type:"tank",position:{x:3,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:3,y:1,z:2},color:"#556B2F"},{type:"vent",position:{x:2,y:2,z:2},color:"#708090"},{type:"vent",position:{x:3,y:2,z:2},color:"#708090"},{type:"panel",position:{x:1,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:1,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:4,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:4,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"pillar2",position:{x:2,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:2,y:3,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:3,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:3,y:3,z:2},color:"#E8DCC8"},{type:"tank",position:{x:6,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:6,y:1,z:2},color:"#556B2F"},{type:"tank",position:{x:7,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:7,y:1,z:2},color:"#556B2F"},{type:"vent",position:{x:6,y:2,z:2},color:"#708090"},{type:"vent",position:{x:7,y:2,z:2},color:"#708090"},{type:"panel",position:{x:5,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:5,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:8,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:8,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"pillar2",position:{x:6,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:6,y:3,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:7,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:7,y:3,z:2},color:"#E8DCC8"},{type:"tank",position:{x:10,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:10,y:1,z:2},color:"#556B2F"},{type:"tank",position:{x:11,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:11,y:1,z:2},color:"#556B2F"},{type:"vent",position:{x:10,y:2,z:2},color:"#708090"},{type:"vent",position:{x:11,y:2,z:2},color:"#708090"},{type:"panel",position:{x:9,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:9,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:12,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:12,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"pillar2",position:{x:10,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:10,y:3,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:11,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:11,y:3,z:2},color:"#E8DCC8"},{type:"iBeam",position:{x:2,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:2,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:2,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:2,y:3,z:5},color:"#708090"},{type:"iBeam",position:{x:6,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:6,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:6,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:6,y:3,z:5},color:"#708090"},{type:"iBeam",position:{x:10,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:10,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:10,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:10,y:3,z:5},color:"#708090"},{type:"beamX",position:{x:1,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:2,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:3,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:5,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:6,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:7,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:9,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:10,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:11,y:4,z:5},color:"#708090"},{type:"pillar2",position:{x:2,y:4,z:5},color:"#E8DCC8"},{type:"pillar2",position:{x:6,y:4,z:5},color:"#E8DCC8"},{type:"pillar2",position:{x:10,y:4,z:5},color:"#E8DCC8"},...Q(2,5,5,10,"X","pipeX","#C0C0C0"),{type:"transformer",position:{x:2,y:0,z:4},color:"#4682B4"},{type:"transformer",position:{x:6,y:0,z:4},color:"#4682B4"},{type:"transformer",position:{x:10,y:0,z:4},color:"#4682B4"},{type:"switchBox",position:{x:3,y:0,z:4},color:"#FF4500"},{type:"switchBox",position:{x:7,y:0,z:4},color:"#FF4500"},{type:"switchBox",position:{x:11,y:0,z:4},color:"#FF4500"},{type:"pillar",position:{x:1,y:0,z:3},color:"#4682B4"},{type:"pillar",position:{x:1,y:1,z:3},color:"#E8DCC8"},{type:"pillar",position:{x:5,y:0,z:3},color:"#4682B4"},{type:"pillar",position:{x:5,y:1,z:3},color:"#E8DCC8"},{type:"pillar",position:{x:9,y:0,z:3},color:"#4682B4"},{type:"pillar",position:{x:9,y:1,z:3},color:"#E8DCC8"},...R(0,0,7,5,3,"#606060"),...ht(0,1,7,5,3,"#D3D3D3"),...ht(0,2,5,5,3,"#D3D3D3"),...R(0,3,7,5,3,"#505050"),{type:"doorFrame",position:{x:2,y:1,z:7},color:"#404040"},{type:"windowFrame",position:{x:0,y:2,z:7},color:"#4682B4"},{type:"windowFrame",position:{x:4,y:2,z:7},color:"#4682B4"},{type:"acUnit",position:{x:4,y:1,z:9},color:"#C0C0C0"},{type:"fuseBox",position:{x:1,y:1,z:8},color:"#404040"},{type:"fuseBox",position:{x:3,y:1,z:8},color:"#404040"},{type:"iBeam",position:{x:0,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:3,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:4,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:5,z:5},color:"#708090"},{type:"crossBeam",position:{x:0,y:6,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:3,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:4,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:5,z:5},color:"#708090"},{type:"crossBeam",position:{x:13,y:6,z:5},color:"#708090"},{type:"channel",position:{x:2,y:0,z:3},color:"#505050"},{type:"channel",position:{x:3,y:0,z:3},color:"#505050"},{type:"channel",position:{x:6,y:0,z:3},color:"#505050"},{type:"channel",position:{x:7,y:0,z:3},color:"#505050"},{type:"channel",position:{x:10,y:0,z:3},color:"#505050"},{type:"channel",position:{x:11,y:0,z:3},color:"#505050"},...Q(0,0,0,14,"X","fence","#808080"),...Q(0,1,0,14,"X","railing","#404040"),...Q(0,0,9,14,"X","fence","#808080"),...Q(0,1,9,14,"X","railing","#404040"),{type:"fenceZ",position:{x:0,y:0,z:1},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:2},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:3},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:4},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:5},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:6},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:7},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:8},color:"#808080"},{type:"railingZ",position:{x:0,y:1,z:1},color:"#404040"},{type:"railingZ",position:{x:0,y:1,z:3},color:"#404040"},{type:"railingZ",position:{x:0,y:1,z:5},color:"#404040"},{type:"railingZ",position:{x:0,y:1,z:7},color:"#404040"},{type:"fenceZ",position:{x:13,y:0,z:1},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:2},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:3},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:4},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:5},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:6},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:7},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:8},color:"#808080"},{type:"railingZ",position:{x:13,y:1,z:2},color:"#404040"},{type:"railingZ",position:{x:13,y:1,z:4},color:"#404040"},{type:"railingZ",position:{x:13,y:1,z:6},color:"#404040"},{type:"railingZ",position:{x:13,y:1,z:8},color:"#404040"},{type:"sign",position:{x:6,y:1,z:0},color:"#FFD700"},{type:"sign",position:{x:7,y:1,z:0},color:"#FFD700"},{type:"barrier",position:{x:4,y:0,z:1},color:"#FF0000"},{type:"barrier",position:{x:8,y:0,z:1},color:"#FF0000"},{type:"post",position:{x:1,y:0,z:1},color:"#B87333"},{type:"post",position:{x:12,y:0,z:1},color:"#B87333"},{type:"post",position:{x:1,y:0,z:6},color:"#B87333"},{type:"post",position:{x:12,y:0,z:6},color:"#B87333"},{type:"pillar",position:{x:4,y:0,z:6},color:"#505050"},{type:"pillar",position:{x:4,y:1,z:6},color:"#505050"},{type:"pillar",position:{x:4,y:2,z:6},color:"#505050"},{type:"spotlight",position:{x:4,y:3,z:6},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:5}},{type:"pillar",position:{x:9,y:0,z:6},color:"#505050"},{type:"pillar",position:{x:9,y:1,z:6},color:"#505050"},{type:"pillar",position:{x:9,y:2,z:6},color:"#505050"},{type:"spotlight",position:{x:9,y:3,z:6},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:5}}]},coolingTowers:{name:"Cooling Towers",category:"energy",description:"Industrial cooling tower complex with basins, pump house, and control building",blocks:[...R(0,0,0,16,16,"#505050"),...R(1,-1,1,5,5,"#2F4F4F"),...R(10,-1,1,5,5,"#2F4F4F"),...R(1,-1,10,5,5,"#2F4F4F"),...R(10,-1,10,5,5,"#2F4F4F"),{type:"cylinder",position:{x:3,y:0,z:3},color:"#C0C0C0"},{type:"cylinder",position:{x:3,y:1,z:3},color:"#C0C0C0"},{type:"cylinder",position:{x:3,y:2,z:3},color:"#B8B8B8"},{type:"cylinder",position:{x:3,y:3,z:3},color:"#B0B0B0"},{type:"cylinder",position:{x:3,y:4,z:3},color:"#A8A8A8"},{type:"cylinder",position:{x:3,y:5,z:3},color:"#A0A0A0"},{type:"cylinder",position:{x:3,y:6,z:3},color:"#989898"},{type:"tube",position:{x:3,y:7,z:3},color:"#909090"},{type:"dome",position:{x:3,y:8,z:3},color:"#E0E0E0",emissive:{enabled:!0,color:"#FFFFFF",intensity:.3,radius:2}},{type:"cylinder",position:{x:12,y:0,z:3},color:"#C0C0C0"},{type:"cylinder",position:{x:12,y:1,z:3},color:"#C0C0C0"},{type:"cylinder",position:{x:12,y:2,z:3},color:"#B8B8B8"},{type:"cylinder",position:{x:12,y:3,z:3},color:"#B0B0B0"},{type:"cylinder",position:{x:12,y:4,z:3},color:"#A8A8A8"},{type:"cylinder",position:{x:12,y:5,z:3},color:"#A0A0A0"},{type:"cylinder",position:{x:12,y:6,z:3},color:"#989898"},{type:"tube",position:{x:12,y:7,z:3},color:"#909090"},{type:"dome",position:{x:12,y:8,z:3},color:"#E0E0E0",emissive:{enabled:!0,color:"#FFFFFF",intensity:.3,radius:2}},{type:"cylinder",position:{x:3,y:0,z:12},color:"#C0C0C0"},{type:"cylinder",position:{x:3,y:1,z:12},color:"#C0C0C0"},{type:"cylinder",position:{x:3,y:2,z:12},color:"#B8B8B8"},{type:"cylinder",position:{x:3,y:3,z:12},color:"#B0B0B0"},{type:"cylinder",position:{x:3,y:4,z:12},color:"#A8A8A8"},{type:"cylinder",position:{x:3,y:5,z:12},color:"#A0A0A0"},{type:"cylinder",position:{x:3,y:6,z:12},color:"#989898"},{type:"tube",position:{x:3,y:7,z:12},color:"#909090"},{type:"dome",position:{x:3,y:8,z:12},color:"#E0E0E0",emissive:{enabled:!0,color:"#FFFFFF",intensity:.3,radius:2}},{type:"cylinder",position:{x:12,y:0,z:12},color:"#C0C0C0"},{type:"cylinder",position:{x:12,y:1,z:12},color:"#C0C0C0"},{type:"cylinder",position:{x:12,y:2,z:12},color:"#B8B8B8"},{type:"cylinder",position:{x:12,y:3,z:12},color:"#B0B0B0"},{type:"cylinder",position:{x:12,y:4,z:12},color:"#A8A8A8"},{type:"cylinder",position:{x:12,y:5,z:12},color:"#A0A0A0"},{type:"cylinder",position:{x:12,y:6,z:12},color:"#989898"},{type:"tube",position:{x:12,y:7,z:12},color:"#909090"},{type:"dome",position:{x:12,y:8,z:12},color:"#E0E0E0",emissive:{enabled:!0,color:"#FFFFFF",intensity:.3,radius:2}},{type:"pillar2",position:{x:5,y:0,z:3},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:0,z:3},color:"#4A4A4A"},{type:"pillar2",position:{x:10,y:0,z:3},color:"#4A4A4A"},{type:"pillar2",position:{x:5,y:0,z:12},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:0,z:12},color:"#4A4A4A"},{type:"pillar2",position:{x:10,y:0,z:12},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:0,z:7},color:"#4A4A4A"},{type:"pillar2",position:{x:8,y:0,z:8},color:"#4A4A4A"},...Q(4,1,3,8,"X","pipeX","#708090"),...Q(4,1,12,8,"X","pipeX","#708090"),...Q(7,1,4,8,"Z","pipeZ","#708090"),...Q(8,1,4,8,"Z","pipeZ","#708090"),{type:"pipeCross",position:{x:7,y:1,z:3},color:"#708090"},{type:"pipeCross",position:{x:8,y:1,z:3},color:"#708090"},{type:"pipeCross",position:{x:7,y:1,z:12},color:"#708090"},{type:"pipeCross",position:{x:8,y:1,z:12},color:"#708090"},{type:"valve",position:{x:5,y:1,z:3},color:"#B22222"},{type:"valve",position:{x:10,y:1,z:3},color:"#B22222"},{type:"valve",position:{x:5,y:1,z:12},color:"#B22222"},{type:"valve",position:{x:10,y:1,z:12},color:"#B22222"},{type:"valve",position:{x:7,y:1,z:7},color:"#FFD700"},{type:"valve",position:{x:8,y:1,z:8},color:"#FFD700"},...R(14,0,6,3,4,"#606060"),...st(14,1,6,4,2,"#708090"),...st(16,1,6,4,2,"#708090"),...at(14,1,6,3,2,"#708090"),...at(14,1,9,3,2,"#708090"),...R(14,3,6,3,4,"#606060"),{type:"tank",position:{x:15,y:1,z:7},color:"#4682B4"},{type:"tank",position:{x:15,y:2,z:7},color:"#4682B4"},{type:"tank",position:{x:15,y:1,z:8},color:"#4682B4"},{type:"tank",position:{x:15,y:2,z:8},color:"#4682B4"},...Q(12,1,7,3,"X","pipeX","#708090"),{type:"pipeElbowXZ",position:{x:12,y:1,z:7},color:"#708090"},...R(-3,0,6,4,5,"#505050"),...st(-3,1,6,5,3,"#808080"),...st(0,1,6,5,3,"#808080"),...at(-3,1,6,4,3,"#808080"),...at(-3,1,10,4,3,"#808080"),...R(-3,4,6,4,5,"#606060"),{type:"doorFrame",position:{x:-1,y:1,z:6},color:"#4682B4"},{type:"doorFrame",position:{x:-1,y:2,z:6},color:"#4682B4"},{type:"windowFrame",position:{x:-2,y:2,z:6},color:"#87CEEB"},{type:"windowFrame",position:{x:-3,y:2,z:8},color:"#87CEEB"},{type:"desk",position:{x:-2,y:1,z:8},color:"#8B4513"},{type:"monitor",position:{x:-2,y:2,z:8},color:"#1E1E1E",emissive:{enabled:!0,color:"#00FF00",intensity:.5,radius:2}},{type:"switchBox",position:{x:-1,y:2,z:10},color:"#808080"},{type:"acUnit",position:{x:-2,y:4,z:8},color:"#C0C0C0"},{type:"post",position:{x:1,y:0,z:0},color:"#505050"},{type:"post",position:{x:1,y:1,z:0},color:"#505050"},{type:"post",position:{x:4,y:0,z:0},color:"#505050"},{type:"post",position:{x:4,y:1,z:0},color:"#505050"},{type:"post",position:{x:6,y:0,z:0},color:"#505050"},{type:"post",position:{x:6,y:1,z:0},color:"#505050"},{type:"post",position:{x:9,y:0,z:0},color:"#505050"},{type:"post",position:{x:9,y:1,z:0},color:"#505050"},{type:"post",position:{x:12,y:0,z:0},color:"#505050"},{type:"post",position:{x:12,y:1,z:0},color:"#505050"},{type:"post",position:{x:14,y:0,z:0},color:"#505050"},{type:"post",position:{x:14,y:1,z:0},color:"#505050"},{type:"post",position:{x:0,y:0,z:1},color:"#505050"},{type:"post",position:{x:0,y:1,z:1},color:"#505050"},{type:"post",position:{x:0,y:0,z:3},color:"#505050"},{type:"post",position:{x:0,y:1,z:3},color:"#505050"},{type:"post",position:{x:0,y:0,z:5},color:"#505050"},{type:"post",position:{x:0,y:1,z:5},color:"#505050"},{type:"post",position:{x:15,y:0,z:1},color:"#505050"},{type:"post",position:{x:15,y:1,z:1},color:"#505050"},{type:"post",position:{x:15,y:0,z:3},color:"#505050"},{type:"post",position:{x:15,y:1,z:3},color:"#505050"},{type:"post",position:{x:15,y:0,z:5},color:"#505050"},{type:"post",position:{x:15,y:1,z:5},color:"#505050"},...Q(1,2,0,6,"X","catwalk","#404040"),...Q(9,2,0,6,"X","catwalk","#404040"),...Q(0,2,1,5,"Z","catwalk","#404040"),...Q(15,2,1,5,"Z","catwalk","#404040"),...Q(1,2,0,6,"X","railing","#606060"),...Q(9,2,0,6,"X","railing","#606060"),{type:"ladder",position:{x:2,y:0,z:3},color:"#FFD700"},{type:"ladder",position:{x:2,y:1,z:3},color:"#FFD700"},{type:"ladder",position:{x:2,y:2,z:3},color:"#FFD700"},{type:"ladder",position:{x:2,y:3,z:3},color:"#FFD700"},{type:"transformer",position:{x:0,y:0,z:0},color:"#505050"},{type:"powerBox",position:{x:0,y:1,z:0},color:"#404040"},...Q(1,0,0,7,"X","conduitX","#404040"),{type:"conduitElbow",position:{x:7,y:0,z:0},color:"#404040"},...Q(7,0,1,5,"Z","conduitZ","#404040"),...Q(-4,0,5,1,"Z","fence","#808080"),...Q(-4,0,11,5,"Z","fence","#808080"),...Q(-4,0,16,21,"X","fence","#808080"),...Q(16,0,0,16,"Z","fence","#808080"),...Q(0,0,-1,16,"X","fence","#808080"),{type:"barrier",position:{x:7,y:0,z:-1},color:"#FF0000"},{type:"barrier",position:{x:8,y:0,z:-1},color:"#FF0000"},{type:"sign",position:{x:7,y:1,z:-1},color:"#FFD700"},{type:"sign",position:{x:15,y:1,z:6},color:"#FFD700"},{type:"sphere",position:{x:3,y:9,z:3},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"sphere",position:{x:12,y:9,z:3},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"sphere",position:{x:3,y:9,z:12},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"sphere",position:{x:12,y:9,z:12},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"post",position:{x:7,y:0,z:7},color:"#404040"},{type:"post",position:{x:7,y:1,z:7},color:"#404040"},{type:"post",position:{x:7,y:2,z:7},color:"#404040"},{type:"lightFixture",position:{x:7,y:3,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}}]},powerPlant:{name:"Power Plant",category:"industrial",description:"Complete power generation facility with boiler house, turbine hall, control room, and transformer yard",blocks:[...R(0,0,0,20,16,"#505050"),...R(0,0,4,8,8,"#404040"),...at(0,1,4,8,6,"#606060"),...at(0,1,11,8,6,"#606060"),...st(0,1,5,6,6,"#606060"),...st(7,1,5,6,6,"#606060"),...R(0,7,4,8,8,"#505050"),{type:"tank",position:{x:2,y:1,z:6},color:"#8B0000"},{type:"tank",position:{x:2,y:2,z:6},color:"#8B0000"},{type:"tank",position:{x:2,y:3,z:6},color:"#8B0000"},{type:"tank",position:{x:2,y:4,z:6},color:"#8B0000"},{type:"tank",position:{x:2,y:5,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:1,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:2,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:3,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:4,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:5,z:6},color:"#8B0000"},{type:"cylinder",position:{x:2,y:7,z:6},color:"#A0522D"},{type:"cylinder",position:{x:2,y:8,z:6},color:"#A0522D"},{type:"cylinder",position:{x:2,y:9,z:6},color:"#8B4513"},{type:"cylinder",position:{x:2,y:10,z:6},color:"#8B4513"},{type:"cylinder",position:{x:2,y:11,z:6},color:"#704214"},{type:"dome",position:{x:2,y:12,z:6},color:"#808080",emissive:{enabled:!0,color:"#AAAAAA",intensity:.4,radius:2}},{type:"cylinder",position:{x:5,y:7,z:6},color:"#A0522D"},{type:"cylinder",position:{x:5,y:8,z:6},color:"#A0522D"},{type:"cylinder",position:{x:5,y:9,z:6},color:"#8B4513"},{type:"cylinder",position:{x:5,y:10,z:6},color:"#8B4513"},{type:"cylinder",position:{x:5,y:11,z:6},color:"#704214"},{type:"dome",position:{x:5,y:12,z:6},color:"#808080",emissive:{enabled:!0,color:"#AAAAAA",intensity:.4,radius:2}},...Q(3,3,6,2,"X","pipeX","#708090"),{type:"valve",position:{x:3,y:3,z:6},color:"#B22222"},{type:"valve",position:{x:4,y:3,z:6},color:"#B22222"},...Q(2,4,7,4,"Z","pipeZ","#C0C0C0"),...Q(5,4,7,4,"Z","pipeZ","#C0C0C0"),...R(8,0,4,8,8,"#454545"),...at(8,1,4,8,5,"#707070"),...at(8,1,11,8,5,"#707070"),...st(8,1,5,6,5,"#707070"),...st(15,1,5,6,5,"#707070"),...R(8,6,4,8,8,"#505050"),{type:"cylinder",position:{x:10,y:1,z:6},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:10,y:1,z:7},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:10,y:1,z:8},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:10,y:2,z:7},color:"#4169E1"},{type:"cylinder",position:{x:13,y:1,z:6},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:13,y:1,z:7},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:13,y:1,z:8},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:13,y:2,z:7},color:"#4169E1"},{type:"cube",position:{x:11,y:1,z:7},color:"#2F4F4F"},{type:"cube",position:{x:11,y:2,z:7},color:"#2F4F4F"},{type:"cube",position:{x:14,y:1,z:7},color:"#2F4F4F"},{type:"cube",position:{x:14,y:2,z:7},color:"#2F4F4F"},{type:"iBeam",position:{x:9,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:10,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:11,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:12,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:13,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:14,y:5,z:5},color:"#FFD700"},...R(16,0,4,5,6,"#505050"),...st(16,1,4,6,3,"#708090"),...st(20,1,4,6,3,"#708090"),...at(16,1,4,5,3,"#708090"),...at(16,1,9,5,3,"#708090"),...R(16,4,4,5,6,"#505050"),{type:"doorFrame",position:{x:16,y:1,z:6},color:"#4682B4"},{type:"doorFrame",position:{x:16,y:2,z:6},color:"#4682B4"},{type:"windowFrame",position:{x:16,y:2,z:5},color:"#87CEEB"},{type:"windowFrame",position:{x:16,y:2,z:7},color:"#87CEEB"},{type:"windowFrame",position:{x:16,y:2,z:8},color:"#87CEEB"},{type:"switchBox",position:{x:18,y:1,z:5},color:"#2F4F4F"},{type:"monitor",position:{x:18,y:2,z:5},color:"#1E1E1E",emissive:{enabled:!0,color:"#00FF00",intensity:.5,radius:2}},{type:"switchBox",position:{x:19,y:1,z:5},color:"#2F4F4F"},{type:"monitor",position:{x:19,y:2,z:5},color:"#1E1E1E",emissive:{enabled:!0,color:"#00BFFF",intensity:.5,radius:2}},{type:"desk",position:{x:17,y:1,z:7},color:"#4A4A4A"},{type:"chair",position:{x:17,y:1,z:6},color:"#2F2F2F"},{type:"acUnit",position:{x:18,y:4,z:7},color:"#C0C0C0"},...R(0,0,12,8,4,"#3A3A3A"),{type:"cube",position:{x:1,y:0,z:13},color:"#1A1A1A"},{type:"cube",position:{x:2,y:0,z:13},color:"#1A1A1A"},{type:"cube",position:{x:3,y:0,z:13},color:"#1A1A1A"},{type:"cube",position:{x:2,y:0,z:14},color:"#1A1A1A"},{type:"wedge",position:{x:1,y:1,z:13},color:"#1A1A1A"},{type:"wedge",position:{x:2,y:1,z:13},color:"#1A1A1A"},{type:"conveyor",position:{x:4,y:1,z:13},color:"#505050"},{type:"conveyor",position:{x:5,y:1,z:13},color:"#505050"},{type:"conveyor",position:{x:6,y:2,z:13},color:"#505050"},{type:"conveyor",position:{x:6,y:2,z:12},color:"#505050"},{type:"hopper",position:{x:6,y:3,z:12},color:"#696969"},...R(16,0,10,6,6,"#606060"),{type:"transformer",position:{x:17,y:0,z:11},color:"#505050"},{type:"transformer",position:{x:17,y:1,z:11},color:"#505050"},{type:"transformer",position:{x:19,y:0,z:11},color:"#505050"},{type:"transformer",position:{x:19,y:1,z:11},color:"#505050"},{type:"pillar4",position:{x:17,y:2,z:11},color:"#8B4513"},{type:"pillar4",position:{x:19,y:2,z:11},color:"#8B4513"},{type:"iBeam",position:{x:17,y:3,z:11},color:"#C0C0C0"},{type:"iBeam",position:{x:18,y:3,z:11},color:"#C0C0C0"},{type:"iBeam",position:{x:19,y:3,z:11},color:"#C0C0C0"},{type:"switchBox",position:{x:17,y:0,z:13},color:"#808080"},{type:"switchBox",position:{x:19,y:0,z:13},color:"#808080"},{type:"cableX",position:{x:20,y:3,z:11},color:"#1E1E1E"},{type:"cableX",position:{x:21,y:3,z:11},color:"#1E1E1E"},{type:"sign",position:{x:16,y:1,z:10},color:"#FFD700"},...Q(16,0,15,6,"X","fence","#808080"),...Q(21,0,10,5,"Z","fence","#808080"),...R(8,-1,12,6,4,"#2F4F4F"),{type:"cube",position:{x:10,y:0,z:13},color:"#708090"},{type:"cube",position:{x:11,y:0,z:13},color:"#708090"},{type:"cube",position:{x:10,y:1,z:13},color:"#708090"},{type:"cube",position:{x:11,y:1,z:13},color:"#708090"},...Q(8,1,14,4,"X","pipeX","#708090"),{type:"valve",position:{x:9,y:1,z:14},color:"#B22222"},...Q(0,0,0,22,"X","fence","#808080"),...Q(0,0,0,16,"Z","fence","#808080"),...Q(0,0,16,16,"X","fence","#808080"),{type:"barrier",position:{x:10,y:0,z:0},color:"#FF0000"},{type:"barrier",position:{x:11,y:0,z:0},color:"#FF0000"},{type:"cube",position:{x:9,y:0,z:1},color:"#808080"},{type:"cube",position:{x:9,y:1,z:1},color:"#808080"},{type:"windowFrame",position:{x:9,y:1,z:1},color:"#87CEEB"},{type:"sphere",position:{x:2,y:13,z:6},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"sphere",position:{x:5,y:13,z:6},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"pillar4",position:{x:4,y:0,z:2},color:"#404040"},{type:"pillar4",position:{x:4,y:1,z:2},color:"#404040"},{type:"pillar4",position:{x:4,y:2,z:2},color:"#404040"},{type:"pillar4",position:{x:4,y:3,z:2},color:"#404040"},{type:"lightFixture",position:{x:4,y:4,z:2},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:12,y:0,z:2},color:"#404040"},{type:"pillar4",position:{x:12,y:1,z:2},color:"#404040"},{type:"pillar4",position:{x:12,y:2,z:2},color:"#404040"},{type:"pillar4",position:{x:12,y:3,z:2},color:"#404040"},{type:"lightFixture",position:{x:12,y:4,z:2},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:18,y:0,z:12},color:"#404040"},{type:"pillar4",position:{x:18,y:1,z:12},color:"#404040"},{type:"pillar4",position:{x:18,y:2,z:12},color:"#404040"},{type:"pillar4",position:{x:18,y:3,z:12},color:"#404040"},{type:"lightFixture",position:{x:18,y:4,z:12},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}}]},warehouseDistrict:{name:"Warehouse District",category:"industrial",description:"Multiple warehouses with loading docks",blocks:[...R(0,0,0,15,12,"#3A3A3A"),...R(0,0,0,5,4,"#708090"),...at(0,1,0,5,2,"#808080"),...at(0,1,3,5,2,"#808080"),...st(0,1,1,2,2,"#808080"),...st(4,1,1,2,2,"#808080"),...R(0,3,0,5,4,"#606060"),{type:"doorFrame",position:{x:2,y:1,z:0},color:"#FFD700"},...R(7,0,0,5,4,"#708090"),...at(7,1,0,5,2,"#909090"),...at(7,1,3,5,2,"#909090"),...st(7,1,1,2,2,"#909090"),...st(11,1,1,2,2,"#909090"),...R(7,3,0,5,4,"#707070"),{type:"doorFrame",position:{x:9,y:1,z:0},color:"#FFD700"},...R(0,0,6,7,5,"#708090"),...at(0,1,6,7,3,"#808080"),...at(0,1,10,7,3,"#808080"),...st(0,1,7,3,3,"#808080"),...st(6,1,7,3,3,"#808080"),...R(0,4,6,7,5,"#606060"),{type:"doorFrame",position:{x:2,y:1,z:6},color:"#FFD700"},{type:"doorFrame",position:{x:3,y:1,z:6},color:"#FFD700"},{type:"doorFrame",position:{x:4,y:1,z:6},color:"#FFD700"},{type:"slab",position:{x:2,y:0,z:5},color:"#505050"},{type:"slab",position:{x:3,y:0,z:5},color:"#505050"},{type:"slab",position:{x:4,y:0,z:5},color:"#505050"},{type:"crate",position:{x:9,y:0,z:6},color:"#8B4513"},{type:"crate",position:{x:10,y:0,z:6},color:"#A0522D"},{type:"crate",position:{x:9,y:1,z:6},color:"#CD853F"},{type:"barrel",position:{x:12,y:0,z:6},color:"#2F4F4F"},{type:"barrel",position:{x:13,y:0,z:6},color:"#006400"},{type:"pillar2",position:{x:5,y:0,z:4},color:"#2F2F2F"},{type:"pillar2",position:{x:5,y:1,z:4},color:"#2F2F2F"},{type:"pillar2",position:{x:5,y:2,z:4},color:"#2F2F2F"},{type:"sphere",position:{x:5,y:3,z:4},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:2,radius:5}}]},gasStation:{name:"Gas Station",category:"modern",description:"Modern fuel station with pumps, convenience store, car wash, and detailed infrastructure",blocks:[...R(0,0,0,12,10,"#2F2F2F"),{type:"slab",position:{x:0,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:1,y:0,z:4},color:"#2F2F2F"},{type:"slab",position:{x:2,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:3,y:0,z:4},color:"#2F2F2F"},{type:"slab",position:{x:4,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:2,y:0,z:2},color:"#808080"},{type:"slab",position:{x:3,y:0,z:2},color:"#808080"},{type:"pillar2",position:{x:2,y:0,z:2},color:"#FF0000"},{type:"pillar2",position:{x:2,y:1,z:2},color:"#C0C0C0"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#FF0000"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#C0C0C0"},{type:"slab",position:{x:2,y:0,z:6},color:"#808080"},{type:"slab",position:{x:3,y:0,z:6},color:"#808080"},{type:"pillar2",position:{x:2,y:0,z:6},color:"#FF0000"},{type:"pillar2",position:{x:2,y:1,z:6},color:"#C0C0C0"},{type:"pillar2",position:{x:3,y:0,z:6},color:"#FF0000"},{type:"pillar2",position:{x:3,y:1,z:6},color:"#C0C0C0"},{type:"bollard",position:{x:1,y:0,z:2},color:"#FFFF00"},{type:"bollard",position:{x:4,y:0,z:2},color:"#FFFF00"},{type:"bollard",position:{x:1,y:0,z:6},color:"#FFFF00"},{type:"bollard",position:{x:4,y:0,z:6},color:"#FFFF00"},{type:"pillar",position:{x:0,y:0,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:1,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:2,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:0,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:1,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:2,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:0,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:1,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:2,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:0,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:1,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:2,z:7},color:"#E0E0E0"},...R(0,3,0,6,9,"#F0F0F0"),{type:"slab",position:{x:0,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:1,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:2,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:3,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:4,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:5,y:3,z:4},color:"#FF0000"},{type:"lightFixture",position:{x:1,y:3,z:2},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:3,radius:5}},{type:"lightFixture",position:{x:4,y:3,z:2},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:3,radius:5}},{type:"lightFixture",position:{x:1,y:3,z:6},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:3,radius:5}},{type:"lightFixture",position:{x:4,y:3,z:6},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:3,radius:5}},...R(7,0,1,5,7,"#505050"),...ht(7,1,1,5,7,"#DEB887"),...ht(7,2,1,5,7,"#DEB887"),...R(7,3,1,5,7,"#8B0000"),{type:"acUnit",position:{x:8,y:3,z:3},color:"#909090"},{type:"acUnit",position:{x:10,y:3,z:5},color:"#909090"},{type:"doorFrame",position:{x:7,y:1,z:4},color:"#4682B4"},{type:"doorFrame",position:{x:7,y:2,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:2},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:3},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:5},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:6},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:2,z:2},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:2,z:6},color:"#4682B4"},{type:"sign",position:{x:7,y:2,z:4},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:1,radius:2}},{type:"cube",position:{x:0,y:0,z:9},color:"#4169E1"},{type:"pillar2",position:{x:0,y:1,z:9},color:"#C0C0C0"},{type:"cableLoop",position:{x:1,y:0,z:9},color:"#1A1A1A"},{type:"cylinder",position:{x:1,y:0,z:0},color:"#FFD700"},{type:"cylinder",position:{x:3,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:0,y:0,z:0},color:"#808080"},{type:"pipeY",position:{x:0,y:1,z:0},color:"#808080"},{type:"pipeY",position:{x:0,y:2,z:0},color:"#808080"},{type:"cube",position:{x:9,y:0,z:9},color:"#4682B4"},{type:"cube",position:{x:10,y:0,z:9},color:"#4682B4"},{type:"cube",position:{x:11,y:0,z:9},color:"#4682B4"},{type:"cube",position:{x:9,y:1,z:9},color:"#87CEEB"},{type:"cube",position:{x:10,y:1,z:9},color:"#87CEEB"},{type:"cube",position:{x:11,y:1,z:9},color:"#87CEEB"},{type:"slab",position:{x:9,y:2,z:9},color:"#4682B4"},{type:"slab",position:{x:10,y:2,z:9},color:"#4682B4"},{type:"slab",position:{x:11,y:2,z:9},color:"#4682B4"},{type:"pillarRound",position:{x:9,y:0,z:9},color:"#0000CD"},{type:"pillarRound",position:{x:11,y:0,z:9},color:"#0000CD"},{type:"pillar",position:{x:-1,y:0,z:4},color:"#E0E0E0"},{type:"pillar",position:{x:-1,y:1,z:4},color:"#E0E0E0"},{type:"pillar",position:{x:-1,y:2,z:4},color:"#E0E0E0"},{type:"cube",position:{x:-1,y:3,z:4},color:"#FFFFFF"},{type:"cube",position:{x:-1,y:4,z:4},color:"#FF0000"},{type:"barrel",position:{x:6,y:0,z:2},color:"#006400"},{type:"barrel",position:{x:6,y:0,z:6},color:"#006400"},{type:"cube",position:{x:6,y:0,z:4},color:"#FFFFFF"},{type:"cube",position:{x:6,y:1,z:4},color:"#4169E1"},{type:"fence",position:{x:11,y:0,z:1},color:"#C0C0C0"},{type:"barrel",position:{x:11,y:0,z:2},color:"#87CEEB"},{type:"barrel",position:{x:11,y:0,z:3},color:"#87CEEB"}]},helipad:{name:"Helipad",category:"modern",description:"Complete heliport with control room, fuel station, fire safety, and service area",blocks:[...R(4,0,2,10,10,"#404040"),...R(6,0,4,6,6,"#353535"),{type:"slab",position:{x:7,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:8,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:9,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:10,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:6,y:0,z:5},color:"#FFFF00"},{type:"slab",position:{x:11,y:0,z:5},color:"#FFFF00"},{type:"slab",position:{x:6,y:0,z:6},color:"#FFFF00"},{type:"slab",position:{x:11,y:0,z:6},color:"#FFFF00"},{type:"slab",position:{x:6,y:0,z:7},color:"#FFFF00"},{type:"slab",position:{x:11,y:0,z:7},color:"#FFFF00"},{type:"slab",position:{x:6,y:0,z:8},color:"#FFFF00"},{type:"slab",position:{x:11,y:0,z:8},color:"#FFFF00"},{type:"slab",position:{x:7,y:0,z:9},color:"#FFFF00"},{type:"slab",position:{x:8,y:0,z:9},color:"#FFFF00"},{type:"slab",position:{x:9,y:0,z:9},color:"#FFFF00"},{type:"slab",position:{x:10,y:0,z:9},color:"#FFFF00"},{type:"slab",position:{x:7,y:0,z:5},color:"#FFFFFF"},{type:"slab",position:{x:7,y:0,z:6},color:"#FFFFFF"},{type:"slab",position:{x:7,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:7,y:0,z:8},color:"#FFFFFF"},{type:"slab",position:{x:8,y:0,z:6},color:"#FFFFFF"},{type:"slab",position:{x:8,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:9,y:0,z:6},color:"#FFFFFF"},{type:"slab",position:{x:9,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:5},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:6},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:8},color:"#FFFFFF"},{type:"sphere",position:{x:4,y:0,z:2},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:8,y:0,z:2},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:13,y:0,z:2},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:4,y:0,z:11},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:8,y:0,z:11},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:13,y:0,z:11},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:4,y:0,z:6},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:13,y:0,z:6},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},...R(0,0,4,4,6,"#606060"),...st(0,1,4,6,3,"#808080"),...st(3,1,4,6,3,"#808080"),...at(0,1,4,4,3,"#808080"),...at(0,1,9,4,3,"#808080"),...R(0,4,4,4,6,"#505050"),{type:"doorFrame",position:{x:3,y:1,z:6},color:"#4682B4"},{type:"doorFrame",position:{x:3,y:2,z:6},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:2,z:5},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:2,z:7},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:2,z:8},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:3,z:5},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:3,z:6},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:3,z:7},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:3,z:8},color:"#87CEEB"},{type:"desk",position:{x:1,y:1,z:6},color:"#4A4A4A"},{type:"monitor",position:{x:1,y:2,z:6},color:"#1E1E1E",emissive:{enabled:!0,color:"#00BFFF",intensity:.5,radius:2}},{type:"desk",position:{x:1,y:1,z:7},color:"#4A4A4A"},{type:"monitor",position:{x:1,y:2,z:7},color:"#1E1E1E",emissive:{enabled:!0,color:"#00FF00",intensity:.5,radius:2}},{type:"chair",position:{x:2,y:1,z:6},color:"#2F2F2F"},{type:"chair",position:{x:2,y:1,z:7},color:"#2F2F2F"},{type:"antenna",position:{x:1,y:4,z:6},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:5,z:6},color:"#C0C0C0"},{type:"acUnit",position:{x:2,y:4,z:8},color:"#A0A0A0"},...R(0,0,0,4,4,"#505050"),{type:"tank",position:{x:1,y:0,z:1},color:"#FF4500"},{type:"tank",position:{x:1,y:1,z:1},color:"#FF4500"},{type:"tank",position:{x:2,y:0,z:1},color:"#FF4500"},{type:"tank",position:{x:2,y:1,z:1},color:"#FF4500"},{type:"pillar",position:{x:1,y:0,z:2},color:"#FFD700"},{type:"powerBox",position:{x:1,y:1,z:2},color:"#FFD700"},{type:"cylinder",position:{x:2,y:0,z:2},color:"#2F2F2F"},{type:"sign",position:{x:0,y:1,z:0},color:"#FF0000"},{type:"drain",position:{x:1,y:0,z:3},color:"#404040"},...R(0,0,10,4,4,"#505050"),{type:"locker",position:{x:1,y:0,z:11},color:"#FF0000"},{type:"locker",position:{x:1,y:1,z:11},color:"#FF0000"},{type:"tank",position:{x:2,y:0,z:12},color:"#FFFF00"},{type:"tank",position:{x:2,y:1,z:12},color:"#FFFF00"},{type:"cylinder",position:{x:1,y:0,z:12},color:"#B22222"},{type:"cabinet",position:{x:3,y:0,z:11},color:"#FFFFFF"},{type:"cross",position:{x:3,y:1,z:11},color:"#FF0000"},{type:"bench",position:{x:3,y:0,z:12},color:"#FF8C00"},{type:"pillar4",position:{x:14,y:0,z:7},color:"#C0C0C0"},{type:"pillar4",position:{x:14,y:1,z:7},color:"#C0C0C0"},{type:"pillar4",position:{x:14,y:2,z:7},color:"#C0C0C0"},{type:"pillar4",position:{x:14,y:3,z:7},color:"#C0C0C0"},{type:"cone",position:{x:14,y:4,z:7},color:"#FF6600",rotation:{x:0,y:0,z:90}},{type:"sphere",position:{x:8,y:0,z:0},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:3}},{type:"sphere",position:{x:9,y:0,z:0},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:3}},{type:"sphere",position:{x:8,y:0,z:1},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1,radius:2}},{type:"sphere",position:{x:9,y:0,z:1},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1,radius:2}},{type:"pillar",position:{x:4,y:0,z:0},color:"#404040"},{type:"pillar",position:{x:4,y:1,z:0},color:"#404040"},{type:"pillar",position:{x:4,y:2,z:0},color:"#404040"},{type:"spotlight",position:{x:4,y:3,z:0},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:2,radius:6}},{type:"pillar",position:{x:13,y:0,z:0},color:"#404040"},{type:"pillar",position:{x:13,y:1,z:0},color:"#404040"},{type:"pillar",position:{x:13,y:2,z:0},color:"#404040"},{type:"spotlight",position:{x:13,y:3,z:0},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:2,radius:6}},...Q(4,0,12,10,"X","barrier","#FF0000"),...Q(14,0,2,10,"Z","barrier","#FF0000"),{type:"cube",position:{x:14,y:0,z:10},color:"#FFD700"},{type:"seat",position:{x:14,y:1,z:10},color:"#2F2F2F"},{type:"crate",position:{x:14,y:0,z:11},color:"#4682B4"},{type:"crate",position:{x:14,y:0,z:12},color:"#B22222"}]},highway:{name:"Highway Interchange",category:"infrastructure",description:"Elevated highway with exit ramp, signage, lighting, and sound barriers",blocks:[...R(0,0,0,24,16,"#3D5C3D"),...R(2,0,6,20,4,"#2F2F2F"),...Q(4,0,8,16,"X","slab","#FFFFFF"),{type:"column",position:{x:4,y:0,z:2},color:"#808080"},{type:"column",position:{x:4,y:1,z:2},color:"#808080"},{type:"column",position:{x:4,y:2,z:2},color:"#808080"},{type:"column",position:{x:4,y:3,z:2},color:"#808080"},{type:"column",position:{x:4,y:0,z:13},color:"#808080"},{type:"column",position:{x:4,y:1,z:13},color:"#808080"},{type:"column",position:{x:4,y:2,z:13},color:"#808080"},{type:"column",position:{x:4,y:3,z:13},color:"#808080"},{type:"column",position:{x:11,y:0,z:2},color:"#808080"},{type:"column",position:{x:11,y:1,z:2},color:"#808080"},{type:"column",position:{x:11,y:2,z:2},color:"#808080"},{type:"column",position:{x:11,y:3,z:2},color:"#808080"},{type:"column",position:{x:11,y:0,z:13},color:"#808080"},{type:"column",position:{x:11,y:1,z:13},color:"#808080"},{type:"column",position:{x:11,y:2,z:13},color:"#808080"},{type:"column",position:{x:11,y:3,z:13},color:"#808080"},{type:"column",position:{x:18,y:0,z:2},color:"#808080"},{type:"column",position:{x:18,y:1,z:2},color:"#808080"},{type:"column",position:{x:18,y:2,z:2},color:"#808080"},{type:"column",position:{x:18,y:3,z:2},color:"#808080"},{type:"column",position:{x:18,y:0,z:13},color:"#808080"},{type:"column",position:{x:18,y:1,z:13},color:"#808080"},{type:"column",position:{x:18,y:2,z:13},color:"#808080"},{type:"column",position:{x:18,y:3,z:13},color:"#808080"},...R(0,4,0,24,6,"#2A2A2A"),...R(0,4,10,24,6,"#2A2A2A"),...R(0,4,6,24,4,"#404040"),{type:"slab",position:{x:2,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:4,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:6,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:8,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:10,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:12,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:14,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:16,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:18,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:20,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:22,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:2,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:4,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:6,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:8,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:10,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:12,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:14,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:16,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:18,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:20,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:22,y:4,z:13},color:"#FFFFFF"},...Q(0,4,5,24,"X","slab","#FFD700"),...Q(0,4,10,24,"X","slab","#FFD700"),...Q(0,4,0,24,"X","barrier","#C0C0C0"),...Q(0,4,15,24,"X","barrier","#C0C0C0"),...Q(0,4,6,24,"X","barrier","#C0C0C0"),...Q(0,4,9,24,"X","barrier","#C0C0C0"),...R(16,4,16,4,4,"#2A2A2A"),...R(18,3,18,4,4,"#2A2A2A"),...R(20,2,20,4,4,"#2A2A2A"),...R(20,1,22,4,4,"#2A2A2A"),...Q(16,4,19,4,"X","barrier","#C0C0C0"),...Q(18,3,21,4,"X","barrier","#C0C0C0"),...Q(20,2,23,4,"X","barrier","#C0C0C0"),{type:"column",position:{x:19,y:0,z:19},color:"#808080"},{type:"column",position:{x:19,y:1,z:19},color:"#808080"},{type:"column",position:{x:19,y:2,z:19},color:"#808080"},{type:"column",position:{x:8,y:4,z:-1},color:"#2F4F2F"},{type:"column",position:{x:8,y:5,z:-1},color:"#2F4F2F"},{type:"column",position:{x:8,y:6,z:-1},color:"#2F4F2F"},{type:"column",position:{x:8,y:7,z:-1},color:"#2F4F2F"},{type:"column",position:{x:8,y:4,z:16},color:"#2F4F2F"},{type:"column",position:{x:8,y:5,z:16},color:"#2F4F2F"},{type:"column",position:{x:8,y:6,z:16},color:"#2F4F2F"},{type:"column",position:{x:8,y:7,z:16},color:"#2F4F2F"},...Q(8,7,0,16,"Z","iBeam","#2F4F2F"),{type:"sign",position:{x:8,y:6,z:3},color:"#006400"},{type:"sign",position:{x:8,y:6,z:4},color:"#006400"},{type:"sign",position:{x:8,y:6,z:12},color:"#006400"},{type:"sign",position:{x:8,y:6,z:13},color:"#006400"},{type:"sign",position:{x:14,y:5,z:15},color:"#228B22"},{type:"pillar4",position:{x:1,y:4,z:0},color:"#FFFFFF"},{type:"sign",position:{x:1,y:5,z:0},color:"#228B22"},{type:"pillar4",position:{x:3,y:4,z:7},color:"#404040"},{type:"pillar4",position:{x:3,y:5,z:7},color:"#404040"},{type:"pillar4",position:{x:3,y:6,z:7},color:"#404040"},{type:"lightFixture",position:{x:3,y:7,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFCC",intensity:1.5,radius:6}},{type:"pillar4",position:{x:10,y:4,z:7},color:"#404040"},{type:"pillar4",position:{x:10,y:5,z:7},color:"#404040"},{type:"pillar4",position:{x:10,y:6,z:7},color:"#404040"},{type:"lightFixture",position:{x:10,y:7,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFCC",intensity:1.5,radius:6}},{type:"pillar4",position:{x:17,y:4,z:7},color:"#404040"},{type:"pillar4",position:{x:17,y:5,z:7},color:"#404040"},{type:"pillar4",position:{x:17,y:6,z:7},color:"#404040"},{type:"lightFixture",position:{x:17,y:7,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFCC",intensity:1.5,radius:6}},{type:"post",position:{x:0,y:0,z:16},color:"#606060"},{type:"post",position:{x:0,y:1,z:16},color:"#606060"},{type:"post",position:{x:0,y:2,z:16},color:"#606060"},{type:"post",position:{x:0,y:3,z:16},color:"#606060"},{type:"post",position:{x:4,y:0,z:16},color:"#606060"},{type:"post",position:{x:4,y:1,z:16},color:"#606060"},{type:"post",position:{x:4,y:2,z:16},color:"#606060"},{type:"post",position:{x:4,y:3,z:16},color:"#606060"},{type:"post",position:{x:8,y:0,z:16},color:"#606060"},{type:"post",position:{x:8,y:1,z:16},color:"#606060"},{type:"post",position:{x:8,y:2,z:16},color:"#606060"},{type:"post",position:{x:8,y:3,z:16},color:"#606060"},{type:"post",position:{x:12,y:0,z:16},color:"#606060"},{type:"post",position:{x:12,y:1,z:16},color:"#606060"},{type:"post",position:{x:12,y:2,z:16},color:"#606060"},{type:"post",position:{x:12,y:3,z:16},color:"#606060"},{type:"post",position:{x:15,y:0,z:16},color:"#606060"},{type:"post",position:{x:15,y:1,z:16},color:"#606060"},{type:"post",position:{x:15,y:2,z:16},color:"#606060"},{type:"post",position:{x:15,y:3,z:16},color:"#606060"},...Q(0,4,16,16,"X","panel","#A0A0A0"),...Q(0,5,16,16,"X","panel","#909090"),...Q(0,6,16,16,"X","panel","#808080"),{type:"pillar4",position:{x:6,y:4,z:0},color:"#4169E1"},{type:"powerBox",position:{x:6,y:5,z:0},color:"#4169E1"},{type:"locker",position:{x:12,y:4,z:0},color:"#FF0000"},{type:"beamZ",position:{x:8,y:3,z:6},color:"#404040"},{type:"beamZ",position:{x:8,y:3,z:7},color:"#404040"},{type:"beamZ",position:{x:8,y:3,z:8},color:"#404040"},{type:"lightFixture",position:{x:8,y:3,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:.8,radius:4}},{type:"beamZ",position:{x:14,y:3,z:6},color:"#404040"},{type:"beamZ",position:{x:14,y:3,z:7},color:"#404040"},{type:"beamZ",position:{x:14,y:3,z:8},color:"#404040"},{type:"lightFixture",position:{x:14,y:3,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:.8,radius:4}},{type:"grate",position:{x:6,y:0,z:7},color:"#2F2F2F"},{type:"grate",position:{x:12,y:0,z:7},color:"#2F2F2F"},{type:"grate",position:{x:18,y:0,z:7},color:"#2F2F2F"}]},harbor:{name:"Harbor",category:"infrastructure",description:"Busy shipping harbor with crane, warehouse, lighthouse, boat, and cargo containers",blocks:[...R(0,-1,0,16,6,"#1E4D6B"),...R(0,0,0,16,1,"#1E90FF"),...R(0,0,6,16,8,"#696969"),...Q(0,0,6,16,"X","ledge","#505050"),...R(0,0,6,6,3,"#8B4513"),...R(6,0,2,4,4,"#654321"),{type:"pillar",position:{x:6,y:-1,z:2},color:"#3A2A1A"},{type:"pillar",position:{x:9,y:-1,z:2},color:"#3A2A1A"},{type:"pillar",position:{x:6,y:-1,z:5},color:"#3A2A1A"},{type:"pillar",position:{x:9,y:-1,z:5},color:"#3A2A1A"},{type:"beamX",position:{x:2,y:0,z:8},color:"#505050"},{type:"beamX",position:{x:3,y:0,z:8},color:"#505050"},{type:"beamX",position:{x:4,y:0,z:8},color:"#505050"},{type:"beamX",position:{x:2,y:0,z:11},color:"#505050"},{type:"beamX",position:{x:3,y:0,z:11},color:"#505050"},{type:"beamX",position:{x:4,y:0,z:11},color:"#505050"},{type:"iBeam",position:{x:2,y:1,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:2,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:3,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:4,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:5,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:1,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:2,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:3,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:4,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:5,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:1,z:11},color:"#FFD700"},{type:"iBeam",position:{x:2,y:2,z:11},color:"#FFD700"},{type:"iBeam",position:{x:2,y:3,z:11},color:"#FFD700"},{type:"iBeam",position:{x:2,y:4,z:11},color:"#FFD700"},{type:"iBeam",position:{x:2,y:5,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:1,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:2,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:3,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:4,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:5,z:11},color:"#FFD700"},{type:"beamZ",position:{x:2,y:6,z:8},color:"#FFD700"},{type:"beamZ",position:{x:2,y:6,z:9},color:"#FFD700"},{type:"beamZ",position:{x:2,y:6,z:10},color:"#FFD700"},{type:"beamZ",position:{x:2,y:6,z:11},color:"#FFD700"},{type:"beamZ",position:{x:4,y:6,z:8},color:"#FFD700"},{type:"beamZ",position:{x:4,y:6,z:9},color:"#FFD700"},{type:"beamZ",position:{x:4,y:6,z:10},color:"#FFD700"},{type:"beamZ",position:{x:4,y:6,z:11},color:"#FFD700"},{type:"beamX",position:{x:2,y:6,z:9},color:"#FF8C00"},{type:"beamX",position:{x:3,y:6,z:9},color:"#FF8C00"},{type:"beamX",position:{x:4,y:6,z:9},color:"#FF8C00"},{type:"beamZ",position:{x:3,y:6,z:7},color:"#FF8C00"},{type:"beamZ",position:{x:3,y:6,z:6},color:"#FF8C00"},{type:"beamZ",position:{x:3,y:6,z:5},color:"#FF8C00"},{type:"beamZ",position:{x:3,y:6,z:4},color:"#FF8C00"},{type:"chain",position:{x:3,y:5,z:5},color:"#404040"},{type:"chain",position:{x:3,y:4,z:5},color:"#404040"},{type:"chain",position:{x:3,y:3,z:5},color:"#404040"},{type:"valve",position:{x:3,y:2,z:5},color:"#808080"},...R(10,0,7,6,6,"#505050"),...at(10,1,7,6,3,"#A0522D"),...at(10,1,12,6,3,"#A0522D"),...st(10,1,8,4,3,"#A0522D"),...st(15,1,8,4,3,"#A0522D"),...R(10,4,7,6,6,"#8B4513"),{type:"doorFrame",position:{x:12,y:1,z:7},color:"#8B4513"},{type:"doorFrame",position:{x:13,y:1,z:7},color:"#8B4513"},{type:"doorFrame",position:{x:12,y:2,z:7},color:"#8B4513"},{type:"doorFrame",position:{x:13,y:2,z:7},color:"#8B4513"},{type:"windowFrame",position:{x:11,y:2,z:7},color:"#4682B4"},{type:"windowFrame",position:{x:14,y:2,z:7},color:"#4682B4"},{type:"sign",position:{x:12,y:3,z:7},color:"#FFD700"},{type:"cylinder",position:{x:0,y:0,z:0},color:"#F5F5F5"},{type:"cylinder",position:{x:0,y:1,z:0},color:"#DC143C"},{type:"cylinder",position:{x:0,y:2,z:0},color:"#F5F5F5"},{type:"cylinder",position:{x:0,y:3,z:0},color:"#DC143C"},{type:"cylinder",position:{x:0,y:4,z:0},color:"#F5F5F5"},{type:"windowFrame",position:{x:0,y:5,z:0},color:"#1A1A1A"},{type:"bulb",position:{x:0,y:5,z:0},color:"#FFFF00",emissive:{enabled:!0,color:"#FFFF00",intensity:3,radius:8}},{type:"dome",position:{x:0,y:6,z:0},color:"#DC143C"},{type:"hull",position:{x:12,y:0,z:2},color:"#F5F5F5"},{type:"hull",position:{x:13,y:0,z:2},color:"#F5F5F5"},{type:"hull",position:{x:14,y:0,z:2},color:"#F5F5F5"},{type:"cube",position:{x:13,y:1,z:2},color:"#E6E6FA"},{type:"pillar2",position:{x:12,y:1,z:2},color:"#8B4513"},{type:"pillar2",position:{x:12,y:2,z:2},color:"#8B4513"},{type:"crateLarge",position:{x:6,y:0,z:7},color:"#B22222"},{type:"crateLarge",position:{x:6,y:1,z:7},color:"#B22222"},{type:"crateLarge",position:{x:6,y:0,z:9},color:"#4169E1"},{type:"crateLarge",position:{x:6,y:0,z:11},color:"#228B22"},{type:"crateLarge",position:{x:6,y:1,z:11},color:"#FFD700"},{type:"crate",position:{x:8,y:0,z:8},color:"#8B4513"},{type:"crate",position:{x:8,y:0,z:9},color:"#A0522D"},{type:"crate",position:{x:8,y:1,z:8},color:"#CD853F"},{type:"barrel",position:{x:8,y:0,z:10},color:"#2F4F4F"},{type:"barrel",position:{x:8,y:0,z:11},color:"#006400"},{type:"bollard",position:{x:0,y:0,z:6},color:"#404040"},{type:"bollard",position:{x:4,y:0,z:6},color:"#404040"},{type:"bollard",position:{x:8,y:0,z:6},color:"#404040"},{type:"bollard",position:{x:12,y:0,z:6},color:"#404040"},{type:"bollard",position:{x:6,y:0,z:2},color:"#404040"},{type:"bollard",position:{x:9,y:0,z:2},color:"#404040"},{type:"pillar",position:{x:2,y:0,z:12},color:"#404040"},{type:"pillar",position:{x:2,y:1,z:12},color:"#404040"},{type:"pillar",position:{x:2,y:2,z:12},color:"#404040"},{type:"spotlight",position:{x:2,y:3,z:12},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:5}},{type:"pillar",position:{x:10,y:0,z:12},color:"#404040"},{type:"pillar",position:{x:10,y:1,z:12},color:"#404040"},{type:"pillar",position:{x:10,y:2,z:12},color:"#404040"},{type:"spotlight",position:{x:10,y:3,z:12},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:5}},{type:"torus",position:{x:5,y:1,z:6},color:"#FF4500"},{type:"railing",position:{x:6,y:0,z:2},color:"#FFD700"},{type:"railing",position:{x:7,y:0,z:2},color:"#FFD700"},{type:"railing",position:{x:8,y:0,z:2},color:"#FFD700"},{type:"railing",position:{x:9,y:0,z:2},color:"#FFD700"},{type:"wheel",position:{x:9,y:0,z:9},color:"#1A1A1A"},{type:"seat",position:{x:9,y:0,z:10},color:"#FFD700"}]},oilDerrick:{name:"Oil Derrick",category:"oil",description:"Classic oil drilling tower with lattice structure and drilling equipment",blocks:[...R(0,0,0,8,7,"#8B7355"),...R(2,0,1,4,4,"#606060"),{type:"iBeam",position:{x:2,y:1,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:2,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:3,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:4,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:5,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:6,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:7,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:1,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:2,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:3,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:4,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:5,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:6,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:7,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:4,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:5,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:6,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:7,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:4,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:5,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:6,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:7,z:4},color:"#8B0000"},{type:"beamX",position:{x:3,y:2,z:1},color:"#B22222"},{type:"beamX",position:{x:4,y:2,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:4,z:1},color:"#B22222"},{type:"beamX",position:{x:4,y:4,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:6,z:1},color:"#B22222"},{type:"beamX",position:{x:4,y:6,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:2,z:4},color:"#B22222"},{type:"beamX",position:{x:4,y:2,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:4,z:4},color:"#B22222"},{type:"beamX",position:{x:4,y:4,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:6,z:4},color:"#B22222"},{type:"beamX",position:{x:4,y:6,z:4},color:"#B22222"},{type:"beamZ",position:{x:2,y:2,z:2},color:"#B22222"},{type:"beamZ",position:{x:2,y:2,z:3},color:"#B22222"},{type:"beamZ",position:{x:2,y:4,z:2},color:"#B22222"},{type:"beamZ",position:{x:2,y:4,z:3},color:"#B22222"},{type:"beamZ",position:{x:2,y:6,z:2},color:"#B22222"},{type:"beamZ",position:{x:2,y:6,z:3},color:"#B22222"},{type:"beamZ",position:{x:5,y:2,z:2},color:"#B22222"},{type:"beamZ",position:{x:5,y:2,z:3},color:"#B22222"},{type:"beamZ",position:{x:5,y:4,z:2},color:"#B22222"},{type:"beamZ",position:{x:5,y:4,z:3},color:"#B22222"},{type:"beamZ",position:{x:5,y:6,z:2},color:"#B22222"},{type:"beamZ",position:{x:5,y:6,z:3},color:"#B22222"},{type:"crossBeam",position:{x:3,y:1,z:1},color:"#A52A2A"},{type:"crossBeam",position:{x:4,y:3,z:1},color:"#A52A2A"},{type:"crossBeam",position:{x:3,y:5,z:1},color:"#A52A2A"},{type:"crossBeam",position:{x:3,y:1,z:4},color:"#A52A2A"},{type:"crossBeam",position:{x:4,y:3,z:4},color:"#A52A2A"},{type:"crossBeam",position:{x:3,y:5,z:4},color:"#A52A2A"},{type:"grateFloor",position:{x:3,y:8,z:2},color:"#404040"},{type:"grateFloor",position:{x:4,y:8,z:2},color:"#404040"},{type:"grateFloor",position:{x:3,y:8,z:3},color:"#404040"},{type:"grateFloor",position:{x:4,y:8,z:3},color:"#404040"},{type:"cylinder",position:{x:3,y:8,z:2},color:"#505050"},{type:"cylinder",position:{x:4,y:8,z:3},color:"#505050"},{type:"beamZ",position:{x:2,y:5,z:2},color:"#B22222"},{type:"beamZ",position:{x:2,y:5,z:3},color:"#B22222"},{type:"beamZ",position:{x:5,y:5,z:2},color:"#B22222"},{type:"beamZ",position:{x:5,y:5,z:3},color:"#B22222"},{type:"catwalk",position:{x:3,y:5,z:2},color:"#404040"},{type:"catwalk",position:{x:4,y:5,z:2},color:"#404040"},{type:"catwalk",position:{x:3,y:5,z:3},color:"#404040"},{type:"catwalk",position:{x:4,y:5,z:3},color:"#404040"},{type:"railing",position:{x:3,y:5,z:1},color:"#FFD700"},{type:"railing",position:{x:4,y:5,z:1},color:"#FFD700"},{type:"wellHead",position:{x:3,y:0,z:2},color:"#B22222"},{type:"wellHead",position:{x:4,y:0,z:2},color:"#B22222"},{type:"wellHead",position:{x:3,y:0,z:3},color:"#B22222"},{type:"wellHead",position:{x:4,y:0,z:3},color:"#B22222"},{type:"pipeY",position:{x:3,y:1,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:2,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:3,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:4,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:5,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:6,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:7,z:2},color:"#708090"},...R(0,0,1,2,3,"#505050"),{type:"cube",position:{x:0,y:1,z:1},color:"#404040"},{type:"cube",position:{x:1,y:1,z:1},color:"#404040"},{type:"cube",position:{x:0,y:1,z:2},color:"#404040"},{type:"cube",position:{x:1,y:1,z:2},color:"#404040"},{type:"cube",position:{x:0,y:1,z:3},color:"#404040"},{type:"cube",position:{x:1,y:1,z:3},color:"#404040"},{type:"slab",position:{x:0,y:2,z:1},color:"#303030"},{type:"slab",position:{x:1,y:2,z:1},color:"#303030"},{type:"slab",position:{x:0,y:2,z:2},color:"#303030"},{type:"slab",position:{x:1,y:2,z:2},color:"#303030"},{type:"slab",position:{x:0,y:2,z:3},color:"#303030"},{type:"slab",position:{x:1,y:2,z:3},color:"#303030"},{type:"pipeY",position:{x:0,y:2,z:1},color:"#2F2F2F"},{type:"pipeY",position:{x:0,y:3,z:1},color:"#2F2F2F"},{type:"tank",position:{x:6,y:0,z:1},color:"#2F4F4F"},{type:"tank",position:{x:6,y:1,z:1},color:"#2F4F4F"},{type:"tank",position:{x:7,y:0,z:1},color:"#2F4F4F"},{type:"tank",position:{x:7,y:1,z:1},color:"#2F4F4F"},{type:"tank",position:{x:6,y:0,z:3},color:"#4A6B4A"},{type:"tank",position:{x:6,y:1,z:3},color:"#4A6B4A"},{type:"tank",position:{x:7,y:0,z:3},color:"#4A6B4A"},{type:"tank",position:{x:7,y:1,z:3},color:"#4A6B4A"},{type:"pipeX",position:{x:5,y:0,z:1},color:"#708090"},{type:"pipeX",position:{x:5,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:5,y:0,z:2},color:"#708090"},{type:"catwalk",position:{x:0,y:0,z:5},color:"#606060"},{type:"catwalk",position:{x:1,y:0,z:5},color:"#606060"},{type:"catwalk",position:{x:2,y:0,z:5},color:"#606060"},{type:"catwalk",position:{x:3,y:0,z:5},color:"#606060"},{type:"pipeX",position:{x:0,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:1,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:2,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:3,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:0,y:0,z:6},color:"#708090"},{type:"pipeX",position:{x:1,y:0,z:6},color:"#708090"},{type:"pipeX",position:{x:2,y:0,z:6},color:"#708090"},{type:"pipeX",position:{x:3,y:0,z:6},color:"#708090"},{type:"valve",position:{x:2,y:1,z:2},color:"#B22222"},{type:"valve",position:{x:2,y:1,z:3},color:"#B22222"},{type:"valve",position:{x:5,y:0,z:2},color:"#FF4500"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:7,y:0,z:0},color:"#FFD700"},{type:"trafficCone",position:{x:6,y:0,z:5},color:"#FF6600"},{type:"trafficCone",position:{x:7,y:0,z:5},color:"#FF6600"},{type:"spotlight",position:{x:2,y:4,z:1},color:"#FFFF99"},{type:"spotlight",position:{x:5,y:4,z:4},color:"#FFFF99"}]},pumpJackStation:{name:"Pump Jack Station",category:"oil",description:"Oil production site with multiple pump jacks, storage, and control systems",blocks:[...R(0,0,0,10,8,"#8B7355"),{type:"slab",position:{x:1,y:0,z:1},color:"#606060"},{type:"slab",position:{x:2,y:0,z:1},color:"#606060"},{type:"slab",position:{x:1,y:0,z:2},color:"#606060"},{type:"slab",position:{x:2,y:0,z:2},color:"#606060"},{type:"pumpJack",position:{x:1,y:0,z:1},color:"#CD5C5C"},{type:"wellHead",position:{x:2,y:0,z:2},color:"#505050"},{type:"slab",position:{x:1,y:0,z:5},color:"#606060"},{type:"slab",position:{x:2,y:0,z:5},color:"#606060"},{type:"slab",position:{x:1,y:0,z:6},color:"#606060"},{type:"slab",position:{x:2,y:0,z:6},color:"#606060"},{type:"pumpJack",position:{x:1,y:0,z:5},color:"#B22222"},{type:"wellHead",position:{x:2,y:0,z:6},color:"#505050"},{type:"oilTankSmall",position:{x:7,y:0,z:1},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:8,y:0,z:1},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:9,y:0,z:1},color:"#4A6B4A"},{type:"oilTankSmall",position:{x:7,y:0,z:3},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:8,y:0,z:3},color:"#2F4F4F"},{type:"tank",position:{x:9,y:0,z:3},color:"#4682B4"},{type:"tank",position:{x:9,y:1,z:3},color:"#4682B4"},{type:"oilTank",position:{x:5,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:5,y:1,z:2},color:"#505050"},{type:"pipeX",position:{x:3,y:0,z:2},color:"#708090"},{type:"pipeX",position:{x:4,y:0,z:2},color:"#708090"},{type:"valve",position:{x:3,y:0,z:2},color:"#B22222"},{type:"pipeX",position:{x:3,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:4,y:0,z:5},color:"#708090"},{type:"pipeZ",position:{x:4,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:4,y:0,z:4},color:"#708090"},{type:"valve",position:{x:3,y:0,z:5},color:"#B22222"},{type:"pipeX",position:{x:6,y:0,z:2},color:"#708090"},{type:"pipeZ",position:{x:6,y:0,z:1},color:"#708090"},{type:"valve",position:{x:6,y:0,z:2},color:"#FF4500"},{type:"cube",position:{x:7,y:0,z:5},color:"#F5F5DC"},{type:"cube",position:{x:8,y:0,z:5},color:"#F5F5DC"},{type:"cube",position:{x:7,y:0,z:6},color:"#F5F5DC"},{type:"cube",position:{x:8,y:0,z:6},color:"#F5F5DC"},{type:"cube",position:{x:7,y:1,z:5},color:"#F5F5DC"},{type:"cube",position:{x:8,y:1,z:5},color:"#F5F5DC"},{type:"cube",position:{x:7,y:1,z:6},color:"#F5F5DC"},{type:"cube",position:{x:8,y:1,z:6},color:"#F5F5DC"},{type:"slab",position:{x:7,y:2,z:5},color:"#696969"},{type:"slab",position:{x:8,y:2,z:5},color:"#696969"},{type:"slab",position:{x:7,y:2,z:6},color:"#696969"},{type:"slab",position:{x:8,y:2,z:6},color:"#696969"},{type:"doorFrame",position:{x:7,y:0,z:5},color:"#8B4513"},{type:"windowFrame",position:{x:8,y:1,z:5},color:"#8B4513"},{type:"acUnit",position:{x:7,y:2,z:6},color:"#C0C0C0"},{type:"transformer",position:{x:5,y:0,z:6},color:"#505050"},{type:"powerBox",position:{x:5,y:0,z:5},color:"#2F4F4F"},{type:"conduitX",position:{x:4,y:0,z:6},color:"#505050"},{type:"conduitX",position:{x:3,y:0,z:6},color:"#505050"},{type:"slab",position:{x:5,y:0,z:0},color:"#606060"},{type:"valve",position:{x:5,y:0,z:0},color:"#FFD700"},{type:"pipeX",position:{x:6,y:0,z:0},color:"#708090"},{type:"pipeX",position:{x:7,y:0,z:0},color:"#708090"},{type:"fence",position:{x:0,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:1,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:2,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:3,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:4,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:0,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:1,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:2,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:3,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:4,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:5,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:6,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:7,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:8,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:9,y:0,z:7},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:1},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:2},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:3},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:4},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:5},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:6},color:"#8B8B8B"},{type:"fenceZ",position:{x:9,y:0,z:5},color:"#8B8B8B"},{type:"fenceZ",position:{x:9,y:0,z:6},color:"#8B8B8B"},{type:"barrier",position:{x:8,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:9,y:0,z:0},color:"#FFD700"},{type:"trafficCone",position:{x:3,y:0,z:3},color:"#FF6600"},{type:"trafficCone",position:{x:3,y:0,z:4},color:"#FF6600"},{type:"sign",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"oilBarrel",position:{x:9,y:0,z:5},color:"#1a1a1a"},{type:"oilBarrel",position:{x:9,y:0,z:6},color:"#B22222"}]},oilStorageFacility:{name:"Oil Storage Facility",category:"oil",description:"Tank farm with containment, truck loading, and fire suppression systems",blocks:[...R(0,0,0,14,12,"#707070"),{type:"slab",position:{x:1,y:0,z:1},color:"#505050"},{type:"slab",position:{x:2,y:0,z:1},color:"#505050"},{type:"slab",position:{x:3,y:0,z:1},color:"#505050"},{type:"slab",position:{x:4,y:0,z:1},color:"#505050"},{type:"slab",position:{x:1,y:0,z:4},color:"#505050"},{type:"slab",position:{x:2,y:0,z:4},color:"#505050"},{type:"slab",position:{x:3,y:0,z:4},color:"#505050"},{type:"slab",position:{x:4,y:0,z:4},color:"#505050"},{type:"oilTank",position:{x:2,y:0,z:2},color:"#1a1a1a"},{type:"oilTank",position:{x:2,y:0,z:3},color:"#1a1a1a"},{type:"slab",position:{x:6,y:0,z:1},color:"#505050"},{type:"slab",position:{x:7,y:0,z:1},color:"#505050"},{type:"slab",position:{x:8,y:0,z:1},color:"#505050"},{type:"slab",position:{x:6,y:0,z:4},color:"#505050"},{type:"slab",position:{x:7,y:0,z:4},color:"#505050"},{type:"slab",position:{x:8,y:0,z:4},color:"#505050"},{type:"tank",position:{x:6,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:6,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:6,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:8,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:8,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:8,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:6,y:0,z:3},color:"#C0C0C0"},{type:"tank",position:{x:6,y:1,z:3},color:"#C0C0C0"},{type:"tank",position:{x:6,y:2,z:3},color:"#C0C0C0"},{type:"tank",position:{x:8,y:0,z:3},color:"#C0C0C0"},{type:"tank",position:{x:8,y:1,z:3},color:"#C0C0C0"},{type:"tank",position:{x:8,y:2,z:3},color:"#C0C0C0"},{type:"stairs",position:{x:7,y:0,z:2},color:"#FFD700"},{type:"stairs",position:{x:7,y:1,z:2},color:"#FFD700"},{type:"oilTankSmall",position:{x:10,y:0,z:1},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:11,y:0,z:1},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:12,y:0,z:1},color:"#4A6B4A"},{type:"oilTankSmall",position:{x:10,y:0,z:3},color:"#4682B4"},{type:"oilTankSmall",position:{x:11,y:0,z:3},color:"#4682B4"},{type:"oilTankSmall",position:{x:12,y:0,z:3},color:"#B8860B"},{type:"pipeX",position:{x:3,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:4,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:5,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:6,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:7,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:9,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:10,y:0,z:5},color:"#708090"},{type:"pipeZ",position:{x:3,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:6,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:10,y:0,z:4},color:"#708090"},{type:"valve",position:{x:3,y:0,z:5},color:"#B22222"},{type:"valve",position:{x:6,y:0,z:5},color:"#B22222"},{type:"valve",position:{x:8,y:0,z:5},color:"#B22222"},{type:"valve",position:{x:10,y:0,z:5},color:"#B22222"},...R(1,0,6,3,2,"#606060"),{type:"cube",position:{x:1,y:1,z:6},color:"#8B8B8B"},{type:"cube",position:{x:2,y:1,z:6},color:"#8B8B8B"},{type:"cube",position:{x:3,y:1,z:6},color:"#8B8B8B"},{type:"cube",position:{x:1,y:1,z:7},color:"#8B8B8B"},{type:"cube",position:{x:2,y:1,z:7},color:"#8B8B8B"},{type:"cube",position:{x:3,y:1,z:7},color:"#8B8B8B"},{type:"slab",position:{x:1,y:2,z:6},color:"#505050"},{type:"slab",position:{x:2,y:2,z:6},color:"#505050"},{type:"slab",position:{x:3,y:2,z:6},color:"#505050"},{type:"slab",position:{x:1,y:2,z:7},color:"#505050"},{type:"slab",position:{x:2,y:2,z:7},color:"#505050"},{type:"slab",position:{x:3,y:2,z:7},color:"#505050"},{type:"doorFrame",position:{x:2,y:1,z:6},color:"#8B4513"},{type:"cylinder",position:{x:1,y:0,z:6},color:"#2F4F4F"},{type:"cylinder",position:{x:3,y:0,z:7},color:"#2F4F4F"},{type:"pipeX",position:{x:0,y:0,z:6},color:"#708090"},{type:"pipeZ",position:{x:2,y:0,z:5},color:"#708090"},...R(1,0,9,6,3,"#404040"),{type:"pipeY",position:{x:2,y:0,z:10},color:"#708090"},{type:"pipeY",position:{x:2,y:1,z:10},color:"#708090"},{type:"pipeElbowXY",position:{x:2,y:2,z:10},color:"#708090"},{type:"pipeY",position:{x:5,y:0,z:10},color:"#708090"},{type:"pipeY",position:{x:5,y:1,z:10},color:"#708090"},{type:"pipeElbowXY",position:{x:5,y:2,z:10},color:"#708090"},{type:"valve",position:{x:2,y:1,z:10},color:"#FFD700"},{type:"valve",position:{x:5,y:1,z:10},color:"#FFD700"},{type:"pillar",position:{x:1,y:0,z:9},color:"#505050"},{type:"pillar",position:{x:1,y:1,z:9},color:"#505050"},{type:"pillar",position:{x:1,y:2,z:9},color:"#505050"},{type:"pillar",position:{x:6,y:0,z:9},color:"#505050"},{type:"pillar",position:{x:6,y:1,z:9},color:"#505050"},{type:"pillar",position:{x:6,y:2,z:9},color:"#505050"},{type:"pillar",position:{x:1,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:1,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:1,y:2,z:11},color:"#505050"},{type:"pillar",position:{x:6,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:6,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:6,y:2,z:11},color:"#505050"},{type:"beamX",position:{x:2,y:3,z:9},color:"#505050"},{type:"beamX",position:{x:3,y:3,z:9},color:"#505050"},{type:"beamX",position:{x:4,y:3,z:9},color:"#505050"},{type:"beamX",position:{x:5,y:3,z:9},color:"#505050"},{type:"beamX",position:{x:2,y:3,z:11},color:"#505050"},{type:"beamX",position:{x:3,y:3,z:11},color:"#505050"},{type:"beamX",position:{x:4,y:3,z:11},color:"#505050"},{type:"beamX",position:{x:5,y:3,z:11},color:"#505050"},...R(10,0,7,4,4,"#808080"),...ht(10,1,7,4,4,"#F5F5DC"),...ht(10,2,7,4,4,"#F5F5DC"),...R(10,3,7,4,4,"#696969"),{type:"doorFrame",position:{x:11,y:1,z:7},color:"#8B4513"},{type:"windowFrame",position:{x:12,y:2,z:7},color:"#8B4513"},{type:"windowFrame",position:{x:10,y:2,z:8},color:"#8B4513"},{type:"windowFrame",position:{x:13,y:2,z:9},color:"#8B4513"},{type:"acUnit",position:{x:12,y:3,z:9},color:"#C0C0C0"},{type:"tank",position:{x:10,y:0,z:5},color:"#B22222"},{type:"tank",position:{x:10,y:1,z:5},color:"#B22222"},{type:"tank",position:{x:10,y:2,z:5},color:"#B22222"},{type:"pipeY",position:{x:4,y:0,z:0},color:"#B22222"},{type:"valve",position:{x:4,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:9,y:0,z:0},color:"#B22222"},{type:"valve",position:{x:9,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:0,y:0,z:5},color:"#B22222"},{type:"pipeY",position:{x:13,y:0,z:5},color:"#B22222"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:13,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:11},color:"#FFD700"},{type:"barrier",position:{x:13,y:0,z:11},color:"#FFD700"},{type:"trafficCone",position:{x:0,y:0,z:9},color:"#FF6600"},{type:"trafficCone",position:{x:0,y:0,z:10},color:"#FF6600"},{type:"trafficCone",position:{x:7,y:0,z:10},color:"#FF6600"},{type:"sign",position:{x:1,y:0,z:0},color:"#FFD700"},{type:"sign",position:{x:12,y:0,z:0},color:"#FFD700"},{type:"transformer",position:{x:12,y:0,z:5},color:"#505050"},{type:"powerBox",position:{x:13,y:0,z:6},color:"#2F4F4F"},{type:"lightFixture",position:{x:5,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:8,y:0,z:0},color:"#FFFF99"},{type:"oilBarrel",position:{x:12,y:0,z:10},color:"#1a1a1a"},{type:"oilBarrel",position:{x:13,y:0,z:10},color:"#1a1a1a"},{type:"oilBarrel",position:{x:12,y:0,z:11},color:"#B22222"},{type:"oilBarrel",position:{x:13,y:0,z:11},color:"#4682B4"},{type:"oilBarrel",position:{x:12,y:1,z:10},color:"#1a1a1a"}]},oilFieldSite:{name:"Oil Field Site",category:"oil",description:"Large-scale oil production facility with drilling, pumps, processing and storage",blocks:[...R(0,0,0,18,16,"#8B7355"),...R(0,0,7,4,2,"#404040"),...R(1,0,1,4,4,"#606060"),{type:"iBeam",position:{x:1,y:1,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:2,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:3,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:4,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:5,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:6,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:1,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:2,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:3,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:4,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:5,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:6,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:4,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:5,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:6,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:4,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:5,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:6,z:4},color:"#8B0000"},{type:"beamX",position:{x:2,y:2,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:2,z:1},color:"#B22222"},{type:"beamX",position:{x:2,y:4,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:4,z:1},color:"#B22222"},{type:"beamX",position:{x:2,y:6,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:6,z:1},color:"#B22222"},{type:"beamX",position:{x:2,y:2,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:2,z:4},color:"#B22222"},{type:"beamX",position:{x:2,y:4,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:4,z:4},color:"#B22222"},{type:"beamX",position:{x:2,y:6,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:6,z:4},color:"#B22222"},{type:"beamZ",position:{x:1,y:2,z:2},color:"#B22222"},{type:"beamZ",position:{x:1,y:2,z:3},color:"#B22222"},{type:"beamZ",position:{x:1,y:4,z:2},color:"#B22222"},{type:"beamZ",position:{x:1,y:4,z:3},color:"#B22222"},{type:"beamZ",position:{x:4,y:2,z:2},color:"#B22222"},{type:"beamZ",position:{x:4,y:2,z:3},color:"#B22222"},{type:"beamZ",position:{x:4,y:4,z:2},color:"#B22222"},{type:"beamZ",position:{x:4,y:4,z:3},color:"#B22222"},{type:"grateFloor",position:{x:2,y:7,z:2},color:"#404040"},{type:"grateFloor",position:{x:3,y:7,z:2},color:"#404040"},{type:"grateFloor",position:{x:2,y:7,z:3},color:"#404040"},{type:"grateFloor",position:{x:3,y:7,z:3},color:"#404040"},{type:"wellHead",position:{x:2,y:0,z:2},color:"#B22222"},{type:"wellHead",position:{x:3,y:0,z:2},color:"#B22222"},{type:"wellHead",position:{x:2,y:0,z:3},color:"#B22222"},{type:"wellHead",position:{x:3,y:0,z:3},color:"#B22222"},{type:"pipeY",position:{x:2,y:1,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:2,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:3,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:4,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:5,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:6,z:2},color:"#708090"},{type:"tank",position:{x:0,y:0,z:5},color:"#2F4F4F"},{type:"tank",position:{x:0,y:1,z:5},color:"#2F4F4F"},{type:"tank",position:{x:0,y:0,z:6},color:"#4A6B4A"},{type:"tank",position:{x:0,y:1,z:6},color:"#4A6B4A"},{type:"slab",position:{x:6,y:0,z:2},color:"#606060"},{type:"slab",position:{x:7,y:0,z:2},color:"#606060"},{type:"pumpJack",position:{x:6,y:0,z:2},color:"#CD5C5C"},{type:"wellHead",position:{x:7,y:0,z:2},color:"#505050"},{type:"slab",position:{x:6,y:0,z:5},color:"#606060"},{type:"slab",position:{x:7,y:0,z:5},color:"#606060"},{type:"pumpJack",position:{x:6,y:0,z:5},color:"#B22222"},{type:"wellHead",position:{x:7,y:0,z:5},color:"#505050"},{type:"slab",position:{x:6,y:0,z:10},color:"#606060"},{type:"slab",position:{x:7,y:0,z:10},color:"#606060"},{type:"pumpJack",position:{x:6,y:0,z:10},color:"#CD5C5C"},{type:"wellHead",position:{x:7,y:0,z:10},color:"#505050"},{type:"slab",position:{x:6,y:0,z:13},color:"#606060"},{type:"slab",position:{x:7,y:0,z:13},color:"#606060"},{type:"pumpJack",position:{x:6,y:0,z:13},color:"#B22222"},{type:"wellHead",position:{x:7,y:0,z:13},color:"#505050"},...R(9,0,1,4,5,"#707070"),{type:"oilTank",position:{x:10,y:0,z:2},color:"#708090"},{type:"oilTank",position:{x:10,y:0,z:4},color:"#708090"},{type:"tank",position:{x:12,y:0,z:2},color:"#505050"},{type:"tank",position:{x:12,y:1,z:2},color:"#505050"},{type:"pipeY",position:{x:12,y:2,z:2},color:"#2F2F2F"},{type:"pipeX",position:{x:11,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:11,y:0,z:2},color:"#708090"},{type:"pipeZ",position:{x:11,y:0,z:4},color:"#708090"},{type:"valve",position:{x:11,y:0,z:3},color:"#B22222"},{type:"pipeY",position:{x:17,y:0,z:1},color:"#505050"},{type:"pipeY",position:{x:17,y:1,z:1},color:"#505050"},{type:"pipeY",position:{x:17,y:2,z:1},color:"#505050"},{type:"pipeY",position:{x:17,y:3,z:1},color:"#505050"},{type:"pipeY",position:{x:17,y:4,z:1},color:"#505050"},{type:"cone",position:{x:17,y:5,z:1},color:"#FF4500"},...R(13,0,7,5,6,"#707070"),{type:"tank",position:{x:14,y:0,z:8},color:"#E8E8E8"},{type:"tank",position:{x:14,y:1,z:8},color:"#E8E8E8"},{type:"tank",position:{x:14,y:2,z:8},color:"#E8E8E8"},{type:"tank",position:{x:16,y:0,z:8},color:"#E8E8E8"},{type:"tank",position:{x:16,y:1,z:8},color:"#E8E8E8"},{type:"tank",position:{x:16,y:2,z:8},color:"#E8E8E8"},{type:"tank",position:{x:14,y:0,z:11},color:"#C0C0C0"},{type:"tank",position:{x:14,y:1,z:11},color:"#C0C0C0"},{type:"tank",position:{x:14,y:2,z:11},color:"#C0C0C0"},{type:"tank",position:{x:16,y:0,z:11},color:"#C0C0C0"},{type:"tank",position:{x:16,y:1,z:11},color:"#C0C0C0"},{type:"tank",position:{x:16,y:2,z:11},color:"#C0C0C0"},{type:"stairs",position:{x:15,y:0,z:8},color:"#FFD700"},{type:"stairs",position:{x:15,y:1,z:8},color:"#FFD700"},{type:"oilTankSmall",position:{x:13,y:0,z:8},color:"#4682B4"},{type:"oilTankSmall",position:{x:13,y:0,z:11},color:"#4682B4"},{type:"pipeX",position:{x:8,y:0,z:2},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:5},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:9,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:10},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:13},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:11},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:12},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:6},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:7},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:8},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:9},color:"#708090"},{type:"pipeX",position:{x:13,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:13,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:13,y:0,z:5},color:"#708090"},{type:"pipeZ",position:{x:13,y:0,z:6},color:"#708090"},{type:"pipeZ",position:{x:13,y:0,z:7},color:"#708090"},{type:"valve",position:{x:8,y:0,z:2},color:"#B22222"},{type:"valve",position:{x:8,y:0,z:5},color:"#B22222"},{type:"valve",position:{x:8,y:0,z:10},color:"#B22222"},{type:"valve",position:{x:8,y:0,z:13},color:"#B22222"},{type:"valve",position:{x:13,y:0,z:3},color:"#FF4500"},...R(1,0,10,4,4,"#808080"),...ht(1,1,10,4,4,"#F5F5DC"),...ht(1,2,10,4,4,"#F5F5DC"),...R(1,3,10,4,4,"#696969"),{type:"doorFrame",position:{x:2,y:1,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:3,y:2,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:1,y:2,z:11},color:"#8B4513"},{type:"windowFrame",position:{x:4,y:2,z:12},color:"#8B4513"},{type:"acUnit",position:{x:3,y:3,z:12},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:3,z:10},color:"#505050"},...R(1,0,14,3,2,"#505050"),{type:"cube",position:{x:1,y:1,z:14},color:"#2F4F4F"},{type:"cube",position:{x:2,y:1,z:14},color:"#2F4F4F"},{type:"cube",position:{x:1,y:1,z:15},color:"#2F4F4F"},{type:"cube",position:{x:2,y:1,z:15},color:"#2F4F4F"},{type:"pipeY",position:{x:1,y:2,z:14},color:"#2F2F2F"},{type:"transformer",position:{x:3,y:0,z:14},color:"#505050"},{type:"powerBox",position:{x:3,y:0,z:15},color:"#2F4F4F"},{type:"oilBarrel",position:{x:10,y:0,z:13},color:"#1a1a1a"},{type:"oilBarrel",position:{x:11,y:0,z:13},color:"#1a1a1a"},{type:"oilBarrel",position:{x:12,y:0,z:13},color:"#B22222"},{type:"oilBarrel",position:{x:10,y:0,z:14},color:"#2F4F4F"},{type:"oilBarrel",position:{x:11,y:0,z:14},color:"#1a1a1a"},{type:"oilBarrel",position:{x:12,y:0,z:14},color:"#4682B4"},{type:"oilBarrel",position:{x:10,y:1,z:13},color:"#B22222"},{type:"oilBarrel",position:{x:11,y:1,z:13},color:"#1a1a1a"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:17,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:15},color:"#FFD700"},{type:"barrier",position:{x:17,y:0,z:15},color:"#FFD700"},{type:"barrier",position:{x:5,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:12,y:0,z:0},color:"#FFD700"},{type:"trafficCone",position:{x:5,y:0,z:3},color:"#FF6600"},{type:"trafficCone",position:{x:5,y:0,z:6},color:"#FF6600"},{type:"trafficCone",position:{x:5,y:0,z:9},color:"#FF6600"},{type:"trafficCone",position:{x:5,y:0,z:12},color:"#FF6600"},{type:"sign",position:{x:0,y:0,z:7},color:"#FFD700"},{type:"sign",position:{x:9,y:0,z:0},color:"#FFD700"},{type:"lightFixture",position:{x:5,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:12,y:0,z:0},color:"#FFFF99"},{type:"spotlight",position:{x:1,y:4,z:1},color:"#FFFF99"},{type:"spotlight",position:{x:4,y:4,z:4},color:"#FFFF99"},{type:"fence",position:{x:13,y:0,z:13},color:"#8B8B8B"},{type:"fence",position:{x:14,y:0,z:13},color:"#8B8B8B"},{type:"fence",position:{x:15,y:0,z:13},color:"#8B8B8B"},{type:"fence",position:{x:16,y:0,z:13},color:"#8B8B8B"},{type:"fence",position:{x:17,y:0,z:13},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:7},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:8},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:9},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:10},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:11},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:12},color:"#8B8B8B"}]},offshorePlatform:{name:"Offshore Oil Platform",category:"oil",description:"Deep-water oil platform with helideck, crane, and living quarters",blocks:[...R(0,0,0,16,14,"#1E4D6B"),{type:"pillar",position:{x:2,y:0,z:2},color:"#505050"},{type:"pillar",position:{x:2,y:1,z:2},color:"#505050"},{type:"pillar",position:{x:2,y:2,z:2},color:"#505050"},{type:"pillar",position:{x:3,y:0,z:2},color:"#505050"},{type:"pillar",position:{x:3,y:1,z:2},color:"#505050"},{type:"pillar",position:{x:3,y:2,z:2},color:"#505050"},{type:"pillar",position:{x:2,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:2,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:2,y:2,z:3},color:"#505050"},{type:"pillar",position:{x:3,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:3,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:3,y:2,z:3},color:"#505050"},{type:"pillar",position:{x:12,y:0,z:2},color:"#505050"},{type:"pillar",position:{x:12,y:1,z:2},color:"#505050"},{type:"pillar",position:{x:12,y:2,z:2},color:"#505050"},{type:"pillar",position:{x:13,y:0,z:2},color:"#505050"},{type:"pillar",position:{x:13,y:1,z:2},color:"#505050"},{type:"pillar",position:{x:13,y:2,z:2},color:"#505050"},{type:"pillar",position:{x:12,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:12,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:12,y:2,z:3},color:"#505050"},{type:"pillar",position:{x:13,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:13,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:13,y:2,z:3},color:"#505050"},{type:"pillar",position:{x:2,y:0,z:10},color:"#505050"},{type:"pillar",position:{x:2,y:1,z:10},color:"#505050"},{type:"pillar",position:{x:2,y:2,z:10},color:"#505050"},{type:"pillar",position:{x:3,y:0,z:10},color:"#505050"},{type:"pillar",position:{x:3,y:1,z:10},color:"#505050"},{type:"pillar",position:{x:3,y:2,z:10},color:"#505050"},{type:"pillar",position:{x:2,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:2,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:2,y:2,z:11},color:"#505050"},{type:"pillar",position:{x:3,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:3,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:3,y:2,z:11},color:"#505050"},{type:"pillar",position:{x:12,y:0,z:10},color:"#505050"},{type:"pillar",position:{x:12,y:1,z:10},color:"#505050"},{type:"pillar",position:{x:12,y:2,z:10},color:"#505050"},{type:"pillar",position:{x:13,y:0,z:10},color:"#505050"},{type:"pillar",position:{x:13,y:1,z:10},color:"#505050"},{type:"pillar",position:{x:13,y:2,z:10},color:"#505050"},{type:"pillar",position:{x:12,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:12,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:12,y:2,z:11},color:"#505050"},{type:"pillar",position:{x:13,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:13,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:13,y:2,z:11},color:"#505050"},...R(1,3,1,14,12,"#707070"),...R(5,3,5,4,4,"#606060"),{type:"iBeam",position:{x:5,y:4,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:5,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:6,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:7,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:8,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:4,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:5,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:6,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:7,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:8,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:4,z:8},color:"#8B0000"},{type:"iBeam",position:{x:5,y:5,z:8},color:"#8B0000"},{type:"iBeam",position:{x:5,y:6,z:8},color:"#8B0000"},{type:"iBeam",position:{x:5,y:7,z:8},color:"#8B0000"},{type:"iBeam",position:{x:5,y:8,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:4,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:5,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:6,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:7,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:8,z:8},color:"#8B0000"},{type:"beamX",position:{x:6,y:5,z:5},color:"#B22222"},{type:"beamX",position:{x:7,y:5,z:5},color:"#B22222"},{type:"beamX",position:{x:6,y:7,z:5},color:"#B22222"},{type:"beamX",position:{x:7,y:7,z:5},color:"#B22222"},{type:"beamX",position:{x:6,y:5,z:8},color:"#B22222"},{type:"beamX",position:{x:7,y:5,z:8},color:"#B22222"},{type:"beamX",position:{x:6,y:7,z:8},color:"#B22222"},{type:"beamX",position:{x:7,y:7,z:8},color:"#B22222"},{type:"beamZ",position:{x:5,y:5,z:6},color:"#B22222"},{type:"beamZ",position:{x:5,y:5,z:7},color:"#B22222"},{type:"beamZ",position:{x:5,y:7,z:6},color:"#B22222"},{type:"beamZ",position:{x:5,y:7,z:7},color:"#B22222"},{type:"beamZ",position:{x:8,y:5,z:6},color:"#B22222"},{type:"beamZ",position:{x:8,y:5,z:7},color:"#B22222"},{type:"beamZ",position:{x:8,y:7,z:6},color:"#B22222"},{type:"beamZ",position:{x:8,y:7,z:7},color:"#B22222"},{type:"grateFloor",position:{x:6,y:9,z:6},color:"#404040"},{type:"grateFloor",position:{x:7,y:9,z:6},color:"#404040"},{type:"grateFloor",position:{x:6,y:9,z:7},color:"#404040"},{type:"grateFloor",position:{x:7,y:9,z:7},color:"#404040"},{type:"wellHead",position:{x:6,y:3,z:6},color:"#B22222"},{type:"wellHead",position:{x:7,y:3,z:7},color:"#B22222"},{type:"pipeY",position:{x:6,y:4,z:6},color:"#708090"},{type:"pipeY",position:{x:6,y:5,z:6},color:"#708090"},{type:"pipeY",position:{x:6,y:6,z:6},color:"#708090"},{type:"pipeY",position:{x:6,y:7,z:6},color:"#708090"},{type:"pipeY",position:{x:6,y:8,z:6},color:"#708090"},...R(10,3,1,4,4,"#2F4F2F"),{type:"slab",position:{x:11,y:3,z:2},color:"#FFFFFF"},{type:"slab",position:{x:12,y:3,z:2},color:"#FFFFFF"},{type:"slab",position:{x:11,y:3,z:3},color:"#FFFFFF"},{type:"slab",position:{x:12,y:3,z:3},color:"#FFFFFF"},{type:"lightFixture",position:{x:10,y:3,z:1},color:"#FF0000"},{type:"lightFixture",position:{x:13,y:3,z:1},color:"#FF0000"},{type:"lightFixture",position:{x:10,y:3,z:4},color:"#FF0000"},{type:"lightFixture",position:{x:13,y:3,z:4},color:"#FF0000"},...R(1,3,1,3,4,"#808080"),...ht(1,4,1,3,4,"#F5F5DC"),...ht(1,5,1,3,4,"#F5F5DC"),...R(1,6,1,3,4,"#696969"),{type:"doorFrame",position:{x:2,y:4,z:4},color:"#8B4513"},{type:"windowFrame",position:{x:1,y:5,z:1},color:"#8B4513"},{type:"windowFrame",position:{x:3,y:5,z:1},color:"#8B4513"},{type:"windowFrame",position:{x:1,y:5,z:3},color:"#8B4513"},{type:"acUnit",position:{x:2,y:6,z:3},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:6,z:1},color:"#505050"},{type:"cylinder",position:{x:14,y:3,z:7},color:"#FFD700"},{type:"pillar",position:{x:14,y:4,z:7},color:"#FFD700"},{type:"pillar",position:{x:14,y:5,z:7},color:"#FFD700"},{type:"pillar",position:{x:14,y:6,z:7},color:"#FFD700"},{type:"beamZ",position:{x:14,y:6,z:5},color:"#FFD700"},{type:"beamZ",position:{x:14,y:6,z:6},color:"#FFD700"},{type:"beamZ",position:{x:14,y:6,z:8},color:"#FFD700"},{type:"beamZ",position:{x:14,y:6,z:9},color:"#FFD700"},{type:"chain",position:{x:14,y:5,z:5},color:"#505050"},{type:"oilTank",position:{x:10,y:3,z:6},color:"#708090"},{type:"oilTank",position:{x:10,y:3,z:8},color:"#708090"},{type:"oilTankSmall",position:{x:10,y:3,z:10},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:11,y:3,z:10},color:"#4682B4"},{type:"pipeX",position:{x:9,y:3,z:7},color:"#708090"},{type:"pipeZ",position:{x:9,y:3,z:8},color:"#708090"},{type:"pipeZ",position:{x:9,y:3,z:9},color:"#708090"},{type:"valve",position:{x:9,y:3,z:7},color:"#B22222"},{type:"beamX",position:{x:0,y:3,z:7},color:"#505050"},{type:"pipeY",position:{x:0,y:4,z:7},color:"#505050"},{type:"pipeY",position:{x:0,y:5,z:7},color:"#505050"},{type:"cone",position:{x:0,y:6,z:7},color:"#FF4500"},{type:"hull",position:{x:1,y:3,z:10},color:"#FF6600"},{type:"hull",position:{x:1,y:3,z:12},color:"#FF6600"},{type:"railing",position:{x:1,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:2,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:3,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:4,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:5,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:6,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:7,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:8,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:9,y:3,z:0},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:1},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:2},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:3},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:4},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:5},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:6},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:6},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:7},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:8},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:9},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:10},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:11},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:12},color:"#FFD700"},{type:"spotlight",position:{x:5,y:6,z:5},color:"#FFFF99"},{type:"spotlight",position:{x:8,y:6,z:8},color:"#FFFF99"},{type:"lightFixture",position:{x:14,y:3,z:12},color:"#FFFF99"}]},oilRefinery:{name:"Oil Refinery",category:"oil",description:"Petroleum refinery with distillation columns, cooling towers, and storage",blocks:[...R(0,0,0,18,14,"#707070"),...R(1,0,1,5,6,"#606060"),{type:"tank",position:{x:2,y:0,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:1,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:2,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:3,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:4,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:5,z:2},color:"#C0C0C0"},{type:"dome",position:{x:2,y:6,z:2},color:"#C0C0C0"},{type:"tank",position:{x:4,y:0,z:2},color:"#B0B0B0"},{type:"tank",position:{x:4,y:1,z:2},color:"#B0B0B0"},{type:"tank",position:{x:4,y:2,z:2},color:"#B0B0B0"},{type:"tank",position:{x:4,y:3,z:2},color:"#B0B0B0"},{type:"tank",position:{x:4,y:4,z:2},color:"#B0B0B0"},{type:"dome",position:{x:4,y:5,z:2},color:"#B0B0B0"},{type:"tank",position:{x:2,y:0,z:5},color:"#A0A0A0"},{type:"tank",position:{x:2,y:1,z:5},color:"#A0A0A0"},{type:"tank",position:{x:2,y:2,z:5},color:"#A0A0A0"},{type:"tank",position:{x:2,y:3,z:5},color:"#A0A0A0"},{type:"dome",position:{x:2,y:4,z:5},color:"#A0A0A0"},{type:"tank",position:{x:4,y:0,z:5},color:"#909090"},{type:"tank",position:{x:4,y:1,z:5},color:"#909090"},{type:"tank",position:{x:4,y:2,z:5},color:"#909090"},{type:"dome",position:{x:4,y:3,z:5},color:"#909090"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:0,z:5},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:5},color:"#4A4A4A"},{type:"catwalk",position:{x:3,y:2,z:2},color:"#404040"},{type:"catwalk",position:{x:3,y:2,z:3},color:"#404040"},{type:"catwalk",position:{x:3,y:2,z:4},color:"#404040"},{type:"catwalk",position:{x:3,y:2,z:5},color:"#404040"},{type:"stairs",position:{x:1,y:0,z:3},color:"#FFD700"},{type:"stairs",position:{x:1,y:1,z:3},color:"#FFD700"},{type:"pipeZ",position:{x:3,y:1,z:3},color:"#708090"},{type:"pipeZ",position:{x:3,y:1,z:4},color:"#708090"},{type:"pipeX",position:{x:3,y:3,z:2},color:"#708090"},{type:"valve",position:{x:3,y:3,z:2},color:"#B22222"},...R(7,0,1,4,4,"#505050"),{type:"cylinder",position:{x:8,y:0,z:2},color:"#808080"},{type:"cylinder",position:{x:8,y:1,z:2},color:"#808080"},{type:"cylinder",position:{x:8,y:2,z:2},color:"#909090"},{type:"cylinder",position:{x:8,y:3,z:2},color:"#A0A0A0"},{type:"cylinder",position:{x:8,y:0,z:4},color:"#808080"},{type:"cylinder",position:{x:8,y:1,z:4},color:"#808080"},{type:"cylinder",position:{x:8,y:2,z:4},color:"#909090"},{type:"cylinder",position:{x:8,y:3,z:4},color:"#A0A0A0"},{type:"pipeZ",position:{x:7,y:0,z:2},color:"#4682B4"},{type:"pipeZ",position:{x:7,y:0,z:3},color:"#4682B4"},{type:"pipeZ",position:{x:7,y:0,z:4},color:"#4682B4"},...R(12,0,1,6,6,"#606060"),{type:"tank",position:{x:13,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:13,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:13,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:16,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:16,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:16,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:13,y:0,z:5},color:"#D8D8D8"},{type:"tank",position:{x:13,y:1,z:5},color:"#D8D8D8"},{type:"tank",position:{x:13,y:2,z:5},color:"#D8D8D8"},{type:"tank",position:{x:16,y:0,z:5},color:"#D8D8D8"},{type:"tank",position:{x:16,y:1,z:5},color:"#D8D8D8"},{type:"tank",position:{x:16,y:2,z:5},color:"#D8D8D8"},{type:"stairs",position:{x:14,y:0,z:2},color:"#FFD700"},{type:"stairs",position:{x:14,y:1,z:2},color:"#FFD700"},{type:"pillar",position:{x:6,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:6,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:11,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:11,y:1,z:3},color:"#505050"},{type:"pipeX",position:{x:5,y:1,z:3},color:"#708090"},{type:"pipeX",position:{x:6,y:1,z:3},color:"#708090"},{type:"pipeX",position:{x:7,y:1,z:3},color:"#2F4F4F"},{type:"pipeX",position:{x:8,y:1,z:3},color:"#2F4F4F"},{type:"pipeX",position:{x:9,y:1,z:3},color:"#4682B4"},{type:"pipeX",position:{x:10,y:1,z:3},color:"#4682B4"},{type:"pipeX",position:{x:11,y:1,z:3},color:"#708090"},{type:"pipeX",position:{x:12,y:1,z:3},color:"#708090"},{type:"pillar",position:{x:0,y:0,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:1,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:2,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:3,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:4,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:5,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:6,z:7},color:"#505050"},{type:"cone",position:{x:0,y:7,z:7},color:"#FF4500"},{type:"oilTank",position:{x:1,y:0,z:8},color:"#708090"},{type:"pipeX",position:{x:0,y:0,z:8},color:"#505050"},...R(1,0,10,5,4,"#808080"),...ht(1,1,10,5,4,"#F5F5DC"),...ht(1,2,10,5,4,"#F5F5DC"),...R(1,3,10,5,4,"#696969"),{type:"doorFrame",position:{x:3,y:1,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:2,y:2,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:4,y:2,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:1,y:2,z:12},color:"#8B4513"},{type:"windowFrame",position:{x:5,y:2,z:12},color:"#8B4513"},{type:"acUnit",position:{x:3,y:3,z:12},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:3,z:10},color:"#505050"},...R(8,0,9,6,5,"#404040"),{type:"pipeY",position:{x:9,y:0,z:11},color:"#708090"},{type:"pipeY",position:{x:9,y:1,z:11},color:"#708090"},{type:"pipeElbowXY",position:{x:9,y:2,z:11},color:"#708090"},{type:"pipeY",position:{x:12,y:0,z:11},color:"#708090"},{type:"pipeY",position:{x:12,y:1,z:11},color:"#708090"},{type:"pipeElbowXY",position:{x:12,y:2,z:11},color:"#708090"},{type:"valve",position:{x:9,y:1,z:11},color:"#FFD700"},{type:"valve",position:{x:12,y:1,z:11},color:"#FFD700"},{type:"oilTankSmall",position:{x:15,y:0,z:9},color:"#B22222"},{type:"oilTankSmall",position:{x:16,y:0,z:9},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:17,y:0,z:9},color:"#4A6B4A"},{type:"oilTankSmall",position:{x:15,y:0,z:11},color:"#B8860B"},{type:"oilTankSmall",position:{x:16,y:0,z:11},color:"#4682B4"},{type:"oilTankSmall",position:{x:17,y:0,z:11},color:"#1a1a1a"},{type:"transformer",position:{x:15,y:0,z:13},color:"#505050"},{type:"transformer",position:{x:16,y:0,z:13},color:"#505050"},{type:"powerBox",position:{x:17,y:0,z:13},color:"#2F4F4F"},{type:"conduitX",position:{x:14,y:0,z:13},color:"#505050"},{type:"conduitX",position:{x:13,y:0,z:13},color:"#505050"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:17,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:13},color:"#FFD700"},{type:"barrier",position:{x:7,y:0,z:13},color:"#FFD700"},{type:"trafficCone",position:{x:8,y:0,z:8},color:"#FF6600"},{type:"trafficCone",position:{x:13,y:0,z:8},color:"#FF6600"},{type:"sign",position:{x:6,y:0,z:0},color:"#FFD700"},{type:"sign",position:{x:11,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:6,y:0,z:6},color:"#B22222"},{type:"pipeY",position:{x:11,y:0,z:6},color:"#B22222"},{type:"lightFixture",position:{x:3,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:9,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:15,y:0,z:0},color:"#FFFF99"},{type:"spotlight",position:{x:2,y:4,z:2},color:"#FFFF99"},{type:"spotlight",position:{x:4,y:3,z:5},color:"#FFFF99"}]},tankerLoadingStation:{name:"Tanker Loading Station",category:"oil",description:"Truck and rail tanker loading facility with metering and safety systems",blocks:[...R(0,0,0,14,10,"#707070"),...R(0,0,4,3,2,"#404040"),...R(3,0,1,8,4,"#505050"),{type:"pillar",position:{x:4,y:0,z:1},color:"#606060"},{type:"pillar",position:{x:4,y:1,z:1},color:"#606060"},{type:"pillar",position:{x:4,y:2,z:1},color:"#606060"},{type:"pillar",position:{x:4,y:0,z:4},color:"#606060"},{type:"pillar",position:{x:4,y:1,z:4},color:"#606060"},{type:"pillar",position:{x:4,y:2,z:4},color:"#606060"},{type:"beamZ",position:{x:4,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:4,y:3,z:3},color:"#505050"},{type:"pipeY",position:{x:4,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:4,y:1,z:2},color:"#708090"},{type:"pipeElbowXY",position:{x:4,y:2,z:2},color:"#708090"},{type:"valve",position:{x:4,y:1,z:2},color:"#B22222"},{type:"pillar",position:{x:7,y:0,z:1},color:"#606060"},{type:"pillar",position:{x:7,y:1,z:1},color:"#606060"},{type:"pillar",position:{x:7,y:2,z:1},color:"#606060"},{type:"pillar",position:{x:7,y:0,z:4},color:"#606060"},{type:"pillar",position:{x:7,y:1,z:4},color:"#606060"},{type:"pillar",position:{x:7,y:2,z:4},color:"#606060"},{type:"beamZ",position:{x:7,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:7,y:3,z:3},color:"#505050"},{type:"pipeY",position:{x:7,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:7,y:1,z:2},color:"#708090"},{type:"pipeElbowXY",position:{x:7,y:2,z:2},color:"#708090"},{type:"valve",position:{x:7,y:1,z:2},color:"#B22222"},{type:"pillar",position:{x:10,y:0,z:1},color:"#606060"},{type:"pillar",position:{x:10,y:1,z:1},color:"#606060"},{type:"pillar",position:{x:10,y:2,z:1},color:"#606060"},{type:"pillar",position:{x:10,y:0,z:4},color:"#606060"},{type:"pillar",position:{x:10,y:1,z:4},color:"#606060"},{type:"pillar",position:{x:10,y:2,z:4},color:"#606060"},{type:"beamZ",position:{x:10,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:10,y:3,z:3},color:"#505050"},{type:"pipeY",position:{x:10,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:10,y:1,z:2},color:"#708090"},{type:"pipeElbowXY",position:{x:10,y:2,z:2},color:"#708090"},{type:"valve",position:{x:10,y:1,z:2},color:"#B22222"},{type:"slab",position:{x:4,y:3,z:1},color:"#404040"},{type:"slab",position:{x:5,y:3,z:1},color:"#404040"},{type:"slab",position:{x:6,y:3,z:1},color:"#404040"},{type:"slab",position:{x:7,y:3,z:1},color:"#404040"},{type:"slab",position:{x:8,y:3,z:1},color:"#404040"},{type:"slab",position:{x:9,y:3,z:1},color:"#404040"},{type:"slab",position:{x:10,y:3,z:1},color:"#404040"},{type:"slab",position:{x:4,y:3,z:4},color:"#404040"},{type:"slab",position:{x:5,y:3,z:4},color:"#404040"},{type:"slab",position:{x:6,y:3,z:4},color:"#404040"},{type:"slab",position:{x:7,y:3,z:4},color:"#404040"},{type:"slab",position:{x:8,y:3,z:4},color:"#404040"},{type:"slab",position:{x:9,y:3,z:4},color:"#404040"},{type:"slab",position:{x:10,y:3,z:4},color:"#404040"},...R(3,0,5,4,2,"#606060"),{type:"cylinder",position:{x:4,y:0,z:5},color:"#2F4F4F"},{type:"cylinder",position:{x:5,y:0,z:5},color:"#2F4F4F"},{type:"cylinder",position:{x:4,y:0,z:6},color:"#2F4F4F"},{type:"cylinder",position:{x:5,y:0,z:6},color:"#2F4F4F"},{type:"valve",position:{x:4,y:0,z:5},color:"#FFD700"},{type:"valve",position:{x:5,y:0,z:6},color:"#FFD700"},{type:"pipeZ",position:{x:4,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:4,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:5,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:6,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:9,y:0,z:3},color:"#708090"},{type:"oilTankSmall",position:{x:8,y:0,z:6},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:9,y:0,z:6},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:10,y:0,z:6},color:"#4A6B4A"},{type:"tank",position:{x:12,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:12,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:12,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:12,y:0,z:5},color:"#C0C0C0"},{type:"tank",position:{x:12,y:1,z:5},color:"#C0C0C0"},{type:"tank",position:{x:12,y:2,z:5},color:"#C0C0C0"},{type:"pipeZ",position:{x:11,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:11,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:10,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:9,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:7,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:6,y:0,z:4},color:"#708090"},{type:"valve",position:{x:11,y:0,z:3},color:"#B22222"},{type:"valve",position:{x:11,y:0,z:4},color:"#B22222"},{type:"cube",position:{x:1,y:0,z:1},color:"#F5F5DC"},{type:"cube",position:{x:2,y:0,z:1},color:"#F5F5DC"},{type:"cube",position:{x:1,y:0,z:2},color:"#F5F5DC"},{type:"cube",position:{x:2,y:0,z:2},color:"#F5F5DC"},{type:"cube",position:{x:1,y:1,z:1},color:"#F5F5DC"},{type:"cube",position:{x:2,y:1,z:1},color:"#F5F5DC"},{type:"cube",position:{x:1,y:1,z:2},color:"#F5F5DC"},{type:"cube",position:{x:2,y:1,z:2},color:"#F5F5DC"},{type:"slab",position:{x:1,y:2,z:1},color:"#696969"},{type:"slab",position:{x:2,y:2,z:1},color:"#696969"},{type:"slab",position:{x:1,y:2,z:2},color:"#696969"},{type:"slab",position:{x:2,y:2,z:2},color:"#696969"},{type:"doorFrame",position:{x:1,y:0,z:1},color:"#8B4513"},{type:"windowFrame",position:{x:2,y:1,z:1},color:"#8B4513"},{type:"acUnit",position:{x:1,y:2,z:2},color:"#C0C0C0"},...R(8,0,8,3,2,"#606060"),{type:"cylinder",position:{x:8,y:0,z:8},color:"#2F4F4F"},{type:"cylinder",position:{x:9,y:0,z:8},color:"#2F4F4F"},{type:"cylinder",position:{x:10,y:0,z:8},color:"#2F4F4F"},{type:"pipeX",position:{x:7,y:0,z:8},color:"#708090"},{type:"pipeX",position:{x:11,y:0,z:8},color:"#708090"},{type:"valve",position:{x:7,y:0,z:8},color:"#FF4500"},{type:"transformer",position:{x:1,y:0,z:8},color:"#505050"},{type:"powerBox",position:{x:2,y:0,z:8},color:"#2F4F4F"},{type:"conduitX",position:{x:3,y:0,z:8},color:"#505050"},{type:"conduitX",position:{x:4,y:0,z:8},color:"#505050"},{type:"conduitX",position:{x:5,y:0,z:8},color:"#505050"},{type:"conduitX",position:{x:6,y:0,z:8},color:"#505050"},{type:"barrier",position:{x:0,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:6},color:"#FFD700"},{type:"barrier",position:{x:13,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:13,y:0,z:9},color:"#FFD700"},{type:"trafficCone",position:{x:3,y:0,z:2},color:"#FF6600"},{type:"trafficCone",position:{x:3,y:0,z:3},color:"#FF6600"},{type:"trafficCone",position:{x:11,y:0,z:2},color:"#FF6600"},{type:"trafficCone",position:{x:11,y:0,z:3},color:"#FF6600"},{type:"sign",position:{x:0,y:0,z:4},color:"#FFD700"},{type:"sign",position:{x:6,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:3,y:0,z:1},color:"#B22222"},{type:"pipeY",position:{x:11,y:0,z:1},color:"#B22222"},{type:"drain",position:{x:5,y:0,z:2},color:"#404040"},{type:"drain",position:{x:8,y:0,z:2},color:"#404040"},{type:"grate",position:{x:6,y:0,z:2},color:"#505050"},{type:"grate",position:{x:9,y:0,z:2},color:"#505050"},{type:"beamZ",position:{x:4,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:4,y:3,z:3},color:"#505050"},{type:"beamZ",position:{x:7,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:7,y:3,z:3},color:"#505050"},{type:"lightFixture",position:{x:4,y:3,z:2},color:"#FFFF99"},{type:"lightFixture",position:{x:7,y:3,z:2},color:"#FFFF99"},{type:"lightFixture",position:{x:10,y:3,z:2},color:"#FFFF99"},{type:"lightFixture",position:{x:0,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:13,y:0,z:5},color:"#FFFF99"},{type:"oilBarrel",position:{x:1,y:0,z:6},color:"#1a1a1a"},{type:"oilBarrel",position:{x:2,y:0,z:6},color:"#B22222"},{type:"oilBarrel",position:{x:1,y:0,z:7},color:"#2F4F4F"}]}};function R(y,t,e,o,i,s){const n=[];for(let r=0;r<o;r++)for(let a=0;a<i;a++)n.push({type:"cube",position:{x:y+r,y:t,z:e+a},color:s});return n}function ht(y,t,e,o,i,s){const n=[];for(let r=0;r<o;r++)for(let a=0;a<i;a++)(r===0||r===o-1||a===0||a===i-1)&&n.push({type:"cube",position:{x:y+r,y:t,z:e+a},color:s});return n}function vt(y,t,e,o,i,s,n){const r=[];for(let a=0;a<o;a++)for(let l=0;l<i;l++)if(a===0||a===o-1||l===0||l===i-1){const p=(a+l)%2===0;r.push({type:"cube",position:{x:y+a,y:t,z:e+l},color:p?n:s})}return r}function at(y,t,e,o,i,s){const n=[];for(let r=0;r<o;r++)for(let a=0;a<i;a++)n.push({type:"cube",position:{x:y+r,y:t+a,z:e},color:s});return n}function st(y,t,e,o,i,s){const n=[];for(let r=0;r<o;r++)for(let a=0;a<i;a++)n.push({type:"cube",position:{x:y,y:t+a,z:e+r},color:s});return n}function Q(y,t,e,o,i,s,n){const r=[];for(let a=0;a<o;a++){const l=i==="X"?{x:y+a,y:t,z:e}:{x:y,y:t,z:e+a};r.push({type:s,position:l,color:n})}return r}function xl(){return Object.entries(ml).map(([y,t])=>({id:y,label:t.label,templates:t.templates.map(e=>{var o,i;return{id:e,name:((o=Ji[e])==null?void 0:o.name)||e,description:((i=Ji[e])==null?void 0:i.description)||""}})}))}function gl(y){return Ji[y]||null}function bl(y,t,e,o){const i=[],s=Math.round(o);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++)for(let a=-s;a<=s;a++)n*n+r*r+a*a<=s*s&&i.push({x:Math.floor(y)+n,y:Math.floor(t)+r,z:Math.floor(e)+a});return i}function zl(y,t,e,o){const i=[],s=Math.floor(o/2);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++)for(let a=-s;a<=s;a++)i.push({x:Math.floor(y)+n,y:Math.floor(t)+r,z:Math.floor(e)+a});return i}function vl(y,t,e,o){const i=[],s=Math.floor(o/2);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++)for(let a=-s;a<=s;a++)(Math.abs(n)===s||Math.abs(r)===s||Math.abs(a)===s)&&i.push({x:Math.floor(y)+n,y:Math.floor(t)+r,z:Math.floor(e)+a});return i}function Fl(y,t,e,o,i){const s=[],n=Math.round(o),r=Math.round(i);for(let a=0;a<r;a++)for(let l=-n;l<=n;l++)for(let p=-n;p<=n;p++)l*l+p*p<=n*n&&s.push({x:Math.floor(y)+l,y:Math.floor(t)+a,z:Math.floor(e)+p});return s}function wl(y,t,e,o){const i=[],s=Math.round(o);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++){const a=n*n+r*r;a<=s*s&&a>(s-1)*(s-1)&&i.push({x:Math.floor(y)+n,y:Math.floor(t),z:Math.floor(e)+r})}return i}function kl(y,t,e,o){const i=[],s=Math.round(o);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++)n*n+r*r<=s*s&&i.push({x:Math.floor(y)+n,y:Math.floor(t),z:Math.floor(e)+r});return i}function Bl(y,t,e,o){const i=[],s=Math.round(o);for(let n=-s;n<=s;n++)for(let r=0;r<=s;r++)for(let a=-s;a<=s;a++)n*n+r*r+a*a<=s*s&&i.push({x:Math.floor(y)+n,y:Math.floor(t)+r,z:Math.floor(e)+a});return i}function Cl(y,t,e,o,i,s){const n=[],r=Math.abs(o-y),a=Math.abs(i-t),l=Math.abs(s-e),p=y<o?1:-1,h=t<i?1:-1,u=e<s?1:-1,c=Math.max(r,a,l);let f=Math.floor(y),d=Math.floor(t),m=Math.floor(e),x=c/2,g=c/2,b=c/2;for(let z=0;z<=c;z++)n.push({x:f,y:d,z:m}),x-=r,g-=a,b-=l,x<0&&(x+=c,f+=p),g<0&&(g+=c,d+=h),b<0&&(b+=c,m+=u);return n}function Al(y,t,e,o,i,s){const n=[],r=Math.min(Math.floor(y),Math.floor(o)),a=Math.max(Math.floor(y),Math.floor(o)),l=Math.min(Math.floor(t),Math.floor(i)),p=Math.max(Math.floor(t),Math.floor(i)),h=Math.min(Math.floor(e),Math.floor(s)),u=Math.max(Math.floor(e),Math.floor(s));for(let c=r;c<=a;c++)for(let f=l;f<=p;f++)for(let d=h;d<=u;d++)n.push({x:c,y:f,z:d});return n}function Vs(y,t,e){const o=e.x-t.x,i=e.y-t.y,s=e.z-t.z,n=Math.sqrt(o*o+i*i+s*s),r=Math.max(1,Math.round(n));switch(y){case"sphere":return bl(t.x,t.y,t.z,r);case"cube":return zl(t.x,t.y,t.z,r*2);case"hollowCube":return vl(t.x,t.y,t.z,r*2);case"cylinder":const a=Math.sqrt(o*o+s*s),l=Math.max(1,Math.round(a)),p=Math.max(1,Math.abs(Math.round(i))||l);return Fl(t.x,t.y,t.z,l,p);case"circle":return wl(t.x,t.y,t.z,r);case"disc":return kl(t.x,t.y,t.z,r);case"dome":return Bl(t.x,t.y,t.z,r);case"line3d":return Cl(t.x,t.y,t.z,e.x,e.y,e.z);case"wall":return Al(t.x,t.y,t.z,e.x,e.y,e.z);default:return[]}}class Ml{constructor(){this.layers=new Map,this.activeLayerId="default",this.onLayerChange=null,this.createLayer("default","Default","#ffffff")}createLayer(t,e,o="#ffffff"){if(this.layers.has(t))return console.warn(`Layer "${t}" already exists`),this.layers.get(t);const i={id:t,name:e,color:o,visible:!0,locked:!1,opacity:1,order:this.layers.size};return this.layers.set(t,i),this.notifyChange(),i}deleteLayer(t){return t==="default"?(console.warn("Cannot delete default layer"),!1):this.layers.has(t)?(this.layers.delete(t),this.activeLayerId===t&&(this.activeLayerId="default"),this.notifyChange(),!0):!1}getLayer(t){return this.layers.get(t)||null}getAllLayers(){return Array.from(this.layers.values()).sort((t,e)=>t.order-e.order)}setActiveLayer(t){return this.layers.has(t)?(this.activeLayerId=t,this.notifyChange(),!0):(console.warn(`Layer "${t}" does not exist`),!1)}getActiveLayer(){return this.layers.get(this.activeLayerId)}setLayerVisible(t,e){const o=this.layers.get(t);return o?(o.visible=e,this.notifyChange(),!0):!1}setLayerLocked(t,e){const o=this.layers.get(t);return o?(o.locked=e,this.notifyChange(),!0):!1}setLayerOpacity(t,e){const o=this.layers.get(t);return o?(o.opacity=Math.max(0,Math.min(1,e)),this.notifyChange(),!0):!1}setLayerName(t,e){const o=this.layers.get(t);return o?(o.name=e,this.notifyChange(),!0):!1}setLayerColor(t,e){const o=this.layers.get(t);return o?(o.color=e,this.notifyChange(),!0):!1}isLayerVisible(t){const e=this.layers.get(t);return e?e.visible:!0}isLayerLocked(t){const e=this.layers.get(t);return e?e.locked:!1}canEditLayer(t){const e=this.layers.get(t);return e?e.visible&&!e.locked:!1}moveLayerUp(t){const e=this.getAllLayers(),o=e.findIndex(i=>i.id===t);if(o>0){const i=e[o].order;return e[o].order=e[o-1].order,e[o-1].order=i,this.notifyChange(),!0}return!1}moveLayerDown(t){const e=this.getAllLayers(),o=e.findIndex(i=>i.id===t);if(o<e.length-1&&o>=0){const i=e[o].order;return e[o].order=e[o+1].order,e[o+1].order=i,this.notifyChange(),!0}return!1}notifyChange(){this.onLayerChange&&this.onLayerChange(this.getAllLayers(),this.activeLayerId)}generateLayerId(){let t=1;for(;this.layers.has(`layer_${t}`);)t++;return`layer_${t}`}toJSON(){return{layers:Array.from(this.layers.values()),activeLayerId:this.activeLayerId}}fromJSON(t){if(this.layers.clear(),t.layers&&Array.isArray(t.layers))for(const e of t.layers)this.layers.set(e.id,{...e});this.layers.has("default")||this.createLayer("default","Default","#ffffff"),this.activeLayerId=t.activeLayerId||"default",this.layers.has(this.activeLayerId)||(this.activeLayerId="default"),this.notifyChange()}clear(){this.layers.clear(),this.createLayer("default","Default","#ffffff"),this.activeLayerId="default",this.notifyChange()}}function Qn(y,t,e){const o={...y};switch(t){case"x":o.x=2*e.x-y.x-1;break;case"y":o.y=2*e.y-y.y-1;break;case"z":o.z=2*e.z-y.z-1;break}return o}function tr(y,t){const e={...y};switch(t){case"x":e.y=(360-e.y)%360,e.z=(360-e.z)%360;break;case"y":e.x=(360-e.x)%360,e.z=(360-e.z)%360;break;case"z":e.x=(360-e.x)%360,e.y=(360-e.y)%360;break}return e}function er(y){if(y.length===0)return{x:0,y:0,z:0};let t=1/0,e=1/0,o=1/0,i=-1/0,s=-1/0,n=-1/0;for(const r of y){const a=r.gridPosition;t=Math.min(t,a.x),e=Math.min(e,a.y),o=Math.min(o,a.z),i=Math.max(i,a.x+1),s=Math.max(s,a.y+1),n=Math.max(n,a.z+1)}return{x:(t+i)/2,y:(e+s)/2,z:(o+n)/2}}function El(y,t,e){const o=Qn(y.gridPosition,t,e),i=tr(y.rotation,t);return{type:y.type,position:o,dimensions:{...y.dimensions},rotation:i,color:y.color,emissive:y.emissive?{...y.emissive}:null,faces:y.faces?JSON.parse(JSON.stringify(y.faces)):null,layerId:y.layerId}}function _l(y,t,e=null){if(y.length===0)return[];const o=e||er(y),i=[];for(const s of y)i.push(El(s,t,o));return i}class Sl{constructor(t){this.blockManager=t,this.symmetryMode=null,this.symmetryCenter={x:0,y:0,z:0}}setSymmetryMode(t){this.symmetryMode=t}setSymmetryCenter(t){this.symmetryCenter={...t}}getSymmetricBlockData(t){return this.symmetryMode?{...t,position:Qn(t.position,this.symmetryMode,this.symmetryCenter),rotation:tr(t.rotation||{x:0,y:0,z:0},this.symmetryMode)}:null}mirrorSelectedBlocks(t,e=!0){const o=this.blockManager.getSelectedBlocks();if(o.length===0)return[];const i=er(o),s=_l(o,t,i);if(e){const n=[];for(const r of s)if(!this.blockManager.wouldOverlapAt(r.type,r.position,r.dimensions)){const a=this.blockManager.addBlock(r);a&&n.push(a)}return n}return s}}class Tl{constructor(t,e){this.camera=t,this.controls=e,this.bookmarks=new Map,this.onBookmarksChange=null}saveBookmark(t){const e=`bookmark_${Date.now()}`,o={id:e,name:t,position:{x:this.camera.position.x,y:this.camera.position.y,z:this.camera.position.z},target:{x:this.controls.target.x,y:this.controls.target.y,z:this.controls.target.z},zoom:this.camera.zoom};return this.bookmarks.set(e,o),this.notifyChange(),o}restoreBookmark(t,e=!0){const o=this.bookmarks.get(t);return o?(e?this.animateTo(o.position,o.target,500):(this.camera.position.set(o.position.x,o.position.y,o.position.z),this.controls.target.set(o.target.x,o.target.y,o.target.z),this.controls.update()),!0):!1}animateTo(t,e,o=500){const i={x:this.camera.position.x,y:this.camera.position.y,z:this.camera.position.z},s={x:this.controls.target.x,y:this.controls.target.y,z:this.controls.target.z},n=performance.now(),r=()=>{const a=performance.now()-n,l=Math.min(a/o,1),p=1-Math.pow(1-l,3);this.camera.position.x=i.x+(t.x-i.x)*p,this.camera.position.y=i.y+(t.y-i.y)*p,this.camera.position.z=i.z+(t.z-i.z)*p,this.controls.target.x=s.x+(e.x-s.x)*p,this.controls.target.y=s.y+(e.y-s.y)*p,this.controls.target.z=s.z+(e.z-s.z)*p,this.controls.update(),l<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}deleteBookmark(t){return this.bookmarks.has(t)?(this.bookmarks.delete(t),this.notifyChange(),!0):!1}renameBookmark(t,e){const o=this.bookmarks.get(t);return o?(o.name=e,this.notifyChange(),!0):!1}getAllBookmarks(){return Array.from(this.bookmarks.values())}goToPreset(t){const o={front:{position:{x:0,y:5,z:15},target:{x:0,y:0,z:0}},back:{position:{x:0,y:5,z:-15},target:{x:0,y:0,z:0}},left:{position:{x:-15,y:5,z:0},target:{x:0,y:0,z:0}},right:{position:{x:15,y:5,z:0},target:{x:0,y:0,z:0}},top:{position:{x:0,y:20,z:.01},target:{x:0,y:0,z:0}},iso:{position:{x:10,y:10,z:10},target:{x:0,y:0,z:0}}}[t];o&&this.animateTo(o.position,o.target)}notifyChange(){this.onBookmarksChange&&this.onBookmarksChange(this.getAllBookmarks())}toJSON(){return{bookmarks:Array.from(this.bookmarks.values())}}fromJSON(t){if(this.bookmarks.clear(),t&&t.bookmarks&&Array.isArray(t.bookmarks))for(const e of t.bookmarks)this.bookmarks.set(e.id,e);this.notifyChange()}clear(){this.bookmarks.clear(),this.notifyChange()}}class Dl{constructor(t,e,o){this.camera=t,this.controls=e,this.cameraBookmarks=o,this.isPlaying=!1,this.currentFrame=0,this.animationFrameId=null,this.curveType="easeInOut"}interpolate(t,e,o,i=null){const s=i||this.curveType;let n=o;switch(s){case"linear":n=o;break;case"easeIn":n=o*o;break;case"easeOut":n=1-Math.pow(1-o,2);break;case"easeInOut":n=o<.5?2*o*o:1-Math.pow(-2*o+2,2)/2;break;case"smoothstep":n=o*o*(3-2*o);break;default:n=o<.5?2*o*o:1-Math.pow(-2*o+2,2)/2;break}const r={x:t.position.x+(e.position.x-t.position.x)*n,y:t.position.y+(e.position.y-t.position.y)*n,z:t.position.z+(e.position.z-t.position.z)*n},a={x:t.target.x+(e.target.x-t.target.x)*n,y:t.target.y+(e.target.y-t.target.y)*n,z:t.target.z+(e.target.z-t.target.z)*n};return{position:r,target:a}}getCameraAtFrame(t,e,o){if(o.length<2)throw new Error("Need at least 2 bookmarks for camera path");t=Math.max(0,Math.min(t,e-1));const i=t/(e-1);if(o.length===2)return this.interpolate(o[0],o[1],i);const s=o.length-1,n=i*s,r=Math.floor(n),a=n-r;return r>=s?{position:{...o[o.length-1].position},target:{...o[o.length-1].target}}:this.interpolate(o[r],o[r+1],a)}setCameraState(t){this.camera.position.set(t.position.x,t.position.y,t.position.z),this.controls.target.set(t.target.x,t.target.y,t.target.z),this.controls.update()}preview(t,e=3e3,o=null){if(t.length<2){console.warn("Need at least 2 bookmarks to preview");return}this.stop();const i=performance.now(),n=Math.floor(e/1e3*60),r=()=>{const a=performance.now()-i,l=Math.min(a/e,1),p=Math.floor(l*n),h=this.getCameraAtFrame(p,n,t);this.setCameraState(h),l<1?this.animationFrameId=requestAnimationFrame(r):(this.isPlaying=!1,o&&o())};this.isPlaying=!0,this.animationFrameId=requestAnimationFrame(r)}stop(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.isPlaying=!1}async renderSequence(t,e,o,i){if(t.length<2)throw new Error("Need at least 2 bookmarks to render sequence");this.stop();for(let s=0;s<e;s++){const n=this.getCameraAtFrame(s,e,t);this.setCameraState(n),o&&await o(s,e),await this.sleep(1)}i&&i()}sleep(t){return new Promise(e=>setTimeout(e,t))}}class Eo{constructor(t,e){this.engine=t,this.blockManager=e,this.enabled=!1,this.style="clean",this.inverted=!1,this.grayscale=!1,this.threshold=.5,this.lineWidth=2,this.showFills=!0,this.quality="medium",this.targetFPS=30,this.lastRenderTime=0,this.renderInterval=1e3/this.targetFPS,this.sceneHash=null,this.cachedImageData=null,this.cacheValid=!1,this.overlayCanvas=null,this.overlayCtx=null,this._tempVec3=new U,this._tempVec3_2=new U,this._tempVec3_3=new U,this.noiseSeed=Math.random()*1e3,window.addEventListener("resize",()=>this.onResize())}onResize(){this.overlayCanvas&&(this.overlayCanvas.width=window.innerWidth,this.overlayCanvas.height=window.innerHeight,this.enabled&&this.render())}setEnabled(t){this.enabled=t,t?(this.createOverlay(),this.render()):this.removeOverlay()}setStyle(t){this.style=t,this.enabled&&this.render()}setInverted(t){this.inverted=t,this.enabled&&this.render()}setGrayscale(t){this.grayscale=t,this.invalidateCache(),this.enabled&&this.render()}setThreshold(t){this.threshold=Math.max(0,Math.min(1,t)),this.enabled&&this.render()}setLineWidth(t){this.lineWidth=t,this.enabled&&this.render()}setShowFills(t){this.showFills=t,this.enabled&&this.render()}setQuality(t){this.quality=t,this.invalidateCache(),this.enabled&&this.render()}invalidateCache(){this.cacheValid=!1,this.sceneHash=null}generateSceneHash(){const t=this.engine.camera,e=`${t.position.x.toFixed(1)},${t.position.y.toFixed(1)},${t.position.z.toFixed(1)}`,o=`${t.rotation.x.toFixed(2)},${t.rotation.y.toFixed(2)},${t.rotation.z.toFixed(2)}`,i=this.blockManager.getAllBlocks().length,s=this.blockManager.getMergedMeshes?this.blockManager.getMergedMeshes().length:0,n=`${this.style}-${this.inverted}-${this.grayscale}-${this.threshold}-${this.quality}`;return`${e}|${o}|${i}|${s}|${n}`}getQualityMultiplier(){switch(this.quality){case"low":return .5;case"high":return 1.5;default:return 1}}createOverlay(){this.overlayCanvas||(this.overlayCanvas=document.createElement("canvas"),this.overlayCanvas.id="tattoo-overlay",this.overlayCanvas.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    `,this.overlayCanvas.width=window.innerWidth,this.overlayCanvas.height=window.innerHeight,this.overlayCtx=this.overlayCanvas.getContext("2d"),document.getElementById("app").appendChild(this.overlayCanvas))}removeOverlay(){this.overlayCanvas&&this.overlayCanvas.parentNode&&this.overlayCanvas.parentNode.removeChild(this.overlayCanvas),this.overlayCanvas=null,this.overlayCtx=null}getColors(){const t={clean:{bg:"#ffffff",fg:"#000000",accent:"#000000"},sketch:{bg:"#f5f5dc",fg:"#2c2c2c",accent:"#4a4a4a"},ink:{bg:"#fffef0",fg:"#1a1a1a",accent:"#000000"},crosshatch:{bg:"#ffffff",fg:"#000000",accent:"#444444"},blueprint:{bg:"#1e3a5f",fg:"#87ceeb",accent:"#add8e6"},comic:{bg:"#ffffff",fg:"#000000",accent:"#ff0000"},saturated:{bg:"#ffffff",fg:"#000000",accent:"#333333",preserveColor:!0},neon:{bg:"#0a0a0f",fg:"#00ffff",accent:"#ff00ff",glow:!0},scifi:{bg:"#0d1117",fg:"#58a6ff",accent:"#238636",grid:!0},watercolor:{bg:"#faf8f5",fg:"#2c4a52",accent:"#8b4513",soft:!0},noir:{bg:"#000000",fg:"#ffffff",accent:"#808080",highContrast:!0},synthwave:{bg:"#1a1a2e",fg:"#ff6ec7",accent:"#00fff7",gradient:!0},ascii:{bg:"#000000",fg:"#00ff00",accent:"#00aa00",monospace:!0}};let e=t[this.style]||t.clean;return this.inverted&&(e={...e,bg:e.fg,fg:e.bg}),e}render(t=!1){if(!this.enabled||!this.overlayCanvas)return;const e=performance.now();if(!t&&e-this.lastRenderTime<this.renderInterval)return;this.lastRenderTime=e;const o=this.overlayCanvas.width,i=this.overlayCanvas.height,s=this.overlayCtx,n=this.getColors(),r=this.generateSceneHash();if(this.cacheValid&&this.sceneHash===r&&this.cachedImageData){s.putImageData(this.cachedImageData,0,0);return}s.clearRect(0,0,o,i),s.fillStyle=n.bg,s.fillRect(0,0,o,i),this.style==="blueprint"?this.drawBlueprintGrid(s,o,i,n):this.style==="sketch"?this.drawPaperTexture(s,o,i):this.style==="scifi"?this.drawScifiBackground(s,o,i,n):this.style==="synthwave"?this.drawSynthwaveBackground(s,o,i,n):this.style==="neon"?this.drawNeonBackground(s,o,i,n):this.style==="watercolor"?this.drawWatercolorBackground(s,o,i,n):this.style==="ascii"&&this.drawAsciiBackground(s,o,i,n);const a=this.engine.camera;if(a.updateMatrixWorld(),this.style==="ascii"){const u=this.blockManager.getAllBlocks(),c=this.blockManager.getMergedMeshes?this.blockManager.getMergedMeshes():[];this.renderAsciiMode(s,u,c,a,o,i,n),this.cacheRenderedFrame(s,o,i,r);return}const l=[],p=this.blockManager.getAllBlocks(),h=this.blockManager.getMergedMeshes?this.blockManager.getMergedMeshes():[];for(const u of p)u.mesh.visible&&this.collectTriangles(u,a,l);for(const u of h)u.mesh.visible&&this.collectTrianglesFromMesh(u.mesh,u.color,a,l);l.sort((u,c)=>c.depth-u.depth),this.showFills&&this.renderFills(s,l,n),this.renderStyledEdges(s,p,h,a,o,i,n),this.cacheRenderedFrame(s,o,i,r)}cacheRenderedFrame(t,e,o,i){this.cachedImageData=t.getImageData(0,0,e,o),this.sceneHash=i,this.cacheValid=!0}renderFills(t,e,o){for(const i of e){const s=this.calculateLuminance(i.color);let n;if(this.style==="crosshatch"){this.drawCrosshatchTriangle(t,i,s,o);continue}else if(this.style==="comic"){this.drawComicTriangle(t,i,s,o);continue}else if(this.style==="saturated"){this.drawSaturatedTriangle(t,i,o);continue}else if(this.style==="neon"){this.drawNeonTriangle(t,i,s,o);continue}else if(this.style==="watercolor"){this.drawWatercolorTriangle(t,i,o);continue}else if(this.style==="noir"){this.drawNoirTriangle(t,i,s,o);continue}else if(this.style==="synthwave"){this.drawSynthwaveTriangle(t,i,o);continue}else if(this.style==="scifi"){this.drawScifiTriangle(t,i,s,o);continue}if(this.grayscale){let r=Math.round(s*255);this.inverted&&(r=255-r),n=`rgb(${r}, ${r}, ${r})`}else n=s>this.threshold?o.bg:o.fg;t.fillStyle=n,t.beginPath(),t.moveTo(i.points[0].x,i.points[0].y),t.lineTo(i.points[1].x,i.points[1].y),t.lineTo(i.points[2].x,i.points[2].y),t.closePath(),t.fill()}}renderStyledEdges(t,e,o,i,s,n,r){t.strokeStyle=r.fg,t.lineCap="round",t.lineJoin="round";const a=[];for(const l of e)l.mesh.visible&&a.push(...this.getEdgesFromBlock(l,i,s,n));for(const l of o)l.mesh.visible&&a.push(...this.getEdgesFromMerged(l,i,s,n));switch(this.style){case"sketch":this.drawSketchEdges(t,a,r);break;case"ink":this.drawInkEdges(t,a,r);break;case"blueprint":this.drawBlueprintEdges(t,a,r);break;case"comic":this.drawComicEdges(t,a,r);break;case"saturated":this.drawSaturatedEdges(t,a,r);break;case"neon":this.drawNeonEdges(t,a,r);break;case"scifi":this.drawScifiEdges(t,a,r);break;case"watercolor":this.drawWatercolorEdges(t,a,r);break;case"noir":this.drawNoirEdges(t,a,r);break;case"synthwave":this.drawSynthwaveEdges(t,a,r);break;default:this.drawCleanEdges(t,a,r)}}drawCleanEdges(t,e,o){t.strokeStyle=o.fg,t.lineWidth=this.lineWidth,t.beginPath();for(const i of e)t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2);t.stroke()}drawSketchEdges(t,e,o){t.strokeStyle=o.fg;for(const i of e)for(let s=0;s<2;s++){t.lineWidth=this.lineWidth*(.8+Math.random()*.4),t.beginPath();const n=8,r=(i.x2-i.x1)/n,a=(i.y2-i.y1)/n;t.moveTo(i.x1+this.sketchNoise(i.x1,i.y1,s)*2,i.y1+this.sketchNoise(i.y1,i.x1,s)*2);for(let l=1;l<=n;l++){const p=i.x1+r*l,h=i.y1+a*l,u=this.lineWidth*.5;t.lineTo(p+this.sketchNoise(p,h,s+l)*u,h+this.sketchNoise(h,p,s+l)*u)}t.stroke()}}drawInkEdges(t,e,o){t.strokeStyle=o.fg,t.fillStyle=o.fg;for(const i of e){const s=Math.sqrt(Math.pow(i.x2-i.x1,2)+Math.pow(i.y2-i.y1,2)),n=Math.max(4,Math.floor(s/10)),r=(i.x2-i.x1)/n,a=(i.y2-i.y1)/n;t.beginPath();for(let l=0;l<=n;l++){const p=l/n,h=i.x1+r*l,u=i.y1+a*l,c=Math.sin(p*Math.PI),f=this.lineWidth*(.5+c*1.5);l===0||(t.lineWidth=f,t.lineTo(h,u),t.stroke(),t.beginPath()),t.moveTo(h,u)}}}drawBlueprintEdges(t,e,o){t.shadowColor=o.fg,t.shadowBlur=2,t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*.8,t.beginPath();for(const s of e)t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2);t.stroke(),t.shadowBlur=0,t.fillStyle=o.accent;const i=new Set;for(const s of e)i.add(`${Math.round(s.x1)},${Math.round(s.y1)}`),i.add(`${Math.round(s.x2)},${Math.round(s.y2)}`);for(const s of i){const[n,r]=s.split(",").map(Number);t.beginPath(),t.arc(n,r,this.lineWidth,0,Math.PI*2),t.fill()}}drawComicEdges(t,e,o){t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*2,t.beginPath();for(const i of e)t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2);t.stroke(),t.strokeStyle=o.bg,t.lineWidth=this.lineWidth*.5,t.beginPath();for(const i of e)t.moveTo(i.x1+1,i.y1+-1),t.lineTo(i.x2+1,i.y2+-1);t.stroke()}drawSaturatedEdges(t,e,o){t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*.75,t.beginPath();for(const i of e)t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2);t.stroke()}drawNeonEdges(t,e,o){t.shadowColor=o.fg,t.shadowBlur=15,t.strokeStyle=o.fg,t.lineWidth=this.lineWidth,t.beginPath();for(const s of e)t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2);t.stroke(),t.shadowBlur=8,t.strokeStyle="#ffffff",t.lineWidth=this.lineWidth*.3,t.beginPath();for(const s of e)t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2);t.stroke(),t.shadowColor=o.accent,t.shadowBlur=12,t.strokeStyle=o.accent,t.lineWidth=this.lineWidth*.8,t.beginPath();let i=0;for(const s of e)i++%3===0&&(t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2));t.stroke(),t.shadowBlur=0}drawScifiEdges(t,e,o){t.shadowColor=o.fg,t.shadowBlur=3,t.strokeStyle=o.fg,t.lineWidth=this.lineWidth,t.beginPath();for(const s of e)t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2);t.stroke(),t.shadowBlur=0,t.fillStyle=o.accent;const i=new Set;for(const s of e)i.add(`${Math.round(s.x1)},${Math.round(s.y1)}`),i.add(`${Math.round(s.x2)},${Math.round(s.y2)}`);for(const s of i){const[n,r]=s.split(",").map(Number);t.beginPath(),t.arc(n,r,this.lineWidth*.8,0,Math.PI*2),t.fill()}}drawWatercolorEdges(t,e,o){for(let i=0;i<3;i++){t.globalAlpha=.3,t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*(2-i*.5),t.beginPath();for(const s of e)t.moveTo(s.x1+(Math.random()-.5)*2,s.y1+(Math.random()-.5)*2),t.lineTo(s.x2+(Math.random()-.5)*2,s.y2+(Math.random()-.5)*2);t.stroke()}t.globalAlpha=1}drawNoirEdges(t,e,o){t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*1.5,t.beginPath();for(const i of e)t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2);t.stroke()}drawSynthwaveEdges(t,e,o){t.shadowColor=o.fg,t.shadowBlur=8;for(const i of e){const s=t.createLinearGradient(i.x1,i.y1,i.x2,i.y2);s.addColorStop(0,o.fg),s.addColorStop(.5,o.accent),s.addColorStop(1,o.fg),t.strokeStyle=s,t.lineWidth=this.lineWidth,t.beginPath(),t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2),t.stroke()}t.shadowBlur=0}drawCrosshatchTriangle(t,e,o,i){t.fillStyle=i.bg,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill(),t.save(),t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.clip();const s=Math.floor((1-o)*4);t.strokeStyle=i.fg,t.lineWidth=1;const n=Math.min(e.points[0].x,e.points[1].x,e.points[2].x),r=Math.max(e.points[0].x,e.points[1].x,e.points[2].x),a=Math.min(e.points[0].y,e.points[1].y,e.points[2].y),l=Math.max(e.points[0].y,e.points[1].y,e.points[2].y),p=8-s*1.5;if(s>=1){t.beginPath();for(let h=n-(l-a);h<r+(l-a);h+=p)t.moveTo(h,l),t.lineTo(h+(l-a),a);t.stroke()}if(s>=2){t.beginPath();for(let h=n-(l-a);h<r+(l-a);h+=p)t.moveTo(h,a),t.lineTo(h+(l-a),l);t.stroke()}if(s>=3){t.beginPath();for(let h=a;h<l;h+=p*1.5)t.moveTo(n,h),t.lineTo(r,h);t.stroke()}t.restore()}drawComicTriangle(t,e,o,i){if(t.fillStyle=i.bg,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill(),o<.7){t.save(),t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.clip(),t.fillStyle=i.fg;const s=Math.min(e.points[0].x,e.points[1].x,e.points[2].x),n=Math.max(e.points[0].x,e.points[1].x,e.points[2].x),r=Math.min(e.points[0].y,e.points[1].y,e.points[2].y),a=Math.max(e.points[0].y,e.points[1].y,e.points[2].y),l=2+(1-o)*3,p=8;for(let h=s;h<n;h+=p)for(let u=r;u<a;u+=p)t.beginPath(),t.arc(h,u,l,0,Math.PI*2),t.fill();t.restore()}}drawSaturatedTriangle(t,e,o){const i=e.color.replace("#","");let s=parseInt(i.substr(0,2),16),n=parseInt(i.substr(2,2),16),r=parseInt(i.substr(4,2),16);const a=(s+n+r)/3,l=1.3;s=Math.min(255,Math.max(0,Math.round(a+(s-a)*l))),n=Math.min(255,Math.max(0,Math.round(a+(n-a)*l))),r=Math.min(255,Math.max(0,Math.round(a+(r-a)*l))),t.fillStyle=`rgb(${s}, ${n}, ${r})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill()}drawNeonTriangle(t,e,o,i){const s=e.color.replace("#","");let n=parseInt(s.substr(0,2),16),r=parseInt(s.substr(2,2),16),a=parseInt(s.substr(4,2),16);n=Math.round(n*.15),r=Math.round(r*.15),a=Math.round(a*.15),t.fillStyle=`rgb(${n}, ${r}, ${a})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill()}drawWatercolorTriangle(t,e,o){const i=e.color.replace("#","");let s=parseInt(i.substr(0,2),16),n=parseInt(i.substr(2,2),16),r=parseInt(i.substr(4,2),16);const a=(s+n+r)/3;s=Math.round(s*.7+a*.3+30),n=Math.round(n*.7+a*.3+30),r=Math.round(r*.7+a*.3+30),s=Math.min(255,s),n=Math.min(255,n),r=Math.min(255,r),t.globalAlpha=.7,t.fillStyle=`rgb(${s}, ${n}, ${r})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill(),t.globalAlpha=1}drawNoirTriangle(t,e,o,i){t.fillStyle=o>.45?i.bg:i.fg,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill()}drawSynthwaveTriangle(t,e,o){const i=e.color.replace("#","");let s=parseInt(i.substr(0,2),16),n=parseInt(i.substr(2,2),16),r=parseInt(i.substr(4,2),16);(s+n+r)/3/255>.5?(s=Math.min(255,Math.round(s*.7+100)),n=Math.round(n*.5),r=Math.min(255,Math.round(r*.7+80))):(s=Math.round(s*.4+40),n=Math.round(n*.3),r=Math.min(255,Math.round(r*.5+60))),t.fillStyle=`rgb(${s}, ${n}, ${r})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill()}drawScifiTriangle(t,e,o,i){const s=e.color.replace("#","");let n=parseInt(s.substr(0,2),16),r=parseInt(s.substr(2,2),16),a=parseInt(s.substr(4,2),16);n=Math.round(n*.4),r=Math.min(255,Math.round(r*.6+30)),a=Math.min(255,Math.round(a*.7+50)),t.globalAlpha=.85,t.fillStyle=`rgb(${n}, ${r}, ${a})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill(),t.globalAlpha=1}drawBlueprintGrid(t,e,o,i){t.strokeStyle=i.accent,t.globalAlpha=.3,t.lineWidth=.5;const s=20;t.beginPath();for(let n=0;n<e;n+=s)t.moveTo(n,0),t.lineTo(n,o);for(let n=0;n<o;n+=s)t.moveTo(0,n),t.lineTo(e,n);t.stroke(),t.globalAlpha=.5,t.lineWidth=1,t.beginPath();for(let n=0;n<e;n+=s*5)t.moveTo(n,0),t.lineTo(n,o);for(let n=0;n<o;n+=s*5)t.moveTo(0,n),t.lineTo(e,n);t.stroke(),t.globalAlpha=1}drawPaperTexture(t,e,o){t.globalAlpha=.03,t.fillStyle="#000000";for(let i=0;i<5e3;i++){const s=Math.random()*e,n=Math.random()*o;t.fillRect(s,n,1,1)}t.globalAlpha=1}drawScifiBackground(t,e,o,i){t.strokeStyle=i.fg,t.globalAlpha=.05,t.lineWidth=1,t.beginPath();for(let r=0;r<o;r+=3)t.moveTo(0,r),t.lineTo(e,r);t.stroke(),t.globalAlpha=.1,t.lineWidth=.5;const s=40;t.beginPath();for(let r=0;r<e;r+=s)t.moveTo(r,0),t.lineTo(r,o);for(let r=0;r<o;r+=s)t.moveTo(0,r),t.lineTo(e,r);t.stroke(),t.globalAlpha=.3,t.strokeStyle=i.accent,t.lineWidth=2;const n=50;t.beginPath(),t.moveTo(10,10+n),t.lineTo(10,10),t.lineTo(10+n,10),t.stroke(),t.beginPath(),t.moveTo(e-10-n,10),t.lineTo(e-10,10),t.lineTo(e-10,10+n),t.stroke(),t.beginPath(),t.moveTo(10,o-10-n),t.lineTo(10,o-10),t.lineTo(10+n,o-10),t.stroke(),t.beginPath(),t.moveTo(e-10-n,o-10),t.lineTo(e-10,o-10),t.lineTo(e-10,o-10-n),t.stroke(),t.globalAlpha=1}drawSynthwaveBackground(t,e,o,i){const s=t.createLinearGradient(0,0,0,o);s.addColorStop(0,"#0f0f23"),s.addColorStop(.5,"#1a1a2e"),s.addColorStop(1,"#16213e"),t.fillStyle=s,t.fillRect(0,0,e,o),t.strokeStyle=i.accent,t.globalAlpha=.4,t.lineWidth=1;const n=o*.6,r=15;for(let u=0;u<=r;u++){const c=u/r,f=n+(o-n)*Math.pow(c,.7);t.globalAlpha=.2+c*.3,t.beginPath(),t.moveTo(0,f),t.lineTo(e,f),t.stroke()}t.globalAlpha=.3;const a=e/2;for(let u=-r;u<=r;u++){const c=a+u*80;t.beginPath(),t.moveTo(a,n),t.lineTo(c,o),t.stroke()}const l=n-60,p=50,h=t.createRadialGradient(e/2,l,0,e/2,l,p);h.addColorStop(0,"#ff6ec7"),h.addColorStop(.7,"#ff6ec7"),h.addColorStop(1,"transparent"),t.globalAlpha=.6,t.fillStyle=h,t.beginPath(),t.arc(e/2,l,p,0,Math.PI*2),t.fill(),t.globalAlpha=1}drawNeonBackground(t,e,o,i){t.fillStyle=i.bg,t.fillRect(0,0,e,o);const s=t.createRadialGradient(e/2,o/2,0,e/2,o/2,Math.max(e,o)*.7);s.addColorStop(0,"transparent"),s.addColorStop(1,"rgba(0, 0, 0, 0.5)"),t.fillStyle=s,t.fillRect(0,0,e,o),t.globalAlpha=.05;for(let n=0;n<20;n++){const r=Math.random()*e,a=Math.random()*o,l=20+Math.random()*40,p=t.createRadialGradient(r,a,0,r,a,l);p.addColorStop(0,n%2===0?i.fg:i.accent),p.addColorStop(1,"transparent"),t.fillStyle=p,t.beginPath(),t.arc(r,a,l,0,Math.PI*2),t.fill()}t.globalAlpha=1}drawAsciiBackground(t,e,o,i){t.globalAlpha=.05,t.strokeStyle=i.accent,t.lineWidth=1;for(let n=0;n<o;n+=4)t.beginPath(),t.moveTo(0,n),t.lineTo(e,n),t.stroke();const s=t.createRadialGradient(e/2,o/2,0,e/2,o/2,Math.max(e,o)*.6);s.addColorStop(0,"transparent"),s.addColorStop(1,"rgba(0, 0, 0, 0.4)"),t.globalAlpha=1,t.fillStyle=s,t.fillRect(0,0,e,o)}renderAsciiMode(t,e,o,i,s,n,r){const a=" .:-=+*#%@",l=this.getQualityMultiplier(),p=Math.max(6,Math.floor(12/l)),h=Math.max(8,Math.floor(16/l)),u=Math.max(8,Math.floor(14/l));t.font=`bold ${u}px monospace`,t.fillStyle=r.fg,t.textAlign="center",t.textBaseline="middle";const c=document.createElement("canvas");c.width=s,c.height=n;const f=c.getContext("2d"),d=[];for(const z of e)z.mesh.visible&&this.collectTriangles(z,i,d);for(const z of o)z.mesh.visible&&this.collectTrianglesFromMesh(z.mesh,z.color,i,d);d.sort((z,v)=>v.depth-z.depth);for(const z of d){const v=this.calculateLuminance(z.color),C=Math.round(v*255);f.fillStyle=`rgb(${C}, ${C}, ${C})`,f.beginPath(),f.moveTo(z.points[0].x,z.points[0].y),f.lineTo(z.points[1].x,z.points[1].y),f.lineTo(z.points[2].x,z.points[2].y),f.closePath(),f.fill()}const x=f.getImageData(0,0,s,n).data,g=Math.floor(s/p),b=Math.floor(n/h);for(let z=0;z<b;z++)for(let v=0;v<g;v++){const C=v*p,B=z*h,A=C+p/2,M=B+h/2;let _=0,P=0,k=0,T=0,F=0;for(let $=0;$<h&&B+$<n;$++)for(let et=0;et<p&&C+et<s;et++){const N=((B+$)*s+(C+et))*4,L=x[N],Y=x[N+1],V=x[N+2];P+=L,k+=Y,T+=V;const W=(.299*L+.587*Y+.114*V)/255;_+=W,F++}const D=_/F;if(D<.01)continue;const J=Math.pow(D,.7),Z=Math.floor(J*(a.length-1)),rt=a[Z];if(this.grayscale)t.fillStyle=r.fg;else{const $=Math.round(P/F),et=Math.round(k/F),N=Math.round(T/F),L=($+et+N)/3,Y=1.3,V=Math.min(255,Math.max(0,Math.round(L+($-L)*Y))),W=Math.min(255,Math.max(0,Math.round(L+(et-L)*Y))),ft=Math.min(255,Math.max(0,Math.round(L+(N-L)*Y)));t.fillStyle=`rgb(${V}, ${W}, ${ft})`}t.fillText(rt,A,M)}}drawWatercolorBackground(t,e,o,i){t.globalAlpha=.02,t.fillStyle=i.fg;for(let s=0;s<3e3;s++){const n=Math.random()*e,r=Math.random()*o,a=Math.random()*3+1;t.beginPath(),t.arc(n,r,a,0,Math.PI*2),t.fill()}t.globalAlpha=.03;for(let s=0;s<5;s++){const n=Math.random()*e,r=Math.random()*o,a=100+Math.random()*200,l=t.createRadialGradient(n,r,0,n,r,a);l.addColorStop(0,i.accent),l.addColorStop(1,"transparent"),t.fillStyle=l,t.beginPath(),t.arc(n,r,a,0,Math.PI*2),t.fill()}t.globalAlpha=1}sketchNoise(t,e,o){const i=Math.sin(t*12.9898+e*78.233+o+this.noiseSeed)*43758.5453;return(i-Math.floor(i))*2-1}getEdgesFromBlock(t,e,o,i){const s=t.mesh;if(t.edges)return this.extractEdges(t.edges.geometry,s.matrixWorld,e,o,i);{const n=new Fo(s.geometry,30),r=this.extractEdges(n,s.matrixWorld,e,o,i);return n.dispose(),r}}getEdgesFromMerged(t,e,o,i){if(t.edges)return this.extractEdges(t.edges.geometry,t.mesh.matrixWorld,e,o,i);{const s=new Fo(t.mesh.geometry,30),n=this.extractEdges(s,t.mesh.matrixWorld,e,o,i);return s.dispose(),n}}extractEdges(t,e,o,i,s){const n=[],r=t.getAttribute("position");if(!r)return n;for(let a=0;a<r.count;a+=2){const l=new U(r.getX(a),r.getY(a),r.getZ(a)).applyMatrix4(e),p=new U(r.getX(a+1),r.getY(a+1),r.getZ(a+1)).applyMatrix4(e),h=l.project(o),u=p.project(o);h.z>1&&u.z>1||n.push({x1:(h.x+1)*i/2,y1:(-h.y+1)*s/2,x2:(u.x+1)*i/2,y2:(-u.y+1)*s/2})}return n}collectTriangles(t,e,o){const i=t.mesh;i.updateMatrixWorld();const s=i.geometry,n=s.getAttribute("position");if(!n)return;const r=s.index,a=i.matrixWorld,l=new U;e.getWorldDirection(l);const p=u=>{if(Array.isArray(i.material)){const c=s.groups;if(c&&c.length>0){for(const f of c)if(u*3>=f.start&&u*3<f.start+f.count)return"#"+i.material[f.materialIndex].color.getHexString()}return t.color}else return t.color},h=(u,c,f,d)=>{const m=this._tempVec3.set(n.getX(u),n.getY(u),n.getZ(u)).applyMatrix4(a),x=this._tempVec3_2.set(n.getX(c),n.getY(c),n.getZ(c)).applyMatrix4(a),g=this._tempVec3_3.set(n.getX(f),n.getY(f),n.getZ(f)).applyMatrix4(a),b=new U().subVectors(x,m),z=new U().subVectors(g,m),v=new U().crossVectors(b,z).normalize();if(v.dot(l)>.1)return;const C=m.clone().project(e),B=new U().copy(x).project(e),A=new U().copy(g).project(e);if(C.z>1||B.z>1||A.z>1)return;const M=(m.z+x.z+g.z)/3;o.push({points:[{x:(C.x+1)*window.innerWidth/2,y:(-C.y+1)*window.innerHeight/2},{x:(B.x+1)*window.innerWidth/2,y:(-B.y+1)*window.innerHeight/2},{x:(A.x+1)*window.innerWidth/2,y:(-A.y+1)*window.innerHeight/2}],depth:M,color:p(d),normal:v.clone()})};if(r)for(let u=0;u<r.count;u+=3){const c=Math.floor(u/3);h(r.getX(u),r.getX(u+1),r.getX(u+2),c)}else for(let u=0;u<n.count;u+=3){const c=Math.floor(u/3);h(u,u+1,u+2,c)}}collectTrianglesFromMesh(t,e,o,i){t.updateMatrixWorld();const s=t.geometry,n=s.getAttribute("position"),r=s.getAttribute("color");if(!n)return;const a=s.index,l=t.matrixWorld,p=new U;o.getWorldDirection(p);const h=(u,c,f)=>{const d=this._tempVec3.set(n.getX(u),n.getY(u),n.getZ(u)).applyMatrix4(l),m=this._tempVec3_2.set(n.getX(c),n.getY(c),n.getZ(c)).applyMatrix4(l),x=this._tempVec3_3.set(n.getX(f),n.getY(f),n.getZ(f)).applyMatrix4(l),g=new U().subVectors(m,d),b=new U().subVectors(x,d),z=new U().crossVectors(g,b).normalize();if(z.dot(p)>.1)return;const v=d.clone().project(o),C=new U().copy(m).project(o),B=new U().copy(x).project(o);if(v.z>1||C.z>1||B.z>1)return;const A=(d.z+m.z+x.z)/3;let M=e;if(r){const _=Math.round(r.getX(u)*255),P=Math.round(r.getY(u)*255),k=Math.round(r.getZ(u)*255);M=`#${_.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}${k.toString(16).padStart(2,"0")}`}i.push({points:[{x:(v.x+1)*window.innerWidth/2,y:(-v.y+1)*window.innerHeight/2},{x:(C.x+1)*window.innerWidth/2,y:(-C.y+1)*window.innerHeight/2},{x:(B.x+1)*window.innerWidth/2,y:(-B.y+1)*window.innerHeight/2}],depth:A,color:M,normal:z.clone()})};if(a)for(let u=0;u<a.count;u+=3)h(a.getX(u),a.getX(u+1),a.getX(u+2));else for(let u=0;u<n.count;u+=3)h(u,u+1,u+2)}calculateLuminance(t){const e=t.replace("#",""),o=parseInt(e.substr(0,2),16)/255,i=parseInt(e.substr(2,2),16)/255,s=parseInt(e.substr(4,2),16)/255;return .299*o+.587*i+.114*s}capturePNG(t="render.png"){const e=this.enabled;e||(this.createOverlay(),this.render());const o=this.overlayCanvas,i=document.createElement("a");i.download=t,i.href=o.toDataURL("image/png"),i.click(),e||this.removeOverlay()}exportSVG(t="render.svg"){const e=window.innerWidth,o=window.innerHeight,i=this.getColors();let s=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${o}" viewBox="0 0 ${e} ${o}">
  <rect width="100%" height="100%" fill="${i.bg}"/>
  <g stroke="${i.fg}" stroke-width="${this.lineWidth}" stroke-linecap="round" stroke-linejoin="round" fill="none">
`;const n=this.engine.camera;n.updateMatrixWorld();const r=this.blockManager.getAllBlocks(),a=this.blockManager.getMergedMeshes?this.blockManager.getMergedMeshes():[];for(const h of r){if(!h.mesh.visible)continue;const u=this.getEdgesFromBlock(h,n,e,o);for(const c of u)s+=`    <line x1="${c.x1.toFixed(2)}" y1="${c.y1.toFixed(2)}" x2="${c.x2.toFixed(2)}" y2="${c.y2.toFixed(2)}"/>
`}for(const h of a){if(!h.mesh.visible)continue;const u=this.getEdgesFromMerged(h,n,e,o);for(const c of u)s+=`    <line x1="${c.x1.toFixed(2)}" y1="${c.y1.toFixed(2)}" x2="${c.x2.toFixed(2)}" y2="${c.y2.toFixed(2)}"/>
`}s+=`  </g>
</svg>`;const l=new Blob([s],{type:"image/svg+xml"}),p=document.createElement("a");p.download=t,p.href=URL.createObjectURL(l),p.click(),URL.revokeObjectURL(p.href)}update(){this.enabled&&this.render()}}const or={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = opacity * texel;


		}`};class no{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const Pl=new Vr(-1,1,1,-1,0,1);class Il extends le{constructor(){super(),this.setAttribute("position",new _t([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new _t([0,2,0,0,2,0],2))}}const Rl=new Il;class gs{constructor(t){this._mesh=new Dt(Rl,t)}dispose(){this._mesh.geometry.dispose()}render(t){t.render(this._mesh,Pl)}get material(){return this._mesh.material}set material(t){this._mesh.material=t}}class Ie extends no{constructor(t,e){super(),this.textureID=e!==void 0?e:"tDiffuse",t instanceof Je?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=ci.clone(t.uniforms),this.material=new Je({name:t.name!==void 0?t.name:"unspecified",defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.fsQuad=new gs(this.material)}render(t,e,o){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=o.texture),this.fsQuad.material=this.material,this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class Hs extends no{constructor(t,e){super(),this.scene=t,this.camera=e,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(t,e,o){const i=t.getContext(),s=t.state;s.buffers.color.setMask(!1),s.buffers.depth.setMask(!1),s.buffers.color.setLocked(!0),s.buffers.depth.setLocked(!0);let n,r;this.inverse?(n=0,r=1):(n=1,r=0),s.buffers.stencil.setTest(!0),s.buffers.stencil.setOp(i.REPLACE,i.REPLACE,i.REPLACE),s.buffers.stencil.setFunc(i.ALWAYS,n,4294967295),s.buffers.stencil.setClear(r),s.buffers.stencil.setLocked(!0),t.setRenderTarget(o),this.clear&&t.clear(),t.render(this.scene,this.camera),t.setRenderTarget(e),this.clear&&t.clear(),t.render(this.scene,this.camera),s.buffers.color.setLocked(!1),s.buffers.depth.setLocked(!1),s.buffers.color.setMask(!0),s.buffers.depth.setMask(!0),s.buffers.stencil.setLocked(!1),s.buffers.stencil.setFunc(i.EQUAL,1,4294967295),s.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),s.buffers.stencil.setLocked(!0)}}class Ll extends no{constructor(){super(),this.needsSwap=!1}render(t){t.state.buffers.stencil.setLocked(!1),t.state.buffers.stencil.setTest(!1)}}class Ws{constructor(t,e){if(this.renderer=t,this._pixelRatio=t.getPixelRatio(),e===void 0){const o=t.getSize(new nt);this._width=o.width,this._height=o.height,e=new Ce(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Qo}),e.texture.name="EffectComposer.rt1"}else this._width=e.width,this._height=e.height;this.renderTarget1=e,this.renderTarget2=e.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new Ie(or),this.copyPass.material.blending=Hr,this.clock=new jn}swapBuffers(){const t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t}addPass(t){this.passes.push(t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(t,e){this.passes.splice(e,0,t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(t){const e=this.passes.indexOf(t);e!==-1&&this.passes.splice(e,1)}isLastEnabledPass(t){for(let e=t+1;e<this.passes.length;e++)if(this.passes[e].enabled)return!1;return!0}render(t){t===void 0&&(t=this.clock.getDelta());const e=this.renderer.getRenderTarget();let o=!1;for(let i=0,s=this.passes.length;i<s;i++){const n=this.passes[i];if(n.enabled!==!1){if(n.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(i),n.render(this.renderer,this.writeBuffer,this.readBuffer,t,o),n.needsSwap){if(o){const r=this.renderer.getContext(),a=this.renderer.state.buffers.stencil;a.setFunc(r.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),a.setFunc(r.EQUAL,1,4294967295)}this.swapBuffers()}Hs!==void 0&&(n instanceof Hs?o=!0:n instanceof Ll&&(o=!1))}}this.renderer.setRenderTarget(e)}reset(t){if(t===void 0){const e=this.renderer.getSize(new nt);this._pixelRatio=this.renderer.getPixelRatio(),this._width=e.width,this._height=e.height,t=this.renderTarget1.clone(),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(t,e){this._width=t,this._height=e;const o=this._width*this._pixelRatio,i=this._height*this._pixelRatio;this.renderTarget1.setSize(o,i),this.renderTarget2.setSize(o,i);for(let s=0;s<this.passes.length;s++)this.passes[s].setSize(o,i)}setPixelRatio(t){this._pixelRatio=t,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class Ol extends no{constructor(t,e,o=null,i=null,s=null){super(),this.scene=t,this.camera=e,this.overrideMaterial=o,this.clearColor=i,this.clearAlpha=s,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new ot}render(t,e,o){const i=t.autoClear;t.autoClear=!1;let s,n;this.overrideMaterial!==null&&(n=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor!==null&&(t.getClearColor(this._oldClearColor),t.setClearColor(this.clearColor,t.getClearAlpha())),this.clearAlpha!==null&&(s=t.getClearAlpha(),t.setClearAlpha(this.clearAlpha)),this.clearDepth==!0&&t.clearDepth(),t.setRenderTarget(this.renderToScreen?null:o),this.clear===!0&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),t.render(this.scene,this.camera),this.clearColor!==null&&t.setClearColor(this._oldClearColor),this.clearAlpha!==null&&t.setClearAlpha(s),this.overrideMaterial!==null&&(this.scene.overrideMaterial=n),t.autoClear=i}}const Nl={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new ot(0)},defaultOpacity:{value:0}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform vec3 defaultColor;
		uniform float defaultOpacity;
		uniform float luminosityThreshold;
		uniform float smoothWidth;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );

			float v = luminance( texel.xyz );

			vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );

			float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );

			gl_FragColor = mix( outputColor, texel, alpha );

		}`};class so extends no{constructor(t,e,o,i){super(),this.strength=e!==void 0?e:1,this.radius=o,this.threshold=i,this.resolution=t!==void 0?new nt(t.x,t.y):new nt(256,256),this.clearColor=new ot(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let s=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);this.renderTargetBright=new Ce(s,n,{type:Qo}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let h=0;h<this.nMips;h++){const u=new Ce(s,n,{type:Qo});u.texture.name="UnrealBloomPass.h"+h,u.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(u);const c=new Ce(s,n,{type:Qo});c.texture.name="UnrealBloomPass.v"+h,c.texture.generateMipmaps=!1,this.renderTargetsVertical.push(c),s=Math.round(s/2),n=Math.round(n/2)}const r=Nl;this.highPassUniforms=ci.clone(r.uniforms),this.highPassUniforms.luminosityThreshold.value=i,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new Je({uniforms:this.highPassUniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader}),this.separableBlurMaterials=[];const a=[3,5,7,9,11];s=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);for(let h=0;h<this.nMips;h++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(a[h])),this.separableBlurMaterials[h].uniforms.invSize.value=new nt(1/s,1/n),s=Math.round(s/2),n=Math.round(n/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=e,this.compositeMaterial.uniforms.bloomRadius.value=.1;const l=[1,.8,.6,.4,.2];this.compositeMaterial.uniforms.bloomFactors.value=l,this.bloomTintColors=[new U(1,1,1),new U(1,1,1),new U(1,1,1),new U(1,1,1),new U(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const p=or;this.copyUniforms=ci.clone(p.uniforms),this.blendMaterial=new Je({uniforms:this.copyUniforms,vertexShader:p.vertexShader,fragmentShader:p.fragmentShader,blending:Wr,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new ot,this.oldClearAlpha=1,this.basic=new gi,this.fsQuad=new gs(null)}dispose(){for(let t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(let t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose();for(let t=0;t<this.separableBlurMaterials.length;t++)this.separableBlurMaterials[t].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(t,e){let o=Math.round(t/2),i=Math.round(e/2);this.renderTargetBright.setSize(o,i);for(let s=0;s<this.nMips;s++)this.renderTargetsHorizontal[s].setSize(o,i),this.renderTargetsVertical[s].setSize(o,i),this.separableBlurMaterials[s].uniforms.invSize.value=new nt(1/o,1/i),o=Math.round(o/2),i=Math.round(i/2)}render(t,e,o,i,s){t.getClearColor(this._oldClearColor),this.oldClearAlpha=t.getClearAlpha();const n=t.autoClear;t.autoClear=!1,t.setClearColor(this.clearColor,0),s&&t.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=o.texture,t.setRenderTarget(null),t.clear(),this.fsQuad.render(t)),this.highPassUniforms.tDiffuse.value=o.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,t.setRenderTarget(this.renderTargetBright),t.clear(),this.fsQuad.render(t);let r=this.renderTargetBright;for(let a=0;a<this.nMips;a++)this.fsQuad.material=this.separableBlurMaterials[a],this.separableBlurMaterials[a].uniforms.colorTexture.value=r.texture,this.separableBlurMaterials[a].uniforms.direction.value=so.BlurDirectionX,t.setRenderTarget(this.renderTargetsHorizontal[a]),t.clear(),this.fsQuad.render(t),this.separableBlurMaterials[a].uniforms.colorTexture.value=this.renderTargetsHorizontal[a].texture,this.separableBlurMaterials[a].uniforms.direction.value=so.BlurDirectionY,t.setRenderTarget(this.renderTargetsVertical[a]),t.clear(),this.fsQuad.render(t),r=this.renderTargetsVertical[a];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.setRenderTarget(this.renderTargetsHorizontal[0]),t.clear(),this.fsQuad.render(t),this.fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,s&&t.state.buffers.stencil.setTest(!0),this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(o),this.fsQuad.render(t)),t.setClearColor(this._oldClearColor,this.oldClearAlpha),t.autoClear=n}getSeperableBlurMaterial(t){const e=[];for(let o=0;o<t;o++)e.push(.39894*Math.exp(-.5*o*o/(t*t))/t);return new Je({defines:{KERNEL_RADIUS:t},uniforms:{colorTexture:{value:null},invSize:{value:new nt(.5,.5)},direction:{value:new nt(.5,.5)},gaussianCoefficients:{value:e}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 invSize;
				uniform vec2 direction;
				uniform float gaussianCoefficients[KERNEL_RADIUS];

				void main() {
					float weightSum = gaussianCoefficients[0];
					vec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianCoefficients[i];
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}getCompositeMaterial(t){return new Je({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}}so.BlurDirectionX=new nt(1,0);so.BlurDirectionY=new nt(0,1);const Ul={name:"OutputShader",uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:`
		precision highp float;

		uniform mat4 modelViewMatrix;
		uniform mat4 projectionMatrix;

		attribute vec3 position;
		attribute vec2 uv;

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`
	
		precision highp float;

		uniform sampler2D tDiffuse;

		#include <tonemapping_pars_fragment>
		#include <colorspace_pars_fragment>

		varying vec2 vUv;

		void main() {

			gl_FragColor = texture2D( tDiffuse, vUv );

			// tone mapping

			#ifdef LINEAR_TONE_MAPPING

				gl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );

			#elif defined( REINHARD_TONE_MAPPING )

				gl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );

			#elif defined( CINEON_TONE_MAPPING )

				gl_FragColor.rgb = CineonToneMapping( gl_FragColor.rgb );

			#elif defined( ACES_FILMIC_TONE_MAPPING )

				gl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );

			#elif defined( AGX_TONE_MAPPING )

				gl_FragColor.rgb = AgXToneMapping( gl_FragColor.rgb );

			#elif defined( NEUTRAL_TONE_MAPPING )

				gl_FragColor.rgb = NeutralToneMapping( gl_FragColor.rgb );

			#endif

			// color space

			#ifdef SRGB_TRANSFER

				gl_FragColor = sRGBTransferOETF( gl_FragColor );

			#endif

		}`};class Xl extends no{constructor(){super();const t=Ul;this.uniforms=ci.clone(t.uniforms),this.material=new qr({name:t.name,uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.fsQuad=new gs(this.material),this._outputColorSpace=null,this._toneMapping=null}render(t,e,o){this.uniforms.tDiffuse.value=o.texture,this.uniforms.toneMappingExposure.value=t.toneMappingExposure,(this._outputColorSpace!==t.outputColorSpace||this._toneMapping!==t.toneMapping)&&(this._outputColorSpace=t.outputColorSpace,this._toneMapping=t.toneMapping,this.material.defines={},Kr.getTransfer(this._outputColorSpace)===Jr&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===Qr?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===ta?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===ea?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===oa?this.material.defines.ACES_FILMIC_TONE_MAPPING="":this._toneMapping===ia?this.material.defines.AGX_TONE_MAPPING="":this._toneMapping===sa&&(this.material.defines.NEUTRAL_TONE_MAPPING=""),this.material.needsUpdate=!0),this.renderToScreen===!0?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}new nt(1920,1080),new ot(0),new ot(16777215);const Zl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},lineColor:{value:new ot(0)},bgColor:{value:new ot(16777215)},spacing:{value:8},lineWidth:{value:1}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform vec3 lineColor;
    uniform vec3 bgColor;
    uniform float spacing;
    uniform float lineWidth;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float hatchLine(vec2 uv, float angle, float sp) {
      float c = cos(angle);
      float s = sin(angle);
      vec2 rotUv = vec2(uv.x * c - uv.y * s, uv.x * s + uv.y * c);
      return step(mod(rotUv.x * resolution.x, sp), lineWidth);
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float lum = luma(texColor.rgb);
      float darkness = 1.0 - lum;

      vec2 pixelCoord = vUv * resolution;
      float hatch = 0.0;

      // Layer 1: diagonal lines (darkness > 0.25)
      if (darkness > 0.25) {
        hatch = max(hatch, hatchLine(pixelCoord, 0.785, spacing));
      }
      // Layer 2: opposite diagonal (darkness > 0.5)
      if (darkness > 0.5) {
        hatch = max(hatch, hatchLine(pixelCoord, -0.785, spacing));
      }
      // Layer 3: horizontal (darkness > 0.75)
      if (darkness > 0.75) {
        hatch = max(hatch, hatchLine(pixelCoord, 0.0, spacing * 1.5));
      }

      vec3 finalColor = mix(bgColor, lineColor, hatch);
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},jl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},dotColor:{value:new ot(0)},bgColor:{value:new ot(16777215)},dotSize:{value:4},spacing:{value:8},thickness:{value:2},showFills:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform vec3 dotColor;
    uniform vec3 bgColor;
    uniform float dotSize;
    uniform float spacing;
    uniform float thickness;
    uniform float showFills;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness * 2.0) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.04, 0.12, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float lum = luma(texColor.rgb);
      float darkness = 1.0 - lum;

      vec2 pixelCoord = vUv * resolution;
      vec2 cell = floor(pixelCoord / spacing);
      vec2 cellCenter = (cell + 0.5) * spacing;
      float dist = length(pixelCoord - cellCenter);

      // Dot radius based on darkness
      float radius = darkness * dotSize;
      float dt = 1.0 - smoothstep(radius - 0.5, radius + 0.5, dist);

      // When fills are off, skip dots  just show bg + edges
      float dotMask = dt * showFills;
      vec3 finalColor = mix(bgColor, dotColor, dotMask);

      // Grayscale conversion
      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }

      // Bold edge overlay (comic-style thick outlines)
      float edge = detectEdge(vUv);
      finalColor = mix(finalColor, dotColor, edge);

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Yl={uniforms:{tDiffuse:{value:null},tCharacters:{value:null},resolution:{value:new nt(1920,1080)},charSize:{value:new nt(8,16)},textColor:{value:new ot(65280)},bgColor:{value:new ot(0)},colorMode:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform sampler2D tCharacters;
    uniform vec2 resolution;
    uniform vec2 charSize;
    uniform vec3 textColor;
    uniform vec3 bgColor;
    uniform int colorMode;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    void main() {
      // Calculate which character cell we're in
      vec2 pixelCoord = vUv * resolution;
      vec2 cellCoord = floor(pixelCoord / charSize);
      vec2 cellUv = (cellCoord + 0.5) * charSize / resolution;

      // Sample the center of this cell
      vec4 texColor = texture2D(tDiffuse, cellUv);
      float lum = luma(texColor.rgb);

      // Map luminance to character index (0-9 for " .:-=+*#%@")
      int charIndex = int(lum * 9.0);

      // Position within character cell
      vec2 posInCell = mod(pixelCoord, charSize) / charSize;

      // Sample from character atlas
      float charWidth = 1.0 / 10.0; // 10 characters in atlas
      vec2 charUv = vec2(
        float(charIndex) * charWidth + posInCell.x * charWidth,
        posInCell.y
      );

      float charValue = texture2D(tCharacters, charUv).r;

      vec3 color;
      if (colorMode == 1) {
        // Colored mode - use original color boosted
        vec3 boosted = texColor.rgb * 1.3;
        color = mix(bgColor, boosted, charValue);
      } else {
        // Monochrome mode
        color = mix(bgColor, textColor, charValue);
      }

      gl_FragColor = vec4(color, 1.0);
    }
  `},Gl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},glowColor:{value:new ot(65535)},accentColor:{value:new ot(16711935)},bgColor:{value:new ot(657935)},glowIntensity:{value:2},thickness:{value:1}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform vec3 glowColor;
    uniform vec3 accentColor;
    uniform vec3 bgColor;
    uniform float glowIntensity;
    uniform float thickness;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      // Dark base from original
      vec3 darkBase = texColor.rgb * 0.15;

      // Alternate between glow colors based on position
      float alternate = step(0.5, fract(vUv.x * 20.0 + vUv.y * 20.0));
      vec3 edgeGlow = mix(glowColor, accentColor, alternate * 0.3);

      // Combine
      vec3 finalColor = mix(darkBase + bgColor * 0.5, edgeGlow * glowIntensity, edge);

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},$l={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1},time:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    uniform float time;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    vec3 synthwaveColor(vec3 color, vec2 uv) {
      float lum = dot(color, vec3(0.299, 0.587, 0.114));

      // Shift toward purple/cyan palette
      vec3 result;
      if (lum > 0.5) {
        // Bright: pink/cyan
        result.r = min(1.0, color.r * 0.7 + 0.4);
        result.g = color.g * 0.5;
        result.b = min(1.0, color.b * 0.7 + 0.3);
      } else {
        // Dark: deep purple
        result.r = color.r * 0.4 + 0.15;
        result.g = color.g * 0.3;
        result.b = min(1.0, color.b * 0.5 + 0.25);
      }
      return result;
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      // Background gradient
      vec3 bgTop = vec3(0.06, 0.06, 0.14);
      vec3 bgBot = vec3(0.09, 0.08, 0.15);
      vec3 bg = mix(bgBot, bgTop, vUv.y);

      // Color shift the original
      vec3 shifted = synthwaveColor(texColor.rgb, vUv);

      // Edge glow with gradient
      vec3 glowStart = vec3(1.0, 0.43, 0.78); // Pink
      vec3 glowEnd = vec3(0.0, 1.0, 0.97);    // Cyan
      vec3 edgeColor = mix(glowStart, glowEnd, vUv.y + sin(vUv.x * 10.0) * 0.2);

      vec3 finalColor = mix(shifted, bg, 0.3);
      finalColor = mix(finalColor, edgeColor * 1.5, edge);

      // Subtle grid on bottom half
      if (vUv.y < 0.5) {
        float gridX = step(0.98, fract(vUv.x * 20.0));
        float gridY = step(0.96, fract((0.5 - vUv.y) * 30.0 * (1.0 + vUv.y)));
        float grid = max(gridX, gridY) * 0.2 * (0.5 - vUv.y) * 2.0;
        finalColor += vec3(0.0, 1.0, 0.97) * grid;
      }

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Vl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},threshold:{value:.45},thickness:{value:1}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float threshold;
    uniform float thickness;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness * 1.5) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);
      float lum = luma(texColor.rgb);

      // High contrast threshold
      float bw = step(threshold, lum);

      // Add edge emphasis (white edges on black)
      bw = max(bw, edge);

      gl_FragColor = vec4(vec3(bw), 1.0);
    }
  `},Hl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1},time:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    uniform float time;
    varying vec2 vUv;

    float hash(vec2 p) {
      return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453);
    }

    float noise(vec2 p) {
      vec2 i = floor(p);
      vec2 f = fract(p);
      f = f * f * (3.0 - 2.0 * f);
      float a = hash(i);
      float b = hash(i + vec2(1.0, 0.0));
      float c = hash(i + vec2(0.0, 1.0));
      float d = hash(i + vec2(1.0, 1.0));
      return mix(mix(a, b, f.x), mix(c, d, f.x), f.y);
    }

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.03, 0.12, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec2 wobble = vec2(
        noise(vUv * 50.0) * 0.003,
        noise(vUv * 50.0 + 100.0) * 0.003
      );

      vec4 texColor = texture2D(tDiffuse, vUv + wobble);
      float edge = detectEdge(vUv);

      float gray = dot(texColor.rgb, vec3(0.299, 0.587, 0.114));
      vec3 softened = mix(texColor.rgb, vec3(gray), 0.3);
      softened = softened * 0.7 + 0.2;

      float paper = noise(vUv * resolution * 0.5) * 0.05;
      softened += paper;

      vec3 edgeColor = vec3(0.17, 0.29, 0.32);
      vec3 finalColor = mix(softened, edgeColor, edge * 0.6);
      finalColor = mix(finalColor, vec3(0.98, 0.97, 0.96), 0.1);

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Wl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1},time:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    uniform float time;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.2, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      vec3 techColor = vec3(texColor.r * 0.4, min(1.0, texColor.g * 0.6 + 0.12), min(1.0, texColor.b * 0.7 + 0.2));
      vec3 bg = vec3(0.05, 0.07, 0.09);
      vec3 finalColor = mix(bg, techColor, 0.85);

      float scanline = sin(vUv.y * resolution.y * 2.0) * 0.03 + 0.97;
      finalColor *= scanline;

      vec3 edgeColor = vec3(0.34, 0.65, 1.0);
      finalColor = mix(finalColor, edgeColor * 1.2, edge);

      float gridSize = 40.0;
      float grid = max(step(0.97, fract(vUv.x * resolution.x / gridSize)), step(0.97, fract(vUv.y * resolution.y / gridSize))) * 0.15;
      finalColor += edgeColor * grid;

      vec2 corner = min(vUv, 1.0 - vUv);
      float bracket = step(corner.x, 0.02) * step(corner.y, 0.05) + step(corner.y, 0.02) * step(corner.x, 0.05);
      finalColor += vec3(0.14, 0.53, 0.21) * bracket * 0.5;

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},ql={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      float edge = detectEdge(vUv);

      vec3 bg = vec3(0.12, 0.23, 0.37);
      vec3 lineColor = vec3(0.53, 0.81, 0.92);
      vec3 accentColor = vec3(0.68, 0.85, 0.90);

      vec2 pixelCoord = vUv * resolution;
      float minorGrid = max(step(0.95, fract(pixelCoord.x / 20.0)), step(0.95, fract(pixelCoord.y / 20.0))) * 0.2;
      float majorGrid = max(step(0.98, fract(pixelCoord.x / 100.0)), step(0.98, fract(pixelCoord.y / 100.0))) * 0.4;

      vec3 finalColor = bg + accentColor * minorGrid + accentColor * majorGrid;
      finalColor = mix(finalColor, lineColor * 1.3, edge);

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Kl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1},time:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    uniform float time;
    varying vec2 vUv;

    float hash(vec2 p) { return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453); }
    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv, vec2 offset) {
      vec2 texel = vec2(thickness) / resolution;
      vec2 uvOff = uv + offset;
      float tl = luma(texture2D(tDiffuse, uvOff + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uvOff + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uvOff + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uvOff + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uvOff + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uvOff + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uvOff + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uvOff + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.03, 0.12, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec3 paper = vec3(0.96, 0.96, 0.86) - hash(floor(vUv * resolution)) * 0.03;

      float edge = 0.0;
      for (int i = 0; i < 3; i++) {
        vec2 offset = vec2(hash(vUv + float(i) * 0.1) - 0.5, hash(vUv + float(i) * 0.2 + 50.0) - 0.5) * 0.003;
        edge += detectEdge(vUv, offset);
      }
      edge = min(edge / 2.0, 1.0);

      vec3 finalColor = mix(paper, vec3(0.17), edge);
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Jl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness * 1.5) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.04, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);
      float lum = luma(texColor.rgb);

      // Cream paper
      vec3 paper = vec3(1.0, 0.996, 0.94);
      vec3 ink = vec3(0.1, 0.1, 0.1);

      // Variable line width based on luminance
      float lineThickness = edge * (1.5 - lum * 0.5);

      // Ink wash for darker areas
      float wash = (1.0 - lum) * 0.15;

      vec3 finalColor = paper;
      finalColor = mix(finalColor, paper * 0.85, wash);
      finalColor = mix(finalColor, ink, min(lineThickness, 1.0));

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Ql={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},saturation:{value:1.4},thickness:{value:1}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float saturation;
    uniform float thickness;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      // Boost saturation
      float gray = dot(texColor.rgb, vec3(0.299, 0.587, 0.114));
      vec3 saturated = mix(vec3(gray), texColor.rgb, saturation);
      saturated = clamp(saturated, 0.0, 1.0);

      // Thin dark outlines
      vec3 finalColor = mix(saturated, vec3(0.0), edge * 0.8);

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},qs={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},bgColor:{value:new ot(1,1,1)},lineColor:{value:new ot(0,0,0)},sceneBg:{value:new ot(1710638)},threshold:{value:.1},thickness:{value:1},showFills:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform vec3 bgColor;
    uniform vec3 lineColor;
    uniform vec3 sceneBg;
    uniform float threshold;
    uniform float thickness;
    uniform float showFills;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 color) {
      vec3 c = clamp(color, 0.0, 1.0);
      return dot(c, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      if (resolution.x < 1.0 || resolution.y < 1.0) return 0.0;
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(threshold, threshold + 0.1, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      // Detect background vs geometry by comparing to scene clear color
      float dist = length(texColor.rgb - sceneBg);
      float isGeometry = smoothstep(0.02, 0.08, dist);

      // Show block fills where geometry exists, style bgColor otherwise
      vec3 fills = mix(bgColor, texColor.rgb, isGeometry);

      // When fills are off, just show bgColor everywhere (edges-only mode)
      fills = mix(bgColor, fills, showFills);

      // Grayscale conversion
      if (grayscale > 0.5) {
        float g = luma(fills);
        fills = vec3(g);
      }

      // Overlay edge lines
      vec3 finalColor = mix(fills, lineColor, edge);
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `};class Ks{constructor(t,e){this.engine=t,this.blockManager=e,this.renderer=t.renderer,this.scene=t.scene,this.camera=t.camera,this.enabled=!1,this.style="clean",this.inverted=!1,this.grayscale=!1,this.threshold=.5,this.lineWidth=2,this.showFills=!0,this.quality="medium",this.width=window.innerWidth,this.height=window.innerHeight,this.setupRenderTargets(),this.setupComposers(),this.createCharacterTexture(),this.time=0,window.addEventListener("resize",()=>this.onResize())}setupRenderTargets(){const t={minFilter:wo,magFilter:wo,format:ds};this.sceneTarget=new Ce(this.width,this.height,t),this.edgeTarget=new Ce(this.width,this.height,t)}setupComposers(){this.composer=new Ws(this.renderer),this.stylePass=null}createCharacterTexture(){const t=document.createElement("canvas"),e=" .:-=+*#%@",o=16,i=24;t.width=o*e.length,t.height=i;const s=t.getContext("2d");s.fillStyle="#000000",s.fillRect(0,0,t.width,t.height),s.fillStyle="#ffffff",s.font="bold 20px monospace",s.textAlign="center",s.textBaseline="middle";for(let n=0;n<e.length;n++)s.fillText(e[n],n*o+o/2,i/2);this.charTexture=new fs(t),this.charTexture.minFilter=me,this.charTexture.magFilter=me}setEnabled(t){this.enabled=t,t?(this.updateStyle(),this.engine.customRender=()=>this.render()):this.engine.customRender=null}setStyle(t){this.style=t,this.enabled&&this.updateStyle()}setInverted(t){this.inverted=t,this.updateStyleUniforms()}setGrayscale(t){this.grayscale=t,this.updateStyleUniforms()}setThreshold(t){this.threshold=t,this.updateStyleUniforms()}setLineWidth(t){this.lineWidth=t,this.updateStyleUniforms()}setShowFills(t){this.showFills=t,this.updateStyleUniforms()}setQuality(t){this.quality=t}updateStyle(){this.composer=new Ws(this.renderer),this.composer.setSize(this.width,this.height),this.renderPass=new Ol(this.engine.scene,this.engine.camera),this.composer.addPass(this.renderPass);const e={clean:qs,sketch:Kl,ink:Jl,crosshatch:Zl,blueprint:ql,comic:jl,saturated:Ql,neon:Gl,scifi:Wl,watercolor:Hl,noir:Vl,synthwave:$l,ascii:Yl}[this.style]||qs;if(this.stylePass=new Ie(e),this.composer.addPass(this.stylePass),["neon","synthwave","scifi"].includes(this.style)){const o=new so(new nt(this.width,this.height),.5,.4,.85);this.composer.addPass(o)}this.composer.addPass(new Xl),this.updateStyleUniforms()}updateStyleUniforms(){if(!this.stylePass)return;const t=this.getColors(),e=this.stylePass.uniforms;switch(e.resolution&&e.resolution.value.set(this.width,this.height),e.bgColor&&e.bgColor.value.set(t.bg),e.lineColor&&e.lineColor.value.set(t.fg),e.threshold&&(e.threshold.value=this.threshold*.3),e.thickness&&(e.thickness.value=this.lineWidth),e.showFills&&(e.showFills.value=this.showFills?1:0),e.grayscale&&(e.grayscale.value=this.grayscale?1:0),this.style){case"clean":break;case"crosshatch":e.spacing&&(e.spacing.value=10-this.lineWidth),e.lineWidth&&(e.lineWidth.value=this.lineWidth*.5);break;case"comic":e.dotSize.value=this.lineWidth*2,e.spacing.value=this.lineWidth*4,e.dotColor.value.set(t.fg);break;case"ascii":e.tCharacters.value=this.charTexture,e.charSize.value.set(8,16),e.textColor.value.set(t.fg),e.colorMode.value=this.grayscale?0:1;break;case"neon":e.glowColor.value.set(t.fg),e.accentColor.value.set(t.accent||16711935);break;case"noir":e.threshold.value=this.threshold;break;case"saturated":e.saturation.value=1.4;break}}getColors(){const t={clean:{bg:"#ffffff",fg:"#000000",accent:"#000000"},sketch:{bg:"#f5f5dc",fg:"#2c2c2c",accent:"#4a4a4a"},ink:{bg:"#fffef0",fg:"#1a1a1a",accent:"#000000"},crosshatch:{bg:"#ffffff",fg:"#000000",accent:"#444444"},blueprint:{bg:"#1e3a5f",fg:"#87ceeb",accent:"#add8e6"},comic:{bg:"#ffffff",fg:"#000000",accent:"#ff0000"},saturated:{bg:"#ffffff",fg:"#000000",accent:"#333333"},neon:{bg:"#0a0a0f",fg:"#00ffff",accent:"#ff00ff"},scifi:{bg:"#0d1117",fg:"#58a6ff",accent:"#238636"},watercolor:{bg:"#faf8f5",fg:"#2c4a52",accent:"#8b4513"},noir:{bg:"#000000",fg:"#ffffff",accent:"#808080"},synthwave:{bg:"#1a1a2e",fg:"#ff6ec7",accent:"#00fff7"},ascii:{bg:"#000000",fg:"#00ff00",accent:"#00aa00"}};let e=t[this.style]||t.clean;return this.inverted&&(e={...e,bg:e.fg,fg:e.bg}),e}onResize(){this.width=window.innerWidth,this.height=window.innerHeight,this.sceneTarget.setSize(this.width,this.height),this.edgeTarget.setSize(this.width,this.height),this.composer&&this.composer.setSize(this.width,this.height),this.sobelPass&&this.sobelPass.uniforms.resolution.value.set(this.width,this.height),this.updateStyleUniforms()}render(t=!1){if(!this.enabled){this.renderer.render(this.engine.scene,this.engine.camera);return}this.time+=.016,this.stylePass&&this.stylePass.uniforms.time&&(this.stylePass.uniforms.time.value=this.time),this.composer.render()}update(){this.enabled&&this.render()}invalidateCache(){}capturePNG(t="render.png"){this.render(!0);const e=this.renderer.domElement,o=document.createElement("a");o.download=t,o.href=e.toDataURL("image/png"),o.click()}exportSVG(t="render.svg"){console.warn("SVG export not fully supported in GPU mode")}dispose(){this.sceneTarget.dispose(),this.edgeTarget.dispose(),this.charTexture&&this.charTexture.dispose()}}class tc{constructor(t){this.engine=t,this.frames=[],this.isCapturing=!1,this.onProgress=null}async captureFrame(t,e="image/jpeg",o=.92){var r;this.engine.renderer.render(this.engine.scene,this.engine.camera);const i=document.getElementById("tattoo-overlay"),s=i&&i.style.display!=="none";if(s){const a=(r=window.appInstance)==null?void 0:r.tattooRenderer;a&&a.enabled&&a.render()}let n=this.engine.canvas;if(s){const a=document.createElement("canvas");a.width=this.engine.canvas.width,a.height=this.engine.canvas.height;const l=a.getContext("2d");l.drawImage(this.engine.canvas,0,0),l.drawImage(i,0,0),n=a}return new Promise(a=>{n.toBlob(l=>{a({frameNumber:t,blob:l,dataUrl:URL.createObjectURL(l),timestamp:Date.now()})},e,o)})}async captureSequence(t){const{animator:e,bookmarks:o,totalFrames:i,onProgress:s,format:n="image/jpeg",quality:r=.92}=t;if(o.length<2)throw new Error("Need at least 2 bookmarks to capture sequence");return this.frames=[],this.isCapturing=!0,await e.renderSequence(o,i,async(a,l)=>{const p=await this.captureFrame(a,n,r);this.frames.push(p),s&&s({current:a+1,total:l,percent:((a+1)/l*100).toFixed(1)})},()=>{this.isCapturing=!1}),this.frames}async exportIndividualFrames(t=null,e="frame_"){const o=t||this.frames;for(let i=0;i<o.length;i++){const s=o[i],n=document.createElement("a"),r=String(s.frameNumber).padStart(4,"0");n.download=`${e}${r}.jpg`,n.href=s.dataUrl,n.click(),await this.sleep(100)}}async exportAsZip(t=null,e="camera_sequence.zip"){const o=t||this.frames;if(!window.JSZip)throw new Error("JSZip library not loaded. Please include it in your project.");const i=window.JSZip,s=new i;for(const r of o){const a=String(r.frameNumber).padStart(4,"0"),l=r.blob.type==="image/png"?"png":"jpg";s.file(`frame_${a}.${l}`,r.blob)}const n=await s.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}});return this.downloadBlob(n,e),n}async exportAsMP4Realtime(t,e,o=3e3,i="camera_path.webm",s=null){const r=Math.floor(o/1e3*30);return console.log(`Exporting video: ${r} frames at 30 FPS`),this.exportAsMP4FrameByFrame(t,e,r,30,i,s)}async exportAsMP4FrameByFrame(t,e,o,i,s="camera_path.webm",n=null){var m;const r=document.getElementById("tattoo-overlay"),a=r&&r.style.display!=="none",l=(m=window.appInstance)==null?void 0:m.tattooRenderer,p=document.createElement("canvas");p.width=this.engine.canvas.width,p.height=this.engine.canvas.height;const h=p.getContext("2d",{willReadFrequently:!0});console.log(`Starting WebM export: ${o} frames at ${i} FPS`);const u=p.captureStream(i);let c="video/webm;codecs=vp9";MediaRecorder.isTypeSupported(c)||(c="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(c)||(c="video/webm"));const f=new MediaRecorder(u,{mimeType:c,videoBitsPerSecond:8e6}),d=[];return new Promise((x,g)=>{f.ondataavailable=B=>{B.data.size>0&&(d.push(B.data),console.log(`Chunk received: ${B.data.size} bytes (total chunks: ${d.length})`))},f.onstop=()=>{console.log(`Recording stopped. Total chunks: ${d.length}, total size: ${d.reduce((A,M)=>A+M.size,0)} bytes`);const B=new Blob(d,{type:c});if(console.log(`Final video blob size: ${B.size} bytes`),B.size<1e4){console.error("Video blob is suspiciously small - recording may have failed"),g(new Error("Video recording failed - file too small. Try using JPG Sequence export instead."));return}this.downloadBlob(B,s),x(B)},f.onerror=g,f.start(100);let b=0;const z=1e3/i;let v=performance.now();const C=()=>{if(b>=o){setTimeout(()=>{f.stop()},1e3);return}const B=t.getCameraAtFrame(b,o,e);t.setCameraState(B),this.engine.renderer.render(this.engine.scene,this.engine.camera),a&&l&&l.enabled&&l.render(!0),h.fillStyle=`rgb(${b%255}, 0, 0)`,h.fillRect(0,0,1,1),h.clearRect(0,0,p.width,p.height),h.drawImage(this.engine.canvas,0,0),a&&r&&h.drawImage(r,0,0),b%30===0&&console.log(`Frame ${b}/${o} rendered, camera:`,t.camera.position.x.toFixed(1),t.camera.position.y.toFixed(1),t.camera.position.z.toFixed(1)),b++,n&&n({current:b,total:o,percent:(b/o*100).toFixed(1)});const M=performance.now()-v,_=b*z,P=Math.max(0,_-M);setTimeout(()=>{requestAnimationFrame(C)},P)};requestAnimationFrame(C)})}async exportAsMP4RealtimeOld(t,e,o=3e3,i="camera_path.webm"){let s,n,r;if(hasTattooOverlay)n=document.createElement("canvas"),n.width=this.engine.canvas.width,n.height=this.engine.canvas.height,r=n.getContext("2d"),s=n.captureStream(30);else{if(!this.engine.canvas.captureStream)throw new Error("Canvas.captureStream() not supported in this browser");s=this.engine.canvas.captureStream(30)}let a="video/webm;codecs=vp9";MediaRecorder.isTypeSupported(a)||(a="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(a)||(a="video/webm"));const l=new MediaRecorder(s,{mimeType:a,videoBitsPerSecond:8e6}),p=[];return new Promise((h,u)=>{var c;if(l.ondataavailable=f=>{f.data.size>0&&p.push(f.data)},l.onstop=()=>{const f=new Blob(p,{type:a});this.downloadBlob(f,i),h(f)},l.onerror=f=>{u(f)},l.start(),n&&r){const f=(c=window.appInstance)==null?void 0:c.tattooRenderer,d=this.engine.onUpdate;this.engine.onUpdate=m=>{d&&d(m),f&&f.enabled&&f.render(),r.clearRect(0,0,n.width,n.height),r.drawImage(this.engine.canvas,0,0),tattooOverlay&&r.drawImage(tattooOverlay,0,0)},t.preview(e,o,()=>{this.engine.onUpdate=d,setTimeout(()=>{l.stop()},500)})}else t.preview(e,o,()=>{setTimeout(()=>{l.stop()},500)})})}downloadBlob(t,e){const o=URL.createObjectURL(t),i=document.createElement("a");i.href=o,i.download=e,i.click(),setTimeout(()=>URL.revokeObjectURL(o),100)}clear(){this.frames.forEach(t=>{t.dataUrl&&URL.revokeObjectURL(t.dataUrl)}),this.frames=[]}getMemoryUsage(){return(this.frames.reduce((e,o)=>e+o.blob.size,0)/1024/1024).toFixed(2)}sleep(t){return new Promise(e=>setTimeout(e,t))}}const ir=0,ec=1,oc=2,Js=2,Mi=1.25,Qs=1,Pt=32,At=Pt/4,sr=65535,ti=Math.pow(2,-24),bs=Symbol("SKIP_GENERATION"),nr={strategy:ir,maxDepth:40,maxLeafSize:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null,[bs]:!1};function bt(y,t,e){return e.min.x=t[y],e.min.y=t[y+1],e.min.z=t[y+2],e.max.x=t[y+3],e.max.y=t[y+4],e.max.z=t[y+5],e}function tn(y){let t=-1,e=-1/0;for(let o=0;o<3;o++){const i=y[o+3]-y[o];i>e&&(e=i,t=o)}return t}function en(y,t){t.set(y)}function on(y,t,e){let o,i;for(let s=0;s<3;s++){const n=s+3;o=y[s],i=t[s],e[s]=o<i?o:i,o=y[n],i=t[n],e[n]=o>i?o:i}}function _o(y,t,e){for(let o=0;o<3;o++){const i=t[y+2*o],s=t[y+2*o+1],n=i-s,r=i+s;n<e[o]&&(e[o]=n),r>e[o+3]&&(e[o+3]=r)}}function po(y){const t=y[3]-y[0],e=y[4]-y[1],o=y[5]-y[2];return 2*(t*e+e*o+o*t)}function Mt(y,t){return t[y+15]===sr}function It(y,t){return t[y+6]}function Nt(y,t){return t[y+14]}function St(y){return y+At}function Tt(y,t){const e=t[y+6];return y+e*At}function zs(y,t){return t[y+7]}function Ei(y,t,e,o,i){let s=1/0,n=1/0,r=1/0,a=-1/0,l=-1/0,p=-1/0,h=1/0,u=1/0,c=1/0,f=-1/0,d=-1/0,m=-1/0;const x=y.offset||0;for(let g=(t-x)*6,b=(t+e-x)*6;g<b;g+=6){const z=y[g+0],v=y[g+1],C=z-v,B=z+v;C<s&&(s=C),B>a&&(a=B),z<h&&(h=z),z>f&&(f=z);const A=y[g+2],M=y[g+3],_=A-M,P=A+M;_<n&&(n=_),P>l&&(l=P),A<u&&(u=A),A>d&&(d=A);const k=y[g+4],T=y[g+5],F=k-T,D=k+T;F<r&&(r=F),D>p&&(p=D),k<c&&(c=k),k>m&&(m=k)}o[0]=s,o[1]=n,o[2]=r,o[3]=a,o[4]=l,o[5]=p,i[0]=h,i[1]=u,i[2]=c,i[3]=f,i[4]=d,i[5]=m}const de=32,ic=(y,t)=>y.candidate-t.candidate,ge=new Array(de).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),So=new Float32Array(6);function sc(y,t,e,o,i,s){let n=-1,r=0;if(s===ir)n=tn(t),n!==-1&&(r=(t[n]+t[n+3])/2);else if(s===ec)n=tn(y),n!==-1&&(r=nc(e,o,i,n));else if(s===oc){const a=po(y);let l=Mi*i;const p=e.offset||0,h=(o-p)*6,u=(o+i-p)*6;for(let c=0;c<3;c++){const f=t[c],x=(t[c+3]-f)/de;if(i<de/4){const g=[...ge];g.length=i;let b=0;for(let v=h;v<u;v+=6,b++){const C=g[b];C.candidate=e[v+2*c],C.count=0;const{bounds:B,leftCacheBounds:A,rightCacheBounds:M}=C;for(let _=0;_<3;_++)M[_]=1/0,M[_+3]=-1/0,A[_]=1/0,A[_+3]=-1/0,B[_]=1/0,B[_+3]=-1/0;_o(v,e,B)}g.sort(ic);let z=i;for(let v=0;v<z;v++){const C=g[v];for(;v+1<z&&g[v+1].candidate===C.candidate;)g.splice(v+1,1),z--}for(let v=h;v<u;v+=6){const C=e[v+2*c];for(let B=0;B<z;B++){const A=g[B];C>=A.candidate?_o(v,e,A.rightCacheBounds):(_o(v,e,A.leftCacheBounds),A.count++)}}for(let v=0;v<z;v++){const C=g[v],B=C.count,A=i-C.count,M=C.leftCacheBounds,_=C.rightCacheBounds;let P=0;B!==0&&(P=po(M)/a);let k=0;A!==0&&(k=po(_)/a);const T=Qs+Mi*(P*B+k*A);T<l&&(n=c,l=T,r=C.candidate)}}else{for(let z=0;z<de;z++){const v=ge[z];v.count=0,v.candidate=f+x+z*x;const C=v.bounds;for(let B=0;B<3;B++)C[B]=1/0,C[B+3]=-1/0}for(let z=h;z<u;z+=6){let B=~~((e[z+2*c]-f)/x);B>=de&&(B=de-1);const A=ge[B];A.count++,_o(z,e,A.bounds)}const g=ge[de-1];en(g.bounds,g.rightCacheBounds);for(let z=de-2;z>=0;z--){const v=ge[z],C=ge[z+1];on(v.bounds,C.rightCacheBounds,v.rightCacheBounds)}let b=0;for(let z=0;z<de-1;z++){const v=ge[z],C=v.count,B=v.bounds,M=ge[z+1].rightCacheBounds;C!==0&&(b===0?en(B,So):on(B,So,So)),b+=C;let _=0,P=0;b!==0&&(_=po(So)/a);const k=i-b;k!==0&&(P=po(M)/a);const T=Qs+Mi*(_*b+P*k);T<l&&(n=c,l=T,r=v.candidate)}}}}else console.warn(`BVH: Invalid build strategy value ${s} used.`);return{axis:n,pos:r}}function nc(y,t,e,o){let i=0;const s=y.offset;for(let n=t,r=t+e;n<r;n++)i+=y[(n-s)*6+o*2];return i/e}class _i{constructor(){this.boundingData=new Float32Array(6)}}function rc(y,t,e,o,i,s){let n=o,r=o+i-1;const a=s.pos,l=s.axis*2,p=e.offset||0;for(;;){for(;n<=r&&e[(n-p)*6+l]<a;)n++;for(;n<=r&&e[(r-p)*6+l]>=a;)r--;if(n<r){for(let h=0;h<t;h++){let u=y[n*t+h];y[n*t+h]=y[r*t+h],y[r*t+h]=u}for(let h=0;h<6;h++){const u=n-p,c=r-p,f=e[u*6+h];e[u*6+h]=e[c*6+h],e[c*6+h]=f}n++,r--}else return n}}let rr,ei,Qi,ar;const ac=Math.pow(2,32);function ts(y){return"count"in y?1:1+ts(y.left)+ts(y.right)}function lc(y,t,e){return rr=new Float32Array(e),ei=new Uint32Array(e),Qi=new Uint16Array(e),ar=new Uint8Array(e),es(y,t)}function es(y,t){const e=y/4,o=y/2,i="count"in t,s=t.boundingData;for(let n=0;n<6;n++)rr[e+n]=s[n];if(i)return t.buffer?(ar.set(new Uint8Array(t.buffer),y),y+t.buffer.byteLength):(ei[e+6]=t.offset,Qi[o+14]=t.count,Qi[o+15]=sr,y+Pt);{const{left:n,right:r,splitAxis:a}=t,l=y+Pt;let p=es(l,n);const h=y/Pt,c=p/Pt-h;if(c>ac)throw new Error("MeshBVH: Cannot store relative child node offset greater than 32 bits.");return ei[e+6]=c,ei[e+7]=a,es(p,r)}}function cc(y,t,e,o,i){const{maxDepth:s,verbose:n,maxLeafSize:r,strategy:a,onProgress:l}=i,p=y.primitiveBuffer,h=y.primitiveBufferStride,u=new Float32Array(6);let c=!1;const f=new _i;return Ei(t,e,o,f.boundingData,u),m(f,e,o,u),f;function d(x){l&&l(x/o)}function m(x,g,b,z=null,v=0){if(!c&&v>=s&&(c=!0,n&&console.warn(`BVH: Max depth of ${s} reached when generating BVH. Consider increasing maxDepth.`)),b<=r||v>=s)return d(g+b),x.offset=g,x.count=b,x;const C=sc(x.boundingData,z,t,g,b,a);if(C.axis===-1)return d(g+b),x.offset=g,x.count=b,x;const B=rc(p,h,t,g,b,C);if(B===g||B===g+b)d(g+b),x.offset=g,x.count=b;else{x.splitAxis=C.axis;const A=new _i,M=g,_=B-g;x.left=A,Ei(t,M,_,A.boundingData,u),m(A,M,_,u,v+1);const P=new _i,k=B,T=b-_;x.right=P,Ei(t,k,T,P.boundingData,u),m(P,k,T,u,v+1)}return x}}function pc(y,t){const e=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,o=y.getRootRanges(t.range),i=o[0],s=o[o.length-1],n={offset:i.offset,count:s.offset+s.count-i.offset},r=new Float32Array(6*n.count);r.offset=n.offset,y.computePrimitiveBounds(n.offset,n.count,r),y._roots=o.map(a=>{const l=cc(y,r,a.offset,a.count,t),p=ts(l),h=new e(Pt*p);return lc(0,l,h),h})}class vs{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return t.length===0?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class hc{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=o=>{e&&t.push(e),e=o,this.float32Array=new Float32Array(o),this.uint16Array=new Uint16Array(o),this.uint32Array=new Uint32Array(o)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,t.length!==0&&this.setBuffer(t.pop())}}}const mt=new hc;let ke,Qe;const je=[],To=new vs(()=>new se);function yc(y,t,e,o,i,s){ke=To.getPrimitive(),Qe=To.getPrimitive(),je.push(ke,Qe),mt.setBuffer(y._roots[t]);const n=os(0,y.geometry,e,o,i,s);mt.clearBuffer(),To.releasePrimitive(ke),To.releasePrimitive(Qe),je.pop(),je.pop();const r=je.length;return r>0&&(Qe=je[r-1],ke=je[r-2]),n}function os(y,t,e,o,i=null,s=0,n=0){const{float32Array:r,uint16Array:a,uint32Array:l}=mt;let p=y*2;if(Mt(p,a)){const u=It(y,l),c=Nt(p,a);return bt(y,r,ke),o(u,c,!1,n,s+y/At,ke)}else{let _=function(k){const{uint16Array:T,uint32Array:F}=mt;let D=k*2;for(;!Mt(D,T);)k=St(k),D=k*2;return It(k,F)},P=function(k){const{uint16Array:T,uint32Array:F}=mt;let D=k*2;for(;!Mt(D,T);)k=Tt(k,F),D=k*2;return It(k,F)+Nt(D,T)};const u=St(y),c=Tt(y,l);let f=u,d=c,m,x,g,b;if(i&&(g=ke,b=Qe,bt(f,r,g),bt(d,r,b),m=i(g),x=i(b),x<m)){f=c,d=u;const k=m;m=x,x=k,g=b}g||(g=ke,bt(f,r,g));const z=Mt(f*2,a),v=e(g,z,m,n+1,s+f/At);let C;if(v===Js){const k=_(f),F=P(f)-k;C=o(k,F,!0,n+1,s+f/At,g)}else C=v&&os(f,t,e,o,i,s,n+1);if(C)return!0;b=Qe,bt(d,r,b);const B=Mt(d*2,a),A=e(b,B,x,n+1,s+d/At);let M;if(A===Js){const k=_(d),F=P(d)-k;M=o(k,F,!0,n+1,s+d/At,b)}else M=A&&os(d,t,e,o,i,s,n+1);return!!M}}const zo=new mt.constructor,yi=new mt.constructor,Fe=new vs(()=>new se),Ye=new se,Ge=new se,Si=new se,Ti=new se;let Di=!1;function uc(y,t,e,o){if(Di)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Di=!0;const i=y._roots,s=t._roots;let n,r=0,a=0;const l=new Rt().copy(e).invert();for(let p=0,h=i.length;p<h;p++){zo.setBuffer(i[p]),a=0;const u=Fe.getPrimitive();bt(0,zo.float32Array,u),u.applyMatrix4(l);for(let c=0,f=s.length;c<f&&(yi.setBuffer(s[c]),n=oe(0,0,e,l,o,r,a,0,0,u),yi.clearBuffer(),a+=s[c].byteLength/Pt,!n);c++);if(Fe.releasePrimitive(u),zo.clearBuffer(),r+=i[p].byteLength/Pt,n)break}return Di=!1,n}function oe(y,t,e,o,i,s=0,n=0,r=0,a=0,l=null,p=!1){let h,u;p?(h=yi,u=zo):(h=zo,u=yi);const c=h.float32Array,f=h.uint32Array,d=h.uint16Array,m=u.float32Array,x=u.uint32Array,g=u.uint16Array,b=y*2,z=t*2,v=Mt(b,d),C=Mt(z,g);let B=!1;if(C&&v)p?B=i(It(t,x),Nt(t*2,g),It(y,f),Nt(y*2,d),a,n+t/At,r,s+y/At):B=i(It(y,f),Nt(y*2,d),It(t,x),Nt(t*2,g),r,s+y/At,a,n+t/At);else if(C){const A=Fe.getPrimitive();bt(t,m,A),A.applyMatrix4(e);const M=St(y),_=Tt(y,f);bt(M,c,Ye),bt(_,c,Ge);const P=A.intersectsBox(Ye),k=A.intersectsBox(Ge);B=P&&oe(t,M,o,e,i,n,s,a,r+1,A,!p)||k&&oe(t,_,o,e,i,n,s,a,r+1,A,!p),Fe.releasePrimitive(A)}else{const A=St(t),M=Tt(t,x);bt(A,m,Si),bt(M,m,Ti);const _=l.intersectsBox(Si),P=l.intersectsBox(Ti);if(_&&P)B=oe(y,A,e,o,i,s,n,r,a+1,l,p)||oe(y,M,e,o,i,s,n,r,a+1,l,p);else if(_)if(v)B=oe(y,A,e,o,i,s,n,r,a+1,l,p);else{const k=Fe.getPrimitive();k.copy(Si).applyMatrix4(e);const T=St(y),F=Tt(y,f);bt(T,c,Ye),bt(F,c,Ge);const D=k.intersectsBox(Ye),J=k.intersectsBox(Ge);B=D&&oe(A,T,o,e,i,n,s,a,r+1,k,!p)||J&&oe(A,F,o,e,i,n,s,a,r+1,k,!p),Fe.releasePrimitive(k)}else if(P)if(v)B=oe(y,M,e,o,i,s,n,r,a+1,l,p);else{const k=Fe.getPrimitive();k.copy(Ti).applyMatrix4(e);const T=St(y),F=Tt(y,f);bt(T,c,Ye),bt(F,c,Ge);const D=k.intersectsBox(Ye),J=k.intersectsBox(Ge);B=D&&oe(M,T,o,e,i,n,s,a,r+1,k,!p)||J&&oe(M,F,o,e,i,n,s,a,r+1,k,!p),Fe.releasePrimitive(k)}}return B}const sn=new se,$e=new Float32Array(6);class dc{constructor(){this._roots=null,this.primitiveBuffer=null,this.primitiveBufferStride=null}init(t){t={...nr,...t},pc(this,t)}getRootRanges(){throw new Error("BVH: getRootRanges() not implemented")}writePrimitiveBounds(){throw new Error("BVH: writePrimitiveBounds() not implemented")}writePrimitiveRangeBounds(t,e,o,i){let s=1/0,n=1/0,r=1/0,a=-1/0,l=-1/0,p=-1/0;for(let h=t,u=t+e;h<u;h++){this.writePrimitiveBounds(h,$e,0);const[c,f,d,m,x,g]=$e;c<s&&(s=c),m>a&&(a=m),f<n&&(n=f),x>l&&(l=x),d<r&&(r=d),g>p&&(p=g)}return o[i+0]=s,o[i+1]=n,o[i+2]=r,o[i+3]=a,o[i+4]=l,o[i+5]=p,o}computePrimitiveBounds(t,e,o){const i=o.offset||0;for(let s=t,n=t+e;s<n;s++){this.writePrimitiveBounds(s,$e,0);const[r,a,l,p,h,u]=$e,c=(r+p)/2,f=(a+h)/2,d=(l+u)/2,m=(p-r)/2,x=(h-a)/2,g=(u-l)/2,b=(s-i)*6;o[b+0]=c,o[b+1]=m+(Math.abs(c)+m)*ti,o[b+2]=f,o[b+3]=x+(Math.abs(f)+x)*ti,o[b+4]=d,o[b+5]=g+(Math.abs(d)+g)*ti}return o}shiftPrimitiveOffsets(t){const e=this._indirectBuffer;if(e)for(let o=0,i=e.length;o<i;o++)e[o]+=t;else{const o=this._roots;for(let i=0;i<o.length;i++){const s=o[i],n=new Uint32Array(s),r=new Uint16Array(s),a=s.byteLength/Pt;for(let l=0;l<a;l++){const p=At*l,h=2*p;Mt(h,r)&&(n[p+6]+=t)}}}}traverse(t,e=0){const o=this._roots[e],i=new Uint32Array(o),s=new Uint16Array(o);n(0);function n(r,a=0){const l=r*2,p=Mt(l,s);if(p){const h=i[r+6],u=s[l+14];t(a,p,new Float32Array(o,r*4,6),h,u)}else{const h=St(r),u=Tt(r,i),c=zs(r,i);t(a,p,new Float32Array(o,r*4,6),c)||(n(h,a+1),n(u,a+1))}}}refit(){const t=this._roots;for(let e=0,o=t.length;e<o;e++){const i=t[e],s=new Uint32Array(i),n=new Uint16Array(i),r=new Float32Array(i),a=i.byteLength/Pt;for(let l=a-1;l>=0;l--){const p=l*At,h=p*2;if(Mt(h,n)){const c=It(p,s),f=Nt(h,n);this.writePrimitiveRangeBounds(c,f,$e,0),r.set($e,p)}else{const c=St(p),f=Tt(p,s);for(let d=0;d<3;d++){const m=r[c+d],x=r[c+d+3],g=r[f+d],b=r[f+d+3];r[p+d]=m<g?m:g,r[p+d+3]=x>b?x:b}}}}}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(o=>{bt(0,new Float32Array(o),sn),t.union(sn)}),t}shapecast(t){let{boundsTraverseOrder:e,intersectsBounds:o,intersectsRange:i,intersectsPrimitive:s,scratchPrimitive:n,iterate:r}=t;if(i&&s){const h=i;i=(u,c,f,d,m)=>h(u,c,f,d,m)?!0:r(u,c,this,s,f,d,n)}else i||(s?i=(h,u,c,f)=>r(h,u,this,s,c,f,n):i=(h,u,c)=>c);let a=!1,l=0;const p=this._roots;for(let h=0,u=p.length;h<u;h++){const c=p[h];if(a=yc(this,h,o,i,e,l),a)break;l+=c.byteLength/Pt}return a}bvhcast(t,e,o){let{intersectsRanges:i}=o;return uc(this,t,e,i)}}function fc(){return typeof SharedArrayBuffer<"u"}function Fs(y){return y.index?y.index.count:y.attributes.position.count}function zi(y){return Fs(y)/3}function mc(y,t=ArrayBuffer){return y>65535?new Uint32Array(new t(4*y)):new Uint16Array(new t(2*y))}function xc(y,t){if(!y.index){const e=y.attributes.position.count,o=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=mc(e,o);y.setIndex(new Ot(i,1));for(let s=0;s<e;s++)i[s]=s}}function gc(y,t,e){const o=Fs(y)/e,i=t||y.drawRange,s=i.start/e,n=(i.start+i.count)/e,r=Math.max(0,s),a=Math.min(o,n)-r;return{offset:Math.floor(r),count:Math.floor(a)}}function bc(y,t){return y.groups.map(e=>({offset:e.start/t,count:e.count/t}))}function nn(y,t,e){const o=gc(y,t,e),i=bc(y,e);if(!i.length)return[o];const s=[],n=o.offset,r=o.offset+o.count,a=Fs(y)/e,l=[];for(const u of i){const{offset:c,count:f}=u,d=c,m=isFinite(f)?f:a-c,x=c+m;d<r&&x>n&&(l.push({pos:Math.max(n,d),isStart:!0}),l.push({pos:Math.min(r,x),isStart:!1}))}l.sort((u,c)=>u.pos!==c.pos?u.pos-c.pos:u.type==="end"?-1:1);let p=0,h=null;for(const u of l){const c=u.pos;p!==0&&c!==h&&s.push({offset:h,count:c-h}),p+=u.isStart?1:-1,h=c}return s}function zc(y,t){const e=y[y.length-1],o=e.offset+e.count>2**16,i=y.reduce((l,p)=>l+p.count,0),s=o?4:2,n=t?new SharedArrayBuffer(i*s):new ArrayBuffer(i*s),r=o?new Uint32Array(n):new Uint16Array(n);let a=0;for(let l=0;l<y.length;l++){const{offset:p,count:h}=y[l];for(let u=0;u<h;u++)r[a+u]=p+u;a+=h}return r}class vc extends dc{get indirect(){return!!this._indirectBuffer}get primitiveStride(){return null}get primitiveBufferStride(){return this.indirect?1:this.primitiveStride}set primitiveBufferStride(t){}get primitiveBuffer(){return this.indirect?this._indirectBuffer:this.geometry.index.array}set primitiveBuffer(t){}constructor(t,e={}){if(t.isBufferGeometry){if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("BVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("BVH: Only BufferGeometries are supported.");if(e.useSharedArrayBuffer&&!fc())throw new Error("BVH: SharedArrayBuffer is not available.");super(),this.geometry=t,this.resolvePrimitiveIndex=e.indirect?o=>this._indirectBuffer[o]:o=>o,this.primitiveBuffer=null,this.primitiveBufferStride=null,this._indirectBuffer=null,e={...nr,...e},e[bs]||this.init(e)}init(t){const{geometry:e,primitiveStride:o}=this;if(t.indirect){const i=nn(e,t.range,o),s=zc(i,t.useSharedArrayBuffer);this._indirectBuffer=s}else xc(e,t);super.init(t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new se))}getRootRanges(t){return this.indirect?[{offset:0,count:this._indirectBuffer.length}]:nn(this.geometry,t,this.primitiveStride)}raycastObject3D(){throw new Error("BVH: raycastObject3D() not implemented")}}class xe{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let o=1/0,i=-1/0;for(let s=0,n=t.length;s<n;s++){const a=t[s][e];o=a<o?a:o,i=a>i?a:i}this.min=o,this.max=i}setFromPoints(t,e){let o=1/0,i=-1/0;for(let s=0,n=e.length;s<n;s++){const r=e[s],a=t.dot(r);o=a<o?a:o,i=a>i?a:i}this.min=o,this.max=i}isSeparated(t){return this.min>t.max||t.min>this.max}}xe.prototype.setFromBox=(function(){const y=new U;return function(e,o){const i=o.min,s=o.max;let n=1/0,r=-1/0;for(let a=0;a<=1;a++)for(let l=0;l<=1;l++)for(let p=0;p<=1;p++){y.x=i.x*a+s.x*(1-a),y.y=i.y*l+s.y*(1-l),y.z=i.z*p+s.z*(1-p);const h=e.dot(y);n=Math.min(h,n),r=Math.max(h,r)}this.min=n,this.max=r}})();const Fc=(function(){const y=new U,t=new U,e=new U;return function(i,s,n){const r=i.start,a=y,l=s.start,p=t;e.subVectors(r,l),y.subVectors(i.end,i.start),t.subVectors(s.end,s.start);const h=e.dot(p),u=p.dot(a),c=p.dot(p),f=e.dot(a),m=a.dot(a)*c-u*u;let x,g;m!==0?x=(h*u-f*c)/m:x=0,g=(h+x*u)/c,n.x=x,n.y=g}})(),ws=(function(){const y=new nt,t=new U,e=new U;return function(i,s,n,r){Fc(i,s,y);let a=y.x,l=y.y;if(a>=0&&a<=1&&l>=0&&l<=1){i.at(a,n),s.at(l,r);return}else if(a>=0&&a<=1){l<0?s.at(0,r):s.at(1,r),i.closestPointToPoint(r,!0,n);return}else if(l>=0&&l<=1){a<0?i.at(0,n):i.at(1,n),s.closestPointToPoint(n,!0,r);return}else{let p;a<0?p=i.start:p=i.end;let h;l<0?h=s.start:h=s.end;const u=t,c=e;if(i.closestPointToPoint(h,!0,t),s.closestPointToPoint(p,!0,e),u.distanceToSquared(h)<=c.distanceToSquared(p)){n.copy(u),r.copy(h);return}else{n.copy(p),r.copy(c);return}}}})(),wc=(function(){const y=new U,t=new U,e=new xi,o=new Kt;return function(s,n){const{radius:r,center:a}=s,{a:l,b:p,c:h}=n;if(o.start=l,o.end=p,o.closestPointToPoint(a,!0,y).distanceTo(a)<=r||(o.start=l,o.end=h,o.closestPointToPoint(a,!0,y).distanceTo(a)<=r)||(o.start=p,o.end=h,o.closestPointToPoint(a,!0,y).distanceTo(a)<=r))return!0;const d=n.getPlane(e);if(Math.abs(d.distanceToPoint(a))<=r){const x=d.projectPoint(a,t);if(n.containsPoint(x))return!0}return!1}})(),kc=["x","y","z"],fe=1e-15,rn=fe*fe;function $t(y){return Math.abs(y)<fe}class Jt extends jt{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new U),this.satBounds=new Array(4).fill().map(()=>new xe),this.points=[this.a,this.b,this.c],this.plane=new xi,this.isDegenerateIntoSegment=!1,this.isDegenerateIntoPoint=!1,this.degenerateSegment=new Kt,this.needsUpdate=!0}intersectsSphere(t){return wc(t,this)}update(){const t=this.a,e=this.b,o=this.c,i=this.points,s=this.satAxes,n=this.satBounds,r=s[0],a=n[0];this.getNormal(r),a.setFromPoints(r,i);const l=s[1],p=n[1];l.subVectors(t,e),p.setFromPoints(l,i);const h=s[2],u=n[2];h.subVectors(e,o),u.setFromPoints(h,i);const c=s[3],f=n[3];c.subVectors(o,t),f.setFromPoints(c,i);const d=l.length(),m=h.length(),x=c.length();this.isDegenerateIntoPoint=!1,this.isDegenerateIntoSegment=!1,d<fe?m<fe||x<fe?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(t),this.degenerateSegment.end.copy(o)):m<fe?x<fe?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(e),this.degenerateSegment.end.copy(t)):x<fe&&(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(o),this.degenerateSegment.end.copy(e)),this.plane.setFromNormalAndCoplanarPoint(r,t),this.needsUpdate=!1}}Jt.prototype.closestPointToSegment=(function(){const y=new U,t=new U,e=new Kt;return function(i,s=null,n=null){const{start:r,end:a}=i,l=this.points;let p,h=1/0;for(let u=0;u<3;u++){const c=(u+1)%3;e.start.copy(l[u]),e.end.copy(l[c]),ws(e,i,y,t),p=y.distanceToSquared(t),p<h&&(h=p,s&&s.copy(y),n&&n.copy(t))}return this.closestPointToPoint(r,y),p=r.distanceToSquared(y),p<h&&(h=p,s&&s.copy(y),n&&n.copy(r)),this.closestPointToPoint(a,y),p=a.distanceToSquared(y),p<h&&(h=p,s&&s.copy(y),n&&n.copy(a)),Math.sqrt(h)}})();Jt.prototype.intersectsTriangle=(function(){const y=new Jt,t=new xe,e=new xe,o=new U,i=new U,s=new U,n=new U,r=new Kt,a=new Kt,l=new U,p=new nt,h=new nt;function u(b,z,v,C){const B=o;!b.isDegenerateIntoPoint&&!b.isDegenerateIntoSegment?B.copy(b.plane.normal):B.copy(z.plane.normal);const A=b.satBounds,M=b.satAxes;for(let k=1;k<4;k++){const T=A[k],F=M[k];if(t.setFromPoints(F,z.points),T.isSeparated(t)||(n.copy(B).cross(F),t.setFromPoints(n,b.points),e.setFromPoints(n,z.points),t.isSeparated(e)))return!1}const _=z.satBounds,P=z.satAxes;for(let k=1;k<4;k++){const T=_[k],F=P[k];if(t.setFromPoints(F,b.points),T.isSeparated(t)||(n.crossVectors(B,F),t.setFromPoints(n,b.points),e.setFromPoints(n,z.points),t.isSeparated(e)))return!1}return v&&(C||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),v.start.set(0,0,0),v.end.set(0,0,0)),!0}function c(b,z,v,C,B,A,M,_,P,k,T){let F=M/(M-_);k.x=C+(B-C)*F,T.start.subVectors(z,b).multiplyScalar(F).add(b),F=M/(M-P),k.y=C+(A-C)*F,T.end.subVectors(v,b).multiplyScalar(F).add(b)}function f(b,z,v,C,B,A,M,_,P,k,T){if(B>0)c(b.c,b.a,b.b,C,z,v,P,M,_,k,T);else if(A>0)c(b.b,b.a,b.c,v,z,C,_,M,P,k,T);else if(_*P>0||M!=0)c(b.a,b.b,b.c,z,v,C,M,_,P,k,T);else if(_!=0)c(b.b,b.a,b.c,v,z,C,_,M,P,k,T);else if(P!=0)c(b.c,b.a,b.b,C,z,v,P,M,_,k,T);else return!0;return!1}function d(b,z,v,C){const B=z.degenerateSegment,A=b.plane.distanceToPoint(B.start),M=b.plane.distanceToPoint(B.end);return $t(A)?$t(M)?u(b,z,v,C):(v&&(v.start.copy(B.start),v.end.copy(B.start)),b.containsPoint(B.start)):$t(M)?(v&&(v.start.copy(B.end),v.end.copy(B.end)),b.containsPoint(B.end)):b.plane.intersectLine(B,o)!=null?(v&&(v.start.copy(o),v.end.copy(o)),b.containsPoint(o)):!1}function m(b,z,v){const C=z.a;return $t(b.plane.distanceToPoint(C))&&b.containsPoint(C)?(v&&(v.start.copy(C),v.end.copy(C)),!0):!1}function x(b,z,v){const C=b.degenerateSegment,B=z.a;return C.closestPointToPoint(B,!0,o),B.distanceToSquared(o)<rn?(v&&(v.start.copy(B),v.end.copy(B)),!0):!1}function g(b,z,v,C){if(b.isDegenerateIntoSegment)if(z.isDegenerateIntoSegment){const B=b.degenerateSegment,A=z.degenerateSegment,M=i,_=s;B.delta(M),A.delta(_);const P=o.subVectors(A.start,B.start),k=M.x*_.y-M.y*_.x;if($t(k))return!1;const T=(P.x*_.y-P.y*_.x)/k,F=-(M.x*P.y-M.y*P.x)/k;if(T<0||T>1||F<0||F>1)return!1;const D=B.start.z+M.z*T,J=A.start.z+_.z*F;return $t(D-J)?(v&&(v.start.copy(B.start).addScaledVector(M,T),v.end.copy(B.start).addScaledVector(M,T)),!0):!1}else return z.isDegenerateIntoPoint?x(b,z,v):d(z,b,v,C);else{if(b.isDegenerateIntoPoint)return z.isDegenerateIntoPoint?z.a.distanceToSquared(b.a)<rn?(v&&(v.start.copy(b.a),v.end.copy(b.a)),!0):!1:z.isDegenerateIntoSegment?x(z,b,v):m(z,b,v);if(z.isDegenerateIntoPoint)return m(b,z,v);if(z.isDegenerateIntoSegment)return d(b,z,v,C)}}return function(z,v=null,C=!1){this.needsUpdate&&this.update(),z.isExtendedTriangle?z.needsUpdate&&z.update():(y.copy(z),y.update(),z=y);const B=g(this,z,v,C);if(B!==void 0)return B;const A=this.plane,M=z.plane;let _=M.distanceToPoint(this.a),P=M.distanceToPoint(this.b),k=M.distanceToPoint(this.c);$t(_)&&(_=0),$t(P)&&(P=0),$t(k)&&(k=0);const T=_*P,F=_*k;if(T>0&&F>0)return!1;let D=A.distanceToPoint(z.a),J=A.distanceToPoint(z.b),Z=A.distanceToPoint(z.c);$t(D)&&(D=0),$t(J)&&(J=0),$t(Z)&&(Z=0);const rt=D*J,$=D*Z;if(rt>0&&$>0)return!1;i.copy(A.normal),s.copy(M.normal);const et=i.cross(s);let N=0,L=Math.abs(et.x);const Y=Math.abs(et.y);Y>L&&(L=Y,N=1),Math.abs(et.z)>L&&(N=2);const W=kc[N],ft=this.a[W],Et=this.b[W],ct=this.c[W],yt=z.a[W],wt=z.b[W],xt=z.c[W];if(f(this,ft,Et,ct,T,F,_,P,k,p,r))return u(this,z,v,C);if(f(z,yt,wt,xt,rt,$,D,J,Z,h,a))return u(this,z,v,C);if(p.y<p.x){const Xt=p.y;p.y=p.x,p.x=Xt,l.copy(r.start),r.start.copy(r.end),r.end.copy(l)}if(h.y<h.x){const Xt=h.y;h.y=h.x,h.x=Xt,l.copy(a.start),a.start.copy(a.end),a.end.copy(l)}return p.y<h.x||h.y<p.x?!1:(v&&(h.x>p.x?v.start.copy(a.start):v.start.copy(r.start),h.y<p.y?v.end.copy(a.end):v.end.copy(r.end)),!0)}})();Jt.prototype.distanceToPoint=(function(){const y=new U;return function(e){return this.closestPointToPoint(e,y),e.distanceTo(y)}})();Jt.prototype.distanceToTriangle=(function(){const y=new U,t=new U,e=["a","b","c"],o=new Kt,i=new Kt;return function(n,r=null,a=null){const l=r||a?o:null;if(this.intersectsTriangle(n,l))return(r||a)&&(r&&l.getCenter(r),a&&l.getCenter(a)),0;let p=1/0;for(let h=0;h<3;h++){let u;const c=e[h],f=n[c];this.closestPointToPoint(f,y),u=f.distanceToSquared(y),u<p&&(p=u,r&&r.copy(y),a&&a.copy(f));const d=this[c];n.closestPointToPoint(d,y),u=d.distanceToSquared(y),u<p&&(p=u,r&&r.copy(d),a&&a.copy(y))}for(let h=0;h<3;h++){const u=e[h],c=e[(h+1)%3];o.set(this[u],this[c]);for(let f=0;f<3;f++){const d=e[f],m=e[(f+1)%3];i.set(n[d],n[m]),ws(o,i,y,t);const x=y.distanceToSquared(t);x<p&&(p=x,r&&r.copy(y),a&&a.copy(t))}}return Math.sqrt(p)}})();class Ut{constructor(t,e,o){this.isOrientedBox=!0,this.min=new U,this.max=new U,this.matrix=new Rt,this.invMatrix=new Rt,this.points=new Array(8).fill().map(()=>new U),this.satAxes=new Array(3).fill().map(()=>new U),this.satBounds=new Array(3).fill().map(()=>new xe),this.alignedSatBounds=new Array(3).fill().map(()=>new xe),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),o&&this.matrix.copy(o)}set(t,e,o){this.min.copy(t),this.max.copy(e),this.matrix.copy(o),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}Ut.prototype.update=(function(){return function(){const t=this.matrix,e=this.min,o=this.max,i=this.points;for(let l=0;l<=1;l++)for(let p=0;p<=1;p++)for(let h=0;h<=1;h++){const u=1*l|2*p|4*h,c=i[u];c.x=l?o.x:e.x,c.y=p?o.y:e.y,c.z=h?o.z:e.z,c.applyMatrix4(t)}const s=this.satBounds,n=this.satAxes,r=i[0];for(let l=0;l<3;l++){const p=n[l],h=s[l],u=1<<l,c=i[u];p.subVectors(r,c),h.setFromPoints(p,i)}const a=this.alignedSatBounds;a[0].setFromPointsField(i,"x"),a[1].setFromPointsField(i,"y"),a[2].setFromPointsField(i,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}})();Ut.prototype.intersectsBox=(function(){const y=new xe;return function(e){this.needsUpdate&&this.update();const o=e.min,i=e.max,s=this.satBounds,n=this.satAxes,r=this.alignedSatBounds;if(y.min=o.x,y.max=i.x,r[0].isSeparated(y)||(y.min=o.y,y.max=i.y,r[1].isSeparated(y))||(y.min=o.z,y.max=i.z,r[2].isSeparated(y)))return!1;for(let a=0;a<3;a++){const l=n[a],p=s[a];if(y.setFromBox(l,e),p.isSeparated(y))return!1}return!0}})();Ut.prototype.intersectsTriangle=(function(){const y=new Jt,t=new Array(3),e=new xe,o=new xe,i=new U;return function(n){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(y.copy(n),y.update(),n=y);const r=this.satBounds,a=this.satAxes;t[0]=n.a,t[1]=n.b,t[2]=n.c;for(let u=0;u<3;u++){const c=r[u],f=a[u];if(e.setFromPoints(f,t),c.isSeparated(e))return!1}const l=n.satBounds,p=n.satAxes,h=this.points;for(let u=0;u<3;u++){const c=l[u],f=p[u];if(e.setFromPoints(f,h),c.isSeparated(e))return!1}for(let u=0;u<3;u++){const c=a[u];for(let f=0;f<4;f++){const d=p[f];if(i.crossVectors(c,d),e.setFromPoints(i,t),o.setFromPoints(i,h),e.isSeparated(o))return!1}}return!0}})();Ut.prototype.closestPointToPoint=(function(){return function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}})();Ut.prototype.distanceToPoint=(function(){const y=new U;return function(e){return this.closestPointToPoint(e,y),e.distanceTo(y)}})();Ut.prototype.distanceToBox=(function(){const y=["x","y","z"],t=new Array(12).fill().map(()=>new Kt),e=new Array(12).fill().map(()=>new Kt),o=new U,i=new U;return function(n,r=0,a=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(n))return(a||l)&&(n.getCenter(i),this.closestPointToPoint(i,o),n.closestPointToPoint(o,i),a&&a.copy(o),l&&l.copy(i)),0;const p=r*r,h=n.min,u=n.max,c=this.points;let f=1/0;for(let m=0;m<8;m++){const x=c[m];i.copy(x).clamp(h,u);const g=x.distanceToSquared(i);if(g<f&&(f=g,a&&a.copy(x),l&&l.copy(i),g<p))return Math.sqrt(g)}let d=0;for(let m=0;m<3;m++)for(let x=0;x<=1;x++)for(let g=0;g<=1;g++){const b=(m+1)%3,z=(m+2)%3,v=x<<b|g<<z,C=1<<m|x<<b|g<<z,B=c[v],A=c[C];t[d].set(B,A);const _=y[m],P=y[b],k=y[z],T=e[d],F=T.start,D=T.end;F[_]=h[_],F[P]=x?h[P]:u[P],F[k]=g?h[k]:u[P],D[_]=u[_],D[P]=x?h[P]:u[P],D[k]=g?h[k]:u[P],d++}for(let m=0;m<=1;m++)for(let x=0;x<=1;x++)for(let g=0;g<=1;g++){i.x=m?u.x:h.x,i.y=x?u.y:h.y,i.z=g?u.z:h.z,this.closestPointToPoint(i,o);const b=i.distanceToSquared(o);if(b<f&&(f=b,a&&a.copy(o),l&&l.copy(i),b<p))return Math.sqrt(b)}for(let m=0;m<12;m++){const x=t[m];for(let g=0;g<12;g++){const b=e[g];ws(x,b,o,i);const z=o.distanceToSquared(i);if(z<f&&(f=z,a&&a.copy(o),l&&l.copy(i),z<p))return Math.sqrt(z)}}return Math.sqrt(f)}})();class Bc extends vs{constructor(){super(()=>new Jt)}}const qt=new Bc,ho=new U,Pi=new U;function Cc(y,t,e={},o=0,i=1/0){const s=o*o,n=i*i;let r=1/0,a=null;if(y.shapecast({boundsTraverseOrder:p=>(ho.copy(t).clamp(p.min,p.max),ho.distanceToSquared(t)),intersectsBounds:(p,h,u)=>u<r&&u<n,intersectsTriangle:(p,h)=>{p.closestPointToPoint(t,ho);const u=t.distanceToSquared(ho);return u<r&&(Pi.copy(ho),r=u,a=h),u<s}}),r===1/0)return null;const l=Math.sqrt(r);return e.point?e.point.copy(Pi):e.point=Pi.clone(),e.distance=l,e.faceIndex=a,e}const Do=parseInt(us)>=169,Ac=parseInt(us)<=161,Ee=new U,_e=new U,Se=new U,Po=new nt,Io=new nt,Ro=new nt,an=new U,ln=new U,cn=new U,yo=new U;function Mc(y,t,e,o,i,s,n,r){let a;if(s===na?a=y.intersectTriangle(o,e,t,!0,i):a=y.intersectTriangle(t,e,o,s!==Ae,i),a===null)return null;const l=y.origin.distanceTo(i);return l<n||l>r?null:{distance:l,point:i.clone()}}function pn(y,t,e,o,i,s,n,r,a,l,p){Ee.fromBufferAttribute(t,s),_e.fromBufferAttribute(t,n),Se.fromBufferAttribute(t,r);const h=Mc(y,Ee,_e,Se,yo,a,l,p);if(h){if(o){Po.fromBufferAttribute(o,s),Io.fromBufferAttribute(o,n),Ro.fromBufferAttribute(o,r),h.uv=new nt;const c=jt.getInterpolation(yo,Ee,_e,Se,Po,Io,Ro,h.uv);Do||(h.uv=c)}if(i){Po.fromBufferAttribute(i,s),Io.fromBufferAttribute(i,n),Ro.fromBufferAttribute(i,r),h.uv1=new nt;const c=jt.getInterpolation(yo,Ee,_e,Se,Po,Io,Ro,h.uv1);Do||(h.uv1=c),Ac&&(h.uv2=h.uv1)}if(e){an.fromBufferAttribute(e,s),ln.fromBufferAttribute(e,n),cn.fromBufferAttribute(e,r),h.normal=new U;const c=jt.getInterpolation(yo,Ee,_e,Se,an,ln,cn,h.normal);h.normal.dot(y.direction)>0&&h.normal.multiplyScalar(-1),Do||(h.normal=c)}const u={a:s,b:n,c:r,normal:new U,materialIndex:0};if(jt.getNormal(Ee,_e,Se,u.normal),h.face=u,h.faceIndex=s,Do){const c=new U;jt.getBarycoord(yo,Ee,_e,Se,c),h.barycoord=c}}return h}function hn(y){return y&&y.isMaterial?y.side:y}function vi(y,t,e,o,i,s,n){const r=o*3;let a=r+0,l=r+1,p=r+2;const{index:h,groups:u}=y;y.index&&(a=h.getX(a),l=h.getX(l),p=h.getX(p));const{position:c,normal:f,uv:d,uv1:m}=y.attributes;if(Array.isArray(t)){const x=o*3;for(let g=0,b=u.length;g<b;g++){const{start:z,count:v,materialIndex:C}=u[g];if(x>=z&&x<z+v){const B=hn(t[C]),A=pn(e,c,f,d,m,a,l,p,B,s,n);if(A)if(A.faceIndex=o,A.face.materialIndex=C,i)i.push(A);else return A}}}else{const x=hn(t),g=pn(e,c,f,d,m,a,l,p,x,s,n);if(g)if(g.faceIndex=o,g.face.materialIndex=0,i)i.push(g);else return g}return null}function Bt(y,t,e,o){const i=y.a,s=y.b,n=y.c;let r=t,a=t+1,l=t+2;e&&(r=e.getX(r),a=e.getX(a),l=e.getX(l)),i.x=o.getX(r),i.y=o.getY(r),i.z=o.getZ(r),s.x=o.getX(a),s.y=o.getY(a),s.z=o.getZ(a),n.x=o.getX(l),n.y=o.getY(l),n.z=o.getZ(l)}function Ec(y,t,e,o,i,s,n,r){const{geometry:a,_indirectBuffer:l}=y;for(let p=o,h=o+i;p<h;p++)vi(a,t,e,p,s,n,r)}function _c(y,t,e,o,i,s,n){const{geometry:r,_indirectBuffer:a}=y;let l=1/0,p=null;for(let h=o,u=o+i;h<u;h++){let c;c=vi(r,t,e,h,null,s,n),c&&c.distance<l&&(p=c,l=c.distance)}return p}function Sc(y,t,e,o,i,s,n){const{geometry:r}=e,{index:a}=r,l=r.attributes.position;for(let p=y,h=t+y;p<h;p++){let u;if(u=p,Bt(n,u*3,a,l),n.needsUpdate=!0,o(n,u,i,s))return!0}return!1}function Tc(y,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=y.geometry,o=e.index?e.index.array:null,i=e.attributes.position;let s,n,r,a,l=0;const p=y._roots;for(let u=0,c=p.length;u<c;u++)s=p[u],n=new Uint32Array(s),r=new Uint16Array(s),a=new Float32Array(s),h(0,l),l+=s.byteLength;function h(u,c,f=!1){const d=u*2;if(Mt(d,r)){const m=It(u,n),x=Nt(d,r);let g=1/0,b=1/0,z=1/0,v=-1/0,C=-1/0,B=-1/0;for(let A=3*m,M=3*(m+x);A<M;A++){let _=o[A];const P=i.getX(_),k=i.getY(_),T=i.getZ(_);P<g&&(g=P),P>v&&(v=P),k<b&&(b=k),k>C&&(C=k),T<z&&(z=T),T>B&&(B=T)}return a[u+0]!==g||a[u+1]!==b||a[u+2]!==z||a[u+3]!==v||a[u+4]!==C||a[u+5]!==B?(a[u+0]=g,a[u+1]=b,a[u+2]=z,a[u+3]=v,a[u+4]=C,a[u+5]=B,!0):!1}else{const m=St(u),x=Tt(u,n);let g=f,b=!1,z=!1;if(t){if(!g){const _=m/At+c/Pt,P=x/At+c/Pt;b=t.has(_),z=t.has(P),g=!b&&!z}}else b=!0,z=!0;const v=g||b,C=g||z;let B=!1;v&&(B=h(m,c,g));let A=!1;C&&(A=h(x,c,g));const M=B||A;if(M)for(let _=0;_<3;_++){const P=m+_,k=x+_,T=a[P],F=a[P+3],D=a[k],J=a[k+3];a[u+_]=T<D?T:D,a[u+_+3]=F>J?F:J}return M}}}function Me(y,t,e,o,i){let s,n,r,a,l,p;const h=1/e.direction.x,u=1/e.direction.y,c=1/e.direction.z,f=e.origin.x,d=e.origin.y,m=e.origin.z;let x=t[y],g=t[y+3],b=t[y+1],z=t[y+3+1],v=t[y+2],C=t[y+3+2];return h>=0?(s=(x-f)*h,n=(g-f)*h):(s=(g-f)*h,n=(x-f)*h),u>=0?(r=(b-d)*u,a=(z-d)*u):(r=(z-d)*u,a=(b-d)*u),s>a||r>n||((r>s||isNaN(s))&&(s=r),(a<n||isNaN(n))&&(n=a),c>=0?(l=(v-m)*c,p=(C-m)*c):(l=(C-m)*c,p=(v-m)*c),s>p||l>n)?!1:((l>s||s!==s)&&(s=l),(p<n||n!==n)&&(n=p),s<=i&&n>=o)}function Dc(y,t,e,o,i,s,n,r){const{geometry:a,_indirectBuffer:l}=y;for(let p=o,h=o+i;p<h;p++){let u=l?l[p]:p;vi(a,t,e,u,s,n,r)}}function Pc(y,t,e,o,i,s,n){const{geometry:r,_indirectBuffer:a}=y;let l=1/0,p=null;for(let h=o,u=o+i;h<u;h++){let c;c=vi(r,t,e,a?a[h]:h,null,s,n),c&&c.distance<l&&(p=c,l=c.distance)}return p}function Ic(y,t,e,o,i,s,n){const{geometry:r}=e,{index:a}=r,l=r.attributes.position;for(let p=y,h=t+y;p<h;p++){let u;if(u=e.resolveTriangleIndex(p),Bt(n,u*3,a,l),n.needsUpdate=!0,o(n,u,i,s))return!0}return!1}function Rc(y,t,e,o,i,s,n){mt.setBuffer(y._roots[t]),is(0,y,e,o,i,s,n),mt.clearBuffer()}function is(y,t,e,o,i,s,n){const{float32Array:r,uint16Array:a,uint32Array:l}=mt,p=y*2;if(Mt(p,a)){const u=It(y,l),c=Nt(p,a);Ec(t,e,o,u,c,i,s,n)}else{const u=St(y);Me(u,r,o,s,n)&&is(u,t,e,o,i,s,n);const c=Tt(y,l);Me(c,r,o,s,n)&&is(c,t,e,o,i,s,n)}}const Lc=["x","y","z"];function Oc(y,t,e,o,i,s){mt.setBuffer(y._roots[t]);const n=ss(0,y,e,o,i,s);return mt.clearBuffer(),n}function ss(y,t,e,o,i,s){const{float32Array:n,uint16Array:r,uint32Array:a}=mt;let l=y*2;if(Mt(l,r)){const h=It(y,a),u=Nt(l,r);return _c(t,e,o,h,u,i,s)}else{const h=zs(y,a),u=Lc[h],f=o.direction[u]>=0;let d,m;f?(d=St(y),m=Tt(y,a)):(d=Tt(y,a),m=St(y));const g=Me(d,n,o,i,s)?ss(d,t,e,o,i,s):null;if(g){const v=g.point[u];if(f?v<=n[m+h]:v>=n[m+h+3])return g}const z=Me(m,n,o,i,s)?ss(m,t,e,o,i,s):null;return g&&z?g.distance<=z.distance?g:z:g||z||null}}const Lo=new se,Ve=new Jt,He=new Jt,uo=new Rt,yn=new Ut,Oo=new Ut;function Nc(y,t,e,o){mt.setBuffer(y._roots[t]);const i=ns(0,y,e,o);return mt.clearBuffer(),i}function ns(y,t,e,o,i=null){const{float32Array:s,uint16Array:n,uint32Array:r}=mt;let a=y*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),yn.set(e.boundingBox.min,e.boundingBox.max,o),i=yn),Mt(a,n)){const p=t.geometry,h=p.index,u=p.attributes.position,c=e.index,f=e.attributes.position,d=It(y,r),m=Nt(a,n);if(uo.copy(o).invert(),e.boundsTree)return bt(y,s,Oo),Oo.matrix.copy(uo),Oo.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:g=>Oo.intersectsBox(g),intersectsTriangle:g=>{g.a.applyMatrix4(o),g.b.applyMatrix4(o),g.c.applyMatrix4(o),g.needsUpdate=!0;for(let b=d*3,z=(m+d)*3;b<z;b+=3)if(Bt(He,b,h,u),He.needsUpdate=!0,g.intersectsTriangle(He))return!0;return!1}});{const x=zi(e);for(let g=d*3,b=(m+d)*3;g<b;g+=3){Bt(Ve,g,h,u),Ve.a.applyMatrix4(uo),Ve.b.applyMatrix4(uo),Ve.c.applyMatrix4(uo),Ve.needsUpdate=!0;for(let z=0,v=x*3;z<v;z+=3)if(Bt(He,z,c,f),He.needsUpdate=!0,Ve.intersectsTriangle(He))return!0}}}else{const p=St(y),h=Tt(y,r);return bt(p,s,Lo),!!(i.intersectsBox(Lo)&&ns(p,t,e,o,i)||(bt(h,s,Lo),i.intersectsBox(Lo)&&ns(h,t,e,o,i)))}}const No=new Rt,Ii=new Ut,fo=new Ut,Uc=new U,Xc=new U,Zc=new U,jc=new U;function Yc(y,t,e,o={},i={},s=0,n=1/0){t.boundingBox||t.computeBoundingBox(),Ii.set(t.boundingBox.min,t.boundingBox.max,e),Ii.needsUpdate=!0;const r=y.geometry,a=r.attributes.position,l=r.index,p=t.attributes.position,h=t.index,u=qt.getPrimitive(),c=qt.getPrimitive();let f=Uc,d=Xc,m=null,x=null;i&&(m=Zc,x=jc);let g=1/0,b=null,z=null;return No.copy(e).invert(),fo.matrix.copy(No),y.shapecast({boundsTraverseOrder:v=>Ii.distanceToBox(v),intersectsBounds:(v,C,B)=>B<g&&B<n?(C&&(fo.min.copy(v.min),fo.max.copy(v.max),fo.needsUpdate=!0),!0):!1,intersectsRange:(v,C)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:A=>fo.distanceToBox(A),intersectsBounds:(A,M,_)=>_<g&&_<n,intersectsRange:(A,M)=>{for(let _=A,P=A+M;_<P;_++){Bt(c,3*_,h,p),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let k=v,T=v+C;k<T;k++){Bt(u,3*k,l,a),u.needsUpdate=!0;const F=u.distanceToTriangle(c,f,m);if(F<g&&(d.copy(f),x&&x.copy(m),g=F,b=k,z=_),F<s)return!0}}}});{const B=zi(t);for(let A=0,M=B;A<M;A++){Bt(c,3*A,h,p),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let _=v,P=v+C;_<P;_++){Bt(u,3*_,l,a),u.needsUpdate=!0;const k=u.distanceToTriangle(c,f,m);if(k<g&&(d.copy(f),x&&x.copy(m),g=k,b=_,z=A),k<s)return!0}}}}}),qt.releasePrimitive(u),qt.releasePrimitive(c),g===1/0?null:(o.point?o.point.copy(d):o.point=d.clone(),o.distance=g,o.faceIndex=b,i&&(i.point?i.point.copy(x):i.point=x.clone(),i.point.applyMatrix4(No),d.applyMatrix4(No),i.distance=d.sub(i.point).length(),i.faceIndex=z),o)}function Gc(y,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=y.geometry,o=e.index?e.index.array:null,i=e.attributes.position;let s,n,r,a,l=0;const p=y._roots;for(let u=0,c=p.length;u<c;u++)s=p[u],n=new Uint32Array(s),r=new Uint16Array(s),a=new Float32Array(s),h(0,l),l+=s.byteLength;function h(u,c,f=!1){const d=u*2;if(Mt(d,r)){const m=It(u,n),x=Nt(d,r);let g=1/0,b=1/0,z=1/0,v=-1/0,C=-1/0,B=-1/0;for(let A=m,M=m+x;A<M;A++){const _=3*y.resolveTriangleIndex(A);for(let P=0;P<3;P++){let k=_+P;k=o?o[k]:k;const T=i.getX(k),F=i.getY(k),D=i.getZ(k);T<g&&(g=T),T>v&&(v=T),F<b&&(b=F),F>C&&(C=F),D<z&&(z=D),D>B&&(B=D)}}return a[u+0]!==g||a[u+1]!==b||a[u+2]!==z||a[u+3]!==v||a[u+4]!==C||a[u+5]!==B?(a[u+0]=g,a[u+1]=b,a[u+2]=z,a[u+3]=v,a[u+4]=C,a[u+5]=B,!0):!1}else{const m=St(u),x=Tt(u,n);let g=f,b=!1,z=!1;if(t){if(!g){const _=m/At+c/Pt,P=x/At+c/Pt;b=t.has(_),z=t.has(P),g=!b&&!z}}else b=!0,z=!0;const v=g||b,C=g||z;let B=!1;v&&(B=h(m,c,g));let A=!1;C&&(A=h(x,c,g));const M=B||A;if(M)for(let _=0;_<3;_++){const P=m+_,k=x+_,T=a[P],F=a[P+3],D=a[k],J=a[k+3];a[u+_]=T<D?T:D,a[u+_+3]=F>J?F:J}return M}}}function $c(y,t,e,o,i,s,n){mt.setBuffer(y._roots[t]),rs(0,y,e,o,i,s,n),mt.clearBuffer()}function rs(y,t,e,o,i,s,n){const{float32Array:r,uint16Array:a,uint32Array:l}=mt,p=y*2;if(Mt(p,a)){const u=It(y,l),c=Nt(p,a);Dc(t,e,o,u,c,i,s,n)}else{const u=St(y);Me(u,r,o,s,n)&&rs(u,t,e,o,i,s,n);const c=Tt(y,l);Me(c,r,o,s,n)&&rs(c,t,e,o,i,s,n)}}const Vc=["x","y","z"];function Hc(y,t,e,o,i,s){mt.setBuffer(y._roots[t]);const n=as(0,y,e,o,i,s);return mt.clearBuffer(),n}function as(y,t,e,o,i,s){const{float32Array:n,uint16Array:r,uint32Array:a}=mt;let l=y*2;if(Mt(l,r)){const h=It(y,a),u=Nt(l,r);return Pc(t,e,o,h,u,i,s)}else{const h=zs(y,a),u=Vc[h],f=o.direction[u]>=0;let d,m;f?(d=St(y),m=Tt(y,a)):(d=Tt(y,a),m=St(y));const g=Me(d,n,o,i,s)?as(d,t,e,o,i,s):null;if(g){const v=g.point[u];if(f?v<=n[m+h]:v>=n[m+h+3])return g}const z=Me(m,n,o,i,s)?as(m,t,e,o,i,s):null;return g&&z?g.distance<=z.distance?g:z:g||z||null}}const Uo=new se,We=new Jt,qe=new Jt,mo=new Rt,un=new Ut,Xo=new Ut;function Wc(y,t,e,o){mt.setBuffer(y._roots[t]);const i=ls(0,y,e,o);return mt.clearBuffer(),i}function ls(y,t,e,o,i=null){const{float32Array:s,uint16Array:n,uint32Array:r}=mt;let a=y*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),un.set(e.boundingBox.min,e.boundingBox.max,o),i=un),Mt(a,n)){const p=t.geometry,h=p.index,u=p.attributes.position,c=e.index,f=e.attributes.position,d=It(y,r),m=Nt(a,n);if(mo.copy(o).invert(),e.boundsTree)return bt(y,s,Xo),Xo.matrix.copy(mo),Xo.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:g=>Xo.intersectsBox(g),intersectsTriangle:g=>{g.a.applyMatrix4(o),g.b.applyMatrix4(o),g.c.applyMatrix4(o),g.needsUpdate=!0;for(let b=d,z=m+d;b<z;b++)if(Bt(qe,3*t.resolveTriangleIndex(b),h,u),qe.needsUpdate=!0,g.intersectsTriangle(qe))return!0;return!1}});{const x=zi(e);for(let g=d,b=m+d;g<b;g++){const z=t.resolveTriangleIndex(g);Bt(We,3*z,h,u),We.a.applyMatrix4(mo),We.b.applyMatrix4(mo),We.c.applyMatrix4(mo),We.needsUpdate=!0;for(let v=0,C=x*3;v<C;v+=3)if(Bt(qe,v,c,f),qe.needsUpdate=!0,We.intersectsTriangle(qe))return!0}}}else{const p=St(y),h=Tt(y,r);return bt(p,s,Uo),!!(i.intersectsBox(Uo)&&ls(p,t,e,o,i)||(bt(h,s,Uo),i.intersectsBox(Uo)&&ls(h,t,e,o,i)))}}const Zo=new Rt,Ri=new Ut,xo=new Ut,qc=new U,Kc=new U,Jc=new U,Qc=new U;function tp(y,t,e,o={},i={},s=0,n=1/0){t.boundingBox||t.computeBoundingBox(),Ri.set(t.boundingBox.min,t.boundingBox.max,e),Ri.needsUpdate=!0;const r=y.geometry,a=r.attributes.position,l=r.index,p=t.attributes.position,h=t.index,u=qt.getPrimitive(),c=qt.getPrimitive();let f=qc,d=Kc,m=null,x=null;i&&(m=Jc,x=Qc);let g=1/0,b=null,z=null;return Zo.copy(e).invert(),xo.matrix.copy(Zo),y.shapecast({boundsTraverseOrder:v=>Ri.distanceToBox(v),intersectsBounds:(v,C,B)=>B<g&&B<n?(C&&(xo.min.copy(v.min),xo.max.copy(v.max),xo.needsUpdate=!0),!0):!1,intersectsRange:(v,C)=>{if(t.boundsTree){const B=t.boundsTree;return B.shapecast({boundsTraverseOrder:A=>xo.distanceToBox(A),intersectsBounds:(A,M,_)=>_<g&&_<n,intersectsRange:(A,M)=>{for(let _=A,P=A+M;_<P;_++){const k=B.resolveTriangleIndex(_);Bt(c,3*k,h,p),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let T=v,F=v+C;T<F;T++){const D=y.resolveTriangleIndex(T);Bt(u,3*D,l,a),u.needsUpdate=!0;const J=u.distanceToTriangle(c,f,m);if(J<g&&(d.copy(f),x&&x.copy(m),g=J,b=T,z=_),J<s)return!0}}}})}else{const B=zi(t);for(let A=0,M=B;A<M;A++){Bt(c,3*A,h,p),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let _=v,P=v+C;_<P;_++){const k=y.resolveTriangleIndex(_);Bt(u,3*k,l,a),u.needsUpdate=!0;const T=u.distanceToTriangle(c,f,m);if(T<g&&(d.copy(f),x&&x.copy(m),g=T,b=_,z=A),T<s)return!0}}}}}),qt.releasePrimitive(u),qt.releasePrimitive(c),g===1/0?null:(o.point?o.point.copy(d):o.point=d.clone(),o.distance=g,o.faceIndex=b,i&&(i.point?i.point.copy(x):i.point=x.clone(),i.point.applyMatrix4(Zo),d.applyMatrix4(Zo),i.distance=d.sub(i.point).length(),i.faceIndex=z),o)}function dn(y,t,e){return y===null?null:(y.point.applyMatrix4(t.matrixWorld),y.distance=y.point.distanceTo(e.ray.origin),y.object=t,y)}const jo=new Ut,Yo=new mi,fn=new U,mn=new Rt,xn=new U,Li=["getX","getY","getZ"];class ui extends vc{static serialize(t,e={}){e={cloneBuffers:!0,...e};const o=t.geometry,i=t._roots,s=t._indirectBuffer,n=o.getIndex(),r={version:1,roots:null,index:null,indirectBuffer:null};return e.cloneBuffers?(r.roots=i.map(a=>a.slice()),r.index=n?n.array.slice():null,r.indirectBuffer=s?s.slice():null):(r.roots=i,r.index=n?n.array:null,r.indirectBuffer=s),r}static deserialize(t,e,o={}){o={setIndex:!0,indirect:!!t.indirectBuffer,...o};const{index:i,roots:s,indirectBuffer:n}=t;t.version||(console.warn("MeshBVH.deserialize: Serialization format has been changed and will be fixed up. It is recommended to regenerate any stored serialized data."),a(s));const r=new ui(e,{...o,[bs]:!0});if(r._roots=s,r._indirectBuffer=n||null,o.setIndex){const l=e.getIndex();if(l===null){const p=new Ot(t.index,1,!1);e.setIndex(p)}else l.array!==i&&(l.array.set(i),l.needsUpdate=!0)}return r;function a(l){for(let p=0;p<l.length;p++){const h=l[p],u=new Uint32Array(h),c=new Uint16Array(h);for(let f=0,d=h.byteLength/Pt;f<d;f++){const m=At*f,x=2*m;Mt(x,c)||(u[m+6]=u[m+6]/At-f)}}}}get primitiveStride(){return 3}get resolveTriangleIndex(){return this.resolvePrimitiveIndex}constructor(t,e={}){e.maxLeafTris&&(console.warn('MeshBVH: "maxLeafTris" option has been deprecated. Use maxLeafSize, instead.'),e={...e,maxLeafSize:e.maxLeafTris}),super(t,e)}shiftTriangleOffsets(t){return super.shiftPrimitiveOffsets(t)}writePrimitiveBounds(t,e,o){const i=this.geometry,s=this._indirectBuffer,n=i.attributes.position,r=i.index?i.index.array:null,l=(s?s[t]:t)*3;let p=l+0,h=l+1,u=l+2;r&&(p=r[p],h=r[h],u=r[u]);for(let c=0;c<3;c++){const f=n[Li[c]](p),d=n[Li[c]](h),m=n[Li[c]](u);let x=f;d<x&&(x=d),m<x&&(x=m);let g=f;d>g&&(g=d),m>g&&(g=m),e[o+c]=x,e[o+c+3]=g}return e}computePrimitiveBounds(t,e,o){const i=this.geometry,s=this._indirectBuffer,n=i.attributes.position,r=i.index?i.index.array:null,a=n.normalized;if(t<0||e+t-o.offset>o.length/6)throw new Error("MeshBVH: compute triangle bounds range is invalid.");const l=n.array,p=n.offset||0;let h=3;n.isInterleavedBufferAttribute&&(h=n.data.stride);const u=["getX","getY","getZ"],c=o.offset;for(let f=t,d=t+e;f<d;f++){const x=(s?s[f]:f)*3,g=(f-c)*6;let b=x+0,z=x+1,v=x+2;r&&(b=r[b],z=r[z],v=r[v]),a||(b=b*h+p,z=z*h+p,v=v*h+p);for(let C=0;C<3;C++){let B,A,M;a?(B=n[u[C]](b),A=n[u[C]](z),M=n[u[C]](v)):(B=l[b+C],A=l[z+C],M=l[v+C]);let _=B;A<_&&(_=A),M<_&&(_=M);let P=B;A>P&&(P=A),M>P&&(P=M);const k=(P-_)/2,T=C*2;o[g+T+0]=_+k,o[g+T+1]=k+(Math.abs(_)+k)*ti}}return o}raycastObject3D(t,e,o=[]){const{material:i}=t;if(i===void 0)return;mn.copy(t.matrixWorld).invert(),Yo.copy(e.ray).applyMatrix4(mn),xn.setFromMatrixScale(t.matrixWorld),fn.copy(Yo.direction).multiply(xn);const s=fn.length(),n=e.near/s,r=e.far/s;if(e.firstHitOnly===!0){let a=this.raycastFirst(Yo,i,n,r);a=dn(a,t,e),a&&o.push(a)}else{const a=this.raycast(Yo,i,n,r);for(let l=0,p=a.length;l<p;l++){const h=dn(a[l],t,e);h&&o.push(h)}}return o}refit(t=null){return(this.indirect?Gc:Tc)(this,t)}raycast(t,e=_s,o=0,i=1/0){const s=this._roots,n=[],r=this.indirect?$c:Rc;for(let a=0,l=s.length;a<l;a++)r(this,a,e,t,n,o,i);return n}raycastFirst(t,e=_s,o=0,i=1/0){const s=this._roots;let n=null;const r=this.indirect?Hc:Oc;for(let a=0,l=s.length;a<l;a++){const p=r(this,a,e,t,o,i);p!=null&&(n==null||p.distance<n.distance)&&(n=p)}return n}intersectsGeometry(t,e){let o=!1;const i=this._roots,s=this.indirect?Wc:Nc;for(let n=0,r=i.length;n<r&&(o=s(this,n,t,e),!o);n++);return o}shapecast(t){const e=qt.getPrimitive(),o=super.shapecast({...t,intersectsPrimitive:t.intersectsTriangle,scratchPrimitive:e,iterate:this.indirect?Ic:Sc});return qt.releasePrimitive(e),o}bvhcast(t,e,o){let{intersectsRanges:i,intersectsTriangles:s}=o;const n=qt.getPrimitive(),r=this.geometry.index,a=this.geometry.attributes.position,l=this.indirect?f=>{const d=this.resolveTriangleIndex(f);Bt(n,d*3,r,a)}:f=>{Bt(n,f*3,r,a)},p=qt.getPrimitive(),h=t.geometry.index,u=t.geometry.attributes.position,c=t.indirect?f=>{const d=t.resolveTriangleIndex(f);Bt(p,d*3,h,u)}:f=>{Bt(p,f*3,h,u)};if(s){if(!(t instanceof ui))throw new Error('MeshBVH: "intersectsTriangles" callback can only be used with another MeshBVH.');const f=(d,m,x,g,b,z,v,C)=>{for(let B=x,A=x+g;B<A;B++){c(B),p.a.applyMatrix4(e),p.b.applyMatrix4(e),p.c.applyMatrix4(e),p.needsUpdate=!0;for(let M=d,_=d+m;M<_;M++)if(l(M),n.needsUpdate=!0,s(n,p,M,B,b,z,v,C))return!0}return!1};if(i){const d=i;i=function(m,x,g,b,z,v,C,B){return d(m,x,g,b,z,v,C,B)?!0:f(m,x,g,b,z,v,C,B)}}else i=f}return super.bvhcast(t,e,{intersectsRanges:i})}intersectsBox(t,e){return jo.set(t.min,t.max,e),jo.needsUpdate=!0,this.shapecast({intersectsBounds:o=>jo.intersectsBox(o),intersectsTriangle:o=>jo.intersectsTriangle(o)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,o={},i={},s=0,n=1/0){return(this.indirect?tp:Yc)(this,t,e,o,i,s,n)}closestPointToPoint(t,e={},o=0,i=1/0){return Cc(this,t,e,o,i)}}const lr=1e-6,ep=lr*.5,cr=Math.pow(10,-Math.log10(lr)),op=ep*cr;function ce(y){return~~(y*cr+op)}function ip(y){return`${ce(y.x)},${ce(y.y)}`}function gn(y){return`${ce(y.x)},${ce(y.y)},${ce(y.z)}`}function sp(y){return`${ce(y.x)},${ce(y.y)},${ce(y.z)},${ce(y.w)}`}function np(y,t,e){e.direction.subVectors(t,y).normalize();const o=y.dot(e.direction);return e.origin.copy(y).addScaledVector(e.direction,-o),e}function pr(){return typeof SharedArrayBuffer<"u"}function rp(y){if(y.buffer instanceof SharedArrayBuffer)return y;const t=y.constructor,e=y.buffer,o=new SharedArrayBuffer(e.byteLength),i=new Uint8Array(e);return new Uint8Array(o).set(i,0),new t(o)}function ap(y,t=ArrayBuffer){return y>65535?new Uint32Array(new t(4*y)):new Uint16Array(new t(2*y))}function lp(y,t){if(!y.index){const e=y.attributes.position.count,o=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=ap(e,o);y.setIndex(new Ot(i,1));for(let s=0;s<e;s++)i[s]=s}}function cp(y){return y.index?y.index.count:y.attributes.position.count}function ks(y){return cp(y)/3}const pp=1e-8,hp=new U;function yp(y){return~~(y/3)}function up(y){return y%3}function bn(y,t){return y.start-t.start}function zn(y,t){return hp.subVectors(t,y.origin).dot(y.direction)}function dp(y,t,e,o=pp){y.sort(bn),t.sort(bn);for(let r=0;r<y.length;r++){const a=y[r];for(let l=0;l<t.length;l++){const p=t[l];if(!(p.start>a.end)){if(a.end<p.start||p.end<a.start)continue;if(a.start<=p.start&&a.end>=p.end)s(p.end,a.end)||y.splice(r+1,0,{start:p.end,end:a.end,index:a.index}),a.end=p.start,p.start=0,p.end=0;else if(a.start>=p.start&&a.end<=p.end)s(a.end,p.end)||t.splice(l+1,0,{start:a.end,end:p.end,index:p.index}),p.end=a.start,a.start=0,a.end=0;else if(a.start<=p.start&&a.end<=p.end){const h=a.end;a.end=p.start,p.start=h}else if(a.start>=p.start&&a.end>=p.end){const h=p.end;p.end=a.start,a.start=h}else throw new Error}if(e.has(a.index)||e.set(a.index,[]),e.has(p.index)||e.set(p.index,[]),e.get(a.index).push(p.index),e.get(p.index).push(a.index),n(p)&&(t.splice(l,1),l--),n(a)){y.splice(r,1),r--;break}}}i(y),i(t);function i(r){for(let a=0;a<r.length;a++)n(r[a])&&(r.splice(a,1),a--)}function s(r,a){return Math.abs(a-r)<o}function n(r){return Math.abs(r.end-r.start)<o}}const vn=1e-5,Fn=1e-4;class fp{constructor(){this._rays=[]}addRay(t){this._rays.push(t)}findClosestRay(t){const e=this._rays,o=t.clone();o.direction.multiplyScalar(-1);let i=1/0,s=null;for(let a=0,l=e.length;a<l;a++){const p=e[a];if(n(p,t)&&n(p,o))continue;const h=r(p,t),u=r(p,o),c=Math.min(h,u);c<i&&(i=c,s=p)}return s;function n(a,l){const p=a.origin.distanceTo(l.origin)>vn;return a.direction.angleTo(l.direction)>Fn||p}function r(a,l){const p=a.origin.distanceTo(l.origin),h=a.direction.angleTo(l.direction);return p/vn+h/Fn}}}const Oi=new U,Ni=new U,Go=new mi;function mp(y,t,e){const o=y.attributes,i=y.index,s=o.position,n=new Map,r=new Map,a=Array.from(t),l=new fp;for(let p=0,h=a.length;p<h;p++){const u=a[p],c=yp(u),f=up(u);let d=3*c+f,m=3*c+(f+1)%3;i&&(d=i.getX(d),m=i.getX(m)),Oi.fromBufferAttribute(s,d),Ni.fromBufferAttribute(s,m),np(Oi,Ni,Go);let x,g=l.findClosestRay(Go);g===null&&(g=Go.clone(),l.addRay(g)),r.has(g)||r.set(g,{forward:[],reverse:[],ray:g}),x=r.get(g);let b=zn(g,Oi),z=zn(g,Ni);b>z&&([b,z]=[z,b]),Go.direction.dot(g.direction)<0?x.reverse.push({start:b,end:z,index:u}):x.forward.push({start:b,end:z,index:u})}return r.forEach(({forward:p,reverse:h},u)=>{dp(p,h,n,e),p.length===0&&h.length===0&&r.delete(u)}),{disjointConnectivityMap:n,fragmentMap:r}}const xp=new nt,Ui=new U,gp=new Ue,Xi=["","",""];class bp{constructor(t=null){this.data=null,this.disjointConnections=null,this.unmatchedDisjointEdges=null,this.unmatchedEdges=-1,this.matchedEdges=-1,this.useDrawRange=!0,this.useAllAttributes=!1,this.matchDisjointEdges=!1,this.degenerateEpsilon=1e-8,t&&this.updateFrom(t)}getSiblingTriangleIndex(t,e){const o=this.data[t*3+e];return o===-1?-1:~~(o/3)}getSiblingEdgeIndex(t,e){const o=this.data[t*3+e];return o===-1?-1:o%3}getDisjointSiblingTriangleIndices(t,e){const o=t*3+e,i=this.disjointConnections.get(o);return i?i.map(s=>~~(s/3)):[]}getDisjointSiblingEdgeIndices(t,e){const o=t*3+e,i=this.disjointConnections.get(o);return i?i.map(s=>s%3):[]}isFullyConnected(){return this.unmatchedEdges===0}updateFrom(t){const{useAllAttributes:e,useDrawRange:o,matchDisjointEdges:i,degenerateEpsilon:s}=this,n=e?b:g,r=new Map,{attributes:a}=t,l=e?Object.keys(a):null,p=t.index,h=a.position;let u=ks(t);const c=u;let f=0;o&&(f=t.drawRange.start,t.drawRange.count!==1/0&&(u=~~(t.drawRange.count/3)));let d=this.data;(!d||d.length<3*c)&&(d=new Int32Array(3*c)),d.fill(-1);let m=0,x=new Set;for(let z=f,v=u*3+f;z<v;z+=3){const C=z;for(let B=0;B<3;B++){let A=C+B;p&&(A=p.getX(A)),Xi[B]=n(A)}for(let B=0;B<3;B++){const A=(B+1)%3,M=Xi[B],_=Xi[A],P=`${_}_${M}`;if(r.has(P)){const k=C+B,T=r.get(P);d[k]=T,d[T]=k,r.delete(P),m+=2,x.delete(T)}else{const k=`${M}_${_}`,T=C+B;r.set(k,T),x.add(T)}}}if(i){const{fragmentMap:z,disjointConnectivityMap:v}=mp(t,x,s);x.clear(),z.forEach(({forward:C,reverse:B})=>{C.forEach(({index:A})=>x.add(A)),B.forEach(({index:A})=>x.add(A))}),this.unmatchedDisjointEdges=z,this.disjointConnections=v,m=u*3-x.size}this.matchedEdges=m,this.unmatchedEdges=x.size,this.data=d;function g(z){return Ui.fromBufferAttribute(h,z),gn(Ui)}function b(z){let v="";for(let C=0,B=l.length;C<B;C++){const A=a[l[C]];let M;switch(A.itemSize){case 1:M=ce(A.getX(z));break;case 2:M=ip(xp.fromBufferAttribute(A,z));break;case 3:M=gn(Ui.fromBufferAttribute(A,z));break;case 4:M=sp(gp.fromBufferAttribute(A,z));break}v!==""&&(v+="|"),v+=M}return v}}}class cs extends Dt{constructor(...t){super(...t),this.isBrush=!0,this._previousMatrix=new Rt,this._previousMatrix.elements.fill(0)}markUpdated(){this._previousMatrix.copy(this.matrix)}isDirty(){const{matrix:t,_previousMatrix:e}=this,o=t.elements,i=e.elements;for(let s=0;s<16;s++)if(o[s]!==i[s])return!0;return!1}prepareGeometry(){const t=this.geometry,e=t.attributes,o=pr();if(o)for(const i in e){const s=e[i];if(s.isInterleavedBufferAttribute)throw new Error("Brush: InterleavedBufferAttributes are not supported.");s.array=rp(s.array)}if(t.boundsTree||(lp(t,{useSharedArrayBuffer:o}),t.boundsTree=new ui(t,{maxLeafTris:3,indirect:!0,useSharedArrayBuffer:o})),t.halfEdges||(t.halfEdges=new bp(t)),!t.groupIndices){const i=ks(t),s=new Uint16Array(i),n=t.groups;for(let r=0,a=n.length;r<a;r++){const{start:l,count:p}=n[r];for(let h=l/3,u=(l+p)/3;h<u;h++)s[h]=r}t.groupIndices=s}}disposeCacheData(){const{geometry:t}=this;t.halfEdges=null,t.boundsTree=null,t.groupIndices=null}}const zp=1e-14,Zi=new U,wn=new U,kn=new U;function we(y,t=zp){Zi.subVectors(y.b,y.a),wn.subVectors(y.c,y.a),kn.subVectors(y.b,y.c);const e=Zi.angleTo(wn),o=Zi.angleTo(kn),i=Math.PI-e-o;return Math.abs(e)<t||Math.abs(o)<t||Math.abs(i)<t||y.a.distanceToSquared(y.b)<t||y.a.distanceToSquared(y.c)<t||y.b.distanceToSquared(y.c)<t}const ji=1e-10,go=1e-10,vp=1e-10,he=new Kt,Ft=new Kt,ye=new U,Yi=new U,Bn=new U,$o=new xi,Gi=new Jt;class Fp{constructor(){this._pool=[],this._index=0}getTriangle(){return this._index>=this._pool.length&&this._pool.push(new jt),this._pool[this._index++]}clear(){this._index=0}reset(){this._pool.length=0,this._index=0}}class wp{constructor(){this.trianglePool=new Fp,this.triangles=[],this.normal=new U,this.coplanarTriangleUsed=!1}initialize(t){this.reset();const{triangles:e,trianglePool:o,normal:i}=this;if(Array.isArray(t))for(let s=0,n=t.length;s<n;s++){const r=t[s];if(s===0)r.getNormal(i);else if(Math.abs(1-r.getNormal(ye).dot(i))>ji)throw new Error("Triangle Splitter: Cannot initialize with triangles that have different normals.");const a=o.getTriangle();a.copy(r),e.push(a)}else{t.getNormal(i);const s=o.getTriangle();s.copy(t),e.push(s)}}splitByTriangle(t){const{normal:e,triangles:o}=this;if(t.getNormal(Yi).normalize(),Math.abs(1-Math.abs(Yi.dot(e)))<vp){this.coplanarTriangleUsed=!0;for(let s=0,n=o.length;s<n;s++){const r=o[s];r.coplanarCount=0}const i=[t.a,t.b,t.c];for(let s=0;s<3;s++){const n=(s+1)%3,r=i[s],a=i[n];ye.subVectors(a,r).normalize(),Bn.crossVectors(Yi,ye),$o.setFromNormalAndCoplanarPoint(Bn,r),this.splitByPlane($o,t)}}else t.getPlane($o),this.splitByPlane($o,t)}splitByPlane(t,e){const{triangles:o,trianglePool:i}=this;Gi.copy(e),Gi.needsUpdate=!0;for(let s=0,n=o.length;s<n;s++){const r=o[s];if(!Gi.intersectsTriangle(r,he,!0))continue;const{a,b:l,c:p}=r;let h=0,u=-1,c=!1,f=[],d=[];const m=[a,l,p];for(let x=0;x<3;x++){const g=(x+1)%3;he.start.copy(m[x]),he.end.copy(m[g]);const b=t.distanceToPoint(he.start),z=t.distanceToPoint(he.end);if(Math.abs(b)<go&&Math.abs(z)<go){c=!0;break}if(b>0?f.push(x):d.push(x),Math.abs(b)<go)continue;let v=!!t.intersectLine(he,ye);!v&&Math.abs(z)<go&&(ye.copy(he.end),v=!0),v&&!(ye.distanceTo(he.start)<ji)&&(ye.distanceTo(he.end)<ji&&(u=x),h===0?Ft.start.copy(ye):Ft.end.copy(ye),h++)}if(!c&&h===2&&Ft.distance()>go)if(u!==-1){u=(u+1)%3;let x=0;x===u&&(x=(x+1)%3);let g=x+1;g===u&&(g=(g+1)%3);const b=i.getTriangle();b.a.copy(m[g]),b.b.copy(Ft.end),b.c.copy(Ft.start),we(b)||o.push(b),r.a.copy(m[x]),r.b.copy(Ft.start),r.c.copy(Ft.end),we(r)&&(o.splice(s,1),s--,n--)}else{const x=f.length>=2?d[0]:f[0];if(x===0){let C=Ft.start;Ft.start=Ft.end,Ft.end=C}const g=(x+1)%3,b=(x+2)%3,z=i.getTriangle(),v=i.getTriangle();m[g].distanceToSquared(Ft.start)<m[b].distanceToSquared(Ft.end)?(z.a.copy(m[g]),z.b.copy(Ft.start),z.c.copy(Ft.end),v.a.copy(m[g]),v.b.copy(m[b]),v.c.copy(Ft.start)):(z.a.copy(m[b]),z.b.copy(Ft.start),z.c.copy(Ft.end),v.a.copy(m[g]),v.b.copy(m[b]),v.c.copy(Ft.end)),r.a.copy(m[x]),r.b.copy(Ft.end),r.c.copy(Ft.start),we(z)||o.push(z),we(v)||o.push(v),we(r)&&(o.splice(s,1),s--,n--)}else h===3&&console.warn("TriangleClipper: Coplanar clip not handled")}}reset(){this.triangles.length=0,this.trianglePool.clear(),this.coplanarTriangleUsed=!1}}function kp(y){return y=~~y,y+4-y%4}class Cn{constructor(t,e=500){this.expansionFactor=1.5,this.type=t,this.length=0,this.array=null,this.setSize(e)}setType(t){if(this.length!==0)throw new Error("TypeBackedArray: Cannot change the type while there is used data in the buffer.");const e=this.array.buffer;this.array=new t(e),this.type=t}setSize(t){if(this.array&&t===this.array.length)return;const e=this.type,o=pr()?SharedArrayBuffer:ArrayBuffer,i=new e(new o(kp(t*e.BYTES_PER_ELEMENT)));this.array&&i.set(this.array,0),this.array=i}expand(){const{array:t,expansionFactor:e}=this;this.setSize(t.length*e)}push(...t){let{array:e,length:o}=this;o+t.length>e.length&&(this.expand(),e=this.array);for(let i=0,s=t.length;i<s;i++)e[o+i]=t[i];this.length+=t.length}clear(){this.length=0}}class Bp{constructor(){this.groupAttributes=[{}],this.groupCount=0}getType(t){return this.groupAttributes[0][t].type}getItemSize(t){return this.groupAttributes[0][t].itemSize}getNormalized(t){return this.groupAttributes[0][t].normalized}getCount(t){if(this.groupCount<=t)return 0;const e=this.getGroupAttrArray("position",t);return e.length/e.itemSize}getTotalLength(t){const{groupCount:e,groupAttributes:o}=this;let i=0;for(let s=0;s<e;s++){const n=o[s];i+=n[t].length}return i}getGroupAttrSet(t=0){const{groupAttributes:e}=this;if(e[t])return this.groupCount=Math.max(this.groupCount,t+1),e[t];const o=e[0];for(this.groupCount=Math.max(this.groupCount,t+1);t>=e.length;){const i={};e.push(i);for(const s in o){const n=o[s],r=new Cn(n.type);r.itemSize=n.itemSize,r.normalized=n.normalized,i[s]=r}}return e[t]}getGroupAttrArray(t,e=0){const{groupAttributes:o}=this;if(!o[0][t])throw new Error(`TypedAttributeData: Attribute with "${t}" has not been initialized`);return this.getGroupAttrSet(e)[t]}initializeArray(t,e,o,i){const{groupAttributes:s}=this,r=s[0][t];if(r){if(r.type!==e)for(let a=0,l=s.length;a<l;a++){const p=s[a][t];p.setType(e),p.itemSize=o,p.normalized=i}}else for(let a=0,l=s.length;a<l;a++){const p=new Cn(e);p.itemSize=o,p.normalized=i,s[a][t]=p}}clear(){this.groupCount=0;const{groupAttributes:t}=this;t.forEach(e=>{for(const o in e)e[o].clear()})}delete(t){this.groupAttributes.forEach(e=>{delete e[t]})}reset(){this.groupAttributes=[],this.groupCount=0}}class An{constructor(){this.intersectionSet={},this.ids=[]}add(t,e){const{intersectionSet:o,ids:i}=this;o[t]||(o[t]=[],i.push(t)),o[t].push(e)}}const hr=0,Cp=1,Ap=2,Mp=3,Ep=4,yr=5,ur=6,Wt=new mi,Mn=new Rt,Lt=new jt,ue=new U,En=new Ue,_n=new Ue,Sn=new Ue,$i=new Ue,Vo=new Ue,Ho=new Ue,Tn=new Kt,Vi=new U,Hi=1e-8,_p=1e-15,Re=-1,Le=1,oi=-2,ii=2,vo=0,Te=1,Bs=2,Sp=1e-14;let si=null;function Dn(y){si=y}function dr(y,t){y.getMidpoint(Wt.origin),y.getNormal(Wt.direction);const e=t.raycastFirst(Wt,Ae);return!!(e&&Wt.direction.dot(e.face.normal)>0)?Re:Le}function Tp(y,t){function e(){return Math.random()-.5}y.getNormal(Vi),Wt.direction.copy(Vi),y.getMidpoint(Wt.origin);const o=3;let i=0,s=1/0;for(let n=0;n<o;n++){Wt.direction.x+=e()*Hi,Wt.direction.y+=e()*Hi,Wt.direction.z+=e()*Hi,Wt.direction.multiplyScalar(-1);const r=t.raycastFirst(Wt,Ae);if(!!(r&&Wt.direction.dot(r.face.normal)>0)&&i++,r!==null&&(s=Math.min(s,r.distance)),s<=_p)return r.face.normal.dot(Vi)>0?ii:oi;if(i/o>.5||(n-i+1)/o>.5)break}return i/o>.5?Re:Le}function Dp(y,t){const e=new An,o=new An;return Mn.copy(y.matrixWorld).invert().multiply(t.matrixWorld),y.geometry.boundsTree.bvhcast(t.geometry.boundsTree,Mn,{intersectsTriangles(i,s,n,r){if(!we(i)&&!we(s)){let a=i.intersectsTriangle(s,Tn,!0);if(!a){const l=i.plane,p=s.plane,h=l.normal,u=p.normal;h.dot(u)===1&&Math.abs(l.constant-p.constant)<Sp&&(a=!0)}if(a){let l=y.geometry.boundsTree.resolveTriangleIndex(n),p=t.geometry.boundsTree.resolveTriangleIndex(r);e.add(l,p),o.add(p,l),si&&(si.addEdge(Tn),si.addIntersectingTriangles(n,i,r,s))}}return!1}}),{aIntersections:e,bIntersections:o}}function Pp(y,t,e,o,i,s,n=!1){const r=e.attributes,a=e.index,l=y*3,p=a.getX(l+0),h=a.getX(l+1),u=a.getX(l+2);for(const c in s){const f=r[c],d=s[c];if(!(c in r))throw new Error(`CSG Operations: Attribute ${c} not available on geometry.`);const m=f.itemSize;c==="position"?(Lt.a.fromBufferAttribute(f,p).applyMatrix4(o),Lt.b.fromBufferAttribute(f,h).applyMatrix4(o),Lt.c.fromBufferAttribute(f,u).applyMatrix4(o),Wi(Lt.a,Lt.b,Lt.c,t,3,d,n)):c==="normal"?(Lt.a.fromBufferAttribute(f,p).applyNormalMatrix(i),Lt.b.fromBufferAttribute(f,h).applyNormalMatrix(i),Lt.c.fromBufferAttribute(f,u).applyNormalMatrix(i),n&&(Lt.a.multiplyScalar(-1),Lt.b.multiplyScalar(-1),Lt.c.multiplyScalar(-1)),Wi(Lt.a,Lt.b,Lt.c,t,3,d,n,!0)):(En.fromBufferAttribute(f,p),_n.fromBufferAttribute(f,h),Sn.fromBufferAttribute(f,u),Wi(En,_n,Sn,t,m,d,n))}}function Ip(y,t,e,o,i,s,n,r=!1){qi(y,o,i,s,n,r),qi(r?e:t,o,i,s,n,r),qi(r?t:e,o,i,s,n,r)}function fr(y,t,e=!1){switch(y){case hr:if(t===Le||t===ii&&!e)return Te;break;case Cp:if(e){if(t===Re)return vo}else if(t===Le||t===oi)return Te;break;case Ap:if(e){if(t===Le||t===oi)return Te}else if(t===Re)return vo;break;case Ep:if(t===Re)return vo;if(t===Le)return Te;break;case Mp:if(t===Re||t===ii&&!e)return Te;break;case yr:if(!e&&(t===Le||t===oi))return Te;break;case ur:if(!e&&(t===Re||t===ii))return Te;break;default:throw new Error(`Unrecognized CSG operation enum "${y}".`)}return Bs}function Wi(y,t,e,o,i,s,n=!1,r=!1){const a=l=>{s.push(l.x),i>1&&s.push(l.y),i>2&&s.push(l.z),i>3&&s.push(l.w)};$i.set(0,0,0,0).addScaledVector(y,o.a.x).addScaledVector(t,o.a.y).addScaledVector(e,o.a.z),Vo.set(0,0,0,0).addScaledVector(y,o.b.x).addScaledVector(t,o.b.y).addScaledVector(e,o.b.z),Ho.set(0,0,0,0).addScaledVector(y,o.c.x).addScaledVector(t,o.c.y).addScaledVector(e,o.c.z),r&&($i.normalize(),Vo.normalize(),Ho.normalize()),a($i),n?(a(Ho),a(Vo)):(a(Vo),a(Ho))}function qi(y,t,e,o,i,s=!1){for(const n in i){const r=t[n],a=i[n];if(!(n in t))throw new Error(`CSG Operations: Attribute ${n} no available on geometry.`);const l=r.itemSize;n==="position"?(ue.fromBufferAttribute(r,y).applyMatrix4(e),a.push(ue.x,ue.y,ue.z)):n==="normal"?(ue.fromBufferAttribute(r,y).applyNormalMatrix(o),s&&ue.multiplyScalar(-1),a.push(ue.x,ue.y,ue.z)):(a.push(r.getX(y)),l>1&&a.push(r.getY(y)),l>2&&a.push(r.getZ(y)),l>3&&a.push(r.getW(y)))}}class Rp{constructor(t){this.triangle=new jt().copy(t),this.intersects={}}addTriangle(t,e){this.intersects[t]=new jt().copy(e)}getIntersectArray(){const t=[],{intersects:e}=this;for(const o in e)t.push(e[o]);return t}}class Pn{constructor(){this.data={}}addTriangleIntersection(t,e,o,i){const{data:s}=this;s[t]||(s[t]=new Rp(e)),s[t].addTriangle(o,i)}getTrianglesAsArray(t=null){const{data:e}=this,o=[];if(t!==null)t in e&&o.push(e[t].triangle);else for(const i in e)o.push(e[i].triangle);return o}getTriangleIndices(){return Object.keys(this.data).map(t=>parseInt(t))}getIntersectionIndices(t){const{data:e}=this;return e[t]?Object.keys(e[t].intersects).map(o=>parseInt(o)):[]}getIntersectionsAsArray(t=null,e=null){const{data:o}=this,i=new Set,s=[],n=r=>{if(o[r])if(e!==null)o[r].intersects[e]&&s.push(o[r].intersects[e]);else{const a=o[r].intersects;for(const l in a)i.has(l)||(i.add(l),s.push(a[l]))}};if(t!==null)n(t);else for(const r in o)n(r);return s}reset(){this.data={}}}class Lp{constructor(){this.enabled=!1,this.triangleIntersectsA=new Pn,this.triangleIntersectsB=new Pn,this.intersectionEdges=[]}addIntersectingTriangles(t,e,o,i){const{triangleIntersectsA:s,triangleIntersectsB:n}=this;s.addTriangleIntersection(t,e,o,i),n.addTriangleIntersection(o,i,t,e)}addEdge(t){this.intersectionEdges.push(t.clone())}reset(){this.triangleIntersectsA.reset(),this.triangleIntersectsB.reset(),this.intersectionEdges=[]}init(){this.enabled&&(this.reset(),Dn(this))}complete(){this.enabled&&Dn(null)}}const Be=new Rt,di=new Vn,De=new jt,Wo=new jt,be=new jt,qo=new jt,ie=[],Oe=[];function Op(y){for(const t of y)return t}function Np(y,t,e,o,i,s={}){const{useGroups:n=!0}=s,{aIntersections:r,bIntersections:a}=Dp(y,t),l=[];let p=null,h;return h=n?0:-1,In(y,t,r,e,!1,o,i,h),Rn(y,t,r,e,!1,i,h),e.findIndex(c=>c!==ur&&c!==yr)!==-1&&(h=n?y.geometry.groups.length||1:-1,In(t,y,a,e,!0,o,i,h),Rn(t,y,a,e,!0,i,h)),ie.length=0,Oe.length=0,{groups:l,materials:p}}function In(y,t,e,o,i,s,n,r=0){const a=y.matrixWorld.determinant()<0;Be.copy(t.matrixWorld).invert().multiply(y.matrixWorld),di.getNormalMatrix(y.matrixWorld).multiplyScalar(a?-1:1);const l=y.geometry.groupIndices,p=y.geometry.index,h=y.geometry.attributes.position,u=t.geometry.boundsTree,c=t.geometry.index,f=t.geometry.attributes.position,d=e.ids,m=e.intersectionSet;for(let x=0,g=d.length;x<g;x++){const b=d[x],z=r===-1?0:l[b]+r,v=3*b,C=p.getX(v+0),B=p.getX(v+1),A=p.getX(v+2);De.a.fromBufferAttribute(h,C).applyMatrix4(Be),De.b.fromBufferAttribute(h,B).applyMatrix4(Be),De.c.fromBufferAttribute(h,A).applyMatrix4(Be),s.reset(),s.initialize(De);const M=m[b];for(let P=0,k=M.length;P<k;P++){const T=3*M[P],F=c.getX(T+0),D=c.getX(T+1),J=c.getX(T+2);Wo.a.fromBufferAttribute(f,F),Wo.b.fromBufferAttribute(f,D),Wo.c.fromBufferAttribute(f,J),s.splitByTriangle(Wo)}const _=s.triangles;for(let P=0,k=_.length;P<k;P++){const T=_[P],F=s.coplanarTriangleUsed?Tp(T,u):dr(T,u);ie.length=0,Oe.length=0;for(let D=0,J=o.length;D<J;D++){const Z=fr(o[D],F,i);Z!==Bs&&(Oe.push(Z),ie.push(n[D].getGroupAttrSet(z)))}if(ie.length!==0){De.getBarycoord(T.a,qo.a),De.getBarycoord(T.b,qo.b),De.getBarycoord(T.c,qo.c);for(let D=0,J=ie.length;D<J;D++){const Z=ie[D],$=Oe[D]===vo;Pp(b,qo,y.geometry,y.matrixWorld,di,Z,a!==$)}}}}return d.length}function Rn(y,t,e,o,i,s,n=0){const r=y.matrixWorld.determinant()<0;Be.copy(t.matrixWorld).invert().multiply(y.matrixWorld),di.getNormalMatrix(y.matrixWorld).multiplyScalar(r?-1:1);const a=t.geometry.boundsTree,l=y.geometry.groupIndices,p=y.geometry.index,h=y.geometry.attributes,u=h.position,c=[],f=y.geometry.halfEdges,d=new Set,m=ks(y.geometry);for(let x=0,g=m;x<g;x++)x in e.intersectionSet||d.add(x);for(;d.size>0;){const x=Op(d);d.delete(x),c.push(x);const g=3*x,b=p.getX(g+0),z=p.getX(g+1),v=p.getX(g+2);be.a.fromBufferAttribute(u,b).applyMatrix4(Be),be.b.fromBufferAttribute(u,z).applyMatrix4(Be),be.c.fromBufferAttribute(u,v).applyMatrix4(Be);const C=dr(be,a);Oe.length=0,ie.length=0;for(let B=0,A=o.length;B<A;B++){const M=fr(o[B],C,i);M!==Bs&&(Oe.push(M),ie.push(s[B]))}for(;c.length>0;){const B=c.pop();for(let A=0;A<3;A++){const M=f.getSiblingTriangleIndex(B,A);M!==-1&&d.has(M)&&(c.push(M),d.delete(M))}if(ie.length!==0){const A=3*B,M=p.getX(A+0),_=p.getX(A+1),P=p.getX(A+2),k=n===-1?0:l[B]+n;if(be.a.fromBufferAttribute(u,M),be.b.fromBufferAttribute(u,_),be.c.fromBufferAttribute(u,P),!we(be))for(let T=0,F=ie.length;T<F;T++){const D=Oe[T],J=ie[T].getGroupAttrSet(k),Z=D===vo;Ip(M,_,P,h,y.matrixWorld,di,J,Z!==r)}}}}}function Up(y){for(let t=0;t<y.length-1;t++){const e=y[t],o=y[t+1];if(e.materialIndex===o.materialIndex){const i=e.start,s=o.start+o.count;o.start=i,o.count=s-i,y.splice(t,1),t--}}}function Xp(y,t,e,o){e.clear();const i=y.attributes;for(let s=0,n=o.length;s<n;s++){const r=o[s],a=i[r];e.initializeArray(r,a.array.constructor,a.itemSize,a.normalized)}for(const s in e.attributes)o.includes(s)||e.delete(s);for(const s in t.attributes)o.includes(s)||(t.deleteAttribute(s),t.dispose())}function Zp(y,t,e){let o=!1,i=-1;const s=y.attributes,n=t.groupAttributes[0];for(const a in n){const l=t.getTotalLength(a),p=t.getType(a),h=t.getItemSize(a),u=t.getNormalized(a);let c=s[a];(!c||c.array.length<l)&&(c=new Ot(new p(l),h,u),y.setAttribute(a,c),o=!0);let f=0;for(let d=0,m=Math.min(e.length,t.groupCount);d<m;d++){const x=e[d].index,{array:g,type:b,length:z}=t.groupAttributes[x][a],v=new b(g.buffer,0,z);c.array.set(v,f),f+=v.length}c.needsUpdate=!0,i=l/c.itemSize}if(y.index){const a=y.index.array;if(a.length<i)y.index=null,o=!0;else for(let l=0,p=a.length;l<p;l++)a[l]=l}let r=0;y.clearGroups();for(let a=0,l=Math.min(e.length,t.groupCount);a<l;a++){const{index:p,materialIndex:h}=e[a],u=t.getCount(p);u!==0&&(y.addGroup(r,u,h),r+=u)}y.setDrawRange(0,i),y.boundsTree=null,o&&y.dispose()}function Ln(y,t){let e=t;return Array.isArray(t)||(e=[],y.forEach(o=>{e[o.materialIndex]=t})),e}class jp{constructor(){this.triangleSplitter=new wp,this.attributeData=[],this.attributes=["position","uv","normal"],this.useGroups=!0,this.consolidateGroups=!0,this.debug=new Lp}getGroupRanges(t){return!this.useGroups||t.groups.length===0?[{start:0,count:1/0,materialIndex:0}]:t.groups.map(e=>({...e}))}evaluate(t,e,o,i=new cs){let s=!0;if(Array.isArray(o)||(o=[o]),Array.isArray(i)||(i=[i],s=!1),i.length!==o.length)throw new Error("Evaluator: operations and target array passed as different sizes.");t.prepareGeometry(),e.prepareGeometry();const{triangleSplitter:n,attributeData:r,attributes:a,useGroups:l,consolidateGroups:p,debug:h}=this;for(;r.length<i.length;)r.push(new Bp);i.forEach((x,g)=>{Xp(t.geometry,x.geometry,r[g],a)}),h.init(),Np(t,e,o,n,r,{useGroups:l}),h.complete();const u=this.getGroupRanges(t.geometry),c=Ln(u,t.material),f=this.getGroupRanges(e.geometry),d=Ln(f,e.material);f.forEach(x=>x.materialIndex+=c.length);let m=[...u,...f].map((x,g)=>({...x,index:g}));if(l){const x=[...c,...d];p&&(m=m.map(b=>{const z=x[b.materialIndex];return b.materialIndex=x.indexOf(z),b}).sort((b,z)=>b.materialIndex-z.materialIndex));const g=[];for(let b=0,z=x.length;b<z;b++){let v=!1;for(let C=0,B=m.length;C<B;C++){const A=m[C];A.materialIndex===b&&(v=!0,A.materialIndex=g.length)}v&&g.push(x[b])}i.forEach(b=>{b.material=g})}else m=[{start:0,count:1/0,index:0,materialIndex:0}],i.forEach(x=>{x.material=c[0]});return i.forEach((x,g)=>{const b=x.geometry;Zp(b,r[g],m),p&&Up(b.groups)}),s?i:i[0]}evaluateHierarchy(t,e=new cs){t.updateMatrixWorld(!0);const o=(s,n)=>{const r=s.children;for(let a=0,l=r.length;a<l;a++){const p=r[a];p.isOperationGroup?o(p,n):n(p)}},i=s=>{const n=s.children;let r=!1;for(let l=0,p=n.length;l<p;l++){const h=n[l];r=i(h)||r}const a=s.isDirty();if(a&&s.markUpdated(),r&&!s.isOperationGroup){let l;return o(s,p=>{l?l=this.evaluate(l,p,p.operation):l=this.evaluate(s,p,p.operation)}),s._cachedGeometry=l.geometry,s._cachedMaterials=l.material,!0}else return r||a};return i(t),e.geometry=t._cachedGeometry,e.material=t._cachedMaterials,e}reset(){this.triangleSplitter.reset()}}let Yp=0;class On{constructor(t={}){this.id=t.id||`merged_${++Yp}`,this.type="merged",this.color=t.color||"#888888",this.layerId=t.layerId||"default",this.sourceBlocks=t.sourceBlocks||[],this.mesh=null,this.edges=null,this.boundingBox=new se,t.geometry&&this.createFromGeometry(t.geometry,t.material)}createFromGeometry(t,e){this.mesh=new Dt(t,e||new kt({color:this.color,roughness:.7,metalness:.1,vertexColors:t.hasAttribute("color")})),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.mesh.userData.mergedId=this.id,this.mesh.userData.merged=this,this.createEdges(t),t.computeBoundingBox(),this.boundingBox.copy(t.boundingBox)}createEdges(t){const e=new Fo(t,30),o=new to({color:0,transparent:!0,opacity:.3});this.edges=new eo(e,o),this.mesh.add(this.edges)}setEdgesVisible(t){this.edges&&(this.edges.visible=t)}setEdgesOpacity(t){this.edges&&(this.edges.material.opacity=t)}setSelected(t){this.mesh.material.emissive&&this.mesh.material.emissive.set(t?3355443:0)}get gridPosition(){const t=new U;return this.boundingBox.getCenter(t),{x:Math.floor(t.x),y:Math.floor(t.y),z:Math.floor(t.z)}}toJSON(){return{id:this.id,type:"merged",color:this.color,layerId:this.layerId,sourceBlocks:this.sourceBlocks}}dispose(){this.edges&&(this.edges.geometry.dispose(),this.edges.material.dispose()),this.mesh&&(this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach(t=>t.dispose()):this.mesh.material.dispose())}}class Gp{constructor(t){this.blockManager=t,this.evaluator=new jp}findIslands(t){if(t.length===0)return[];const e=new Map,o=new Set(t.map(r=>r.id));for(const r of t){const a=r.gridPosition,l=`${a.x},${a.y},${a.z}`;e.set(l,r)}const i=new Set,s=[],n=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]];for(const r of t){if(i.has(r.id))continue;const a=[],l=[r];for(;l.length>0;){const p=l.shift();if(i.has(p.id))continue;i.add(p.id),a.push(p);const h=p.gridPosition;for(const[u,c,f]of n){const d=`${h.x+u},${h.y+c},${h.z+f}`,m=e.get(d);m&&o.has(m.id)&&!i.has(m.id)&&l.push(m)}}a.length>0&&s.push(a)}return s}createBrushFromBlock(t){const e=t.mesh;e.updateMatrixWorld();const o=e.geometry.clone();if(o.applyMatrix4(e.matrixWorld),!o.index){const s=o.getAttribute("position"),n=[];for(let r=0;r<s.count;r++)n.push(r);o.setIndex(n)}const i=new cs(o);return i.updateMatrixWorld(),i}mergeIsland(t){if(t.length===0)return null;const e=t[0].color;if(t.length===1){const r=t[0];r.mesh.updateMatrixWorld();const a=r.mesh.geometry.clone();a.applyMatrix4(r.mesh.matrixWorld),this.addVertexColors(a,r.color);const l=new kt({color:16777215,vertexColors:!0,roughness:.7,metalness:.1});return new On({geometry:a,material:l,color:e,layerId:r.layerId,sourceBlocks:[r.toJSON()]})}const o=new Map;for(const r of t){const a=r.color.toLowerCase();o.has(a)||o.set(a,[]),o.get(a).push(r)}const i=[];for(const[r,a]of o)try{const l=this.csgMergeBlocks(a);l&&(this.addVertexColors(l,r),i.push({geometry:l,color:r}))}catch(l){console.error(`CSG merge failed for color ${r}:`,l);const p=this.simpleMergeBlocks(a);this.addVertexColors(p,r),i.push({geometry:p,color:r})}if(i.length===0)return null;const s=this.combineGeometriesWithColors(i),n=new kt({color:16777215,vertexColors:!0,roughness:.7,metalness:.1});return new On({geometry:s,material:n,color:e,layerId:t[0].layerId,sourceBlocks:t.map(r=>r.toJSON())})}csgMergeBlocks(t){if(t.length===0)return null;if(t.length===1){const i=t[0];i.mesh.updateMatrixWorld();const s=i.mesh.geometry.clone();return s.applyMatrix4(i.mesh.matrixWorld),s}let e=this.createBrushFromBlock(t[0]);for(let i=1;i<t.length;i++){const s=this.createBrushFromBlock(t[i]),n=this.evaluator.evaluate(e,s,hr);e.geometry&&e.geometry.dispose(),s.geometry&&s.geometry.dispose(),e=n}const o=e.geometry;return o.getAttribute("normal")||o.computeVertexNormals(),o}simpleMergeBlocks(t){const e=[];for(const i of t){const s=i.mesh;s.updateMatrixWorld();const n=s.geometry.clone();n.applyMatrix4(s.matrixWorld),e.push(n)}const o=this.mergeGeometries(e);return e.forEach(i=>i.dispose()),o}addVertexColors(t,e){const o=new ot(e),i=t.getAttribute("position"),s=new Float32Array(i.count*3);for(let n=0;n<i.count;n++)s[n*3]=o.r,s[n*3+1]=o.g,s[n*3+2]=o.b;t.setAttribute("color",new Ot(s,3))}combineGeometriesWithColors(t){const e=[],o=[],i=[],s=[];let n=0;for(const{geometry:a}of t){const l=a.getAttribute("position"),p=a.getAttribute("normal"),h=a.getAttribute("color"),u=a.getIndex();for(let c=0;c<l.count;c++)e.push(l.getX(c),l.getY(c),l.getZ(c)),p&&o.push(p.getX(c),p.getY(c),p.getZ(c)),h&&i.push(h.getX(c),h.getY(c),h.getZ(c));if(u)for(let c=0;c<u.count;c++)s.push(u.getX(c)+n);else for(let c=0;c<l.count;c++)s.push(c+n);n+=l.count,a.dispose()}const r=new le;return r.setAttribute("position",new _t(e,3)),o.length>0?r.setAttribute("normal",new _t(o,3)):r.computeVertexNormals(),i.length>0&&r.setAttribute("color",new _t(i,3)),r.setIndex(s),r}mergeGeometries(t){const e=[],o=[],i=[];let s=0;for(const r of t){const a=r.getAttribute("position"),l=r.getAttribute("normal"),p=r.getIndex();for(let h=0;h<a.count;h++)e.push(a.getX(h),a.getY(h),a.getZ(h)),l&&o.push(l.getX(h),l.getY(h),l.getZ(h));if(p)for(let h=0;h<p.count;h++)i.push(p.getX(h)+s);else for(let h=0;h<a.count;h++)i.push(h+s);s+=a.count}const n=new le;return n.setAttribute("position",new _t(e,3)),o.length>0?n.setAttribute("normal",new _t(o,3)):n.computeVertexNormals(),n.setIndex(i),n}flatten(t=null){const e=t||this.blockManager.getAllBlocks();if(e.length===0)return{mergedMeshes:[],removedBlockIds:[]};const o=this.findIslands(e),i=[],s=[];for(const n of o){const r=this.mergeIsland(n);r&&(i.push(r),s.push(...n.map(a=>a.id)))}return{mergedMeshes:i,removedBlockIds:s}}flattenAndApply(t=null){const{mergedMeshes:e,removedBlockIds:o}=this.flatten(t);for(const i of o)this.blockManager.removeBlock(i);for(const i of e)this.blockManager.addMergedMesh(i);return{mergedCount:e.length,blocksRemoved:o.length,mergedMeshes:e}}}const fi={pipes:{label:"Pipes",straight:{X:"pipeX",Y:"pipeY",Z:"pipeZ"},elbows:{"X+_Z+":{type:"pipeElbowXZ3",rotation:0},"X+_Z-":{type:"pipeElbowXZ2",rotation:0},"X-_Z+":{type:"pipeElbowXZ4",rotation:0},"X-_Z-":{type:"pipeElbowXZ",rotation:0},"Z+_X+":{type:"pipeElbowXZ3",rotation:0},"Z+_X-":{type:"pipeElbowXZ4",rotation:0},"Z-_X+":{type:"pipeElbowXZ2",rotation:0},"Z-_X-":{type:"pipeElbowXZ",rotation:0},"X+_Y+":{type:"pipeElbowXY",rotation:0},"X+_Y-":{type:"pipeElbowXY",rotation:180},"X-_Y+":{type:"pipeElbowXY2",rotation:0},"X-_Y-":{type:"pipeElbowXY2",rotation:180},"Y+_X+":{type:"pipeElbowXY",rotation:0},"Y+_X-":{type:"pipeElbowXY2",rotation:0},"Y-_X+":{type:"pipeElbowXY",rotation:180},"Y-_X-":{type:"pipeElbowXY2",rotation:180},"Z+_Y+":{type:"pipeElbowYZ",rotation:0},"Z+_Y-":{type:"pipeElbowYZ",rotation:180},"Z-_Y+":{type:"pipeElbowYZ2",rotation:0},"Z-_Y-":{type:"pipeElbowYZ2",rotation:180},"Y+_Z+":{type:"pipeElbowYZ",rotation:0},"Y+_Z-":{type:"pipeElbowYZ2",rotation:0},"Y-_Z+":{type:"pipeElbowYZ",rotation:180},"Y-_Z-":{type:"pipeElbowYZ2",rotation:180}},junctions:{cross:"pipeCross",tXZ:"pipeT",tXY:"pipeTY",tYZ:"pipeTZ"},decorative:["downspout"],allowedScales:[1,2,4],clusterBased:!1},cables:{label:"Cables",straight:{X:"cableX",Y:"cableY",Z:"cableZ"},elbows:{"X+_Z+":{type:"cableElbow",rotation:180},"X+_Z-":{type:"cableElbow",rotation:90},"X-_Z+":{type:"cableElbow",rotation:270},"X-_Z-":{type:"cableElbow",rotation:0},"Z+_X+":{type:"cableElbow",rotation:180},"Z+_X-":{type:"cableElbow",rotation:270},"Z-_X+":{type:"cableElbow",rotation:90},"Z-_X-":{type:"cableElbow",rotation:0},"X+_Y+":{type:"cableElbowY",rotation:0},"X-_Y+":{type:"cableElbowY",rotation:180},"Z+_Y+":{type:"cableElbowY",rotation:90},"Z-_Y+":{type:"cableElbowY",rotation:270},"Y+_X+":{type:"cableElbowY",rotation:0},"Y+_X-":{type:"cableElbowY",rotation:180},"Y+_Z+":{type:"cableElbowY",rotation:90},"Y+_Z-":{type:"cableElbowY",rotation:270}},junctions:{tXZ:"cableT"},decorative:["cableHanging","cableDroop","cableLoop"],allowedScales:[1,2,4],clusterBased:!1},conduits:{label:"Conduits",straight:{X:"conduitX",Y:"conduitY",Z:"conduitZ"},elbows:{"X+_Z+":{type:"conduitElbow",rotation:180},"X+_Z-":{type:"conduitElbow",rotation:90},"X-_Z+":{type:"conduitElbow",rotation:270},"X-_Z-":{type:"conduitElbow",rotation:0},"Z+_X+":{type:"conduitElbow",rotation:180},"Z+_X-":{type:"conduitElbow",rotation:270},"Z-_X+":{type:"conduitElbow",rotation:90},"Z-_X-":{type:"conduitElbow",rotation:0},"X+_Y+":{type:"conduitElbowY",rotation:0},"X-_Y+":{type:"conduitElbowY",rotation:180},"Z+_Y+":{type:"conduitElbowY",rotation:90},"Z-_Y+":{type:"conduitElbowY",rotation:270},"Y+_X+":{type:"conduitElbowY",rotation:0},"Y+_X-":{type:"conduitElbowY",rotation:180},"Y+_Z+":{type:"conduitElbowY",rotation:90},"Y+_Z-":{type:"conduitElbowY",rotation:270}},junctions:{tXZ:"conduitT"},decorative:[],allowedScales:[1,2,4],clusterBased:!1},industrial:{label:"Industrial",straight:{X:"ductX",Y:"iBeam",Z:"ductZ"},elbows:{"X+_Z+":{type:"ductCorner",rotation:180},"X+_Z-":{type:"ductCorner",rotation:90},"X-_Z+":{type:"ductCorner",rotation:270},"X-_Z-":{type:"ductCorner",rotation:0},"Z+_X+":{type:"ductCorner",rotation:180},"Z+_X-":{type:"ductCorner",rotation:270},"Z-_X+":{type:"ductCorner",rotation:90},"Z-_X-":{type:"ductCorner",rotation:0}},junctions:{},decorative:["tank","valve","vent","catwalk","grateFloor"],allowedScales:[1,2,4],clusterBased:!1},natural:{label:"Natural",blocks:["rock","bush","logX","logZ","stump","boulder","grass","flower","rockSmall","rockLarge","rockFlat","rockTall","rockJagged","rockCluster","rockPile","pebbles","slate","crystalSmall","crystalLarge","crystalCluster","crystalSpike","crystalFlat","crystalShard","crystalFormation","stalactite","stalagmite","mushroom","mushroomCluster","moss","vine","coral"],allowedScales:[1,2,4],clusterBased:!0},abstract:{label:"Abstract",blocks:["cube","sphere","cylinder","cone","pyramid","octagon","gem","crystal","prism"],allowedScales:[1,2,4],clusterBased:!0},beams:{label:"Beams",straight:{X:"beamX",Y:"pillar",Z:"beamZ"},elbows:{},junctions:{cross:"crossBeam"},decorative:["truss","post"],allowedScales:[1,2,4],clusterBased:!1},fences:{label:"Fences",straight:{X:"fence",Y:"fencePost",Z:"fenceZ"},elbows:{"X+_Z+":{type:"fenceCorner",rotation:180},"X+_Z-":{type:"fenceCorner",rotation:90},"X-_Z+":{type:"fenceCorner",rotation:270},"X-_Z-":{type:"fenceCorner",rotation:0},"Z+_X+":{type:"fenceCorner",rotation:180},"Z+_X-":{type:"fenceCorner",rotation:270},"Z-_X+":{type:"fenceCorner",rotation:90},"Z-_X-":{type:"fenceCorner",rotation:0}},junctions:{tXZ:"fenceT",cross:"fenceCross"},decorative:["gate","gateArch"],allowedScales:[1,2,4],clusterBased:!1},mixedTech:{label:"Tech Mix",blocks:["pipeX","pipeY","pipeZ","pipeElbowXZ","pipeCross","pipeT","cableX","cableY","cableZ","cableHanging","cableLoop","conduitX","conduitY","conduitZ","tank","valve","vent","antenna","ductX","ductZ"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedOrganic:{label:"Organic Mix",blocks:["rock","bush","logX","logZ","stump","boulder","grass","flower","rockSmall","rockLarge","rockFlat","rockJagged","rockCluster","pebbles","crystalSmall","crystalLarge","crystalCluster","crystalFormation","mushroom","mushroomCluster","moss","vine","coral","sphere","crystal","gem","prism","pillar","pillarRound","post"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedArchitecture:{label:"Architecture Mix",blocks:["cube","slab","slabTop","pillar","pillarRound","arch","archHalf","beamX","beamZ","crossBeam","truss","stairs","stairsCorner","ramp","dome","domeLow","halfX","halfZ","quarter","wedge"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedGeometric:{label:"Geometric Mix",blocks:["cube","sphere","cylinder","cone","pyramid","octagon","prism","gem","crystal","wedge","wedgeCorner","wedgeInner","slab","slabTop","quarter"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedChaos:{label:"Chaos Mix",blocks:["cube","sphere","cylinder","cone","pyramid","gem","pipeX","pipeY","pipeZ","tank","valve","rock","bush","crystal","pillar","arch","dome","stairs","beamX","beamZ","truss","wedge","slab","octagon"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedSciFi:{label:"Sci-Fi Mix",blocks:["pipeX","pipeY","pipeZ","pipeCross","antenna","tank","vent","valve","octagon","cylinder","dome","domeLow","slab","slabTop","grateFloor","catwalk","pillar","pillar2","iBeam"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedRuins:{label:"Ruins Mix",blocks:["cube","slab","quarter","wedge","wedgeCorner","pillar","arch","archHalf","stairs","rock","boulder","bush","grass","moss","vine","rockSmall","rockFlat","rockCluster","pebbles","slate","halfX","halfZ","stump"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},cave:{label:"Cave",blocks:["rock","boulder","rockSmall","rockLarge","rockFlat","rockTall","rockJagged","rockCluster","rockPile","pebbles","slate","crystalSmall","crystalLarge","crystalCluster","crystalSpike","crystalFlat","crystalShard","crystalFormation","stalactite","stalagmite","mushroom","mushroomCluster","moss"],allowedScales:[1,2,4],clusterBased:!0},crystals:{label:"Crystals",blocks:["crystal","gem","prism","crystalSmall","crystalLarge","crystalCluster","crystalSpike","crystalFlat","crystalShard","crystalFormation"],allowedScales:[1,2,4],clusterBased:!0},rocks:{label:"Rocks",blocks:["rock","boulder","rockSmall","rockLarge","rockFlat","rockTall","rockJagged","rockCluster","rockPile","pebbles","slate"],allowedScales:[1,2,4],clusterBased:!0}};function $p(y,t,e){if(!y.elbows)return null;const o=`${t}_${e}`;return y.elbows[o]||null}function Nn(y,t){return y.straight&&y.straight[t]||null}function Un(y){return!y.decorative||y.decorative.length===0?null:y.decorative[Math.floor(Math.random()*y.decorative.length)]}function Vp(y){return!y.blocks||y.blocks.length===0?null:y.blocks[Math.floor(Math.random()*y.blocks.length)]}const ni={walk:{label:"Random Walk",description:"Connected directional growth"},cluster:{label:"Cluster",description:"Organic blob spreading"},lsystem:{label:"L-System",description:"Fractal rule-based growth"},spiral:{label:"Spiral",description:"Spiral tower patterns"},tree:{label:"Tree",description:"Branching tree structures"},wave:{label:"Wave",description:"Sine wave patterns"},drunk:{label:"Drunkard's Walk",description:"Chaotic random movement"},crystal:{label:"Crystal",description:"Geometric crystalline growth"},vine:{label:"Vine",description:"Climbing vine patterns"},layers:{label:"Layered",description:"Stacked layers of different blocks"},scatter3d:{label:"Scatter 3D",description:"Random 3D cloud of mixed blocks"},radial:{label:"Radial Burst",description:"Exploding outward pattern"},gradient:{label:"Gradient",description:"Block types change with distance"},terrain:{label:"Terrain",description:"Heightmap-based mixed terrain"},galaxy:{label:"Galaxy",description:"Spiral arms with mixed blocks"},cavern:{label:"Cavern",description:"Cave with stalactites and stalagmites"},rockField:{label:"Rock Field",description:"Scattered rock landscape"},mushroomGrove:{label:"Mushroom Grove",description:"Forest of mushrooms"},crystalCave:{label:"Crystal Cave",description:"Crystalline cave formation"},coralReef:{label:"Coral Reef",description:"Underwater coral structures"},boulderPile:{label:"Boulder Pile",description:"Piled rocks and stones"}};class Hp{constructor(t){this.blockManager=t,this.preset="pipes",this.algorithm="walk",this.maxBlocks=50,this.branchChance=.2,this.turnChance=.3,this.scaleRatio=.8,this.colorHarmony="analogous",this.verticalBias=.1,this.decorativeChance=.05,this.placedPositions=new Set}generate(t,e={}){const o=fi[this.preset];if(!o)return console.warn(`Unknown scatter preset: ${this.preset}`),[];const i={maxBlocks:e.maxBlocks??this.maxBlocks,branchChance:e.branchChance??this.branchChance,turnChance:e.turnChance??this.turnChance,scaleRatio:e.scaleRatio??this.scaleRatio,baseColor:e.baseColor||"#5588cc",colorHarmony:e.colorHarmony??this.colorHarmony,verticalBias:e.verticalBias??this.verticalBias,decorativeChance:e.decorativeChance??this.decorativeChance},s=this.generateColorPalette(i.baseColor,i.colorHarmony);switch(this.placedPositions.clear(),this.algorithm){case"walk":return this.generateDirectional(t,o,i,s);case"cluster":return this.generateCluster(t,o,i,s);case"lsystem":return this.generateLSystem(t,o,i,s);case"spiral":return this.generateSpiral(t,o,i,s);case"tree":return this.generateTree(t,o,i,s);case"wave":return this.generateWave(t,o,i,s);case"drunk":return this.generateDrunkard(t,o,i,s);case"crystal":return this.generateCrystal(t,o,i,s);case"vine":return this.generateVine(t,o,i,s);case"layers":return this.generateLayers(t,o,i,s);case"scatter3d":return this.generateScatter3D(t,o,i,s);case"radial":return this.generateRadial(t,o,i,s);case"gradient":return this.generateGradient(t,o,i,s);case"terrain":return this.generateTerrain(t,o,i,s);case"galaxy":return this.generateGalaxy(t,o,i,s);case"cavern":return this.generateCavern(t,o,i,s);case"rockField":return this.generateRockField(t,o,i,s);case"mushroomGrove":return this.generateMushroomGrove(t,o,i,s);case"crystalCave":return this.generateCrystalCave(t,o,i,s);case"coralReef":return this.generateCoralReef(t,o,i,s);case"boulderPile":return this.generateBoulderPile(t,o,i,s);default:return o.clusterBased?this.generateCluster(t,o,i,s):this.generateDirectional(t,o,i,s)}}generateDirectional(t,e,o,i){const s=[],n=[],r=["X+","X-","Z+","Z-"],a=r[Math.floor(Math.random()*r.length)];for(n.push({position:{...t},direction:a,previousDirection:null,depth:0});n.length>0&&s.length<o.maxBlocks;){const l=n.shift(),p=this.posKey(l.position);if(this.placedPositions.has(p))continue;const h=this.pickScale(e,o.scaleRatio);if(h>1&&(l.position.x=Math.floor(l.position.x/h)*h,l.position.z=Math.floor(l.position.z/h)*h),this.blockManager.wouldOverlapAt("cube",l.position,{w:1,h:1,d:1},null,h))continue;let u=null,c=0;if(l.previousDirection&&l.previousDirection!==l.direction&&this.getAxisFromDirection(l.previousDirection)!==this.getAxisFromDirection(l.direction)){const g=$p(e,l.previousDirection,l.direction);if(g)u=g.type,c=g.rotation;else{const b=this.getAxisFromDirection(l.direction);u=Nn(e,b)}}else{const g=this.getAxisFromDirection(l.direction);u=Nn(e,g)}if(!u&&(u=Un(e),!u))continue;const d=i[Math.floor(Math.random()*i.length)];s.push({type:u,position:{...l.position},color:d,rotation:{x:0,y:c,z:0},scale:h}),this.placedPositions.add(p);const m=this.moveInDirection(l.position,l.direction,h);let x=l.direction;if(Math.random()<o.turnChance&&(Math.random()<o.verticalBias&&l.direction.charAt(0)!=="Y"?x="Y+":x=this.getPerpendicularDirection(l.direction,o.verticalBias)),n.push({position:m,direction:x,previousDirection:l.direction,depth:l.depth+1}),Math.random()<o.branchChance&&s.length<o.maxBlocks-5){const g=this.getPerpendicularDirection(l.direction,o.verticalBias),b=this.moveInDirection(l.position,g,h);n.push({position:b,direction:g,previousDirection:l.direction,depth:l.depth+1})}if(Math.random()<o.decorativeChance){const g=Un(e);if(g){const b=this.getPerpendicularDirection(l.direction,0),z=this.moveInDirection(l.position,b,1),v=this.posKey(z);!this.placedPositions.has(v)&&!this.blockManager.wouldOverlapAt(g,z)&&(s.push({type:g,position:z,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}}return s}generateCluster(t,e,o,i){const s=[],n=[{...t}];for(;n.length>0&&s.length<o.maxBlocks;){const r=n.shift(),a=this.posKey(r);if(this.placedPositions.has(a))continue;const l=this.pickScale(e,o.scaleRatio),p={...r};if(l>1&&(p.x=Math.floor(r.x/l)*l,p.z=Math.floor(r.z/l)*l),this.blockManager.wouldOverlapAt("cube",p,{w:1,h:1,d:1},null,l))continue;const h=Vp(e);if(!h)continue;const u=i[Math.floor(Math.random()*i.length)];s.push({type:h,position:p,color:u,rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:l}),this.placedPositions.add(a);const c=this.getNeighbors(r);for(const f of c){const d=.7-s.length/o.maxBlocks*.4;Math.random()<d&&n.push(f)}}return s}generateLSystem(t,e,o,i){const s=[],r={F:"F[+F]F[-F]F"},a=Math.min(4,Math.floor(Math.log2(o.maxBlocks/5)));let l="F";for(let f=0;f<a;f++){let d="";for(const m of l)d+=r[m]||m;l=d}const p=[];let h={...t},u=0;const c=25+Math.random()*20;for(const f of l){if(s.length>=o.maxBlocks)break;switch(f){case"F":{const d=this.posKey(h);if(!this.placedPositions.has(d)){const x=this.pickScale(e,o.scaleRatio),g=this.getBlockForPreset(e,"straight");this.blockManager.wouldOverlapAt(g,h,{w:1,h:1,d:1},null,x)||(s.push({type:g,position:{...h},color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.round(u/90)*90,z:0},scale:x}),this.placedPositions.add(d))}const m=u*Math.PI/180;h={x:h.x+Math.round(Math.sin(m)),y:h.y+(Math.random()<o.verticalBias?1:0),z:h.z+Math.round(Math.cos(m))};break}case"+":u+=c;break;case"-":u-=c;break;case"[":p.push({pos:{...h},angle:u});break;case"]":if(p.length>0){const d=p.pop();h=d.pos,u=d.angle}break}}return s}generateSpiral(t,e,o,i){const s=[],n=3+Math.random()*4,r=2+Math.random()*3,a=o.maxBlocks/(2*Math.PI*n);for(let l=0;l<o.maxBlocks;l++){const p=l/o.maxBlocks*a*2*Math.PI,h=n*(1-l/o.maxBlocks*.3),u={x:Math.round(t.x+Math.cos(p)*h),y:Math.round(t.y+p/(2*Math.PI)*r),z:Math.round(t.z+Math.sin(p)*h)},c=this.posKey(u);if(this.placedPositions.has(c))continue;const f=this.pickScale(e,o.scaleRatio),d=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(d,u,{w:1,h:1,d:1},null,f)||(s.push({type:d,position:u,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.round(p*180/Math.PI)%360,z:0},scale:f}),this.placedPositions.add(c))}return s}generateTree(t,e,o,i){const s=[],n=3+Math.floor(Math.random()*5),r=2+Math.floor(Math.random()*3);for(let p=0;p<n&&s.length<o.maxBlocks;p++){const h={x:t.x,y:t.y+p,z:t.z},u=this.posKey(h);if(!this.placedPositions.has(u)){const c=this.getBlockForPreset(e,"vertical");s.push({type:c,position:h,color:i[0],rotation:{x:0,y:0,z:0},scale:1}),this.placedPositions.add(u)}}const a=t.y+n,l=[{dx:1,dz:0},{dx:-1,dz:0},{dx:0,dz:1},{dx:0,dz:-1},{dx:1,dz:1},{dx:-1,dz:1},{dx:1,dz:-1},{dx:-1,dz:-1}];for(const p of l)if(!(Math.random()>o.branchChance*2+.3)){if(s.length>=o.maxBlocks)break;for(let h=1;h<=r;h++){const u={x:t.x+p.dx*h,y:a+Math.floor(h*.5)-1,z:t.z+p.dz*h},c=this.posKey(u);if(!this.placedPositions.has(c)&&s.length<o.maxBlocks){const f=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(f,u)||(s.push({type:f,position:u,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(c))}if(Math.random()<o.branchChance&&s.length<o.maxBlocks){const f={...u,y:u.y+1},d=this.posKey(f);if(!this.placedPositions.has(d)){const m=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(m,f)||(s.push({type:m,position:f,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(d))}}}}return s}generateWave(t,e,o,i){const s=[],n=4+Math.random()*4,r=2+Math.random()*3,a=Math.ceil(Math.sqrt(o.maxBlocks)),l=Math.ceil(o.maxBlocks/a);for(let p=0;p<l&&s.length<o.maxBlocks;p++)for(let h=0;h<a&&s.length<o.maxBlocks;h++){const u=Math.sin(p/n*2*Math.PI),c=Math.sin(h/n*2*Math.PI)*.5,f=Math.round((u+c)*r),d={x:t.x+p-Math.floor(l/2),y:t.y+f+Math.round(r),z:t.z+h-Math.floor(a/2)},m=this.posKey(d);if(this.placedPositions.has(m))continue;const x=this.pickScale(e,o.scaleRatio),g=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(g,d,{w:1,h:1,d:1},null,x)||(s.push({type:g,position:d,color:i[Math.floor((f+r)/(2*r)*i.length)%i.length],rotation:{x:0,y:0,z:0},scale:x}),this.placedPositions.add(m))}return s}generateDrunkard(t,e,o,i){const s=[];let n={...t};const r=[{dx:1,dy:0,dz:0},{dx:-1,dy:0,dz:0},{dx:0,dy:1,dz:0},{dx:0,dy:-1,dz:0},{dx:0,dy:0,dz:1},{dx:0,dy:0,dz:-1}];let a=0;const l=50;for(;s.length<o.maxBlocks&&a<l;){const p=this.posKey(n);if(!this.placedPositions.has(p)){const c=this.pickScale(e,o.scaleRatio),f=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(f,n,{w:1,h:1,d:1},null,c)?a++:(s.push({type:f,position:{...n},color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:c}),this.placedPositions.add(p),a=0)}const h=r[Math.floor(Math.random()*r.length)],u=Math.random()<.3?2:1;n={x:n.x+h.dx*u,y:Math.max(0,n.y+h.dy*u),z:n.z+h.dz*u}}return s}generateCrystal(t,e,o,i){const s=[],n=4+Math.floor(Math.random()*4),r=5+Math.floor(Math.random()*8),a=3+Math.random()*3;for(let l=0;l<r&&s.length<o.maxBlocks;l++){const p=l/r,h=a*(1-p*.8);for(let u=0;u<n;u++){const c=u/n*2*Math.PI,f=h*(.8+Math.random()*.4),d={x:Math.round(t.x+Math.cos(c)*f),y:t.y+l,z:Math.round(t.z+Math.sin(c)*f)},m=this.posKey(d);if(this.placedPositions.has(m))continue;if(s.length>=o.maxBlocks)break;const x=this.getBlockForPreset(e,"any");if(!this.blockManager.wouldOverlapAt(x,d)){const g=Math.floor(p*(i.length-1));s.push({type:x,position:d,color:i[g],rotation:{x:0,y:Math.round(c*180/Math.PI),z:0},scale:1}),this.placedPositions.add(m)}}if(p<.5&&s.length<o.maxBlocks){const u=this.posKey({...t,y:t.y+l});if(!this.placedPositions.has(u)){const c=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(c,{...t,y:t.y+l})||(s.push({type:c,position:{...t,y:t.y+l},color:i[0],rotation:{x:0,y:0,z:0},scale:1}),this.placedPositions.add(u))}}}return s}generateVine(t,e,o,i){const s=[],n=2+Math.floor(Math.random()*3);for(let r=0;r<n;r++){let a={x:t.x+Math.floor(Math.random()*3)-1,y:t.y,z:t.z+Math.floor(Math.random()*3)-1};const l=Math.floor(o.maxBlocks/n);let p=0,h=Math.floor(Math.random()*4)*90;for(;p<l&&s.length<o.maxBlocks;){const u=this.posKey(a);if(!this.placedPositions.has(u)){const c=this.getBlockForPreset(e,"vertical");this.blockManager.wouldOverlapAt(c,a)||(s.push({type:c,position:{...a},color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:h,z:0},scale:1}),this.placedPositions.add(u),p++)}if(Math.random()<.7)a.y++;else{const c=h*Math.PI/180;Math.random()<.5&&(a.x+=Math.round(Math.cos(c)),a.z+=Math.round(Math.sin(c))),Math.random()<o.turnChance&&(h=(h+(Math.random()<.5?90:-90)+360)%360)}if(Math.random()<o.branchChance*.5&&s.length<o.maxBlocks){const c=(h+(Math.random()<.5?90:-90))%360,f=c*Math.PI/180,d={x:a.x+Math.round(Math.cos(f)),y:a.y,z:a.z+Math.round(Math.sin(f))},m=this.posKey(d);if(!this.placedPositions.has(m)){const x=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(x,d)||(s.push({type:x,position:d,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:c,z:0},scale:1}),this.placedPositions.add(m))}}}}return s}generateLayers(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.ceil(o.maxBlocks/n.length),a=Math.ceil(Math.sqrt(r/Math.PI));for(let l=0;l<n.length&&s.length<o.maxBlocks;l++){const p=n[l],h=t.y+l;for(let u=-a;u<=a&&s.length<o.maxBlocks;u++)for(let c=-a;c<=a&&s.length<o.maxBlocks;c++){const f=Math.sqrt(u*u+c*c);if(f>a||Math.random()>.7+.3*(1-f/a))continue;const d={x:t.x+u,y:h,z:t.z+c},m=this.posKey(d);!this.placedPositions.has(m)&&!this.blockManager.wouldOverlapAt(p,d)&&(s.push({type:p,position:d,color:i[l%i.length],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(m))}}return s}generateScatter3D(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.cbrt(o.maxBlocks)*1.5;let a=0;const l=o.maxBlocks*3;for(;s.length<o.maxBlocks&&a<l;){a++;const p=Math.random()*2*Math.PI,h=Math.acos(2*Math.random()-1),u=Math.cbrt(Math.random())*r,c={x:Math.round(t.x+u*Math.sin(h)*Math.cos(p)),y:Math.round(t.y+u*Math.cos(h)),z:Math.round(t.z+u*Math.sin(h)*Math.sin(p))};if(c.y<0)continue;const f=this.posKey(c);if(this.placedPositions.has(f))continue;const d=n[Math.floor(Math.random()*n.length)],m=this.pickScale(e,o.scaleRatio);this.blockManager.wouldOverlapAt(d,c,{w:1,h:1,d:1},null,m)||(s.push({type:d,position:c,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:m}),this.placedPositions.add(f))}return s}generateRadial(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.cbrt(o.maxBlocks)*2,a=8+Math.floor(Math.random()*8);for(let l=0;l<a&&s.length<o.maxBlocks;l++){const p=l/a*2*Math.PI,h=(Math.random()-.3)*Math.PI*.5;for(let u=0;u<=r&&s.length<o.maxBlocks;u++){const c=Math.floor(u/r*n.length),f=n[Math.min(c,n.length-1)],d={x:Math.round(t.x+u*Math.cos(p)*Math.cos(h)),y:Math.round(t.y+u*Math.sin(h)),z:Math.round(t.z+u*Math.sin(p)*Math.cos(h))};if(d.y<0)continue;const m=this.posKey(d);this.placedPositions.has(m)||Math.random()>.8-u/r*.5||this.blockManager.wouldOverlapAt(f,d)||(s.push({type:f,position:d,color:i[c%i.length],rotation:{x:0,y:Math.round(p*180/Math.PI),z:0},scale:1}),this.placedPositions.add(m))}}return s}generateGradient(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.ceil(Math.cbrt(o.maxBlocks));for(let a=-r;a<=r&&s.length<o.maxBlocks;a++)for(let l=0;l<=r&&s.length<o.maxBlocks;l++)for(let p=-r;p<=r&&s.length<o.maxBlocks;p++){const h=Math.sqrt(a*a+l*l+p*p);if(h>r)continue;const u=Math.sin(a*.5)*Math.cos(p*.5)*Math.sin(l*.7);if(Math.random()>.3+u*.2)continue;const c={x:t.x+a,y:t.y+l,z:t.z+p},f=this.posKey(c);if(this.placedPositions.has(f))continue;const d=Math.floor(h/r*n.length),m=n[Math.min(d,n.length-1)];this.blockManager.wouldOverlapAt(m,c)||(s.push({type:m,position:c,color:i[d%i.length],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(f))}return s}generateTerrain(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.ceil(Math.sqrt(o.maxBlocks)),a=6,l=(p,h)=>{const u=Math.sin(p*.3)*Math.cos(h*.3),c=Math.sin(p*.7+1)*Math.cos(h*.5+2),f=Math.sin(p*.15)*Math.cos(h*.15);return(u+c*.5+f*2)/3.5};for(let p=0;p<r&&s.length<o.maxBlocks;p++)for(let h=0;h<r&&s.length<o.maxBlocks;h++){const u=Math.round((l(p,h)+1)*a/2);for(let c=0;c<=u&&s.length<o.maxBlocks;c++){const f={x:t.x+p-Math.floor(r/2),y:t.y+c,z:t.z+h-Math.floor(r/2)},d=this.posKey(f);if(this.placedPositions.has(d))continue;const m=c/a,x=Math.floor(m*n.length),g=n[Math.min(x,n.length-1)];this.blockManager.wouldOverlapAt(g,f)||(s.push({type:g,position:f,color:i[x%i.length],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(d))}}return s}generateGalaxy(t,e,o,i){const s=[],n=this.getBlockList(e),r=2+Math.floor(Math.random()*3),a=Math.floor(o.maxBlocks/r);for(let l=0;l<r&&s.length<o.maxBlocks;l++){const p=l/r*2*Math.PI,h=n[l%n.length];for(let u=0;u<a&&s.length<o.maxBlocks;u++){const c=u/a,f=p+c*3*Math.PI,d=1+c*8,m=(Math.random()-.5)*2*(1+c),x=f+Math.PI/2,g={x:Math.round(t.x+Math.cos(f)*d+Math.cos(x)*m),y:Math.round(t.y+(Math.random()-.5)*2),z:Math.round(t.z+Math.sin(f)*d+Math.sin(x)*m)};g.y<0&&(g.y=0);const b=this.posKey(g);if(this.placedPositions.has(b))continue;const z=Math.random()<.3,v=z?n[Math.floor(Math.random()*n.length)]:h;this.blockManager.wouldOverlapAt(v,g)||(s.push({type:v,position:g,color:i[(l+(z?1:0))%i.length],rotation:{x:0,y:Math.round(f*180/Math.PI),z:0},scale:1}),this.placedPositions.add(b))}}return s}generateCavern(t,e,o,i){const s=[],n=Math.ceil(Math.sqrt(o.maxBlocks/2)),r=6+Math.floor(Math.random()*4),a=["stalactite","crystalSpike","crystalShard"],l=["stalagmite","rockTall","crystalSpike"],p=["rock","rockSmall","rockFlat","pebbles","moss"],h=["rockFlat","slate","moss"],u=["crystalSmall","crystalCluster","crystalFormation"];for(let c=-n;c<=n&&s.length<o.maxBlocks;c++)for(let f=-n;f<=n&&s.length<o.maxBlocks;f++){const d=Math.sqrt(c*c+f*f);if(d>n*1.2)continue;const m={x:t.x+c,y:t.y,z:t.z+f},x=this.posKey(m);if(!this.placedPositions.has(x)&&Math.random()<.4){const g=p[Math.floor(Math.random()*p.length)];this.blockManager.wouldOverlapAt(g,m)||(s.push({type:g,position:m,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(x))}if(Math.random()<.15&&s.length<o.maxBlocks){const g=1+Math.floor(Math.random()*3);for(let b=0;b<g&&s.length<o.maxBlocks;b++){const z={x:m.x,y:t.y+b,z:m.z},v=this.posKey(z);if(!this.placedPositions.has(v)){const C=b===g-1?l[Math.floor(Math.random()*l.length)]:"rockTall";this.blockManager.wouldOverlapAt(C,z)||(s.push({type:C,position:z,color:i[0],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}}if(Math.random()<.2&&s.length<o.maxBlocks){const g=1+Math.floor(Math.random()*3);for(let b=0;b<g&&s.length<o.maxBlocks;b++){const z={x:m.x,y:t.y+r-b,z:m.z},v=this.posKey(z);if(!this.placedPositions.has(v)){const C=b===g-1?a[Math.floor(Math.random()*a.length)]:h[Math.floor(Math.random()*h.length)];this.blockManager.wouldOverlapAt(C,z)||(s.push({type:C,position:z,color:i[Math.min(1,Math.floor(Math.random()*i.length))],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}}if(d>n*.7&&Math.random()<.3&&s.length<o.maxBlocks){const g=t.y+1+Math.floor(Math.random()*(r-2)),b={x:m.x,y:g,z:m.z},z=this.posKey(b);if(!this.placedPositions.has(z)){const v=u[Math.floor(Math.random()*u.length)];this.blockManager.wouldOverlapAt(v,b)||(s.push({type:v,position:b,color:i[2%i.length],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(z))}}}return s}generateRockField(t,e,o,i){const s=[],n=Math.ceil(Math.sqrt(o.maxBlocks)),r=["rockSmall","pebbles","slate"],a=["rock","rockFlat","rockCluster"],l=["rockLarge","rockTall","rockJagged","boulder","rockPile"],p=(h,u)=>Math.sin(h*.4)*Math.cos(u*.4)+Math.sin(h*.8+1)*Math.cos(u*.6)*.5;for(let h=-n;h<=n&&s.length<o.maxBlocks;h++)for(let u=-n;u<=n&&s.length<o.maxBlocks;u++){const c=p(h,u);if(Math.random()>.3+c*.3)continue;const f={x:t.x+h,y:t.y,z:t.z+u},d=this.posKey(f);if(this.placedPositions.has(d))continue;let m;const x=Math.random()+c*.3;x<.4?m=r:x<.8?m=a:m=l;const g=m[Math.floor(Math.random()*m.length)],b=l.includes(g)&&Math.random()>o.scaleRatio?2:1;if(!this.blockManager.wouldOverlapAt(g,f,{w:1,h:1,d:1},null,b)&&(s.push({type:g,position:f,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:b}),this.placedPositions.add(d),Math.random()<.2&&s.length<o.maxBlocks)){const z=[{dx:1,dz:0},{dx:-1,dz:0},{dx:0,dz:1},{dx:0,dz:-1}][Math.floor(Math.random()*4)],v={x:f.x+z.dx,y:t.y,z:f.z+z.dz},C=this.posKey(v);if(!this.placedPositions.has(C)){const B=Math.random()<.5?"moss":"pebbles";this.blockManager.wouldOverlapAt(B,v)||(s.push({type:B,position:v,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(C))}}}return s}generateMushroomGrove(t,e,o,i){const s=[],n=Math.ceil(Math.sqrt(o.maxBlocks)),r=["mushroom","mushroomCluster"],a=["moss","grass","pebbles"];let l=0;const p=o.maxBlocks*3;for(;s.length<o.maxBlocks&&l<p;){l++;const h={x:t.x+(Math.random()-.5)*n*2,z:t.z+(Math.random()-.5)*n*2},u=1+Math.floor(Math.random()*4);for(let c=0;c<u&&s.length<o.maxBlocks;c++){const f=c===0?{x:0,z:0}:{x:Math.floor((Math.random()-.5)*4),z:Math.floor((Math.random()-.5)*4)},d={x:Math.round(h.x+f.x),y:t.y,z:Math.round(h.z+f.z)},m=this.posKey(d);if(this.placedPositions.has(m))continue;const x=c===0&&u>2?"mushroomCluster":r[Math.floor(Math.random()*r.length)],g=x==="mushroomCluster"&&Math.random()>o.scaleRatio?2:1;if(!this.blockManager.wouldOverlapAt(x,d,{w:1,h:1,d:1},null,g)&&(s.push({type:x,position:d,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:g}),this.placedPositions.add(m),Math.random()<.4&&s.length<o.maxBlocks)){const b=[{dx:1,dz:0},{dx:-1,dz:0},{dx:0,dz:1},{dx:0,dz:-1}][Math.floor(Math.random()*4)],z={x:d.x+b.dx,y:t.y,z:d.z+b.dz},v=this.posKey(z);if(!this.placedPositions.has(v)){const C=a[Math.floor(Math.random()*a.length)];this.blockManager.wouldOverlapAt(C,z)||(s.push({type:C,position:z,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}}}return s}generateCrystalCave(t,e,o,i){const s=[],n=Math.ceil(Math.cbrt(o.maxBlocks)*1.5),r=["crystalSmall","crystalShard","gem"],a=["crystal","crystalFlat","crystalSpike"],l=["crystalLarge","crystalCluster","crystalFormation"],p=[{dir:"floor",yBase:0,yMod:1},{dir:"ceiling",yBase:n,yMod:-1},{dir:"wall",yBase:Math.floor(n/2),yMod:0}];for(const h of p){const u=Math.floor(o.maxBlocks/3);let c=0;for(;c<u&&s.length<o.maxBlocks;){const f=Math.random()*2*Math.PI,d=Math.random()*n,m={x:Math.round(t.x+Math.cos(f)*d),y:t.y+h.yBase+(h.yMod!==0?Math.floor(Math.random()*3)*h.yMod:0),z:Math.round(t.z+Math.sin(f)*d)};if(h.dir==="wall"){const B=n*(.8+Math.random()*.2);m.x=Math.round(t.x+Math.cos(f)*B),m.z=Math.round(t.z+Math.sin(f)*B),m.y=t.y+Math.floor(Math.random()*n)}const x=this.posKey(m);if(this.placedPositions.has(x)){c++;continue}const g=Math.sqrt(Math.pow(m.x-t.x,2)+Math.pow(m.z-t.z,2)),b=Math.random()+(1-g/n)*.5;let z;b<.4?z=r:b<.75?z=a:z=l;const v=z[Math.floor(Math.random()*z.length)],C=l.includes(v)&&Math.random()>o.scaleRatio?2:1;if(!this.blockManager.wouldOverlapAt(v,m,{w:1,h:1,d:1},null,C)){const B=Math.floor(f/(2*Math.PI)*i.length);s.push({type:v,position:m,color:i[B%i.length],rotation:{x:0,y:Math.round(f*180/Math.PI),z:0},scale:C}),this.placedPositions.add(x)}c++}}return s}generateCoralReef(t,e,o,i){const s=[],n=Math.ceil(Math.sqrt(o.maxBlocks)),r=["coral","crystalCluster","crystalFormation"],a=["vine","grass","moss"],l=["rockSmall","rockFlat","pebbles"],p=3+Math.floor(Math.random()*3),h=Math.floor(o.maxBlocks/p);for(let u=0;u<p&&s.length<o.maxBlocks;u++){const c={x:t.x+(Math.random()-.5)*n*1.5,z:t.z+(Math.random()-.5)*n*1.5},f=2+Math.random()*3,d=2+Math.floor(Math.random()*3);for(let m=0;m<h&&s.length<o.maxBlocks;m++){const x=Math.random()*2*Math.PI,g=Math.random()*f,b=1-g/f,z={x:Math.round(c.x+Math.cos(x)*g),y:t.y+Math.floor(Math.random()*d*b),z:Math.round(c.z+Math.sin(x)*g)},v=this.posKey(z);if(this.placedPositions.has(v))continue;let C;if(z.y===t.y)C=l[Math.floor(Math.random()*l.length)];else if(z.y>=t.y+d-1)C=r[Math.floor(Math.random()*r.length)];else{const B=Math.random();B<.5?C=r[Math.floor(Math.random()*r.length)]:B<.8?C=a[Math.floor(Math.random()*a.length)]:C=l[Math.floor(Math.random()*l.length)]}this.blockManager.wouldOverlapAt(C,z)||(s.push({type:C,position:z,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}return s}generateBoulderPile(t,e,o,i){const s=[],n=Math.ceil(Math.cbrt(o.maxBlocks)*1.5),r=Math.ceil(n*.8),a=["boulder","rockLarge","rockPile"],l=["rock","rockJagged","rockCluster"],p=["rockFlat","rockSmall","pebbles","slate"];for(let h=0;h<r&&s.length<o.maxBlocks;h++){const u=n*(1-h/r*.7),c=h/r,f=.7-c*.4;for(let d=-Math.ceil(u);d<=Math.ceil(u)&&s.length<o.maxBlocks;d++)for(let m=-Math.ceil(u);m<=Math.ceil(u)&&s.length<o.maxBlocks;m++){if(Math.sqrt(d*d+m*m)>u||Math.random()>f)continue;const g={x:t.x+d,y:t.y+h,z:t.z+m},b=this.posKey(g);if(this.placedPositions.has(b))continue;let z;c<.3?z=Math.random()<.6?a:l:c<.7?z=Math.random()<.5?l:p:z=Math.random()<.7?p:l;const v=z[Math.floor(Math.random()*z.length)],C=a.includes(v)&&h<2&&Math.random()>o.scaleRatio?2:1;this.blockManager.wouldOverlapAt(v,g,{w:1,h:1,d:1},null,C)||(s.push({type:v,position:g,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:C}),this.placedPositions.add(b))}}return s}getBlockList(t){if(t.blocks&&t.blocks.length>0)return t.blocks;const e=[];return t.straight&&e.push(...Object.values(t.straight)),t.decorative&&e.push(...t.decorative),t.junctions&&e.push(...Object.values(t.junctions)),e.length>0?e:["cube"]}getBlockForPreset(t,e="any"){var o;if(t.clusterBased&&t.blocks)return t.blocks[Math.floor(Math.random()*t.blocks.length)];if(e==="vertical"&&((o=t.straight)!=null&&o.Y))return t.straight.Y;if(e==="straight"&&t.straight){const i=Object.keys(t.straight);return t.straight[i[Math.floor(Math.random()*i.length)]]}if(t.straight){const i=Object.keys(t.straight);return t.straight[i[Math.floor(Math.random()*i.length)]]}return t.decorative&&t.decorative.length>0?t.decorative[Math.floor(Math.random()*t.decorative.length)]:"cube"}getAxisFromDirection(t){return t.charAt(0)}getSignFromDirection(t){return t.charAt(1)==="+"?1:-1}moveInDirection(t,e,o=1){const i={...t},s=this.getSignFromDirection(e),n=this.getAxisFromDirection(e).toLowerCase();return i[n]+=s*o,i}getPerpendicularDirection(t,e=0){const o=this.getAxisFromDirection(t);let i;return o==="X"?(i=["Z+","Z-"],e>0&&Math.random()<e&&i.push("Y+","Y-")):o==="Z"?(i=["X+","X-"],e>0&&Math.random()<e&&i.push("Y+","Y-")):i=["X+","X-","Z+","Z-"],i[Math.floor(Math.random()*i.length)]}pickScale(t,e){const o=t.allowedScales||[1],i=o.includes(2),s=o.includes(4);if(!i&&!s)return 1;const n=Math.random();if(s&&i){const r=.3+e*.7,a=Math.max(0,(1-e)*.3),l=1-r-a;return n<r?1:n<r+l?2:4}else{if(i)return n>e?2:1;if(s)return n>e?4:1}return 1}getNeighbors(t){return[{x:t.x+1,y:t.y,z:t.z},{x:t.x-1,y:t.y,z:t.z},{x:t.x,y:t.y+1,z:t.z},{x:t.x,y:t.y-1,z:t.z},{x:t.x,y:t.y,z:t.z+1},{x:t.x,y:t.y,z:t.z-1}]}posKey(t){return`${Math.floor(t.x)},${Math.floor(t.y)},${Math.floor(t.z)}`}generateColorPalette(t,e){const o=new ot(t),i={h:0,s:0,l:0};o.getHSL(i);const s=[t];switch(e){case"analogous":s.push(this.hslToHex(i.h+.083,i.s,i.l),this.hslToHex(i.h-.083,i.s,i.l),this.hslToHex(i.h+.042,i.s,i.l*.7),this.hslToHex(i.h-.042,i.s*.8,Math.min(1,i.l*1.2)));break;case"complementary":s.push(this.hslToHex(i.h+.5,i.s,i.l),this.hslToHex(i.h,i.s*.6,i.l),this.hslToHex(i.h+.5,i.s*.6,i.l));break;case"triadic":s.push(this.hslToHex(i.h+.333,i.s,i.l),this.hslToHex(i.h+.666,i.s,i.l),this.hslToHex(i.h,i.s,i.l*.7));break;case"monochrome":s.push(this.hslToHex(i.h,i.s,i.l*.5),this.hslToHex(i.h,i.s,i.l*.7),this.hslToHex(i.h,i.s*.5,Math.min(1,i.l*1.2)),this.hslToHex(i.h,i.s*.3,Math.min(1,i.l*1.4)));break;case"split":s.push(this.hslToHex(i.h+.417,i.s,i.l),this.hslToHex(i.h+.583,i.s,i.l),this.hslToHex(i.h,i.s*.7,i.l*.8));break;default:for(let n=0;n<4;n++)s.push(this.hslToHex(i.h+(Math.random()-.5)*.2,Math.max(.2,i.s+(Math.random()-.5)*.3),Math.max(.2,Math.min(.9,i.l+(Math.random()-.5)*.3))))}return s}hslToHex(t,e,o){t=(t%1+1)%1,e=Math.max(0,Math.min(1,e)),o=Math.max(0,Math.min(1,o));const i=new ot;return i.setHSL(t,e,o),"#"+i.getHexString()}setPreset(t){fi[t]&&(this.preset=t)}setMaxBlocks(t){this.maxBlocks=Math.max(1,Math.min(500,t))}setBranchChance(t){this.branchChance=Math.max(0,Math.min(1,t))}setScaleRatio(t){this.scaleRatio=Math.max(0,Math.min(1,t))}setColorHarmony(t){this.colorHarmony=t}setAlgorithm(t){ni[t]&&(this.algorithm=t)}}var Ko=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Wp(y){return y&&y.__esModule&&Object.prototype.hasOwnProperty.call(y,"default")?y.default:y}function Jo(y){throw new Error('Could not dynamically require "'+y+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ki={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/var Xn;function qp(){return Xn||(Xn=1,(function(y,t){(function(e){y.exports=e()})(function(){return(function e(o,i,s){function n(l,p){if(!i[l]){if(!o[l]){var h=typeof Jo=="function"&&Jo;if(!p&&h)return h(l,!0);if(r)return r(l,!0);var u=new Error("Cannot find module '"+l+"'");throw u.code="MODULE_NOT_FOUND",u}var c=i[l]={exports:{}};o[l][0].call(c.exports,function(f){var d=o[l][1][f];return n(d||f)},c,c.exports,e,o,i,s)}return i[l].exports}for(var r=typeof Jo=="function"&&Jo,a=0;a<s.length;a++)n(s[a]);return n})({1:[function(e,o,i){var s=e("./utils"),n=e("./support"),r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(a){for(var l,p,h,u,c,f,d,m=[],x=0,g=a.length,b=g,z=s.getTypeOf(a)!=="string";x<a.length;)b=g-x,h=z?(l=a[x++],p=x<g?a[x++]:0,x<g?a[x++]:0):(l=a.charCodeAt(x++),p=x<g?a.charCodeAt(x++):0,x<g?a.charCodeAt(x++):0),u=l>>2,c=(3&l)<<4|p>>4,f=1<b?(15&p)<<2|h>>6:64,d=2<b?63&h:64,m.push(r.charAt(u)+r.charAt(c)+r.charAt(f)+r.charAt(d));return m.join("")},i.decode=function(a){var l,p,h,u,c,f,d=0,m=0,x="data:";if(a.substr(0,x.length)===x)throw new Error("Invalid base64 input, it looks like a data url.");var g,b=3*(a=a.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(a.charAt(a.length-1)===r.charAt(64)&&b--,a.charAt(a.length-2)===r.charAt(64)&&b--,b%1!=0)throw new Error("Invalid base64 input, bad content length.");for(g=n.uint8array?new Uint8Array(0|b):new Array(0|b);d<a.length;)l=r.indexOf(a.charAt(d++))<<2|(u=r.indexOf(a.charAt(d++)))>>4,p=(15&u)<<4|(c=r.indexOf(a.charAt(d++)))>>2,h=(3&c)<<6|(f=r.indexOf(a.charAt(d++))),g[m++]=l,c!==64&&(g[m++]=p),f!==64&&(g[m++]=h);return g}},{"./support":30,"./utils":32}],2:[function(e,o,i){var s=e("./external"),n=e("./stream/DataWorker"),r=e("./stream/Crc32Probe"),a=e("./stream/DataLengthProbe");function l(p,h,u,c,f){this.compressedSize=p,this.uncompressedSize=h,this.crc32=u,this.compression=c,this.compressedContent=f}l.prototype={getContentWorker:function(){var p=new n(s.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new a("data_length")),h=this;return p.on("end",function(){if(this.streamInfo.data_length!==h.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),p},getCompressedWorker:function(){return new n(s.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(p,h,u){return p.pipe(new r).pipe(new a("uncompressedSize")).pipe(h.compressWorker(u)).pipe(new a("compressedSize")).withStreamInfo("compression",h)},o.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,o,i){var s=e("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new s("STORE compression")},uncompressWorker:function(){return new s("STORE decompression")}},i.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,o,i){var s=e("./utils"),n=(function(){for(var r,a=[],l=0;l<256;l++){r=l;for(var p=0;p<8;p++)r=1&r?3988292384^r>>>1:r>>>1;a[l]=r}return a})();o.exports=function(r,a){return r!==void 0&&r.length?s.getTypeOf(r)!=="string"?(function(l,p,h,u){var c=n,f=u+h;l^=-1;for(var d=u;d<f;d++)l=l>>>8^c[255&(l^p[d])];return-1^l})(0|a,r,r.length,0):(function(l,p,h,u){var c=n,f=u+h;l^=-1;for(var d=u;d<f;d++)l=l>>>8^c[255&(l^p.charCodeAt(d))];return-1^l})(0|a,r,r.length,0):0}},{"./utils":32}],5:[function(e,o,i){i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(e,o,i){var s=null;s=typeof Promise<"u"?Promise:e("lie"),o.exports={Promise:s}},{lie:37}],7:[function(e,o,i){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",n=e("pako"),r=e("./utils"),a=e("./stream/GenericWorker"),l=s?"uint8array":"array";function p(h,u){a.call(this,"FlateWorker/"+h),this._pako=null,this._pakoAction=h,this._pakoOptions=u,this.meta={}}i.magic="\b\0",r.inherits(p,a),p.prototype.processChunk=function(h){this.meta=h.meta,this._pako===null&&this._createPako(),this._pako.push(r.transformTo(l,h.data),!1)},p.prototype.flush=function(){a.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},p.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this._pako=null},p.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var h=this;this._pako.onData=function(u){h.push({data:u,meta:h.meta})}},i.compressWorker=function(h){return new p("Deflate",h)},i.uncompressWorker=function(){return new p("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,o,i){function s(c,f){var d,m="";for(d=0;d<f;d++)m+=String.fromCharCode(255&c),c>>>=8;return m}function n(c,f,d,m,x,g){var b,z,v=c.file,C=c.compression,B=g!==l.utf8encode,A=r.transformTo("string",g(v.name)),M=r.transformTo("string",l.utf8encode(v.name)),_=v.comment,P=r.transformTo("string",g(_)),k=r.transformTo("string",l.utf8encode(_)),T=M.length!==v.name.length,F=k.length!==_.length,D="",J="",Z="",rt=v.dir,$=v.date,et={crc32:0,compressedSize:0,uncompressedSize:0};f&&!d||(et.crc32=c.crc32,et.compressedSize=c.compressedSize,et.uncompressedSize=c.uncompressedSize);var N=0;f&&(N|=8),B||!T&&!F||(N|=2048);var L=0,Y=0;rt&&(L|=16),x==="UNIX"?(Y=798,L|=(function(W,ft){var Et=W;return W||(Et=ft?16893:33204),(65535&Et)<<16})(v.unixPermissions,rt)):(Y=20,L|=(function(W){return 63&(W||0)})(v.dosPermissions)),b=$.getUTCHours(),b<<=6,b|=$.getUTCMinutes(),b<<=5,b|=$.getUTCSeconds()/2,z=$.getUTCFullYear()-1980,z<<=4,z|=$.getUTCMonth()+1,z<<=5,z|=$.getUTCDate(),T&&(J=s(1,1)+s(p(A),4)+M,D+="up"+s(J.length,2)+J),F&&(Z=s(1,1)+s(p(P),4)+k,D+="uc"+s(Z.length,2)+Z);var V="";return V+=`
\0`,V+=s(N,2),V+=C.magic,V+=s(b,2),V+=s(z,2),V+=s(et.crc32,4),V+=s(et.compressedSize,4),V+=s(et.uncompressedSize,4),V+=s(A.length,2),V+=s(D.length,2),{fileRecord:h.LOCAL_FILE_HEADER+V+A+D,dirRecord:h.CENTRAL_FILE_HEADER+s(Y,2)+V+s(P.length,2)+"\0\0\0\0"+s(L,4)+s(m,4)+A+D+P}}var r=e("../utils"),a=e("../stream/GenericWorker"),l=e("../utf8"),p=e("../crc32"),h=e("../signature");function u(c,f,d,m){a.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=f,this.zipPlatform=d,this.encodeFileName=m,this.streamFiles=c,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}r.inherits(u,a),u.prototype.push=function(c){var f=c.meta.percent||0,d=this.entriesCount,m=this._sources.length;this.accumulate?this.contentBuffer.push(c):(this.bytesWritten+=c.data.length,a.prototype.push.call(this,{data:c.data,meta:{currentFile:this.currentFile,percent:d?(f+100*(d-m-1))/d:100}}))},u.prototype.openedSource=function(c){this.currentSourceOffset=this.bytesWritten,this.currentFile=c.file.name;var f=this.streamFiles&&!c.file.dir;if(f){var d=n(c,f,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:d.fileRecord,meta:{percent:0}})}else this.accumulate=!0},u.prototype.closedSource=function(c){this.accumulate=!1;var f=this.streamFiles&&!c.file.dir,d=n(c,f,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(d.dirRecord),f)this.push({data:(function(m){return h.DATA_DESCRIPTOR+s(m.crc32,4)+s(m.compressedSize,4)+s(m.uncompressedSize,4)})(c),meta:{percent:100}});else for(this.push({data:d.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},u.prototype.flush=function(){for(var c=this.bytesWritten,f=0;f<this.dirRecords.length;f++)this.push({data:this.dirRecords[f],meta:{percent:100}});var d=this.bytesWritten-c,m=(function(x,g,b,z,v){var C=r.transformTo("string",v(z));return h.CENTRAL_DIRECTORY_END+"\0\0\0\0"+s(x,2)+s(x,2)+s(g,4)+s(b,4)+s(C.length,2)+C})(this.dirRecords.length,d,c,this.zipComment,this.encodeFileName);this.push({data:m,meta:{percent:100}})},u.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},u.prototype.registerPrevious=function(c){this._sources.push(c);var f=this;return c.on("data",function(d){f.processChunk(d)}),c.on("end",function(){f.closedSource(f.previous.streamInfo),f._sources.length?f.prepareNextSource():f.end()}),c.on("error",function(d){f.error(d)}),this},u.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},u.prototype.error=function(c){var f=this._sources;if(!a.prototype.error.call(this,c))return!1;for(var d=0;d<f.length;d++)try{f[d].error(c)}catch{}return!0},u.prototype.lock=function(){a.prototype.lock.call(this);for(var c=this._sources,f=0;f<c.length;f++)c[f].lock()},o.exports=u},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,o,i){var s=e("../compressions"),n=e("./ZipFileWorker");i.generateWorker=function(r,a,l){var p=new n(a.streamFiles,l,a.platform,a.encodeFileName),h=0;try{r.forEach(function(u,c){h++;var f=(function(g,b){var z=g||b,v=s[z];if(!v)throw new Error(z+" is not a valid compression method !");return v})(c.options.compression,a.compression),d=c.options.compressionOptions||a.compressionOptions||{},m=c.dir,x=c.date;c._compressWorker(f,d).withStreamInfo("file",{name:u,dir:m,date:x,comment:c.comment||"",unixPermissions:c.unixPermissions,dosPermissions:c.dosPermissions}).pipe(p)}),p.entriesCount=h}catch(u){p.error(u)}return p}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,o,i){function s(){if(!(this instanceof s))return new s;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var n=new s;for(var r in this)typeof this[r]!="function"&&(n[r]=this[r]);return n}}(s.prototype=e("./object")).loadAsync=e("./load"),s.support=e("./support"),s.defaults=e("./defaults"),s.version="3.10.1",s.loadAsync=function(n,r){return new s().loadAsync(n,r)},s.external=e("./external"),o.exports=s},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,o,i){var s=e("./utils"),n=e("./external"),r=e("./utf8"),a=e("./zipEntries"),l=e("./stream/Crc32Probe"),p=e("./nodejsUtils");function h(u){return new n.Promise(function(c,f){var d=u.decompressed.getContentWorker().pipe(new l);d.on("error",function(m){f(m)}).on("end",function(){d.streamInfo.crc32!==u.decompressed.crc32?f(new Error("Corrupted zip : CRC32 mismatch")):c()}).resume()})}o.exports=function(u,c){var f=this;return c=s.extend(c||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:r.utf8decode}),p.isNode&&p.isStream(u)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):s.prepareContent("the loaded zip file",u,!0,c.optimizedBinaryString,c.base64).then(function(d){var m=new a(c);return m.load(d),m}).then(function(d){var m=[n.Promise.resolve(d)],x=d.files;if(c.checkCRC32)for(var g=0;g<x.length;g++)m.push(h(x[g]));return n.Promise.all(m)}).then(function(d){for(var m=d.shift(),x=m.files,g=0;g<x.length;g++){var b=x[g],z=b.fileNameStr,v=s.resolve(b.fileNameStr);f.file(v,b.decompressed,{binary:!0,optimizedBinaryString:!0,date:b.date,dir:b.dir,comment:b.fileCommentStr.length?b.fileCommentStr:null,unixPermissions:b.unixPermissions,dosPermissions:b.dosPermissions,createFolders:c.createFolders}),b.dir||(f.file(v).unsafeOriginalName=z)}return m.zipComment.length&&(f.comment=m.zipComment),f})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,o,i){var s=e("../utils"),n=e("../stream/GenericWorker");function r(a,l){n.call(this,"Nodejs stream input adapter for "+a),this._upstreamEnded=!1,this._bindStream(l)}s.inherits(r,n),r.prototype._bindStream=function(a){var l=this;(this._stream=a).pause(),a.on("data",function(p){l.push({data:p,meta:{percent:0}})}).on("error",function(p){l.isPaused?this.generatedError=p:l.error(p)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},r.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},o.exports=r},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,o,i){var s=e("readable-stream").Readable;function n(r,a,l){s.call(this,a),this._helper=r;var p=this;r.on("data",function(h,u){p.push(h)||p._helper.pause(),l&&l(u)}).on("error",function(h){p.emit("error",h)}).on("end",function(){p.push(null)})}e("../utils").inherits(n,s),n.prototype._read=function(){this._helper.resume()},o.exports=n},{"../utils":32,"readable-stream":16}],14:[function(e,o,i){o.exports={isNode:typeof Buffer<"u",newBufferFrom:function(s,n){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(s,n);if(typeof s=="number")throw new Error('The "data" argument must not be a number');return new Buffer(s,n)},allocBuffer:function(s){if(Buffer.alloc)return Buffer.alloc(s);var n=new Buffer(s);return n.fill(0),n},isBuffer:function(s){return Buffer.isBuffer(s)},isStream:function(s){return s&&typeof s.on=="function"&&typeof s.pause=="function"&&typeof s.resume=="function"}}},{}],15:[function(e,o,i){function s(v,C,B){var A,M=r.getTypeOf(C),_=r.extend(B||{},p);_.date=_.date||new Date,_.compression!==null&&(_.compression=_.compression.toUpperCase()),typeof _.unixPermissions=="string"&&(_.unixPermissions=parseInt(_.unixPermissions,8)),_.unixPermissions&&16384&_.unixPermissions&&(_.dir=!0),_.dosPermissions&&16&_.dosPermissions&&(_.dir=!0),_.dir&&(v=x(v)),_.createFolders&&(A=m(v))&&g.call(this,A,!0);var P=M==="string"&&_.binary===!1&&_.base64===!1;B&&B.binary!==void 0||(_.binary=!P),(C instanceof h&&C.uncompressedSize===0||_.dir||!C||C.length===0)&&(_.base64=!1,_.binary=!0,C="",_.compression="STORE",M="string");var k=null;k=C instanceof h||C instanceof a?C:f.isNode&&f.isStream(C)?new d(v,C):r.prepareContent(v,C,_.binary,_.optimizedBinaryString,_.base64);var T=new u(v,k,_);this.files[v]=T}var n=e("./utf8"),r=e("./utils"),a=e("./stream/GenericWorker"),l=e("./stream/StreamHelper"),p=e("./defaults"),h=e("./compressedObject"),u=e("./zipObject"),c=e("./generate"),f=e("./nodejsUtils"),d=e("./nodejs/NodejsStreamInputAdapter"),m=function(v){v.slice(-1)==="/"&&(v=v.substring(0,v.length-1));var C=v.lastIndexOf("/");return 0<C?v.substring(0,C):""},x=function(v){return v.slice(-1)!=="/"&&(v+="/"),v},g=function(v,C){return C=C!==void 0?C:p.createFolders,v=x(v),this.files[v]||s.call(this,v,null,{dir:!0,createFolders:C}),this.files[v]};function b(v){return Object.prototype.toString.call(v)==="[object RegExp]"}var z={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(v){var C,B,A;for(C in this.files)A=this.files[C],(B=C.slice(this.root.length,C.length))&&C.slice(0,this.root.length)===this.root&&v(B,A)},filter:function(v){var C=[];return this.forEach(function(B,A){v(B,A)&&C.push(A)}),C},file:function(v,C,B){if(arguments.length!==1)return v=this.root+v,s.call(this,v,C,B),this;if(b(v)){var A=v;return this.filter(function(_,P){return!P.dir&&A.test(_)})}var M=this.files[this.root+v];return M&&!M.dir?M:null},folder:function(v){if(!v)return this;if(b(v))return this.filter(function(M,_){return _.dir&&v.test(M)});var C=this.root+v,B=g.call(this,C),A=this.clone();return A.root=B.name,A},remove:function(v){v=this.root+v;var C=this.files[v];if(C||(v.slice(-1)!=="/"&&(v+="/"),C=this.files[v]),C&&!C.dir)delete this.files[v];else for(var B=this.filter(function(M,_){return _.name.slice(0,v.length)===v}),A=0;A<B.length;A++)delete this.files[B[A].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(v){var C,B={};try{if((B=r.extend(v||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=B.type.toLowerCase(),B.compression=B.compression.toUpperCase(),B.type==="binarystring"&&(B.type="string"),!B.type)throw new Error("No output type specified.");r.checkSupport(B.type),B.platform!=="darwin"&&B.platform!=="freebsd"&&B.platform!=="linux"&&B.platform!=="sunos"||(B.platform="UNIX"),B.platform==="win32"&&(B.platform="DOS");var A=B.comment||this.comment||"";C=c.generateWorker(this,B,A)}catch(M){(C=new a("error")).error(M)}return new l(C,B.type||"string",B.mimeType)},generateAsync:function(v,C){return this.generateInternalStream(v).accumulate(C)},generateNodeStream:function(v,C){return(v=v||{}).type||(v.type="nodebuffer"),this.generateInternalStream(v).toNodejsStream(C)}};o.exports=z},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,o,i){o.exports=e("stream")},{stream:void 0}],17:[function(e,o,i){var s=e("./DataReader");function n(r){s.call(this,r);for(var a=0;a<this.data.length;a++)r[a]=255&r[a]}e("../utils").inherits(n,s),n.prototype.byteAt=function(r){return this.data[this.zero+r]},n.prototype.lastIndexOfSignature=function(r){for(var a=r.charCodeAt(0),l=r.charCodeAt(1),p=r.charCodeAt(2),h=r.charCodeAt(3),u=this.length-4;0<=u;--u)if(this.data[u]===a&&this.data[u+1]===l&&this.data[u+2]===p&&this.data[u+3]===h)return u-this.zero;return-1},n.prototype.readAndCheckSignature=function(r){var a=r.charCodeAt(0),l=r.charCodeAt(1),p=r.charCodeAt(2),h=r.charCodeAt(3),u=this.readData(4);return a===u[0]&&l===u[1]&&p===u[2]&&h===u[3]},n.prototype.readData=function(r){if(this.checkOffset(r),r===0)return[];var a=this.data.slice(this.zero+this.index,this.zero+this.index+r);return this.index+=r,a},o.exports=n},{"../utils":32,"./DataReader":18}],18:[function(e,o,i){var s=e("../utils");function n(r){this.data=r,this.length=r.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(r){this.checkIndex(this.index+r)},checkIndex:function(r){if(this.length<this.zero+r||r<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+r+"). Corrupted zip ?")},setIndex:function(r){this.checkIndex(r),this.index=r},skip:function(r){this.setIndex(this.index+r)},byteAt:function(){},readInt:function(r){var a,l=0;for(this.checkOffset(r),a=this.index+r-1;a>=this.index;a--)l=(l<<8)+this.byteAt(a);return this.index+=r,l},readString:function(r){return s.transformTo("string",this.readData(r))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var r=this.readInt(4);return new Date(Date.UTC(1980+(r>>25&127),(r>>21&15)-1,r>>16&31,r>>11&31,r>>5&63,(31&r)<<1))}},o.exports=n},{"../utils":32}],19:[function(e,o,i){var s=e("./Uint8ArrayReader");function n(r){s.call(this,r)}e("../utils").inherits(n,s),n.prototype.readData=function(r){this.checkOffset(r);var a=this.data.slice(this.zero+this.index,this.zero+this.index+r);return this.index+=r,a},o.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,o,i){var s=e("./DataReader");function n(r){s.call(this,r)}e("../utils").inherits(n,s),n.prototype.byteAt=function(r){return this.data.charCodeAt(this.zero+r)},n.prototype.lastIndexOfSignature=function(r){return this.data.lastIndexOf(r)-this.zero},n.prototype.readAndCheckSignature=function(r){return r===this.readData(4)},n.prototype.readData=function(r){this.checkOffset(r);var a=this.data.slice(this.zero+this.index,this.zero+this.index+r);return this.index+=r,a},o.exports=n},{"../utils":32,"./DataReader":18}],21:[function(e,o,i){var s=e("./ArrayReader");function n(r){s.call(this,r)}e("../utils").inherits(n,s),n.prototype.readData=function(r){if(this.checkOffset(r),r===0)return new Uint8Array(0);var a=this.data.subarray(this.zero+this.index,this.zero+this.index+r);return this.index+=r,a},o.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(e,o,i){var s=e("../utils"),n=e("../support"),r=e("./ArrayReader"),a=e("./StringReader"),l=e("./NodeBufferReader"),p=e("./Uint8ArrayReader");o.exports=function(h){var u=s.getTypeOf(h);return s.checkSupport(u),u!=="string"||n.uint8array?u==="nodebuffer"?new l(h):n.uint8array?new p(s.transformTo("uint8array",h)):new r(s.transformTo("array",h)):new a(h)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,o,i){i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,o,i){var s=e("./GenericWorker"),n=e("../utils");function r(a){s.call(this,"ConvertWorker to "+a),this.destType=a}n.inherits(r,s),r.prototype.processChunk=function(a){this.push({data:n.transformTo(this.destType,a.data),meta:a.meta})},o.exports=r},{"../utils":32,"./GenericWorker":28}],25:[function(e,o,i){var s=e("./GenericWorker"),n=e("../crc32");function r(){s.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(r,s),r.prototype.processChunk=function(a){this.streamInfo.crc32=n(a.data,this.streamInfo.crc32||0),this.push(a)},o.exports=r},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,o,i){var s=e("../utils"),n=e("./GenericWorker");function r(a){n.call(this,"DataLengthProbe for "+a),this.propName=a,this.withStreamInfo(a,0)}s.inherits(r,n),r.prototype.processChunk=function(a){if(a){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+a.data.length}n.prototype.processChunk.call(this,a)},o.exports=r},{"../utils":32,"./GenericWorker":28}],27:[function(e,o,i){var s=e("../utils"),n=e("./GenericWorker");function r(a){n.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,a.then(function(p){l.dataIsReady=!0,l.data=p,l.max=p&&p.length||0,l.type=s.getTypeOf(p),l.isPaused||l._tickAndRepeat()},function(p){l.error(p)})}s.inherits(r,n),r.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,s.delay(this._tickAndRepeat,[],this)),!0)},r.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(s.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},r.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var a=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":a=this.data.substring(this.index,l);break;case"uint8array":a=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":a=this.data.slice(this.index,l)}return this.index=l,this.push({data:a,meta:{percent:this.max?this.index/this.max*100:0}})},o.exports=r},{"../utils":32,"./GenericWorker":28}],28:[function(e,o,i){function s(n){this.name=n||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}s.prototype={push:function(n){this.emit("data",n)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(n){this.emit("error",n)}return!0},error:function(n){return!this.isFinished&&(this.isPaused?this.generatedError=n:(this.isFinished=!0,this.emit("error",n),this.previous&&this.previous.error(n),this.cleanUp()),!0)},on:function(n,r){return this._listeners[n].push(r),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(n,r){if(this._listeners[n])for(var a=0;a<this._listeners[n].length;a++)this._listeners[n][a].call(this,r)},pipe:function(n){return n.registerPrevious(this)},registerPrevious:function(n){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=n.streamInfo,this.mergeStreamInfo(),this.previous=n;var r=this;return n.on("data",function(a){r.processChunk(a)}),n.on("end",function(){r.end()}),n.on("error",function(a){r.error(a)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var n=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),n=!0),this.previous&&this.previous.resume(),!n},flush:function(){},processChunk:function(n){this.push(n)},withStreamInfo:function(n,r){return this.extraStreamInfo[n]=r,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var n in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,n)&&(this.streamInfo[n]=this.extraStreamInfo[n])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var n="Worker "+this.name;return this.previous?this.previous+" -> "+n:n}},o.exports=s},{}],29:[function(e,o,i){var s=e("../utils"),n=e("./ConvertWorker"),r=e("./GenericWorker"),a=e("../base64"),l=e("../support"),p=e("../external"),h=null;if(l.nodestream)try{h=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function u(f,d){return new p.Promise(function(m,x){var g=[],b=f._internalType,z=f._outputType,v=f._mimeType;f.on("data",function(C,B){g.push(C),d&&d(B)}).on("error",function(C){g=[],x(C)}).on("end",function(){try{var C=(function(B,A,M){switch(B){case"blob":return s.newBlob(s.transformTo("arraybuffer",A),M);case"base64":return a.encode(A);default:return s.transformTo(B,A)}})(z,(function(B,A){var M,_=0,P=null,k=0;for(M=0;M<A.length;M++)k+=A[M].length;switch(B){case"string":return A.join("");case"array":return Array.prototype.concat.apply([],A);case"uint8array":for(P=new Uint8Array(k),M=0;M<A.length;M++)P.set(A[M],_),_+=A[M].length;return P;case"nodebuffer":return Buffer.concat(A);default:throw new Error("concat : unsupported type '"+B+"'")}})(b,g),v);m(C)}catch(B){x(B)}g=[]}).resume()})}function c(f,d,m){var x=d;switch(d){case"blob":case"arraybuffer":x="uint8array";break;case"base64":x="string"}try{this._internalType=x,this._outputType=d,this._mimeType=m,s.checkSupport(x),this._worker=f.pipe(new n(x)),f.lock()}catch(g){this._worker=new r("error"),this._worker.error(g)}}c.prototype={accumulate:function(f){return u(this,f)},on:function(f,d){var m=this;return f==="data"?this._worker.on(f,function(x){d.call(m,x.data,x.meta)}):this._worker.on(f,function(){s.delay(d,arguments,m)}),this},resume:function(){return s.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(f){if(s.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new h(this,{objectMode:this._outputType!=="nodebuffer"},f)}},o.exports=c},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,o,i){if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",i.nodebuffer=typeof Buffer<"u",i.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")i.blob=!1;else{var s=new ArrayBuffer(0);try{i.blob=new Blob([s],{type:"application/zip"}).size===0}catch{try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(s),i.blob=n.getBlob("application/zip").size===0}catch{i.blob=!1}}}try{i.nodestream=!!e("readable-stream").Readable}catch{i.nodestream=!1}},{"readable-stream":16}],31:[function(e,o,i){for(var s=e("./utils"),n=e("./support"),r=e("./nodejsUtils"),a=e("./stream/GenericWorker"),l=new Array(256),p=0;p<256;p++)l[p]=252<=p?6:248<=p?5:240<=p?4:224<=p?3:192<=p?2:1;l[254]=l[254]=1;function h(){a.call(this,"utf-8 decode"),this.leftOver=null}function u(){a.call(this,"utf-8 encode")}i.utf8encode=function(c){return n.nodebuffer?r.newBufferFrom(c,"utf-8"):(function(f){var d,m,x,g,b,z=f.length,v=0;for(g=0;g<z;g++)(64512&(m=f.charCodeAt(g)))==55296&&g+1<z&&(64512&(x=f.charCodeAt(g+1)))==56320&&(m=65536+(m-55296<<10)+(x-56320),g++),v+=m<128?1:m<2048?2:m<65536?3:4;for(d=n.uint8array?new Uint8Array(v):new Array(v),g=b=0;b<v;g++)(64512&(m=f.charCodeAt(g)))==55296&&g+1<z&&(64512&(x=f.charCodeAt(g+1)))==56320&&(m=65536+(m-55296<<10)+(x-56320),g++),m<128?d[b++]=m:(m<2048?d[b++]=192|m>>>6:(m<65536?d[b++]=224|m>>>12:(d[b++]=240|m>>>18,d[b++]=128|m>>>12&63),d[b++]=128|m>>>6&63),d[b++]=128|63&m);return d})(c)},i.utf8decode=function(c){return n.nodebuffer?s.transformTo("nodebuffer",c).toString("utf-8"):(function(f){var d,m,x,g,b=f.length,z=new Array(2*b);for(d=m=0;d<b;)if((x=f[d++])<128)z[m++]=x;else if(4<(g=l[x]))z[m++]=65533,d+=g-1;else{for(x&=g===2?31:g===3?15:7;1<g&&d<b;)x=x<<6|63&f[d++],g--;1<g?z[m++]=65533:x<65536?z[m++]=x:(x-=65536,z[m++]=55296|x>>10&1023,z[m++]=56320|1023&x)}return z.length!==m&&(z.subarray?z=z.subarray(0,m):z.length=m),s.applyFromCharCode(z)})(c=s.transformTo(n.uint8array?"uint8array":"array",c))},s.inherits(h,a),h.prototype.processChunk=function(c){var f=s.transformTo(n.uint8array?"uint8array":"array",c.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var d=f;(f=new Uint8Array(d.length+this.leftOver.length)).set(this.leftOver,0),f.set(d,this.leftOver.length)}else f=this.leftOver.concat(f);this.leftOver=null}var m=(function(g,b){var z;for((b=b||g.length)>g.length&&(b=g.length),z=b-1;0<=z&&(192&g[z])==128;)z--;return z<0||z===0?b:z+l[g[z]]>b?z:b})(f),x=f;m!==f.length&&(n.uint8array?(x=f.subarray(0,m),this.leftOver=f.subarray(m,f.length)):(x=f.slice(0,m),this.leftOver=f.slice(m,f.length))),this.push({data:i.utf8decode(x),meta:c.meta})},h.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=h,s.inherits(u,a),u.prototype.processChunk=function(c){this.push({data:i.utf8encode(c.data),meta:c.meta})},i.Utf8EncodeWorker=u},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,o,i){var s=e("./support"),n=e("./base64"),r=e("./nodejsUtils"),a=e("./external");function l(d){return d}function p(d,m){for(var x=0;x<d.length;++x)m[x]=255&d.charCodeAt(x);return m}e("setimmediate"),i.newBlob=function(d,m){i.checkSupport("blob");try{return new Blob([d],{type:m})}catch{try{var x=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return x.append(d),x.getBlob(m)}catch{throw new Error("Bug : can't construct the Blob.")}}};var h={stringifyByChunk:function(d,m,x){var g=[],b=0,z=d.length;if(z<=x)return String.fromCharCode.apply(null,d);for(;b<z;)m==="array"||m==="nodebuffer"?g.push(String.fromCharCode.apply(null,d.slice(b,Math.min(b+x,z)))):g.push(String.fromCharCode.apply(null,d.subarray(b,Math.min(b+x,z)))),b+=x;return g.join("")},stringifyByChar:function(d){for(var m="",x=0;x<d.length;x++)m+=String.fromCharCode(d[x]);return m},applyCanBeUsed:{uint8array:(function(){try{return s.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}})(),nodebuffer:(function(){try{return s.nodebuffer&&String.fromCharCode.apply(null,r.allocBuffer(1)).length===1}catch{return!1}})()}};function u(d){var m=65536,x=i.getTypeOf(d),g=!0;if(x==="uint8array"?g=h.applyCanBeUsed.uint8array:x==="nodebuffer"&&(g=h.applyCanBeUsed.nodebuffer),g)for(;1<m;)try{return h.stringifyByChunk(d,x,m)}catch{m=Math.floor(m/2)}return h.stringifyByChar(d)}function c(d,m){for(var x=0;x<d.length;x++)m[x]=d[x];return m}i.applyFromCharCode=u;var f={};f.string={string:l,array:function(d){return p(d,new Array(d.length))},arraybuffer:function(d){return f.string.uint8array(d).buffer},uint8array:function(d){return p(d,new Uint8Array(d.length))},nodebuffer:function(d){return p(d,r.allocBuffer(d.length))}},f.array={string:u,array:l,arraybuffer:function(d){return new Uint8Array(d).buffer},uint8array:function(d){return new Uint8Array(d)},nodebuffer:function(d){return r.newBufferFrom(d)}},f.arraybuffer={string:function(d){return u(new Uint8Array(d))},array:function(d){return c(new Uint8Array(d),new Array(d.byteLength))},arraybuffer:l,uint8array:function(d){return new Uint8Array(d)},nodebuffer:function(d){return r.newBufferFrom(new Uint8Array(d))}},f.uint8array={string:u,array:function(d){return c(d,new Array(d.length))},arraybuffer:function(d){return d.buffer},uint8array:l,nodebuffer:function(d){return r.newBufferFrom(d)}},f.nodebuffer={string:u,array:function(d){return c(d,new Array(d.length))},arraybuffer:function(d){return f.nodebuffer.uint8array(d).buffer},uint8array:function(d){return c(d,new Uint8Array(d.length))},nodebuffer:l},i.transformTo=function(d,m){if(m=m||"",!d)return m;i.checkSupport(d);var x=i.getTypeOf(m);return f[x][d](m)},i.resolve=function(d){for(var m=d.split("/"),x=[],g=0;g<m.length;g++){var b=m[g];b==="."||b===""&&g!==0&&g!==m.length-1||(b===".."?x.pop():x.push(b))}return x.join("/")},i.getTypeOf=function(d){return typeof d=="string"?"string":Object.prototype.toString.call(d)==="[object Array]"?"array":s.nodebuffer&&r.isBuffer(d)?"nodebuffer":s.uint8array&&d instanceof Uint8Array?"uint8array":s.arraybuffer&&d instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(d){if(!s[d.toLowerCase()])throw new Error(d+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(d){var m,x,g="";for(x=0;x<(d||"").length;x++)g+="\\x"+((m=d.charCodeAt(x))<16?"0":"")+m.toString(16).toUpperCase();return g},i.delay=function(d,m,x){setImmediate(function(){d.apply(x||null,m||[])})},i.inherits=function(d,m){function x(){}x.prototype=m.prototype,d.prototype=new x},i.extend=function(){var d,m,x={};for(d=0;d<arguments.length;d++)for(m in arguments[d])Object.prototype.hasOwnProperty.call(arguments[d],m)&&x[m]===void 0&&(x[m]=arguments[d][m]);return x},i.prepareContent=function(d,m,x,g,b){return a.Promise.resolve(m).then(function(z){return s.blob&&(z instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(z))!==-1)&&typeof FileReader<"u"?new a.Promise(function(v,C){var B=new FileReader;B.onload=function(A){v(A.target.result)},B.onerror=function(A){C(A.target.error)},B.readAsArrayBuffer(z)}):z}).then(function(z){var v=i.getTypeOf(z);return v?(v==="arraybuffer"?z=i.transformTo("uint8array",z):v==="string"&&(b?z=n.decode(z):x&&g!==!0&&(z=(function(C){return p(C,s.uint8array?new Uint8Array(C.length):new Array(C.length))})(z))),z):a.Promise.reject(new Error("Can't read the data of '"+d+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,o,i){var s=e("./reader/readerFor"),n=e("./utils"),r=e("./signature"),a=e("./zipEntry"),l=e("./support");function p(h){this.files=[],this.loadOptions=h}p.prototype={checkSignature:function(h){if(!this.reader.readAndCheckSignature(h)){this.reader.index-=4;var u=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(u)+", expected "+n.pretty(h)+")")}},isSignature:function(h,u){var c=this.reader.index;this.reader.setIndex(h);var f=this.reader.readString(4)===u;return this.reader.setIndex(c),f},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var h=this.reader.readData(this.zipCommentLength),u=l.uint8array?"uint8array":"array",c=n.transformTo(u,h);this.zipComment=this.loadOptions.decodeFileName(c)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var h,u,c,f=this.zip64EndOfCentralSize-44;0<f;)h=this.reader.readInt(2),u=this.reader.readInt(4),c=this.reader.readData(u),this.zip64ExtensibleData[h]={id:h,length:u,value:c}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var h,u;for(h=0;h<this.files.length;h++)u=this.files[h],this.reader.setIndex(u.localHeaderOffset),this.checkSignature(r.LOCAL_FILE_HEADER),u.readLocalPart(this.reader),u.handleUTF8(),u.processAttributes()},readCentralDir:function(){var h;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(r.CENTRAL_FILE_HEADER);)(h=new a({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(h);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var h=this.reader.lastIndexOfSignature(r.CENTRAL_DIRECTORY_END);if(h<0)throw this.isSignature(0,r.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(h);var u=h;if(this.checkSignature(r.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(h=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(h),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,r.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var c=this.centralDirOffset+this.centralDirSize;this.zip64&&(c+=20,c+=12+this.zip64EndOfCentralSize);var f=u-c;if(0<f)this.isSignature(u,r.CENTRAL_FILE_HEADER)||(this.reader.zero=f);else if(f<0)throw new Error("Corrupted zip: missing "+Math.abs(f)+" bytes.")},prepareReader:function(h){this.reader=s(h)},load:function(h){this.prepareReader(h),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},o.exports=p},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,o,i){var s=e("./reader/readerFor"),n=e("./utils"),r=e("./compressedObject"),a=e("./crc32"),l=e("./utf8"),p=e("./compressions"),h=e("./support");function u(c,f){this.options=c,this.loadOptions=f}u.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(c){var f,d;if(c.skip(22),this.fileNameLength=c.readInt(2),d=c.readInt(2),this.fileName=c.readData(this.fileNameLength),c.skip(d),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((f=(function(m){for(var x in p)if(Object.prototype.hasOwnProperty.call(p,x)&&p[x].magic===m)return p[x];return null})(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new r(this.compressedSize,this.uncompressedSize,this.crc32,f,c.readData(this.compressedSize))},readCentralPart:function(c){this.versionMadeBy=c.readInt(2),c.skip(2),this.bitFlag=c.readInt(2),this.compressionMethod=c.readString(2),this.date=c.readDate(),this.crc32=c.readInt(4),this.compressedSize=c.readInt(4),this.uncompressedSize=c.readInt(4);var f=c.readInt(2);if(this.extraFieldsLength=c.readInt(2),this.fileCommentLength=c.readInt(2),this.diskNumberStart=c.readInt(2),this.internalFileAttributes=c.readInt(2),this.externalFileAttributes=c.readInt(4),this.localHeaderOffset=c.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");c.skip(f),this.readExtraFields(c),this.parseZIP64ExtraField(c),this.fileComment=c.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var c=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),c==0&&(this.dosPermissions=63&this.externalFileAttributes),c==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var c=s(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=c.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=c.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=c.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=c.readInt(4))}},readExtraFields:function(c){var f,d,m,x=c.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});c.index+4<x;)f=c.readInt(2),d=c.readInt(2),m=c.readData(d),this.extraFields[f]={id:f,length:d,value:m};c.setIndex(x)},handleUTF8:function(){var c=h.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var f=this.findExtraFieldUnicodePath();if(f!==null)this.fileNameStr=f;else{var d=n.transformTo(c,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(d)}var m=this.findExtraFieldUnicodeComment();if(m!==null)this.fileCommentStr=m;else{var x=n.transformTo(c,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(x)}}},findExtraFieldUnicodePath:function(){var c=this.extraFields[28789];if(c){var f=s(c.value);return f.readInt(1)!==1||a(this.fileName)!==f.readInt(4)?null:l.utf8decode(f.readData(c.length-5))}return null},findExtraFieldUnicodeComment:function(){var c=this.extraFields[25461];if(c){var f=s(c.value);return f.readInt(1)!==1||a(this.fileComment)!==f.readInt(4)?null:l.utf8decode(f.readData(c.length-5))}return null}},o.exports=u},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,o,i){function s(f,d,m){this.name=f,this.dir=m.dir,this.date=m.date,this.comment=m.comment,this.unixPermissions=m.unixPermissions,this.dosPermissions=m.dosPermissions,this._data=d,this._dataBinary=m.binary,this.options={compression:m.compression,compressionOptions:m.compressionOptions}}var n=e("./stream/StreamHelper"),r=e("./stream/DataWorker"),a=e("./utf8"),l=e("./compressedObject"),p=e("./stream/GenericWorker");s.prototype={internalStream:function(f){var d=null,m="string";try{if(!f)throw new Error("No output type specified.");var x=(m=f.toLowerCase())==="string"||m==="text";m!=="binarystring"&&m!=="text"||(m="string"),d=this._decompressWorker();var g=!this._dataBinary;g&&!x&&(d=d.pipe(new a.Utf8EncodeWorker)),!g&&x&&(d=d.pipe(new a.Utf8DecodeWorker))}catch(b){(d=new p("error")).error(b)}return new n(d,m,"")},async:function(f,d){return this.internalStream(f).accumulate(d)},nodeStream:function(f,d){return this.internalStream(f||"nodebuffer").toNodejsStream(d)},_compressWorker:function(f,d){if(this._data instanceof l&&this._data.compression.magic===f.magic)return this._data.getCompressedWorker();var m=this._decompressWorker();return this._dataBinary||(m=m.pipe(new a.Utf8EncodeWorker)),l.createWorkerFrom(m,f,d)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof p?this._data:new r(this._data)}};for(var h=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],u=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},c=0;c<h.length;c++)s.prototype[h[c]]=u;o.exports=s},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,o,i){(function(s){var n,r,a=s.MutationObserver||s.WebKitMutationObserver;if(a){var l=0,p=new a(f),h=s.document.createTextNode("");p.observe(h,{characterData:!0}),n=function(){h.data=l=++l%2}}else if(s.setImmediate||s.MessageChannel===void 0)n="document"in s&&"onreadystatechange"in s.document.createElement("script")?function(){var d=s.document.createElement("script");d.onreadystatechange=function(){f(),d.onreadystatechange=null,d.parentNode.removeChild(d),d=null},s.document.documentElement.appendChild(d)}:function(){setTimeout(f,0)};else{var u=new s.MessageChannel;u.port1.onmessage=f,n=function(){u.port2.postMessage(0)}}var c=[];function f(){var d,m;r=!0;for(var x=c.length;x;){for(m=c,c=[],d=-1;++d<x;)m[d]();x=c.length}r=!1}o.exports=function(d){c.push(d)!==1||r||n()}}).call(this,typeof Ko<"u"?Ko:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,o,i){var s=e("immediate");function n(){}var r={},a=["REJECTED"],l=["FULFILLED"],p=["PENDING"];function h(x){if(typeof x!="function")throw new TypeError("resolver must be a function");this.state=p,this.queue=[],this.outcome=void 0,x!==n&&d(this,x)}function u(x,g,b){this.promise=x,typeof g=="function"&&(this.onFulfilled=g,this.callFulfilled=this.otherCallFulfilled),typeof b=="function"&&(this.onRejected=b,this.callRejected=this.otherCallRejected)}function c(x,g,b){s(function(){var z;try{z=g(b)}catch(v){return r.reject(x,v)}z===x?r.reject(x,new TypeError("Cannot resolve promise with itself")):r.resolve(x,z)})}function f(x){var g=x&&x.then;if(x&&(typeof x=="object"||typeof x=="function")&&typeof g=="function")return function(){g.apply(x,arguments)}}function d(x,g){var b=!1;function z(B){b||(b=!0,r.reject(x,B))}function v(B){b||(b=!0,r.resolve(x,B))}var C=m(function(){g(v,z)});C.status==="error"&&z(C.value)}function m(x,g){var b={};try{b.value=x(g),b.status="success"}catch(z){b.status="error",b.value=z}return b}(o.exports=h).prototype.finally=function(x){if(typeof x!="function")return this;var g=this.constructor;return this.then(function(b){return g.resolve(x()).then(function(){return b})},function(b){return g.resolve(x()).then(function(){throw b})})},h.prototype.catch=function(x){return this.then(null,x)},h.prototype.then=function(x,g){if(typeof x!="function"&&this.state===l||typeof g!="function"&&this.state===a)return this;var b=new this.constructor(n);return this.state!==p?c(b,this.state===l?x:g,this.outcome):this.queue.push(new u(b,x,g)),b},u.prototype.callFulfilled=function(x){r.resolve(this.promise,x)},u.prototype.otherCallFulfilled=function(x){c(this.promise,this.onFulfilled,x)},u.prototype.callRejected=function(x){r.reject(this.promise,x)},u.prototype.otherCallRejected=function(x){c(this.promise,this.onRejected,x)},r.resolve=function(x,g){var b=m(f,g);if(b.status==="error")return r.reject(x,b.value);var z=b.value;if(z)d(x,z);else{x.state=l,x.outcome=g;for(var v=-1,C=x.queue.length;++v<C;)x.queue[v].callFulfilled(g)}return x},r.reject=function(x,g){x.state=a,x.outcome=g;for(var b=-1,z=x.queue.length;++b<z;)x.queue[b].callRejected(g);return x},h.resolve=function(x){return x instanceof this?x:r.resolve(new this(n),x)},h.reject=function(x){var g=new this(n);return r.reject(g,x)},h.all=function(x){var g=this;if(Object.prototype.toString.call(x)!=="[object Array]")return this.reject(new TypeError("must be an array"));var b=x.length,z=!1;if(!b)return this.resolve([]);for(var v=new Array(b),C=0,B=-1,A=new this(n);++B<b;)M(x[B],B);return A;function M(_,P){g.resolve(_).then(function(k){v[P]=k,++C!==b||z||(z=!0,r.resolve(A,v))},function(k){z||(z=!0,r.reject(A,k))})}},h.race=function(x){var g=this;if(Object.prototype.toString.call(x)!=="[object Array]")return this.reject(new TypeError("must be an array"));var b=x.length,z=!1;if(!b)return this.resolve([]);for(var v=-1,C=new this(n);++v<b;)B=x[v],g.resolve(B).then(function(A){z||(z=!0,r.resolve(C,A))},function(A){z||(z=!0,r.reject(C,A))});var B;return C}},{immediate:36}],38:[function(e,o,i){var s={};(0,e("./lib/utils/common").assign)(s,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),o.exports=s},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,o,i){var s=e("./zlib/deflate"),n=e("./utils/common"),r=e("./utils/strings"),a=e("./zlib/messages"),l=e("./zlib/zstream"),p=Object.prototype.toString,h=0,u=-1,c=0,f=8;function d(x){if(!(this instanceof d))return new d(x);this.options=n.assign({level:u,method:f,chunkSize:16384,windowBits:15,memLevel:8,strategy:c,to:""},x||{});var g=this.options;g.raw&&0<g.windowBits?g.windowBits=-g.windowBits:g.gzip&&0<g.windowBits&&g.windowBits<16&&(g.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var b=s.deflateInit2(this.strm,g.level,g.method,g.windowBits,g.memLevel,g.strategy);if(b!==h)throw new Error(a[b]);if(g.header&&s.deflateSetHeader(this.strm,g.header),g.dictionary){var z;if(z=typeof g.dictionary=="string"?r.string2buf(g.dictionary):p.call(g.dictionary)==="[object ArrayBuffer]"?new Uint8Array(g.dictionary):g.dictionary,(b=s.deflateSetDictionary(this.strm,z))!==h)throw new Error(a[b]);this._dict_set=!0}}function m(x,g){var b=new d(g);if(b.push(x,!0),b.err)throw b.msg||a[b.err];return b.result}d.prototype.push=function(x,g){var b,z,v=this.strm,C=this.options.chunkSize;if(this.ended)return!1;z=g===~~g?g:g===!0?4:0,typeof x=="string"?v.input=r.string2buf(x):p.call(x)==="[object ArrayBuffer]"?v.input=new Uint8Array(x):v.input=x,v.next_in=0,v.avail_in=v.input.length;do{if(v.avail_out===0&&(v.output=new n.Buf8(C),v.next_out=0,v.avail_out=C),(b=s.deflate(v,z))!==1&&b!==h)return this.onEnd(b),!(this.ended=!0);v.avail_out!==0&&(v.avail_in!==0||z!==4&&z!==2)||(this.options.to==="string"?this.onData(r.buf2binstring(n.shrinkBuf(v.output,v.next_out))):this.onData(n.shrinkBuf(v.output,v.next_out)))}while((0<v.avail_in||v.avail_out===0)&&b!==1);return z===4?(b=s.deflateEnd(this.strm),this.onEnd(b),this.ended=!0,b===h):z!==2||(this.onEnd(h),!(v.avail_out=0))},d.prototype.onData=function(x){this.chunks.push(x)},d.prototype.onEnd=function(x){x===h&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=x,this.msg=this.strm.msg},i.Deflate=d,i.deflate=m,i.deflateRaw=function(x,g){return(g=g||{}).raw=!0,m(x,g)},i.gzip=function(x,g){return(g=g||{}).gzip=!0,m(x,g)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,o,i){var s=e("./zlib/inflate"),n=e("./utils/common"),r=e("./utils/strings"),a=e("./zlib/constants"),l=e("./zlib/messages"),p=e("./zlib/zstream"),h=e("./zlib/gzheader"),u=Object.prototype.toString;function c(d){if(!(this instanceof c))return new c(d);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},d||{});var m=this.options;m.raw&&0<=m.windowBits&&m.windowBits<16&&(m.windowBits=-m.windowBits,m.windowBits===0&&(m.windowBits=-15)),!(0<=m.windowBits&&m.windowBits<16)||d&&d.windowBits||(m.windowBits+=32),15<m.windowBits&&m.windowBits<48&&(15&m.windowBits)==0&&(m.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new p,this.strm.avail_out=0;var x=s.inflateInit2(this.strm,m.windowBits);if(x!==a.Z_OK)throw new Error(l[x]);this.header=new h,s.inflateGetHeader(this.strm,this.header)}function f(d,m){var x=new c(m);if(x.push(d,!0),x.err)throw x.msg||l[x.err];return x.result}c.prototype.push=function(d,m){var x,g,b,z,v,C,B=this.strm,A=this.options.chunkSize,M=this.options.dictionary,_=!1;if(this.ended)return!1;g=m===~~m?m:m===!0?a.Z_FINISH:a.Z_NO_FLUSH,typeof d=="string"?B.input=r.binstring2buf(d):u.call(d)==="[object ArrayBuffer]"?B.input=new Uint8Array(d):B.input=d,B.next_in=0,B.avail_in=B.input.length;do{if(B.avail_out===0&&(B.output=new n.Buf8(A),B.next_out=0,B.avail_out=A),(x=s.inflate(B,a.Z_NO_FLUSH))===a.Z_NEED_DICT&&M&&(C=typeof M=="string"?r.string2buf(M):u.call(M)==="[object ArrayBuffer]"?new Uint8Array(M):M,x=s.inflateSetDictionary(this.strm,C)),x===a.Z_BUF_ERROR&&_===!0&&(x=a.Z_OK,_=!1),x!==a.Z_STREAM_END&&x!==a.Z_OK)return this.onEnd(x),!(this.ended=!0);B.next_out&&(B.avail_out!==0&&x!==a.Z_STREAM_END&&(B.avail_in!==0||g!==a.Z_FINISH&&g!==a.Z_SYNC_FLUSH)||(this.options.to==="string"?(b=r.utf8border(B.output,B.next_out),z=B.next_out-b,v=r.buf2string(B.output,b),B.next_out=z,B.avail_out=A-z,z&&n.arraySet(B.output,B.output,b,z,0),this.onData(v)):this.onData(n.shrinkBuf(B.output,B.next_out)))),B.avail_in===0&&B.avail_out===0&&(_=!0)}while((0<B.avail_in||B.avail_out===0)&&x!==a.Z_STREAM_END);return x===a.Z_STREAM_END&&(g=a.Z_FINISH),g===a.Z_FINISH?(x=s.inflateEnd(this.strm),this.onEnd(x),this.ended=!0,x===a.Z_OK):g!==a.Z_SYNC_FLUSH||(this.onEnd(a.Z_OK),!(B.avail_out=0))},c.prototype.onData=function(d){this.chunks.push(d)},c.prototype.onEnd=function(d){d===a.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=d,this.msg=this.strm.msg},i.Inflate=c,i.inflate=f,i.inflateRaw=function(d,m){return(m=m||{}).raw=!0,f(d,m)},i.ungzip=f},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,o,i){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";i.assign=function(a){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var p=l.shift();if(p){if(typeof p!="object")throw new TypeError(p+"must be non-object");for(var h in p)p.hasOwnProperty(h)&&(a[h]=p[h])}}return a},i.shrinkBuf=function(a,l){return a.length===l?a:a.subarray?a.subarray(0,l):(a.length=l,a)};var n={arraySet:function(a,l,p,h,u){if(l.subarray&&a.subarray)a.set(l.subarray(p,p+h),u);else for(var c=0;c<h;c++)a[u+c]=l[p+c]},flattenChunks:function(a){var l,p,h,u,c,f;for(l=h=0,p=a.length;l<p;l++)h+=a[l].length;for(f=new Uint8Array(h),l=u=0,p=a.length;l<p;l++)c=a[l],f.set(c,u),u+=c.length;return f}},r={arraySet:function(a,l,p,h,u){for(var c=0;c<h;c++)a[u+c]=l[p+c]},flattenChunks:function(a){return[].concat.apply([],a)}};i.setTyped=function(a){a?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,n)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,r))},i.setTyped(s)},{}],42:[function(e,o,i){var s=e("./common"),n=!0,r=!0;try{String.fromCharCode.apply(null,[0])}catch{n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{r=!1}for(var a=new s.Buf8(256),l=0;l<256;l++)a[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function p(h,u){if(u<65537&&(h.subarray&&r||!h.subarray&&n))return String.fromCharCode.apply(null,s.shrinkBuf(h,u));for(var c="",f=0;f<u;f++)c+=String.fromCharCode(h[f]);return c}a[254]=a[254]=1,i.string2buf=function(h){var u,c,f,d,m,x=h.length,g=0;for(d=0;d<x;d++)(64512&(c=h.charCodeAt(d)))==55296&&d+1<x&&(64512&(f=h.charCodeAt(d+1)))==56320&&(c=65536+(c-55296<<10)+(f-56320),d++),g+=c<128?1:c<2048?2:c<65536?3:4;for(u=new s.Buf8(g),d=m=0;m<g;d++)(64512&(c=h.charCodeAt(d)))==55296&&d+1<x&&(64512&(f=h.charCodeAt(d+1)))==56320&&(c=65536+(c-55296<<10)+(f-56320),d++),c<128?u[m++]=c:(c<2048?u[m++]=192|c>>>6:(c<65536?u[m++]=224|c>>>12:(u[m++]=240|c>>>18,u[m++]=128|c>>>12&63),u[m++]=128|c>>>6&63),u[m++]=128|63&c);return u},i.buf2binstring=function(h){return p(h,h.length)},i.binstring2buf=function(h){for(var u=new s.Buf8(h.length),c=0,f=u.length;c<f;c++)u[c]=h.charCodeAt(c);return u},i.buf2string=function(h,u){var c,f,d,m,x=u||h.length,g=new Array(2*x);for(c=f=0;c<x;)if((d=h[c++])<128)g[f++]=d;else if(4<(m=a[d]))g[f++]=65533,c+=m-1;else{for(d&=m===2?31:m===3?15:7;1<m&&c<x;)d=d<<6|63&h[c++],m--;1<m?g[f++]=65533:d<65536?g[f++]=d:(d-=65536,g[f++]=55296|d>>10&1023,g[f++]=56320|1023&d)}return p(g,f)},i.utf8border=function(h,u){var c;for((u=u||h.length)>h.length&&(u=h.length),c=u-1;0<=c&&(192&h[c])==128;)c--;return c<0||c===0?u:c+a[h[c]]>u?c:u}},{"./common":41}],43:[function(e,o,i){o.exports=function(s,n,r,a){for(var l=65535&s|0,p=s>>>16&65535|0,h=0;r!==0;){for(r-=h=2e3<r?2e3:r;p=p+(l=l+n[a++]|0)|0,--h;);l%=65521,p%=65521}return l|p<<16|0}},{}],44:[function(e,o,i){o.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,o,i){var s=(function(){for(var n,r=[],a=0;a<256;a++){n=a;for(var l=0;l<8;l++)n=1&n?3988292384^n>>>1:n>>>1;r[a]=n}return r})();o.exports=function(n,r,a,l){var p=s,h=l+a;n^=-1;for(var u=l;u<h;u++)n=n>>>8^p[255&(n^r[u])];return-1^n}},{}],46:[function(e,o,i){var s,n=e("../utils/common"),r=e("./trees"),a=e("./adler32"),l=e("./crc32"),p=e("./messages"),h=0,u=4,c=0,f=-2,d=-1,m=4,x=2,g=8,b=9,z=286,v=30,C=19,B=2*z+1,A=15,M=3,_=258,P=_+M+1,k=42,T=113,F=1,D=2,J=3,Z=4;function rt(w,j){return w.msg=p[j],j}function $(w){return(w<<1)-(4<w?9:0)}function et(w){for(var j=w.length;0<=--j;)w[j]=0}function N(w){var j=w.state,X=j.pending;X>w.avail_out&&(X=w.avail_out),X!==0&&(n.arraySet(w.output,j.pending_buf,j.pending_out,X,w.next_out),w.next_out+=X,j.pending_out+=X,w.total_out+=X,w.avail_out-=X,j.pending-=X,j.pending===0&&(j.pending_out=0))}function L(w,j){r._tr_flush_block(w,0<=w.block_start?w.block_start:-1,w.strstart-w.block_start,j),w.block_start=w.strstart,N(w.strm)}function Y(w,j){w.pending_buf[w.pending++]=j}function V(w,j){w.pending_buf[w.pending++]=j>>>8&255,w.pending_buf[w.pending++]=255&j}function W(w,j){var X,S,E=w.max_chain_length,I=w.strstart,G=w.prev_length,H=w.nice_match,O=w.strstart>w.w_size-P?w.strstart-(w.w_size-P):0,q=w.window,tt=w.w_mask,K=w.prev,it=w.strstart+_,dt=q[I+G-1],pt=q[I+G];w.prev_length>=w.good_match&&(E>>=2),H>w.lookahead&&(H=w.lookahead);do if(q[(X=j)+G]===pt&&q[X+G-1]===dt&&q[X]===q[I]&&q[++X]===q[I+1]){I+=2,X++;do;while(q[++I]===q[++X]&&q[++I]===q[++X]&&q[++I]===q[++X]&&q[++I]===q[++X]&&q[++I]===q[++X]&&q[++I]===q[++X]&&q[++I]===q[++X]&&q[++I]===q[++X]&&I<it);if(S=_-(it-I),I=it-_,G<S){if(w.match_start=j,H<=(G=S))break;dt=q[I+G-1],pt=q[I+G]}}while((j=K[j&tt])>O&&--E!=0);return G<=w.lookahead?G:w.lookahead}function ft(w){var j,X,S,E,I,G,H,O,q,tt,K=w.w_size;do{if(E=w.window_size-w.lookahead-w.strstart,w.strstart>=K+(K-P)){for(n.arraySet(w.window,w.window,K,K,0),w.match_start-=K,w.strstart-=K,w.block_start-=K,j=X=w.hash_size;S=w.head[--j],w.head[j]=K<=S?S-K:0,--X;);for(j=X=K;S=w.prev[--j],w.prev[j]=K<=S?S-K:0,--X;);E+=K}if(w.strm.avail_in===0)break;if(G=w.strm,H=w.window,O=w.strstart+w.lookahead,q=E,tt=void 0,tt=G.avail_in,q<tt&&(tt=q),X=tt===0?0:(G.avail_in-=tt,n.arraySet(H,G.input,G.next_in,tt,O),G.state.wrap===1?G.adler=a(G.adler,H,tt,O):G.state.wrap===2&&(G.adler=l(G.adler,H,tt,O)),G.next_in+=tt,G.total_in+=tt,tt),w.lookahead+=X,w.lookahead+w.insert>=M)for(I=w.strstart-w.insert,w.ins_h=w.window[I],w.ins_h=(w.ins_h<<w.hash_shift^w.window[I+1])&w.hash_mask;w.insert&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[I+M-1])&w.hash_mask,w.prev[I&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=I,I++,w.insert--,!(w.lookahead+w.insert<M)););}while(w.lookahead<P&&w.strm.avail_in!==0)}function Et(w,j){for(var X,S;;){if(w.lookahead<P){if(ft(w),w.lookahead<P&&j===h)return F;if(w.lookahead===0)break}if(X=0,w.lookahead>=M&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,X=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),X!==0&&w.strstart-X<=w.w_size-P&&(w.match_length=W(w,X)),w.match_length>=M)if(S=r._tr_tally(w,w.strstart-w.match_start,w.match_length-M),w.lookahead-=w.match_length,w.match_length<=w.max_lazy_match&&w.lookahead>=M){for(w.match_length--;w.strstart++,w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,X=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart,--w.match_length!=0;);w.strstart++}else w.strstart+=w.match_length,w.match_length=0,w.ins_h=w.window[w.strstart],w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+1])&w.hash_mask;else S=r._tr_tally(w,0,w.window[w.strstart]),w.lookahead--,w.strstart++;if(S&&(L(w,!1),w.strm.avail_out===0))return F}return w.insert=w.strstart<M-1?w.strstart:M-1,j===u?(L(w,!0),w.strm.avail_out===0?J:Z):w.last_lit&&(L(w,!1),w.strm.avail_out===0)?F:D}function ct(w,j){for(var X,S,E;;){if(w.lookahead<P){if(ft(w),w.lookahead<P&&j===h)return F;if(w.lookahead===0)break}if(X=0,w.lookahead>=M&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,X=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),w.prev_length=w.match_length,w.prev_match=w.match_start,w.match_length=M-1,X!==0&&w.prev_length<w.max_lazy_match&&w.strstart-X<=w.w_size-P&&(w.match_length=W(w,X),w.match_length<=5&&(w.strategy===1||w.match_length===M&&4096<w.strstart-w.match_start)&&(w.match_length=M-1)),w.prev_length>=M&&w.match_length<=w.prev_length){for(E=w.strstart+w.lookahead-M,S=r._tr_tally(w,w.strstart-1-w.prev_match,w.prev_length-M),w.lookahead-=w.prev_length-1,w.prev_length-=2;++w.strstart<=E&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,X=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),--w.prev_length!=0;);if(w.match_available=0,w.match_length=M-1,w.strstart++,S&&(L(w,!1),w.strm.avail_out===0))return F}else if(w.match_available){if((S=r._tr_tally(w,0,w.window[w.strstart-1]))&&L(w,!1),w.strstart++,w.lookahead--,w.strm.avail_out===0)return F}else w.match_available=1,w.strstart++,w.lookahead--}return w.match_available&&(S=r._tr_tally(w,0,w.window[w.strstart-1]),w.match_available=0),w.insert=w.strstart<M-1?w.strstart:M-1,j===u?(L(w,!0),w.strm.avail_out===0?J:Z):w.last_lit&&(L(w,!1),w.strm.avail_out===0)?F:D}function yt(w,j,X,S,E){this.good_length=w,this.max_lazy=j,this.nice_length=X,this.max_chain=S,this.func=E}function wt(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=g,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*B),this.dyn_dtree=new n.Buf16(2*(2*v+1)),this.bl_tree=new n.Buf16(2*(2*C+1)),et(this.dyn_ltree),et(this.dyn_dtree),et(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(A+1),this.heap=new n.Buf16(2*z+1),et(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*z+1),et(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function xt(w){var j;return w&&w.state?(w.total_in=w.total_out=0,w.data_type=x,(j=w.state).pending=0,j.pending_out=0,j.wrap<0&&(j.wrap=-j.wrap),j.status=j.wrap?k:T,w.adler=j.wrap===2?0:1,j.last_flush=h,r._tr_init(j),c):rt(w,f)}function Xt(w){var j=xt(w);return j===c&&(function(X){X.window_size=2*X.w_size,et(X.head),X.max_lazy_match=s[X.level].max_lazy,X.good_match=s[X.level].good_length,X.nice_match=s[X.level].nice_length,X.max_chain_length=s[X.level].max_chain,X.strstart=0,X.block_start=0,X.lookahead=0,X.insert=0,X.match_length=X.prev_length=M-1,X.match_available=0,X.ins_h=0})(w.state),j}function Qt(w,j,X,S,E,I){if(!w)return f;var G=1;if(j===d&&(j=6),S<0?(G=0,S=-S):15<S&&(G=2,S-=16),E<1||b<E||X!==g||S<8||15<S||j<0||9<j||I<0||m<I)return rt(w,f);S===8&&(S=9);var H=new wt;return(w.state=H).strm=w,H.wrap=G,H.gzhead=null,H.w_bits=S,H.w_size=1<<H.w_bits,H.w_mask=H.w_size-1,H.hash_bits=E+7,H.hash_size=1<<H.hash_bits,H.hash_mask=H.hash_size-1,H.hash_shift=~~((H.hash_bits+M-1)/M),H.window=new n.Buf8(2*H.w_size),H.head=new n.Buf16(H.hash_size),H.prev=new n.Buf16(H.w_size),H.lit_bufsize=1<<E+6,H.pending_buf_size=4*H.lit_bufsize,H.pending_buf=new n.Buf8(H.pending_buf_size),H.d_buf=1*H.lit_bufsize,H.l_buf=3*H.lit_bufsize,H.level=j,H.strategy=I,H.method=X,Xt(w)}s=[new yt(0,0,0,0,function(w,j){var X=65535;for(X>w.pending_buf_size-5&&(X=w.pending_buf_size-5);;){if(w.lookahead<=1){if(ft(w),w.lookahead===0&&j===h)return F;if(w.lookahead===0)break}w.strstart+=w.lookahead,w.lookahead=0;var S=w.block_start+X;if((w.strstart===0||w.strstart>=S)&&(w.lookahead=w.strstart-S,w.strstart=S,L(w,!1),w.strm.avail_out===0)||w.strstart-w.block_start>=w.w_size-P&&(L(w,!1),w.strm.avail_out===0))return F}return w.insert=0,j===u?(L(w,!0),w.strm.avail_out===0?J:Z):(w.strstart>w.block_start&&(L(w,!1),w.strm.avail_out),F)}),new yt(4,4,8,4,Et),new yt(4,5,16,8,Et),new yt(4,6,32,32,Et),new yt(4,4,16,16,ct),new yt(8,16,32,32,ct),new yt(8,16,128,128,ct),new yt(8,32,128,256,ct),new yt(32,128,258,1024,ct),new yt(32,258,258,4096,ct)],i.deflateInit=function(w,j){return Qt(w,j,g,15,8,0)},i.deflateInit2=Qt,i.deflateReset=Xt,i.deflateResetKeep=xt,i.deflateSetHeader=function(w,j){return w&&w.state?w.state.wrap!==2?f:(w.state.gzhead=j,c):f},i.deflate=function(w,j){var X,S,E,I;if(!w||!w.state||5<j||j<0)return w?rt(w,f):f;if(S=w.state,!w.output||!w.input&&w.avail_in!==0||S.status===666&&j!==u)return rt(w,w.avail_out===0?-5:f);if(S.strm=w,X=S.last_flush,S.last_flush=j,S.status===k)if(S.wrap===2)w.adler=0,Y(S,31),Y(S,139),Y(S,8),S.gzhead?(Y(S,(S.gzhead.text?1:0)+(S.gzhead.hcrc?2:0)+(S.gzhead.extra?4:0)+(S.gzhead.name?8:0)+(S.gzhead.comment?16:0)),Y(S,255&S.gzhead.time),Y(S,S.gzhead.time>>8&255),Y(S,S.gzhead.time>>16&255),Y(S,S.gzhead.time>>24&255),Y(S,S.level===9?2:2<=S.strategy||S.level<2?4:0),Y(S,255&S.gzhead.os),S.gzhead.extra&&S.gzhead.extra.length&&(Y(S,255&S.gzhead.extra.length),Y(S,S.gzhead.extra.length>>8&255)),S.gzhead.hcrc&&(w.adler=l(w.adler,S.pending_buf,S.pending,0)),S.gzindex=0,S.status=69):(Y(S,0),Y(S,0),Y(S,0),Y(S,0),Y(S,0),Y(S,S.level===9?2:2<=S.strategy||S.level<2?4:0),Y(S,3),S.status=T);else{var G=g+(S.w_bits-8<<4)<<8;G|=(2<=S.strategy||S.level<2?0:S.level<6?1:S.level===6?2:3)<<6,S.strstart!==0&&(G|=32),G+=31-G%31,S.status=T,V(S,G),S.strstart!==0&&(V(S,w.adler>>>16),V(S,65535&w.adler)),w.adler=1}if(S.status===69)if(S.gzhead.extra){for(E=S.pending;S.gzindex<(65535&S.gzhead.extra.length)&&(S.pending!==S.pending_buf_size||(S.gzhead.hcrc&&S.pending>E&&(w.adler=l(w.adler,S.pending_buf,S.pending-E,E)),N(w),E=S.pending,S.pending!==S.pending_buf_size));)Y(S,255&S.gzhead.extra[S.gzindex]),S.gzindex++;S.gzhead.hcrc&&S.pending>E&&(w.adler=l(w.adler,S.pending_buf,S.pending-E,E)),S.gzindex===S.gzhead.extra.length&&(S.gzindex=0,S.status=73)}else S.status=73;if(S.status===73)if(S.gzhead.name){E=S.pending;do{if(S.pending===S.pending_buf_size&&(S.gzhead.hcrc&&S.pending>E&&(w.adler=l(w.adler,S.pending_buf,S.pending-E,E)),N(w),E=S.pending,S.pending===S.pending_buf_size)){I=1;break}I=S.gzindex<S.gzhead.name.length?255&S.gzhead.name.charCodeAt(S.gzindex++):0,Y(S,I)}while(I!==0);S.gzhead.hcrc&&S.pending>E&&(w.adler=l(w.adler,S.pending_buf,S.pending-E,E)),I===0&&(S.gzindex=0,S.status=91)}else S.status=91;if(S.status===91)if(S.gzhead.comment){E=S.pending;do{if(S.pending===S.pending_buf_size&&(S.gzhead.hcrc&&S.pending>E&&(w.adler=l(w.adler,S.pending_buf,S.pending-E,E)),N(w),E=S.pending,S.pending===S.pending_buf_size)){I=1;break}I=S.gzindex<S.gzhead.comment.length?255&S.gzhead.comment.charCodeAt(S.gzindex++):0,Y(S,I)}while(I!==0);S.gzhead.hcrc&&S.pending>E&&(w.adler=l(w.adler,S.pending_buf,S.pending-E,E)),I===0&&(S.status=103)}else S.status=103;if(S.status===103&&(S.gzhead.hcrc?(S.pending+2>S.pending_buf_size&&N(w),S.pending+2<=S.pending_buf_size&&(Y(S,255&w.adler),Y(S,w.adler>>8&255),w.adler=0,S.status=T)):S.status=T),S.pending!==0){if(N(w),w.avail_out===0)return S.last_flush=-1,c}else if(w.avail_in===0&&$(j)<=$(X)&&j!==u)return rt(w,-5);if(S.status===666&&w.avail_in!==0)return rt(w,-5);if(w.avail_in!==0||S.lookahead!==0||j!==h&&S.status!==666){var H=S.strategy===2?(function(O,q){for(var tt;;){if(O.lookahead===0&&(ft(O),O.lookahead===0)){if(q===h)return F;break}if(O.match_length=0,tt=r._tr_tally(O,0,O.window[O.strstart]),O.lookahead--,O.strstart++,tt&&(L(O,!1),O.strm.avail_out===0))return F}return O.insert=0,q===u?(L(O,!0),O.strm.avail_out===0?J:Z):O.last_lit&&(L(O,!1),O.strm.avail_out===0)?F:D})(S,j):S.strategy===3?(function(O,q){for(var tt,K,it,dt,pt=O.window;;){if(O.lookahead<=_){if(ft(O),O.lookahead<=_&&q===h)return F;if(O.lookahead===0)break}if(O.match_length=0,O.lookahead>=M&&0<O.strstart&&(K=pt[it=O.strstart-1])===pt[++it]&&K===pt[++it]&&K===pt[++it]){dt=O.strstart+_;do;while(K===pt[++it]&&K===pt[++it]&&K===pt[++it]&&K===pt[++it]&&K===pt[++it]&&K===pt[++it]&&K===pt[++it]&&K===pt[++it]&&it<dt);O.match_length=_-(dt-it),O.match_length>O.lookahead&&(O.match_length=O.lookahead)}if(O.match_length>=M?(tt=r._tr_tally(O,1,O.match_length-M),O.lookahead-=O.match_length,O.strstart+=O.match_length,O.match_length=0):(tt=r._tr_tally(O,0,O.window[O.strstart]),O.lookahead--,O.strstart++),tt&&(L(O,!1),O.strm.avail_out===0))return F}return O.insert=0,q===u?(L(O,!0),O.strm.avail_out===0?J:Z):O.last_lit&&(L(O,!1),O.strm.avail_out===0)?F:D})(S,j):s[S.level].func(S,j);if(H!==J&&H!==Z||(S.status=666),H===F||H===J)return w.avail_out===0&&(S.last_flush=-1),c;if(H===D&&(j===1?r._tr_align(S):j!==5&&(r._tr_stored_block(S,0,0,!1),j===3&&(et(S.head),S.lookahead===0&&(S.strstart=0,S.block_start=0,S.insert=0))),N(w),w.avail_out===0))return S.last_flush=-1,c}return j!==u?c:S.wrap<=0?1:(S.wrap===2?(Y(S,255&w.adler),Y(S,w.adler>>8&255),Y(S,w.adler>>16&255),Y(S,w.adler>>24&255),Y(S,255&w.total_in),Y(S,w.total_in>>8&255),Y(S,w.total_in>>16&255),Y(S,w.total_in>>24&255)):(V(S,w.adler>>>16),V(S,65535&w.adler)),N(w),0<S.wrap&&(S.wrap=-S.wrap),S.pending!==0?c:1)},i.deflateEnd=function(w){var j;return w&&w.state?(j=w.state.status)!==k&&j!==69&&j!==73&&j!==91&&j!==103&&j!==T&&j!==666?rt(w,f):(w.state=null,j===T?rt(w,-3):c):f},i.deflateSetDictionary=function(w,j){var X,S,E,I,G,H,O,q,tt=j.length;if(!w||!w.state||(I=(X=w.state).wrap)===2||I===1&&X.status!==k||X.lookahead)return f;for(I===1&&(w.adler=a(w.adler,j,tt,0)),X.wrap=0,tt>=X.w_size&&(I===0&&(et(X.head),X.strstart=0,X.block_start=0,X.insert=0),q=new n.Buf8(X.w_size),n.arraySet(q,j,tt-X.w_size,X.w_size,0),j=q,tt=X.w_size),G=w.avail_in,H=w.next_in,O=w.input,w.avail_in=tt,w.next_in=0,w.input=j,ft(X);X.lookahead>=M;){for(S=X.strstart,E=X.lookahead-(M-1);X.ins_h=(X.ins_h<<X.hash_shift^X.window[S+M-1])&X.hash_mask,X.prev[S&X.w_mask]=X.head[X.ins_h],X.head[X.ins_h]=S,S++,--E;);X.strstart=S,X.lookahead=M-1,ft(X)}return X.strstart+=X.lookahead,X.block_start=X.strstart,X.insert=X.lookahead,X.lookahead=0,X.match_length=X.prev_length=M-1,X.match_available=0,w.next_in=H,w.input=O,w.avail_in=G,X.wrap=I,c},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,o,i){o.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,o,i){o.exports=function(s,n){var r,a,l,p,h,u,c,f,d,m,x,g,b,z,v,C,B,A,M,_,P,k,T,F,D;r=s.state,a=s.next_in,F=s.input,l=a+(s.avail_in-5),p=s.next_out,D=s.output,h=p-(n-s.avail_out),u=p+(s.avail_out-257),c=r.dmax,f=r.wsize,d=r.whave,m=r.wnext,x=r.window,g=r.hold,b=r.bits,z=r.lencode,v=r.distcode,C=(1<<r.lenbits)-1,B=(1<<r.distbits)-1;t:do{b<15&&(g+=F[a++]<<b,b+=8,g+=F[a++]<<b,b+=8),A=z[g&C];e:for(;;){if(g>>>=M=A>>>24,b-=M,(M=A>>>16&255)===0)D[p++]=65535&A;else{if(!(16&M)){if((64&M)==0){A=z[(65535&A)+(g&(1<<M)-1)];continue e}if(32&M){r.mode=12;break t}s.msg="invalid literal/length code",r.mode=30;break t}_=65535&A,(M&=15)&&(b<M&&(g+=F[a++]<<b,b+=8),_+=g&(1<<M)-1,g>>>=M,b-=M),b<15&&(g+=F[a++]<<b,b+=8,g+=F[a++]<<b,b+=8),A=v[g&B];o:for(;;){if(g>>>=M=A>>>24,b-=M,!(16&(M=A>>>16&255))){if((64&M)==0){A=v[(65535&A)+(g&(1<<M)-1)];continue o}s.msg="invalid distance code",r.mode=30;break t}if(P=65535&A,b<(M&=15)&&(g+=F[a++]<<b,(b+=8)<M&&(g+=F[a++]<<b,b+=8)),c<(P+=g&(1<<M)-1)){s.msg="invalid distance too far back",r.mode=30;break t}if(g>>>=M,b-=M,(M=p-h)<P){if(d<(M=P-M)&&r.sane){s.msg="invalid distance too far back",r.mode=30;break t}if(T=x,(k=0)===m){if(k+=f-M,M<_){for(_-=M;D[p++]=x[k++],--M;);k=p-P,T=D}}else if(m<M){if(k+=f+m-M,(M-=m)<_){for(_-=M;D[p++]=x[k++],--M;);if(k=0,m<_){for(_-=M=m;D[p++]=x[k++],--M;);k=p-P,T=D}}}else if(k+=m-M,M<_){for(_-=M;D[p++]=x[k++],--M;);k=p-P,T=D}for(;2<_;)D[p++]=T[k++],D[p++]=T[k++],D[p++]=T[k++],_-=3;_&&(D[p++]=T[k++],1<_&&(D[p++]=T[k++]))}else{for(k=p-P;D[p++]=D[k++],D[p++]=D[k++],D[p++]=D[k++],2<(_-=3););_&&(D[p++]=D[k++],1<_&&(D[p++]=D[k++]))}break}}break}}while(a<l&&p<u);a-=_=b>>3,g&=(1<<(b-=_<<3))-1,s.next_in=a,s.next_out=p,s.avail_in=a<l?l-a+5:5-(a-l),s.avail_out=p<u?u-p+257:257-(p-u),r.hold=g,r.bits=b}},{}],49:[function(e,o,i){var s=e("../utils/common"),n=e("./adler32"),r=e("./crc32"),a=e("./inffast"),l=e("./inftrees"),p=1,h=2,u=0,c=-2,f=1,d=852,m=592;function x(k){return(k>>>24&255)+(k>>>8&65280)+((65280&k)<<8)+((255&k)<<24)}function g(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function b(k){var T;return k&&k.state?(T=k.state,k.total_in=k.total_out=T.total=0,k.msg="",T.wrap&&(k.adler=1&T.wrap),T.mode=f,T.last=0,T.havedict=0,T.dmax=32768,T.head=null,T.hold=0,T.bits=0,T.lencode=T.lendyn=new s.Buf32(d),T.distcode=T.distdyn=new s.Buf32(m),T.sane=1,T.back=-1,u):c}function z(k){var T;return k&&k.state?((T=k.state).wsize=0,T.whave=0,T.wnext=0,b(k)):c}function v(k,T){var F,D;return k&&k.state?(D=k.state,T<0?(F=0,T=-T):(F=1+(T>>4),T<48&&(T&=15)),T&&(T<8||15<T)?c:(D.window!==null&&D.wbits!==T&&(D.window=null),D.wrap=F,D.wbits=T,z(k))):c}function C(k,T){var F,D;return k?(D=new g,(k.state=D).window=null,(F=v(k,T))!==u&&(k.state=null),F):c}var B,A,M=!0;function _(k){if(M){var T;for(B=new s.Buf32(512),A=new s.Buf32(32),T=0;T<144;)k.lens[T++]=8;for(;T<256;)k.lens[T++]=9;for(;T<280;)k.lens[T++]=7;for(;T<288;)k.lens[T++]=8;for(l(p,k.lens,0,288,B,0,k.work,{bits:9}),T=0;T<32;)k.lens[T++]=5;l(h,k.lens,0,32,A,0,k.work,{bits:5}),M=!1}k.lencode=B,k.lenbits=9,k.distcode=A,k.distbits=5}function P(k,T,F,D){var J,Z=k.state;return Z.window===null&&(Z.wsize=1<<Z.wbits,Z.wnext=0,Z.whave=0,Z.window=new s.Buf8(Z.wsize)),D>=Z.wsize?(s.arraySet(Z.window,T,F-Z.wsize,Z.wsize,0),Z.wnext=0,Z.whave=Z.wsize):(D<(J=Z.wsize-Z.wnext)&&(J=D),s.arraySet(Z.window,T,F-D,J,Z.wnext),(D-=J)?(s.arraySet(Z.window,T,F-D,D,0),Z.wnext=D,Z.whave=Z.wsize):(Z.wnext+=J,Z.wnext===Z.wsize&&(Z.wnext=0),Z.whave<Z.wsize&&(Z.whave+=J))),0}i.inflateReset=z,i.inflateReset2=v,i.inflateResetKeep=b,i.inflateInit=function(k){return C(k,15)},i.inflateInit2=C,i.inflate=function(k,T){var F,D,J,Z,rt,$,et,N,L,Y,V,W,ft,Et,ct,yt,wt,xt,Xt,Qt,w,j,X,S,E=0,I=new s.Buf8(4),G=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!k||!k.state||!k.output||!k.input&&k.avail_in!==0)return c;(F=k.state).mode===12&&(F.mode=13),rt=k.next_out,J=k.output,et=k.avail_out,Z=k.next_in,D=k.input,$=k.avail_in,N=F.hold,L=F.bits,Y=$,V=et,j=u;t:for(;;)switch(F.mode){case f:if(F.wrap===0){F.mode=13;break}for(;L<16;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if(2&F.wrap&&N===35615){I[F.check=0]=255&N,I[1]=N>>>8&255,F.check=r(F.check,I,2,0),L=N=0,F.mode=2;break}if(F.flags=0,F.head&&(F.head.done=!1),!(1&F.wrap)||(((255&N)<<8)+(N>>8))%31){k.msg="incorrect header check",F.mode=30;break}if((15&N)!=8){k.msg="unknown compression method",F.mode=30;break}if(L-=4,w=8+(15&(N>>>=4)),F.wbits===0)F.wbits=w;else if(w>F.wbits){k.msg="invalid window size",F.mode=30;break}F.dmax=1<<w,k.adler=F.check=1,F.mode=512&N?10:12,L=N=0;break;case 2:for(;L<16;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if(F.flags=N,(255&F.flags)!=8){k.msg="unknown compression method",F.mode=30;break}if(57344&F.flags){k.msg="unknown header flags set",F.mode=30;break}F.head&&(F.head.text=N>>8&1),512&F.flags&&(I[0]=255&N,I[1]=N>>>8&255,F.check=r(F.check,I,2,0)),L=N=0,F.mode=3;case 3:for(;L<32;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}F.head&&(F.head.time=N),512&F.flags&&(I[0]=255&N,I[1]=N>>>8&255,I[2]=N>>>16&255,I[3]=N>>>24&255,F.check=r(F.check,I,4,0)),L=N=0,F.mode=4;case 4:for(;L<16;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}F.head&&(F.head.xflags=255&N,F.head.os=N>>8),512&F.flags&&(I[0]=255&N,I[1]=N>>>8&255,F.check=r(F.check,I,2,0)),L=N=0,F.mode=5;case 5:if(1024&F.flags){for(;L<16;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}F.length=N,F.head&&(F.head.extra_len=N),512&F.flags&&(I[0]=255&N,I[1]=N>>>8&255,F.check=r(F.check,I,2,0)),L=N=0}else F.head&&(F.head.extra=null);F.mode=6;case 6:if(1024&F.flags&&($<(W=F.length)&&(W=$),W&&(F.head&&(w=F.head.extra_len-F.length,F.head.extra||(F.head.extra=new Array(F.head.extra_len)),s.arraySet(F.head.extra,D,Z,W,w)),512&F.flags&&(F.check=r(F.check,D,W,Z)),$-=W,Z+=W,F.length-=W),F.length))break t;F.length=0,F.mode=7;case 7:if(2048&F.flags){if($===0)break t;for(W=0;w=D[Z+W++],F.head&&w&&F.length<65536&&(F.head.name+=String.fromCharCode(w)),w&&W<$;);if(512&F.flags&&(F.check=r(F.check,D,W,Z)),$-=W,Z+=W,w)break t}else F.head&&(F.head.name=null);F.length=0,F.mode=8;case 8:if(4096&F.flags){if($===0)break t;for(W=0;w=D[Z+W++],F.head&&w&&F.length<65536&&(F.head.comment+=String.fromCharCode(w)),w&&W<$;);if(512&F.flags&&(F.check=r(F.check,D,W,Z)),$-=W,Z+=W,w)break t}else F.head&&(F.head.comment=null);F.mode=9;case 9:if(512&F.flags){for(;L<16;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if(N!==(65535&F.check)){k.msg="header crc mismatch",F.mode=30;break}L=N=0}F.head&&(F.head.hcrc=F.flags>>9&1,F.head.done=!0),k.adler=F.check=0,F.mode=12;break;case 10:for(;L<32;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}k.adler=F.check=x(N),L=N=0,F.mode=11;case 11:if(F.havedict===0)return k.next_out=rt,k.avail_out=et,k.next_in=Z,k.avail_in=$,F.hold=N,F.bits=L,2;k.adler=F.check=1,F.mode=12;case 12:if(T===5||T===6)break t;case 13:if(F.last){N>>>=7&L,L-=7&L,F.mode=27;break}for(;L<3;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}switch(F.last=1&N,L-=1,3&(N>>>=1)){case 0:F.mode=14;break;case 1:if(_(F),F.mode=20,T!==6)break;N>>>=2,L-=2;break t;case 2:F.mode=17;break;case 3:k.msg="invalid block type",F.mode=30}N>>>=2,L-=2;break;case 14:for(N>>>=7&L,L-=7&L;L<32;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if((65535&N)!=(N>>>16^65535)){k.msg="invalid stored block lengths",F.mode=30;break}if(F.length=65535&N,L=N=0,F.mode=15,T===6)break t;case 15:F.mode=16;case 16:if(W=F.length){if($<W&&(W=$),et<W&&(W=et),W===0)break t;s.arraySet(J,D,Z,W,rt),$-=W,Z+=W,et-=W,rt+=W,F.length-=W;break}F.mode=12;break;case 17:for(;L<14;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if(F.nlen=257+(31&N),N>>>=5,L-=5,F.ndist=1+(31&N),N>>>=5,L-=5,F.ncode=4+(15&N),N>>>=4,L-=4,286<F.nlen||30<F.ndist){k.msg="too many length or distance symbols",F.mode=30;break}F.have=0,F.mode=18;case 18:for(;F.have<F.ncode;){for(;L<3;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}F.lens[G[F.have++]]=7&N,N>>>=3,L-=3}for(;F.have<19;)F.lens[G[F.have++]]=0;if(F.lencode=F.lendyn,F.lenbits=7,X={bits:F.lenbits},j=l(0,F.lens,0,19,F.lencode,0,F.work,X),F.lenbits=X.bits,j){k.msg="invalid code lengths set",F.mode=30;break}F.have=0,F.mode=19;case 19:for(;F.have<F.nlen+F.ndist;){for(;yt=(E=F.lencode[N&(1<<F.lenbits)-1])>>>16&255,wt=65535&E,!((ct=E>>>24)<=L);){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if(wt<16)N>>>=ct,L-=ct,F.lens[F.have++]=wt;else{if(wt===16){for(S=ct+2;L<S;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if(N>>>=ct,L-=ct,F.have===0){k.msg="invalid bit length repeat",F.mode=30;break}w=F.lens[F.have-1],W=3+(3&N),N>>>=2,L-=2}else if(wt===17){for(S=ct+3;L<S;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}L-=ct,w=0,W=3+(7&(N>>>=ct)),N>>>=3,L-=3}else{for(S=ct+7;L<S;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}L-=ct,w=0,W=11+(127&(N>>>=ct)),N>>>=7,L-=7}if(F.have+W>F.nlen+F.ndist){k.msg="invalid bit length repeat",F.mode=30;break}for(;W--;)F.lens[F.have++]=w}}if(F.mode===30)break;if(F.lens[256]===0){k.msg="invalid code -- missing end-of-block",F.mode=30;break}if(F.lenbits=9,X={bits:F.lenbits},j=l(p,F.lens,0,F.nlen,F.lencode,0,F.work,X),F.lenbits=X.bits,j){k.msg="invalid literal/lengths set",F.mode=30;break}if(F.distbits=6,F.distcode=F.distdyn,X={bits:F.distbits},j=l(h,F.lens,F.nlen,F.ndist,F.distcode,0,F.work,X),F.distbits=X.bits,j){k.msg="invalid distances set",F.mode=30;break}if(F.mode=20,T===6)break t;case 20:F.mode=21;case 21:if(6<=$&&258<=et){k.next_out=rt,k.avail_out=et,k.next_in=Z,k.avail_in=$,F.hold=N,F.bits=L,a(k,V),rt=k.next_out,J=k.output,et=k.avail_out,Z=k.next_in,D=k.input,$=k.avail_in,N=F.hold,L=F.bits,F.mode===12&&(F.back=-1);break}for(F.back=0;yt=(E=F.lencode[N&(1<<F.lenbits)-1])>>>16&255,wt=65535&E,!((ct=E>>>24)<=L);){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if(yt&&(240&yt)==0){for(xt=ct,Xt=yt,Qt=wt;yt=(E=F.lencode[Qt+((N&(1<<xt+Xt)-1)>>xt)])>>>16&255,wt=65535&E,!(xt+(ct=E>>>24)<=L);){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}N>>>=xt,L-=xt,F.back+=xt}if(N>>>=ct,L-=ct,F.back+=ct,F.length=wt,yt===0){F.mode=26;break}if(32&yt){F.back=-1,F.mode=12;break}if(64&yt){k.msg="invalid literal/length code",F.mode=30;break}F.extra=15&yt,F.mode=22;case 22:if(F.extra){for(S=F.extra;L<S;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}F.length+=N&(1<<F.extra)-1,N>>>=F.extra,L-=F.extra,F.back+=F.extra}F.was=F.length,F.mode=23;case 23:for(;yt=(E=F.distcode[N&(1<<F.distbits)-1])>>>16&255,wt=65535&E,!((ct=E>>>24)<=L);){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if((240&yt)==0){for(xt=ct,Xt=yt,Qt=wt;yt=(E=F.distcode[Qt+((N&(1<<xt+Xt)-1)>>xt)])>>>16&255,wt=65535&E,!(xt+(ct=E>>>24)<=L);){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}N>>>=xt,L-=xt,F.back+=xt}if(N>>>=ct,L-=ct,F.back+=ct,64&yt){k.msg="invalid distance code",F.mode=30;break}F.offset=wt,F.extra=15&yt,F.mode=24;case 24:if(F.extra){for(S=F.extra;L<S;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}F.offset+=N&(1<<F.extra)-1,N>>>=F.extra,L-=F.extra,F.back+=F.extra}if(F.offset>F.dmax){k.msg="invalid distance too far back",F.mode=30;break}F.mode=25;case 25:if(et===0)break t;if(W=V-et,F.offset>W){if((W=F.offset-W)>F.whave&&F.sane){k.msg="invalid distance too far back",F.mode=30;break}ft=W>F.wnext?(W-=F.wnext,F.wsize-W):F.wnext-W,W>F.length&&(W=F.length),Et=F.window}else Et=J,ft=rt-F.offset,W=F.length;for(et<W&&(W=et),et-=W,F.length-=W;J[rt++]=Et[ft++],--W;);F.length===0&&(F.mode=21);break;case 26:if(et===0)break t;J[rt++]=F.length,et--,F.mode=21;break;case 27:if(F.wrap){for(;L<32;){if($===0)break t;$--,N|=D[Z++]<<L,L+=8}if(V-=et,k.total_out+=V,F.total+=V,V&&(k.adler=F.check=F.flags?r(F.check,J,V,rt-V):n(F.check,J,V,rt-V)),V=et,(F.flags?N:x(N))!==F.check){k.msg="incorrect data check",F.mode=30;break}L=N=0}F.mode=28;case 28:if(F.wrap&&F.flags){for(;L<32;){if($===0)break t;$--,N+=D[Z++]<<L,L+=8}if(N!==(4294967295&F.total)){k.msg="incorrect length check",F.mode=30;break}L=N=0}F.mode=29;case 29:j=1;break t;case 30:j=-3;break t;case 31:return-4;case 32:default:return c}return k.next_out=rt,k.avail_out=et,k.next_in=Z,k.avail_in=$,F.hold=N,F.bits=L,(F.wsize||V!==k.avail_out&&F.mode<30&&(F.mode<27||T!==4))&&P(k,k.output,k.next_out,V-k.avail_out)?(F.mode=31,-4):(Y-=k.avail_in,V-=k.avail_out,k.total_in+=Y,k.total_out+=V,F.total+=V,F.wrap&&V&&(k.adler=F.check=F.flags?r(F.check,J,V,k.next_out-V):n(F.check,J,V,k.next_out-V)),k.data_type=F.bits+(F.last?64:0)+(F.mode===12?128:0)+(F.mode===20||F.mode===15?256:0),(Y==0&&V===0||T===4)&&j===u&&(j=-5),j)},i.inflateEnd=function(k){if(!k||!k.state)return c;var T=k.state;return T.window&&(T.window=null),k.state=null,u},i.inflateGetHeader=function(k,T){var F;return k&&k.state?(2&(F=k.state).wrap)==0?c:((F.head=T).done=!1,u):c},i.inflateSetDictionary=function(k,T){var F,D=T.length;return k&&k.state?(F=k.state).wrap!==0&&F.mode!==11?c:F.mode===11&&n(1,T,D,0)!==F.check?-3:P(k,T,D,D)?(F.mode=31,-4):(F.havedict=1,u):c},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,o,i){var s=e("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],a=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];o.exports=function(p,h,u,c,f,d,m,x){var g,b,z,v,C,B,A,M,_,P=x.bits,k=0,T=0,F=0,D=0,J=0,Z=0,rt=0,$=0,et=0,N=0,L=null,Y=0,V=new s.Buf16(16),W=new s.Buf16(16),ft=null,Et=0;for(k=0;k<=15;k++)V[k]=0;for(T=0;T<c;T++)V[h[u+T]]++;for(J=P,D=15;1<=D&&V[D]===0;D--);if(D<J&&(J=D),D===0)return f[d++]=20971520,f[d++]=20971520,x.bits=1,0;for(F=1;F<D&&V[F]===0;F++);for(J<F&&(J=F),k=$=1;k<=15;k++)if($<<=1,($-=V[k])<0)return-1;if(0<$&&(p===0||D!==1))return-1;for(W[1]=0,k=1;k<15;k++)W[k+1]=W[k]+V[k];for(T=0;T<c;T++)h[u+T]!==0&&(m[W[h[u+T]]++]=T);if(B=p===0?(L=ft=m,19):p===1?(L=n,Y-=257,ft=r,Et-=257,256):(L=a,ft=l,-1),k=F,C=d,rt=T=N=0,z=-1,v=(et=1<<(Z=J))-1,p===1&&852<et||p===2&&592<et)return 1;for(;;){for(A=k-rt,_=m[T]<B?(M=0,m[T]):m[T]>B?(M=ft[Et+m[T]],L[Y+m[T]]):(M=96,0),g=1<<k-rt,F=b=1<<Z;f[C+(N>>rt)+(b-=g)]=A<<24|M<<16|_|0,b!==0;);for(g=1<<k-1;N&g;)g>>=1;if(g!==0?(N&=g-1,N+=g):N=0,T++,--V[k]==0){if(k===D)break;k=h[u+m[T]]}if(J<k&&(N&v)!==z){for(rt===0&&(rt=J),C+=F,$=1<<(Z=k-rt);Z+rt<D&&!(($-=V[Z+rt])<=0);)Z++,$<<=1;if(et+=1<<Z,p===1&&852<et||p===2&&592<et)return 1;f[z=N&v]=J<<24|Z<<16|C-d|0}}return N!==0&&(f[C+N]=k-rt<<24|64<<16|0),x.bits=J,0}},{"../utils/common":41}],51:[function(e,o,i){o.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,o,i){var s=e("../utils/common"),n=0,r=1;function a(E){for(var I=E.length;0<=--I;)E[I]=0}var l=0,p=29,h=256,u=h+1+p,c=30,f=19,d=2*u+1,m=15,x=16,g=7,b=256,z=16,v=17,C=18,B=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],A=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],M=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],_=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],P=new Array(2*(u+2));a(P);var k=new Array(2*c);a(k);var T=new Array(512);a(T);var F=new Array(256);a(F);var D=new Array(p);a(D);var J,Z,rt,$=new Array(c);function et(E,I,G,H,O){this.static_tree=E,this.extra_bits=I,this.extra_base=G,this.elems=H,this.max_length=O,this.has_stree=E&&E.length}function N(E,I){this.dyn_tree=E,this.max_code=0,this.stat_desc=I}function L(E){return E<256?T[E]:T[256+(E>>>7)]}function Y(E,I){E.pending_buf[E.pending++]=255&I,E.pending_buf[E.pending++]=I>>>8&255}function V(E,I,G){E.bi_valid>x-G?(E.bi_buf|=I<<E.bi_valid&65535,Y(E,E.bi_buf),E.bi_buf=I>>x-E.bi_valid,E.bi_valid+=G-x):(E.bi_buf|=I<<E.bi_valid&65535,E.bi_valid+=G)}function W(E,I,G){V(E,G[2*I],G[2*I+1])}function ft(E,I){for(var G=0;G|=1&E,E>>>=1,G<<=1,0<--I;);return G>>>1}function Et(E,I,G){var H,O,q=new Array(m+1),tt=0;for(H=1;H<=m;H++)q[H]=tt=tt+G[H-1]<<1;for(O=0;O<=I;O++){var K=E[2*O+1];K!==0&&(E[2*O]=ft(q[K]++,K))}}function ct(E){var I;for(I=0;I<u;I++)E.dyn_ltree[2*I]=0;for(I=0;I<c;I++)E.dyn_dtree[2*I]=0;for(I=0;I<f;I++)E.bl_tree[2*I]=0;E.dyn_ltree[2*b]=1,E.opt_len=E.static_len=0,E.last_lit=E.matches=0}function yt(E){8<E.bi_valid?Y(E,E.bi_buf):0<E.bi_valid&&(E.pending_buf[E.pending++]=E.bi_buf),E.bi_buf=0,E.bi_valid=0}function wt(E,I,G,H){var O=2*I,q=2*G;return E[O]<E[q]||E[O]===E[q]&&H[I]<=H[G]}function xt(E,I,G){for(var H=E.heap[G],O=G<<1;O<=E.heap_len&&(O<E.heap_len&&wt(I,E.heap[O+1],E.heap[O],E.depth)&&O++,!wt(I,H,E.heap[O],E.depth));)E.heap[G]=E.heap[O],G=O,O<<=1;E.heap[G]=H}function Xt(E,I,G){var H,O,q,tt,K=0;if(E.last_lit!==0)for(;H=E.pending_buf[E.d_buf+2*K]<<8|E.pending_buf[E.d_buf+2*K+1],O=E.pending_buf[E.l_buf+K],K++,H===0?W(E,O,I):(W(E,(q=F[O])+h+1,I),(tt=B[q])!==0&&V(E,O-=D[q],tt),W(E,q=L(--H),G),(tt=A[q])!==0&&V(E,H-=$[q],tt)),K<E.last_lit;);W(E,b,I)}function Qt(E,I){var G,H,O,q=I.dyn_tree,tt=I.stat_desc.static_tree,K=I.stat_desc.has_stree,it=I.stat_desc.elems,dt=-1;for(E.heap_len=0,E.heap_max=d,G=0;G<it;G++)q[2*G]!==0?(E.heap[++E.heap_len]=dt=G,E.depth[G]=0):q[2*G+1]=0;for(;E.heap_len<2;)q[2*(O=E.heap[++E.heap_len]=dt<2?++dt:0)]=1,E.depth[O]=0,E.opt_len--,K&&(E.static_len-=tt[2*O+1]);for(I.max_code=dt,G=E.heap_len>>1;1<=G;G--)xt(E,q,G);for(O=it;G=E.heap[1],E.heap[1]=E.heap[E.heap_len--],xt(E,q,1),H=E.heap[1],E.heap[--E.heap_max]=G,E.heap[--E.heap_max]=H,q[2*O]=q[2*G]+q[2*H],E.depth[O]=(E.depth[G]>=E.depth[H]?E.depth[G]:E.depth[H])+1,q[2*G+1]=q[2*H+1]=O,E.heap[1]=O++,xt(E,q,1),2<=E.heap_len;);E.heap[--E.heap_max]=E.heap[1],(function(pt,Gt){var ro,ne,ao,zt,Bo,Fi,pe=Gt.dyn_tree,Cs=Gt.max_code,mr=Gt.stat_desc.static_tree,xr=Gt.stat_desc.has_stree,gr=Gt.stat_desc.extra_bits,As=Gt.stat_desc.extra_base,lo=Gt.stat_desc.max_length,Co=0;for(zt=0;zt<=m;zt++)pt.bl_count[zt]=0;for(pe[2*pt.heap[pt.heap_max]+1]=0,ro=pt.heap_max+1;ro<d;ro++)lo<(zt=pe[2*pe[2*(ne=pt.heap[ro])+1]+1]+1)&&(zt=lo,Co++),pe[2*ne+1]=zt,Cs<ne||(pt.bl_count[zt]++,Bo=0,As<=ne&&(Bo=gr[ne-As]),Fi=pe[2*ne],pt.opt_len+=Fi*(zt+Bo),xr&&(pt.static_len+=Fi*(mr[2*ne+1]+Bo)));if(Co!==0){do{for(zt=lo-1;pt.bl_count[zt]===0;)zt--;pt.bl_count[zt]--,pt.bl_count[zt+1]+=2,pt.bl_count[lo]--,Co-=2}while(0<Co);for(zt=lo;zt!==0;zt--)for(ne=pt.bl_count[zt];ne!==0;)Cs<(ao=pt.heap[--ro])||(pe[2*ao+1]!==zt&&(pt.opt_len+=(zt-pe[2*ao+1])*pe[2*ao],pe[2*ao+1]=zt),ne--)}})(E,I),Et(q,dt,E.bl_count)}function w(E,I,G){var H,O,q=-1,tt=I[1],K=0,it=7,dt=4;for(tt===0&&(it=138,dt=3),I[2*(G+1)+1]=65535,H=0;H<=G;H++)O=tt,tt=I[2*(H+1)+1],++K<it&&O===tt||(K<dt?E.bl_tree[2*O]+=K:O!==0?(O!==q&&E.bl_tree[2*O]++,E.bl_tree[2*z]++):K<=10?E.bl_tree[2*v]++:E.bl_tree[2*C]++,q=O,dt=(K=0)===tt?(it=138,3):O===tt?(it=6,3):(it=7,4))}function j(E,I,G){var H,O,q=-1,tt=I[1],K=0,it=7,dt=4;for(tt===0&&(it=138,dt=3),H=0;H<=G;H++)if(O=tt,tt=I[2*(H+1)+1],!(++K<it&&O===tt)){if(K<dt)for(;W(E,O,E.bl_tree),--K!=0;);else O!==0?(O!==q&&(W(E,O,E.bl_tree),K--),W(E,z,E.bl_tree),V(E,K-3,2)):K<=10?(W(E,v,E.bl_tree),V(E,K-3,3)):(W(E,C,E.bl_tree),V(E,K-11,7));q=O,dt=(K=0)===tt?(it=138,3):O===tt?(it=6,3):(it=7,4)}}a($);var X=!1;function S(E,I,G,H){V(E,(l<<1)+(H?1:0),3),(function(O,q,tt,K){yt(O),Y(O,tt),Y(O,~tt),s.arraySet(O.pending_buf,O.window,q,tt,O.pending),O.pending+=tt})(E,I,G)}i._tr_init=function(E){X||((function(){var I,G,H,O,q,tt=new Array(m+1);for(O=H=0;O<p-1;O++)for(D[O]=H,I=0;I<1<<B[O];I++)F[H++]=O;for(F[H-1]=O,O=q=0;O<16;O++)for($[O]=q,I=0;I<1<<A[O];I++)T[q++]=O;for(q>>=7;O<c;O++)for($[O]=q<<7,I=0;I<1<<A[O]-7;I++)T[256+q++]=O;for(G=0;G<=m;G++)tt[G]=0;for(I=0;I<=143;)P[2*I+1]=8,I++,tt[8]++;for(;I<=255;)P[2*I+1]=9,I++,tt[9]++;for(;I<=279;)P[2*I+1]=7,I++,tt[7]++;for(;I<=287;)P[2*I+1]=8,I++,tt[8]++;for(Et(P,u+1,tt),I=0;I<c;I++)k[2*I+1]=5,k[2*I]=ft(I,5);J=new et(P,B,h+1,u,m),Z=new et(k,A,0,c,m),rt=new et(new Array(0),M,0,f,g)})(),X=!0),E.l_desc=new N(E.dyn_ltree,J),E.d_desc=new N(E.dyn_dtree,Z),E.bl_desc=new N(E.bl_tree,rt),E.bi_buf=0,E.bi_valid=0,ct(E)},i._tr_stored_block=S,i._tr_flush_block=function(E,I,G,H){var O,q,tt=0;0<E.level?(E.strm.data_type===2&&(E.strm.data_type=(function(K){var it,dt=4093624447;for(it=0;it<=31;it++,dt>>>=1)if(1&dt&&K.dyn_ltree[2*it]!==0)return n;if(K.dyn_ltree[18]!==0||K.dyn_ltree[20]!==0||K.dyn_ltree[26]!==0)return r;for(it=32;it<h;it++)if(K.dyn_ltree[2*it]!==0)return r;return n})(E)),Qt(E,E.l_desc),Qt(E,E.d_desc),tt=(function(K){var it;for(w(K,K.dyn_ltree,K.l_desc.max_code),w(K,K.dyn_dtree,K.d_desc.max_code),Qt(K,K.bl_desc),it=f-1;3<=it&&K.bl_tree[2*_[it]+1]===0;it--);return K.opt_len+=3*(it+1)+5+5+4,it})(E),O=E.opt_len+3+7>>>3,(q=E.static_len+3+7>>>3)<=O&&(O=q)):O=q=G+5,G+4<=O&&I!==-1?S(E,I,G,H):E.strategy===4||q===O?(V(E,2+(H?1:0),3),Xt(E,P,k)):(V(E,4+(H?1:0),3),(function(K,it,dt,pt){var Gt;for(V(K,it-257,5),V(K,dt-1,5),V(K,pt-4,4),Gt=0;Gt<pt;Gt++)V(K,K.bl_tree[2*_[Gt]+1],3);j(K,K.dyn_ltree,it-1),j(K,K.dyn_dtree,dt-1)})(E,E.l_desc.max_code+1,E.d_desc.max_code+1,tt+1),Xt(E,E.dyn_ltree,E.dyn_dtree)),ct(E),H&&yt(E)},i._tr_tally=function(E,I,G){return E.pending_buf[E.d_buf+2*E.last_lit]=I>>>8&255,E.pending_buf[E.d_buf+2*E.last_lit+1]=255&I,E.pending_buf[E.l_buf+E.last_lit]=255&G,E.last_lit++,I===0?E.dyn_ltree[2*G]++:(E.matches++,I--,E.dyn_ltree[2*(F[G]+h+1)]++,E.dyn_dtree[2*L(I)]++),E.last_lit===E.lit_bufsize-1},i._tr_align=function(E){V(E,2,3),W(E,b,P),(function(I){I.bi_valid===16?(Y(I,I.bi_buf),I.bi_buf=0,I.bi_valid=0):8<=I.bi_valid&&(I.pending_buf[I.pending++]=255&I.bi_buf,I.bi_buf>>=8,I.bi_valid-=8)})(E)}},{"../utils/common":41}],53:[function(e,o,i){o.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,o,i){(function(s){(function(n,r){if(!n.setImmediate){var a,l,p,h,u=1,c={},f=!1,d=n.document,m=Object.getPrototypeOf&&Object.getPrototypeOf(n);m=m&&m.setTimeout?m:n,a={}.toString.call(n.process)==="[object process]"?function(z){process.nextTick(function(){g(z)})}:(function(){if(n.postMessage&&!n.importScripts){var z=!0,v=n.onmessage;return n.onmessage=function(){z=!1},n.postMessage("","*"),n.onmessage=v,z}})()?(h="setImmediate$"+Math.random()+"$",n.addEventListener?n.addEventListener("message",b,!1):n.attachEvent("onmessage",b),function(z){n.postMessage(h+z,"*")}):n.MessageChannel?((p=new MessageChannel).port1.onmessage=function(z){g(z.data)},function(z){p.port2.postMessage(z)}):d&&"onreadystatechange"in d.createElement("script")?(l=d.documentElement,function(z){var v=d.createElement("script");v.onreadystatechange=function(){g(z),v.onreadystatechange=null,l.removeChild(v),v=null},l.appendChild(v)}):function(z){setTimeout(g,0,z)},m.setImmediate=function(z){typeof z!="function"&&(z=new Function(""+z));for(var v=new Array(arguments.length-1),C=0;C<v.length;C++)v[C]=arguments[C+1];var B={callback:z,args:v};return c[u]=B,a(u),u++},m.clearImmediate=x}function x(z){delete c[z]}function g(z){if(f)setTimeout(g,0,z);else{var v=c[z];if(v){f=!0;try{(function(C){var B=C.callback,A=C.args;switch(A.length){case 0:B();break;case 1:B(A[0]);break;case 2:B(A[0],A[1]);break;case 3:B(A[0],A[1],A[2]);break;default:B.apply(r,A)}})(v)}finally{x(z),f=!1}}}}function b(z){z.source===n&&typeof z.data=="string"&&z.data.indexOf(h)===0&&g(+z.data.slice(h.length))}})(typeof self>"u"?s===void 0?this:s:self)}).call(this,typeof Ko<"u"?Ko:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Ki)),Ki.exports}var Kp=qp();const Jp=Wp(Kp);class Qp{constructor(){this.context=null,this.analyser=null,this.source=null,this.gainNode=null,this.stream=null,this.fftSize=1024,this.freqData=null,this.timeData=null,this.bands={sub:0,bass:0,mid:0,high:0,presence:0},this.energy=0,this.beat=!1,this.onset=0,this.beatThreshold=1.4,this.beatDecay=.98,this.beatAverage=0,this.beatHoldFrames=0,this.beatHoldMax=8,this.prevEnergy=0,this.onsetDecay=.92,this.gain=1,this.sensitivity=1,this.running=!1}async start(){if(!this.running)try{this.context=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=this.fftSize,this.analyser.smoothingTimeConstant=.8,this.gainNode=this.context.createGain(),this.gainNode.gain.value=this.gain,this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.source=this.context.createMediaStreamSource(this.stream),this.source.connect(this.gainNode),this.gainNode.connect(this.analyser),this.freqData=new Uint8Array(this.analyser.frequencyBinCount),this.timeData=new Uint8Array(this.analyser.fftSize),this.running=!0}catch(t){throw console.warn("AudioReactor: Failed to start mic capture:",t),t}}stop(){this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null),this.source&&(this.source.disconnect(),this.source=null),this.context&&this.context.state!=="closed"&&this.context.close(),this.context=null,this.analyser=null,this.running=!1,this.bands={sub:0,bass:0,mid:0,high:0,presence:0},this.energy=0,this.beat=!1,this.onset=0}setGain(t){this.gain=t,this.gainNode&&(this.gainNode.gain.value=t)}setSensitivity(t){this.sensitivity=Math.max(.1,t)}update(){if(!this.running||!this.analyser)return;this.analyser.getByteFrequencyData(this.freqData),this.analyser.getByteTimeDomainData(this.timeData);const t=this.analyser.frequencyBinCount,o=this.context.sampleRate/2/t;this.bands.sub=this._bandEnergy(20,60,o,t),this.bands.bass=this._bandEnergy(60,250,o,t),this.bands.mid=this._bandEnergy(250,2e3,o,t),this.bands.high=this._bandEnergy(2e3,6e3,o,t),this.bands.presence=this._bandEnergy(6e3,2e4,o,t);for(const r in this.bands)this.bands[r]=Math.min(1,this.bands[r]*this.sensitivity);let i=0;for(let r=0;r<this.timeData.length;r++){const a=(this.timeData[r]-128)/128;i+=a*a}this.energy=Math.min(1,Math.sqrt(i/this.timeData.length)*3*this.sensitivity);const s=(this.bands.sub+this.bands.bass)*.5;this.beatAverage=this.beatAverage*this.beatDecay+s*(1-this.beatDecay),this.beatHoldFrames>0?(this.beatHoldFrames--,this.beat=!0):s>this.beatAverage*this.beatThreshold&&s>.15?(this.beat=!0,this.beatHoldFrames=this.beatHoldMax):this.beat=!1;const n=Math.max(0,this.energy-this.prevEnergy);this.onset=Math.max(this.onset*this.onsetDecay,n*3),this.onset=Math.min(1,this.onset),this.prevEnergy=this.energy}_bandEnergy(t,e,o,i){const s=Math.max(0,Math.floor(t/o)),n=Math.min(i-1,Math.floor(e/o));if(s>=n)return 0;let r=0,a=0;for(let l=s;l<=n;l++)r+=this.freqData[l],a++;return a>0?r/a/255:0}getSource(t){switch(t){case"sub":return this.bands.sub;case"bass":return this.bands.bass;case"mid":return this.bands.mid;case"high":return this.bands.high;case"presence":return this.bands.presence;case"energy":return this.energy;case"beat":return this.beat?1:0;case"onset":return this.onset;default:return 0}}dispose(){this.stop()}}class t0{constructor(){this.mappings=[],this.smoothedValues=new Map,this.triggerStates=new Map}addMapping(t){const e={id:t.id||`map_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,source:t.source||"energy",target:t.target||"",range:t.range||[0,1],smooth:t.smooth??.15,curve:t.curve||"linear",trigger:t.trigger||!1,enabled:t.enabled??!0};return this.mappings.push(e),this.smoothedValues.set(e.id,e.range[0]),e}removeMapping(t){this.mappings=this.mappings.filter(e=>e.id!==t),this.smoothedValues.delete(t)}setMapping(t,e){const o=this.mappings.find(i=>i.id===t);o&&Object.assign(o,e)}update(t,e){const o=new Map;for(const i of this.mappings){if(!i.enabled)continue;const s=t.getSource(i.source);if(i.trigger){const c=this.triggerStates.get(i.id)||!1,f=s>.5;this.triggerStates.set(i.id,f),f&&!c&&o.set(i.target,{value:1,trigger:!0});continue}const n=this._applyCurve(s,i.curve),[r,a]=i.range,l=r+n*(a-r),p=this.smoothedValues.get(i.id)??l,h=1-Math.pow(1-i.smooth,e*60),u=p+(l-p)*h;this.smoothedValues.set(i.id,u),o.set(i.target,{value:u,trigger:!1})}return o}_applyCurve(t,e){switch(e){case"exponential":return t*t;case"step":return t>.5?1:0;case"sqrt":return Math.sqrt(t);case"linear":default:return t}}loadPreset(t){this.mappings=[],this.smoothedValues.clear(),this.triggerStates.clear();const o=this._getPresets()[t];if(o)for(const i of o)this.addMapping(i)}savePreset(t){const e=`vj_preset_${t}`;localStorage.setItem(e,JSON.stringify(this.mappings))}loadCustomPreset(t){const e=`vj_preset_${t}`,o=localStorage.getItem(e);if(!o)return!1;this.mappings=[],this.smoothedValues.clear(),this.triggerStates.clear();const i=JSON.parse(o);for(const s of i)this.addMapping(s);return!0}_getPresets(){return{chill:[{source:"bass",target:"shader.thickness",range:[1,3],smooth:.08,curve:"sqrt"},{source:"energy",target:"emissive.intensity",range:[.5,2],smooth:.1},{source:"energy",target:"camera.orbitSpeed",range:[.3,1.5],smooth:.05},{source:"bass",target:"mesh.vertexDistort",range:[0,.08],smooth:.06},{source:"mid",target:"shader.chromatic",range:[0,.002],smooth:.08},{source:"high",target:"shader.vignette",range:[0,.4],smooth:.1},{source:"energy",target:"bloom.strength",range:[.2,.7],smooth:.08}],hard:[{source:"bass",target:"shader.thickness",range:[1,6],smooth:.25,curve:"exponential"},{source:"energy",target:"emissive.intensity",range:[.5,4],smooth:.3},{source:"onset",target:"camera.shake",range:[0,.5],smooth:.05},{source:"energy",target:"camera.orbitSpeed",range:[.5,4],smooth:.2},{source:"bass",target:"mesh.vertexDistort",range:[0,.2],smooth:.2},{source:"bass",target:"mesh.blockBounce",range:[0,.5],smooth:.15},{source:"mid",target:"shader.chromatic",range:[0,.008],smooth:.15},{source:"beat",target:"shader.fills",range:[0,1],trigger:!0},{source:"high",target:"shader.vignette",range:[0,1],smooth:.2},{source:"energy",target:"bloom.strength",range:[.3,1.5],smooth:.2}],psychedelic:[{source:"bass",target:"shader.thickness",range:[1,8],smooth:.2,curve:"exponential"},{source:"energy",target:"emissive.intensity",range:[1,5],smooth:.25},{source:"onset",target:"camera.shake",range:[0,.4],smooth:.05},{source:"energy",target:"camera.orbitSpeed",range:[1,5],smooth:.15},{source:"bass",target:"mesh.vertexDistort",range:[0,.25],smooth:.15},{source:"bass",target:"mesh.blockBounce",range:[0,.6],smooth:.12},{source:"mid",target:"shader.chromatic",range:[0,.012],smooth:.12},{source:"beat",target:"shader.fills",range:[0,1],trigger:!0},{source:"high",target:"shader.vignette",range:[0,1.2],smooth:.15},{source:"energy",target:"bloom.strength",range:[.5,2],smooth:.15},{source:"mid",target:"shader.hueShift",range:[0,1],smooth:.05},{source:"onset",target:"shader.glitch",range:[0,.5],smooth:.03},{source:"energy",target:"shader.feedback",range:[0,.7],smooth:.1}]}}setReactivity(t){for(const e of this.mappings)e.smooth=Math.min(.5,e.smooth*t)}dispose(){this.mappings=[],this.smoothedValues.clear(),this.triggerStates.clear()}}class e0{constructor(t,e){this.engine=t,this.camera=t.camera,this.controls=t.controls,this.bookmarks=e,this.mode="orbit",this.enabled=!1,this.time=0,this.shake=0,this.orbitSpeed=1,this.zoomPulse=0,this.fovTarget=60,this.baseDistance=0,this.baseFov=60,this.shakeOffset=new U,this.driftTarget=new U(10,10,10),this.driftLookAt=new U(0,0,0),this.driftTimer=0,this.driftDuration=5,this.railProgress=0,this.railSpeed=.1,this.chaosTimer=0,this.chaosInterval=2}setMode(t){this.mode=t,this.baseDistance=this.camera.position.distanceTo(this.controls.target),this.baseFov=this.camera.fov,t==="orbit"?this.controls.autoRotate=!0:this.controls.autoRotate=!1,t==="drift"&&this._pickDriftTarget()}setEnabled(t){this.enabled=t,t||(this.controls.autoRotate=!1,this.camera.fov=this.baseFov,this.camera.updateProjectionMatrix())}update(t,e){if(this.enabled)switch(this.time+=e,this._applyShake(e),this._applyFOVBreathing(t,e),this._applyZoomPulse(t,e),this.mode){case"orbit":this._updateOrbit(t,e);break;case"drift":this._updateDrift(t,e);break;case"lock":break;case"rail":this._updateRail(t,e);break;case"chaos":this._updateChaos(t,e);break}}_applyShake(t){this.shake<.001||(this.shakeOffset.set((Math.random()-.5)*this.shake,(Math.random()-.5)*this.shake,(Math.random()-.5)*this.shake),this.camera.position.add(this.shakeOffset))}_applyFOVBreathing(t,e){const o=55+t.bands.bass*20;this.camera.fov+=(o-this.camera.fov)*e*3,this.camera.updateProjectionMatrix()}_applyZoomPulse(t,e){if(!t.beat)return;const o=new U().subVectors(this.controls.target,this.camera.position).normalize();this.camera.position.addScaledVector(o,.3)}_updateOrbit(t,e){this.controls.autoRotateSpeed=this.orbitSpeed*2,this.controls.update()}_updateDrift(t,e){this.driftTimer+=e,this.driftTimer>=this.driftDuration&&(this._pickDriftTarget(),this.driftTimer=0);const o=e*.8;this.camera.position.lerp(this.driftTarget,o),this.controls.target.lerp(this.driftLookAt,o),this.controls.update()}_pickDriftTarget(){const t=this.bookmarks?Array.from(this.bookmarks.bookmarks.values()):[];if(t.length>1){const e=t[Math.floor(Math.random()*t.length)];this.driftTarget.set(e.position.x,e.position.y,e.position.z),this.driftLookAt.set(e.target.x,e.target.y,e.target.z)}else{const e=Math.random()*Math.PI*2,o=8+Math.random()*12,i=3+Math.random()*10;this.driftTarget.set(Math.cos(e)*o,i,Math.sin(e)*o),this.driftLookAt.set(0,2,0)}this.driftDuration=3+Math.random()*5}_updateRail(t,e){const o=this.bookmarks?Array.from(this.bookmarks.bookmarks.values()):[];if(o.length<2)return;this.railProgress+=e*this.railSpeed*(.5+t.energy),this.railProgress>=o.length-1&&(this.railProgress=0);const i=Math.floor(this.railProgress),s=this.railProgress-i,n=o[i],r=o[Math.min(i+1,o.length-1)],a=s*s*(3-2*s);this.camera.position.set(n.position.x+(r.position.x-n.position.x)*a,n.position.y+(r.position.y-n.position.y)*a,n.position.z+(r.position.z-n.position.z)*a),this.controls.target.set(n.target.x+(r.target.x-n.target.x)*a,n.target.y+(r.target.y-n.target.y)*a,n.target.z+(r.target.z-n.target.z)*a),this.controls.update()}_updateChaos(t,e){if(this.chaosTimer+=e,t.beat||this.chaosTimer>=this.chaosInterval){this.chaosTimer=0;const o=Math.random()*Math.PI*2,i=5+Math.random()*15,s=2+Math.random()*12;this.camera.position.set(Math.cos(o)*i,s,Math.sin(o)*i),this.camera.lookAt(0,2,0),this.controls.target.set(0,2,0),this.controls.update()}}dispose(){this.setEnabled(!1)}}const Zn=new ot,Vt={h:0,s:0,l:0};class o0{constructor(t,e){this.blockManager=t,this.engine=e,this.enabled=!1,this.time=0,this.blockDistortion=.5,this.vertexDistortion=.5,this.colorReactivity=.5,this.movementMode="bounce",this.originalState=new Map,this.lastBeat=!1,this.beatTime=0,this.vertexUniforms={uBass:{value:0},uEnergy:{value:0},uTime:{value:0},uDistortAmount:{value:0}},this.patchedMaterials=new WeakSet}setEnabled(t){this.enabled=t,t?(this._captureOriginalState(),this._patchExistingMaterials()):this._restoreOriginalState()}setBlockDistortion(t){this.blockDistortion=t}setVertexDistortion(t){this.vertexDistortion=t}setColorReactivity(t){this.colorReactivity=t}setMovementMode(t){this.movementMode=t;for(const[e,o]of this.originalState)o.impulseY=0,o.velX=0,o.velZ=0,o.pushX=0,o.pushZ=0,o.rotImpulse=0}update(t,e){if(!this.enabled)return;this.time+=e;const o=t.beat;o&&!this.lastBeat&&(this.beatTime=this.time),this.lastBeat=o,this.vertexUniforms.uBass.value=t.bands.bass,this.vertexUniforms.uEnergy.value=t.energy,this.vertexUniforms.uTime.value=this.time,this.vertexUniforms.uDistortAmount.value=this.vertexDistortion,this.blockDistortion>.01&&this._updateBlocks(t,e),this.colorReactivity>.01&&this._updateBlockColors(t,e),this.vertexDistortion>.01&&this._patchNewMaterials()}_captureOriginalState(){this.originalState.clear();const t=this.blockManager.getAllBlocks();for(const e of t)this._captureBlock(e)}_captureBlock(t){const o=(Array.isArray(t.mesh.material)?t.mesh.material:[t.mesh.material]).map(i=>i.color.getHex());this.originalState.set(t.id,{y:t.mesh.position.y,x:t.mesh.position.x,z:t.mesh.position.z,scaleX:t.mesh.scale.x,scaleY:t.mesh.scale.y,scaleZ:t.mesh.scale.z,rotY:t.mesh.rotation.y,colors:o,impulseY:0,velX:0,velZ:0,pushX:0,pushZ:0,rotImpulse:0})}_restoreOriginalState(){const t=this.blockManager.getAllBlocks();for(const e of t){const o=this.originalState.get(e.id);if(o){e.mesh.position.set(o.x,o.y,o.z),e.mesh.scale.set(o.scaleX,o.scaleY,o.scaleZ),e.mesh.rotation.y=o.rotY;const i=Array.isArray(e.mesh.material)?e.mesh.material:[e.mesh.material];for(let s=0;s<i.length;s++)o.colors[s]!==void 0&&i[s].color.setHex(o.colors[s])}}this.originalState.clear()}_updateBlocks(t,e){const o=this.blockManager.getAllBlocks(),i=t.bands.bass,s=t.energy,n=t.onset;t.beat&&this.lastBeat;const r=this.blockDistortion;for(const a of o){let l=this.originalState.get(a.id);if(!l){this._captureBlock(a);continue}switch(this.movementMode){case"bounce":this._moveBounce(a,l,i,s,r);break;case"jump":this._moveJump(a,l,i,s,n,r,e);break;case"wave":this._moveWave(a,l,i,s,r);break;case"scatter":this._moveScatter(a,l,i,s,n,r,e);break}const p=1+s*r*.25,h=1+i*r*.4;if(a.mesh.scale.set(l.scaleX*p,l.scaleY*h,l.scaleZ*p),a.emissive&&a.emissive.enabled){const u=Array.isArray(a.mesh.material)?a.mesh.material:[a.mesh.material];for(const c of u)c.emissiveIntensity=a.emissive.intensity*(1+n*r*4)}}}_moveBounce(t,e,o,i,s){const n=t.gridPosition.x*.7+t.gridPosition.z*.5+this.time*3,r=Math.sin(n)*o*s*1.5;t.mesh.position.y=e.y+r;const a=t.gridPosition.x*.5-t.gridPosition.z*.3+this.time*2;t.mesh.position.x=e.x+Math.sin(a)*i*s*.3,t.mesh.position.z=e.z+Math.cos(a*.7)*i*s*.3}_moveJump(t,e,o,i,s,n,r){if(s>.2){const a=(t.gridPosition.x*.3+t.gridPosition.z*.2)%1;Math.random()<s*.6+(1-a)*.3&&(e.impulseY=Math.max(e.impulseY,s*n*3.5))}e.impulseY*=.85,t.mesh.position.y=e.y+e.impulseY,t.mesh.position.x=e.x+(Math.random()-.5)*o*n*.4,t.mesh.position.z=e.z+(Math.random()-.5)*o*n*.4,s>.25&&(e.rotImpulse+=s*n*.6),e.rotImpulse*=.88,t.mesh.rotation.y=e.rotY+e.rotImpulse}_moveWave(t,e,o,i,s){const n=t.gridPosition.x,r=t.gridPosition.z,a=Math.sqrt(n*n+r*r),l=a*.1,p=this.time-this.beatTime,h=(p-l)*6,u=Math.max(0,1-p*.5),c=Math.sin(h)*u*o*s*2.5;if(t.mesh.position.y=e.y+(p>l?c:0),p>l&&u>.1){const f=a>.1?1/a:0,d=Math.sin(h)*u*s*.4;t.mesh.position.x=e.x+n*f*d,t.mesh.position.z=e.z+r*f*d}}_moveScatter(t,e,o,i,s,n,r){const a=t.gridPosition.x,l=t.gridPosition.z,p=Math.max(.5,Math.sqrt(a*a+l*l));if(s>.2){const f=s*n*1.5;e.velX+=a/p*f,e.velZ+=l/p*f}const h=5,u=3;e.velX+=-e.pushX*h*r,e.velZ+=-e.pushZ*h*r,e.velX*=Math.max(0,1-u*r),e.velZ*=Math.max(0,1-u*r),e.pushX+=e.velX*r,e.pushZ+=e.velZ*r,t.mesh.position.x=e.x+e.pushX,t.mesh.position.z=e.z+e.pushZ;const c=o*n*1.2;t.mesh.position.y=e.y+c,t.mesh.rotation.y=e.rotY+e.pushX*.3}_updateBlockColors(t,e){const o=this.blockManager.getAllBlocks(),i=t.bands.mid,s=t.energy,n=t.bands.bass,r=t.bands.high,a=this.colorReactivity;for(const l of o){let p=this.originalState.get(l.id);if(!p&&(this._captureBlock(l),p=this.originalState.get(l.id),!p))continue;const h=Array.isArray(l.mesh.material)?l.mesh.material:[l.mesh.material],u=l.gridPosition.x*.4+l.gridPosition.z*.3+l.gridPosition.y*.2;for(let c=0;c<h.length;c++)p.colors[c]!==void 0&&(Zn.setHex(p.colors[c]),Zn.getHSL(Vt),Vt.h=(Vt.h+i*a*.3+Math.sin(this.time*.5+u)*a*.1)%1,Vt.h<0&&(Vt.h+=1),Vt.s=Math.min(1,Vt.s+s*a*.2),Vt.l=Math.min(.9,Math.max(.1,Vt.l+n*a*.15-r*a*.05)),h[c].color.setHSL(Vt.h,Vt.s,Vt.l))}}_patchExistingMaterials(){const t=this.blockManager.getAllBlocks();for(const e of t)this._patchBlockMaterial(e)}_patchNewMaterials(){const t=this.blockManager.getAllBlocks();for(const e of t){const o=Array.isArray(e.mesh.material)?e.mesh.material:[e.mesh.material];for(const i of o)this.patchedMaterials.has(i)||this._patchMaterial(i)}}_patchBlockMaterial(t){const e=Array.isArray(t.mesh.material)?t.mesh.material:[t.mesh.material];for(const o of e)this._patchMaterial(o)}_patchMaterial(t){if(this.patchedMaterials.has(t))return;this.patchedMaterials.add(t);const e=this.vertexUniforms;t.onBeforeCompile=o=>{o.uniforms.uBass=e.uBass,o.uniforms.uEnergy=e.uEnergy,o.uniforms.uTime=e.uTime,o.uniforms.uDistortAmount=e.uDistortAmount,o.vertexShader=o.vertexShader.replace("#include <common>",`#include <common>
        uniform float uBass;
        uniform float uEnergy;
        uniform float uTime;
        uniform float uDistortAmount;

        // Simplex-style hash noise
        vec3 mod289(vec3 x) { return x - floor(x * (1.0/289.0)) * 289.0; }
        vec4 mod289(vec4 x) { return x - floor(x * (1.0/289.0)) * 289.0; }
        vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
        vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }
        float snoise(vec3 v) {
          const vec2 C = vec2(1.0/6.0, 1.0/3.0);
          const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);
          vec3 i = floor(v + dot(v, C.yyy));
          vec3 x0 = v - i + dot(i, C.xxx);
          vec3 g = step(x0.yzx, x0.xyz);
          vec3 l = 1.0 - g;
          vec3 i1 = min(g.xyz, l.zxy);
          vec3 i2 = max(g.xyz, l.zxy);
          vec3 x1 = x0 - i1 + C.xxx;
          vec3 x2 = x0 - i2 + C.yyy;
          vec3 x3 = x0 - D.yyy;
          i = mod289(i);
          vec4 p = permute(permute(permute(
            i.z + vec4(0.0, i1.z, i2.z, 1.0))
            + i.y + vec4(0.0, i1.y, i2.y, 1.0))
            + i.x + vec4(0.0, i1.x, i2.x, 1.0));
          float n_ = 0.142857142857;
          vec3 ns = n_ * D.wyz - D.xzx;
          vec4 j = p - 49.0 * floor(p * ns.z * ns.z);
          vec4 x_ = floor(j * ns.z);
          vec4 y_ = floor(j - 7.0 * x_);
          vec4 x = x_ * ns.x + ns.yyyy;
          vec4 y = y_ * ns.x + ns.yyyy;
          vec4 h = 1.0 - abs(x) - abs(y);
          vec4 b0 = vec4(x.xy, y.xy);
          vec4 b1 = vec4(x.zw, y.zw);
          vec4 s0 = floor(b0) * 2.0 + 1.0;
          vec4 s1 = floor(b1) * 2.0 + 1.0;
          vec4 sh = -step(h, vec4(0.0));
          vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy;
          vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww;
          vec3 p0 = vec3(a0.xy, h.x);
          vec3 p1 = vec3(a0.zw, h.y);
          vec3 p2 = vec3(a1.xy, h.z);
          vec3 p3 = vec3(a1.zw, h.w);
          vec4 norm = taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));
          p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w;
          vec4 m = max(0.6 - vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)), 0.0);
          m = m * m;
          return 42.0 * dot(m*m, vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));
        }
        `),o.vertexShader=o.vertexShader.replace("#include <begin_vertex>",`#include <begin_vertex>
        if (uDistortAmount > 0.001) {
          // Radial breathing on bass
          float breath = sin(uTime * 2.0) * uBass * uDistortAmount * 0.5;
          transformed *= 1.0 + breath;

          // Noise displacement along normal
          float noise = snoise(transformed * 2.0 + uTime * 0.5);
          transformed += normal * noise * uBass * uDistortAmount * 0.6;

          // Energy-driven expansion
          transformed *= 1.0 + uEnergy * uDistortAmount * 0.15;
        }
        `)},t.needsUpdate=!0}dispose(){this.enabled&&this._restoreOriginalState(),this.enabled=!1,this.patchedMaterials=new WeakSet}}class i0{constructor(t){this.scene=t,this.enabled=!1,this.poolSize=64,this.pool=[],this.active=[],this.geometry=new bi(1,1,1),this.sceneCenter=new U(0,2,0),this.sceneRadius=8,this._built=!1}setEnabled(t){this.enabled=t,t&&!this._built&&this._buildPool(),t||this._returnAll()}setPoolSize(t){t===this.poolSize&&this._built||(this._dispose(),this.poolSize=t,this.enabled&&this._buildPool())}updateSceneBounds(t){const e=t.getAllBlocks();if(e.length===0)return;let o=1/0,i=-1/0,s=1/0,n=-1/0,r=1/0,a=-1/0;for(const l of e){const p=l.gridPosition;o=Math.min(o,p.x),i=Math.max(i,p.x),s=Math.min(s,p.y),n=Math.max(n,p.y),r=Math.min(r,p.z),a=Math.max(a,p.z)}this.sceneCenter.set((o+i)/2,(s+n)/2+1,(r+a)/2),this.sceneRadius=Math.max(3,Math.sqrt(Math.pow(i-o,2)+Math.pow(a-r,2))/2+2)}spawn(t,e){if(!this.enabled||this.pool.length===0)return;const o=this.pool.pop();o.visible=!0;const i=Math.random()*Math.PI*2,s=Math.random()*this.sceneRadius;o.position.set(this.sceneCenter.x+Math.cos(i)*s,this.sceneCenter.y+Math.random()*3,this.sceneCenter.z+Math.sin(i)*s);const n=.3+t*.7;o.scale.set(.01,.01,.01),o.material.color.setHex(e||this._randomColor()),o.material.opacity=.9,o.userData.life=0,o.userData.maxLife=.8+Math.random()*.8,o.userData.targetScale=n,o.userData.velocityY=1.5+t*2,o.userData.rotSpeed=(Math.random()-.5)*4,this.active.push(o)}update(t){if(this.enabled)for(let e=this.active.length-1;e>=0;e--){const o=this.active[e],i=o.userData;i.life+=t;const s=i.life/i.maxLife;if(s>=1){o.visible=!1,this.pool.push(o),this.active.splice(e,1);continue}const n=s<.2?s/.2:1-(s-.2)/.8,r=i.targetScale*n;o.scale.set(r,r,r),o.position.y+=i.velocityY*t*(1-s*.5),o.rotation.y+=i.rotSpeed*t,o.rotation.x+=i.rotSpeed*.5*t,o.material.opacity=Math.max(0,.9*(1-s))}}_buildPool(){this._dispose();for(let t=0;t<this.poolSize;t++){const e=new kt({roughness:.6,metalness:.2,transparent:!0,opacity:0}),o=new Dt(this.geometry,e);o.visible=!1,this.scene.add(o),this.pool.push(o)}this._built=!0}_returnAll(){for(const t of this.active)t.visible=!1,this.pool.push(t);this.active.length=0}_randomColor(){const t=Math.random(),e=new ot;return e.setHSL(t,.8,.6),e.getHex()}_dispose(){for(const t of[...this.pool,...this.active])this.scene.remove(t),t.material.dispose();this.pool.length=0,this.active.length=0,this._built=!1}dispose(){this._dispose(),this.geometry.dispose()}}class s0{constructor(){this.scenes=[],this.currentIndex=-1,this.onSceneChange=null}get count(){return this.scenes.length}get currentName(){return this.currentIndex>=0&&this.currentIndex<this.scenes.length?this.scenes[this.currentIndex].name:null}async loadFolder(t){this.scenes=[],this.currentIndex=-1;const e=Array.from(t).filter(o=>o.name.endsWith(".blocks"));e.sort((o,i)=>o.name.localeCompare(i.name));for(const o of e)try{const i=await o.text(),s=JSON.parse(i);s.blocks&&Array.isArray(s.blocks)&&this.scenes.push({name:o.name.replace(".blocks",""),data:s})}catch(i){console.warn(`SceneBank: skipped invalid file ${o.name}:`,i.message)}return this.scenes.length}switchTo(t,e,o){if(this.scenes.length===0)return!1;t=(t%this.scenes.length+this.scenes.length)%this.scenes.length;const i=this.scenes[t];this.currentIndex=t;const s=e.getAllBlocks();for(const n of[...s])e.removeBlock(n.id);return e.fromJSON(i.data.blocks),o&&i.data.layers&&o.fromJSON(i.data.layers),this.onSceneChange&&this.onSceneChange(t,i.name,this.scenes.length),!0}next(t,e){return this.switchTo(this.currentIndex+1,t,e)}previous(t,e){return this.switchTo(this.currentIndex-1,t,e)}random(t,e){if(this.scenes.length<=1)return this.switchTo(0,t,e);let o;do o=Math.floor(Math.random()*this.scenes.length);while(o===this.currentIndex);return this.switchTo(o,t,e)}}const ze=512,Ht=new Rt,te=new U,ee=new U,re=new Ne,ve=new ot;class n0{constructor(t){this.scene=t,this.enabled=!1,this.count=0,this.maxInstances=ze,this.headIndex=0,this.instanceData=new Array(ze);for(let e=0;e<ze;e++)this.instanceData[e]={birthTime:0,ttl:0,alive:!1,baseY:0};this.cursors=[],this.maxCursors=8,this.growthRate=3,this.branchProb=.25,this.ttl=20,this.blockScale=1,this.verticalBias=.7,this.time=0,this.lastBeat=!1,this.mesh=null,this._built=!1}setEnabled(t){this.enabled=t,t&&!this._built&&this._build(),t&&this._resetCursors(),this.mesh&&(this.mesh.visible=t)}setMaxInstances(t){t===this.maxInstances&&this._built||(this.maxInstances=Math.min(t,ze))}setTTL(t){this.ttl=t}setGrowthRate(t){this.growthRate=t}initFromScene(t){const e=t.getAllBlocks();if(e.length===0){this._resetCursors();return}const o=new Map;for(const s of e){const n=`${s.gridPosition.x},${s.gridPosition.z}`,r=o.get(n);(!r||s.gridPosition.y>r.gridPosition.y)&&o.set(n,s)}const i=Array.from(o.values()).sort((s,n)=>n.gridPosition.y-s.gridPosition.y).slice(0,this.maxCursors);for(this.cursors=i.map(s=>({x:s.gridPosition.x,y:s.gridPosition.y+1,z:s.gridPosition.z,direction:"up",energy:1}));this.cursors.length<3;)this.cursors.push({x:Math.floor(Math.random()*6-3),y:0,z:Math.floor(Math.random()*6-3),direction:"up",energy:1})}update(t,e){if(!this.enabled||!this.mesh)return;this.time+=e;const o=t.beat&&!this.lastBeat;this.lastBeat=t.beat,o&&this._grow(t),this._animate(t,e),this._expire(),this.mesh.instanceMatrix.needsUpdate=!0,this.mesh.instanceColor.needsUpdate=!0}_grow(t){const e=t.bands.bass,o=t.bands.mid,i=t.bands.high,s=t.energy,n=t.onset,r=Math.min(Math.ceil(s*this.growthRate),this.growthRate);for(let a=0;a<r&&this.cursors.length!==0;a++){const l=Math.floor(Math.random()*this.cursors.length),p=this.cursors[l];this._placeInstance(p.x,p.y,p.z,t),this._advanceCursor(p,e,o,i,n),o>.3&&Math.random()<this.branchProb*o&&this._branchCursor(p,o),n>.5&&this.cursors.length<this.maxCursors&&Math.random()<.4&&this.cursors.push({x:p.x+Math.floor(Math.random()*5-2),y:0,z:p.z+Math.floor(Math.random()*5-2),direction:"up",energy:n})}this.cursors=this.cursors.filter(a=>a.y<30&&Math.abs(a.x)<20&&Math.abs(a.z)<20),this.cursors.length===0&&this._resetCursors()}_advanceCursor(t,e,o,i,s){if(Math.random()<this.verticalBias*(.5+e*.5))t.y+=1;else switch(Math.floor(Math.random()*4)){case 0:t.x+=1;break;case 1:t.x-=1;break;case 2:t.z+=1;break;case 3:t.z-=1;break}}_branchCursor(t,e){if(this.cursors.length>=this.maxCursors)return;const o=Math.floor(Math.random()*4),i={x:t.x,y:t.y,z:t.z,direction:"side",energy:e};switch(o){case 0:i.x+=1;break;case 1:i.x-=1;break;case 2:i.z+=1;break;case 3:i.z-=1;break}this.cursors.push(i)}_placeInstance(t,e,o,i){const s=this.headIndex;this.headIndex=(this.headIndex+1)%this.maxInstances,this.count<this.maxInstances&&this.count++;const n=i.bands.high,r=this.blockScale*(.6+(1-n)*.6);te.set(t,e,o),ee.set(r,r,r),re.identity(),Ht.compose(te,re,ee),this.mesh.setMatrixAt(s,Ht);const a=(i.bands.bass*.3+i.bands.mid*.4+this.time*.02)%1,l=.5+i.energy*.4,p=.35+i.bands.bass*.25;ve.setHSL(a,l,p),this.mesh.setColorAt(s,ve),this.instanceData[s].birthTime=this.time,this.instanceData[s].ttl=this.ttl,this.instanceData[s].alive=!0,this.instanceData[s].baseY=e,this.mesh.count=this.count}_animate(t,e){const o=t.bands.bass,i=t.energy;for(let s=0;s<this.maxInstances;s++){const n=this.instanceData[s];if(!n.alive)continue;const r=this.time-n.birthTime,a=Math.min(1,r/n.ttl);this.mesh.getMatrixAt(s,Ht),Ht.decompose(te,re,ee),te.y=n.baseY+r*.15;const l=1+Math.sin(this.time*3+s*.5)*o*.3,p=a>.7?(1-a)/.3:1,h=Math.min(1,r*4),u=this.blockScale*l*p*h;ee.set(u,u,u),Ht.compose(te,re,ee),this.mesh.setMatrixAt(s,Ht),this.mesh.getColorAt(s,ve);const c={};ve.getHSL(c),c.h=(c.h+e*.05)%1,c.l=Math.max(.1,c.l*(.99+i*.01)),ve.setHSL(c.h,c.s,c.l),this.mesh.setColorAt(s,ve)}}_expire(){for(let t=0;t<this.maxInstances;t++){const e=this.instanceData[t];e.alive&&this.time-e.birthTime>e.ttl&&(e.alive=!1,ee.set(0,0,0),te.set(0,-100,0),re.identity(),Ht.compose(te,re,ee),this.mesh.setMatrixAt(t,Ht))}}_resetCursors(){this.cursors=[];for(let t=0;t<3;t++)this.cursors.push({x:Math.floor(Math.random()*4-2),y:0,z:Math.floor(Math.random()*4-2),direction:"up",energy:1})}_build(){if(this._built)return;const t=new bi(.95,.95,.95),e=new kt({roughness:.5,metalness:.3});this.mesh=new Gn(t,e,ze),this.mesh.count=0,this.mesh.instanceColor=new $n(new Float32Array(ze*3),3),this.mesh.frustumCulled=!1,this.mesh.visible=!1;for(let o=0;o<ze;o++)te.set(0,-100,0),ee.set(0,0,0),re.identity(),Ht.compose(te,re,ee),this.mesh.setMatrixAt(o,Ht),ve.set(0,0,0),this.mesh.setColorAt(o,ve);this.scene.add(this.mesh),this._built=!0}clear(){this.count=0,this.headIndex=0;for(let t=0;t<ze;t++)this.instanceData[t].alive=!1,te.set(0,-100,0),ee.set(0,0,0),re.identity(),Ht.compose(te,re,ee),this.mesh&&this.mesh.setMatrixAt(t,Ht);this.mesh&&(this.mesh.count=0,this.mesh.instanceMatrix.needsUpdate=!0),this._resetCursors()}dispose(){this.mesh&&(this.scene.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.mesh=null),this._built=!1}}const r0={uniforms:{tDiffuse:{value:null},uAmount:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uAmount;
    varying vec2 vUv;

    void main() {
      vec2 dir = vUv - 0.5;
      float dist = length(dir);
      vec2 offset = dir * uAmount * dist;

      float r = texture2D(tDiffuse, vUv + offset).r;
      float g = texture2D(tDiffuse, vUv).g;
      float b = texture2D(tDiffuse, vUv - offset).b;

      gl_FragColor = vec4(r, g, b, 1.0);
    }
  `},a0={uniforms:{tDiffuse:{value:null},uGlitch:{value:0},uTime:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uGlitch;
    uniform float uTime;
    varying vec2 vUv;

    float hash(float n) {
      return fract(sin(n) * 43758.5453);
    }

    void main() {
      vec2 uv = vUv;

      if (uGlitch > 0.01) {
        // Horizontal slice displacement
        float sliceY = floor(uv.y * 20.0) / 20.0;
        float sliceRand = hash(sliceY + floor(uTime * 10.0));

        if (sliceRand > 1.0 - uGlitch) {
          uv.x += (hash(sliceY + uTime) - 0.5) * uGlitch * 0.3;
        }

        // Color channel split on glitch
        float shift = uGlitch * 0.01 * hash(uTime);
        float r = texture2D(tDiffuse, uv + vec2(shift, 0.0)).r;
        float g = texture2D(tDiffuse, uv).g;
        float b = texture2D(tDiffuse, uv - vec2(shift, 0.0)).b;
        gl_FragColor = vec4(r, g, b, 1.0);
      } else {
        gl_FragColor = texture2D(tDiffuse, uv);
      }
    }
  `},l0={uniforms:{tDiffuse:{value:null},uShift:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uShift;
    varying vec2 vUv;

    vec3 rgb2hsv(vec3 c) {
      vec4 K = vec4(0.0, -1.0/3.0, 2.0/3.0, -1.0);
      vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
      vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
      float d = q.x - min(q.w, q.y);
      float e = 1.0e-10;
      return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
    }

    vec3 hsv2rgb(vec3 c) {
      vec4 K = vec4(1.0, 2.0/3.0, 1.0/3.0, 3.0);
      vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
      return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
    }

    void main() {
      vec4 color = texture2D(tDiffuse, vUv);

      if (uShift > 0.001) {
        vec3 hsv = rgb2hsv(color.rgb);
        hsv.x = fract(hsv.x + uShift);
        color.rgb = hsv2rgb(hsv);
      }

      gl_FragColor = color;
    }
  `},c0={uniforms:{tDiffuse:{value:null},uIntensity:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uIntensity;
    varying vec2 vUv;

    void main() {
      vec4 color = texture2D(tDiffuse, vUv);
      float dist = length(vUv - 0.5) * 1.414; // 0 at center, ~1 at corners
      float vignette = 1.0 - dist * dist * uIntensity;
      color.rgb *= max(0.0, vignette);
      gl_FragColor = color;
    }
  `},p0={uniforms:{tDiffuse:{value:null},tPrevFrame:{value:null},uFeedback:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform sampler2D tPrevFrame;
    uniform float uFeedback;
    varying vec2 vUv;

    void main() {
      vec4 current = texture2D(tDiffuse, vUv);
      vec4 prev = texture2D(tPrevFrame, vUv);

      // Blend current frame with previous for motion trail effect
      gl_FragColor = mix(current, prev, uFeedback);
    }
  `};class h0{constructor(t,e,o,i){this.engine=t,this.blockManager=e,this.gpuRenderer=o,this.cameraBookmarks=i,this.audioReactor=new Qp,this.parameterBus=new t0,this.cameraModes=new e0(t,i),this.meshReactor=new o0(e,t),this.particleSpawner=new i0(t.scene),this.sceneBank=new s0,this.audioGenerative=new n0(t.scene),this.vjPasses={},this.vjPassesActive=!1,this.feedbackTargetA=null,this.feedbackTargetB=null,this.feedbackFlip=!1,this.active=!1,this.performanceMode=!1,this.currentPreset="hard",this.styles=["clean","sketch","ink","crosshatch","blueprint","comic","saturated","neon","scifi","watercolor","noir","synthwave","ascii"],this.currentStyleIndex=0,this.cameraModeNames=["orbit","drift","lock","rail","chaos"],this.currentCameraModeIndex=0,this.fillsOn=!0,this.reactivity=1,this._keyHandler=s=>this._handleKeyboard(s),this._layerManager=null,this.onStateChange=null}async start(){if(!this.active){try{await this.audioReactor.start()}catch(t){throw console.warn("VJController: Audio start failed:",t),t}this.parameterBus.loadPreset(this.currentPreset),this.gpuRenderer.enabled||this.gpuRenderer.setEnabled(!0),this._setupVJPasses(),this.cameraModes.setMode("orbit"),this.cameraModes.setEnabled(!0),this.meshReactor.setEnabled(!0),this.particleSpawner.updateSceneBounds(this.blockManager),this.engine.onVJUpdate=t=>this.update(t),window.addEventListener("keydown",this._keyHandler),this.active=!0,this.onStateChange&&this.onStateChange(!0)}}stop(){this.active&&(this.engine.onVJUpdate=null,this.audioReactor.stop(),this.cameraModes.setEnabled(!1),this.meshReactor.setEnabled(!1),this.particleSpawner.setEnabled(!1),this.audioGenerative.setEnabled(!1),this._removeVJPasses(),this.performanceMode&&this.exitPerformanceMode(),window.removeEventListener("keydown",this._keyHandler),this.active=!1,this.onStateChange&&this.onStateChange(!1))}update(t){if(!this.active)return;this.audioReactor.update();const e=this.parameterBus.update(this.audioReactor,t);if(this._applyParams(e,t),this.cameraModes.update(this.audioReactor,t),this.meshReactor.update(this.audioReactor,t),this._updateVJPasses(t),this.particleSpawner.enabled){if(this.audioReactor.beat){const o=1+Math.floor(this.audioReactor.energy*4);for(let i=0;i<o;i++)this.particleSpawner.spawn(this.audioReactor.energy)}this.particleSpawner.update(t)}this.audioGenerative.enabled&&this.audioGenerative.update(this.audioReactor,t)}_applyParams(t,e){for(const[o,i]of t){const{value:s,trigger:n}=i,r=n?s:s*this.reactivity;switch(o){case"shader.thickness":this.gpuRenderer.setLineWidth(r);break;case"shader.threshold":this.gpuRenderer.setThreshold(r);break;case"shader.fills":n&&(this.fillsOn=!this.fillsOn,this.gpuRenderer.setShowFills(this.fillsOn));break;case"shader.chromatic":this.vjPasses.chromatic&&(this.vjPasses.chromatic.uniforms.uAmount.value=r);break;case"shader.glitch":this.vjPasses.glitch&&(this.vjPasses.glitch.uniforms.uGlitch.value=r);break;case"shader.hueShift":this.vjPasses.hueShift&&(this.vjPasses.hueShift.uniforms.uShift.value=r);break;case"shader.vignette":this.vjPasses.vignette&&(this.vjPasses.vignette.uniforms.uIntensity.value=r);break;case"shader.feedback":this.vjPasses.feedback&&(this.vjPasses.feedback.uniforms.uFeedback.value=r);break;case"camera.shake":this.cameraModes.shake=r;break;case"camera.orbitSpeed":this.cameraModes.orbitSpeed=r;break;case"mesh.vertexDistort":this.meshReactor.setVertexDistortion(r);break;case"mesh.blockBounce":this.meshReactor.setBlockDistortion(r);break;case"emissive.intensity":this._setGlobalEmissiveIntensity(r);break;case"bloom.strength":this._setBloomStrength(r);break}}}_setGlobalEmissiveIntensity(t){const e=this.blockManager.getAllBlocks();for(const o of e)if(o.emissive&&o.emissive.enabled){const i=Array.isArray(o.mesh.material)?o.mesh.material:[o.mesh.material];for(const s of i)s.emissiveIntensity=t}}_setBloomStrength(t){if(!this.gpuRenderer.composer)return;const e=this.gpuRenderer.composer.passes;for(const o of e)o.strength!==void 0&&(o.strength=t)}_setupVJPasses(){if(this.vjPassesActive)return;this.vjPasses.chromatic=new Ie(r0),this.vjPasses.glitch=new Ie(a0),this.vjPasses.hueShift=new Ie(l0),this.vjPasses.vignette=new Ie(c0),this.vjPasses.feedback=new Ie(p0);const t=window.innerWidth,e=window.innerHeight,o={minFilter:wo,magFilter:wo,format:ds};this.feedbackTargetA=new Ce(t,e,o),this.feedbackTargetB=new Ce(t,e,o),this.vjPassesActive=!0,this._injectVJPasses()}_injectVJPasses(){if(!this.gpuRenderer.composer||!this.vjPassesActive)return;const t=this.gpuRenderer.composer,e=t.passes,o=e.length-1,i=[this.vjPasses.chromatic,this.vjPasses.glitch,this.vjPasses.hueShift,this.vjPasses.vignette],s=e[o];e.splice(o,1);for(const n of i)t.addPass(n);t.addPass(s)}_removeVJPasses(){this.vjPassesActive&&(this.feedbackTargetA&&this.feedbackTargetA.dispose(),this.feedbackTargetB&&this.feedbackTargetB.dispose(),this.feedbackTargetA=null,this.feedbackTargetB=null,this.vjPasses={},this.vjPassesActive=!1,this.gpuRenderer.enabled&&this.gpuRenderer.updateStyle())}_updateVJPasses(t){this.vjPassesActive&&this.vjPasses.glitch&&(this.vjPasses.glitch.uniforms.uTime.value+=t)}onStyleChanged(){this.vjPassesActive&&this._injectVJPasses()}enterPerformanceMode(){this.performanceMode=!0;const t=document.documentElement;t.requestFullscreen&&t.requestFullscreen(),document.querySelectorAll("#right-panel, #bottom-toolbar, #top-menu, #timeline-panel, .modal").forEach(o=>{o.dataset.vjHidden=o.style.display,o.style.display="none"});const e=document.getElementById("vj-overlay");e&&(e.style.display="flex")}exitPerformanceMode(){this.performanceMode=!1,document.fullscreenElement&&document.exitFullscreen(),document.querySelectorAll("#right-panel, #bottom-toolbar, #top-menu, #timeline-panel").forEach(e=>{e.style.display=e.dataset.vjHidden||"",delete e.dataset.vjHidden});const t=document.getElementById("vj-overlay");t&&(t.style.display="none")}_handleKeyboard(t){if(this.active&&!(t.target.tagName==="INPUT"||t.target.tagName==="SELECT"||t.target.tagName==="TEXTAREA"))switch(t.key){case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{const s=parseInt(t.key)-1;s<this.styles.length&&(this.currentStyleIndex=s,this.gpuRenderer.setStyle(this.styles[s]),setTimeout(()=>this.onStyleChanged(),50),this._showOverlayMessage(this.styles[s])),t.preventDefault();break}case" ":this.fillsOn=!this.fillsOn,this.gpuRenderer.setShowFills(this.fillsOn),this._showOverlayMessage(this.fillsOn?"Fills ON":"Fills OFF"),t.preventDefault();break;case"g":this.gpuRenderer.grayscale=!this.gpuRenderer.grayscale,this.gpuRenderer.updateStyleUniforms(),this._showOverlayMessage(this.gpuRenderer.grayscale?"Grayscale":"Color");break;case"i":this.gpuRenderer.setInverted(!this.gpuRenderer.inverted),this._showOverlayMessage(this.gpuRenderer.inverted?"Inverted":"Normal");break;case"c":this.currentCameraModeIndex=(this.currentCameraModeIndex+1)%this.cameraModeNames.length;const e=this.cameraModeNames[this.currentCameraModeIndex];this.cameraModes.setMode(e),this._showOverlayMessage(`Camera: ${e}`);break;case"f":this.performanceMode?this.exitPerformanceMode():this.enterPerformanceMode();break;case"m":this.audioReactor.running&&(this.audioReactor.setGain(this.audioReactor.gain>0?0:1),this._showOverlayMessage(this.audioReactor.gain>0?"Audio ON":"Audio MUTED"));break;case"r":this.currentStyleIndex=Math.floor(Math.random()*this.styles.length),this.gpuRenderer.setStyle(this.styles[this.currentStyleIndex]),setTimeout(()=>this.onStyleChanged(),50),this._showOverlayMessage(this.styles[this.currentStyleIndex]);break;case"+":case"=":this.reactivity=Math.min(3,this.reactivity+.1),this._showOverlayMessage(`Reactivity: ${this.reactivity.toFixed(1)}`);break;case"-":this.reactivity=Math.max(.1,this.reactivity-.1),this._showOverlayMessage(`Reactivity: ${this.reactivity.toFixed(1)}`);break;case"[":this._adjustAllSmoothing(-.02),this._showOverlayMessage("Smoother");break;case"]":this._adjustAllSmoothing(.02),this._showOverlayMessage("Snappier");break;case"0":this.reactivity=1,this.parameterBus.loadPreset(this.currentPreset),this._showOverlayMessage("Reset");break;case"p":const o=["chill","hard","psychedelic"],i=o.indexOf(this.currentPreset);this.currentPreset=o[(i+1)%o.length],this.parameterBus.loadPreset(this.currentPreset),this._showOverlayMessage(`Preset: ${this.currentPreset}`);break;case"n":this.sceneBank.count>0&&(this.sceneBank.next(this.blockManager,this._layerManager),this.meshReactor.setEnabled(!0),this.particleSpawner.updateSceneBounds(this.blockManager),this._showOverlayMessage(`Scene: ${this.sceneBank.currentName} (${this.sceneBank.currentIndex+1}/${this.sceneBank.count})`));break;case"b":this.sceneBank.count>0&&(this.sceneBank.previous(this.blockManager,this._layerManager),this.meshReactor.setEnabled(!0),this.particleSpawner.updateSceneBounds(this.blockManager),this._showOverlayMessage(`Scene: ${this.sceneBank.currentName} (${this.sceneBank.currentIndex+1}/${this.sceneBank.count})`));break;case"v":{const s=["bounce","jump","wave","scatter"],n=s.indexOf(this.meshReactor.movementMode),r=s[(n+1)%s.length];this.meshReactor.setMovementMode(r),this._showOverlayMessage(`Move: ${r}`);break}case"x":{const s=this.audioGenerative;s.enabled?(s.setEnabled(!1),this._showOverlayMessage("Generative OFF")):(s.initFromScene(this.blockManager),s.setEnabled(!0),this._showOverlayMessage("Generative ON"));break}}}_adjustAllSmoothing(t){for(const e of this.parameterBus.mappings)e.smooth=Math.max(.01,Math.min(.5,e.smooth+t))}_showOverlayMessage(t){const e=document.getElementById("vj-message");e&&(e.textContent=t,e.style.opacity="1",clearTimeout(this._messageTimeout),this._messageTimeout=setTimeout(()=>{e.style.opacity="0"},1200))}getAudioData(){return{bands:{...this.audioReactor.bands},energy:this.audioReactor.energy,beat:this.audioReactor.beat,onset:this.audioReactor.onset}}setPreset(t){this.currentPreset=t,this.parameterBus.loadPreset(t)}setCameraMode(t){const e=this.cameraModeNames.indexOf(t);e>=0&&(this.currentCameraModeIndex=e),this.cameraModes.setMode(t)}dispose(){this.stop(),this.audioReactor.dispose(),this.meshReactor.dispose(),this.cameraModes.dispose(),this.parameterBus.dispose(),this.particleSpawner.dispose(),this.audioGenerative.dispose()}}function y0(y,t){let e;return function(...i){const s=()=>{clearTimeout(e),y(...i)};clearTimeout(e),e=setTimeout(s,t)}}class u0{constructor(){this.canvas=document.getElementById("viewport"),this.gridPosEl=document.getElementById("grid-pos"),this.blockCountEl=document.getElementById("block-count"),this.colorInput=document.getElementById("current-color"),this.colorPalette=document.getElementById("color-palette"),this.selectionProps=document.getElementById("selection-props"),this.fileInput=document.getElementById("file-input"),this.debouncedAutoSave=y0(()=>this.autoSave(),2e3),this.engine=new za(this.canvas),this.grid=new va(this.engine.scene,{gridSize:20,cellSize:1}),this.blockManager=new Da(this.engine.scene),this.ghostBlock=new Ia(this.engine.scene),this.history=new La,this.textureManager=new Ra,this.facePainter=new wa(this.textureManager),this.animator=new Xa(this.blockManager),this.projectManager=new Za(this.blockManager,this.animator,this.textureManager),this.projectManager.onError=t=>this.showNotification(t,"error"),this.exporter=new ul,this.layerManager=new Ml,this.layerManager.onLayerChange=()=>this.updateLayerUI(),this.projectManager.setLayerManager(this.layerManager),this.symmetryTool=new Sl(this.blockManager),this.cameraBookmarks=new Tl(this.engine.camera,this.engine.controls),this.cameraBookmarks.onBookmarksChange=()=>this.updateCameraBookmarksUI(),this.cameraPathAnimator=new Dl(this.engine.camera,this.engine.controls,this.cameraBookmarks),this.frameSequencer=new tc(this.engine),window.JSZip=Jp,this.lightBaker=new dl,this.textureBaker=new fl,this.useGPURenderer=!0;try{this.useGPURenderer?(this.tattooRenderer=new Ks(this.engine,this.blockManager),console.log("Using GPU-accelerated style renderer")):(this.tattooRenderer=new Eo(this.engine,this.blockManager),console.log("Using CPU style renderer"))}catch(t){console.warn("GPU renderer failed, falling back to CPU:",t),this.tattooRenderer=new Eo(this.engine,this.blockManager)}this.blockFlattener=new Gp(this.blockManager),this.scatterTool=new Hp(this.blockManager),this.vjController=new h0(this.engine,this.blockManager,this.tattooRenderer,this.cameraBookmarks),this.notificationsEl=document.getElementById("notifications"),this.bakedTexture=null,this.bakedUVData=null,this.inputManager=new Pa(this.canvas,this.engine.camera),this.inputManager.setGridPlane(this.grid.getRaycastPlane()),this.currentColor="#5588cc",this.currentBlockType="cube",this.currentRotation=0,this.clipboard=null,this.emissiveEnabled=!1,this.emissiveColor="#ffaa00",this.emissiveIntensity=1,this.emissiveRadius=3,this.showEdges=!0,this.edgeOpacity=.3,this.currentShape="sphere",this.shapeGhosts=[],this.paintMode="face",this.currentBlockScale=1,this.setupCallbacks(),this.setupToolbar(),this.setupPaintMode(),this.setupShapeBrush(),this.setupMoveControls(),this.setupColorPalette(),this.setupEmissiveControls(),this.setupEdgeControls(),this.setupMenuBar(),this.setupTimeline(),this.setupLayerPanel(),this.setupSymmetryTools(),this.setupCameraBookmarks(),this.setupCameraAnimation(),this.setupTattooMode(),this.setupScatterTool(),this.setupVJ(),this.setupKeyboardShortcuts(),this.engine.onUpdate=t=>{if(this.animator.update(t),!this.useGPURenderer&&this.tattooRenderer.update&&this.tattooRenderer.update(),this.vjController&&this.vjController.active){const e=this.vjController.audioReactor.energy,o=Math.min(100,e*100);this._vjMeterBar&&(this._vjMeterBar.style.width=o+"%"),this._vjOverlayMeterBar&&(this._vjOverlayMeterBar.style.width=o+"%"),this._vjStyleNameEl&&(this._vjStyleNameEl.textContent=this.vjController.styles[this.vjController.currentStyleIndex]),this._vjCameraNameEl&&(this._vjCameraNameEl.textContent=this.vjController.cameraModeNames[this.vjController.currentCameraModeIndex]),this._vjPresetNameEl&&(this._vjPresetNameEl.textContent=this.vjController.currentPreset)}},this.engine.start(),this.autoLoad()}setupCallbacks(){this.blockManager.onBlockCountChange=c=>{this.blockCountEl.textContent=`Blocks: ${c}`,this.inputManager.setRaycastTargets(this.blockManager.getBlockMeshes()),this.debouncedAutoSave()},this.engine.controls.addEventListener("change",()=>{this.debouncedAutoSave()}),this.history.onChange=({canUndo:c,canRedo:f})=>{document.getElementById("btn-undo").disabled=!c,document.getElementById("btn-redo").disabled=!f},this.history.notify();const t={slab:"slabTop",wedgeLow:"wedgeLowTop",wedgeFlat:"wedgeFlatTop",slabSlope:"slabSlopeTop"},e=(c,f)=>{const d={x:c.placementPosition.x,y:c.placementPosition.y,z:c.placementPosition.z};if(c.placementPosition.surfaceY!==void 0){const m=c.placementPosition.surfaceY,x=m%1;if(x!==0){const b=t[f];b&&Math.abs(x-.5)<.1?(d.y=Math.floor(m),d.useUpperVariant=b):d.y=Math.ceil(m)}}return d},o=(c,f)=>f<=1?c:{x:Math.floor(c.x/f)*f,y:c.y,z:Math.floor(c.z/f)*f};this.inputManager.onMouseMove=c=>{if(this.inputManager.currentTool==="place"&&c){let f=e(c,this.currentBlockType);const d=f.useUpperVariant||this.currentBlockType;f=o(f,this.currentBlockScale),this.ghostBlock.show(),this.ghostBlock.setPosition(f),this.ghostBlock.setBlockType(d),this.ghostBlock.setRotation(this.currentRotation);const m=this.blockManager.wouldOverlapAt(d,f,{w:1,h:1,d:1},null,this.currentBlockScale,{x:0,y:this.currentRotation,z:0});this.ghostBlock.setValid(!m),this.gridPosEl.textContent=`Grid: ${f.x}, ${f.y}, ${f.z}`}else this.ghostBlock.hide()};let i=null;const s=(c,f)=>{const d=[],m=Math.abs(f.x-c.x),x=Math.abs(f.y-c.y),g=Math.abs(f.z-c.z),b=c.x===f.x,z=c.y===f.y,v=c.z===f.z;if(b&&z||b&&v||z&&v){const C=c.x<f.x?1:c.x>f.x?-1:0,B=c.y<f.y?1:c.y>f.y?-1:0,A=c.z<f.z?1:c.z>f.z?-1:0,M=Math.max(m,x,g);for(let _=0;_<=M;_++)d.push({x:c.x+C*_,y:c.y+B*_,z:c.z+A*_})}else{const C=Math.min(c.x,f.x),B=Math.max(c.x,f.x),A=Math.min(c.y,f.y),M=Math.max(c.y,f.y),_=Math.min(c.z,f.z),P=Math.max(c.z,f.z);for(let k=C;k<=B;k++)for(let T=A;T<=M;T++)for(let F=_;F<=P;F++)d.push({x:k,y:T,z:F})}return d};this.inputManager.onPlace=(c,f)=>{if(!c)return;if(!this.canEditCurrentLayer()){this.showNotification("Layer is locked or hidden","warning");return}let d=e(c,this.currentBlockType);const m=d.useUpperVariant||this.currentBlockType;if(d=o(d,this.currentBlockScale),f&&i){const b=s(i,d);let z=!1;for(const v of b){if(this.blockManager.wouldOverlapAt(m,v,{w:1,h:1,d:1},null,this.currentBlockScale,{x:0,y:this.currentRotation,z:0}))continue;const C={type:m,position:{...v},color:this.currentColor,rotation:{x:0,y:this.currentRotation,z:0},layerId:this.getActiveLayerId(),scale:this.currentBlockScale,emissive:{enabled:this.emissiveEnabled,color:this.emissiveColor,intensity:this.emissiveIntensity,radius:this.emissiveRadius}},B=this.blockManager.addBlock(C);B&&(this.history.push(co(this.blockManager,C,B)),z=!0)}z&&(i={...d});return}if(this.blockManager.wouldOverlapAt(m,d,{w:1,h:1,d:1},null,this.currentBlockScale,{x:0,y:this.currentRotation,z:0}))return;const x={type:m,position:d,color:this.currentColor,rotation:{x:0,y:this.currentRotation,z:0},layerId:this.getActiveLayerId(),scale:this.currentBlockScale,emissive:{enabled:this.emissiveEnabled,color:this.emissiveColor,intensity:this.emissiveIntensity,radius:this.emissiveRadius}},g=this.blockManager.addBlock(x);g&&(this.history.push(co(this.blockManager,x,g)),i={...d})},this.inputManager.onDelete=c=>{c&&(this.history.push(Bi(this.blockManager,c)),this.blockManager.removeBlock(c.id))},this.inputManager.onSelect=(c,f)=>{f&&c?this.blockManager.toggleSelection(c):this.blockManager.selectBlock(c),this.updateSelectionUI()};const n=(c,f)=>{const d=new ko(gt.degToRad(f.rotation.x),gt.degToRad(f.rotation.y),gt.degToRad(f.rotation.z)),x=new Ne().setFromEuler(d).clone().invert(),g=c.clone().applyQuaternion(x);return this.facePainter.getFaceFromNormal(g)};let r=null,a=[],l=!1,p=0;const h=(c,f)=>{const d=this.paintMode==="face"&&!c.supportsPerFacePainting();if(d){const m=Date.now();if(m-p>2e3){p=m;const x=document.getElementById("tool-hint"),g=x.textContent;x.textContent=`Complex block "${c.type}" - painting entire block (face mode not supported)`,x.style.color="#ffaa00",setTimeout(()=>{x.textContent=g,x.style.color=""},2e3)}}if(this.paintMode==="block"||d){const m=c.color,x={};return Object.entries(c.faces).forEach(([g,b])=>{b&&b.color&&(x[g]={color:b.color})}),c.setColor(this.currentColor),Na(c,m,this.currentColor,x)}else{const m=n(f,c),x=c.getFaceColor(m),g=c.faces[m]&&c.faces[m].color!==null;return c.setFaceColor(m,this.currentColor),Oa(c,m,g?x:null,this.currentColor)}},u=(c,f,d)=>{const m=[],x=Math.abs(f.x-c.x),g=Math.abs(f.y-c.y),b=Math.abs(f.z-c.z);let z,v,C,B;x>=g&&x>=b?(z=x,v=c.x<f.x?1:-1,C=0,B=0):g>=x&&g>=b?(z=g,v=0,C=c.y<f.y?1:-1,B=0):(z=b,v=0,C=0,B=c.z<f.z?1:-1);for(let A=0;A<=z;A++){const M={x:c.x+v*A,y:c.y+C*A,z:c.z+B*A},_=this.blockManager.getBlockAtPosition(M);_&&m.push({block:_,normal:d})}return m};this.inputManager.onPaint=(c,f)=>{if(!c||!c.block)return;const d=c.block.gridPosition;if(f&&r){const m=u(r,d,c.normal),x=[];m.forEach(({block:g,normal:b})=>{const z=h(g,b);x.push(z)}),x.length>0&&this.history.push(Us(x))}else{const m=h(c.block,c.normal);this.inputManager.isPainting&&!l?(l=!0,a=[m]):this.inputManager.isPainting&&l?a.push(m):this.history.push(m)}r={...d},c.normal.clone()},this.canvas.onmouseup,this.canvas.addEventListener("mouseup",()=>{l&&a.length>0&&(a.length===1?this.history.push(a[0]):this.history.push(Us(a)),a=[]),l=!1}),this.inputManager.onPick=c=>{if(c&&c.block){const f=n(c.normal,c.block);this.currentColor=c.block.getFaceColor(f),this.colorInput.value=this.currentColor,this.updateColorSwatchSelection()}},this.inputManager.onPickBlock=c=>{this.pickBlock(c)},this.inputManager.onReplace=c=>{if(!c)return;const f=c.gridPosition;this.history.push(Bi(this.blockManager,c)),this.blockManager.removeBlock(c.id);const d=this.emissiveEnabled?{enabled:!0,color:this.emissiveColor,intensity:this.emissiveIntensity,radius:this.emissiveRadius}:null,m={type:this.currentBlockType,position:{x:f.x,y:f.y,z:f.z},color:this.currentColor,rotation:{x:0,y:this.currentRotation,z:0},emissive:d},x=this.blockManager.addBlock(m);x&&this.history.push(co(this.blockManager,m,x))}}findMaterialIdByColor(t){for(const e of this.textureManager.getColorMaterials())if(e.baseColor.toLowerCase()===t.toLowerCase())return e.id;return null}setupToolbar(){document.querySelectorAll(".tool").forEach(a=>{a.addEventListener("click",()=>{const l=a.dataset.tool;this.setTool(l)})}),this.generateBlockPalette(),this.setupBlockSearch(),document.getElementById("btn-rotate").addEventListener("click",()=>{this.rotateBlock()});const t=document.getElementById("btn-scale-1x"),e=document.getElementById("btn-scale-2x"),o=document.getElementById("btn-scale-4x"),i=document.getElementById("btn-scale-6x"),s=document.getElementById("btn-scale-8x"),n=[t,e,o,i,s],r=a=>{n.forEach(l=>l.classList.remove("active")),a.classList.add("active")};t.addEventListener("click",()=>{this.setBlockScale(1),r(t)}),e.addEventListener("click",()=>{this.setBlockScale(2),r(e)}),o.addEventListener("click",()=>{this.setBlockScale(4),r(o)}),i.addEventListener("click",()=>{this.setBlockScale(6),r(i)}),s.addEventListener("click",()=>{this.setBlockScale(8),r(s)})}setBlockScale(t){this.currentBlockScale=t,this.ghostBlock.setScale(t)}generateBlockPalette(){const t=document.getElementById("block-palette");if(!t)return;t.innerHTML="";const e=["decorative","details","architectural","furniture","storage","industrial","electrical","natural","modern","medieval"];for(const[o,i]of Object.entries(Yn)){const s=document.createElement("div");s.className="block-category",e.includes(o)&&s.classList.add("collapsed");const n=document.createElement("div");n.className="block-category-header",n.innerHTML=`
        <span class="arrow"></span>
        <span class="label">${i.label}</span>
        <span class="count">${i.types.length}</span>
      `,n.addEventListener("click",()=>{s.classList.toggle("collapsed")}),s.appendChild(n);const r=document.createElement("div");r.className="block-category-content";for(const a of i.types){const l=Ss[a]||{icon:"?",label:a},p=document.createElement("button");p.className="block-type",p.dataset.type=a,p.title=l.label,p.textContent=l.icon,a==="cube"&&p.classList.add("active"),p.addEventListener("click",()=>{this.setBlockType(a)}),r.appendChild(p)}s.appendChild(r),t.appendChild(s)}}setupBlockSearch(){const t=document.getElementById("block-search");t&&(t.addEventListener("input",e=>{this.filterBlocks(e.target.value)}),t.addEventListener("keydown",e=>{e.key==="Escape"&&(t.value="",this.filterBlocks(""),t.blur())}))}filterBlocks(t){const e=t.toLowerCase().trim();document.querySelectorAll(".block-category").forEach(i=>{const s=i.querySelectorAll(".block-type");let n=!1;s.forEach(r=>{const a=r.dataset.type,p=(Ss[a]||{label:a}).label.toLowerCase(),h=!e||a.toLowerCase().includes(e)||p.includes(e);r.classList.toggle("search-hidden",!h),h&&(n=!0)}),i.classList.toggle("search-hidden",!n),i.classList.toggle("search-match",n&&e.length>0)})}setTool(t){this.inputManager.setTool(t),document.querySelectorAll(".tool").forEach(r=>{r.classList.toggle("active",r.dataset.tool===t)}),t!=="place"&&t!=="shape"&&this.ghostBlock.hide();const e=document.getElementById("shape-section");e&&(e.style.display=t==="shape"?"":"none");const o=document.getElementById("paint-section");o&&(o.style.display=t==="paint"?"":"none");const i=document.getElementById("scatter-section");i&&(i.style.display=t==="scatter"?"":"none"),t!=="shape"&&this.clearShapeGhosts();const n={place:"Left-click: place | Alt+click: pick block | Ctrl+click: replace",delete:"Left-click: delete | Alt+click: pick block",select:"Left-click: select | Shift+click: add | +/-: keyframe | Space: play",paint:`Click+drag: ${this.paintMode==="block"?"paint block":"paint face"} | Shift+click: paint line | Alt+click: pick block`,pick:"Left-click: pick color | Alt+click: pick block",shape:"Click+drag: define shape size | Release: place blocks",scatter:"Click: generate organic structure from point"};document.getElementById("tool-hint").textContent=n[t]||""}setBlockType(t){this.currentBlockType=t,document.querySelectorAll(".block-type").forEach(e=>{e.classList.toggle("active",e.dataset.type===t)})}rotateBlock(){this.currentRotation=(this.currentRotation+90)%360;const t=this.blockManager.getSelectedBlocks();for(const e of t)e.rotateY(90);t.length>0&&this.updateSelectionUI()}setupPaintMode(){document.querySelectorAll(".paint-mode").forEach(t=>{t.addEventListener("click",()=>{this.paintMode=t.dataset.mode,document.querySelectorAll(".paint-mode").forEach(e=>{e.classList.toggle("active",e.dataset.mode===this.paintMode)}),this.setTool("paint")})})}pickBlock(t){t&&(this.setTool("place"),this.setBlockType(t.type),this.currentColor=t.color,this.colorInput.value=t.color,this.currentRotation=t.rotation.y,this.ghostBlock.setBlockType(t.type),this.ghostBlock.setColor(t.color),this.ghostBlock.setRotation(this.currentRotation))}setupShapeBrush(){document.querySelectorAll(".shape-type").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.shape;this.currentShape=e,document.querySelectorAll(".shape-type").forEach(o=>{o.classList.toggle("active",o.dataset.shape===e)})})}),this.inputManager.onShapeDrag=(t,e)=>{this.updateShapePreview(t,e)},this.inputManager.onShapePlace=(t,e)=>{this.placeShape(t,e),this.clearShapeGhosts()}}updateShapePreview(t,e){this.clearShapeGhosts();const o=Vs(this.currentShape,t,e),i=500,s=o.slice(0,i),n=new gi({color:this.currentColor,transparent:!0,opacity:.4,side:Ae}),r=new bi(.95,.95,.95);s.forEach(l=>{const p=new Dt(r,n);p.position.set(l.x+.5,l.y+.5,l.z+.5),this.engine.scene.add(p),this.shapeGhosts.push(p)});const a=document.getElementById("tool-hint");o.length>i?a.textContent=`Shape: ${o.length} blocks (showing ${i}) | Release to place`:a.textContent=`Shape: ${o.length} blocks | Release to place`}clearShapeGhosts(){this.shapeGhosts.forEach(t=>{this.engine.scene.remove(t),t.geometry.dispose(),t.material.dispose()}),this.shapeGhosts=[]}placeShape(t,e){if(!this.canEditCurrentLayer()){this.showNotification("Layer is locked or hidden","warning");return}const o=Vs(this.currentShape,t,e),i=1e3;if(o.length>i){alert(`Shape too large (${o.length} blocks). Maximum is ${i}.`);return}const s=this.emissiveEnabled?{color:this.emissiveColor,intensity:this.emissiveIntensity,radius:this.emissiveRadius}:null,n=[],r={x:0,y:this.currentRotation,z:0};if(o.forEach(a=>{if(!this.blockManager.wouldOverlapAt(this.currentBlockType,a,{w:1,h:1,d:1},null,1,r)){const l={type:this.currentBlockType,position:{...a},color:this.currentColor,rotation:{...r},layerId:this.getActiveLayerId(),emissive:s},p=this.blockManager.addBlock(l);p&&n.push(p)}}),n.length>0){const a=n.map(l=>l.id);this.history.push({undo:()=>{a.forEach(l=>this.blockManager.removeBlock(l))},redo:()=>{o.forEach(l=>{this.blockManager.wouldOverlapAt(this.currentBlockType,l,{w:1,h:1,d:1},null,1,r)||this.blockManager.addBlock({type:this.currentBlockType,position:{...l},color:this.currentColor,rotation:{...r},emissive:s})})}})}}setupScatterTool(){const t=document.getElementById("scatter-preset");Object.keys(fi).forEach(p=>{const h=document.createElement("option");h.value=p,h.textContent=fi[p].label||p,t.appendChild(h)}),t.addEventListener("change",p=>{this.scatterTool.setPreset(p.target.value)});const e=document.getElementById("scatter-algorithm");Object.keys(ni).forEach(p=>{const h=document.createElement("option");h.value=p,h.textContent=ni[p].label,h.title=ni[p].description,e.appendChild(h)}),e.addEventListener("change",p=>{this.scatterTool.setAlgorithm(p.target.value)});const o=document.getElementById("scatter-count"),i=document.getElementById("scatter-count-val");o.addEventListener("input",p=>{const h=parseInt(p.target.value);this.scatterTool.setMaxBlocks(h),i.textContent=h});const s=document.getElementById("scatter-branch"),n=document.getElementById("scatter-branch-val");s.addEventListener("input",p=>{const h=parseFloat(p.target.value);this.scatterTool.setBranchChance(h),n.textContent=Math.round(h*100)+"%"});const r=document.getElementById("scatter-scale-ratio"),a=document.getElementById("scatter-scale-ratio-val");r.addEventListener("input",p=>{const h=parseFloat(p.target.value);this.scatterTool.setScaleRatio(h);const u=Math.round((.3+h*.7)*100),c=Math.round(Math.max(0,(1-h)*.3)*100),f=100-u-c;c>0?a.textContent=`${u}% 1 / ${f}% 2 / ${c}% 4`:a.textContent=`${u}% 1 / ${f}% 2`}),document.getElementById("scatter-harmony").addEventListener("change",p=>{this.scatterTool.setColorHarmony(p.target.value)}),this.inputManager.onScatterPlace=p=>{this.executeScatter(p)}}executeScatter(t){if(!this.canEditCurrentLayer()){this.showNotification("Layer is locked or hidden","warning");return}const e=t.placementPosition,o=this.scatterTool.generate(e,{baseColor:this.currentColor});if(o.length===0){this.showNotification("No blocks generated","warning");return}const i=[],s=[];if(o.forEach(n=>{if(!this.blockManager.wouldOverlapAt(n.type,n.position,{w:1,h:1,d:1},null,n.scale,n.rotation)){const r={type:n.type,position:{...n.position},color:n.color,rotation:n.rotation,scale:n.scale,layerId:this.getActiveLayerId()},a=this.blockManager.addBlock(r);a&&(i.push(a),s.push(r))}}),i.length>0){const n=i.map(r=>r.id);this.history.push({undo:()=>{n.forEach(r=>this.blockManager.removeBlock(r))},redo:()=>{s.forEach(r=>{this.blockManager.wouldOverlapAt(r.type,r.position,{w:1,h:1,d:1},null,r.scale,r.rotation)||this.blockManager.addBlock(r)})}}),this.showNotification(`Scattered ${i.length} blocks`,"success")}}moveSelectedBlocks(t,e,o){const i=this.blockManager.getSelectedBlocks();if(i.length===0)return;const s=new Set(i.map(n=>n.id));for(const n of i){const r={x:n.gridPosition.x+t,y:n.gridPosition.y+e,z:n.gridPosition.z+o};if(this.blockManager.wouldOverlapAt(n.type,r,n.dimensions,s,n.scale||1,n.rotation||{x:0,y:0,z:0}))return}for(const n of i){const r={x:n.gridPosition.x+t,y:n.gridPosition.y+e,z:n.gridPosition.z+o};n.setPosition(r)}this.updateSelectionUI()}moveSelectedBlock(t,e,o){this.moveSelectedBlocks(t,e,o)}setupMoveControls(){document.querySelectorAll(".move-btn").forEach(t=>{t.addEventListener("click",()=>{switch(t.dataset.dir){case"up":this.moveSelectedBlock(0,0,-1);break;case"down":this.moveSelectedBlock(0,0,1);break;case"left":this.moveSelectedBlock(-1,0,0);break;case"right":this.moveSelectedBlock(1,0,0);break;case"raise":this.moveSelectedBlock(0,1,0);break;case"lower":this.moveSelectedBlock(0,-1,0);break}})})}setupColorPalette(){["#ffffff","#d0d0d0","#a0a0a0","#707070","#404040","#1a1a1a","#000000","#ffcccc","#ff6666","#e74c3c","#c0392b","#8b0000","#4a0000","#ffe0cc","#ffaa66","#e67e22","#d35400","#a04000","#602800","#ffffcc","#ffff66","#f1c40f","#d4ac0d","#b8860b","#806000","#ccffcc","#66ff66","#2ecc71","#27ae60","#1e8449","#145a32","#ccffff","#66ffff","#1abc9c","#16a085","#0e6655","#0a4a3a","#cce0ff","#66b3ff","#3498db","#2980b9","#1a5276","#0d2840","#e0ccff","#b366ff","#9b59b6","#8e44ad","#6c3483","#4a235a","#ffccee","#ff66cc","#e91e63","#c2185b","#880e4f","#4a0728","#e6d5c3","#c4a484","#a0522d","#795548","#5d4037","#3e2723","#ffd700","#c0c0c0","#cd7f32","#b87333","#4682b4","#708090"].forEach(e=>{const o=document.createElement("div");o.className="color-swatch",o.style.background=e,o.addEventListener("click",()=>{this.currentColor=e,this.colorInput.value=e,this.updateColorSwatchSelection()}),this.colorPalette.appendChild(o)}),this.colorInput.addEventListener("input",e=>{this.currentColor=e.target.value,this.updateColorSwatchSelection()}),this.updateColorSwatchSelection()}setupEmissiveControls(){const t=document.getElementById("emissive-enabled"),e=document.getElementById("emissive-color"),o=document.getElementById("emissive-intensity"),i=document.getElementById("emissive-intensity-val"),s=document.getElementById("emissive-radius"),n=document.getElementById("emissive-radius-val");t.addEventListener("change",r=>{this.emissiveEnabled=r.target.checked,this.ghostBlock.setColor(this.emissiveEnabled?this.emissiveColor:this.currentColor)}),e.addEventListener("input",r=>{this.emissiveColor=r.target.value,this.emissiveEnabled&&this.ghostBlock.setColor(this.emissiveColor)}),o.addEventListener("input",r=>{this.emissiveIntensity=parseFloat(r.target.value),i.textContent=this.emissiveIntensity.toFixed(1)}),s.addEventListener("input",r=>{this.emissiveRadius=parseFloat(r.target.value),n.textContent=this.emissiveRadius.toFixed(1)})}setupEdgeControls(){const t=document.getElementById("show-edges"),e=document.getElementById("edge-opacity");t.addEventListener("change",o=>{this.showEdges=o.target.checked,this.updateAllBlockEdges()}),e.addEventListener("input",o=>{this.edgeOpacity=parseFloat(o.target.value),this.updateAllBlockEdges()})}updateAllBlockEdges(){for(const t of this.blockManager.getAllBlocks())t.setEdgesVisible(this.showEdges),t.setEdgesOpacity(this.edgeOpacity)}setupLayerPanel(){document.getElementById("btn-add-layer").addEventListener("click",()=>{const e=prompt("Layer name:",`Layer ${this.layerManager.layers.size}`);if(e){const o=this.layerManager.generateLayerId();this.layerManager.createLayer(o,e),this.layerManager.setActiveLayer(o)}}),this.updateLayerUI()}updateLayerUI(){const t=document.getElementById("layer-list");if(!t)return;t.innerHTML="";const e=this.layerManager.getAllLayers(),o=this.layerManager.activeLayerId;e.forEach(i=>{const s=document.createElement("div");s.className="layer-item"+(i.id===o?" active":""),s.innerHTML=`
        <div class="layer-color" style="background: ${i.color}"></div>
        <span class="layer-name">${i.name}</span>
        <div class="layer-controls">
          <button class="layer-btn ${i.visible?"":"off"}" data-action="visibility" title="Toggle Visibility">
            ${i.visible?"":""}
          </button>
          <button class="layer-btn ${i.locked?"locked":""}" data-action="lock" title="Toggle Lock">
            ${i.locked?"":""}
          </button>
        </div>
      `,s.addEventListener("click",n=>{n.target.closest(".layer-btn")||this.layerManager.setActiveLayer(i.id)}),s.addEventListener("dblclick",n=>{if(n.target.closest(".layer-btn"))return;const r=prompt("Rename layer:",i.name);r&&this.layerManager.setLayerName(i.id,r)}),s.querySelector('[data-action="visibility"]').addEventListener("click",n=>{n.stopPropagation(),this.layerManager.setLayerVisible(i.id,!i.visible),this.updateBlockVisibility()}),s.querySelector('[data-action="lock"]').addEventListener("click",n=>{n.stopPropagation(),this.layerManager.setLayerLocked(i.id,!i.locked)}),t.appendChild(s)})}updateBlockVisibility(){for(const t of this.blockManager.getAllBlocks()){const e=this.layerManager.isLayerVisible(t.layerId);t.mesh.visible=e}}getActiveLayerId(){return this.layerManager.activeLayerId}canEditCurrentLayer(){return this.layerManager.canEditLayer(this.layerManager.activeLayerId)}setupSymmetryTools(){document.getElementById("btn-mirror-x").addEventListener("click",()=>{this.mirrorSelectedBlocks("x")}),document.getElementById("btn-mirror-y").addEventListener("click",()=>{this.mirrorSelectedBlocks("y")}),document.getElementById("btn-mirror-z").addEventListener("click",()=>{this.mirrorSelectedBlocks("z")})}mirrorSelectedBlocks(t){if(this.blockManager.getSelectedBlocks().length===0){this.showNotification("Select blocks to mirror","warning");return}const o=this.symmetryTool.mirrorSelectedBlocks(t,!0);if(o.length>0){this.showNotification(`Mirrored ${o.length} block(s) across ${t.toUpperCase()} axis`,"success");const i=o.map(s=>s.id);this.history.push({undo:()=>{i.forEach(s=>this.blockManager.removeBlock(s))},redo:()=>{this.symmetryTool.mirrorSelectedBlocks(t,!0)}})}else this.showNotification("Could not mirror - blocks may overlap","warning")}setupCameraBookmarks(){document.querySelectorAll(".preset-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.preset;this.cameraBookmarks.goToPreset(e)})}),document.getElementById("btn-save-view").addEventListener("click",()=>{const t=prompt("Bookmark name:",`View ${this.cameraBookmarks.bookmarks.size+1}`);t&&(this.cameraBookmarks.saveBookmark(t),this.showNotification(`View "${t}" saved`,"success"))}),this.updateCameraBookmarksUI()}updateCameraBookmarksUI(){const t=document.getElementById("camera-bookmarks");if(!t)return;t.innerHTML="",this.cameraBookmarks.getAllBookmarks().forEach(o=>{const i=document.createElement("div");i.className="bookmark-item",i.innerHTML=`
        <span class="bookmark-name">${o.name}</span>
        <button class="bookmark-delete" title="Delete">&times;</button>
      `,i.addEventListener("click",s=>{s.target.closest(".bookmark-delete")||this.cameraBookmarks.restoreBookmark(o.id)}),i.addEventListener("dblclick",s=>{if(s.target.closest(".bookmark-delete"))return;const n=prompt("Rename bookmark:",o.name);n&&this.cameraBookmarks.renameBookmark(o.id,n)}),i.querySelector(".bookmark-delete").addEventListener("click",s=>{s.stopPropagation(),this.cameraBookmarks.deleteBookmark(o.id)}),t.appendChild(i)})}setupCameraAnimation(){const t=document.getElementById("camera-anim-frames"),e=document.getElementById("camera-anim-fps"),o=document.getElementById("camera-anim-curve"),i=document.getElementById("camera-anim-duration"),s=document.getElementById("btn-camera-preview"),n=document.getElementById("btn-camera-export-jpg"),r=document.getElementById("btn-camera-export-mp4"),a=document.getElementById("camera-anim-progress"),l=document.getElementById("camera-anim-progress-bar"),p=document.getElementById("camera-anim-progress-text"),h=()=>{const u=parseInt(t.value),c=parseInt(e.value),f=(u/c).toFixed(1);i.textContent=`${f}s`};t.addEventListener("input",h),e.addEventListener("input",h),o.addEventListener("change",()=>{this.cameraPathAnimator.curveType=o.value}),s.addEventListener("click",()=>{const u=this.cameraBookmarks.getAllBookmarks();if(u.length<2){this.showNotification("Save at least 2 camera views to preview animation","warning",3e3);return}const c=parseInt(t.value),f=parseInt(e.value),d=c/f*1e3;this.showNotification("Previewing camera animation...","info",2e3),this.cameraPathAnimator.preview(u,d,()=>{this.showNotification("Preview complete","success",2e3)})}),n.addEventListener("click",async()=>{const u=this.cameraBookmarks.getAllBookmarks();if(u.length<2){this.showNotification("Save at least 2 camera views to export animation","warning",3e3);return}const c=parseInt(t.value);parseInt(e.value),n.disabled=!0,r.disabled=!0,s.disabled=!0,a.style.display="block",l.style.width="0%",p.textContent="0%";try{this.showNotification(`Rendering ${c} frames...`,"info");const f=await this.frameSequencer.captureSequence({animator:this.cameraPathAnimator,bookmarks:u,totalFrames:c,onProgress:m=>{l.style.width=`${m.percent}%`,p.textContent=`${m.percent}% (${m.current}/${m.total})`}});this.showNotification("Creating ZIP archive...","info"),await this.frameSequencer.exportAsZip(f);const d=this.frameSequencer.getMemoryUsage();this.showNotification(`Exported ${c} frames (${d}MB)`,"success",4e3),this.frameSequencer.clear()}catch(f){console.error("Export failed:",f),this.showNotification(`Export failed: ${f.message}`,"error",4e3)}finally{n.disabled=!1,r.disabled=!1,s.disabled=!1,a.style.display="none"}}),r.addEventListener("click",async()=>{const u=this.cameraBookmarks.getAllBookmarks();if(u.length<2){this.showNotification("Save at least 2 camera views to export video","warning",3e3);return}const c=parseInt(t.value),f=parseInt(e.value),d=c/f*1e3;n.disabled=!0,r.disabled=!0,s.disabled=!0,a.style.display="block",l.style.width="0%",p.textContent="Starting...";try{const m=Math.floor(d/1e3*f);this.showNotification(`Rendering ${m} frames for video...`,"info"),await this.frameSequencer.exportAsMP4Realtime(this.cameraPathAnimator,u,d,"camera_path.webm",x=>{l.style.width=`${x.percent}%`,p.textContent=`${x.percent}% (${x.current}/${x.total})`}),this.showNotification("Video exported successfully","success",3e3)}catch(m){console.error("Video export failed:",m),this.showNotification(`Video export failed: ${m.message}`,"error",4e3)}finally{n.disabled=!1,r.disabled=!1,s.disabled=!1,a.style.display="none"}})}setupTattooMode(){const t=document.getElementById("tattoo-enabled"),e=document.getElementById("gpu-acceleration"),o=document.getElementById("render-style"),i=document.getElementById("tattoo-inverted"),s=document.getElementById("tattoo-grayscale"),n=document.getElementById("tattoo-fills"),r=document.getElementById("render-quality"),a=document.getElementById("tattoo-threshold"),l=document.getElementById("tattoo-threshold-val"),p=document.getElementById("tattoo-line-width"),h=document.getElementById("tattoo-line-width-val"),u=document.getElementById("btn-tattoo-png"),c=document.getElementById("btn-tattoo-svg");e.checked=this.useGPURenderer,e.addEventListener("change",d=>{const m=this.tattooRenderer.enabled;m&&this.tattooRenderer.setEnabled(!1),this.tattooRenderer.dispose&&this.tattooRenderer.dispose(),this.useGPURenderer=d.target.checked;try{this.useGPURenderer?(this.tattooRenderer=new Ks(this.engine,this.blockManager),this.showNotification("GPU acceleration enabled","success",2e3)):(this.tattooRenderer=new Eo(this.engine,this.blockManager),this.showNotification("CPU rendering enabled","info",2e3))}catch(x){console.warn("Renderer switch failed:",x),this.tattooRenderer=new Eo(this.engine,this.blockManager),e.checked=!1,this.useGPURenderer=!1,this.showNotification("GPU not available, using CPU","warning",3e3)}this.vjController&&(this.vjController.gpuRenderer=this.tattooRenderer),m&&(this.tattooRenderer.setStyle(o.value),this.tattooRenderer.setInverted(i.checked),this.tattooRenderer.setGrayscale(s.checked),this.tattooRenderer.setShowFills(n.checked),this.tattooRenderer.setQuality(r.value),this.tattooRenderer.setEnabled(!0))}),t.addEventListener("change",d=>{if(this.tattooRenderer.setEnabled(d.target.checked),d.target.checked){const m=this.useGPURenderer?"GPU":"CPU";this.showNotification(`Stylized view enabled (${m})`,"info",2e3)}}),o.addEventListener("change",d=>{this.tattooRenderer.setStyle(d.target.value)}),i.addEventListener("change",d=>{this.tattooRenderer.setInverted(d.target.checked)}),s.addEventListener("change",d=>{this.tattooRenderer.setGrayscale(d.target.checked)}),n.addEventListener("change",d=>{this.tattooRenderer.setShowFills(d.target.checked)}),r.addEventListener("change",d=>{this.tattooRenderer.setQuality(d.target.value)}),a.addEventListener("input",d=>{const m=parseFloat(d.target.value);this.tattooRenderer.setThreshold(m),l.textContent=m.toFixed(2)}),p.addEventListener("input",d=>{const m=parseFloat(d.target.value);this.tattooRenderer.setLineWidth(m),h.textContent=m.toFixed(1)}),u.addEventListener("click",()=>{this.tattooRenderer.capturePNG("tattoo-design.png"),this.showNotification("PNG saved","success",2e3)}),c.addEventListener("click",()=>{this.tattooRenderer.exportSVG("tattoo-design.svg"),this.showNotification("SVG exported","success",2e3)}),document.getElementById("btn-flatten").addEventListener("click",()=>{this.flattenBlocks()})}flattenBlocks(){const t=this.blockManager.getAllBlocks();if(t.length===0){this.showNotification("No blocks to flatten","warning",2e3);return}const e=t.map(i=>i.toJSON()),o=this.blockFlattener.flattenAndApply();if(o.mergedCount>0){const i=o.mergedMeshes.map(s=>s.id);this.history.push(Ua(this.blockManager,e,i)),this.showNotification(`Flattened ${o.blocksRemoved} blocks into ${o.mergedCount} merged mesh(es)`,"success",3e3),this.updateBlockCount(),this.debouncedAutoSave(),this.tattooRenderer.enabled&&this.tattooRenderer.render()}else this.showNotification("No blocks were flattened","info",2e3)}updateColorSwatchSelection(){document.querySelectorAll(".color-swatch").forEach(t=>{const e=this.rgbToHex(t.style.background);t.classList.toggle("active",e===this.currentColor.toLowerCase())})}rgbToHex(t){if(t.startsWith("#"))return t.toLowerCase();const e=t.match(/\d+/g);return e?"#"+e.slice(0,3).map(o=>{const i=parseInt(o).toString(16);return i.length===1?"0"+i:i}).join(""):t}generateColorPalette(){var p;const t=new Set;for(const h of this.blockManager.getAllBlocks())t.add(h.color.toLowerCase()),(p=h.emissive)!=null&&p.enabled&&t.add(h.emissive.color.toLowerCase());const e=Array.from(t),o=32,i=8,s=Math.ceil(e.length/i),n=i*o,r=Math.max(s*o+20,o+20),a=document.createElement("canvas");a.width=n,a.height=r;const l=a.getContext("2d");return l.fillStyle="#1a1a1a",l.fillRect(0,0,n,r),l.fillStyle="#ffffff",l.font="12px monospace",l.fillText(`Color Palette (${e.length} colors)`,4,14),e.forEach((h,u)=>{const c=u%i,f=Math.floor(u/i),d=c*o,m=20+f*o;l.fillStyle=h,l.fillRect(d+2,m+2,o-4,o-4),l.strokeStyle="#333333",l.strokeRect(d+2,m+2,o-4,o-4)}),a}updateSelectionUI(t=null){const e=this.blockManager.getSelectedBlocks(),o=e.length;if(o===0){this.selectionProps.style.display="none";return}if(this.selectionProps.style.display="block",o===1){const i=e[0];document.getElementById("prop-type").textContent=i.type,document.getElementById("prop-position").textContent=`${i.gridPosition.x}, ${i.gridPosition.y}, ${i.gridPosition.z}`,document.getElementById("prop-rotation").textContent=`${i.rotation.y}`}else document.getElementById("prop-type").textContent=`${o} blocks`,document.getElementById("prop-position").textContent="multiple",document.getElementById("prop-rotation").textContent="various";document.getElementById("btn-copy").onclick=()=>{o===1?this.clipboard=e[0].toJSON():this.clipboard=e.map(i=>i.toJSON())},document.getElementById("btn-delete-sel").onclick=()=>{this.deleteSelectedBlocks()},this.updateKeyframeMarkers()}deleteSelectedBlocks(){const t=this.blockManager.getSelectedBlocks();if(t.length!==0){for(const e of t)this.history.push(Bi(this.blockManager,e)),this.blockManager.removeBlock(e.id);this.updateSelectionUI()}}setupMenuBar(){document.getElementById("btn-new").addEventListener("click",()=>{confirm("Create new project? Unsaved changes will be lost.")&&(this.projectManager.newProject(),this.updateAnimationSelect(),this.updateLayerUI())}),document.getElementById("btn-save").addEventListener("click",()=>{this.projectManager.save()}),document.getElementById("btn-load").addEventListener("click",()=>{this.fileInput.click()}),document.getElementById("btn-clear").addEventListener("click",()=>{this.clearProject()}),this.setupTemplateMenu(),this.fileInput.addEventListener("change",async i=>{const s=i.target.files[0];if(s)try{await this.projectManager.load(s),this.updateAnimationSelect(),this.updateLayerUI(),this.updateBlockVisibility(),this.showNotification(`Project "${this.projectManager.currentProjectName}" loaded successfully`,"success")}catch{}this.fileInput.value=""}),document.getElementById("btn-export").addEventListener("click",()=>{this.showExportModal()}),this.setupExportModal(),document.getElementById("btn-bake").addEventListener("click",()=>{const i=this.blockManager.getAllBlocks().filter(u=>{var c;return(c=u.emissive)==null?void 0:c.enabled});if(i.length===0){alert('No emissive blocks found. Add blocks with "Enable Glow" checked to bake lighting.');return}console.log("Starting texture-based light bake...");const s=performance.now(),{texture:n,uvData:r,atlasWidth:a,atlasHeight:l}=this.textureBaker.bake(this.blockManager);this.bakedTexture=n,this.bakedUVData=r;const p=this.lightBaker.bake(this.blockManager);this.lightBaker.apply(this.blockManager,p);const h=(performance.now()-s).toFixed(1);console.log(`Light bake completed in ${h}ms (atlas: ${a}x${l})`),alert(`Lighting baked from ${i.length} emissive block(s) in ${h}ms.
Texture atlas: ${a}x${l}
Export to see the result in Blender/Godot.`)}),document.getElementById("btn-clear-bake").addEventListener("click",()=>{this.lightBaker.clear(this.blockManager),this.bakedTexture=null,this.bakedUVData=null,console.log("Baked lighting cleared")}),document.getElementById("btn-undo").addEventListener("click",()=>{this.history.undo()}),document.getElementById("btn-redo").addEventListener("click",()=>{this.history.redo()});const t=document.getElementById("timeline-panel"),e=document.getElementById("btn-toggle-timeline");localStorage.getItem("timelineHidden")==="true"?(t.style.display="none",e.classList.remove("active")):e.classList.add("active"),e.addEventListener("click",()=>{const i=t.style.display==="none";t.style.display=i?"":"none",e.classList.toggle("active",i),localStorage.setItem("timelineHidden",!i)})}toggleUIVisibility(){this.uiHidden===void 0&&(this.uiHidden=!1),this.uiHidden=!this.uiHidden;const t=this.uiHidden?"none":"";["menubar","toolbar","right-panel","timeline-panel","info","vj-panel"].forEach(o=>{const i=document.getElementById(o);i&&(i.style.display=t)}),localStorage.setItem("uiHidden",this.uiHidden),this.uiHidden&&this.showNotification("UI hidden. Press U to restore.","info",3e3)}setupTimeline(){const t=document.getElementById("anim-select"),e=document.getElementById("timeline-slider"),o=document.getElementById("time-display"),i=document.getElementById("anim-loop");document.getElementById("keyframes-container");const s=document.getElementById("anim-duration"),n=document.getElementById("anim-speed"),r=document.getElementById("anim-curve");document.getElementById("btn-add-anim").addEventListener("click",()=>{const a=prompt("Animation name:","Animation");if(a){const l=parseInt(s.value)||2e3,p=this.animator.createAnimation(a,l);this.updateAnimationSelect(),t.value=p.id,this.animator.setCurrentAnimation(p.id),e.max=p.duration,this.showNotification(`Created animation "${a}"`,"success",2e3)}}),document.getElementById("btn-delete-anim").addEventListener("click",()=>{if(this.animator.currentAnimation){const a=this.animator.currentAnimation.name;confirm(`Delete animation "${a}"?`)&&(this.animator.deleteAnimation(this.animator.currentAnimation.id),this.updateAnimationSelect(),t.value="",this.updateKeyframeMarkers(),this.showNotification(`Deleted animation "${a}"`,"info",2e3))}else this.showNotification("No animation selected","warning",2e3)}),t.addEventListener("change",()=>{const a=t.value;if(a){this.animator.setCurrentAnimation(a);const l=this.animator.currentAnimation;e.max=l.duration,s.value=l.duration,i.checked=l.loop,r.value=l.curve||"easeInOut",this.updateKeyframeMarkers()}else this.animator.currentAnimation=null,this.updateKeyframeMarkers()}),s.addEventListener("change",()=>{if(this.animator.currentAnimation){const a=Math.max(100,parseInt(s.value)||2e3);s.value=a,this.animator.currentAnimation.duration=a,e.max=a,this.updateKeyframeMarkers()}}),n.addEventListener("change",()=>{this.animator.playbackSpeed=parseFloat(n.value)}),document.getElementById("btn-play").addEventListener("click",()=>{this.animator.isPlaying?this.animator.pause():this.animator.play()}),document.getElementById("btn-stop").addEventListener("click",()=>{this.animator.stop()}),i.addEventListener("change",()=>{this.animator.currentAnimation&&(this.animator.currentAnimation.loop=i.checked)}),r.addEventListener("change",()=>{this.animator.currentAnimation&&(this.animator.currentAnimation.curve=r.value)}),e.addEventListener("input",()=>{this.animator.setTime(parseInt(e.value))}),document.getElementById("btn-add-keyframe").addEventListener("click",()=>{if(this.animator.currentAnimation){const a=this.blockManager.getSelectedBlocks();if(a.length>0){const l=this.animator.addKeyframesForSelection(a);this.updateKeyframeMarkers();const p=(this.animator.currentTime/1e3).toFixed(2);this.showNotification(`Added keyframe${l>1?"s":""} for ${l} block${l>1?"s":""} at ${p}s`,"success",2e3)}else this.showNotification("Select blocks to add keyframes","warning",2e3)}else this.showNotification("Create an animation first","warning",2e3)}),document.getElementById("btn-remove-keyframe").addEventListener("click",()=>{if(this.animator.currentAnimation){const a=this.blockManager.getSelectedBlocks();if(a.length>0){const l=a.map(h=>h.id),p=this.animator.removeKeyframesForSelection(l);if(this.updateKeyframeMarkers(),p>0){const h=(this.animator.currentTime/1e3).toFixed(2);this.showNotification(`Removed ${p} keyframe${p>1?"s":""} at ${h}s`,"info",2e3)}else this.showNotification("No keyframes at current time for selected blocks","warning",2e3)}else this.showNotification("Select blocks to remove keyframes","warning",2e3)}}),this.animator.onTimeUpdate=a=>{e.value=a,o.textContent=(a/1e3).toFixed(2)+"s"},this.animator.onPlayStateChange=a=>{document.getElementById("btn-play").textContent=a?"":""}}updateAnimationSelect(){const t=document.getElementById("anim-select");t.innerHTML='<option value="">-- No Animation --</option>';for(const e of this.animator.getAllAnimations()){const o=document.createElement("option");o.value=e.id,o.textContent=e.name,t.appendChild(o)}}updateKeyframeMarkers(){const t=document.getElementById("keyframes-container");if(t.innerHTML="",!this.animator.currentAnimation)return;const e=this.animator.currentAnimation.duration,o=this.animator.currentAnimation.keyframes,i=new Set(this.blockManager.getSelectedBlocks().map(n=>n.id)),s=new Map;for(const n of o){s.has(n.time)||s.set(n.time,{total:0,selected:0});const r=s.get(n.time);r.total++,i.has(n.blockId)&&r.selected++}for(const[n,r]of s){const a=document.createElement("div");a.className="keyframe-marker",r.selected>0&&a.classList.add("selected"),a.style.left=`${n/e*100}%`,a.title=`${n}ms - ${r.total} block${r.total>1?"s":""}${r.selected>0?` (${r.selected} selected)`:""}`,a.addEventListener("click",()=>{this.animator.setTime(n)}),t.appendChild(a)}}setupVJ(){const t=document.getElementById("btn-vj"),e=document.getElementById("vj-panel"),o=document.getElementById("vj-preset"),i=document.getElementById("vj-camera-mode"),s=document.getElementById("vj-gain"),n=document.getElementById("vj-sensitivity"),r=document.getElementById("vj-meter-bar"),a=document.getElementById("vj-overlay-meter-bar"),l=document.getElementById("vj-block-distort"),p=document.getElementById("vj-block-distort-val"),h=document.getElementById("vj-vertex-distort"),u=document.getElementById("vj-vertex-distort-val"),c=document.getElementById("vj-reactivity"),f=document.getElementById("vj-reactivity-val"),d=document.getElementById("vj-fullscreen"),m=document.getElementById("vj-exit-fullscreen"),x=document.getElementById("vj-style-name"),g=document.getElementById("vj-camera-name"),b=document.getElementById("vj-preset-name"),z=document.getElementById("toolbar");t.addEventListener("click",async()=>{if(this.vjController.active)this.vjController.stop(),t.classList.remove("active"),e.style.display="none",z.style.display="",this.grid.gridGroup.visible=!0,this.showNotification("VJ Mode stopped","info",2e3);else try{if(!this.tattooRenderer.enabled){this.tattooRenderer.setEnabled(!0);const Y=document.getElementById("tattoo-enabled");Y&&(Y.checked=!0)}await this.vjController.start(),t.classList.add("active"),e.style.display="",z.style.display="none",this.grid.gridGroup.visible=!1,this.showNotification("VJ Mode started  use mic audio","success",3e3)}catch(Y){console.error("VJ start failed:",Y),this.showNotification("VJ Mode failed: "+Y.message,"error",4e3)}}),o.addEventListener("change",Y=>{this.vjController.setPreset(Y.target.value)}),i.addEventListener("change",Y=>{this.vjController.setCameraMode(Y.target.value)}),s.addEventListener("input",Y=>{this.vjController.audioReactor.setGain(parseFloat(Y.target.value))}),n.addEventListener("input",Y=>{this.vjController.audioReactor.setSensitivity(parseFloat(Y.target.value))}),l.addEventListener("input",Y=>{const V=parseFloat(Y.target.value);this.vjController.meshReactor.setBlockDistortion(V),p.textContent=V.toFixed(2)}),h.addEventListener("input",Y=>{const V=parseFloat(Y.target.value);this.vjController.meshReactor.setVertexDistortion(V),u.textContent=V.toFixed(2)}),document.getElementById("vj-movement-mode").addEventListener("change",Y=>{this.vjController.meshReactor.setMovementMode(Y.target.value)});const C=document.getElementById("vj-color-react"),B=document.getElementById("vj-color-react-val");C.addEventListener("input",Y=>{const V=parseFloat(Y.target.value);this.vjController.meshReactor.setColorReactivity(V),B.textContent=V.toFixed(2)});const A=document.getElementById("vj-scene-folder"),M=document.getElementById("vj-load-scenes"),_=document.getElementById("vj-scene-label"),P=document.getElementById("vj-scene-index"),k=document.getElementById("vj-scene-prev"),T=document.getElementById("vj-scene-next");this.vjController._layerManager=this.layerManager,M.addEventListener("click",()=>A.click()),A.addEventListener("change",async Y=>{const V=await this.vjController.sceneBank.loadFolder(Y.target.files);_.textContent=`${V} scene${V!==1?"s":""}`,P.textContent=(V>0,"-"),V>0?this.showNotification(`Loaded ${V} scene${V!==1?"s":""}`,"success",2e3):this.showNotification("No valid .blocks files found","warning",3e3)}),this.vjController.sceneBank.onSceneChange=(Y,V,W)=>{P.textContent=`${Y+1}/${W}`,_.textContent=V,this.vjController.meshReactor.enabled&&this.vjController.meshReactor.setEnabled(!0),this.vjController.particleSpawner.updateSceneBounds(this.blockManager),this.updateBlockCount()},k.addEventListener("click",()=>{this.vjController.sceneBank.previous(this.blockManager,this.layerManager)}),T.addEventListener("click",()=>{this.vjController.sceneBank.next(this.blockManager,this.layerManager)});const F=document.getElementById("vj-particles-enabled"),D=document.getElementById("vj-particle-pool");F.addEventListener("change",Y=>{this.vjController.particleSpawner.setEnabled(Y.target.checked),Y.target.checked&&this.vjController.particleSpawner.updateSceneBounds(this.blockManager)}),D.addEventListener("change",Y=>{this.vjController.particleSpawner.setPoolSize(parseInt(Y.target.value))});const J=document.getElementById("vj-generative-enabled"),Z=document.getElementById("vj-generative-clear"),rt=document.getElementById("vj-gen-rate"),$=document.getElementById("vj-gen-rate-val"),et=document.getElementById("vj-gen-ttl"),N=document.getElementById("vj-gen-ttl-val");J.addEventListener("change",Y=>{const V=this.vjController.audioGenerative;Y.target.checked?(V.initFromScene(this.blockManager),V.setEnabled(!0)):V.setEnabled(!1)}),Z.addEventListener("click",()=>{this.vjController.audioGenerative.clear()}),rt.addEventListener("input",Y=>{const V=parseInt(Y.target.value);this.vjController.audioGenerative.setGrowthRate(V),$.textContent=V}),et.addEventListener("input",Y=>{const V=parseInt(Y.target.value);this.vjController.audioGenerative.setTTL(V),N.textContent=V+"s"}),c.addEventListener("input",Y=>{const V=parseFloat(Y.target.value);this.vjController.reactivity=V,f.textContent=V.toFixed(1)}),d.addEventListener("click",()=>{this.vjController.enterPerformanceMode()}),m.addEventListener("click",()=>{this.vjController.exitPerformanceMode()}),this._vjMeterBar=r,this._vjOverlayMeterBar=a,this._vjStyleNameEl=x,this._vjCameraNameEl=g,this._vjPresetNameEl=b,this.vjController.onStateChange=Y=>{t.classList.toggle("active",Y),e.style.display=Y?"":"none",z.style.display=Y?"none":"",this.grid.gridGroup.visible=!Y};const L=document.getElementById("render-style");L&&L.addEventListener("change",()=>{this.vjController.active&&setTimeout(()=>this.vjController.onStyleChanged(),50)})}setupKeyboardShortcuts(){window.addEventListener("keydown",t=>{if(!(t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA")){switch(t.key.toLowerCase()){case"1":this.setTool("place");break;case"2":this.setTool("delete");break;case"3":this.setTool("select");break;case"4":this.setTool("paint");break;case"5":this.setTool("pick");break;case"6":this.setTool("shape");break;case"r":this.rotateBlock();break;case"u":this.toggleUIVisibility();break;case"z":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.history.undo());break;case"y":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.history.redo());break;case"c":if((t.ctrlKey||t.metaKey)&&this.blockManager.getSelectionCount()>0){const e=this.blockManager.getSelectedBlocks();e.length===1?this.clipboard=e[0].toJSON():this.clipboard=e.map(o=>o.toJSON())}break;case"v":if((t.ctrlKey||t.metaKey)&&this.clipboard)if(Array.isArray(this.clipboard))for(const e of this.clipboard){const o={...e};o.position={x:o.position.x+1,y:o.position.y,z:o.position.z+1},delete o.id;const i=this.blockManager.addBlock(o);i&&this.history.push(co(this.blockManager,o,i))}else{const e={...this.clipboard};e.position={x:e.position.x+1,y:e.position.y,z:e.position.z+1},delete e.id;const o=this.blockManager.addBlock(e);o&&this.history.push(co(this.blockManager,e,o))}break;case"delete":case"backspace":this.blockManager.getSelectionCount()>0&&(t.preventDefault(),this.deleteSelectedBlocks());break;case" ":t.preventDefault(),this.animator.currentAnimation&&(this.animator.isPlaying?this.animator.pause():this.animator.play());break;case"k":case"+":case"=":if(this.animator.currentAnimation){const e=this.blockManager.getSelectedBlocks();if(e.length>0){const o=this.animator.addKeyframesForSelection(e);this.updateKeyframeMarkers();const i=(this.animator.currentTime/1e3).toFixed(2);this.showNotification(`Added keyframe${o>1?"s":""} for ${o} block${o>1?"s":""} at ${i}s`,"success",2e3)}else this.showNotification("Select blocks to add keyframes","warning",2e3)}else this.showNotification("Create an animation first (+ Anim button)","warning",2e3);break;case"-":case"_":if(this.animator.currentAnimation){const e=this.blockManager.getSelectedBlocks();if(e.length>0){const o=e.map(s=>s.id),i=this.animator.removeKeyframesForSelection(o);if(this.updateKeyframeMarkers(),i>0){const s=(this.animator.currentTime/1e3).toFixed(2);this.showNotification(`Removed ${i} keyframe${i>1?"s":""} at ${s}s`,"info",2e3)}else this.showNotification("No keyframes at current time for selected blocks","warning",2e3)}else this.showNotification("Select blocks to remove keyframes","warning",2e3)}break}switch(t.key){case"ArrowUp":t.preventDefault(),this.moveSelectedBlock(0,0,-1);break;case"ArrowDown":t.preventDefault(),this.moveSelectedBlock(0,0,1);break;case"ArrowLeft":t.preventDefault(),this.moveSelectedBlock(-1,0,0);break;case"ArrowRight":t.preventDefault(),this.moveSelectedBlock(1,0,0);break;case"PageUp":t.preventDefault(),this.moveSelectedBlock(0,1,0);break;case"PageDown":t.preventDefault(),this.moveSelectedBlock(0,-1,0);break}}})}autoSave(){try{const t=this.engine.camera,e=this.engine.controls.target,o={blocks:this.blockManager.toJSON(),animations:this.animator.toJSON(),layers:this.layerManager.toJSON(),cameraBookmarks:this.cameraBookmarks.toJSON(),currentColor:this.currentColor,currentBlockType:this.currentBlockType,currentRotation:this.currentRotation,camera:{position:{x:t.position.x,y:t.position.y,z:t.position.z},target:{x:e.x,y:e.y,z:e.z}}};localStorage.setItem("blocksProject",JSON.stringify(o))}catch(t){console.warn("Auto-save failed:",t)}}autoLoad(){try{const t=localStorage.getItem("blocksProject");if(!t)return;const e=JSON.parse(t);if(e.layers&&(this.layerManager.fromJSON(e.layers),this.updateLayerUI()),e.blocks&&e.blocks.length>0&&(this.blockManager.fromJSON(e.blocks),this.updateBlockVisibility()),e.animations&&(this.animator.fromJSON(e.animations),this.updateAnimationSelect()),e.cameraBookmarks&&(this.cameraBookmarks.fromJSON(e.cameraBookmarks),this.updateCameraBookmarksUI()),e.currentColor&&(this.currentColor=e.currentColor,this.colorInput.value=e.currentColor),e.currentBlockType&&(this.currentBlockType=e.currentBlockType,this.setBlockType(e.currentBlockType)),e.currentRotation!==void 0&&(this.currentRotation=e.currentRotation),e.camera){const o=e.camera.position,i=e.camera.target;o&&this.engine.camera.position.set(o.x,o.y,o.z),i&&this.engine.controls.target.set(i.x,i.y,i.z),this.engine.controls.update()}console.log("Project loaded from localStorage")}catch(t){console.warn("Auto-load failed:",t)}}showNotification(t,e="info",o=5e3){if(!this.notificationsEl)return;const i={info:"i",success:"",warning:"!",error:""},s=document.createElement("div");return s.className=`notification ${e}`,s.innerHTML=`
      <span class="icon">${i[e]||i.info}</span>
      <span class="message">${t}</span>
      <button class="close-btn">&times;</button>
    `,s.querySelector(".close-btn").addEventListener("click",()=>{this.dismissNotification(s)}),this.notificationsEl.appendChild(s),o>0&&setTimeout(()=>{this.dismissNotification(s)},o),s}dismissNotification(t){!t||!t.parentNode||(t.classList.add("fade-out"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))}clearProject(){confirm("Clear all blocks? This cannot be undone.")&&(this.blockManager.clear(),this.animator.clear(),this.layerManager.clear(),this.cameraBookmarks.clear(),this.history.clear(),localStorage.removeItem("blocksProject"),this.updateAnimationSelect(),this.updateLayerUI(),this.updateCameraBookmarksUI(),this.updateSelectionUI(null))}setupTemplateMenu(){const t=document.getElementById("templates-modal"),e=document.getElementById("templates-list");xl().forEach((i,s)=>{const n=document.createElement("div");n.className="template-category",s>2&&n.classList.add("collapsed");const r=document.createElement("div");r.className="template-category-header",r.innerHTML=`
        <span class="arrow"></span>
        <span class="label">${i.label}</span>
        <span class="count">${i.templates.length}</span>
      `,r.addEventListener("click",()=>{n.classList.toggle("collapsed")}),n.appendChild(r);const a=document.createElement("div");a.className="template-category-content",i.templates.forEach(l=>{const p=document.createElement("button");p.className="template-item",p.innerHTML=`
          <span class="template-name">${l.name}</span>
          <span class="template-desc">${l.description}</span>
        `,p.addEventListener("click",()=>{this.loadTemplate(l.id),this.hideTemplatesModal()}),a.appendChild(p)}),n.appendChild(a),e.appendChild(n)}),document.getElementById("btn-templates").addEventListener("click",()=>{this.showTemplatesModal()}),document.getElementById("templates-modal-close").addEventListener("click",()=>{this.hideTemplatesModal()}),t.addEventListener("click",i=>{i.target===t&&this.hideTemplatesModal()})}showTemplatesModal(){document.getElementById("templates-modal").style.display="flex"}hideTemplatesModal(){document.getElementById("templates-modal").style.display="none"}loadTemplate(t){const e=gl(t);if(!e)return;(this.blockManager.getBlockCount()>0?confirm(`Add "${e.name}" to existing blocks?

Click OK to add, Cancel to replace all.`):!1)||(this.blockManager.clear(),this.history.clear());let i=0;for(const s of e.blocks){const n={type:s.type||"cube",position:{...s.position},color:s.color||this.currentColor,rotation:s.rotation||{x:0,y:0,z:0},emissive:s.emissive||null};this.blockManager.wouldOverlapAt(n.type,n.position,{w:1,h:1,d:1},null,1,n.rotation)||this.blockManager.addBlock(n)&&i++}console.log(`Placed ${i}/${e.blocks.length} blocks from template "${e.name}"`)}showExportModal(){const t=document.getElementById("export-modal");t.style.display="flex",this.updateExportStats()}hideExportModal(){const t=document.getElementById("export-modal");t.style.display="none"}updateExportStats(){const t=document.getElementById("opt-face-cull").checked,e=document.getElementById("opt-merge-cubes").checked,o=this.exporter.getOptimizationStats(this.blockManager,{cullFaces:t,mergeCubes:e});document.getElementById("stat-blocks").textContent=o.blockCount,document.getElementById("stat-faces").textContent=o.originalFaces,document.getElementById("stat-optimized").textContent=`${o.optimizedFaces} (-${o.reduction}%)`}setupExportModal(){const t=document.getElementById("export-modal");document.getElementById("export-modal-close").addEventListener("click",()=>{this.hideExportModal()}),document.getElementById("export-cancel").addEventListener("click",()=>{this.hideExportModal()}),t.addEventListener("click",e=>{e.target===t&&this.hideExportModal()}),document.getElementById("opt-face-cull").addEventListener("change",()=>{this.updateExportStats()}),document.getElementById("opt-merge-cubes").addEventListener("change",()=>{this.updateExportStats()}),document.getElementById("export-confirm").addEventListener("click",async()=>{await this.performExport()})}async performExport(){const t=document.querySelector('input[name="export-format"][value="glb"]').checked,e=document.getElementById("opt-face-cull").checked,o=document.getElementById("opt-merge-cubes").checked,i=document.getElementById("opt-material-batch").checked,s=document.getElementById("opt-deduplicate").checked,n=document.getElementById("opt-merge-all").checked,r=document.getElementById("opt-instancing").checked,a=document.getElementById("inc-animations").checked,l=document.getElementById("inc-baked-lighting").checked,p=document.getElementById("dbg-lightmap").checked,h=document.getElementById("dbg-colors").checked,u=document.getElementById("dbg-palette").checked,c=document.getElementById("dbg-json").checked,f=document.getElementById("export-confirm"),d=f.textContent;f.textContent="Exporting...",f.disabled=!0;try{const m=await this.exporter.exportScene(this.blockManager,{binary:t,includeAnimations:a,animator:this.animator,bakedTexture:l?this.bakedTexture:null,uvData:l?this.bakedUVData:null,cullFaces:e,mergeCubes:o,batchMaterials:i,deduplicateVertices:s,mergeAll:n,useInstancing:r}),x=t?"model.glb":"model.gltf";if(this.exporter.downloadFile(m,x,t),c&&t){const g=await this.exporter.exportScene(this.blockManager,{binary:!1,includeAnimations:a,animator:this.animator,bakedTexture:l?this.bakedTexture:null,uvData:l?this.bakedUVData:null});this.exporter.downloadFile(g,"model.gltf",!1)}if(p&&this.bakedTexture&&this.lightBaker.downloadCanvasAsPNG(this.bakedTexture,"baked_lightmap.png"),h){const g=this.lightBaker.generateDebugTexture(this.blockManager);this.lightBaker.downloadCanvasAsPNG(g,"debug_colors.png")}if(u){const g=this.generateColorPalette();this.lightBaker.downloadCanvasAsPNG(g,"color_palette.png")}console.log("Export completed successfully"),this.hideExportModal(),this.showNotification("Export completed successfully","success")}catch(m){this.showNotification("Export failed: "+m.message,"error"),console.error("Export error:",m)}finally{f.textContent=d,f.disabled=!1}}}const d0=new u0;window.appInstance=d0;
