var br=Object.defineProperty;var zr=(u,t,e)=>t in u?br(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var Xe=(u,t,e)=>zr(u,typeof t!="symbol"?t+"":t,e);import{C as vr,V as X,M as le,T as Je,Q as Oe,S as Ms,a as nt,R as mi,P as xi,b as zt,c as ri,d as ot,e as Zn,W as Fr,f as wr,g as kr,A as Br,D as Cr,H as Ar,G as ps,h as Mr,i as gi,j as Ae,k as It,B as ce,L as eo,l as oo,m as Ct,n as Er,o as ai,E as wo,p as Sr,q as io,r as so,s as Gn,t as bo,u as Es,v as hs,w as _r,N as xe,x as ys,y as Ut,z as Nt,F as us,I as wi,J as Dr,K as Tr,O as ds,U as li,X as Pr,Y as Ir,Z as Rr,_ as ko,$ as Lr,a0 as Ur,a1 as Or,a2 as Nr,a3 as jr,a4 as Xr,a5 as _t,a6 as bi,a7 as Yn,a8 as Bo,a9 as Zr,aa as Gr,ab as fs,ac as Yr,ad as Vr,ae as $r,af as Vn,ag as Hr,ah as Qe,ai as ci,aj as Ce,ak as Qo,al as Wr,am as qr,an as Kr,ao as Jr,ap as Qr,aq as ta,ar as ea,as as oa,at as ia,au as sa,av as na,aw as ne,ax as Qt,ay as Gt,az as ra,aA as Ss,aB as je,aC as aa,aD as _s}from"./BlockTypes.js";const Ds={type:"change"},ms={type:"start"},$n={type:"end"},Mo=new mi,Ts=new xi,la=Math.cos(70*zt.DEG2RAD),Mt=new X,Zt=2*Math.PI,ft={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},ki=1e-6;class ca extends vr{constructor(t,e=null){super(t,e),this.state=ft.NONE,this.enabled=!0,this.target=new X,this.cursor=new X,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:le.ROTATE,MIDDLE:le.DOLLY,RIGHT:le.PAN},this.touches={ONE:Je.ROTATE,TWO:Je.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new X,this._lastQuaternion=new Oe,this._lastTargetPosition=new X,this._quat=new Oe().setFromUnitVectors(t.up,new X(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new Ms,this._sphericalDelta=new Ms,this._scale=1,this._panOffset=new X,this._rotateStart=new nt,this._rotateEnd=new nt,this._rotateDelta=new nt,this._panStart=new nt,this._panEnd=new nt,this._panDelta=new nt,this._dollyStart=new nt,this._dollyEnd=new nt,this._dollyDelta=new nt,this._dollyDirection=new X,this._mouse=new nt,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=ha.bind(this),this._onPointerDown=pa.bind(this),this._onPointerUp=ya.bind(this),this._onContextMenu=ba.bind(this),this._onMouseWheel=fa.bind(this),this._onKeyDown=ma.bind(this),this._onTouchStart=xa.bind(this),this._onTouchMove=ga.bind(this),this._onMouseDown=ua.bind(this),this._onMouseMove=da.bind(this),this._interceptControlDown=za.bind(this),this._interceptControlUp=va.bind(this),this.domElement!==null&&this.connect(),this.update()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(t){t.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=t}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(Ds),this.update(),this.state=ft.NONE}update(t=null){const e=this.object.position;Mt.copy(e).sub(this.target),Mt.applyQuaternion(this._quat),this._spherical.setFromVector3(Mt),this.autoRotate&&this.state===ft.NONE&&this._rotateLeft(this._getAutoRotationAngle(t)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let o=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(o)&&isFinite(i)&&(o<-Math.PI?o+=Zt:o>Math.PI&&(o-=Zt),i<-Math.PI?i+=Zt:i>Math.PI&&(i-=Zt),o<=i?this._spherical.theta=Math.max(o,Math.min(i,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(o+i)/2?Math.max(o,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let s=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const n=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),s=n!=this._spherical.radius}if(Mt.setFromSpherical(this._spherical),Mt.applyQuaternion(this._quatInverse),e.copy(this.target).add(Mt),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let n=null;if(this.object.isPerspectiveCamera){const r=Mt.length();n=this._clampDistance(r*this._scale);const a=r-n;this.object.position.addScaledVector(this._dollyDirection,a),this.object.updateMatrixWorld(),s=!!a}else if(this.object.isOrthographicCamera){const r=new X(this._mouse.x,this._mouse.y,0);r.unproject(this.object);const a=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),s=a!==this.object.zoom;const l=new X(this._mouse.x,this._mouse.y,0);l.unproject(this.object),this.object.position.sub(l).add(r),this.object.updateMatrixWorld(),n=Mt.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;n!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(n).add(this.object.position):(Mo.origin.copy(this.object.position),Mo.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(Mo.direction))<la?this.object.lookAt(this.target):(Ts.setFromNormalAndCoplanarPoint(this.object.up,this.target),Mo.intersectPlane(Ts,this.target))))}else if(this.object.isOrthographicCamera){const n=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),n!==this.object.zoom&&(this.object.updateProjectionMatrix(),s=!0)}return this._scale=1,this._performCursorZoom=!1,s||this._lastPosition.distanceToSquared(this.object.position)>ki||8*(1-this._lastQuaternion.dot(this.object.quaternion))>ki||this._lastTargetPosition.distanceToSquared(this.target)>ki?(this.dispatchEvent(Ds),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(t){return t!==null?Zt/60*this.autoRotateSpeed*t:Zt/60/60*this.autoRotateSpeed}_getZoomScale(t){const e=Math.abs(t*.01);return Math.pow(.95,this.zoomSpeed*e)}_rotateLeft(t){this._sphericalDelta.theta-=t}_rotateUp(t){this._sphericalDelta.phi-=t}_panLeft(t,e){Mt.setFromMatrixColumn(e,0),Mt.multiplyScalar(-t),this._panOffset.add(Mt)}_panUp(t,e){this.screenSpacePanning===!0?Mt.setFromMatrixColumn(e,1):(Mt.setFromMatrixColumn(e,0),Mt.crossVectors(this.object.up,Mt)),Mt.multiplyScalar(t),this._panOffset.add(Mt)}_pan(t,e){const o=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;Mt.copy(i).sub(this.target);let s=Mt.length();s*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*t*s/o.clientHeight,this.object.matrix),this._panUp(2*e*s/o.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(t*(this.object.right-this.object.left)/this.object.zoom/o.clientWidth,this.object.matrix),this._panUp(e*(this.object.top-this.object.bottom)/this.object.zoom/o.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(t,e){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const o=this.domElement.getBoundingClientRect(),i=t-o.left,s=e-o.top,n=o.width,r=o.height;this._mouse.x=i/n*2-1,this._mouse.y=-(s/r)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(t){return Math.max(this.minDistance,Math.min(this.maxDistance,t))}_handleMouseDownRotate(t){this._rotateStart.set(t.clientX,t.clientY)}_handleMouseDownDolly(t){this._updateZoomParameters(t.clientX,t.clientX),this._dollyStart.set(t.clientX,t.clientY)}_handleMouseDownPan(t){this._panStart.set(t.clientX,t.clientY)}_handleMouseMoveRotate(t){this._rotateEnd.set(t.clientX,t.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const e=this.domElement;this._rotateLeft(Zt*this._rotateDelta.x/e.clientHeight),this._rotateUp(Zt*this._rotateDelta.y/e.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(t){this._dollyEnd.set(t.clientX,t.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(t){this._panEnd.set(t.clientX,t.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(t){this._updateZoomParameters(t.clientX,t.clientY),t.deltaY<0?this._dollyIn(this._getZoomScale(t.deltaY)):t.deltaY>0&&this._dollyOut(this._getZoomScale(t.deltaY)),this.update()}_handleKeyDown(t){let e=!1;switch(t.code){case this.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateUp(Zt*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,this.keyPanSpeed),e=!0;break;case this.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateUp(-Zt*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,-this.keyPanSpeed),e=!0;break;case this.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateLeft(Zt*this.rotateSpeed/this.domElement.clientHeight):this._pan(this.keyPanSpeed,0),e=!0;break;case this.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateLeft(-Zt*this.rotateSpeed/this.domElement.clientHeight):this._pan(-this.keyPanSpeed,0),e=!0;break}e&&(t.preventDefault(),this.update())}_handleTouchStartRotate(t){if(this._pointers.length===1)this._rotateStart.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),o=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);this._rotateStart.set(o,i)}}_handleTouchStartPan(t){if(this._pointers.length===1)this._panStart.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),o=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);this._panStart.set(o,i)}}_handleTouchStartDolly(t){const e=this._getSecondPointerPosition(t),o=t.pageX-e.x,i=t.pageY-e.y,s=Math.sqrt(o*o+i*i);this._dollyStart.set(0,s)}_handleTouchStartDollyPan(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enablePan&&this._handleTouchStartPan(t)}_handleTouchStartDollyRotate(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enableRotate&&this._handleTouchStartRotate(t)}_handleTouchMoveRotate(t){if(this._pointers.length==1)this._rotateEnd.set(t.pageX,t.pageY);else{const o=this._getSecondPointerPosition(t),i=.5*(t.pageX+o.x),s=.5*(t.pageY+o.y);this._rotateEnd.set(i,s)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const e=this.domElement;this._rotateLeft(Zt*this._rotateDelta.x/e.clientHeight),this._rotateUp(Zt*this._rotateDelta.y/e.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(t){if(this._pointers.length===1)this._panEnd.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),o=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);this._panEnd.set(o,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(t){const e=this._getSecondPointerPosition(t),o=t.pageX-e.x,i=t.pageY-e.y,s=Math.sqrt(o*o+i*i);this._dollyEnd.set(0,s),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const n=(t.pageX+e.x)*.5,r=(t.pageY+e.y)*.5;this._updateZoomParameters(n,r)}_handleTouchMoveDollyPan(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enablePan&&this._handleTouchMovePan(t)}_handleTouchMoveDollyRotate(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enableRotate&&this._handleTouchMoveRotate(t)}_addPointer(t){this._pointers.push(t.pointerId)}_removePointer(t){delete this._pointerPositions[t.pointerId];for(let e=0;e<this._pointers.length;e++)if(this._pointers[e]==t.pointerId){this._pointers.splice(e,1);return}}_isTrackingPointer(t){for(let e=0;e<this._pointers.length;e++)if(this._pointers[e]==t.pointerId)return!0;return!1}_trackPointer(t){let e=this._pointerPositions[t.pointerId];e===void 0&&(e=new nt,this._pointerPositions[t.pointerId]=e),e.set(t.pageX,t.pageY)}_getSecondPointerPosition(t){const e=t.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[e]}_customWheelEvent(t){const e=t.deltaMode,o={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(e){case 1:o.deltaY*=16;break;case 2:o.deltaY*=100;break}return t.ctrlKey&&!this._controlActive&&(o.deltaY*=10),o}}function pa(u){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(u.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(u)&&(this._addPointer(u),u.pointerType==="touch"?this._onTouchStart(u):this._onMouseDown(u)))}function ha(u){this.enabled!==!1&&(u.pointerType==="touch"?this._onTouchMove(u):this._onMouseMove(u))}function ya(u){switch(this._removePointer(u),this._pointers.length){case 0:this.domElement.releasePointerCapture(u.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent($n),this.state=ft.NONE;break;case 1:const t=this._pointers[0],e=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:e.x,pageY:e.y});break}}function ua(u){let t;switch(u.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case le.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(u),this.state=ft.DOLLY;break;case le.ROTATE:if(u.ctrlKey||u.metaKey||u.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(u),this.state=ft.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(u),this.state=ft.ROTATE}break;case le.PAN:if(u.ctrlKey||u.metaKey||u.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(u),this.state=ft.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(u),this.state=ft.PAN}break;default:this.state=ft.NONE}this.state!==ft.NONE&&this.dispatchEvent(ms)}function da(u){switch(this.state){case ft.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(u);break;case ft.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(u);break;case ft.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(u);break}}function fa(u){this.enabled===!1||this.enableZoom===!1||this.state!==ft.NONE||(u.preventDefault(),this.dispatchEvent(ms),this._handleMouseWheel(this._customWheelEvent(u)),this.dispatchEvent($n))}function ma(u){this.enabled===!1||this.enablePan===!1||this._handleKeyDown(u)}function xa(u){switch(this._trackPointer(u),this._pointers.length){case 1:switch(this.touches.ONE){case Je.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(u),this.state=ft.TOUCH_ROTATE;break;case Je.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(u),this.state=ft.TOUCH_PAN;break;default:this.state=ft.NONE}break;case 2:switch(this.touches.TWO){case Je.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(u),this.state=ft.TOUCH_DOLLY_PAN;break;case Je.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(u),this.state=ft.TOUCH_DOLLY_ROTATE;break;default:this.state=ft.NONE}break;default:this.state=ft.NONE}this.state!==ft.NONE&&this.dispatchEvent(ms)}function ga(u){switch(this._trackPointer(u),this.state){case ft.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(u),this.update();break;case ft.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(u),this.update();break;case ft.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(u),this.update();break;case ft.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(u),this.update();break;default:this.state=ft.NONE}}function ba(u){this.enabled!==!1&&u.preventDefault()}function za(u){u.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function va(u){u.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}class Fa{constructor(t){Xe(this,"animate",()=>{if(!this.isRunning)return;this.animationFrameId=requestAnimationFrame(this.animate);const t=this.clock.getDelta();this.controls.update(),this.onUpdate&&this.onUpdate(t),this.onVJUpdate&&this.onVJUpdate(t),this.customRender?this.customRender():this.renderer.render(this.scene,this.camera)});this.canvas=t,this.scene=new ri,this.scene.background=new ot(1710638),this.setupRenderer(),this.setupCamera(),this.setupLights(),this.setupControls(),this.clock=new Zn,this.onUpdate=null,this.onVJUpdate=null,this.customRender=null,this.animationFrameId=null,this.isRunning=!1,this._resizeHandler=()=>this.onResize(),window.addEventListener("resize",this._resizeHandler),this.onResize()}setupRenderer(){this.renderer=new Fr({canvas:this.canvas,antialias:!0,preserveDrawingBuffer:!0}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=wr}setupCamera(){this.camera=new kr(60,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(10,10,10),this.camera.lookAt(0,0,0)}setupLights(){const t=new Br(16777215,.4);this.scene.add(t);const e=new Cr(16777215,.8);e.position.set(10,20,10),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-20,e.shadow.camera.right=20,e.shadow.camera.top=20,e.shadow.camera.bottom=-20,this.scene.add(e);const o=new Ar(8900331,3550502,.3);this.scene.add(o)}setupControls(){this.controls=new ca(this.camera,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.1,this.controls.minDistance=5,this.controls.maxDistance=50,this.controls.maxPolarAngle=Math.PI,this.controls.mouseButtons={LEFT:null,MIDDLE:le.DOLLY,RIGHT:le.ROTATE},this.controls.enablePan=!0,window.addEventListener("keydown",t=>{t.key==="Shift"&&(this.controls.mouseButtons.RIGHT=le.PAN)}),window.addEventListener("keyup",t=>{t.key==="Shift"&&(this.controls.mouseButtons.RIGHT=le.ROTATE)})}onResize(){const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}start(){this.isRunning||(this.isRunning=!0,this.animate())}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}dispose(){this.stop(),window.removeEventListener("resize",this._resizeHandler),this.renderer.dispose(),this.controls.dispose()}}class wa{constructor(t,e={}){this.scene=t,this.cellSize=e.cellSize||1,this.gridSize=e.gridSize||20,this.snapIncrement=1,this.gridGroup=new ps,this.gridGroup.name="grid",this.scene.add(this.gridGroup),this.createGridPlane(),this.createMultiLevelGrid()}createGridPlane(){const t=new Mr(this.gridSize*this.cellSize*2,this.gridSize*this.cellSize*2),e=new gi({visible:!1,side:Ae});this.plane=new It(t,e),this.plane.rotation.x=-Math.PI/2,this.plane.position.y=0,this.plane.name="gridPlane",this.scene.add(this.plane)}createMultiLevelGrid(){const e=this.gridSize*this.cellSize;this.fineGrid=this.createGridLevel(e,1,3816010,.6),this.fineGrid.position.y=.001,this.gridGroup.add(this.fineGrid),this.mediumGrid=this.createGridLevel(e,5,4868714,.6),this.mediumGrid.position.y=.002,this.gridGroup.add(this.mediumGrid),this.majorGrid=this.createGridLevel(e,10,6974106,.8),this.majorGrid.position.y=.003,this.gridGroup.add(this.majorGrid),this.createOriginAxes(e)}createGridLevel(t,e,o,i){const s=[];for(let a=-t;a<=t;a+=e){const l=e<5&&a%5===0,p=e<10&&a%10===0;l||p||(s.push(new X(-t,0,a)),s.push(new X(t,0,a)),s.push(new X(a,0,-t)),s.push(new X(a,0,t)))}const n=new ce().setFromPoints(s),r=new eo({color:o,transparent:!0,opacity:i});return new oo(n,r)}createOriginAxes(t){const e=[new X(-t,0,0),new X(t,0,0)],o=new ce().setFromPoints(e),i=new eo({color:8930372,transparent:!0,opacity:.7});this.xAxis=new oo(o,i),this.xAxis.position.y=.004,this.gridGroup.add(this.xAxis);const s=[new X(0,0,-t),new X(0,0,t)],n=new ce().setFromPoints(s),r=new eo({color:4473992,transparent:!0,opacity:.7});this.zAxis=new oo(n,r),this.zAxis.position.y=.004,this.gridGroup.add(this.zAxis)}snapToGrid(t){if(this.snapIncrement===0)return t.clone();const e=this.snapIncrement;return new X(Math.round(t.x/e)*e,Math.round(t.y/e)*e,Math.round(t.z/e)*e)}worldToGrid(t){const e=this.snapIncrement===0?.01:this.snapIncrement;return{x:Math.round(t.x/e)*e,y:Math.round(t.y/e)*e,z:Math.round(t.z/e)*e}}gridToWorld(t){return new X(t.x*this.cellSize,t.y*this.cellSize,t.z*this.cellSize)}getRaycastPlane(){return this.plane}dispose(){this.scene.remove(this.plane),this.scene.remove(this.gridGroup),this.plane.geometry.dispose(),this.plane.material.dispose(),[this.fineGrid,this.mediumGrid,this.majorGrid,this.xAxis,this.zAxis].forEach(t=>{t&&(t.geometry.dispose(),t.material.dispose())})}}const Ie=["east","west","top","bottom","south","north"],ka={east:0,west:1,top:2,bottom:3,south:4,north:5};class Ba{constructor(t){this.textureManager=t,this.selectedFace=null}getFaceFromNormal(t){const e=Math.abs(t.x),o=Math.abs(t.y),i=Math.abs(t.z);return e>o&&e>i?t.x>0?"east":"west":o>e&&o>i?t.y>0?"top":"bottom":t.z>0?"south":"north"}applyMaterialToFace(t,e,o){return ka[e]===void 0?!1:(t.faces[e]={direction:e,materialId:o,uvRotation:0,uvFlip:{x:!1,y:!1}},this.updateBlockMaterials(t),!0)}applyMaterialToAllFaces(t,e){Ie.forEach(o=>{t.faces[o]={direction:o,materialId:e,uvRotation:0,uvFlip:{x:!1,y:!1}}}),this.updateBlockMaterials(t)}updateBlockMaterials(t){const e=Ie.map(o=>{const i=t.faces[o];if(i&&i.materialId){const s=this.textureManager.createThreeMaterial(i.materialId);if(s)return s}return new Ct({color:t.color,roughness:.7,metalness:.1})});Array.isArray(t.mesh.material)?t.mesh.material.forEach(o=>o.dispose()):t.mesh.material&&t.mesh.material.dispose(),t.mesh.material=e}rotateFaceUV(t,e,o=90){const i=t.faces[e];i&&(i.uvRotation=(i.uvRotation+o)%360,this.updateBlockMaterials(t))}flipFaceUV(t,e,o="x"){const i=t.faces[e];i&&(i.uvFlip[o]=!i.uvFlip[o],this.updateBlockMaterials(t))}pickMaterialFromFace(t,e){const o=t.faces[e];return o?o.materialId:null}}let Ca=0;class xs{constructor(t={}){this.id=t.id||`block_${++Ca}`,this.type=t.type||"cube",this.gridPosition=t.position||{x:0,y:0,z:0},this.dimensions=t.dimensions||{w:1,h:1,d:1},this.rotation=t.rotation||{x:0,y:0,z:0},this.color=t.color||"#5588cc",this.layerId=t.layerId||"default",this.scale=t.scale||1,this.emissive=t.emissive||{enabled:!1,color:"#ffaa00",intensity:1,radius:3},this.faces={},t.faces?Ie.forEach(e=>{t.faces[e]?this.faces[e]={...t.faces[e]}:this.faces[e]={direction:e,materialId:null,color:null,uvRotation:0,uvFlip:{x:!1,y:!1}}}):Ie.forEach(e=>{this.faces[e]={direction:e,materialId:null,color:null,uvRotation:0,uvFlip:{x:!1,y:!1}}}),this.mesh=null,this.light=null,this.createMesh()}createMesh(){const e=(ai[this.type]||ai.cube)(this.dimensions);this.scale>1&&e.scale(this.scale,this.scale,this.scale);const o=e.groups&&e.groups.length===6;let i;o?i=Ie.map(s=>{const n=this.faces[s],r=n&&n.color?n.color:this.color,a=new Ct({color:r,roughness:.7,metalness:.1,side:Ae});return this.emissive.enabled&&(a.emissive=new ot(this.emissive.color),a.emissiveIntensity=this.emissive.intensity),a}):(i=new Ct({color:this.color,roughness:.7,metalness:.1,side:Ae}),this.emissive.enabled&&(i.emissive=new ot(this.emissive.color),i.emissiveIntensity=this.emissive.intensity)),this.mesh=new It(e,i),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.mesh.userData.blockId=this.id,this.mesh.userData.block=this,this.createEdges(e),this.emissive.enabled&&this.createLight(),this.updateTransform()}createEdges(t){const e=new wo(t,30),o=new eo({color:0,transparent:!0,opacity:.3});this.edges=new oo(e,o),this.mesh.add(this.edges)}setEdgesVisible(t){this.edges&&(this.edges.visible=t)}setEdgesOpacity(t){this.edges&&(this.edges.material.opacity=t)}createLight(){this.light&&(this.mesh.remove(this.light),this.light.dispose()),this.light=new Sr(new ot(this.emissive.color),this.emissive.intensity*2,this.emissive.radius*2,1),this.light.castShadow=!1,this.mesh.add(this.light)}removeLight(){this.light&&(this.mesh.remove(this.light),this.light.dispose(),this.light=null)}updateTransform(){const t=io[this.type]||1,e=so[this.type]||0,o=this.dimensions.h*t*this.scale,i=e*this.scale+o/2;this.mesh.position.set(this.gridPosition.x+this.dimensions.w*this.scale/2,this.gridPosition.y+i,this.gridPosition.z+this.dimensions.d*this.scale/2),this.mesh.rotation.set(zt.degToRad(this.rotation.x),zt.degToRad(this.rotation.y),zt.degToRad(this.rotation.z))}setPosition(t){this.gridPosition={...t},this.updateTransform()}setRotation(t){this.rotation={...t},this.updateTransform()}rotateY(t){this.rotation.y=(this.rotation.y+t)%360,this.updateTransform()}setColor(t){this.color=t,Array.isArray(this.mesh.material)?this.mesh.material.forEach((e,o)=>{const i=Ie[o];(!this.faces[i]||!this.faces[i].color)&&e.color.set(t)}):this.mesh.material.color.set(t)}setFaceColor(t,e){if(!Array.isArray(this.mesh.material)){this.color=e,this.mesh.material.color.set(e);return}const o=Ie.indexOf(t);o!==-1&&(this.faces[t]||(this.faces[t]={direction:t,materialId:null,color:null,uvRotation:0,uvFlip:{x:!1,y:!1}}),this.faces[t].color=e,this.mesh.material[o].color.set(e))}getFaceColor(t){if(!Array.isArray(this.mesh.material))return this.color;const e=this.faces[t];return e&&e.color?e.color:this.color}supportsPerFacePainting(){return Array.isArray(this.mesh.material)&&this.mesh.material.length===6}setEmissive(t,e=null,o=null,i=null){this.emissive.enabled=t,e!==null&&(this.emissive.color=e),o!==null&&(this.emissive.intensity=o),i!==null&&(this.emissive.radius=i);const s=n=>{t?(n.emissive=new ot(this.emissive.color),n.emissiveIntensity=this.emissive.intensity):(n.emissive=new ot(0),n.emissiveIntensity=0)};Array.isArray(this.mesh.material)?this.mesh.material.forEach(s):s(this.mesh.material),t?this.createLight():this.removeLight()}updateLight(){this.light&&(this.light.color.set(this.emissive.color),this.light.intensity=this.emissive.intensity*2,this.light.distance=this.emissive.radius*2)}setSelected(t){if(this.emissive.enabled){const o=i=>{i.emissiveIntensity=t?this.emissive.intensity*1.5:this.emissive.intensity};Array.isArray(this.mesh.material)?this.mesh.material.forEach(o):o(this.mesh.material);return}const e=(o,i)=>{o.emissive&&o.emissive.set(i)};Array.isArray(this.mesh.material)?this.mesh.material.forEach(o=>e(o,t?3355443:0)):e(this.mesh.material,t?3355443:0)}clone(){return new xs({type:this.type,position:{...this.gridPosition},dimensions:{...this.dimensions},rotation:{...this.rotation},color:this.color,emissive:{...this.emissive},faces:JSON.parse(JSON.stringify(this.faces)),layerId:this.layerId,scale:this.scale})}toJSON(){return{id:this.id,type:this.type,position:this.gridPosition,dimensions:this.dimensions,rotation:this.rotation,color:this.color,emissive:this.emissive,faces:this.faces,layerId:this.layerId,scale:this.scale}}dispose(){this.removeLight(),this.edges&&(this.edges.geometry.dispose(),this.edges.material.dispose()),this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach(t=>t.dispose()):this.mesh.material.dispose()}}Er();const Hn=new Set;for(const u of Object.values(Gn))for(const t of u.types)Hn.add(t);function Aa(u){return typeof u=="string"&&Hn.has(u)}function Ma(u){return!u||typeof u!="object"?!1:typeof u.x=="number"&&isFinite(u.x)&&typeof u.y=="number"&&isFinite(u.y)&&typeof u.z=="number"&&isFinite(u.z)}function Ea(u){return!u||typeof u!="object"?!1:typeof u.w=="number"&&u.w>0&&isFinite(u.w)&&typeof u.h=="number"&&u.h>0&&isFinite(u.h)&&typeof u.d=="number"&&u.d>0&&isFinite(u.d)}function Sa(u){return!u||typeof u!="object"?!1:typeof u.x=="number"&&isFinite(u.x)&&typeof u.y=="number"&&isFinite(u.y)&&typeof u.z=="number"&&isFinite(u.z)}function Wn(u){return typeof u!="string"?!1:/^#[0-9A-Fa-f]{6}$/.test(u)}function _a(u){return!(!u||typeof u!="object"||typeof u.enabled!="boolean"||u.enabled&&(!Wn(u.color)||typeof u.intensity!="number"||u.intensity<0||typeof u.radius!="number"||u.radius<0))}function qn(u){const t=[];return!u||typeof u!="object"?{valid:!1,errors:["Block data must be an object"]}:(u.type?Aa(u.type)||t.push(`Invalid block type: ${u.type}`):t.push("Block type is required"),u.position?Ma(u.position)||t.push("Invalid block position"):t.push("Block position is required"),u.dimensions&&!Ea(u.dimensions)&&t.push("Invalid block dimensions"),u.rotation&&!Sa(u.rotation)&&t.push("Invalid block rotation"),u.color&&!Wn(u.color)&&t.push("Invalid block color"),u.emissive&&!_a(u.emissive)&&t.push("Invalid emissive settings"),{valid:t.length===0,errors:t})}function Da(u){const t=[],e=[];return!u||typeof u!="object"?{valid:!1,errors:["Project data must be an object"],warnings:[]}:(u.version&&u.version!=="1.0"&&e.push(`Project version ${u.version} may not be fully compatible`),u.blocks&&(Array.isArray(u.blocks)?u.blocks.forEach((o,i)=>{const s=qn(o);s.valid||t.push(`Block ${i}: ${s.errors.join(", ")}`)}):t.push("Project blocks must be an array")),u.animations&&(Array.isArray(u.animations)||t.push("Project animations must be an array")),{valid:t.length===0,errors:t,warnings:e})}function Ta(u){const t={...u};return t.dimensions=t.dimensions||{w:1,h:1,d:1},t.rotation=t.rotation||{x:0,y:0,z:0},t.color=t.color||"#5588cc",t.emissive=t.emissive||{enabled:!1,color:"#ffaa00",intensity:1,radius:3},t.position&&(t.position.x=Math.max(-1e3,Math.min(1e3,t.position.x)),t.position.y=Math.max(-1e3,Math.min(1e3,t.position.y)),t.position.z=Math.max(-1e3,Math.min(1e3,t.position.z))),t}function Pa(u){if(!Array.isArray(u))return{blocks:[],invalidCount:0};const t=[];let e=0;for(const o of u){const i=qn(o);i.valid?t.push(Ta(o)):(e++,console.warn("Skipping invalid block:",i.errors.join(", ")))}return{blocks:t,invalidCount:e}}const Ps={pillar:"Y",pillar2:"Y",pillar4:"Y",pillarRound:"Y",pillarRound2:"Y",post:"Y",bollard:"Y",downspout:"Y",antenna:"Y",torch:"Y",chain:"Y",finial:"Y",banner:"Y",derrickLeg:"Y",wellHead:"Y",beamX:"X",beam2X:"X",beam4X:"X",beamXLow:"X",beam2XLow:"X",pipeX:"X",conduit:"X",cableX:"X",pipelineX:"X",ductX:"X",moldingX:"X",beamZ:"Z",beam2Z:"Z",beam4Z:"Z",beamZLow:"Z",beam2ZLow:"Z",pipeZ:"Z",cableZ:"Z",pipelineZ:"Z",ductZ:"Z",moldingZ:"Z",pipeY:"Y",cableY:"Y",cableDroop:"Y",cableLoop:"Y",beamDiag:"XZ"},Is=["slab","quarter","wedgeLow","wedgeFlat","wedgeCornerLow","wedgeCornerFlat","slabSlope","ledge","gutter","capital","base","channel","channelCorner","channelEnd","rampCurvedLow","roofPeakLow","step","platform","landing","stairsSingle","spiralStep","drain","grate","grateFloor","pallet","derrickPlatform","pumpBase","awning","canopy","tarp","lightFixture","shelf"],Rs=["beamX","beam2X","beam4X","beamZ","beam2Z","beam4Z","beamDiag","slabTop","wedgeLowTop","wedgeFlatTop","slabSlopeTop","crossBeam","derrickCross"],Ls=["pillar","pillar2","pillar4","pillarRound","pillarRound2","fence","fenceZ","railing","railingZ","wall","wall4","wall8","panel","post","bollard","downspout","antenna","torch","chain","finial","banner","conduit","conduitCorner","cable","cableX","cableY","cableZ","cableElbow","cableElbowY","cableT","cableHanging","cableDroop","cableLoop","pipeX","pipeY","pipeZ","pipeElbowXZ","pipeElbowXZ2","pipeElbowXZ3","pipeElbowXZ4","pipeElbowXY","pipeElbowXY2","pipeElbowYZ","pipeElbowYZ2","pipeCross","pipeT","pipeTY","pipeTZ","derrickLeg","wellHead","pipelineX","pipelineZ"],Us=["pipeX","pipeY","pipeZ","pipeElbowXZ","pipeElbowXZ2","pipeElbowXZ3","pipeElbowXZ4","pipeElbowXY","pipeElbowXY2","pipeElbowYZ","pipeElbowYZ2","pipeCross","pipeT","pipeTY","pipeTZ","conduit","conduitCorner","conduitElbow","conduitElbowY","conduitT","cableX","cableY","cableZ","cableElbow","cableElbowY","cableT"];function Os(u,t){const e=Ps[u],o=Ps[t],i=Is.includes(u),s=Is.includes(t),n=Rs.includes(u),r=Rs.includes(t),a=Ls.includes(u),l=Ls.includes(t),p=Us.includes(u),h=Us.includes(t);return p&&h||i&&r||s&&n||i&&l||s&&a||p&&s||h&&i?!0:!(n&&r||i&&s||!e||!o||e===o||e==="XZ"||o==="XZ")}class Ia{constructor(t){this.scene=t,this.blocks=new Map,this.mergedMeshes=new Map,this.blockGroup=new ps,this.blockGroup.name="blocks",this.scene.add(this.blockGroup),this.selectedBlocks=new Set,this.onBlockCountChange=null,this.onSelectionChange=null,this.freePlacementMode=!1}get selectedBlock(){return this.selectedBlocks.size===0?null:this.selectedBlocks.values().next().value}set selectedBlock(t){this.deselectAll(),t&&(this.selectedBlocks.add(t),t.setSelected(!0))}addBlock(t){const e=new xs(t);return!this.freePlacementMode&&this.wouldOverlap(e)?(e.dispose(),null):(this.blocks.set(e.id,e),this.blockGroup.add(e.mesh),this.notifyBlockCountChange(),e)}wouldOverlap(t,e=null){const o=bo(t);for(const i of this.blocks.values()){if(e&&i.id===e)continue;const s=bo(i);if(Es(o,s)){if(Os(t.type,i.type))continue;return!0}}return!1}wouldOverlapAt(t,e,o={w:1,h:1,d:1},i=null,s=1,n={x:0,y:0,z:0}){if(this.freePlacementMode)return!1;const a=bo({type:t,gridPosition:e,dimensions:o,scale:s,rotation:n}),l=i instanceof Set?i:i?new Set([i]):new Set;for(const p of this.blocks.values()){if(l.has(p.id))continue;const h=bo(p);if(Es(a,h)){if(Os(t,p.type))continue;return window.DEBUG_COLLISIONS&&(console.log("[Collision] Cannot place",t,"at",e,"(scale:",s+")"),console.log("  New bounds:",a),console.log("  Conflicts with:",p.type,"at",p.gridPosition,"(scale:",p.scale+")"),console.log("  Existing bounds:",h)),!0}}return!1}removeBlock(t){const e=this.blocks.get(t);return e?(this.blockGroup.remove(e.mesh),e.dispose(),this.blocks.delete(t),this.selectedBlocks.has(e)&&(this.selectedBlocks.delete(e),this.notifySelectionChange()),this.notifyBlockCountChange(),!0):!1}removeBlockAtPosition(t){const e=this.getBlockAtPosition(t);return e?this.removeBlock(e.id):!1}getBlockAtPosition(t){for(const e of this.blocks.values()){const o=e.gridPosition;if(o.x===t.x&&o.y===t.y&&o.z===t.z)return e}return null}getBlockByMesh(t){return t.userData.block?t.userData.block:null}selectBlock(t,e=!1){e||this.deselectAll(),t&&(this.selectedBlocks.add(t),t.setSelected(!0)),this.notifySelectionChange()}addToSelection(t){t&&!this.selectedBlocks.has(t)&&(this.selectedBlocks.add(t),t.setSelected(!0),this.notifySelectionChange())}removeFromSelection(t){t&&this.selectedBlocks.has(t)&&(this.selectedBlocks.delete(t),t.setSelected(!1),this.notifySelectionChange())}toggleSelection(t){this.selectedBlocks.has(t)?this.removeFromSelection(t):this.addToSelection(t)}isSelected(t){return this.selectedBlocks.has(t)}getSelectedBlocks(){return Array.from(this.selectedBlocks)}getSelectionCount(){return this.selectedBlocks.size}selectBlocksInBox(t,e){for(const o of this.blocks.values()){const i=o.gridPosition;i.x>=t.x&&i.x<=e.x&&i.y>=t.y&&i.y<=e.y&&i.z>=t.z&&i.z<=e.z&&(this.selectedBlocks.add(o),o.setSelected(!0))}this.notifySelectionChange()}deselectAll(){for(const t of this.selectedBlocks)t.setSelected(!1);this.selectedBlocks.clear(),this.notifySelectionChange()}notifySelectionChange(){this.onSelectionChange&&this.onSelectionChange(this.getSelectedBlocks())}getBlockMeshes(){return this.blockGroup.children}getAllBlocks(){return Array.from(this.blocks.values())}getBlockById(t){return this.blocks.get(t)||null}positionKey(t){return`${t.x},${t.y},${t.z}`}getBlockCount(){return this.blocks.size}notifyBlockCountChange(){this.onBlockCountChange&&this.onBlockCountChange(this.blocks.size)}clear(){for(const t of this.blocks.values())this.blockGroup.remove(t.mesh),t.dispose();this.blocks.clear();for(const t of this.mergedMeshes.values())this.blockGroup.remove(t.mesh),t.dispose();this.mergedMeshes.clear(),this.selectedBlocks.clear(),this.notifyBlockCountChange(),this.notifySelectionChange()}addMergedMesh(t){return this.mergedMeshes.set(t.id,t),this.blockGroup.add(t.mesh),this.notifyBlockCountChange(),t}removeMergedMesh(t){const e=this.mergedMeshes.get(t);return e?(this.blockGroup.remove(e.mesh),e.dispose(),this.mergedMeshes.delete(t),this.notifyBlockCountChange(),!0):!1}getMergedMeshes(){return Array.from(this.mergedMeshes.values())}getMergedMeshByMesh(t){return t.userData.merged?t.userData.merged:null}toJSON(){return Array.from(this.blocks.values()).map(t=>t.toJSON())}fromJSON(t){this.clear();const{blocks:e,invalidCount:o}=Pa(t);o>0&&console.warn(`Skipped ${o} invalid block(s) during load`);for(const i of e)this.addBlock({type:i.type,position:i.position,dimensions:i.dimensions,rotation:i.rotation,color:i.color,emissive:i.emissive,faces:i.faces,layerId:i.layerId||"default",scale:i.scale||1});return{loadedCount:e.length,invalidCount:o}}}class Ra{constructor(t,e){Xe(this,"handleMouseMove",t=>{this.updateMouse(t);const e=this.raycast();if(this.isDragging&&this.currentTool==="shape"&&this.onShapeDrag){if(e&&this.dragStartPos){const o=e.placementPosition;this.onShapeDrag(this.dragStartPos,o)}return}if(this.isPainting&&this.currentTool==="paint"&&this.onPaint&&e&&e.block){const i=`${e.block.id}_${e.normal.x}_${e.normal.y}_${e.normal.z}`;i!==this.lastPaintedBlock&&(this.onPaint(e,!1),this.lastPaintedBlock=i)}this.onMouseMove&&this.onMouseMove(e)});Xe(this,"handleMouseDown",t=>{if(t.button!==0&&t.button!==1)return;this.updateMouse(t);const e=this.raycast();if(e){if(t.button===1){this.onDelete&&e.block&&this.onDelete(e.block);return}if(t.ctrlKey&&e.block){this.onReplace&&this.onReplace(e.block);return}if(t.altKey&&e.block){this.onPickBlock&&this.onPickBlock(e.block);return}switch(this.currentTool){case"place":this.onPlace&&this.onPlace(e,t.shiftKey);break;case"delete":this.onDelete&&e.block&&this.onDelete(e.block);break;case"select":this.onSelect&&this.onSelect(e.block||null,t.shiftKey);break;case"paint":if(this.onPaint&&e.block){this.isPainting=!0;const i=`${e.block.id}_${e.normal.x}_${e.normal.y}_${e.normal.z}`;this.lastPaintedBlock=i,this.onPaint(e,t.shiftKey)}break;case"pick":this.onPick&&e.block&&this.onPick(e);break;case"shape":this.isDragging=!0,this.dragStartPos=e.placementPosition,this.dragStartResult=e,this.onShapeDrag&&this.onShapeDrag(this.dragStartPos,this.dragStartPos);break;case"scatter":this.onScatterPlace&&this.onScatterPlace(e);break}}});Xe(this,"handleMouseUp",t=>{if(t.button===0){if(this.isDragging&&this.currentTool==="shape"){this.updateMouse(t);const e=this.raycast();if(e&&this.dragStartPos&&this.onShapePlace){const o=e.placementPosition;this.onShapePlace(this.dragStartPos,o)}this.isDragging=!1,this.dragStartPos=null,this.dragStartResult=null}this.isPainting&&(this.isPainting=!1,this.lastPaintedBlock=null)}});Xe(this,"handleKeyDown",t=>{});this.canvas=t,this.camera=e,this.raycaster=new hs,this.mouse=new nt,this.currentTool="place",this.onPlace=null,this.onDelete=null,this.onSelect=null,this.onPaint=null,this.onPick=null,this.onMouseMove=null,this.onReplace=null,this.onPickBlock=null,this.onShapeDrag=null,this.onShapePlace=null,this.onScatterPlace=null,this.isDragging=!1,this.dragStartPos=null,this.dragStartResult=null,this.isPainting=!1,this.lastPaintedBlock=null,this.raycastTargets=[],this.gridPlane=null,this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),window.addEventListener("keydown",this.handleKeyDown)}setGridPlane(t){this.gridPlane=t}setRaycastTargets(t){this.raycastTargets=t}setTool(t){this.currentTool=t}updateMouse(t){const e=this.canvas.getBoundingClientRect();this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-((t.clientY-e.top)/e.height)*2+1}raycast(){this.raycaster.setFromCamera(this.mouse,this.camera);const t=this.raycaster.intersectObjects(this.raycastTargets,!1);if(t.length>0){const e=t[0],o=e.object.userData.block,i=e.object.userData.merged,s=e.face.normal.clone();if(s.transformDirection(e.object.matrixWorld),s.x=Math.abs(s.x)>.5?Math.sign(s.x):0,s.y=Math.abs(s.y)>.5?Math.sign(s.y):0,s.z=Math.abs(s.z)>.5?Math.sign(s.z):0,i&&!o){const n=e.point;let r={x:Math.floor(n.x+s.x*.5),y:Math.floor(n.y+s.y*.5),z:Math.floor(n.z+s.z*.5)};return s.y>0&&(r.y=Math.floor(n.y),r.surfaceY=n.y),{type:"merged",point:e.point,normal:s,block:null,merged:i,placementPosition:r,faceIndex:e.faceIndex}}if(o){const n=o,r=n.gridPosition,a=n.dimensions,l=n.scale||1,p=io[n.type]||1,h=(so[n.type]||0)*l,y=a.h*p*l;let c={x:r.x,y:r.y,z:r.z};if(s.y>0){c.x=Math.floor(e.point.x),c.z=Math.floor(e.point.z);const d=r.y+h+y;c.y=Math.round(d),c.surfaceY=d}else s.y<0?(c.x=Math.floor(e.point.x),c.z=Math.floor(e.point.z),c.y=r.y-1):s.x!==0?(c.x=r.x+s.x*a.w*l,c.y=Math.round(e.point.y),c.z=Math.floor(e.point.z)):s.z!==0&&(c.x=Math.floor(e.point.x),c.y=Math.round(e.point.y),c.z=r.z+s.z*a.d*l);return{type:"block",point:e.point,normal:s,block:o,placementPosition:c,faceIndex:e.faceIndex}}}if(this.gridPlane){const e=this.raycaster.intersectObject(this.gridPlane,!1);if(e.length>0){const o=e[0],i={x:Math.floor(o.point.x),y:0,z:Math.floor(o.point.z)};return{type:"grid",point:o.point,normal:new X(0,1,0),block:null,placementPosition:i}}}return null}dispose(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mouseup",this.handleMouseUp),window.removeEventListener("keydown",this.handleKeyDown)}}class La{constructor(t){this.scene=t,this.visible=!1,this.currentType="cube",this.currentScale=1,this.group=new ps,this.scene.add(this.group),this.mesh=null,this.wireframe=null,this.createMesh("cube")}createMesh(t){this.mesh&&(this.group.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.wireframe&&(this.wireframe.geometry.dispose(),this.wireframe.material.dispose()));const e=this.createGeometry(t),o=new gi({color:5605580,transparent:!0,opacity:.4,depthWrite:!1});this.mesh=new It(e,o),this.mesh.visible=this.visible;const i=new wo(e),s=new eo({color:16777215,transparent:!0,opacity:.6});this.wireframe=new oo(i,s),this.mesh.add(this.wireframe),this.group.add(this.mesh),this.currentType=t}createGeometry(t){const o=(ai[t]||ai.cube)({w:1,h:1,d:1});return this.currentScale>1&&o.scale(this.currentScale,this.currentScale,this.currentScale),o}show(){this.mesh.visible=!0,this.visible=!0}hide(){this.mesh.visible=!1,this.visible=!1}setPosition(t){const e=io[this.currentType]||1,o=so[this.currentType]||0,i=e*this.currentScale,s=o*this.currentScale+i/2,n=this.currentScale/2;this.group.position.set(t.x+n,t.y+s,t.z+n)}setBlockType(t){t!==this.currentType&&(this.createMesh(t),this.mesh.visible=this.visible)}setScale(t){t!==this.currentScale&&(this.currentScale=t,this.createMesh(this.currentType),this.mesh.visible=this.visible)}setRotation(t){this.group.rotation.y=zt.degToRad(t)}setColor(t){this.mesh.material.color.set(t)}setValid(t){t?(this.mesh.material.color.set(5605580),this.mesh.material.opacity=.4):(this.mesh.material.color.set(16729156),this.mesh.material.opacity=.6)}dispose(){this.scene.remove(this.group),this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose()),this.wireframe&&(this.wireframe.geometry.dispose(),this.wireframe.material.dispose())}}class Ua{constructor(){this.atlases=new Map,this.materials=new Map,this.loader=new _r,this.createDefaultMaterials()}createDefaultMaterials(){[{id:"white",name:"White",color:"#ffffff"},{id:"gray",name:"Gray",color:"#888888"},{id:"black",name:"Black",color:"#222222"},{id:"red",name:"Red",color:"#e74c3c"},{id:"orange",name:"Orange",color:"#e67e22"},{id:"yellow",name:"Yellow",color:"#f1c40f"},{id:"green",name:"Green",color:"#2ecc71"},{id:"cyan",name:"Cyan",color:"#1abc9c"},{id:"blue",name:"Blue",color:"#3498db"},{id:"purple",name:"Purple",color:"#9b59b6"},{id:"pink",name:"Pink",color:"#e91e63"},{id:"brown",name:"Brown",color:"#795548"}].forEach(e=>{this.materials.set(e.id,{id:e.id,name:e.name,baseColor:e.color,albedoTile:null,roughness:.7,metallic:0,emission:null,emissionStrength:0})})}async loadAtlas(t,e,o,i,s){return new Promise((n,r)=>{this.loader.load(e,a=>{a.magFilter=xe,a.minFilter=xe,a.colorSpace=ys;const l={id:t,texture:a,tileSize:o,columns:i,rows:s,totalTiles:i*s};this.atlases.set(t,l),this.createAtlasMaterials(l),n(l)},void 0,r)})}createAtlasMaterials(t){for(let e=0;e<t.totalTiles;e++){const o=e%t.columns,i=Math.floor(e/t.columns),s=`${t.id}_tile_${e}`;this.materials.set(s,{id:s,name:`Tile ${e}`,baseColor:"#ffffff",albedoTile:{atlasId:t.id,index:e,col:o,row:i},roughness:.8,metallic:0,emission:null,emissionStrength:0})}}getMaterial(t){return this.materials.get(t)}getAllMaterials(){return Array.from(this.materials.values())}getColorMaterials(){return Array.from(this.materials.values()).filter(t=>!t.albedoTile)}getAtlasMaterials(t){return Array.from(this.materials.values()).filter(e=>e.albedoTile&&e.albedoTile.atlasId===t)}createThreeMaterial(t){const e=this.materials.get(t);if(!e)return null;const o={color:e.baseColor,roughness:e.roughness,metalness:e.metallic};if(e.albedoTile){const i=this.atlases.get(e.albedoTile.atlasId);if(i){const s=i.texture.clone();s.needsUpdate=!0,s.repeat.set(1/i.columns,1/i.rows),s.offset.set(e.albedoTile.col/i.columns,1-(e.albedoTile.row+1)/i.rows),o.map=s}}return e.emission&&(o.emissive=new ot(e.emission),o.emissiveIntensity=e.emissionStrength),new Ct(o)}createFaceMaterial(t,e=0,o={x:!1,y:!1}){const i=this.createThreeMaterial(t);return i?(i.userData={uvRotation:e,uvFlip:o},i):null}}class Oa{constructor(t=50){this.undoStack=[],this.redoStack=[],this.maxSize=t,this.onChange=null}push(t){this.undoStack.push(t),this.redoStack=[],this.undoStack.length>this.maxSize&&this.undoStack.shift(),this.notify()}undo(){if(this.undoStack.length===0)return!1;const t=this.undoStack.pop();return t.undo(),this.redoStack.push(t),this.notify(),!0}redo(){if(this.redoStack.length===0)return!1;const t=this.redoStack.pop();return t.redo(),this.undoStack.push(t),this.notify(),!0}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}clear(){this.undoStack=[],this.redoStack=[],this.notify()}notify(){this.onChange&&this.onChange({canUndo:this.canUndo(),canRedo:this.canRedo()})}}function co(u,t,e){return{type:"addBlock",data:t,undo:()=>{u.removeBlock(e.id)},redo:()=>{u.addBlock(t)}}}function Bi(u,t){const e=t.toJSON();return{type:"removeBlock",data:e,undo:()=>{u.addBlock(e)},redo:()=>{u.removeBlockAtPosition(e.position)}}}function Na(u,t,e,o){return{type:"paintFaceColor",data:{blockId:u.id,faceDirection:t,oldColor:e,newColor:o},undo:()=>{if(e===null){if(u.faces[t].color=null,Array.isArray(u.mesh.material)){const s=["east","west","top","bottom","south","north"].indexOf(t);s!==-1&&u.mesh.material[s].color.set(u.color)}}else u.setFaceColor(t,e)},redo:()=>{u.setFaceColor(t,o)}}}function ja(u,t,e,o){return{type:"paintBlockColor",data:{blockId:u.id,oldColor:t,newColor:e},undo:()=>{u.setColor(t),o&&Object.entries(o).forEach(([s,n])=>{n&&n.color&&u.setFaceColor(s,n.color)})},redo:()=>{u.setColor(e)}}}function Ns(u){return{type:"batchPaint",data:{count:u.length},undo:()=>{for(let t=u.length-1;t>=0;t--)u[t].undo()},redo:()=>{u.forEach(t=>t.redo())}}}function Xa(u,t,e){return{type:"flatten",data:{blockCount:t.length,mergedCount:e.length},undo:()=>{for(const o of e)u.removeMergedMesh(o);for(const o of t)u.addBlock(o)},redo:()=>{const o=u.getAllBlocks().filter(i=>t.some(s=>s.position.x===i.gridPosition.x&&s.position.y===i.gridPosition.y&&s.position.z===i.gridPosition.z));for(const i of o)u.removeBlock(i.id)}}}class pi{constructor(t={}){this.id=t.id||`anim_${Date.now()}`,this.name=t.name||"Animation",this.duration=t.duration||1e3,this.loop=t.loop||!1,this.curve=t.curve||"easeInOut",this.keyframes=t.keyframes||[]}addKeyframe(t,e,o){this.keyframes=this.keyframes.filter(i=>!(i.time===t&&i.blockId===e)),this.keyframes.push({time:t,blockId:e,properties:o}),this.keyframes.sort((i,s)=>i.time-s.time)}removeKeyframe(t,e){this.keyframes=this.keyframes.filter(o=>!(o.time===t&&o.blockId===e))}getKeyframesForBlock(t){return this.keyframes.filter(e=>e.blockId===t)}getKeyframesAtTime(t){return this.keyframes.filter(e=>e.time===t)}toJSON(){return{id:this.id,name:this.name,duration:this.duration,loop:this.loop,curve:this.curve,keyframes:this.keyframes}}static fromJSON(t){return new pi(t)}}class Za{constructor(t){this.blockManager=t,this.animations=new Map,this.currentAnimation=null,this.isPlaying=!1,this.currentTime=0,this.playbackSpeed=1,this.originalStates=new Map,this.onTimeUpdate=null,this.onPlayStateChange=null}createAnimation(t="New Animation",e=2e3){const o=new pi({name:t,duration:e});return this.animations.set(o.id,o),o}deleteAnimation(t){var e;this.animations.delete(t),((e=this.currentAnimation)==null?void 0:e.id)===t&&(this.currentAnimation=null,this.stop())}setCurrentAnimation(t){this.stop(),this.currentAnimation=this.animations.get(t)||null,this.currentTime=0}captureInitialState(){if(this.currentAnimation){this.originalStates.clear();for(const t of this.blockManager.blocks.values())this.originalStates.set(t.id,{position:{...t.gridPosition},rotation:{...t.rotation},scale:{...t.dimensions},color:t.color,emissive:t.emissive?{...t.emissive}:null})}}addKeyframe(t){return!this.currentAnimation||!t?0:(this.currentAnimation.addKeyframe(this.currentTime,t.id,{position:{...t.gridPosition},rotation:{...t.rotation},scale:{...t.dimensions},color:t.color,emissive:t.emissive?{...t.emissive}:null}),1)}addKeyframesForSelection(t){if(!this.currentAnimation||!t||t.length===0)return 0;let e=0;for(const o of t)this.currentAnimation.addKeyframe(this.currentTime,o.id,{position:{...o.gridPosition},rotation:{...o.rotation},scale:{...o.dimensions},color:o.color,emissive:o.emissive?{...o.emissive}:null}),e++;return e}removeKeyframe(t){if(!this.currentAnimation)return 0;const e=this.currentAnimation.keyframes.length;return this.currentAnimation.removeKeyframe(this.currentTime,t),e-this.currentAnimation.keyframes.length}removeKeyframesForSelection(t){if(!this.currentAnimation||!t||t.length===0)return 0;let e=0;for(const o of t){const i=this.currentAnimation.keyframes.length;this.currentAnimation.removeKeyframe(this.currentTime,o),this.currentAnimation.keyframes.length<i&&e++}return e}hasKeyframesAtCurrentTime(t){return this.currentAnimation?this.currentAnimation.getKeyframesAtTime(this.currentTime).some(o=>t.includes(o.blockId)):!1}play(){this.currentAnimation&&(this.captureInitialState(),this.isPlaying=!0,this.lastTime=performance.now(),this.onPlayStateChange&&this.onPlayStateChange(!0))}pause(){this.isPlaying=!1,this.onPlayStateChange&&this.onPlayStateChange(!1)}stop(){this.isPlaying=!1,this.currentTime=0,this.restoreOriginalStates(),this.onPlayStateChange&&this.onPlayStateChange(!1),this.onTimeUpdate&&this.onTimeUpdate(0)}restoreOriginalStates(){for(const[t,e]of this.originalStates){const o=this.blockManager.blocks.get(t);o&&(o.setPosition(e.position),o.setRotation(e.rotation),o.setColor(e.color),e.emissive&&o.setEmissive&&o.setEmissive(e.emissive))}}setTime(t){var e;this.currentTime=Math.max(0,Math.min(t,((e=this.currentAnimation)==null?void 0:e.duration)||0)),this.updateBlocks(),this.onTimeUpdate&&this.onTimeUpdate(this.currentTime)}update(t){!this.isPlaying||!this.currentAnimation||(this.currentTime+=t*1e3*this.playbackSpeed,this.currentTime>=this.currentAnimation.duration&&(this.currentAnimation.loop?this.currentTime=this.currentTime%this.currentAnimation.duration:(this.currentTime=this.currentAnimation.duration,this.pause())),this.updateBlocks(),this.onTimeUpdate&&this.onTimeUpdate(this.currentTime))}updateBlocks(){if(!this.currentAnimation)return;const t=new Map;for(const e of this.currentAnimation.keyframes)t.has(e.blockId)||t.set(e.blockId,[]),t.get(e.blockId).push(e);for(const[e,o]of t){const i=this.blockManager.blocks.get(e);if(!i||o.length===0)continue;let s=null,n=null;for(const r of o)r.time<=this.currentTime?s=r:n||(n=r);if(s&&n){const r=(this.currentTime-s.time)/(n.time-s.time);this.interpolateBlock(i,s.properties,n.properties,r)}else if(s)this.applyProperties(i,s.properties);else if(n){const r=this.originalStates.get(e);r&&(i.setPosition(r.position),i.setRotation(r.rotation))}}}interpolateBlock(t,e,o,i){const s=this.applyCurve(i);if(e.position&&o.position&&t.setPosition({x:Math.round(this.lerp(e.position.x,o.position.x,s)),y:Math.round(this.lerp(e.position.y,o.position.y,s)),z:Math.round(this.lerp(e.position.z,o.position.z,s))}),e.rotation&&o.rotation&&t.setRotation({x:this.lerp(e.rotation.x,o.rotation.x,s),y:this.lerp(e.rotation.y,o.rotation.y,s),z:this.lerp(e.rotation.z,o.rotation.z,s)}),e.color&&o.color){const n=new ot(e.color),r=new ot(o.color);n.lerp(r,s),t.setColor("#"+n.getHexString())}if(e.emissive&&o.emissive&&t.setEmissive){const n=new ot(e.emissive.color||"#000000"),r=new ot(o.emissive.color||"#000000");n.lerp(r,s),t.setEmissive({enabled:o.emissive.enabled,color:"#"+n.getHexString(),intensity:this.lerp(e.emissive.intensity||0,o.emissive.intensity||0,s),radius:this.lerp(e.emissive.radius||0,o.emissive.radius||0,s)})}else if(o.emissive&&t.setEmissive)t.setEmissive(o.emissive);else if(e.emissive&&!o.emissive&&t.setEmissive){const n=new ot(e.emissive.color||"#000000");t.setEmissive({enabled:s<.5?e.emissive.enabled:!1,color:"#"+n.getHexString(),intensity:this.lerp(e.emissive.intensity||0,0,s),radius:e.emissive.radius||0})}}applyProperties(t,e){e.position&&t.setPosition(e.position),e.rotation&&t.setRotation(e.rotation),e.color&&t.setColor(e.color),e.emissive&&t.setEmissive&&t.setEmissive(e.emissive)}lerp(t,e,o){return t+(e-t)*o}applyCurve(t){if(!this.currentAnimation)return t;switch(this.currentAnimation.curve||"easeInOut"){case"linear":return t;case"easeIn":return t*t;case"easeOut":return 1-Math.pow(1-t,2);case"easeInOut":return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;case"smoothstep":return t*t*(3-2*t);default:return t}}getAllAnimations(){return Array.from(this.animations.values())}toJSON(){var t;return{animations:Array.from(this.animations.values()).map(e=>e.toJSON()),currentAnimationId:((t=this.currentAnimation)==null?void 0:t.id)||null}}fromJSON(t){this.animations.clear();for(const e of t.animations||[]){const o=pi.fromJSON(e);this.animations.set(o.id,o)}t.currentAnimationId&&this.setCurrentAnimation(t.currentAnimationId)}clear(){this.stop(),this.animations.clear(),this.currentAnimation=null,this.originalStates.clear()}}class Ga{constructor(t,e,o,i=null){this.blockManager=t,this.animator=e,this.textureManager=o,this.layerManager=i,this.currentProjectName="Untitled",this.onError=null}setLayerManager(t){this.layerManager=t}notifyError(t,e=null){console.error(t,e),this.onError&&this.onError(t,e)}save(){try{const t=this.currentProjectName||"Untitled",e=prompt("Save project as:",t);if(e===null)return!1;const o=e.trim()||"Untitled";this.currentProjectName=o;const i={version:"1.0",name:o,createdAt:new Date().toISOString(),blocks:this.blockManager.toJSON(),animations:this.animator.toJSON(),layers:this.layerManager?this.layerManager.toJSON():null},s=JSON.stringify(i,null,2),n=new Blob([s],{type:"application/json"}),r=URL.createObjectURL(n),a=document.createElement("a");return a.href=r,a.download=`${o.replace(/\s+/g,"_")}.blocks`,a.click(),URL.revokeObjectURL(r),!0}catch(t){return this.notifyError("Failed to save project",t),!1}}async load(t){return new Promise((e,o)=>{if(!t){const s=new Error("No file provided");this.notifyError("No file provided for loading",s),o(s);return}const i=new FileReader;i.onload=s=>{try{const n=s.target.result;if(!n||n.trim()==="")throw new Error("File is empty");const r=JSON.parse(n);if(!r||typeof r!="object")throw new Error("Invalid project format");const a=Da(r);if(!a.valid)throw new Error(`Invalid project: ${a.errors.join(", ")}`);for(const l of a.warnings)console.warn("Project warning:",l);if(this.currentProjectName=r.name||"Loaded Project",r.blocks&&Array.isArray(r.blocks)){const l=this.blockManager.fromJSON(r.blocks);l.invalidCount>0&&console.warn(`Loaded ${l.loadedCount} blocks, skipped ${l.invalidCount} invalid blocks`)}else console.warn("No blocks found in project file");r.animations&&this.animator.fromJSON(r.animations),r.layers&&this.layerManager&&this.layerManager.fromJSON(r.layers),e(r)}catch(n){this.notifyError(`Failed to parse project file: ${n.message}`,n),o(n)}},i.onerror=s=>{const n=new Error("Failed to read file");this.notifyError("Failed to read project file",n),o(n)},i.readAsText(t)})}newProject(){try{return this.currentProjectName="Untitled",this.blockManager.clear(),this.animator.animations.clear(),this.animator.currentAnimation=null,this.layerManager&&this.layerManager.clear(),!0}catch(t){return this.notifyError("Failed to create new project",t),!1}}setProjectName(t){this.currentProjectName=t}}const js={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};let hi=class{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(t){return new tl(t)}),this.register(function(t){return new el(t)}),this.register(function(t){return new nl(t)}),this.register(function(t){return new rl(t)}),this.register(function(t){return new al(t)}),this.register(function(t){return new ll(t)}),this.register(function(t){return new ol(t)}),this.register(function(t){return new il(t)}),this.register(function(t){return new sl(t)}),this.register(function(t){return new cl(t)}),this.register(function(t){return new pl(t)}),this.register(function(t){return new hl(t)}),this.register(function(t){return new yl(t)}),this.register(function(t){return new ul(t)})}register(t){return this.pluginCallbacks.indexOf(t)===-1&&this.pluginCallbacks.push(t),this}unregister(t){return this.pluginCallbacks.indexOf(t)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}setTextureUtils(t){return this.textureUtils=t,this}parse(t,e,o,i){const s=new Qa,n=[];for(let r=0,a=this.pluginCallbacks.length;r<a;r++)n.push(this.pluginCallbacks[r](s));s.setPlugins(n),s.setTextureUtils(this.textureUtils),s.writeAsync(t,e,i).catch(o)}parseAsync(t,e){const o=this;return new Promise(function(i,s){o.parse(t,i,s,e)})}};const pt={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},Ci="KHR_mesh_quantization",Yt={};Yt[xe]=pt.NEAREST;Yt[Ir]=pt.NEAREST_MIPMAP_NEAREST;Yt[Rr]=pt.NEAREST_MIPMAP_LINEAR;Yt[ko]=pt.LINEAR;Yt[Lr]=pt.LINEAR_MIPMAP_NEAREST;Yt[Ur]=pt.LINEAR_MIPMAP_LINEAR;Yt[Or]=pt.CLAMP_TO_EDGE;Yt[Nr]=pt.REPEAT;Yt[jr]=pt.MIRRORED_REPEAT;const Xs={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Ya=new ot,Zs=12,Va=1179937895,$a=2,Gs=8,Ha=1313821514,Wa=5130562;function zo(u,t){return u.length===t.length&&u.every(function(e,o){return e===t[o]})}function qa(u){return new TextEncoder().encode(u).buffer}function Ka(u){return zo(u.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function Ja(u,t,e){const o={min:new Array(u.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(u.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let i=t;i<t+e;i++)for(let s=0;s<u.itemSize;s++){let n;u.itemSize>4?n=u.array[i*u.itemSize+s]:(s===0?n=u.getX(i):s===1?n=u.getY(i):s===2?n=u.getZ(i):s===3&&(n=u.getW(i)),u.normalized===!0&&(n=zt.normalize(n,u.array))),o.min[s]=Math.min(o.min[s],n),o.max[s]=Math.max(o.max[s],n)}return o}function Kn(u){return Math.ceil(u/4)*4}function Ai(u,t=0){const e=Kn(u.byteLength);if(e!==u.byteLength){const o=new Uint8Array(e);if(o.set(new Uint8Array(u)),t!==0)for(let i=u.byteLength;i<e;i++)o[i]=t;return o.buffer}return u}function Ys(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function Vs(u,t){if(u.toBlob!==void 0)return new Promise(o=>u.toBlob(o,t));let e;return t==="image/jpeg"?e=.92:t==="image/webp"&&(e=.8),u.convertToBlob({type:t,quality:e})}class Qa{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+us}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(t){this.plugins=t}setTextureUtils(t){this.textureUtils=t}async writeAsync(t,e,o={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},o),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(t),await Promise.all(this.pending);const i=this,s=i.buffers,n=i.json;o=i.options;const r=i.extensionsUsed,a=i.extensionsRequired,l=new Blob(s,{type:"application/octet-stream"}),p=Object.keys(r),h=Object.keys(a);if(p.length>0&&(n.extensionsUsed=p),h.length>0&&(n.extensionsRequired=h),n.buffers&&n.buffers.length>0&&(n.buffers[0].byteLength=l.size),o.binary===!0){const y=new FileReader;y.readAsArrayBuffer(l),y.onloadend=function(){const c=Ai(y.result),d=new DataView(new ArrayBuffer(Gs));d.setUint32(0,c.byteLength,!0),d.setUint32(4,Wa,!0);const f=Ai(qa(JSON.stringify(n)),32),m=new DataView(new ArrayBuffer(Gs));m.setUint32(0,f.byteLength,!0),m.setUint32(4,Ha,!0);const x=new ArrayBuffer(Zs),g=new DataView(x);g.setUint32(0,Va,!0),g.setUint32(4,$a,!0);const b=Zs+m.byteLength+f.byteLength+d.byteLength+c.byteLength;g.setUint32(8,b,!0);const z=new Blob([x,m,f,d,c],{type:"application/octet-stream"}),v=new FileReader;v.readAsArrayBuffer(z),v.onloadend=function(){e(v.result)}}}else if(n.buffers&&n.buffers.length>0){const y=new FileReader;y.readAsDataURL(l),y.onloadend=function(){const c=y.result;n.buffers[0].uri=c,e(n)}}else e(n)}serializeUserData(t,e){if(Object.keys(t.userData).length===0)return;const o=this.options,i=this.extensionsUsed;try{const s=JSON.parse(JSON.stringify(t.userData));if(o.includeCustomExtensions&&s.gltfExtensions){e.extensions===void 0&&(e.extensions={});for(const n in s.gltfExtensions)e.extensions[n]=s.gltfExtensions[n],i[n]=!0;delete s.gltfExtensions}Object.keys(s).length>0&&(e.extras=s)}catch(s){console.warn("THREE.GLTFExporter: userData of '"+t.name+"' won't be serialized because of JSON.stringify error - "+s.message)}}getUID(t,e=!1){if(this.uids.has(t)===!1){const i=new Map;i.set(!0,this.uid++),i.set(!1,this.uid++),this.uids.set(t,i)}return this.uids.get(t).get(e)}isNormalizedNormalAttribute(t){if(this.cache.attributesNormalized.has(t))return!1;const o=new X;for(let i=0,s=t.count;i<s;i++)if(Math.abs(o.fromBufferAttribute(t,i).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(t){const e=this.cache;if(e.attributesNormalized.has(t))return e.attributesNormalized.get(t);const o=t.clone(),i=new X;for(let s=0,n=o.count;s<n;s++)i.fromBufferAttribute(o,s),i.x===0&&i.y===0&&i.z===0?i.setX(1):i.normalize(),o.setXYZ(s,i.x,i.y,i.z);return e.attributesNormalized.set(t,o),o}applyTextureTransform(t,e){let o=!1;const i={};(e.offset.x!==0||e.offset.y!==0)&&(i.offset=e.offset.toArray(),o=!0),e.rotation!==0&&(i.rotation=e.rotation,o=!0),(e.repeat.x!==1||e.repeat.y!==1)&&(i.scale=e.repeat.toArray(),o=!0),o&&(t.extensions=t.extensions||{},t.extensions.KHR_texture_transform=i,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(t,e){if(t===e)return t;function o(c){return c.colorSpace===ys?function(f){return f<.04045?f*.0773993808:Math.pow(f*.9478672986+.0521327014,2.4)}:function(f){return f}}t instanceof wi&&(t=await this.decompressTextureAsync(t)),e instanceof wi&&(e=await this.decompressTextureAsync(e));const i=t?t.image:null,s=e?e.image:null,n=Math.max(i?i.width:0,s?s.width:0),r=Math.max(i?i.height:0,s?s.height:0),a=Ys();a.width=n,a.height=r;const l=a.getContext("2d",{willReadFrequently:!0});l.fillStyle="#00ffff",l.fillRect(0,0,n,r);const p=l.getImageData(0,0,n,r);if(i){l.drawImage(i,0,0,n,r);const c=o(t),d=l.getImageData(0,0,n,r).data;for(let f=2;f<d.length;f+=4)p.data[f]=c(d[f]/256)*256}if(s){l.drawImage(s,0,0,n,r);const c=o(e),d=l.getImageData(0,0,n,r).data;for(let f=1;f<d.length;f+=4)p.data[f]=c(d[f]/256)*256}l.putImageData(p,0,0);const y=(t||e).clone();return y.source=new Dr(a),y.colorSpace=Tr,y.channel=(t||e).channel,t&&e&&t.channel!==e.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),y}async decompressTextureAsync(t,e=1/0){if(this.textureUtils===null)throw new Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(t,e)}processBuffer(t){const e=this.json,o=this.buffers;return e.buffers||(e.buffers=[{byteLength:0}]),o.push(t),0}processBufferView(t,e,o,i,s){const n=this.json;n.bufferViews||(n.bufferViews=[]);let r;switch(e){case pt.BYTE:case pt.UNSIGNED_BYTE:r=1;break;case pt.SHORT:case pt.UNSIGNED_SHORT:r=2;break;default:r=4}let a=t.itemSize*r;s===pt.ARRAY_BUFFER&&(a=Math.ceil(a/4)*4);const l=Kn(i*a),p=new DataView(new ArrayBuffer(l));let h=0;for(let d=o;d<o+i;d++){for(let f=0;f<t.itemSize;f++){let m;t.itemSize>4?m=t.array[d*t.itemSize+f]:(f===0?m=t.getX(d):f===1?m=t.getY(d):f===2?m=t.getZ(d):f===3&&(m=t.getW(d)),t.normalized===!0&&(m=zt.normalize(m,t.array))),e===pt.FLOAT?p.setFloat32(h,m,!0):e===pt.INT?p.setInt32(h,m,!0):e===pt.UNSIGNED_INT?p.setUint32(h,m,!0):e===pt.SHORT?p.setInt16(h,m,!0):e===pt.UNSIGNED_SHORT?p.setUint16(h,m,!0):e===pt.BYTE?p.setInt8(h,m):e===pt.UNSIGNED_BYTE&&p.setUint8(h,m),h+=r}h%a!==0&&(h+=a-h%a)}const y={buffer:this.processBuffer(p.buffer),byteOffset:this.byteOffset,byteLength:l};return s!==void 0&&(y.target=s),s===pt.ARRAY_BUFFER&&(y.byteStride=a),this.byteOffset+=l,n.bufferViews.push(y),{id:n.bufferViews.length-1,byteLength:0}}processBufferViewImage(t){const e=this,o=e.json;return o.bufferViews||(o.bufferViews=[]),new Promise(function(i){const s=new FileReader;s.readAsArrayBuffer(t),s.onloadend=function(){const n=Ai(s.result),r={buffer:e.processBuffer(n),byteOffset:e.byteOffset,byteLength:n.byteLength};e.byteOffset+=n.byteLength,i(o.bufferViews.push(r)-1)}})}processAccessor(t,e,o,i){const s=this.json,n={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"};let r;if(t.array.constructor===Float32Array)r=pt.FLOAT;else if(t.array.constructor===Int32Array)r=pt.INT;else if(t.array.constructor===Uint32Array)r=pt.UNSIGNED_INT;else if(t.array.constructor===Int16Array)r=pt.SHORT;else if(t.array.constructor===Uint16Array)r=pt.UNSIGNED_SHORT;else if(t.array.constructor===Int8Array)r=pt.BYTE;else if(t.array.constructor===Uint8Array)r=pt.UNSIGNED_BYTE;else throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+t.array.constructor.name);if(o===void 0&&(o=0),(i===void 0||i===1/0)&&(i=t.count),i===0)return null;const a=Ja(t,o,i);let l;e!==void 0&&(l=t===e.index?pt.ELEMENT_ARRAY_BUFFER:pt.ARRAY_BUFFER);const p=this.processBufferView(t,r,o,i,l),h={bufferView:p.id,byteOffset:p.byteOffset,componentType:r,count:i,max:a.max,min:a.min,type:n[t.itemSize]};return t.normalized===!0&&(h.normalized=!0),s.accessors||(s.accessors=[]),s.accessors.push(h)-1}processImage(t,e,o,i="image/png"){if(t!==null){const s=this,n=s.cache,r=s.json,a=s.options,l=s.pending;n.images.has(t)||n.images.set(t,{});const p=n.images.get(t),h=i+":flipY/"+o.toString();if(p[h]!==void 0)return p[h];r.images||(r.images=[]);const y={mimeType:i},c=Ys();c.width=Math.min(t.width,a.maxTextureSize),c.height=Math.min(t.height,a.maxTextureSize);const d=c.getContext("2d",{willReadFrequently:!0});if(o===!0&&(d.translate(0,c.height),d.scale(1,-1)),t.data!==void 0){e!==ds&&console.error("GLTFExporter: Only RGBAFormat is supported.",e),(t.width>a.maxTextureSize||t.height>a.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",t);const m=new Uint8ClampedArray(t.height*t.width*4);for(let x=0;x<m.length;x+=4)m[x+0]=t.data[x+0],m[x+1]=t.data[x+1],m[x+2]=t.data[x+2],m[x+3]=t.data[x+3];d.putImageData(new ImageData(m,t.width,t.height),0,0)}else if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas)d.drawImage(t,0,0,c.width,c.height);else throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");a.binary===!0?l.push(Vs(c,i).then(m=>s.processBufferViewImage(m)).then(m=>{y.bufferView=m})):c.toDataURL!==void 0?y.uri=c.toDataURL(i):l.push(Vs(c,i).then(m=>new FileReader().readAsDataURL(m)).then(m=>{y.uri=m}));const f=r.images.push(y)-1;return p[h]=f,f}else throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(t){const e=this.json;e.samplers||(e.samplers=[]);const o={magFilter:Yt[t.magFilter],minFilter:Yt[t.minFilter],wrapS:Yt[t.wrapS],wrapT:Yt[t.wrapT]};return e.samplers.push(o)-1}async processTextureAsync(t){const o=this.options,i=this.cache,s=this.json;if(i.textures.has(t))return i.textures.get(t);s.textures||(s.textures=[]),t instanceof wi&&(t=await this.decompressTextureAsync(t,o.maxTextureSize));let n=t.userData.mimeType;n==="image/webp"&&(n="image/png");const r={sampler:this.processSampler(t),source:this.processImage(t.image,t.format,t.flipY,n)};t.name&&(r.name=t.name),await this._invokeAllAsync(async function(l){l.writeTexture&&await l.writeTexture(t,r)});const a=s.textures.push(r)-1;return i.textures.set(t,a),a}async processMaterialAsync(t){const e=this.cache,o=this.json;if(e.materials.has(t))return e.materials.get(t);if(t.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;o.materials||(o.materials=[]);const i={pbrMetallicRoughness:{}};t.isMeshStandardMaterial!==!0&&t.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const s=t.color.toArray().concat([t.opacity]);if(zo(s,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=s),t.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=t.metalness,i.pbrMetallicRoughness.roughnessFactor=t.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),t.metalnessMap||t.roughnessMap){const r=await this.buildMetalRoughTextureAsync(t.metalnessMap,t.roughnessMap),a={index:await this.processTextureAsync(r),texCoord:r.channel};this.applyTextureTransform(a,r),i.pbrMetallicRoughness.metallicRoughnessTexture=a}if(t.map){const r={index:await this.processTextureAsync(t.map),texCoord:t.map.channel};this.applyTextureTransform(r,t.map),i.pbrMetallicRoughness.baseColorTexture=r}if(t.emissive){const r=t.emissive;if(Math.max(r.r,r.g,r.b)>0&&(i.emissiveFactor=t.emissive.toArray()),t.emissiveMap){const l={index:await this.processTextureAsync(t.emissiveMap),texCoord:t.emissiveMap.channel};this.applyTextureTransform(l,t.emissiveMap),i.emissiveTexture=l}}if(t.normalMap){const r={index:await this.processTextureAsync(t.normalMap),texCoord:t.normalMap.channel};t.normalScale&&t.normalScale.x!==1&&(r.scale=t.normalScale.x),this.applyTextureTransform(r,t.normalMap),i.normalTexture=r}if(t.aoMap){const r={index:await this.processTextureAsync(t.aoMap),texCoord:t.aoMap.channel};t.aoMapIntensity!==1&&(r.strength=t.aoMapIntensity),this.applyTextureTransform(r,t.aoMap),i.occlusionTexture=r}t.transparent?i.alphaMode="BLEND":t.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=t.alphaTest),t.side===Ae&&(i.doubleSided=!0),t.name!==""&&(i.name=t.name),this.serializeUserData(t,i),await this._invokeAllAsync(async function(r){r.writeMaterialAsync&&await r.writeMaterialAsync(t,i)});const n=o.materials.push(i)-1;return e.materials.set(t,n),n}async processMeshAsync(t){const e=this.cache,o=this.json,i=[t.geometry.uuid];if(Array.isArray(t.material))for(let z=0,v=t.material.length;z<v;z++)i.push(t.material[z].uuid);else i.push(t.material.uuid);const s=i.join(":");if(e.meshes.has(s))return e.meshes.get(s);const n=t.geometry;let r;t.isLineSegments?r=pt.LINES:t.isLineLoop?r=pt.LINE_LOOP:t.isLine?r=pt.LINE_STRIP:t.isPoints?r=pt.POINTS:r=t.material.wireframe?pt.LINES:pt.TRIANGLES;const a={},l={},p=[],h=[],y={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},c=n.getAttribute("normal");c!==void 0&&!this.isNormalizedNormalAttribute(c)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),n.setAttribute("normal",this.createNormalizedNormalAttribute(c)));let d=null;for(let z in n.attributes){if(z.slice(0,5)==="morph")continue;const v=n.attributes[z];if(z=y[z]||z.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(z)||(z="_"+z),e.attributes.has(this.getUID(v))){l[z]=e.attributes.get(this.getUID(v));continue}d=null;const B=v.array;z==="JOINTS_0"&&!(B instanceof Uint16Array)&&!(B instanceof Uint8Array)?(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),d=new Nt(new Uint16Array(B),v.itemSize,v.normalized)):(B instanceof Uint32Array||B instanceof Int32Array)&&!z.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${z}" converted to type FLOAT.`),d=hi.Utils.toFloat32BufferAttribute(v));const A=this.processAccessor(d||v,n);A!==null&&(z.startsWith("_")||this.detectMeshQuantization(z,v),l[z]=A,e.attributes.set(this.getUID(v),A))}if(c!==void 0&&n.setAttribute("normal",c),Object.keys(l).length===0)return null;if(t.morphTargetInfluences!==void 0&&t.morphTargetInfluences.length>0){const z=[],v=[],C={};if(t.morphTargetDictionary!==void 0)for(const B in t.morphTargetDictionary)C[t.morphTargetDictionary[B]]=B;for(let B=0;B<t.morphTargetInfluences.length;++B){const A={};let M=!1;for(const S in n.morphAttributes){if(S!=="position"&&S!=="normal"){M||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),M=!0);continue}const P=n.morphAttributes[S][B],k=S.toUpperCase(),D=n.attributes[S];if(e.attributes.has(this.getUID(P,!0))){A[k]=e.attributes.get(this.getUID(P,!0));continue}const F=P.clone();if(!n.morphTargetsRelative)for(let T=0,K=P.count;T<K;T++)for(let G=0;G<P.itemSize;G++)G===0&&F.setX(T,P.getX(T)-D.getX(T)),G===1&&F.setY(T,P.getY(T)-D.getY(T)),G===2&&F.setZ(T,P.getZ(T)-D.getZ(T)),G===3&&F.setW(T,P.getW(T)-D.getW(T));A[k]=this.processAccessor(F,n),e.attributes.set(this.getUID(D,!0),A[k])}h.push(A),z.push(t.morphTargetInfluences[B]),t.morphTargetDictionary!==void 0&&v.push(C[B])}a.weights=z,v.length>0&&(a.extras={},a.extras.targetNames=v)}const f=Array.isArray(t.material);if(f&&n.groups.length===0)return null;let m=!1;if(f&&n.index===null){const z=[];for(let v=0,C=n.attributes.position.count;v<C;v++)z[v]=v;n.setIndex(z),m=!0}const x=f?t.material:[t.material],g=f?n.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let z=0,v=g.length;z<v;z++){const C={mode:r,attributes:l};if(this.serializeUserData(n,C),h.length>0&&(C.targets=h),n.index!==null){let A=this.getUID(n.index);(g[z].start!==void 0||g[z].count!==void 0)&&(A+=":"+g[z].start+":"+g[z].count),e.attributes.has(A)?C.indices=e.attributes.get(A):(C.indices=this.processAccessor(n.index,n,g[z].start,g[z].count),e.attributes.set(A,C.indices)),C.indices===null&&delete C.indices}const B=await this.processMaterialAsync(x[g[z].materialIndex]);B!==null&&(C.material=B),p.push(C)}m===!0&&n.setIndex(null),a.primitives=p,o.meshes||(o.meshes=[]),await this._invokeAllAsync(function(z){z.writeMesh&&z.writeMesh(t,a)});const b=o.meshes.push(a)-1;return e.meshes.set(s,b),b}detectMeshQuantization(t,e){if(this.extensionsUsed[Ci])return;let o;switch(e.array.constructor){case Int8Array:o="byte";break;case Uint8Array:o="unsigned byte";break;case Int16Array:o="short";break;case Uint16Array:o="unsigned short";break;default:return}e.normalized&&(o+=" normalized");const i=t.split("_",1)[0];js[i]&&js[i].includes(o)&&(this.extensionsUsed[Ci]=!0,this.extensionsRequired[Ci]=!0)}processCamera(t){const e=this.json;e.cameras||(e.cameras=[]);const o=t.isOrthographicCamera,i={type:o?"orthographic":"perspective"};return o?i.orthographic={xmag:t.right*2,ymag:t.top*2,zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near}:i.perspective={aspectRatio:t.aspect,yfov:zt.degToRad(t.fov),zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near},t.name!==""&&(i.name=t.type),e.cameras.push(i)-1}processAnimation(t,e){const o=this.json,i=this.nodeMap;o.animations||(o.animations=[]),t=hi.Utils.mergeMorphTargetTracks(t.clone(),e);const s=t.tracks,n=[],r=[];for(let a=0;a<s.length;++a){const l=s[a],p=li.parseTrackName(l.name);let h=li.findNode(e,p.nodeName);const y=Xs[p.propertyName];if(p.objectName==="bones"&&(h.isSkinnedMesh===!0?h=h.skeleton.getBoneByName(p.objectIndex):h=void 0),!h||!y){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',l.name);continue}const c=1;let d=l.values.length/l.times.length;y===Xs.morphTargetInfluences&&(d/=h.morphTargetInfluences.length);let f;l.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(f="CUBICSPLINE",d/=3):l.getInterpolation()===Pr?f="STEP":f="LINEAR",r.push({input:this.processAccessor(new Nt(l.times,c)),output:this.processAccessor(new Nt(l.values,d)),interpolation:f}),n.push({sampler:r.length-1,target:{node:i.get(h),path:y}})}return o.animations.push({name:t.name||"clip_"+o.animations.length,samplers:r,channels:n}),o.animations.length-1}processSkin(t){const e=this.json,o=this.nodeMap,i=e.nodes[o.get(t)],s=t.skeleton;if(s===void 0)return null;const n=t.skeleton.bones[0];if(n===void 0)return null;const r=[],a=new Float32Array(s.bones.length*16),l=new Ut;for(let h=0;h<s.bones.length;++h)r.push(o.get(s.bones[h])),l.copy(s.boneInverses[h]),l.multiply(t.bindMatrix).toArray(a,h*16);return e.skins===void 0&&(e.skins=[]),e.skins.push({inverseBindMatrices:this.processAccessor(new Nt(a,16)),joints:r,skeleton:o.get(n)}),i.skin=e.skins.length-1}async processNodeAsync(t){const e=this.json,o=this.options,i=this.nodeMap;e.nodes||(e.nodes=[]);const s={};if(o.trs){const r=t.quaternion.toArray(),a=t.position.toArray(),l=t.scale.toArray();zo(r,[0,0,0,1])||(s.rotation=r),zo(a,[0,0,0])||(s.translation=a),zo(l,[1,1,1])||(s.scale=l)}else t.matrixAutoUpdate&&t.updateMatrix(),Ka(t.matrix)===!1&&(s.matrix=t.matrix.elements);if(t.name!==""&&(s.name=String(t.name)),this.serializeUserData(t,s),t.isMesh||t.isLine||t.isPoints){const r=await this.processMeshAsync(t);r!==null&&(s.mesh=r)}else t.isCamera&&(s.camera=this.processCamera(t));if(t.isSkinnedMesh&&this.skins.push(t),t.children.length>0){const r=[];for(let a=0,l=t.children.length;a<l;a++){const p=t.children[a];if(p.visible||o.onlyVisible===!1){const h=await this.processNodeAsync(p);h!==null&&r.push(h)}}r.length>0&&(s.children=r)}await this._invokeAllAsync(function(r){r.writeNode&&r.writeNode(t,s)});const n=e.nodes.push(s)-1;return i.set(t,n),n}async processSceneAsync(t){const e=this.json,o=this.options;e.scenes||(e.scenes=[],e.scene=0);const i={};t.name!==""&&(i.name=t.name),e.scenes.push(i);const s=[];for(let n=0,r=t.children.length;n<r;n++){const a=t.children[n];if(a.visible||o.onlyVisible===!1){const l=await this.processNodeAsync(a);l!==null&&s.push(l)}}s.length>0&&(i.nodes=s),this.serializeUserData(t,i)}async processObjectsAsync(t){const e=new ri;e.name="AuxScene";for(let o=0;o<t.length;o++)e.children.push(t[o]);await this.processSceneAsync(e)}async processInputAsync(t){const e=this.options;t=t instanceof Array?t:[t],await this._invokeAllAsync(function(i){i.beforeParse&&i.beforeParse(t)});const o=[];for(let i=0;i<t.length;i++)t[i]instanceof ri?await this.processSceneAsync(t[i]):o.push(t[i]);o.length>0&&await this.processObjectsAsync(o);for(let i=0;i<this.skins.length;++i)this.processSkin(this.skins[i]);for(let i=0;i<e.animations.length;++i)this.processAnimation(e.animations[i],t[0]);await this._invokeAllAsync(function(i){i.afterParse&&i.afterParse(t)})}async _invokeAllAsync(t){for(let e=0,o=this.plugins.length;e<o;e++)await t(this.plugins[e])}}class tl{constructor(t){this.writer=t,this.name="KHR_lights_punctual"}writeNode(t,e){if(!t.isLight)return;if(!t.isDirectionalLight&&!t.isPointLight&&!t.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",t);return}const o=this.writer,i=o.json,s=o.extensionsUsed,n={};t.name&&(n.name=t.name),n.color=t.color.toArray(),n.intensity=t.intensity,t.isDirectionalLight?n.type="directional":t.isPointLight?(n.type="point",t.distance>0&&(n.range=t.distance)):t.isSpotLight&&(n.type="spot",t.distance>0&&(n.range=t.distance),n.spot={},n.spot.innerConeAngle=(1-t.penumbra)*t.angle,n.spot.outerConeAngle=t.angle),t.decay!==void 0&&t.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),t.target&&(t.target.parent!==t||t.target.position.x!==0||t.target.position.y!==0||t.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),s[this.name]||(i.extensions=i.extensions||{},i.extensions[this.name]={lights:[]},s[this.name]=!0);const r=i.extensions[this.name].lights;r.push(n),e.extensions=e.extensions||{},e.extensions[this.name]={light:r.length-1}}}class el{constructor(t){this.writer=t,this.name="KHR_materials_unlit"}async writeMaterialAsync(t,e){if(!t.isMeshBasicMaterial)return;const i=this.writer.extensionsUsed;e.extensions=e.extensions||{},e.extensions[this.name]={},i[this.name]=!0,e.pbrMetallicRoughness.metallicFactor=0,e.pbrMetallicRoughness.roughnessFactor=.9}}class ol{constructor(t){this.writer=t,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.clearcoat===0)return;const o=this.writer,i=o.extensionsUsed,s={};if(s.clearcoatFactor=t.clearcoat,t.clearcoatMap){const n={index:await o.processTextureAsync(t.clearcoatMap),texCoord:t.clearcoatMap.channel};o.applyTextureTransform(n,t.clearcoatMap),s.clearcoatTexture=n}if(s.clearcoatRoughnessFactor=t.clearcoatRoughness,t.clearcoatRoughnessMap){const n={index:await o.processTextureAsync(t.clearcoatRoughnessMap),texCoord:t.clearcoatRoughnessMap.channel};o.applyTextureTransform(n,t.clearcoatRoughnessMap),s.clearcoatRoughnessTexture=n}if(t.clearcoatNormalMap){const n={index:await o.processTextureAsync(t.clearcoatNormalMap),texCoord:t.clearcoatNormalMap.channel};t.clearcoatNormalScale.x!==1&&(n.scale=t.clearcoatNormalScale.x),o.applyTextureTransform(n,t.clearcoatNormalMap),s.clearcoatNormalTexture=n}e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class il{constructor(t){this.writer=t,this.name="KHR_materials_dispersion"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.dispersion===0)return;const i=this.writer.extensionsUsed,s={};s.dispersion=t.dispersion,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class sl{constructor(t){this.writer=t,this.name="KHR_materials_iridescence"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.iridescence===0)return;const o=this.writer,i=o.extensionsUsed,s={};if(s.iridescenceFactor=t.iridescence,t.iridescenceMap){const n={index:await o.processTextureAsync(t.iridescenceMap),texCoord:t.iridescenceMap.channel};o.applyTextureTransform(n,t.iridescenceMap),s.iridescenceTexture=n}if(s.iridescenceIor=t.iridescenceIOR,s.iridescenceThicknessMinimum=t.iridescenceThicknessRange[0],s.iridescenceThicknessMaximum=t.iridescenceThicknessRange[1],t.iridescenceThicknessMap){const n={index:await o.processTextureAsync(t.iridescenceThicknessMap),texCoord:t.iridescenceThicknessMap.channel};o.applyTextureTransform(n,t.iridescenceThicknessMap),s.iridescenceThicknessTexture=n}e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class nl{constructor(t){this.writer=t,this.name="KHR_materials_transmission"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.transmission===0)return;const o=this.writer,i=o.extensionsUsed,s={};if(s.transmissionFactor=t.transmission,t.transmissionMap){const n={index:await o.processTextureAsync(t.transmissionMap),texCoord:t.transmissionMap.channel};o.applyTextureTransform(n,t.transmissionMap),s.transmissionTexture=n}e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class rl{constructor(t){this.writer=t,this.name="KHR_materials_volume"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.transmission===0)return;const o=this.writer,i=o.extensionsUsed,s={};if(s.thicknessFactor=t.thickness,t.thicknessMap){const n={index:await o.processTextureAsync(t.thicknessMap),texCoord:t.thicknessMap.channel};o.applyTextureTransform(n,t.thicknessMap),s.thicknessTexture=n}t.attenuationDistance!==1/0&&(s.attenuationDistance=t.attenuationDistance),s.attenuationColor=t.attenuationColor.toArray(),e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class al{constructor(t){this.writer=t,this.name="KHR_materials_ior"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.ior===1.5)return;const i=this.writer.extensionsUsed,s={};s.ior=t.ior,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class ll{constructor(t){this.writer=t,this.name="KHR_materials_specular"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.specularIntensity===1&&t.specularColor.equals(Ya)&&!t.specularIntensityMap&&!t.specularColorMap)return;const o=this.writer,i=o.extensionsUsed,s={};if(t.specularIntensityMap){const n={index:await o.processTextureAsync(t.specularIntensityMap),texCoord:t.specularIntensityMap.channel};o.applyTextureTransform(n,t.specularIntensityMap),s.specularTexture=n}if(t.specularColorMap){const n={index:await o.processTextureAsync(t.specularColorMap),texCoord:t.specularColorMap.channel};o.applyTextureTransform(n,t.specularColorMap),s.specularColorTexture=n}s.specularFactor=t.specularIntensity,s.specularColorFactor=t.specularColor.toArray(),e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class cl{constructor(t){this.writer=t,this.name="KHR_materials_sheen"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.sheen==0)return;const o=this.writer,i=o.extensionsUsed,s={};if(t.sheenRoughnessMap){const n={index:await o.processTextureAsync(t.sheenRoughnessMap),texCoord:t.sheenRoughnessMap.channel};o.applyTextureTransform(n,t.sheenRoughnessMap),s.sheenRoughnessTexture=n}if(t.sheenColorMap){const n={index:await o.processTextureAsync(t.sheenColorMap),texCoord:t.sheenColorMap.channel};o.applyTextureTransform(n,t.sheenColorMap),s.sheenColorTexture=n}s.sheenRoughnessFactor=t.sheenRoughness,s.sheenColorFactor=t.sheenColor.toArray(),e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class pl{constructor(t){this.writer=t,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(t,e){if(!t.isMeshPhysicalMaterial||t.anisotropy==0)return;const o=this.writer,i=o.extensionsUsed,s={};if(t.anisotropyMap){const n={index:await o.processTextureAsync(t.anisotropyMap)};o.applyTextureTransform(n,t.anisotropyMap),s.anisotropyTexture=n}s.anisotropyStrength=t.anisotropy,s.anisotropyRotation=t.anisotropyRotation,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class hl{constructor(t){this.writer=t,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(t,e){if(!t.isMeshStandardMaterial||t.emissiveIntensity===1)return;const i=this.writer.extensionsUsed,s={};s.emissiveStrength=t.emissiveIntensity,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class yl{constructor(t){this.writer=t,this.name="EXT_materials_bump"}async writeMaterialAsync(t,e){if(!t.isMeshStandardMaterial||t.bumpScale===1&&!t.bumpMap)return;const o=this.writer,i=o.extensionsUsed,s={};if(t.bumpMap){const n={index:await o.processTextureAsync(t.bumpMap),texCoord:t.bumpMap.channel};o.applyTextureTransform(n,t.bumpMap),s.bumpTexture=n}s.bumpFactor=t.bumpScale,e.extensions=e.extensions||{},e.extensions[this.name]=s,i[this.name]=!0}}class ul{constructor(t){this.writer=t,this.name="EXT_mesh_gpu_instancing"}writeNode(t,e){if(!t.isInstancedMesh)return;const o=this.writer,i=t,s=new Float32Array(i.count*3),n=new Float32Array(i.count*4),r=new Float32Array(i.count*3),a=new Ut,l=new X,p=new Oe,h=new X;for(let c=0;c<i.count;c++)i.getMatrixAt(c,a),a.decompose(l,p,h),l.toArray(s,c*3),p.toArray(n,c*4),h.toArray(r,c*3);const y={TRANSLATION:o.processAccessor(new Nt(s,3)),ROTATION:o.processAccessor(new Nt(n,4)),SCALE:o.processAccessor(new Nt(r,3))};i.instanceColor&&(y._COLOR_0=o.processAccessor(i.instanceColor)),e.extensions=e.extensions||{},e.extensions[this.name]={attributes:y},o.extensionsUsed[this.name]=!0,o.extensionsRequired[this.name]=!0}}hi.Utils={insertKeyframe:function(u,t){const o=u.getValueSize(),i=new u.TimeBufferType(u.times.length+1),s=new u.ValueBufferType(u.values.length+o),n=u.createInterpolant(new u.ValueBufferType(o));let r;if(u.times.length===0){i[0]=t;for(let a=0;a<o;a++)s[a]=0;r=0}else if(t<u.times[0]){if(Math.abs(u.times[0]-t)<.001)return 0;i[0]=t,i.set(u.times,1),s.set(n.evaluate(t),0),s.set(u.values,o),r=0}else if(t>u.times[u.times.length-1]){if(Math.abs(u.times[u.times.length-1]-t)<.001)return u.times.length-1;i[i.length-1]=t,i.set(u.times,0),s.set(u.values,0),s.set(n.evaluate(t),u.values.length),r=i.length-1}else for(let a=0;a<u.times.length;a++){if(Math.abs(u.times[a]-t)<.001)return a;if(u.times[a]<t&&u.times[a+1]>t){i.set(u.times.slice(0,a+1),0),i[a+1]=t,i.set(u.times.slice(a+1),a+2),s.set(u.values.slice(0,(a+1)*o),0),s.set(n.evaluate(t),(a+1)*o),s.set(u.values.slice((a+1)*o),(a+2)*o),r=a+1;break}}return u.times=i,u.values=s,r},mergeMorphTargetTracks:function(u,t){const e=[],o={},i=u.tracks;for(let s=0;s<i.length;++s){let n=i[s];const r=li.parseTrackName(n.name),a=li.findNode(t,r.nodeName);if(r.propertyName!=="morphTargetInfluences"||r.propertyIndex===void 0){e.push(n);continue}if(n.createInterpolant!==n.InterpolantFactoryMethodDiscrete&&n.createInterpolant!==n.InterpolantFactoryMethodLinear){if(n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),n=n.clone(),n.setInterpolation(Xr)}const l=a.morphTargetInfluences.length,p=a.morphTargetDictionary[r.propertyIndex];if(p===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+r.propertyIndex);let h;if(o[a.uuid]===void 0){h=n.clone();const c=new h.ValueBufferType(l*h.times.length);for(let d=0;d<h.times.length;d++)c[d*l+p]=h.values[d];h.name=(r.nodeName||"")+".morphTargetInfluences",h.values=c,o[a.uuid]=h,e.push(h);continue}const y=n.createInterpolant(new n.ValueBufferType(1));h=o[a.uuid];for(let c=0;c<h.times.length;c++)h.values[c*l+p]=y.evaluate(h.times[c]);for(let c=0;c<n.times.length;c++){const d=this.insertKeyframe(h,n.times[c]);h.values[d*l+p]=n.values[c]}}return u.tracks=e,u},toFloat32BufferAttribute:function(u){const t=new Nt(new Float32Array(u.count*u.itemSize),u.itemSize,!1);if(!u.normalized&&!u.isInterleavedBufferAttribute)return t.array.set(u.array),t;for(let e=0,o=u.count;e<o;e++)for(let i=0;i<u.itemSize;i++)t.setComponent(e,i,u.getComponent(e,i));return t}};const Ze={east:{axis:"x",sign:1,opposite:"west"},west:{axis:"x",sign:-1,opposite:"east"},top:{axis:"y",sign:1,opposite:"bottom"},bottom:{axis:"y",sign:-1,opposite:"top"},south:{axis:"z",sign:1,opposite:"north"},north:{axis:"z",sign:-1,opposite:"south"}};class dl{constructor(){this.stats={originalFaces:0,optimizedFaces:0,culledFaces:0,mergedQuads:0}}optimize(t,e={}){const{cullFaces:o=!0,mergeCubes:i=!0,batchMaterials:s=!0,mergeAll:n=!1,deduplicateVertices:r=!0}=e;this.resetStats();const a=this.buildBlockMap(t),l=[],p=[];for(const y of t)y.type==="cube"?l.push(y):p.push(y);let h=[];if(l.length>0)if(i){const y=this.greedyMeshCubes(l,a,o,s);h.push(...y)}else if(o){const y=this.cullCubeFaces(l,a,s);h.push(...y)}else{const y=this.createSimpleMeshes(l,s);h.push(...y)}if(p.length>0){const y=this.processNonCubeBlocks(p,a,o,s);h.push(...y)}return n&&h.length>1&&(h=this.mergeAllMeshes(h)),r&&(h=h.map(y=>{const c=this.deduplicateGeometryVertices(y.geometry);return y.geometry.dispose(),y.geometry=c,y})),this.stats.finalMeshCount=h.length,this.stats.finalVertexCount=h.reduce((y,c)=>{var d;return y+(((d=c.geometry.getAttribute("position"))==null?void 0:d.count)||0)},0),this.stats.finalTriangleCount=h.reduce((y,c)=>{var f;const d=c.geometry.getIndex();return d?y+d.count/3:y+(((f=c.geometry.getAttribute("position"))==null?void 0:f.count)||0)/3},0),{meshes:h,stats:{...this.stats}}}resetStats(){this.stats={originalFaces:0,optimizedFaces:0,culledFaces:0,mergedQuads:0}}buildBlockMap(t){const e=new Map;for(const o of t){const i=o.gridPosition,s=`${i.x},${i.y},${i.z}`;e.set(s,o)}return e}hasNeighbor(t,e,o,i){return t.has(`${e},${o},${i}`)}getNeighbor(t,e,o,i){return t.get(`${e},${o},${i}`)}shouldCullFace(t,e,o){const i=t.gridPosition,s=Ze[e],n={x:i.x+(s.axis==="x"?s.sign:0),y:i.y+(s.axis==="y"?s.sign:0),z:i.z+(s.axis==="z"?s.sign:0)},r=this.getNeighbor(o,n.x,n.y,n.z);return r?r.type==="cube":!1}greedyMeshCubes(t,e,o,i){const s=new Map;for(const r of t){const a=r.color.toLowerCase();s.has(a)||s.set(a,[]),s.get(a).push(r)}const n=[];for(const[r,a]of s){const l=new Set;for(const h of a){const y=h.gridPosition;l.add(`${y.x},${y.y},${y.z}`)}const p=[];for(const[h,y]of Object.entries(Ze)){const c=this.greedyMeshFace(a,h,y,l,e,o);p.push(...c)}if(this.stats.originalFaces+=a.length*6,p.length>0){const h=this.createGeometryFromQuads(p),y=new It(h,new Ct({color:new ot(r),roughness:.7,metalness:.1}));y.name=`merged_cubes_${r}`,n.push(y),this.stats.optimizedFaces+=p.length,this.stats.mergedQuads+=p.length}}return n}greedyMeshFace(t,e,o,i,s,n){const r=[],a=["x","y","z"].filter(y=>y!==o.axis),[l,p]=a,h=new Map;for(const y of t){const c=y.gridPosition,d=c[o.axis];h.has(d)||h.set(d,new Map);let f=!0;if(n){const m={x:c.x+(o.axis==="x"?o.sign:0),y:c.y+(o.axis==="y"?o.sign:0),z:c.z+(o.axis==="z"?o.sign:0)},x=`${m.x},${m.y},${m.z}`;i.has(x)?(f=!1,this.stats.culledFaces++):s.has(x)&&(f=!1,this.stats.culledFaces++)}if(f){const m=c[l],x=c[p];h.get(d).set(`${m},${x}`,{pos:c,cube:y})}}for(const[y,c]of h){const d=new Set,f=Array.from(c.keys()).map(m=>{const[x,g]=m.split(",").map(Number);return{u:x,v:g,key:m}}).sort((m,x)=>m.v-x.v||m.u-x.u);for(const{u:m,v:x,key:g}of f){if(d.has(g))continue;let b=1,z=1;for(;c.has(`${m+b},${x}`)&&!d.has(`${m+b},${x}`);)b++;t:for(;;){for(let C=0;C<b;C++){const B=`${m+C},${x+z}`;if(!c.has(B)||d.has(B))break t}z++}for(let C=0;C<b;C++)for(let B=0;B<z;B++)d.add(`${m+C},${x+B}`);const v=this.createQuad(e,o,y,m,x,b,z,l,p);r.push(v)}}return r}createQuad(t,e,o,i,s,n,r,a,l){const p=[],h=e.sign>0?1:0,y=[[0,0],[n,0],[n,r],[0,r]];e.sign<0&&y.reverse();for(const[c,d]of y){const f={x:0,y:0,z:0};f[e.axis]=o+h,f[a]=i+c,f[l]=s+d,p.push(f)}return{vertices:p,normal:{x:e.axis==="x"?e.sign:0,y:e.axis==="y"?e.sign:0,z:e.axis==="z"?e.sign:0}}}createGeometryFromQuads(t){const e=[],o=[],i=[];let s=0;for(const r of t){for(const a of r.vertices)e.push(a.x,a.y,a.z),o.push(r.normal.x,r.normal.y,r.normal.z);i.push(s,s+1,s+2,s,s+2,s+3),s+=4}const n=new ce;return n.setAttribute("position",new _t(e,3)),n.setAttribute("normal",new _t(o,3)),n.setIndex(i),n}cullCubeFaces(t,e,o){const i=o?new Map:null,s=[];for(const n of t){const r=n.gridPosition,a=[];this.stats.originalFaces+=6;for(const[h,y]of Object.entries(Ze))this.shouldCullFace(n,h,e)?this.stats.culledFaces++:(a.push(h),this.stats.optimizedFaces++);if(a.length===0)continue;const l=this.createCubeWithFaces(r,a),p=n.color.toLowerCase();if(o)i.has(p)||i.set(p,[]),i.get(p).push(l);else{const h=new It(l,new Ct({color:new ot(p),roughness:.7,metalness:.1}));s.push(h)}}if(o&&i)for(const[n,r]of i){const a=this.mergeGeometries(r),l=new It(a,new Ct({color:new ot(n),roughness:.7,metalness:.1}));l.name=`culled_cubes_${n}`,s.push(l)}return s}createCubeWithFaces(t,e){const o=[];for(const i of e){const s=Ze[i],n=["x","y","z"].filter(r=>r!==s.axis);o.push(this.createQuad(i,s,t[s.axis],t[n[0]],t[n[1]],1,1,n[0],n[1]))}return this.createGeometryFromQuads(o)}mergeGeometries(t){const e=[],o=[],i=[];let s=0;for(const r of t){const a=r.getAttribute("position"),l=r.getAttribute("normal"),p=r.getIndex();for(let h=0;h<a.count;h++)e.push(a.getX(h),a.getY(h),a.getZ(h)),o.push(l.getX(h),l.getY(h),l.getZ(h));for(let h=0;h<p.count;h++)i.push(p.getX(h)+s);s+=a.count,r.dispose()}const n=new ce;return n.setAttribute("position",new _t(e,3)),n.setAttribute("normal",new _t(o,3)),n.setIndex(i),n}processNonCubeBlocks(t,e,o,i){const s=[],n=i?new Map:null;for(const r of t){const a=r.mesh.geometry.clone(),l=new Ut;l.compose(r.mesh.position,r.mesh.quaternion,r.mesh.scale),a.applyMatrix4(l);const p=r.color.toLowerCase(),h=a.index?a.index.count:a.attributes.position.count;if(this.stats.originalFaces+=Math.floor(h/6),this.stats.optimizedFaces+=Math.floor(h/6),i)n.has(p)||n.set(p,[]),n.get(p).push(a);else{const y=new It(a,new Ct({color:new ot(p),roughness:.7,metalness:.1}));s.push(y)}}if(i&&n)for(const[r,a]of n){const l=this.mergeNonIndexedGeometries(a),p=new It(l,new Ct({color:new ot(r),roughness:.7,metalness:.1}));p.name=`other_blocks_${r}`,s.push(p)}return s}mergeNonIndexedGeometries(t){const e=[],o=[],i=[];let s=!1;for(const r of t){const a=r.getAttribute("position"),l=r.getAttribute("normal"),p=r.getAttribute("uv");if(p&&(s=!0),r.index){const h=r.index;for(let y=0;y<h.count;y++){const c=h.getX(y);e.push(a.getX(c),a.getY(c),a.getZ(c)),l&&o.push(l.getX(c),l.getY(c),l.getZ(c)),p&&i.push(p.getX(c),p.getY(c))}}else for(let h=0;h<a.count;h++)e.push(a.getX(h),a.getY(h),a.getZ(h)),l&&o.push(l.getX(h),l.getY(h),l.getZ(h)),p&&i.push(p.getX(h),p.getY(h));r.dispose()}const n=new ce;return n.setAttribute("position",new _t(e,3)),o.length>0?n.setAttribute("normal",new _t(o,3)):n.computeVertexNormals(),s&&i.length>0&&n.setAttribute("uv",new _t(i,2)),n}createSimpleMeshes(t,e){const o=e?new Map:null,i=[];for(const s of t){const n=new bi(1,1,1);n.translate(s.gridPosition.x+.5,s.gridPosition.y+.5,s.gridPosition.z+.5),this.stats.originalFaces+=6,this.stats.optimizedFaces+=6;const r=s.color.toLowerCase();if(e)o.has(r)||o.set(r,[]),o.get(r).push(n);else{const a=new It(n,new Ct({color:new ot(r),roughness:.7,metalness:.1}));i.push(a)}}if(e&&o)for(const[s,n]of o){const r=this.mergeGeometries(n),a=new It(r,new Ct({color:new ot(s),roughness:.7,metalness:.1}));a.name=`simple_cubes_${s}`,i.push(a)}return i}estimateFaceCount(t){let e=0;for(const o of t)if(o.type==="cube")e+=6;else{const i=o.mesh.geometry,s=i.index?i.index.count:i.attributes.position.count;e+=Math.floor(s/6)}return e}createInstancedExport(t){const e=new Map;for(const l of t)e.has(l.type)||e.set(l.type,[]),e.get(l.type).push(l);const o=[],i=new Ut,s=new X,n=new Oe,r=new X(1,1,1),a=new Bo;for(const[l,p]of e){if(p.length===0)continue;const y=p[0].mesh.geometry.clone(),c=new Yn(y,new Ct({vertexColors:!0,roughness:.7,metalness:.1}),p.length),d=new Float32Array(p.length*3);p.forEach((f,m)=>{s.copy(f.mesh.position),a.set(zt.degToRad(f.rotation.x),zt.degToRad(f.rotation.y),zt.degToRad(f.rotation.z)),n.setFromEuler(a),i.compose(s,n,r),c.setMatrixAt(m,i);const x=new ot(f.color);d[m*3]=x.r,d[m*3+1]=x.g,d[m*3+2]=x.b}),c.instanceColor=new Zr(d,3),c.instanceMatrix.needsUpdate=!0,c.name=`instanced_${l}`,c.castShadow=!0,c.receiveShadow=!0,o.push(c)}return{meshes:o,stats:{totalBlocks:t.length,uniqueTypes:e.size,drawCalls:o.length}}}estimateOptimizedCount(t,e={}){const{cullFaces:o=!0,mergeCubes:i=!0}=e;if(!o&&!i)return this.estimateFaceCount(t);const s=this.buildBlockMap(t);let n=0;for(const r of t)if(r.type==="cube")for(const a of Object.keys(Ze))(!o||!this.shouldCullFace(r,a,s))&&n++;else{const a=r.mesh.geometry,l=a.index?a.index.count:a.attributes.position.count;n+=Math.floor(l/6)}if(i){const r=t.filter(p=>p.type==="cube").length,a=n-(r>0?t.filter(p=>p.type==="cube").reduce((p,h)=>{let y=0;for(const c of Object.keys(Ze))(!o||!this.shouldCullFace(h,c,s))&&y++;return p+y},0):0),l=n-a;n=Math.floor(l*.4)+a}return n}mergeAllMeshes(t){if(t.length===0)return[];if(t.length===1)return t;const e=[];for(const n of t){const r=n.geometry.clone(),a=n.material.color||new ot(8421504),l=r.getAttribute("position").count,p=new Float32Array(l*3);for(let h=0;h<l;h++)p[h*3]=a.r,p[h*3+1]=a.g,p[h*3+2]=a.b;r.setAttribute("color",new Nt(p,3)),e.push(r),n.geometry.dispose(),n.material.dispose()}const o=Gr(e,!1);e.forEach(n=>n.dispose());const i=new Ct({vertexColors:!0,roughness:.7,metalness:.1}),s=new It(o,i);return s.name="merged_all",[s]}deduplicateGeometryVertices(t){const e=t.getAttribute("position"),o=t.getAttribute("normal"),i=t.getAttribute("color"),s=t.getAttribute("uv"),n=t.getIndex();if(!e)return t;const r=new Map,a=[],l=[],p=[],h=[],y=[],c=1e3,d=b=>{const z=Math.round(e.getX(b)*c),v=Math.round(e.getY(b)*c),C=Math.round(e.getZ(b)*c);let B=`${z},${v},${C}`;if(o){const A=Math.round(o.getX(b)*100),M=Math.round(o.getY(b)*100),S=Math.round(o.getZ(b)*100);B+=`|${A},${M},${S}`}if(i){const A=Math.round(i.getX(b)*255),M=Math.round(i.getY(b)*255),S=Math.round(i.getZ(b)*255);B+=`|${A},${M},${S}`}return B},f=b=>{const z=d(b);if(r.has(z))return r.get(z);const v=a.length/3;return r.set(z,v),a.push(e.getX(b),e.getY(b),e.getZ(b)),o&&l.push(o.getX(b),o.getY(b),o.getZ(b)),i&&p.push(i.getX(b),i.getY(b),i.getZ(b)),s&&h.push(s.getX(b),s.getY(b)),v};if(n)for(let b=0;b<n.count;b++){const z=n.getX(b),v=f(z);y.push(v)}else for(let b=0;b<e.count;b++){const z=f(b);y.push(z)}const m=new ce;m.setAttribute("position",new _t(a,3)),l.length>0&&m.setAttribute("normal",new _t(l,3)),p.length>0&&m.setAttribute("color",new _t(p,3)),h.length>0&&m.setAttribute("uv",new _t(h,2)),m.setIndex(y);const x=e.count,g=a.length/3;return this.stats.verticesRemoved=(this.stats.verticesRemoved||0)+(x-g),m}}class fl{constructor(){this.exporter=new hi,this.optimizer=new dl}async exportScene(t,e={}){var g;const{binary:o=!0,includeAnimations:i=!1,animator:s=null,bakedTexture:n=null,uvData:r=null,cullFaces:a=!1,mergeCubes:l=!1,batchMaterials:p=!1,useInstancing:h=!1,mergeAll:y=!1,deduplicateVertices:c=!0}=e;if(t.blocks.size===0)throw new Error("No blocks to export");const d=new ri,f=t.getAllBlocks(),m=a||l||p||y;if(h&&!n){const b=this.optimizer.createInstancedExport(f);for(const z of b.meshes)d.add(z);console.log("Instancing stats:",b.stats)}else if(m&&!n){const b=this.optimizer.optimize(f,{cullFaces:a,mergeCubes:l,batchMaterials:p,mergeAll:y,deduplicateVertices:c});for(const z of b.meshes)d.add(z);console.log("Optimization stats:",b.stats)}else{let b=null;n&&(b=new fs(n),b.magFilter=xe,b.minFilter=xe,b.generateMipmaps=!1,b.flipY=!1,b.colorSpace=ys);const z=["east","west","top","bottom","south","north"];for(const v of f){const C=v.mesh.clone();C.name=v.id,C.geometry=v.mesh.geometry.clone();const B=Array.isArray(v.mesh.material)?v.mesh.material[0]:v.mesh.material;let A;if(b&&r&&r.has(v.id)){const M=r.get(v.id),S=C.geometry.getAttribute("uv");if(S&&M.faceUVs){for(let k=0;k<6;k++){const D=z[k],F=M.faceUVs[D];if(F)for(let T=0;T<4;T++){const K=k*4+T;S.setXY(K,F.u,F.v)}}S.needsUpdate=!0}A=new Ct({map:b,roughness:B.roughness||.7,metalness:B.metalness||.1})}else A=new Ct({color:new ot(v.color),roughness:B.roughness||.7,metalness:B.metalness||.1});(g=v.emissive)!=null&&g.enabled&&(A.emissive=new ot(v.emissive.color),A.emissiveIntensity=v.emissive.intensity),C.material=A,d.add(C)}}const x=[];if(i&&s&&s.getAllAnimations().length>0)for(const b of s.getAllAnimations()){const z=this.buildAnimationClip(b,t);z&&x.push(z)}try{const b=await this.exporter.parseAsync(d,{binary:o,animations:x});return this.disposeScene(d),b}catch(b){throw this.disposeScene(d),b}}disposeScene(t){t.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(o=>{o.map&&o.map.dispose(),o.dispose()}):(e.material.map&&e.material.map.dispose(),e.material.dispose()))})}buildAnimationClip(t,e){const o=[],i=new Map;for(const s of t.keyframes)i.has(s.blockId)||i.set(s.blockId,[]),i.get(s.blockId).push(s);for(const[s,n]of i){const r=e.blocks.get(s);if(!r)continue;const a=r.id,l=[],p=[],h=[],y=[];for(const c of n){const d=c.time/1e3;if(c.properties.position){l.push(d);const f=c.properties.position;p.push(f.x+.5,f.y+.5,f.z+.5)}if(c.properties.rotation){h.push(d);const f=new Bo(zt.degToRad(c.properties.rotation.x),zt.degToRad(c.properties.rotation.y),zt.degToRad(c.properties.rotation.z)),m=new Oe().setFromEuler(f);y.push(m.x,m.y,m.z,m.w)}}l.length>0&&o.push(new Yr(`${a}.position`,l,p)),h.length>0&&o.push(new Vr(`${a}.quaternion`,h,y))}return o.length===0?null:new $r(t.name,t.duration/1e3,o)}downloadFile(t,e,o=!0){const i=o?new Blob([t],{type:"application/octet-stream"}):new Blob([JSON.stringify(t)],{type:"application/json"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=e,n.click(),URL.revokeObjectURL(s)}getOptimizationStats(t,e={}){const o=t.getAllBlocks(),i=this.optimizer.estimateFaceCount(o),s=this.optimizer.estimateOptimizedCount(o,e);return{blockCount:o.length,originalFaces:i,optimizedFaces:s,reduction:i>0?Math.round((1-s/i)*100):0}}}class ml{constructor(){this.raycaster=new hs,this.ambientLight=new ot(.15,.15,.15)}bake(t){const e=t.getAllBlocks(),o=e.filter(n=>{var r;return(r=n.emissive)==null?void 0:r.enabled}),i=e.map(n=>n.mesh);console.log(`Baking lighting: ${o.length} emissive blocks, ${e.length} total blocks`);const s=new Map;for(const n of e){const r=this.bakeBlockVertices(n,o,i);s.set(n.id,r)}return s}apply(t,e){for(const[o,i]of e){const s=t.getBlockById(o);if(!s)continue;s.mesh.geometry.setAttribute("color",new Nt(i,3));const r=a=>{a.vertexColors=!0,a.needsUpdate=!0};Array.isArray(s.mesh.material)?s.mesh.material.forEach(r):r(s.mesh.material)}}bakeBlockVertices(t,e,o){const i=t.mesh.geometry,s=i.getAttribute("position"),n=i.getAttribute("normal"),r=s.count,a=new Float32Array(r*3),l=new X,p=new X,h=new Vn().getNormalMatrix(t.mesh.matrixWorld);t.mesh.updateMatrixWorld();for(let y=0;y<r;y++){l.fromBufferAttribute(s,y),l.applyMatrix4(t.mesh.matrixWorld),n?(p.fromBufferAttribute(n,y),p.applyMatrix3(h).normalize()):p.set(0,1,0);const c=this.calculateLightAtPoint(l,p,e,o,t.mesh),d=new ot(t.color);a[y*3]=Math.min(1,d.r*c.r),a[y*3+1]=Math.min(1,d.g*c.g),a[y*3+2]=Math.min(1,d.b*c.b)}return a}calculateLightAtPoint(t,e,o,i,s){const n=this.ambientLight.clone();for(const r of o){const a=this.getBlockCenter(r),l=new X().subVectors(a,t),p=l.length();if(p>r.emissive.radius)continue;l.normalize();const h=Math.max(0,e.dot(l));if(h<=0||this.isOccluded(t,a,i,s,r.mesh))continue;const c=p/r.emissive.radius,d=Math.pow(1-c,2),f=new ot(r.emissive.color),m=r.emissive.intensity*h*d;n.r+=f.r*m,n.g+=f.g*m,n.b+=f.b*m}return n}getBlockCenter(t){const e=t.gridPosition,o=t.dimensions,i=io[t.type]||1,s=so[t.type]||0,n=o.h*i;return new X(e.x+o.w/2,e.y+s+n/2,e.z+o.d/2)}isOccluded(t,e,o,i,s){const n=new X().subVectors(e,t),r=n.length();n.normalize();const a=t.clone().addScaledVector(n,.01);this.raycaster.set(a,n),this.raycaster.far=r-.02;const l=o.filter(h=>h!==i&&h!==s);return this.raycaster.intersectObjects(l,!1).length>0}clear(t){for(const e of t.getAllBlocks()){const o=e.mesh.geometry;o.hasAttribute("color")&&o.deleteAttribute("color");const i=s=>{s.vertexColors=!1,s.needsUpdate=!0};Array.isArray(e.mesh.material)?e.mesh.material.forEach(i):i(e.mesh.material)}}generateDebugTexture(t,e={}){const{cellSize:o=32,columns:i=8,showLighting:s=!0,showBaseColors:n=!0}=e,r=t.getAllBlocks(),a=Math.ceil(r.length/i),l=i*o,p=Math.max(a*o*(s&&n?2:1),o),h=document.createElement("canvas");h.width=l,h.height=p;const y=h.getContext("2d");return y.fillStyle="#000000",y.fillRect(0,0,l,p),r.forEach((c,d)=>{var g;const f=d%i,m=Math.floor(d/i),x=f*o;if(n){const b=m*o;y.fillStyle=c.color,y.fillRect(x+1,b+1,o-2,o-2),y.fillStyle="#ffffff",y.font="8px monospace",y.fillText(c.type.slice(0,4),x+2,b+10)}if(s){const b=(n?a+m:m)*o,z=c.mesh.geometry;if(z.hasAttribute("color")){const v=z.getAttribute("color");let C=0,B=0,A=0;for(let k=0;k<v.count;k++)C+=v.getX(k),B+=v.getY(k),A+=v.getZ(k);C/=v.count,B/=v.count,A/=v.count;const M=Math.round(C*255),S=Math.round(B*255),P=Math.round(A*255);y.fillStyle=`rgb(${M},${S},${P})`}else y.fillStyle=c.color;y.fillRect(x+1,b+1,o-2,o-2),(g=c.emissive)!=null&&g.enabled&&(y.strokeStyle=c.emissive.color,y.lineWidth=2,y.strokeRect(x+2,b+2,o-4,o-4))}}),y.fillStyle="#ffffff",y.font="10px monospace",n&&s&&(y.fillText("Base Colors",4,a*o-4),y.fillText("Baked",4,p-4)),h}generateLightmapTexture(t,e={}){const{cellSize:o=32,columns:i=8}=e,s=t.getAllBlocks(),n=Math.ceil(s.length/i),r=i*o,a=Math.max(n*o,o),l=document.createElement("canvas");l.width=r,l.height=a;const p=l.getContext("2d");return p.fillStyle="#808080",p.fillRect(0,0,r,a),s.forEach((h,y)=>{const c=y%i,d=Math.floor(y/i),f=c*o,m=d*o,x=h.mesh.geometry;if(x.hasAttribute("color")){const g=x.getAttribute("color"),b=new ot(h.color);let z=new ot(0,0,0),v=0;for(let M=0;M<g.count;M++){const S=g.getX(M),P=g.getY(M),k=g.getZ(M),D=b.r>.01?S/b.r:S,F=b.g>.01?P/b.g:P,T=b.b>.01?k/b.b:k;z.r+=D,z.g+=F,z.b+=T,v++}v>0&&(z.r/=v,z.g/=v,z.b/=v);const C=Math.round(Math.min(1,z.r)*255),B=Math.round(Math.min(1,z.g)*255),A=Math.round(Math.min(1,z.b)*255);p.fillStyle=`rgb(${C},${B},${A})`}else p.fillStyle="#262626";p.fillRect(f,m,o,o),p.strokeStyle="#333333",p.strokeRect(f,m,o,o)}),l}downloadCanvasAsPNG(t,e){const o=document.createElement("a");o.download=e,o.href=t.toDataURL("image/png"),o.click()}}class xl{constructor(){this.raycaster=new hs,this.ambientLight=new ot(.15,.15,.15),this.faceOrder=["east","west","top","bottom","south","north"],this.faceNormals={east:new X(1,0,0),west:new X(-1,0,0),top:new X(0,1,0),bottom:new X(0,-1,0),south:new X(0,0,1),north:new X(0,0,-1)}}bake(t){const e=t.getAllBlocks(),o=e.filter(c=>{var d;return(d=c.emissive)==null?void 0:d.enabled}),i=e.map(c=>c.mesh);o.length===0&&console.warn("No emissive blocks found for texture baking"),console.log(`Texture baking: ${o.length} emissive blocks, ${e.length} total blocks`);const n=e.length*6,r=Math.ceil(Math.sqrt(n)),a=Math.ceil(n/r);console.log(`Atlas size: ${r}x${a} (${n} pixels for ${e.length} blocks)`);const l=document.createElement("canvas");l.width=r,l.height=a;const p=l.getContext("2d");p.fillStyle="#000000",p.fillRect(0,0,r,a);const h=new Map;let y=0;for(const c of e){const d={};for(const f of this.faceOrder){const m=y%r,x=Math.floor(y/r),g=this.calculateFaceLighting(c,f,o,i),b=Math.round(Math.min(1,g.r)*255),z=Math.round(Math.min(1,g.g)*255),v=Math.round(Math.min(1,g.b)*255);p.fillStyle=`rgb(${b},${z},${v})`,p.fillRect(m,x,1,1),d[f]={u:(m+.5)/r,v:1-(x+.5)/a},y++}h.set(c.id,{faceUVs:d})}return{texture:l,uvData:h,atlasWidth:r,atlasHeight:a}}calculateFaceLighting(t,e,o,i){var p,h,y;const s=new ot(t.color),n=this.faceNormals[e].clone(),r=new Bo(zt.degToRad(((p=t.rotation)==null?void 0:p.x)||0),zt.degToRad(((h=t.rotation)==null?void 0:h.y)||0),zt.degToRad(((y=t.rotation)==null?void 0:y.z)||0));n.applyEuler(r);const a=this.getFaceCenter(t,e),l=this.calculateLightAtPoint(a,n,o,i,t.mesh);return new ot(Math.min(1,s.r*l.r),Math.min(1,s.g*l.g),Math.min(1,s.b*l.b))}getFaceCenter(t,e){var h,y,c;const o=t.gridPosition,i=t.dimensions,s=io[t.type]||1,n=so[t.type]||0,r=i.h*s,a=new X(o.x+i.w/2,o.y+n+r/2,o.z+i.d/2),l=new X;switch(e){case"east":l.set(i.w/2,0,0);break;case"west":l.set(-i.w/2,0,0);break;case"top":l.set(0,r/2,0);break;case"bottom":l.set(0,-r/2,0);break;case"south":l.set(0,0,i.d/2);break;case"north":l.set(0,0,-i.d/2);break}const p=new Bo(zt.degToRad(((h=t.rotation)==null?void 0:h.x)||0),zt.degToRad(((y=t.rotation)==null?void 0:y.y)||0),zt.degToRad(((c=t.rotation)==null?void 0:c.z)||0));return l.applyEuler(p),a.add(l)}calculateLightAtPoint(t,e,o,i,s){const n=this.ambientLight.clone();for(const r of o){const a=this.getBlockCenter(r),l=new X().subVectors(a,t),p=l.length();if(p>r.emissive.radius)continue;l.normalize();const h=Math.max(0,e.dot(l));if(h<=0||this.isOccluded(t,a,i,s,r.mesh))continue;const c=p/r.emissive.radius,d=Math.pow(1-c,2),f=new ot(r.emissive.color),m=r.emissive.intensity*h*d;n.r+=f.r*m,n.g+=f.g*m,n.b+=f.b*m}return n}getBlockCenter(t){const e=t.gridPosition,o=t.dimensions,i=io[t.type]||1,s=so[t.type]||0,n=o.h*i;return new X(e.x+o.w/2,e.y+s+n/2,e.z+o.d/2)}isOccluded(t,e,o,i,s){const n=new X().subVectors(e,t),r=n.length();n.normalize();const a=t.clone().addScaledVector(n,.01);this.raycaster.set(a,n),this.raycaster.far=r-.02;const l=o.filter(h=>h!==i&&h!==s);return this.raycaster.intersectObjects(l,!1).length>0}applyUVs(t,e){for(const[o,i]of e){const s=t.getBlockById(o);if(!s)continue;const r=s.mesh.geometry.getAttribute("uv");if(!r){console.warn(`Block ${o} has no UV attribute`);continue}const a=4;for(let l=0;l<6;l++){const p=this.faceOrder[l],h=i.faceUVs[p];for(let y=0;y<a;y++){const c=l*a+y;r.setXY(c,h.u,h.v)}}r.needsUpdate=!0}}createTexture(t){const e=new fs(t);return e.magFilter=xe,e.minFilter=xe,e.generateMipmaps=!1,e.flipY=!1,e}}const gl={city:{label:"City",templates:["cityBlock","skyscraper","apartmentBuilding","shoppingMall","trainStation"]},buildings:{label:"Buildings",templates:["cottage","townhouse","officeBuilding","warehouse"]},medieval:{label:"Medieval",templates:["castleWall","guardTower","dungeon","tavern"]},nature:{label:"Nature",templates:["oakTree","rockGarden","pond","campsite"]},industrial:{label:"Industrial",templates:["factory","pipeNetwork","storageYard","refinery","industrialComplex","powerPlant","warehouseDistrict"]},energy:{label:"Energy",templates:["solarArrayLarge","windTurbine","substationYard","coolingTowers"]},modern:{label:"Modern",templates:["rooftopTerrace","parkingLot","busStop","solarFarm","gasStation","helipad"]},furniture:{label:"Furniture",templates:["diningRoom","livingRoom","workshop","cellar"]},infrastructure:{label:"Infrastructure",templates:["stoneBridge","streetCorner","plaza","stairway","highway","harbor"]},oil:{label:"Oil & Gas",templates:["oilDerrick","pumpJackStation","oilStorageFacility","oilFieldSite","offshorePlatform","oilRefinery","tankerLoadingStation"]},alien:{label:"Alien Structures",templates:["nexusSpire","hiveNode","energyPylon","growthChamber","scoutWisp","sentinel","construct"]}},Ji={cottage:{name:"Cozy Cottage",category:"buildings",description:"A charming rustic cottage with detailed architecture",blocks:[...L(-1,0,-1,6,6,"#5D4037"),{type:"slab",position:{x:-1,y:0,z:-1},color:"#696969"},{type:"slab",position:{x:-1,y:0,z:4},color:"#696969"},{type:"slab",position:{x:4,y:0,z:-1},color:"#696969"},{type:"slab",position:{x:4,y:0,z:4},color:"#696969"},{type:"cube",position:{x:0,y:1,z:0},color:"#DEB887"},{type:"cube",position:{x:1,y:1,z:0},color:"#F5DEB3"},{type:"cube",position:{x:2,y:1,z:0},color:"#F5DEB3"},{type:"cube",position:{x:3,y:1,z:0},color:"#DEB887"},{type:"cube",position:{x:0,y:2,z:0},color:"#DEB887"},{type:"cube",position:{x:3,y:2,z:0},color:"#DEB887"},{type:"cube",position:{x:0,y:1,z:3},color:"#DEB887"},{type:"cube",position:{x:3,y:1,z:3},color:"#DEB887"},{type:"cube",position:{x:0,y:2,z:3},color:"#DEB887"},{type:"cube",position:{x:1,y:2,z:3},color:"#F5DEB3"},{type:"cube",position:{x:2,y:2,z:3},color:"#F5DEB3"},{type:"cube",position:{x:3,y:2,z:3},color:"#DEB887"},{type:"cube",position:{x:0,y:1,z:1},color:"#DEB887"},{type:"cube",position:{x:0,y:1,z:2},color:"#DEB887"},{type:"cube",position:{x:0,y:2,z:1},color:"#F5DEB3"},{type:"cube",position:{x:0,y:2,z:2},color:"#F5DEB3"},{type:"cube",position:{x:3,y:1,z:1},color:"#DEB887"},{type:"cube",position:{x:3,y:1,z:2},color:"#DEB887"},{type:"cube",position:{x:3,y:2,z:1},color:"#F5DEB3"},{type:"cube",position:{x:3,y:2,z:2},color:"#F5DEB3"},{type:"beam2X",position:{x:0,y:1,z:0},color:"#5D4037"},{type:"beam2X",position:{x:2,y:1,z:0},color:"#5D4037"},{type:"beam2Z",position:{x:0,y:1,z:0},color:"#5D4037"},{type:"beam2Z",position:{x:0,y:1,z:2},color:"#5D4037"},{type:"beam2Z",position:{x:3,y:1,z:0},color:"#5D4037"},{type:"beam2Z",position:{x:3,y:1,z:2},color:"#5D4037"},{type:"windowFrame",position:{x:1,y:2,z:0},color:"#8B4513"},{type:"windowFrame",position:{x:2,y:2,z:0},color:"#8B4513"},{type:"windowSill",position:{x:1,y:1,z:-1},color:"#5D4037"},{type:"windowSill",position:{x:2,y:1,z:-1},color:"#5D4037"},{type:"windowFrame",position:{x:0,y:2,z:2},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"doorFrame",position:{x:1,y:1,z:3},color:"#654321"},{type:"doorFrame",position:{x:2,y:1,z:3},color:"#654321"},{type:"step",position:{x:1,y:0,z:4},color:"#808080"},{type:"step",position:{x:2,y:0,z:4},color:"#808080"},{type:"wedge",position:{x:0,y:3,z:0},color:"#8B0000"},{type:"wedge",position:{x:1,y:3,z:0},color:"#8B0000"},{type:"wedge",position:{x:2,y:3,z:0},color:"#8B0000"},{type:"wedge",position:{x:3,y:3,z:0},color:"#8B0000"},{type:"wedge",position:{x:0,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:1,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:2,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:3,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},...J(0,3,1,4,"X","slab","#8B0000"),...J(0,3,2,4,"X","slab","#8B0000"),{type:"wedgeFlat",position:{x:-1,y:3,z:0},color:"#8B0000"},{type:"wedgeFlat",position:{x:4,y:3,z:0},color:"#8B0000"},{type:"wedgeFlat",position:{x:-1,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"wedgeFlat",position:{x:4,y:3,z:3},color:"#8B0000",rotation:{x:0,y:180,z:0}},{type:"chimney",position:{x:3,y:3,z:1},color:"#8B4513"},{type:"chimney",position:{x:3,y:4,z:1},color:"#704214"},{type:"chimney",position:{x:3,y:5,z:1},color:"#5D3A1A"},{type:"slab",position:{x:1,y:0,z:-1},color:"#5D4037"},{type:"slab",position:{x:2,y:0,z:-1},color:"#5D4037"},{type:"pillar2",position:{x:1,y:0,z:-1},color:"#5D4037"},{type:"pillar2",position:{x:2,y:0,z:-1},color:"#5D4037"},{type:"beam2X",position:{x:1,y:1,z:-1},color:"#5D4037"},{type:"planter",position:{x:-1,y:0,z:1},color:"#8B4513"},{type:"flower",position:{x:-1,y:1,z:1},color:"#FF69B4"},{type:"planter",position:{x:-1,y:0,z:2},color:"#8B4513"},{type:"bush",position:{x:-1,y:1,z:2},color:"#228B22"},{type:"barrel",position:{x:4,y:0,z:2},color:"#8B4513"},{type:"rock",position:{x:4,y:0,z:0},color:"#696969"},{type:"fence",position:{x:-1,y:0,z:-1},color:"#DEB887"},{type:"fence",position:{x:0,y:0,z:-1},color:"#DEB887"},{type:"fence",position:{x:3,y:0,z:-1},color:"#DEB887"},{type:"fence",position:{x:4,y:0,z:-1},color:"#DEB887"}]},townhouse:{name:"Town House",category:"buildings",description:"A tall narrow townhouse with baluster railings",blocks:[...L(0,0,0,3,3,"#696969"),...yt(0,1,0,3,3,"#F5F5DC"),...yt(0,2,0,3,3,"#F5F5DC"),...yt(0,3,0,3,3,"#F5F5DC"),{type:"slab",position:{x:0,y:2,z:-1},color:"#808080"},{type:"slab",position:{x:1,y:2,z:-1},color:"#808080"},{type:"slab",position:{x:2,y:2,z:-1},color:"#808080"},{type:"baluster",position:{x:0,y:2,z:-1},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:2,z:-1},color:"#F5F5DC"},{type:"railing",position:{x:0,y:3,z:-1},color:"#F5F5DC"},{type:"railing",position:{x:1,y:3,z:-1},color:"#F5F5DC"},{type:"railing",position:{x:2,y:3,z:-1},color:"#F5F5DC"},{type:"cornice",position:{x:0,y:4,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:1,y:4,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:2,y:4,z:0},color:"#D3D3D3"},...L(0,4,0,3,3,"#2F4F4F"),{type:"slab",position:{x:0,y:0,z:-1},color:"#696969"},{type:"slab",position:{x:1,y:0,z:-1},color:"#696969"},{type:"slab",position:{x:2,y:0,z:-1},color:"#696969"},{type:"base",position:{x:0,y:0,z:-1},color:"#F5F5DC"},{type:"base",position:{x:2,y:0,z:-1},color:"#F5F5DC"},{type:"column",position:{x:0,y:1,z:-1},color:"#F5F5DC"},{type:"column",position:{x:2,y:1,z:-1},color:"#F5F5DC"},{type:"capital",position:{x:0,y:2,z:-1},color:"#F5F5DC"},{type:"capital",position:{x:2,y:2,z:-1},color:"#F5F5DC"}]},officeBuilding:{name:"Office Building",category:"buildings",description:"Modern office with AC units and antenna",blocks:[...L(0,0,0,5,5,"#333333"),...wt(0,1,0,5,5,"#E0E0E0","#4169E1"),...wt(0,2,0,5,5,"#E0E0E0","#4169E1"),...wt(0,3,0,5,5,"#E0E0E0","#4169E1"),...wt(0,4,0,5,5,"#E0E0E0","#4169E1"),...L(0,5,0,5,5,"#404040"),{type:"acUnit",position:{x:1,y:5,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:3,y:5,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:1,y:5,z:3},color:"#C0C0C0"},{type:"acUnit",position:{x:3,y:5,z:3},color:"#C0C0C0"},{type:"antenna",position:{x:2,y:5,z:2},color:"#808080"},{type:"antenna",position:{x:2,y:6,z:2},color:"#808080"},{type:"vent",position:{x:0,y:5,z:2},color:"#696969"}]},warehouse:{name:"Warehouse",category:"buildings",description:"Industrial warehouse with crates and barrels",blocks:[...L(0,0,0,6,4,"#808080"),...at(0,1,0,6,2,"#A9A9A9"),...at(0,1,3,6,2,"#A9A9A9"),...st(0,1,1,2,2,"#A9A9A9"),...st(5,1,1,2,2,"#A9A9A9"),{type:"iBeam",position:{x:2,y:1,z:1},color:"#696969"},{type:"iBeam",position:{x:2,y:2,z:1},color:"#696969"},{type:"iBeam",position:{x:2,y:1,z:2},color:"#696969"},{type:"iBeam",position:{x:2,y:2,z:2},color:"#696969"},...L(0,3,0,6,4,"#708090"),{type:"catwalk",position:{x:1,y:3,z:1},color:"#4A4A4A"},{type:"catwalk",position:{x:1,y:3,z:2},color:"#4A4A4A"},{type:"crate",position:{x:4,y:1,z:1},color:"#8B4513"},{type:"crate",position:{x:4,y:1,z:2},color:"#8B4513"},{type:"crate",position:{x:4,y:2,z:1},color:"#A0522D"},{type:"barrel",position:{x:3,y:1,z:1},color:"#654321"},{type:"barrel",position:{x:3,y:1,z:2},color:"#654321"}]},castleWall:{name:"Castle Wall",category:"medieval",description:"Fortified wall with merlons and arrow slits",blocks:[...at(0,0,0,8,3,"#808080"),{type:"merlon",position:{x:0,y:3,z:0},color:"#696969"},{type:"merlon",position:{x:2,y:3,z:0},color:"#696969"},{type:"merlon",position:{x:4,y:3,z:0},color:"#696969"},{type:"merlon",position:{x:6,y:3,z:0},color:"#696969"},{type:"arrowSlit",position:{x:1,y:1,z:0},color:"#505050"},{type:"arrowSlit",position:{x:3,y:1,z:0},color:"#505050"},{type:"arrowSlit",position:{x:5,y:1,z:0},color:"#505050"},{type:"arrowSlit",position:{x:7,y:1,z:0},color:"#505050"},...J(0,2,1,8,"X","slab","#707070"),{type:"torch",position:{x:1,y:2,z:1},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:1.5,radius:4}},{type:"torch",position:{x:5,y:2,z:1},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:1.5,radius:4}},{type:"buttress",position:{x:0,y:0,z:1},color:"#606060"},{type:"buttress",position:{x:4,y:0,z:1},color:"#606060"},{type:"buttress",position:{x:7,y:0,z:1},color:"#606060"}]},guardTower:{name:"Guard Tower",category:"medieval",description:"Imposing medieval watchtower with battlements, arrow slits, and defensive features",blocks:[...L(0,0,0,5,5,"#505050"),{type:"cylinder",position:{x:2,y:1,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:2,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:3,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:4,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:5,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:6,z:2},color:"#505050"},{type:"arrowSlit",position:{x:2,y:2,z:0},color:"#3A3A3A"},{type:"arrowSlit",position:{x:0,y:3,z:2},color:"#3A3A3A",rotation:{x:0,y:90,z:0}},{type:"arrowSlit",position:{x:4,y:3,z:2},color:"#3A3A3A",rotation:{x:0,y:90,z:0}},{type:"arrowSlit",position:{x:2,y:4,z:4},color:"#3A3A3A",rotation:{x:0,y:180,z:0}},{type:"merlon",position:{x:1,y:6,z:1},color:"#505050"},{type:"merlon",position:{x:3,y:6,z:1},color:"#505050"},{type:"merlon",position:{x:1,y:6,z:3},color:"#505050"},{type:"merlon",position:{x:3,y:6,z:3},color:"#505050"},{type:"crenellation",position:{x:0,y:6,z:2},color:"#505050"},{type:"crenellation",position:{x:4,y:6,z:2},color:"#505050"},{type:"crenellation",position:{x:2,y:6,z:0},color:"#505050"},{type:"crenellation",position:{x:2,y:6,z:4},color:"#505050"},{type:"cone",position:{x:2,y:7,z:2},color:"#2F4F4F"},{type:"finial",position:{x:2,y:8,z:2},color:"#8B4513"},{type:"doorFrame",position:{x:2,y:1,z:0},color:"#5D4037"},{type:"archLow",position:{x:2,y:2,z:0},color:"#606060"},{type:"torch",position:{x:1,y:2,z:0},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"torch",position:{x:3,y:2,z:0},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"torch",position:{x:2,y:6,z:2},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:3,radius:8}},{type:"chain",position:{x:0,y:5,z:1},color:"#4A4A4A"},{type:"chain",position:{x:4,y:5,z:1},color:"#4A4A4A"},{type:"chain",position:{x:0,y:4,z:1},color:"#4A4A4A"},{type:"chain",position:{x:4,y:4,z:1},color:"#4A4A4A"},{type:"banner",position:{x:2,y:5,z:0},color:"#8B0000"},{type:"shield",position:{x:1,y:4,z:0},color:"#DAA520"},{type:"shield",position:{x:3,y:4,z:0},color:"#DAA520"},{type:"buttress",position:{x:0,y:0,z:1},color:"#606060"},{type:"buttress",position:{x:0,y:0,z:3},color:"#606060"},{type:"buttress",position:{x:4,y:0,z:1},color:"#606060"},{type:"buttress",position:{x:4,y:0,z:3},color:"#606060"},{type:"ladder",position:{x:1,y:1,z:1},color:"#8B4513"},{type:"ladder",position:{x:1,y:2,z:1},color:"#8B4513"},{type:"ladder",position:{x:1,y:3,z:1},color:"#8B4513"},{type:"ladder",position:{x:1,y:4,z:1},color:"#8B4513"},{type:"ladder",position:{x:1,y:5,z:1},color:"#8B4513"},{type:"rock",position:{x:0,y:0,z:0},color:"#696969"},{type:"rock",position:{x:4,y:0,z:4},color:"#707070"},{type:"boulder",position:{x:-1,y:0,z:3},color:"#5A5A5A"}]},dungeon:{name:"Dungeon Complex",category:"medieval",description:"Medieval dungeon with cells, torture chamber, guard post, and treasure room",blocks:[...L(0,0,4,12,3,"#3A3A3A"),...at(0,1,4,12,3,"#4A4A4A"),...at(0,1,6,12,3,"#4A4A4A"),...L(0,4,4,12,3,"#3A3A3A"),{type:"torch",position:{x:2,y:3,z:4},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},{type:"torch",position:{x:6,y:3,z:4},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},{type:"torch",position:{x:10,y:3,z:4},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},...L(0,0,0,4,4,"#3A3A3A"),...at(0,1,0,4,3,"#4A4A4A"),...st(0,1,1,3,3,"#4A4A4A"),...st(3,1,1,3,3,"#4A4A4A"),...L(0,4,0,4,4,"#3A3A3A"),{type:"fence",position:{x:0,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:1,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:2,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:3,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:0,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:1,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:2,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:3,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:0,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:1,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:2,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:3,y:3,z:3},color:"#2F2F2F"},{type:"chain",position:{x:1,y:2,z:0},color:"#4A4A4A"},{type:"chain",position:{x:2,y:2,z:0},color:"#4A4A4A"},{type:"chain",position:{x:1,y:1,z:0},color:"#4A4A4A"},{type:"chain",position:{x:2,y:1,z:0},color:"#4A4A4A"},{type:"slab",position:{x:0,y:1,z:1},color:"#8B7355"},...L(4,0,0,4,4,"#3A3A3A"),...at(4,1,0,4,3,"#4A4A4A"),...st(4,1,1,3,3,"#4A4A4A"),...st(7,1,1,3,3,"#4A4A4A"),...L(4,4,0,4,4,"#3A3A3A"),{type:"fence",position:{x:4,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:5,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:6,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:7,y:1,z:3},color:"#2F2F2F"},{type:"fence",position:{x:4,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:5,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:6,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:7,y:2,z:3},color:"#2F2F2F"},{type:"fence",position:{x:4,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:5,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:6,y:3,z:3},color:"#2F2F2F"},{type:"fence",position:{x:7,y:3,z:3},color:"#2F2F2F"},{type:"barrel",position:{x:4,y:1,z:1},color:"#3D2914"},{type:"chain",position:{x:6,y:2,z:0},color:"#4A4A4A"},...L(8,0,0,4,4,"#2F2F2F"),...at(8,1,0,4,3,"#4A4A4A"),...st(8,1,1,3,3,"#4A4A4A"),...st(11,1,1,3,3,"#4A4A4A"),...L(8,4,0,4,4,"#3A3A3A"),{type:"arch",position:{x:9,y:1,z:3},color:"#4A4A4A"},{type:"arch",position:{x:10,y:1,z:3},color:"#4A4A4A"},{type:"cross",position:{x:9,y:1,z:0},color:"#3D2914"},{type:"chain",position:{x:9,y:2,z:0},color:"#4A4A4A"},{type:"chain",position:{x:9,y:3,z:0},color:"#4A4A4A"},{type:"barrel",position:{x:11,y:1,z:1},color:"#2F2F2F"},{type:"cube",position:{x:11,y:2,z:1},color:"#FF4500",emissive:{enabled:!0,color:"#FF2200",intensity:1.5,radius:3}},{type:"shelf",position:{x:8,y:2,z:1},color:"#3D2914"},{type:"torch",position:{x:10,y:3,z:0},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},...L(0,0,7,5,5,"#4A4A3A"),...at(0,1,11,5,3,"#5A5A4A"),...st(0,1,7,4,3,"#5A5A4A"),...st(4,1,8,3,3,"#5A5A4A"),...L(0,4,7,5,5,"#3A3A3A"),{type:"doorFrame",position:{x:1,y:1,z:7},color:"#3D2914"},{type:"doorFrame",position:{x:1,y:2,z:7},color:"#3D2914"},{type:"table",position:{x:1,y:1,z:9},color:"#5C4033"},{type:"stool",position:{x:0,y:1,z:9},color:"#5C4033"},{type:"stool",position:{x:2,y:1,z:9},color:"#5C4033"},{type:"shelf",position:{x:0,y:2,z:11},color:"#3D2914"},{type:"shelf",position:{x:1,y:2,z:11},color:"#3D2914"},{type:"shield",position:{x:3,y:2,z:11},color:"#8B0000"},{type:"torch",position:{x:2,y:3,z:11},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},{type:"barrel",position:{x:4,y:1,z:10},color:"#5C4033"},{type:"chain",position:{x:4,y:2,z:8},color:"#B8860B"},...L(8,0,7,4,5,"#3A3A3A"),...at(8,1,11,4,3,"#4A4A4A"),...st(8,1,7,4,3,"#4A4A4A"),...st(11,1,7,4,3,"#4A4A4A"),...L(8,4,7,4,5,"#3A3A3A"),{type:"portcullis",position:{x:9,y:1,z:7},color:"#2F2F2F"},{type:"portcullis",position:{x:10,y:1,z:7},color:"#2F2F2F"},{type:"portcullis",position:{x:9,y:2,z:7},color:"#2F2F2F"},{type:"portcullis",position:{x:10,y:2,z:7},color:"#2F2F2F"},{type:"crate",position:{x:9,y:1,z:10},color:"#8B4513"},{type:"crate",position:{x:10,y:1,z:10},color:"#8B4513"},{type:"slab",position:{x:9,y:1,z:9},color:"#FFD700"},{type:"slab",position:{x:10,y:1,z:9},color:"#FFD700"},{type:"quarter",position:{x:9,y:2,z:9},color:"#FFD700"},{type:"sack",position:{x:8,y:1,z:9},color:"#8B7355"},{type:"sack",position:{x:11,y:1,z:9},color:"#8B7355"},{type:"torch",position:{x:9,y:3,z:11},color:"#5C4033",emissive:{enabled:!0,color:"#FF4500",intensity:1.2,radius:4}},{type:"arrowSlit",position:{x:4,y:2,z:6},color:"#4A4A4A"},{type:"arrowSlit",position:{x:8,y:2,z:6},color:"#4A4A4A"},{type:"grate",position:{x:3,y:0,z:5},color:"#2F2F2F"},{type:"grate",position:{x:7,y:0,z:5},color:"#2F2F2F"}]},tavern:{name:"Tavern Interior",category:"medieval",description:"Cozy medieval tavern with bar, fireplace, sleeping quarters, and rustic charm",blocks:[...L(0,0,0,7,6,"#8B4513"),{type:"slab",position:{x:6,y:0,z:0},color:"#505050"},{type:"slab",position:{x:6,y:0,z:1},color:"#505050"},{type:"slab",position:{x:6,y:0,z:2},color:"#505050"},...at(0,1,-1,7,3,"#606060"),...st(-1,1,0,6,3,"#8B4513"),...st(7,1,0,6,3,"#8B4513"),{type:"slab",position:{x:0,y:1,z:0},color:"#5D4037"},{type:"slab",position:{x:1,y:1,z:0},color:"#5D4037"},{type:"slab",position:{x:2,y:1,z:0},color:"#5D4037"},{type:"slab",position:{x:3,y:1,z:0},color:"#5D4037"},{type:"ledge",position:{x:0,y:1,z:1},color:"#654321"},{type:"ledge",position:{x:1,y:1,z:1},color:"#654321"},{type:"ledge",position:{x:2,y:1,z:1},color:"#654321"},{type:"ledge",position:{x:3,y:1,z:1},color:"#654321"},{type:"shelf",position:{x:0,y:2,z:-1},color:"#5D4037"},{type:"shelf",position:{x:1,y:2,z:-1},color:"#5D4037"},{type:"shelf",position:{x:2,y:2,z:-1},color:"#5D4037"},{type:"shelf",position:{x:3,y:2,z:-1},color:"#5D4037"},{type:"barrel",position:{x:0,y:1,z:-1},color:"#5C4033"},{type:"barrel",position:{x:1,y:1,z:-1},color:"#4A3728"},{type:"barrel",position:{x:2,y:1,z:-1},color:"#5C4033"},{type:"barrel",position:{x:3,y:1,z:-1},color:"#4A3728"},{type:"barrel",position:{x:0,y:2,z:-1},color:"#4A3728"},{type:"barrel",position:{x:2,y:2,z:-1},color:"#5C4033"},{type:"barrel",position:{x:0,y:0,z:5},color:"#5C4033"},{type:"barrel",position:{x:0,y:1,z:5},color:"#4A3728"},{type:"cube",position:{x:6,y:1,z:0},color:"#505050"},{type:"cube",position:{x:6,y:1,z:2},color:"#505050"},{type:"cube",position:{x:6,y:2,z:0},color:"#404040"},{type:"cube",position:{x:6,y:2,z:2},color:"#404040"},{type:"arch",position:{x:6,y:2,z:1},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"pillar4",position:{x:6,y:1,z:1},color:"#FF4500",emissive:{enabled:!0,color:"#FF6600",intensity:4,radius:5}},{type:"chimney",position:{x:6,y:3,z:1},color:"#505050"},{type:"chimney",position:{x:6,y:4,z:1},color:"#404040"},{type:"slab",position:{x:6,y:3,z:0},color:"#5D4037"},{type:"slab",position:{x:6,y:3,z:2},color:"#5D4037"},{type:"table",position:{x:2,y:1,z:3},color:"#8B4513"},{type:"chair",position:{x:1,y:1,z:3},color:"#654321",rotation:{x:0,y:90,z:0}},{type:"chair",position:{x:3,y:1,z:3},color:"#654321",rotation:{x:0,y:270,z:0}},{type:"stool",position:{x:2,y:1,z:2},color:"#654321"},{type:"stool",position:{x:2,y:1,z:4},color:"#654321"},{type:"bench",position:{x:4,y:1,z:4},color:"#654321"},{type:"bench",position:{x:5,y:1,z:5},color:"#654321",rotation:{x:0,y:90,z:0}},{type:"table",position:{x:5,y:1,z:4},color:"#8B4513"},{type:"stool",position:{x:1,y:1,z:1},color:"#5D4037"},{type:"stool",position:{x:2,y:1,z:1},color:"#5D4037"},{type:"stool",position:{x:3,y:1,z:1},color:"#5D4037"},{type:"beamX",position:{x:0,y:3,z:2},color:"#5D4037"},{type:"beamX",position:{x:2,y:3,z:2},color:"#5D4037"},{type:"beamX",position:{x:4,y:3,z:2},color:"#5D4037"},{type:"beamX",position:{x:0,y:3,z:4},color:"#5D4037"},{type:"beamX",position:{x:2,y:3,z:4},color:"#5D4037"},{type:"beamX",position:{x:4,y:3,z:4},color:"#5D4037"},{type:"torch",position:{x:-1,y:2,z:1},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"torch",position:{x:-1,y:2,z:4},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"torch",position:{x:4,y:2,z:-1},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"chain",position:{x:3,y:3,z:3},color:"#2F2F2F"},{type:"sphere",position:{x:3,y:2,z:3},color:"#FFD700",emissive:{enabled:!0,color:"#FFAA00",intensity:2,radius:3}},{type:"shield",position:{x:2,y:3,z:-1},color:"#8B0000"},{type:"beamDiag",position:{x:5,y:3,z:-1},color:"#C0C0C0"},{type:"banner",position:{x:0,y:3,z:-1},color:"#006400"},{type:"crate",position:{x:0,y:0,z:4},color:"#8B4513"},{type:"doorFrame",position:{x:3,y:1,z:5},color:"#5D4037"}]},oakTree:{name:"Oak Tree",category:"nature",description:"Majestic oak tree with detailed bark, branches, and forest floor",blocks:[{type:"slab",position:{x:0,y:0,z:0},color:"#4A3728"},{type:"slab",position:{x:1,y:0,z:0},color:"#3D2914"},{type:"slab",position:{x:2,y:0,z:0},color:"#4A3728"},{type:"slab",position:{x:3,y:0,z:0},color:"#3D2914"},{type:"slab",position:{x:0,y:0,z:1},color:"#3D2914"},{type:"slab",position:{x:3,y:0,z:1},color:"#4A3728"},{type:"slab",position:{x:0,y:0,z:2},color:"#4A3728"},{type:"slab",position:{x:3,y:0,z:2},color:"#3D2914"},{type:"slab",position:{x:0,y:0,z:3},color:"#3D2914"},{type:"slab",position:{x:1,y:0,z:3},color:"#4A3728"},{type:"slab",position:{x:2,y:0,z:3},color:"#3D2914"},{type:"slab",position:{x:3,y:0,z:3},color:"#4A3728"},{type:"rock",position:{x:1,y:0,z:1},color:"#5D4037"},{type:"rock",position:{x:2,y:0,z:1},color:"#5D4037"},{type:"rock",position:{x:1,y:0,z:2},color:"#5D4037"},{type:"rock",position:{x:2,y:0,z:2},color:"#5D4037"},{type:"pillar",position:{x:1,y:1,z:1},color:"#5D4037"},{type:"pillar",position:{x:2,y:1,z:1},color:"#4A3728"},{type:"pillar",position:{x:1,y:1,z:2},color:"#4A3728"},{type:"pillar",position:{x:2,y:1,z:2},color:"#5D4037"},{type:"pillar",position:{x:1,y:2,z:1},color:"#5D4037"},{type:"pillar",position:{x:2,y:2,z:2},color:"#5D4037"},{type:"pillar",position:{x:1,y:3,z:2},color:"#5D4037"},{type:"pillar",position:{x:2,y:3,z:1},color:"#5D4037"},{type:"logX",position:{x:0,y:3,z:1},color:"#5D4037"},{type:"logX",position:{x:3,y:3,z:2},color:"#5D4037"},{type:"logZ",position:{x:1,y:4,z:0},color:"#5D4037"},{type:"logZ",position:{x:2,y:4,z:3},color:"#5D4037"},{type:"sphere",position:{x:0,y:4,z:1},color:"#228B22"},{type:"sphere",position:{x:3,y:4,z:1},color:"#2E8B2E"},{type:"sphere",position:{x:0,y:4,z:2},color:"#2E8B2E"},{type:"sphere",position:{x:3,y:4,z:2},color:"#228B22"},{type:"sphere",position:{x:1,y:4,z:0},color:"#228B22"},{type:"sphere",position:{x:2,y:4,z:0},color:"#2E8B2E"},{type:"sphere",position:{x:1,y:4,z:3},color:"#2E8B2E"},{type:"sphere",position:{x:2,y:4,z:3},color:"#228B22"},{type:"sphere",position:{x:1,y:5,z:1},color:"#32CD32"},{type:"sphere",position:{x:2,y:5,z:1},color:"#228B22"},{type:"sphere",position:{x:1,y:5,z:2},color:"#228B22"},{type:"sphere",position:{x:2,y:5,z:2},color:"#32CD32"},{type:"sphere",position:{x:0,y:5,z:1},color:"#2E8B2E"},{type:"sphere",position:{x:3,y:5,z:2},color:"#2E8B2E"},{type:"sphere",position:{x:1,y:6,z:1},color:"#32CD32"},{type:"sphere",position:{x:2,y:6,z:2},color:"#32CD32"},{type:"sphere",position:{x:1,y:6,z:2},color:"#228B22"},{type:"sphere",position:{x:2,y:6,z:1},color:"#228B22"},{type:"sphere",position:{x:1,y:7,z:1},color:"#90EE90"},{type:"sphere",position:{x:2,y:7,z:2},color:"#90EE90"},{type:"bush",position:{x:0,y:0,z:0},color:"#228B22"},{type:"bush",position:{x:3,y:0,z:3},color:"#2E8B2E"},{type:"bush",position:{x:3,y:0,z:0},color:"#006400"},{type:"grass",position:{x:0,y:0,z:3},color:"#7CFC00"},{type:"grass",position:{x:3,y:0,z:1},color:"#90EE90"},{type:"flower",position:{x:0,y:0,z:2},color:"#FFD700"},{type:"flower",position:{x:2,y:0,z:3},color:"#FF69B4"},{type:"logX",position:{x:-1,y:0,z:0},color:"#5D4037"},{type:"stump",position:{x:-1,y:0,z:3},color:"#5D4037"},{type:"rock",position:{x:4,y:0,z:1},color:"#696969"},{type:"rock",position:{x:-1,y:0,z:1},color:"#707070"}]},rockGarden:{name:"Rock Garden",category:"nature",description:"Zen garden with rocks and plants",blocks:[...L(0,0,0,4,4,"#C2B280"),{type:"rock",position:{x:0,y:0,z:0},color:"#696969"},{type:"rock",position:{x:3,y:0,z:1},color:"#808080",rotation:{x:0,y:45,z:0}},{type:"rock",position:{x:1,y:0,z:3},color:"#707070",rotation:{x:0,y:90,z:0}},{type:"rock",position:{x:2,y:0,z:2},color:"#606060"},{type:"bush",position:{x:0,y:0,z:2},color:"#228B22"},{type:"bush",position:{x:3,y:0,z:3},color:"#2E8B2E"},{type:"planter",position:{x:2,y:0,z:0},color:"#8B4513"}]},pond:{name:"Pond",category:"nature",description:"Small pond with rocks and plants",blocks:[{type:"slab",position:{x:1,y:0,z:1},color:"#1E90FF"},{type:"slab",position:{x:2,y:0,z:1},color:"#1E90FF"},{type:"slab",position:{x:1,y:0,z:2},color:"#1E90FF"},{type:"slab",position:{x:2,y:0,z:2},color:"#1E90FF"},{type:"rock",position:{x:0,y:0,z:1},color:"#696969"},{type:"rock",position:{x:0,y:0,z:2},color:"#606060"},{type:"rock",position:{x:3,y:0,z:1},color:"#707070"},{type:"rock",position:{x:3,y:0,z:2},color:"#808080"},{type:"rock",position:{x:1,y:0,z:0},color:"#656565"},{type:"rock",position:{x:2,y:0,z:0},color:"#757575"},{type:"rock",position:{x:1,y:0,z:3},color:"#858585"},{type:"rock",position:{x:2,y:0,z:3},color:"#959595"},{type:"bush",position:{x:0,y:0,z:0},color:"#228B22"},{type:"bush",position:{x:3,y:0,z:3},color:"#2E8B2E"},{type:"logX",position:{x:1,y:1,z:1},color:"#5D4037"},{type:"logX",position:{x:2,y:1,z:1},color:"#5D4037"}]},campsite:{name:"Campsite",category:"nature",description:"Cozy wilderness campsite with tent, campfire, and outdoor gear",blocks:[...L(0,0,0,6,6,"#654321"),{type:"slab",position:{x:2,y:0,z:2},color:"#4A3728"},{type:"slab",position:{x:3,y:0,z:2},color:"#4A3728"},{type:"slab",position:{x:2,y:0,z:3},color:"#4A3728"},{type:"slab",position:{x:3,y:0,z:3},color:"#4A3728"},{type:"slab",position:{x:0,y:0,z:4},color:"#2F4F4F"},{type:"slab",position:{x:1,y:0,z:4},color:"#2F4F4F"},{type:"slab",position:{x:0,y:0,z:5},color:"#2F4F4F"},{type:"slab",position:{x:1,y:0,z:5},color:"#2F4F4F"},{type:"wedge",position:{x:0,y:1,z:4},color:"#3CB371"},{type:"wedge",position:{x:1,y:1,z:4},color:"#3CB371"},{type:"wedge",position:{x:0,y:1,z:5},color:"#2E8B57",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:1,y:1,z:5},color:"#2E8B57",rotation:{x:0,y:180,z:0}},{type:"pillar4",position:{x:0,y:1,z:4},color:"#8B4513"},{type:"pillar4",position:{x:1,y:1,z:5},color:"#8B4513"},{type:"rock",position:{x:2,y:0,z:2},color:"#404040"},{type:"rock",position:{x:3,y:0,z:2},color:"#505050"},{type:"rock",position:{x:2,y:0,z:3},color:"#505050"},{type:"rock",position:{x:3,y:0,z:3},color:"#404040"},{type:"pillar4",position:{x:2,y:0,z:2},color:"#FF4500",emissive:{enabled:!0,color:"#FF6600",intensity:4,radius:6}},{type:"pillar4",position:{x:3,y:0,z:3},color:"#FF8C00",emissive:{enabled:!0,color:"#FF4500",intensity:3,radius:4}},{type:"sphere",position:{x:2,y:1,z:2},color:"#3A3A3A"},{type:"logX",position:{x:1,y:0,z:1},color:"#5D4037"},{type:"logZ",position:{x:4,y:0,z:2},color:"#5D4037"},{type:"logZ",position:{x:4,y:0,z:3},color:"#5D4037"},{type:"logX",position:{x:1,y:0,z:4},color:"#5D4037"},{type:"pillar4",position:{x:3,y:1,z:2},color:"#2F2F2F"},{type:"barrel",position:{x:3,y:0,z:2},color:"#1A1A1A"},{type:"crate",position:{x:5,y:0,z:0},color:"#8B4513"},{type:"crate",position:{x:5,y:0,z:1},color:"#A0522D"},{type:"crate",position:{x:5,y:1,z:0},color:"#CD853F"},{type:"barrel",position:{x:5,y:0,z:2},color:"#4169E1"},{type:"sphere",position:{x:5,y:1,z:1},color:"#FFD700",emissive:{enabled:!0,color:"#FFAA00",intensity:2,radius:3}},{type:"pillar4",position:{x:0,y:0,z:0},color:"#8B4513"},{type:"pillar4",position:{x:0,y:1,z:0},color:"#8B4513"},{type:"barrel",position:{x:1,y:0,z:0},color:"#696969"},{type:"boulder",position:{x:0,y:0,z:2},color:"#696969"},{type:"rock",position:{x:4,y:0,z:5},color:"#707070"},{type:"bush",position:{x:5,y:0,z:4},color:"#228B22"},{type:"bush",position:{x:5,y:0,z:5},color:"#2E8B2E"},{type:"pillar",position:{x:-1,y:0,z:3},color:"#5D4037"},{type:"pillar",position:{x:-1,y:1,z:3},color:"#5D4037"},{type:"sphere",position:{x:-1,y:2,z:3},color:"#228B22"},{type:"grass",position:{x:0,y:0,z:1},color:"#7CFC00"},{type:"grass",position:{x:4,y:0,z:0},color:"#90EE90"},{type:"flower",position:{x:3,y:0,z:5},color:"#FFFF00"}]},factory:{name:"Factory Building",category:"industrial",description:"Detailed industrial facility with machinery, pipes, and electrical systems",blocks:[...L(0,0,0,8,6,"#505050"),{type:"grate",position:{x:3,y:0,z:3},color:"#404040"},{type:"grate",position:{x:4,y:0,z:3},color:"#404040"},...at(0,1,0,8,3,"#606060"),...at(0,1,5,8,3,"#606060"),...st(0,1,1,4,3,"#606060"),...st(7,1,1,4,3,"#606060"),...L(0,4,0,8,6,"#505050"),{type:"iBeam",position:{x:2,y:1,z:2},color:"#8B0000"},{type:"iBeam",position:{x:2,y:2,z:2},color:"#8B0000"},{type:"iBeam",position:{x:2,y:3,z:2},color:"#8B0000"},{type:"iBeam",position:{x:5,y:1,z:2},color:"#8B0000"},{type:"iBeam",position:{x:5,y:2,z:2},color:"#8B0000"},{type:"iBeam",position:{x:5,y:3,z:2},color:"#8B0000"},{type:"iBeam",position:{x:2,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:3,z:4},color:"#8B0000"},{type:"doorFrame",position:{x:3,y:1,z:0},color:"#FFD700"},{type:"doorFrame",position:{x:4,y:1,z:0},color:"#FFD700"},{type:"doorFrame",position:{x:3,y:2,z:0},color:"#FFD700"},{type:"doorFrame",position:{x:4,y:2,z:0},color:"#FFD700"},{type:"windowFrame",position:{x:1,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:2,z:5},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:2,z:5},color:"#4682B4"},{type:"tank",position:{x:1,y:4,z:1},color:"#C0C0C0"},{type:"tank",position:{x:1,y:5,z:1},color:"#B0B0B0"},{type:"tank",position:{x:6,y:4,z:1},color:"#808080"},{type:"tank",position:{x:6,y:5,z:1},color:"#707070"},{type:"vent",position:{x:3,y:4,z:3},color:"#4A4A4A"},{type:"vent",position:{x:4,y:4,z:3},color:"#4A4A4A"},{type:"acUnit",position:{x:1,y:4,z:4},color:"#909090"},{type:"acUnit",position:{x:6,y:4,z:4},color:"#909090"},{type:"chimney",position:{x:0,y:4,z:2},color:"#8B4513"},{type:"chimney",position:{x:0,y:5,z:2},color:"#704214"},{type:"chimney",position:{x:0,y:6,z:2},color:"#5D3A1A"},{type:"pipeX",position:{x:2,y:5,z:1},color:"#696969"},{type:"pipeX",position:{x:3,y:5,z:1},color:"#696969"},{type:"pipeX",position:{x:4,y:5,z:1},color:"#696969"},{type:"pipeX",position:{x:5,y:5,z:1},color:"#696969"},{type:"valve",position:{x:3,y:5,z:1},color:"#B22222"},{type:"pipeY",position:{x:4,y:4,z:1},color:"#696969"},{type:"fuseBox",position:{x:0,y:1,z:3},color:"#404040"},{type:"powerBox",position:{x:7,y:1,z:3},color:"#2F4F4F"},{type:"cableY",position:{x:0,y:2,z:3},color:"#696969"},{type:"cableY",position:{x:0,y:3,z:3},color:"#696969"},{type:"beamX",position:{x:1,y:3,z:3},color:"#404040"},{type:"beamX",position:{x:2,y:3,z:3},color:"#404040"},{type:"beamX",position:{x:3,y:3,z:3},color:"#404040"},{type:"beamX",position:{x:4,y:3,z:3},color:"#404040"},{type:"cableX",position:{x:1,y:3,z:3},color:"#1A1A1A"},{type:"cableX",position:{x:2,y:3,z:3},color:"#1A1A1A"},{type:"lightFixture",position:{x:3,y:3,z:3},color:"#FFFF00"},{type:"lightFixture",position:{x:4,y:3,z:3},color:"#FFFF00"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:4,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:4,y:1,z:2},color:"#4A4A4A"},{type:"catwalk",position:{x:3,y:2,z:2},color:"#3A3A3A"},{type:"catwalk",position:{x:4,y:2,z:2},color:"#3A3A3A"},{type:"railing",position:{x:3,y:3,z:2},color:"#505050"},{type:"railing",position:{x:4,y:3,z:2},color:"#505050"},{type:"ladder",position:{x:2,y:1,z:3},color:"#FFD700"},{type:"ladder",position:{x:2,y:2,z:3},color:"#FFD700"},{type:"crate",position:{x:6,y:0,z:2},color:"#8B4513"},{type:"crate",position:{x:6,y:0,z:3},color:"#A0522D"},{type:"crate",position:{x:6,y:1,z:2},color:"#CD853F"},{type:"barrel",position:{x:1,y:0,z:3},color:"#006400"},{type:"barrel",position:{x:1,y:0,z:4},color:"#2F4F4F"},{type:"barrier",position:{x:3,y:0,z:-1},color:"#FFD700"},{type:"barrier",position:{x:4,y:0,z:-1},color:"#FFD700"},{type:"trafficCone",position:{x:2,y:0,z:-1},color:"#FF4500"}]},pipeNetwork:{name:"Pipe Network",category:"industrial",description:"Industrial pipe and cable network showcase with all junction types",blocks:[...L(0,0,0,8,8,"#505050"),{type:"pipeX",position:{x:0,y:2,z:2},color:"#4682B4"},{type:"pipeX",position:{x:1,y:2,z:2},color:"#4682B4"},{type:"pipeX",position:{x:2,y:2,z:2},color:"#4682B4"},{type:"valve",position:{x:1,y:2,z:2},color:"#B22222"},{type:"pipeElbowXZ4",position:{x:3,y:2,z:2},color:"#4682B4"},{type:"pipeZ",position:{x:3,y:2,z:3},color:"#4682B4"},{type:"pipeZ",position:{x:3,y:2,z:4},color:"#4682B4"},{type:"pipeT",position:{x:3,y:2,z:5},color:"#4682B4"},{type:"pipeX",position:{x:2,y:2,z:5},color:"#4682B4"},{type:"pipeX",position:{x:4,y:2,z:5},color:"#4682B4"},{type:"valve",position:{x:4,y:2,z:5},color:"#B22222"},{type:"pipeY",position:{x:6,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:6,y:1,z:2},color:"#708090"},{type:"pipeY",position:{x:6,y:2,z:2},color:"#708090"},{type:"pipeElbowXY",position:{x:6,y:3,z:2},color:"#708090"},{type:"pipeX",position:{x:7,y:3,z:2},color:"#708090"},{type:"pipeTY",position:{x:5,y:2,z:2},color:"#708090"},{type:"pipeX",position:{x:4,y:2,z:2},color:"#708090"},{type:"pipeY",position:{x:5,y:3,z:2},color:"#708090"},{type:"vent",position:{x:5,y:4,z:2},color:"#606060"},{type:"pipeCross",position:{x:5,y:2,z:5},color:"#FF8C00"},{type:"pipeX",position:{x:6,y:2,z:5},color:"#FF8C00"},{type:"pipeZ",position:{x:5,y:2,z:6},color:"#FF8C00"},{type:"valve",position:{x:5,y:2,z:6},color:"#B22222"},{type:"cableX",position:{x:0,y:1,z:1},color:"#1A1A1A"},{type:"cableX",position:{x:1,y:1,z:1},color:"#1A1A1A"},{type:"cableX",position:{x:2,y:1,z:1},color:"#1A1A1A"},{type:"cableElbow",position:{x:3,y:1,z:1},color:"#1A1A1A"},{type:"cableZ",position:{x:3,y:1,z:2},color:"#1A1A1A"},{type:"cableZ",position:{x:3,y:1,z:3},color:"#1A1A1A"},{type:"cableT",position:{x:3,y:1,z:4},color:"#1A1A1A"},{type:"cableZ",position:{x:3,y:1,z:5},color:"#1A1A1A"},{type:"cableY",position:{x:1,y:0,z:6},color:"#8B0000"},{type:"cableY",position:{x:1,y:1,z:6},color:"#8B0000"},{type:"cableY",position:{x:1,y:2,z:6},color:"#8B0000"},{type:"cableElbowY",position:{x:1,y:3,z:6},color:"#8B0000"},{type:"cableX",position:{x:2,y:3,z:6},color:"#8B0000"},{type:"cableX",position:{x:3,y:3,z:6},color:"#8B0000"},{type:"conduitX",position:{x:5,y:0,z:0},color:"#696969"},{type:"conduitX",position:{x:6,y:0,z:0},color:"#696969"},{type:"conduitElbow",position:{x:7,y:0,z:0},color:"#696969"},{type:"conduitZ",position:{x:7,y:0,z:1},color:"#696969"},{type:"conduitT",position:{x:7,y:0,z:2},color:"#696969"},{type:"conduitZ",position:{x:7,y:0,z:3},color:"#696969"},{type:"pillar2",position:{x:0,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:0,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:0,z:5},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:5},color:"#4A4A4A"},{type:"pillar2",position:{x:5,y:0,z:5},color:"#4A4A4A"},{type:"pillar2",position:{x:5,y:1,z:5},color:"#4A4A4A"},{type:"fuseBox",position:{x:0,y:0,z:1},color:"#404040"},{type:"switchBox",position:{x:1,y:0,z:0},color:"#505050"},{type:"powerBox",position:{x:0,y:0,z:6},color:"#2F4F4F"},{type:"tank",position:{x:0,y:0,z:4},color:"#4682B4"},{type:"tank",position:{x:0,y:1,z:4},color:"#4682B4"},{type:"tank",position:{x:7,y:0,z:5},color:"#FF8C00"},{type:"tank",position:{x:7,y:1,z:5},color:"#FF8C00"},{type:"sign",position:{x:0,y:2,z:4},color:"#FFFF00"},{type:"sign",position:{x:7,y:2,z:5},color:"#FF4500"}]},storageYard:{name:"Storage Yard",category:"industrial",description:"Outdoor storage with crates and barrels",blocks:[...L(0,0,0,5,4,"#808080"),{type:"crate",position:{x:0,y:0,z:0},color:"#8B4513"},{type:"crate",position:{x:1,y:0,z:0},color:"#A0522D"},{type:"crate",position:{x:0,y:0,z:1},color:"#8B4513"},{type:"crate",position:{x:1,y:0,z:1},color:"#A0522D"},{type:"crate",position:{x:0,y:1,z:0},color:"#CD853F"},{type:"crate",position:{x:1,y:1,z:0},color:"#8B4513"},{type:"barrel",position:{x:3,y:0,z:0},color:"#2F4F4F"},{type:"barrel",position:{x:4,y:0,z:0},color:"#2F4F4F"},{type:"barrel",position:{x:3,y:0,z:1},color:"#006400"},{type:"barrel",position:{x:4,y:0,z:1},color:"#006400"},{type:"barrel",position:{x:3,y:1,z:0},color:"#2F4F4F"},{type:"barrier",position:{x:0,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:1,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:2,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:3,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:4,y:0,z:3},color:"#FFD700"}]},refinery:{name:"Refinery",category:"industrial",description:"Oil refinery with tanks and pipes",blocks:[...L(0,0,0,5,5,"#404040"),{type:"tank",position:{x:0,y:0,z:0},color:"#C0C0C0"},{type:"tank",position:{x:0,y:1,z:0},color:"#C0C0C0"},{type:"tank",position:{x:0,y:2,z:0},color:"#C0C0C0"},{type:"tank",position:{x:4,y:0,z:0},color:"#808080"},{type:"tank",position:{x:4,y:1,z:0},color:"#808080"},{type:"tank",position:{x:4,y:2,z:0},color:"#808080"},{type:"pipeX",position:{x:1,y:2,z:0},color:"#696969"},{type:"pipeX",position:{x:2,y:2,z:0},color:"#696969"},{type:"pipeX",position:{x:3,y:2,z:0},color:"#696969"},{type:"valve",position:{x:2,y:2,z:0},color:"#B22222"},{type:"cube",position:{x:2,y:0,z:2},color:"#505050"},{type:"cube",position:{x:2,y:1,z:2},color:"#505050"},{type:"vent",position:{x:2,y:2,z:2},color:"#404040"},{type:"pillar2",position:{x:1,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:1,y:1,z:2},color:"#4A4A4A"},{type:"catwalk",position:{x:1,y:2,z:2},color:"#3A3A3A"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#4A4A4A"},{type:"catwalk",position:{x:3,y:2,z:2},color:"#3A3A3A"},{type:"ladder",position:{x:0,y:0,z:1},color:"#FFD700"},{type:"ladder",position:{x:0,y:1,z:1},color:"#FFD700"},{type:"ladder",position:{x:0,y:2,z:1},color:"#FFD700"}]},industrialComplex:{name:"Industrial Complex",category:"industrial",description:"Large industrial facility with buildings, tanks, and pipe network",blocks:[...L(0,0,0,12,10,"#505050"),...at(0,1,0,5,3,"#606060"),...at(0,1,4,5,3,"#606060"),...st(0,1,1,3,3,"#606060"),...st(4,1,1,3,3,"#606060"),...L(0,4,0,5,5,"#404040"),{type:"doorFrame",position:{x:1,y:1,z:4},color:"#333333"},{type:"doorFrame",position:{x:2,y:1,z:4},color:"#333333"},{type:"doorFrame",position:{x:1,y:2,z:4},color:"#333333"},{type:"doorFrame",position:{x:2,y:2,z:4},color:"#333333"},{type:"windowFrame",position:{x:1,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:2,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:2,z:0},color:"#4682B4"},{type:"iBeam",position:{x:1,y:1,z:2},color:"#8B0000"},{type:"iBeam",position:{x:1,y:2,z:2},color:"#8B0000"},{type:"iBeam",position:{x:1,y:3,z:2},color:"#8B0000"},{type:"iBeam",position:{x:3,y:1,z:2},color:"#8B0000"},{type:"iBeam",position:{x:3,y:2,z:2},color:"#8B0000"},{type:"iBeam",position:{x:3,y:3,z:2},color:"#8B0000"},{type:"vent",position:{x:1,y:4,z:1},color:"#3A3A3A"},{type:"vent",position:{x:3,y:4,z:1},color:"#3A3A3A"},{type:"vent",position:{x:2,y:4,z:3},color:"#3A3A3A"},{type:"chimney",position:{x:0,y:4,z:0},color:"#8B4513"},{type:"chimney",position:{x:0,y:5,z:0},color:"#8B4513"},{type:"chimney",position:{x:0,y:6,z:0},color:"#8B4513"},{type:"chimney",position:{x:0,y:7,z:0},color:"#704214"},{type:"tank",position:{x:8,y:0,z:1},color:"#C0C0C0"},{type:"tank",position:{x:8,y:1,z:1},color:"#C0C0C0"},{type:"tank",position:{x:8,y:2,z:1},color:"#C0C0C0"},{type:"tank",position:{x:8,y:3,z:1},color:"#B0B0B0"},{type:"tank",position:{x:10,y:0,z:1},color:"#A0A0A0"},{type:"tank",position:{x:10,y:1,z:1},color:"#A0A0A0"},{type:"tank",position:{x:10,y:2,z:1},color:"#A0A0A0"},{type:"tank",position:{x:10,y:3,z:1},color:"#909090"},{type:"tank",position:{x:8,y:0,z:4},color:"#708090"},{type:"tank",position:{x:8,y:1,z:4},color:"#708090"},{type:"tank",position:{x:10,y:0,z:4},color:"#708090"},{type:"tank",position:{x:10,y:1,z:4},color:"#708090"},{type:"ladder",position:{x:8,y:0,z:0},color:"#FFD700"},{type:"ladder",position:{x:8,y:1,z:0},color:"#FFD700"},{type:"ladder",position:{x:8,y:2,z:0},color:"#FFD700"},{type:"ladder",position:{x:8,y:3,z:0},color:"#FFD700"},{type:"pipeX",position:{x:5,y:2,z:2},color:"#696969"},{type:"pipeX",position:{x:6,y:2,z:2},color:"#696969"},{type:"pipeX",position:{x:7,y:2,z:2},color:"#696969"},{type:"pipeElbowXZ4",position:{x:8,y:2,z:2},color:"#696969"},{type:"pipeZ",position:{x:8,y:2,z:1},color:"#696969"},{type:"pipeT",position:{x:7,y:2,z:2},color:"#696969"},{type:"pipeZ",position:{x:7,y:2,z:3},color:"#696969"},{type:"pipeZ",position:{x:7,y:2,z:4},color:"#696969"},{type:"pipeCross",position:{x:9,y:1,z:4},color:"#696969"},{type:"pipeX",position:{x:8,y:1,z:4},color:"#696969"},{type:"pipeX",position:{x:10,y:1,z:4},color:"#696969"},{type:"pipeY",position:{x:9,y:0,z:4},color:"#696969"},{type:"pipeTY",position:{x:9,y:2,z:4},color:"#696969"},{type:"valve",position:{x:6,y:2,z:2},color:"#B22222"},{type:"valve",position:{x:9,y:1,z:4},color:"#B22222"},{type:"pillar2",position:{x:5,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:5,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:1,z:2},color:"#4A4A4A"},{type:"catwalk",position:{x:9,y:3,z:1},color:"#3A3A3A"},{type:"railing",position:{x:9,y:4,z:1},color:"#505050"},{type:"pillar",position:{x:9,y:0,z:1},color:"#4A4A4A"},{type:"pillar",position:{x:9,y:1,z:1},color:"#4A4A4A"},{type:"pillar",position:{x:9,y:2,z:1},color:"#4A4A4A"},{type:"crate",position:{x:0,y:0,z:6},color:"#8B4513"},{type:"crate",position:{x:1,y:0,z:6},color:"#A0522D"},{type:"crate",position:{x:0,y:0,z:7},color:"#8B4513"},{type:"crate",position:{x:1,y:0,z:7},color:"#CD853F"},{type:"crate",position:{x:0,y:1,z:6},color:"#A0522D"},{type:"barrel",position:{x:3,y:0,z:6},color:"#2F4F4F"},{type:"barrel",position:{x:4,y:0,z:6},color:"#006400"},{type:"barrel",position:{x:3,y:0,z:7},color:"#8B0000"},{type:"barrel",position:{x:4,y:0,z:7},color:"#2F4F4F"},{type:"cube",position:{x:6,y:0,z:7},color:"#D3D3D3"},{type:"cube",position:{x:7,y:0,z:7},color:"#D3D3D3"},{type:"cube",position:{x:6,y:0,z:8},color:"#D3D3D3"},{type:"cube",position:{x:7,y:0,z:8},color:"#D3D3D3"},{type:"cube",position:{x:6,y:1,z:7},color:"#C0C0C0"},{type:"cube",position:{x:7,y:1,z:7},color:"#C0C0C0"},{type:"cube",position:{x:6,y:1,z:8},color:"#C0C0C0"},{type:"cube",position:{x:7,y:1,z:8},color:"#C0C0C0"},{type:"slab",position:{x:6,y:2,z:7},color:"#808080"},{type:"slab",position:{x:7,y:2,z:7},color:"#808080"},{type:"slab",position:{x:6,y:2,z:8},color:"#808080"},{type:"slab",position:{x:7,y:2,z:8},color:"#808080"},{type:"acUnit",position:{x:7,y:2,z:8},color:"#909090"},{type:"antenna",position:{x:6,y:2,z:7},color:"#606060"},{type:"doorFrame",position:{x:6,y:0,z:6},color:"#333333"},{type:"slab",position:{x:10,y:0,z:7},color:"#707070"},{type:"slab",position:{x:11,y:0,z:7},color:"#707070"},{type:"slab",position:{x:10,y:0,z:8},color:"#707070"},{type:"slab",position:{x:11,y:0,z:8},color:"#707070"},{type:"barrier",position:{x:10,y:0,z:6},color:"#FFD700"},{type:"barrier",position:{x:11,y:0,z:6},color:"#FFD700"},{type:"fence",position:{x:0,y:0,z:9},color:"#696969"},{type:"fence",position:{x:1,y:0,z:9},color:"#696969"},{type:"fence",position:{x:2,y:0,z:9},color:"#696969"},{type:"fence",position:{x:3,y:0,z:9},color:"#696969"},{type:"fence",position:{x:4,y:0,z:9},color:"#696969"},{type:"fence",position:{x:5,y:0,z:9},color:"#696969"},{type:"fence",position:{x:8,y:0,z:9},color:"#696969"},{type:"fence",position:{x:9,y:0,z:9},color:"#696969"},{type:"fence",position:{x:10,y:0,z:9},color:"#696969"},{type:"fence",position:{x:11,y:0,z:9},color:"#696969"}]},rooftopTerrace:{name:"Rooftop Terrace",category:"modern",description:"Modern rooftop with furniture and plants",blocks:[...L(0,0,0,5,4,"#D2B48C"),{type:"planter",position:{x:0,y:0,z:0},color:"#696969"},{type:"bush",position:{x:0,y:1,z:0},color:"#228B22"},{type:"planter",position:{x:4,y:0,z:0},color:"#696969"},{type:"bush",position:{x:4,y:1,z:0},color:"#2E8B2E"},{type:"planter",position:{x:0,y:0,z:3},color:"#696969"},{type:"bush",position:{x:0,y:1,z:3},color:"#32CD32"},{type:"planter",position:{x:4,y:0,z:3},color:"#696969"},{type:"bush",position:{x:4,y:1,z:3},color:"#228B22"},{type:"bench",position:{x:1,y:0,z:1},color:"#8B4513"},{type:"table",position:{x:2,y:0,z:1},color:"#A0522D"},{type:"chair",position:{x:3,y:0,z:1},color:"#8B4513"},{type:"acUnit",position:{x:2,y:0,z:3},color:"#C0C0C0"},{type:"solarPanel",position:{x:1,y:0,z:3},color:"#1a1a2e"},{type:"solarPanel",position:{x:3,y:0,z:3},color:"#1a1a2e"}]},parkingLot:{name:"Parking Lot",category:"modern",description:"Parking area with barriers and lights",blocks:[...L(0,0,0,6,4,"#2F2F2F"),{type:"slab",position:{x:1,y:0,z:0},color:"#FFFFFF"},{type:"slab",position:{x:3,y:0,z:0},color:"#FFFFFF"},{type:"slab",position:{x:5,y:0,z:0},color:"#FFFFFF"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:1},color:"#FF0000"},{type:"barrier",position:{x:0,y:0,z:2},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:3},color:"#FF0000"},{type:"pillar2",position:{x:2,y:0,z:3},color:"#808080"},{type:"pillar2",position:{x:2,y:1,z:3},color:"#808080"},{type:"pillar2",position:{x:2,y:2,z:3},color:"#808080"},{type:"solarPanel",position:{x:2,y:3,z:3},color:"#404040"},{type:"quarter",position:{x:2,y:2,z:3},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFAA",intensity:2,radius:6}},{type:"pillar2",position:{x:5,y:0,z:3},color:"#808080"},{type:"pillar2",position:{x:5,y:1,z:3},color:"#808080"},{type:"pillar2",position:{x:5,y:2,z:3},color:"#808080"},{type:"quarter",position:{x:5,y:2,z:3},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFAA",intensity:2,radius:6}}]},busStop:{name:"Bus Stop",category:"modern",description:"Modern bus shelter with bench",blocks:[{type:"slab",position:{x:0,y:0,z:0},color:"#808080"},{type:"slab",position:{x:1,y:0,z:0},color:"#808080"},{type:"slab",position:{x:2,y:0,z:0},color:"#808080"},{type:"slab",position:{x:0,y:0,z:1},color:"#808080"},{type:"slab",position:{x:1,y:0,z:1},color:"#808080"},{type:"slab",position:{x:2,y:0,z:1},color:"#808080"},{type:"pillar2",position:{x:0,y:0,z:0},color:"#4169E1"},{type:"pillar2",position:{x:0,y:1,z:0},color:"#4169E1"},{type:"pillar2",position:{x:2,y:0,z:0},color:"#4169E1"},{type:"pillar2",position:{x:2,y:1,z:0},color:"#4169E1"},{type:"slab",position:{x:0,y:2,z:0},color:"#4169E1"},{type:"slab",position:{x:1,y:2,z:0},color:"#4169E1"},{type:"slab",position:{x:2,y:2,z:0},color:"#4169E1"},{type:"slab",position:{x:0,y:2,z:1},color:"#4169E1"},{type:"slab",position:{x:1,y:2,z:1},color:"#4169E1"},{type:"slab",position:{x:2,y:2,z:1},color:"#4169E1"},{type:"bench",position:{x:1,y:0,z:0},color:"#8B4513"},{type:"quarter",position:{x:1,y:2,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:4}}]},solarFarm:{name:"Solar Farm",category:"modern",description:"Array of solar panels",blocks:[...L(0,0,0,5,4,"#90EE90"),{type:"solarPanel",position:{x:0,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:1,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:2,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:3,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:4,y:0,z:0},color:"#1a1a2e"},{type:"solarPanel",position:{x:0,y:0,z:2},color:"#1a1a2e"},{type:"solarPanel",position:{x:1,y:0,z:2},color:"#1a1a2e"},{type:"solarPanel",position:{x:2,y:0,z:2},color:"#1a1a2e"},{type:"solarPanel",position:{x:3,y:0,z:2},color:"#1a1a2e"},{type:"solarPanel",position:{x:4,y:0,z:2},color:"#1a1a2e"},{type:"cube",position:{x:2,y:0,z:3},color:"#808080"},{type:"vent",position:{x:2,y:1,z:3},color:"#696969"},{type:"fence",position:{x:0,y:0,z:3},color:"#C0C0C0"},{type:"fence",position:{x:1,y:0,z:3},color:"#C0C0C0"},{type:"fence",position:{x:3,y:0,z:3},color:"#C0C0C0"},{type:"fence",position:{x:4,y:0,z:3},color:"#C0C0C0"}]},diningRoom:{name:"Dining Room",category:"furniture",description:"Dining set with table and chairs",blocks:[...L(0,0,0,4,4,"#DEB887"),{type:"table",position:{x:1,y:0,z:1},color:"#8B4513"},{type:"table",position:{x:2,y:0,z:1},color:"#8B4513"},{type:"table",position:{x:1,y:0,z:2},color:"#8B4513"},{type:"table",position:{x:2,y:0,z:2},color:"#8B4513"},{type:"chair",position:{x:0,y:0,z:1},color:"#654321",rotation:{x:0,y:90,z:0}},{type:"chair",position:{x:0,y:0,z:2},color:"#654321",rotation:{x:0,y:90,z:0}},{type:"chair",position:{x:3,y:0,z:1},color:"#654321",rotation:{x:0,y:270,z:0}},{type:"chair",position:{x:3,y:0,z:2},color:"#654321",rotation:{x:0,y:270,z:0}},{type:"chair",position:{x:1,y:0,z:0},color:"#654321",rotation:{x:0,y:180,z:0}},{type:"chair",position:{x:2,y:0,z:0},color:"#654321",rotation:{x:0,y:180,z:0}},{type:"chair",position:{x:1,y:0,z:3},color:"#654321"},{type:"chair",position:{x:2,y:0,z:3},color:"#654321"}]},livingRoom:{name:"Living Room",category:"furniture",description:"Cozy living room with sofa, fireplace, entertainment center, and decorations",blocks:[...L(0,0,0,8,7,"#DEB887"),{type:"slab",position:{x:2,y:0,z:2},color:"#8B0000"},{type:"slab",position:{x:3,y:0,z:2},color:"#8B0000"},{type:"slab",position:{x:4,y:0,z:2},color:"#8B0000"},{type:"slab",position:{x:2,y:0,z:3},color:"#A52A2A"},{type:"slab",position:{x:3,y:0,z:3},color:"#A52A2A"},{type:"slab",position:{x:4,y:0,z:3},color:"#A52A2A"},{type:"slab",position:{x:2,y:0,z:4},color:"#8B0000"},{type:"slab",position:{x:3,y:0,z:4},color:"#8B0000"},{type:"slab",position:{x:4,y:0,z:4},color:"#8B0000"},...st(0,1,0,7,3,"#F5F5DC"),...at(0,1,0,8,3,"#F5F5DC"),{type:"cube",position:{x:3,y:1,z:0},color:"#696969"},{type:"cube",position:{x:4,y:1,z:0},color:"#696969"},{type:"cube",position:{x:2,y:1,z:0},color:"#808080"},{type:"cube",position:{x:5,y:1,z:0},color:"#808080"},{type:"cube",position:{x:2,y:2,z:0},color:"#808080"},{type:"cube",position:{x:5,y:2,z:0},color:"#808080"},{type:"slab",position:{x:2,y:3,z:0},color:"#654321"},{type:"slab",position:{x:3,y:3,z:0},color:"#654321"},{type:"slab",position:{x:4,y:3,z:0},color:"#654321"},{type:"slab",position:{x:5,y:3,z:0},color:"#654321"},{type:"doorFrame",position:{x:3,y:1,z:0},color:"#1A1A1A"},{type:"doorFrame",position:{x:4,y:1,z:0},color:"#1A1A1A"},{type:"cube",position:{x:3,y:1,z:0},color:"#FF4500",emissive:{enabled:!0,color:"#FF6600",intensity:2,radius:4}},{type:"chimney",position:{x:3,y:3,z:0},color:"#696969"},{type:"chimney",position:{x:4,y:3,z:0},color:"#696969"},{type:"pillar2",position:{x:2,y:3,z:0},color:"#FFD700"},{type:"pillar2",position:{x:5,y:3,z:0},color:"#FFD700"},{type:"bench",position:{x:2,y:0,z:5},color:"#4169E1"},{type:"bench",position:{x:3,y:0,z:5},color:"#4169E1"},{type:"bench",position:{x:4,y:0,z:5},color:"#4169E1"},{type:"halfZ",position:{x:2,y:1,z:6},color:"#3A5FCD"},{type:"halfZ",position:{x:3,y:1,z:6},color:"#3A5FCD"},{type:"halfZ",position:{x:4,y:1,z:6},color:"#3A5FCD"},{type:"halfX",position:{x:1,y:0,z:5},color:"#3A5FCD"},{type:"halfX",position:{x:5,y:0,z:5},color:"#3A5FCD",rotation:{x:0,y:180,z:0}},{type:"slab",position:{x:2,y:0,z:5},color:"#FFD700"},{type:"slab",position:{x:4,y:0,z:5},color:"#DC143C"},{type:"table",position:{x:3,y:0,z:3},color:"#8B4513"},{type:"slab",position:{x:3,y:1,z:3},color:"#228B22"},{type:"shelf",position:{x:0,y:0,z:2},color:"#2F2F2F"},{type:"shelf",position:{x:0,y:0,z:3},color:"#2F2F2F"},{type:"shelf",position:{x:0,y:0,z:4},color:"#2F2F2F"},{type:"monitor",position:{x:0,y:1,z:3},color:"#1A1A1A"},{type:"speaker",position:{x:0,y:1,z:2},color:"#2F2F2F"},{type:"speaker",position:{x:0,y:1,z:4},color:"#2F2F2F"},{type:"shelfUnit",position:{x:7,y:0,z:0},color:"#654321"},{type:"shelfUnit",position:{x:7,y:1,z:0},color:"#654321"},{type:"shelfUnit",position:{x:7,y:2,z:0},color:"#654321"},{type:"chair",position:{x:6,y:0,z:3},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"table",position:{x:6,y:0,z:5},color:"#A0522D"},{type:"pillar2",position:{x:6,y:1,z:5},color:"#B87333"},{type:"dome",position:{x:6,y:2,z:5},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:1.5,radius:4}},{type:"planter",position:{x:7,y:0,z:5},color:"#8B4513"},{type:"bush",position:{x:7,y:1,z:5},color:"#228B22"},{type:"bush",position:{x:7,y:2,z:5},color:"#2E8B57"},{type:"windowFrame",position:{x:0,y:2,z:5},color:"#F5F5DC"},{type:"windowFrame",position:{x:0,y:2,z:6},color:"#F5F5DC"},{type:"windowSill",position:{x:0,y:1,z:5},color:"#F5F5DC"},{type:"windowSill",position:{x:0,y:1,z:6},color:"#F5F5DC"},{type:"lightFixture",position:{x:3,y:3,z:3},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:5}}]},workshop:{name:"Workshop",category:"furniture",description:"Crafting workshop with tools",blocks:[...L(0,0,0,4,4,"#696969"),{type:"table",position:{x:0,y:0,z:0},color:"#8B4513"},{type:"table",position:{x:1,y:0,z:0},color:"#8B4513"},{type:"table",position:{x:2,y:0,z:0},color:"#8B4513"},{type:"valve",position:{x:0,y:1,z:0},color:"#B22222"},{type:"valve",position:{x:2,y:1,z:0},color:"#4169E1"},{type:"chair",position:{x:1,y:0,z:1},color:"#654321"},{type:"crate",position:{x:3,y:0,z:0},color:"#8B4513"},{type:"crate",position:{x:3,y:0,z:1},color:"#A0522D"},{type:"crate",position:{x:3,y:1,z:0},color:"#CD853F"},{type:"barrel",position:{x:0,y:0,z:3},color:"#2F4F4F"},{type:"barrel",position:{x:1,y:0,z:3},color:"#006400"},{type:"ladder",position:{x:3,y:0,z:3},color:"#8B4513"},{type:"ladder",position:{x:3,y:1,z:3},color:"#8B4513"}]},cellar:{name:"Wine Cellar",category:"furniture",description:"Underground cellar with barrels",blocks:[...L(0,0,0,4,3,"#505050"),{type:"barrel",position:{x:0,y:0,z:0},color:"#5C4033",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:1,y:0,z:0},color:"#5C4033",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:2,y:0,z:0},color:"#5C4033",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:0,y:1,z:0},color:"#4A3728",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:1,y:1,z:0},color:"#4A3728",rotation:{x:90,y:0,z:0}},{type:"barrel",position:{x:2,y:1,z:0},color:"#4A3728",rotation:{x:90,y:0,z:0}},{type:"crate",position:{x:3,y:0,z:0},color:"#654321"},{type:"crate",position:{x:3,y:1,z:0},color:"#654321"},{type:"crate",position:{x:3,y:0,z:1},color:"#654321"},{type:"crate",position:{x:3,y:1,z:1},color:"#654321"},{type:"table",position:{x:1,y:0,z:2},color:"#8B4513"},{type:"torch",position:{x:0,y:1,z:2},color:"#8B4513",emissive:{enabled:!0,color:"#FF6600",intensity:1.5,radius:4}}]},stoneBridge:{name:"Stone Bridge",category:"infrastructure",description:"Grand arched stone bridge with decorative pillars, lanterns, and water below",blocks:[{type:"slab",position:{x:1,y:-1,z:0},color:"#4169E1"},{type:"slab",position:{x:2,y:-1,z:0},color:"#4682B4"},{type:"slab",position:{x:3,y:-1,z:0},color:"#4169E1"},{type:"slab",position:{x:4,y:-1,z:0},color:"#4682B4"},{type:"slab",position:{x:5,y:-1,z:0},color:"#4169E1"},{type:"slab",position:{x:1,y:-1,z:1},color:"#4682B4"},{type:"slab",position:{x:2,y:-1,z:1},color:"#4169E1"},{type:"slab",position:{x:3,y:-1,z:1},color:"#4682B4"},{type:"slab",position:{x:4,y:-1,z:1},color:"#4169E1"},{type:"slab",position:{x:5,y:-1,z:1},color:"#4682B4"},{type:"slab",position:{x:1,y:-1,z:-1},color:"#4682B4"},{type:"slab",position:{x:2,y:-1,z:-1},color:"#4169E1"},{type:"slab",position:{x:3,y:-1,z:-1},color:"#4682B4"},{type:"slab",position:{x:4,y:-1,z:-1},color:"#4169E1"},{type:"slab",position:{x:5,y:-1,z:-1},color:"#4682B4"},{type:"column",position:{x:0,y:-1,z:0},color:"#505050"},{type:"column",position:{x:0,y:0,z:0},color:"#606060"},{type:"column",position:{x:0,y:1,z:0},color:"#696969"},{type:"base",position:{x:0,y:-1,z:0},color:"#404040"},{type:"column",position:{x:8,y:-1,z:0},color:"#505050"},{type:"column",position:{x:8,y:0,z:0},color:"#606060"},{type:"column",position:{x:8,y:1,z:0},color:"#696969"},{type:"base",position:{x:8,y:-1,z:0},color:"#404040"},{type:"column",position:{x:4,y:-1,z:0},color:"#505050"},{type:"buttress",position:{x:4,y:0,z:0},color:"#606060"},{type:"arch",position:{x:2,y:0,z:0},color:"#707070",rotation:{x:0,y:90,z:0}},{type:"arch",position:{x:6,y:0,z:0},color:"#707070",rotation:{x:0,y:90,z:0}},...J(0,2,0,9,"X","slab","#808080"),...J(0,2,-1,9,"X","slab","#909090"),...J(0,2,1,9,"X","slab","#909090"),{type:"slab",position:{x:1,y:2,z:0},color:"#707070"},{type:"slab",position:{x:3,y:2,z:0},color:"#707070"},{type:"slab",position:{x:5,y:2,z:0},color:"#707070"},{type:"slab",position:{x:7,y:2,z:0},color:"#707070"},{type:"baluster",position:{x:0,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:2,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:4,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:6,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:8,y:2,z:-2},color:"#909090"},{type:"baluster",position:{x:0,y:2,z:2},color:"#909090"},{type:"baluster",position:{x:2,y:2,z:2},color:"#909090"},{type:"baluster",position:{x:4,y:2,z:2},color:"#909090"},{type:"baluster",position:{x:6,y:2,z:2},color:"#909090"},{type:"baluster",position:{x:8,y:2,z:2},color:"#909090"},...J(0,3,-2,9,"X","railing","#808080"),...J(0,3,2,9,"X","railing","#808080"),{type:"cube",position:{x:0,y:2,z:-2},color:"#707070"},{type:"cube",position:{x:0,y:2,z:2},color:"#707070"},{type:"cube",position:{x:8,y:2,z:-2},color:"#707070"},{type:"cube",position:{x:8,y:2,z:2},color:"#707070"},{type:"finial",position:{x:0,y:3,z:-2},color:"#606060"},{type:"finial",position:{x:0,y:3,z:2},color:"#606060"},{type:"finial",position:{x:8,y:3,z:-2},color:"#606060"},{type:"finial",position:{x:8,y:3,z:2},color:"#606060"},{type:"pillar4",position:{x:0,y:3,z:0},color:"#2F2F2F"},{type:"sphere",position:{x:0,y:4,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFD700",intensity:2,radius:4}},{type:"pillar4",position:{x:8,y:3,z:0},color:"#2F2F2F"},{type:"sphere",position:{x:8,y:4,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFD700",intensity:2,radius:4}},{type:"pillar4",position:{x:4,y:3,z:0},color:"#2F2F2F"},{type:"sphere",position:{x:4,y:4,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFD700",intensity:2,radius:4}},{type:"wedge",position:{x:-1,y:1,z:0},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"wedge",position:{x:-1,y:1,z:-1},color:"#606060",rotation:{x:0,y:90,z:0}},{type:"wedge",position:{x:-1,y:1,z:1},color:"#606060",rotation:{x:0,y:90,z:0}},{type:"wedge",position:{x:9,y:1,z:0},color:"#505050",rotation:{x:0,y:-90,z:0}},{type:"wedge",position:{x:9,y:1,z:-1},color:"#606060",rotation:{x:0,y:-90,z:0}},{type:"wedge",position:{x:9,y:1,z:1},color:"#606060",rotation:{x:0,y:-90,z:0}},{type:"bush",position:{x:-1,y:0,z:-2},color:"#228B22"},{type:"bush",position:{x:9,y:0,z:2},color:"#2E8B2E"}]},streetCorner:{name:"Street Corner",category:"infrastructure",description:"Urban street corner with lamp",blocks:[...L(0,0,0,4,4,"#D3D3D3"),{type:"slab",position:{x:0,y:0,z:-1},color:"#2F2F2F"},{type:"slab",position:{x:1,y:0,z:-1},color:"#2F2F2F"},{type:"slab",position:{x:2,y:0,z:-1},color:"#2F2F2F"},{type:"slab",position:{x:3,y:0,z:-1},color:"#2F2F2F"},{type:"slab",position:{x:-1,y:0,z:0},color:"#2F2F2F"},{type:"slab",position:{x:-1,y:0,z:1},color:"#2F2F2F"},{type:"slab",position:{x:-1,y:0,z:2},color:"#2F2F2F"},{type:"slab",position:{x:-1,y:0,z:3},color:"#2F2F2F"},{type:"pillar2",position:{x:0,y:0,z:0},color:"#2F2F2F"},{type:"pillar2",position:{x:0,y:1,z:0},color:"#2F2F2F"},{type:"pillar2",position:{x:0,y:2,z:0},color:"#2F2F2F"},{type:"dome",position:{x:0,y:3,z:0},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:2,radius:6}},{type:"bench",position:{x:2,y:0,z:0},color:"#228B22"},{type:"planter",position:{x:3,y:0,z:0},color:"#8B4513"},{type:"bush",position:{x:3,y:1,z:0},color:"#228B22"},{type:"barrier",position:{x:0,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:1,y:0,z:3},color:"#FFD700"}]},plaza:{name:"Plaza",category:"infrastructure",description:"Grand public plaza with tiered fountain, outdoor seating, landscaping, and decorative lighting",blocks:[...L(0,0,0,12,12,"#B8B8B8"),...J(0,0,0,12,"X","slab","#808080"),...J(0,0,11,12,"X","slab","#808080"),{type:"slab",position:{x:0,y:0,z:1},color:"#808080"},{type:"slab",position:{x:0,y:0,z:2},color:"#808080"},{type:"slab",position:{x:0,y:0,z:3},color:"#808080"},{type:"slab",position:{x:0,y:0,z:4},color:"#808080"},{type:"slab",position:{x:0,y:0,z:5},color:"#808080"},{type:"slab",position:{x:0,y:0,z:6},color:"#808080"},{type:"slab",position:{x:0,y:0,z:7},color:"#808080"},{type:"slab",position:{x:0,y:0,z:8},color:"#808080"},{type:"slab",position:{x:0,y:0,z:9},color:"#808080"},{type:"slab",position:{x:0,y:0,z:10},color:"#808080"},{type:"slab",position:{x:11,y:0,z:1},color:"#808080"},{type:"slab",position:{x:11,y:0,z:2},color:"#808080"},{type:"slab",position:{x:11,y:0,z:3},color:"#808080"},{type:"slab",position:{x:11,y:0,z:4},color:"#808080"},{type:"slab",position:{x:11,y:0,z:5},color:"#808080"},{type:"slab",position:{x:11,y:0,z:6},color:"#808080"},{type:"slab",position:{x:11,y:0,z:7},color:"#808080"},{type:"slab",position:{x:11,y:0,z:8},color:"#808080"},{type:"slab",position:{x:11,y:0,z:9},color:"#808080"},{type:"slab",position:{x:11,y:0,z:10},color:"#808080"},{type:"slab",position:{x:4,y:0,z:4},color:"#606060"},{type:"slab",position:{x:5,y:0,z:4},color:"#606060"},{type:"slab",position:{x:6,y:0,z:4},color:"#606060"},{type:"slab",position:{x:7,y:0,z:4},color:"#606060"},{type:"slab",position:{x:4,y:0,z:7},color:"#606060"},{type:"slab",position:{x:5,y:0,z:7},color:"#606060"},{type:"slab",position:{x:6,y:0,z:7},color:"#606060"},{type:"slab",position:{x:7,y:0,z:7},color:"#606060"},{type:"slab",position:{x:4,y:0,z:5},color:"#606060"},{type:"slab",position:{x:4,y:0,z:6},color:"#606060"},{type:"slab",position:{x:7,y:0,z:5},color:"#606060"},{type:"slab",position:{x:7,y:0,z:6},color:"#606060"},{type:"quarter",position:{x:5,y:0,z:5},color:"#4169E1"},{type:"quarter",position:{x:6,y:0,z:5},color:"#4682B4"},{type:"quarter",position:{x:5,y:0,z:6},color:"#4682B4"},{type:"quarter",position:{x:6,y:0,z:6},color:"#4169E1"},{type:"cylinder",position:{x:5,y:0,z:5},color:"#A0A0A0"},{type:"cylinder",position:{x:5,y:1,z:5},color:"#909090"},{type:"bowl",position:{x:5,y:2,z:5},color:"#B0B0B0"},{type:"pillar2",position:{x:5,y:2,z:5},color:"#C0C0C0"},{type:"finial",position:{x:5,y:3,z:5},color:"#D4AF37"},{type:"base",position:{x:3,y:0,z:3},color:"#808080"},{type:"column",position:{x:3,y:1,z:3},color:"#D3D3D3"},{type:"capital",position:{x:3,y:2,z:3},color:"#D3D3D3"},{type:"base",position:{x:8,y:0,z:3},color:"#808080"},{type:"column",position:{x:8,y:1,z:3},color:"#D3D3D3"},{type:"capital",position:{x:8,y:2,z:3},color:"#D3D3D3"},{type:"base",position:{x:3,y:0,z:8},color:"#808080"},{type:"column",position:{x:3,y:1,z:8},color:"#D3D3D3"},{type:"capital",position:{x:3,y:2,z:8},color:"#D3D3D3"},{type:"base",position:{x:8,y:0,z:8},color:"#808080"},{type:"column",position:{x:8,y:1,z:8},color:"#D3D3D3"},{type:"capital",position:{x:8,y:2,z:8},color:"#D3D3D3"},{type:"bench",position:{x:3,y:0,z:1},color:"#8B4513",rotation:{x:0,y:180,z:0}},{type:"bench",position:{x:5,y:0,z:1},color:"#8B4513",rotation:{x:0,y:180,z:0}},{type:"bench",position:{x:7,y:0,z:1},color:"#8B4513",rotation:{x:0,y:180,z:0}},{type:"bench",position:{x:3,y:0,z:10},color:"#8B4513"},{type:"bench",position:{x:5,y:0,z:10},color:"#8B4513"},{type:"bench",position:{x:7,y:0,z:10},color:"#8B4513"},{type:"bench",position:{x:10,y:0,z:4},color:"#8B4513",rotation:{x:0,y:270,z:0}},{type:"bench",position:{x:10,y:0,z:6},color:"#8B4513",rotation:{x:0,y:270,z:0}},{type:"bench",position:{x:1,y:0,z:4},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"bench",position:{x:1,y:0,z:6},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"table",position:{x:9,y:0,z:9},color:"#8B4513"},{type:"chair",position:{x:9,y:0,z:8},color:"#8B4513",rotation:{x:0,y:180,z:0}},{type:"chair",position:{x:9,y:0,z:10},color:"#8B4513"},{type:"chair",position:{x:8,y:0,z:9},color:"#8B4513",rotation:{x:0,y:90,z:0}},{type:"chair",position:{x:10,y:0,z:9},color:"#8B4513",rotation:{x:0,y:270,z:0}},{type:"umbrella",position:{x:9,y:1,z:9},color:"#DC143C"},{type:"planter",position:{x:1,y:0,z:1},color:"#696969"},{type:"planter",position:{x:2,y:0,z:1},color:"#696969"},{type:"planter",position:{x:1,y:0,z:2},color:"#696969"},{type:"logZ",position:{x:1,y:1,z:1},color:"#654321"},{type:"logZ",position:{x:1,y:2,z:1},color:"#654321"},{type:"bush",position:{x:1,y:3,z:1},color:"#228B22"},{type:"bush",position:{x:0,y:3,z:1},color:"#2E8B57"},{type:"bush",position:{x:1,y:3,z:0},color:"#2E8B57"},{type:"bush",position:{x:1,y:4,z:1},color:"#228B22"},{type:"planter",position:{x:9,y:0,z:1},color:"#696969"},{type:"planter",position:{x:10,y:0,z:1},color:"#696969"},{type:"planter",position:{x:10,y:0,z:2},color:"#696969"},{type:"logZ",position:{x:10,y:1,z:1},color:"#654321"},{type:"logZ",position:{x:10,y:2,z:1},color:"#654321"},{type:"bush",position:{x:10,y:3,z:1},color:"#228B22"},{type:"bush",position:{x:10,y:3,z:0},color:"#32CD32"},{type:"bush",position:{x:10,y:4,z:1},color:"#228B22"},{type:"planter",position:{x:2,y:0,z:5},color:"#696969"},{type:"flower",position:{x:2,y:1,z:5},color:"#FF6B6B"},{type:"planter",position:{x:2,y:0,z:6},color:"#696969"},{type:"flower",position:{x:2,y:1,z:6},color:"#FFD700"},{type:"planter",position:{x:9,y:0,z:5},color:"#696969"},{type:"flower",position:{x:9,y:1,z:5},color:"#DA70D6"},{type:"planter",position:{x:9,y:0,z:6},color:"#696969"},{type:"flower",position:{x:9,y:1,z:6},color:"#FF69B4"},{type:"pillar",position:{x:2,y:0,z:2},color:"#2F4F4F"},{type:"pillar",position:{x:2,y:1,z:2},color:"#2F4F4F"},{type:"pillar",position:{x:2,y:2,z:2},color:"#2F4F4F"},{type:"lightFixture",position:{x:2,y:3,z:2},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1.2,radius:4}},{type:"pillar",position:{x:9,y:0,z:2},color:"#2F4F4F"},{type:"pillar",position:{x:9,y:1,z:2},color:"#2F4F4F"},{type:"pillar",position:{x:9,y:2,z:2},color:"#2F4F4F"},{type:"lightFixture",position:{x:9,y:3,z:2},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1.2,radius:4}},{type:"pillar",position:{x:2,y:0,z:9},color:"#2F4F4F"},{type:"pillar",position:{x:2,y:1,z:9},color:"#2F4F4F"},{type:"pillar",position:{x:2,y:2,z:9},color:"#2F4F4F"},{type:"lightFixture",position:{x:2,y:3,z:9},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1.2,radius:4}},{type:"bin",position:{x:4,y:0,z:2},color:"#2F4F4F"},{type:"bin",position:{x:7,y:0,z:9},color:"#2F4F4F"},{type:"pediment",position:{x:1,y:0,z:9},color:"#808080"},{type:"pillar2",position:{x:1,y:1,z:9},color:"#A0A0A0"},{type:"sphere",position:{x:1,y:2,z:9},color:"#B87333"},{type:"grate",position:{x:3,y:0,z:5},color:"#404040"},{type:"grate",position:{x:8,y:0,z:6},color:"#404040"}]},stairway:{name:"Grand Stairway",category:"infrastructure",description:"Elegant staircase with balusters",blocks:[{type:"stairs",position:{x:1,y:0,z:0},color:"#D3D3D3"},{type:"stairs",position:{x:1,y:1,z:1},color:"#D3D3D3"},{type:"stairs",position:{x:1,y:2,z:2},color:"#D3D3D3"},{type:"stairs",position:{x:1,y:3,z:3},color:"#D3D3D3"},{type:"baluster",position:{x:0,y:0,z:0},color:"#F5F5DC"},{type:"baluster",position:{x:0,y:1,z:1},color:"#F5F5DC"},{type:"baluster",position:{x:0,y:2,z:2},color:"#F5F5DC"},{type:"baluster",position:{x:0,y:3,z:3},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:0,z:0},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:1,z:1},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:2,z:2},color:"#F5F5DC"},{type:"baluster",position:{x:2,y:3,z:3},color:"#F5F5DC"},{type:"railing",position:{x:0,y:1,z:0},color:"#DAA520"},{type:"railing",position:{x:0,y:2,z:1},color:"#DAA520"},{type:"railing",position:{x:0,y:3,z:2},color:"#DAA520"},{type:"railing",position:{x:0,y:4,z:3},color:"#DAA520"},{type:"railing",position:{x:2,y:1,z:0},color:"#DAA520"},{type:"railing",position:{x:2,y:2,z:1},color:"#DAA520"},{type:"railing",position:{x:2,y:3,z:2},color:"#DAA520"},{type:"railing",position:{x:2,y:4,z:3},color:"#DAA520"},{type:"capital",position:{x:0,y:1,z:0},color:"#F5F5DC"},{type:"capital",position:{x:2,y:1,z:0},color:"#F5F5DC"},{type:"slab",position:{x:0,y:4,z:4},color:"#D3D3D3"},{type:"slab",position:{x:1,y:4,z:4},color:"#D3D3D3"},{type:"slab",position:{x:2,y:4,z:4},color:"#D3D3D3"}]},cityBlock:{name:"City Block",category:"city",description:"Detailed urban block with shops, apartments, offices, street furniture, and traffic elements",blocks:[...L(-2,0,-2,16,2,"#2F2F2F"),...L(-2,0,12,16,2,"#2F2F2F"),...L(-2,0,0,2,12,"#2F2F2F"),...L(12,0,0,2,12,"#2F2F2F"),{type:"slab",position:{x:3,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:5,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:7,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:9,y:0,z:-1},color:"#FFFFFF"},...L(0,0,0,12,12,"#B0B0B0"),{type:"slab",position:{x:0,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:1,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:-1},color:"#FFFFFF"},{type:"slab",position:{x:11,y:0,z:-1},color:"#FFFFFF"},...L(0,0,0,4,5,"#404040"),...wt(0,1,0,4,5,"#303030","#4169E1"),...wt(0,2,0,4,5,"#303030","#4682B4"),...wt(0,3,0,4,5,"#303030","#4169E1"),...wt(0,4,0,4,5,"#303030","#4682B4"),...wt(0,5,0,4,5,"#303030","#4169E1"),...wt(0,6,0,4,5,"#303030","#4682B4"),...L(0,7,0,4,5,"#353535"),{type:"acUnit",position:{x:1,y:7,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:2,y:7,z:2},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:7,z:3},color:"#808080"},{type:"doorFrame",position:{x:1,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:2,y:1,z:0},color:"#4682B4"},{type:"awning",position:{x:1,y:2,z:-1},color:"#2F2F2F"},{type:"awning",position:{x:2,y:2,z:-1},color:"#2F2F2F"},...L(5,0,0,4,4,"#696969"),...yt(5,1,0,4,4,"#DEB887"),...yt(5,2,0,4,4,"#F5DEB3"),...L(5,3,0,4,4,"#8B4513"),{type:"doorFrame",position:{x:6,y:1,z:0},color:"#654321"},{type:"awning",position:{x:5,y:2,z:-1},color:"#DC143C"},{type:"awning",position:{x:6,y:2,z:-1},color:"#DC143C"},{type:"awning",position:{x:7,y:2,z:-1},color:"#DC143C"},{type:"windowFrame",position:{x:5,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:0},color:"#4682B4"},{type:"sign",position:{x:6,y:2,z:0},color:"#FFD700"},{type:"table",position:{x:5,y:0,z:-1},color:"#8B4513"},{type:"chair",position:{x:5,y:0,z:-2},color:"#8B4513"},...L(9,0,0,3,5,"#505050"),...yt(9,1,0,3,5,"#CD853F"),...yt(9,2,0,3,5,"#CD853F"),...yt(9,3,0,3,5,"#D2B48C"),...yt(9,4,0,3,5,"#D2B48C"),...yt(9,5,0,3,5,"#CD853F"),...L(9,6,0,3,5,"#8B0000"),{type:"windowFrame",position:{x:10,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:10,y:2,z:0},color:"#87CEEB"},{type:"windowFrame",position:{x:10,y:3,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:10,y:4,z:0},color:"#87CEEB"},{type:"windowFrame",position:{x:10,y:5,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:9,y:1,z:0},color:"#654321"},{type:"step",position:{x:9,y:0,z:-1},color:"#808080"},{type:"slab",position:{x:10,y:3,z:-1},color:"#808080"},{type:"railing",position:{x:10,y:4,z:-1},color:"#404040"},{type:"slab",position:{x:10,y:5,z:-1},color:"#808080"},{type:"railing",position:{x:10,y:6,z:-1},color:"#404040"},...L(0,0,7,7,5,"#606060"),...at(0,1,7,7,3,"#808080"),...at(0,1,11,7,3,"#808080"),...st(0,1,8,3,3,"#808080"),...st(6,1,8,3,3,"#808080"),...L(0,4,7,7,5,"#505050"),{type:"doorFrame",position:{x:2,y:1,z:7},color:"#4A4A4A"},{type:"doorFrame",position:{x:3,y:1,z:7},color:"#4A4A4A"},{type:"doorFrame",position:{x:2,y:2,z:7},color:"#4A4A4A"},{type:"doorFrame",position:{x:3,y:2,z:7},color:"#4A4A4A"},{type:"barrel",position:{x:5,y:1,z:9},color:"#2F4F4F"},{type:"barrel",position:{x:5,y:1,z:10},color:"#006400"},...L(8,0,6,4,6,"#3A3A3A"),{type:"slab",position:{x:8,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:8,y:0,z:9},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:9},color:"#FFFFFF"},{type:"barrier",position:{x:8,y:0,z:6},color:"#FFD700"},{type:"barrier",position:{x:11,y:0,z:6},color:"#FFD700"},{type:"pillar",position:{x:-1,y:0,z:3},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:1,z:3},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:2,z:3},color:"#2F2F2F"},{type:"lightFixture",position:{x:-1,y:3,z:3},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:1.5,radius:5}},{type:"pillar",position:{x:-1,y:0,z:8},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:1,z:8},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:2,z:8},color:"#2F2F2F"},{type:"lightFixture",position:{x:-1,y:3,z:8},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:1.5,radius:5}},{type:"pillar",position:{x:12,y:0,z:5},color:"#2F2F2F"},{type:"pillar",position:{x:12,y:1,z:5},color:"#2F2F2F"},{type:"pillar",position:{x:12,y:2,z:5},color:"#2F2F2F"},{type:"lightFixture",position:{x:12,y:3,z:5},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:1.5,radius:5}},{type:"bollard",position:{x:4,y:0,z:-1},color:"#FF0000"},{type:"bin",position:{x:0,y:0,z:-1},color:"#2F4F4F"},{type:"bin",position:{x:8,y:0,z:-1},color:"#2F4F4F"},{type:"bench",position:{x:4,y:0,z:5},color:"#8B4513"},{type:"pillar",position:{x:-1,y:0,z:-1},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:1,z:-1},color:"#2F2F2F"},{type:"pillar",position:{x:-1,y:2,z:-1},color:"#2F2F2F"},{type:"bulb",position:{x:-1,y:3,z:-1},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:1,radius:2}},{type:"pillar",position:{x:12,y:0,z:10},color:"#4169E1"},{type:"pillar",position:{x:12,y:1,z:10},color:"#4169E1"},{type:"sign",position:{x:12,y:2,z:10},color:"#FFD700"},{type:"bench",position:{x:11,y:0,z:10},color:"#808080",rotation:{x:0,y:90,z:0}},{type:"planter",position:{x:4,y:0,z:4},color:"#505050"},{type:"logZ",position:{x:4,y:1,z:4},color:"#654321"},{type:"bush",position:{x:4,y:2,z:4},color:"#228B22"},{type:"bush",position:{x:4,y:3,z:4},color:"#2E8B57"},{type:"planter",position:{x:7,y:0,z:5},color:"#505050"},{type:"logZ",position:{x:7,y:1,z:5},color:"#654321"},{type:"bush",position:{x:7,y:2,z:5},color:"#228B22"},{type:"bush",position:{x:7,y:3,z:5},color:"#32CD32"}]},skyscraper:{name:"Skyscraper",category:"city",description:"Modern glass tower with helipad, observation deck, and detailed infrastructure",blocks:[...L(-1,0,-1,8,8,"#2F2F2F"),{type:"planter",position:{x:-1,y:0,z:2},color:"#505050"},{type:"bush",position:{x:-1,y:1,z:2},color:"#228B22"},{type:"planter",position:{x:-1,y:0,z:4},color:"#505050"},{type:"bush",position:{x:-1,y:1,z:4},color:"#228B22"},{type:"bench",position:{x:6,y:0,z:2},color:"#808080"},...wt(0,1,0,6,6,"#303030","#4169E1"),...wt(0,2,0,6,6,"#303030","#4682B4"),...wt(0,3,0,6,6,"#303030","#4169E1"),...wt(0,4,0,6,6,"#303030","#4682B4"),...wt(0,5,0,6,6,"#303030","#4169E1"),...yt(0,6,0,6,6,"#252525"),...wt(0,7,0,6,6,"#303030","#4682B4"),...wt(0,8,0,6,6,"#303030","#4169E1"),...wt(0,9,0,6,6,"#303030","#4682B4"),...wt(0,10,0,6,6,"#303030","#4169E1"),...wt(1,11,1,4,4,"#404040","#4169E1"),...wt(1,12,1,4,4,"#404040","#4682B4"),...L(1,13,1,4,4,"#252525"),{type:"railing",position:{x:1,y:13,z:0},color:"#C0C0C0"},{type:"railing",position:{x:2,y:13,z:0},color:"#C0C0C0"},{type:"railing",position:{x:3,y:13,z:0},color:"#C0C0C0"},{type:"railing",position:{x:4,y:13,z:0},color:"#C0C0C0"},{type:"railing",position:{x:0,y:13,z:1},color:"#C0C0C0"},{type:"railing",position:{x:0,y:13,z:2},color:"#C0C0C0"},{type:"railing",position:{x:0,y:13,z:3},color:"#C0C0C0"},{type:"railing",position:{x:0,y:13,z:4},color:"#C0C0C0"},...L(1,14,1,4,4,"#404040"),{type:"slab",position:{x:2,y:14,z:2},color:"#FFFF00"},{type:"slab",position:{x:3,y:14,z:2},color:"#FFFF00"},{type:"slab",position:{x:2,y:14,z:3},color:"#FFFF00"},{type:"slab",position:{x:3,y:14,z:3},color:"#FFFF00"},{type:"sphere",position:{x:1,y:14,z:1},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:2}},{type:"sphere",position:{x:4,y:14,z:1},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:2}},{type:"sphere",position:{x:1,y:14,z:4},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:2}},{type:"sphere",position:{x:4,y:14,z:4},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:2}},{type:"pillar2",position:{x:2,y:15,z:2},color:"#C0C0C0"},{type:"pillar2",position:{x:2,y:16,z:2},color:"#C0C0C0"},{type:"pillar4",position:{x:2,y:17,z:2},color:"#C0C0C0"},{type:"pillar4",position:{x:2,y:18,z:2},color:"#C0C0C0"},{type:"antenna",position:{x:2,y:19,z:2},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:3,radius:5}},{type:"acUnit",position:{x:5,y:11,z:1},color:"#808080"},{type:"acUnit",position:{x:5,y:11,z:3},color:"#808080"},{type:"acUnit",position:{x:5,y:11,z:5},color:"#808080"},{type:"vent",position:{x:0,y:11,z:2},color:"#606060"},{type:"vent",position:{x:0,y:11,z:4},color:"#606060"},{type:"dome",position:{x:0,y:11,z:0},color:"#E0E0E0"},{type:"doorFrame",position:{x:2,y:1,z:0},color:"#B8860B"},{type:"doorFrame",position:{x:3,y:1,z:0},color:"#B8860B"},{type:"slab",position:{x:1,y:2,z:-1},color:"#303030"},{type:"slab",position:{x:2,y:2,z:-1},color:"#303030"},{type:"slab",position:{x:3,y:2,z:-1},color:"#303030"},{type:"slab",position:{x:4,y:2,z:-1},color:"#303030"},{type:"column",position:{x:1,y:1,z:0},color:"#D4AF37"},{type:"column",position:{x:4,y:1,z:0},color:"#D4AF37"},{type:"capital",position:{x:1,y:2,z:0},color:"#D4AF37"},{type:"capital",position:{x:4,y:2,z:0},color:"#D4AF37"},{type:"spotlight",position:{x:0,y:0,z:-1},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:2,radius:3}},{type:"spotlight",position:{x:5,y:0,z:-1},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:2,radius:3}},{type:"beam4X",position:{x:0,y:10,z:-1},color:"#404040"},{type:"beam4X",position:{x:2,y:10,z:-1},color:"#404040"},{type:"beam4X",position:{x:4,y:10,z:-1},color:"#404040"}]},apartmentBuilding:{name:"Apartment Building",category:"city",description:"Residential apartment with balconies, fire escape, rooftop amenities, and urban details",blocks:[...L(-1,0,-2,10,8,"#707070"),...L(0,0,0,8,5,"#505050"),...yt(0,1,0,8,5,"#8B4513"),...yt(0,2,0,8,5,"#DEB887"),...yt(0,3,0,8,5,"#DEB887"),...yt(0,4,0,8,5,"#DEB887"),...yt(0,5,0,8,5,"#E8D8B8"),...yt(0,6,0,8,5,"#E8D8B8"),...yt(0,7,0,8,5,"#E8D8B8"),...L(0,8,0,8,5,"#404040"),...J(0,8,0,8,"X","ledge","#505050"),...J(0,8,4,8,"X","ledge","#505050"),{type:"ledge",position:{x:0,y:8,z:1},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"ledge",position:{x:0,y:8,z:2},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"ledge",position:{x:0,y:8,z:3},color:"#505050",rotation:{x:0,y:90,z:0}},{type:"ledge",position:{x:7,y:8,z:1},color:"#505050",rotation:{x:0,y:270,z:0}},{type:"ledge",position:{x:7,y:8,z:2},color:"#505050",rotation:{x:0,y:270,z:0}},{type:"ledge",position:{x:7,y:8,z:3},color:"#505050",rotation:{x:0,y:270,z:0}},{type:"tank",position:{x:1,y:8,z:2},color:"#2F4F4F"},{type:"tank",position:{x:1,y:9,z:2},color:"#2F4F4F"},{type:"acUnit",position:{x:5,y:8,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:6,y:8,z:1},color:"#C0C0C0"},{type:"acUnit",position:{x:5,y:8,z:3},color:"#C0C0C0"},{type:"antenna",position:{x:3,y:8,z:2},color:"#808080"},{type:"cube",position:{x:4,y:8,z:2},color:"#606060"},{type:"slab",position:{x:4,y:9,z:2},color:"#505050"},{type:"doorFrame",position:{x:4,y:8,z:1},color:"#404040"},{type:"slab",position:{x:1,y:2,z:-1},color:"#808080"},{type:"slab",position:{x:2,y:2,z:-1},color:"#808080"},{type:"railing",position:{x:1,y:3,z:-1},color:"#303030"},{type:"railing",position:{x:2,y:3,z:-1},color:"#303030"},{type:"planter",position:{x:1,y:2,z:-1},color:"#8B4513"},{type:"flower",position:{x:1,y:3,z:-1},color:"#FF6B6B"},{type:"slab",position:{x:5,y:2,z:-1},color:"#808080"},{type:"slab",position:{x:6,y:2,z:-1},color:"#808080"},{type:"railing",position:{x:5,y:3,z:-1},color:"#303030"},{type:"railing",position:{x:6,y:3,z:-1},color:"#303030"},{type:"chair",position:{x:6,y:2,z:-1},color:"#8B4513"},{type:"slab",position:{x:1,y:4,z:-1},color:"#808080"},{type:"slab",position:{x:2,y:4,z:-1},color:"#808080"},{type:"railing",position:{x:1,y:5,z:-1},color:"#303030"},{type:"railing",position:{x:2,y:5,z:-1},color:"#303030"},{type:"slab",position:{x:5,y:4,z:-1},color:"#808080"},{type:"slab",position:{x:6,y:4,z:-1},color:"#808080"},{type:"railing",position:{x:5,y:5,z:-1},color:"#303030"},{type:"railing",position:{x:6,y:5,z:-1},color:"#303030"},{type:"planter",position:{x:5,y:4,z:-1},color:"#8B4513"},{type:"bush",position:{x:5,y:5,z:-1},color:"#228B22"},{type:"slab",position:{x:1,y:6,z:-1},color:"#808080"},{type:"slab",position:{x:2,y:6,z:-1},color:"#808080"},{type:"railing",position:{x:1,y:7,z:-1},color:"#303030"},{type:"railing",position:{x:2,y:7,z:-1},color:"#303030"},{type:"slab",position:{x:5,y:6,z:-1},color:"#808080"},{type:"slab",position:{x:6,y:6,z:-1},color:"#808080"},{type:"railing",position:{x:5,y:7,z:-1},color:"#303030"},{type:"railing",position:{x:6,y:7,z:-1},color:"#303030"},{type:"planter",position:{x:6,y:6,z:-1},color:"#8B4513"},{type:"flower",position:{x:6,y:7,z:-1},color:"#FFD700"},{type:"grateFloor",position:{x:8,y:2,z:1},color:"#303030"},{type:"grateFloor",position:{x:8,y:2,z:2},color:"#303030"},{type:"railing",position:{x:8,y:3,z:1},color:"#404040"},{type:"stairs",position:{x:8,y:3,z:2},color:"#303030",rotation:{x:0,y:90,z:0}},{type:"grateFloor",position:{x:8,y:4,z:1},color:"#303030"},{type:"grateFloor",position:{x:8,y:4,z:2},color:"#303030"},{type:"railing",position:{x:8,y:5,z:1},color:"#404040"},{type:"stairs",position:{x:8,y:5,z:2},color:"#303030",rotation:{x:0,y:270,z:0}},{type:"grateFloor",position:{x:8,y:6,z:1},color:"#303030"},{type:"grateFloor",position:{x:8,y:6,z:2},color:"#303030"},{type:"railing",position:{x:8,y:7,z:1},color:"#404040"},{type:"ladder",position:{x:8,y:0,z:1},color:"#404040"},{type:"ladder",position:{x:8,y:1,z:1},color:"#404040"},{type:"windowFrame",position:{x:1,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:2,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:5,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:1,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:5,y:2,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:4,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:4,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:5,y:4,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:6,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:6,z:0},color:"#4682B4"},{type:"windowFrame",position:{x:5,y:6,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:3,y:1,z:0},color:"#654321"},{type:"doorFrame",position:{x:4,y:1,z:0},color:"#654321"},{type:"awning",position:{x:3,y:2,z:-1},color:"#8B0000"},{type:"awning",position:{x:4,y:2,z:-1},color:"#8B0000"},{type:"step",position:{x:3,y:0,z:-1},color:"#606060"},{type:"step",position:{x:4,y:0,z:-1},color:"#606060"},{type:"locker",position:{x:0,y:1,z:-1},color:"#C0C0C0"},{type:"pillar",position:{x:-1,y:0,z:-1},color:"#404040"},{type:"pillar",position:{x:-1,y:1,z:-1},color:"#404040"},{type:"pillar",position:{x:-1,y:2,z:-1},color:"#404040"},{type:"lightFixture",position:{x:-1,y:3,z:-1},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1.2,radius:4}},{type:"bin",position:{x:7,y:0,z:-1},color:"#2F4F4F"},{type:"bollard",position:{x:8,y:0,z:-1},color:"#FF0000"},{type:"railing",position:{x:6,y:0,z:-1},color:"#808080"},{type:"powerBox",position:{x:0,y:1,z:1},color:"#808080"},{type:"cableY",position:{x:7,y:3,z:4},color:"#FFFFFF"},{type:"cableY",position:{x:7,y:4,z:4},color:"#FFFFFF"},{type:"cableY",position:{x:7,y:5,z:4},color:"#FFFFFF"},{type:"cableY",position:{x:7,y:6,z:4},color:"#FFFFFF"},{type:"cableY",position:{x:7,y:7,z:4},color:"#FFFFFF"},{type:"cornice",position:{x:0,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:1,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:2,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:5,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:6,y:2,z:0},color:"#D3D3D3"},{type:"cornice",position:{x:7,y:2,z:0},color:"#D3D3D3"}]},shoppingMall:{name:"Shopping Mall",category:"city",description:"Two-story shopping center with stores, food court, escalators, and glass atrium",blocks:[...L(0,0,0,18,14,"#D8D8D8"),...L(7,0,0,4,14,"#E8E8E8"),...at(0,1,0,18,6,"#E0E0E0"),...at(0,1,13,18,6,"#E0E0E0"),...st(0,1,1,12,6,"#E0E0E0"),...st(17,1,1,12,6,"#E0E0E0"),{type:"doorFrame",position:{x:7,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:8,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:9,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:10,y:1,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:7,y:2,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:8,y:2,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:9,y:2,z:0},color:"#4682B4"},{type:"doorFrame",position:{x:10,y:2,z:0},color:"#4682B4"},{type:"awning",position:{x:7,y:3,z:-1},color:"#E0E0E0"},{type:"awning",position:{x:8,y:3,z:-1},color:"#E0E0E0"},{type:"awning",position:{x:9,y:3,z:-1},color:"#E0E0E0"},{type:"awning",position:{x:10,y:3,z:-1},color:"#E0E0E0"},...st(1,1,1,3,3,"#F5F5DC"),...st(5,1,1,3,3,"#F5F5DC"),{type:"windowFrame",position:{x:2,y:1,z:1},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:1,z:1},color:"#4682B4"},{type:"windowFrame",position:{x:4,y:1,z:1},color:"#4682B4"},{type:"sign",position:{x:3,y:3,z:1},color:"#FF69B4"},{type:"shelf",position:{x:2,y:1,z:2},color:"#D2B48C"},{type:"shelf",position:{x:3,y:1,z:2},color:"#D2B48C"},{type:"shelf",position:{x:4,y:1,z:2},color:"#D2B48C"},...st(1,1,4,3,3,"#1E1E1E"),...st(5,1,4,3,3,"#1E1E1E"),{type:"windowFrame",position:{x:2,y:1,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:1,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:4,y:1,z:4},color:"#4682B4"},{type:"sign",position:{x:3,y:3,z:4},color:"#00BFFF"},{type:"monitor",position:{x:2,y:1,z:5},color:"#1E1E1E"},{type:"monitor",position:{x:4,y:1,z:5},color:"#1E1E1E"},{type:"table",position:{x:3,y:1,z:6},color:"#2F2F2F"},...st(12,1,1,3,3,"#8B4513"),...st(16,1,1,3,3,"#8B4513"),{type:"windowFrame",position:{x:13,y:1,z:1},color:"#4682B4"},{type:"windowFrame",position:{x:14,y:1,z:1},color:"#4682B4"},{type:"windowFrame",position:{x:15,y:1,z:1},color:"#4682B4"},{type:"sign",position:{x:14,y:3,z:1},color:"#228B22"},{type:"shelfUnit",position:{x:13,y:1,z:2},color:"#8B4513"},{type:"shelfUnit",position:{x:14,y:1,z:2},color:"#8B4513"},{type:"shelfUnit",position:{x:15,y:1,z:2},color:"#8B4513"},...st(12,1,4,3,3,"#FF4500"),...st(16,1,4,3,3,"#FF4500"),{type:"windowFrame",position:{x:13,y:1,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:14,y:1,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:15,y:1,z:4},color:"#4682B4"},{type:"sign",position:{x:14,y:3,z:4},color:"#FF4500"},{type:"shelf",position:{x:13,y:1,z:5},color:"#E0E0E0"},{type:"shelf",position:{x:15,y:1,z:5},color:"#E0E0E0"},{type:"cylinder",position:{x:8,y:0,z:3},color:"#708090"},{type:"cylinder",position:{x:9,y:0,z:3},color:"#708090"},{type:"cylinder",position:{x:8,y:0,z:4},color:"#708090"},{type:"cylinder",position:{x:9,y:0,z:4},color:"#708090"},{type:"slab",position:{x:8,y:0,z:3},color:"#87CEEB"},{type:"slab",position:{x:9,y:0,z:3},color:"#87CEEB"},{type:"slab",position:{x:8,y:0,z:4},color:"#87CEEB"},{type:"slab",position:{x:9,y:0,z:4},color:"#87CEEB"},{type:"pillar",position:{x:8,y:1,z:3},color:"#708090"},{type:"dome",position:{x:8,y:2,z:3},color:"#87CEEB"},{type:"stairs",position:{x:7,y:1,z:6},color:"#808080"},{type:"stairs",position:{x:7,y:2,z:7},color:"#808080"},{type:"stairs",position:{x:7,y:3,z:8},color:"#808080"},{type:"railing",position:{x:6,y:1,z:6},color:"#C0C0C0"},{type:"railing",position:{x:6,y:2,z:7},color:"#C0C0C0"},{type:"railing",position:{x:6,y:3,z:8},color:"#C0C0C0"},{type:"stairs",position:{x:10,y:1,z:8},color:"#808080",rotation:{x:0,y:180,z:0}},{type:"stairs",position:{x:10,y:2,z:7},color:"#808080",rotation:{x:0,y:180,z:0}},{type:"stairs",position:{x:10,y:3,z:6},color:"#808080",rotation:{x:0,y:180,z:0}},{type:"railing",position:{x:11,y:1,z:8},color:"#C0C0C0"},{type:"railing",position:{x:11,y:2,z:7},color:"#C0C0C0"},{type:"railing",position:{x:11,y:3,z:6},color:"#C0C0C0"},...L(0,4,0,6,6,"#D8D8D8"),...L(12,4,0,6,6,"#D8D8D8"),...L(0,4,8,18,6,"#D8D8D8"),...J(6,4,0,6,"Z","railing","#C0C0C0"),...J(11,4,0,6,"Z","railing","#C0C0C0"),...J(0,4,8,6,"X","railing","#C0C0C0"),...J(12,4,8,6,"X","railing","#C0C0C0"),...L(0,0,8,18,5,"#C0A080"),{type:"table",position:{x:2,y:1,z:10},color:"#FFFFFF"},{type:"chair",position:{x:1,y:1,z:10},color:"#FF6347"},{type:"chair",position:{x:3,y:1,z:10},color:"#FF6347"},{type:"table",position:{x:5,y:1,z:10},color:"#FFFFFF"},{type:"chair",position:{x:4,y:1,z:10},color:"#4169E1"},{type:"chair",position:{x:6,y:1,z:10},color:"#4169E1"},{type:"table",position:{x:12,y:1,z:10},color:"#FFFFFF"},{type:"chair",position:{x:11,y:1,z:10},color:"#32CD32"},{type:"chair",position:{x:13,y:1,z:10},color:"#32CD32"},{type:"table",position:{x:15,y:1,z:10},color:"#FFFFFF"},{type:"chair",position:{x:14,y:1,z:10},color:"#FFD700"},{type:"chair",position:{x:16,y:1,z:10},color:"#FFD700"},...J(1,1,12,6,"X","slab","#808080"),...J(11,1,12,6,"X","slab","#808080"),{type:"sign",position:{x:2,y:2,z:13},color:"#FF0000"},{type:"sign",position:{x:5,y:2,z:13},color:"#FFD700"},{type:"sign",position:{x:12,y:2,z:13},color:"#228B22"},{type:"sign",position:{x:15,y:2,z:13},color:"#FF69B4"},{type:"pillar",position:{x:8,y:1,z:1},color:"#404040"},{type:"monitor",position:{x:8,y:2,z:1},color:"#1E1E1E",emissive:{enabled:!0,color:"#4169E1",intensity:.5,radius:2}},{type:"column",position:{x:4,y:1,z:3},color:"#C0C0C0"},{type:"column",position:{x:4,y:2,z:3},color:"#C0C0C0"},{type:"column",position:{x:4,y:3,z:3},color:"#C0C0C0"},{type:"column",position:{x:13,y:1,z:3},color:"#C0C0C0"},{type:"column",position:{x:13,y:2,z:3},color:"#C0C0C0"},{type:"column",position:{x:13,y:3,z:3},color:"#C0C0C0"},{type:"column",position:{x:4,y:1,z:10},color:"#C0C0C0"},{type:"column",position:{x:4,y:2,z:10},color:"#C0C0C0"},{type:"column",position:{x:4,y:3,z:10},color:"#C0C0C0"},{type:"column",position:{x:13,y:1,z:10},color:"#C0C0C0"},{type:"column",position:{x:13,y:2,z:10},color:"#C0C0C0"},{type:"column",position:{x:13,y:3,z:10},color:"#C0C0C0"},...L(6,7,1,6,12,"#87CEEB"),...J(6,7,0,6,"X","iBeam","#404040"),...J(6,7,13,6,"X","iBeam","#404040"),...J(6,7,0,14,"Z","iBeam","#404040"),...J(11,7,0,14,"Z","iBeam","#404040"),...L(0,7,0,6,14,"#A0A0A0"),...L(12,7,0,6,14,"#A0A0A0"),{type:"planter",position:{x:3,y:0,z:3},color:"#8B4513"},{type:"bush",position:{x:3,y:1,z:3},color:"#228B22"},{type:"planter",position:{x:14,y:0,z:3},color:"#8B4513"},{type:"bush",position:{x:14,y:1,z:3},color:"#228B22"},{type:"bench",position:{x:5,y:0,z:5},color:"#A0522D"},{type:"bench",position:{x:12,y:0,z:5},color:"#A0522D"},{type:"bin",position:{x:6,y:0,z:1},color:"#2F2F2F"},{type:"bin",position:{x:11,y:0,z:1},color:"#2F2F2F"},{type:"bin",position:{x:8,y:0,z:9},color:"#2F2F2F"},{type:"pillar4",position:{x:4,y:4,z:3},color:"#C0C0C0"},{type:"pillar4",position:{x:4,y:5,z:3},color:"#C0C0C0"},{type:"lightFixture",position:{x:4,y:6,z:3},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:13,y:4,z:3},color:"#C0C0C0"},{type:"pillar4",position:{x:13,y:5,z:3},color:"#C0C0C0"},{type:"lightFixture",position:{x:13,y:6,z:3},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:4,y:4,z:10},color:"#C0C0C0"},{type:"pillar4",position:{x:4,y:5,z:10},color:"#C0C0C0"},{type:"lightFixture",position:{x:4,y:6,z:10},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:13,y:4,z:10},color:"#C0C0C0"},{type:"pillar4",position:{x:13,y:5,z:10},color:"#C0C0C0"},{type:"lightFixture",position:{x:13,y:6,z:10},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}}]},trainStation:{name:"Train Station",category:"city",description:"Grand railway station with platforms, canopy, clock tower, ticket hall, and period details",blocks:[...L(0,-1,3,18,4,"#4A4A4A"),...J(0,0,3,18,"X","beamX","#505050"),...J(0,0,4,18,"X","beamX","#505050"),...J(0,0,5,18,"X","beamX","#505050"),...J(0,0,6,18,"X","beamX","#505050"),{type:"beam2Z",position:{x:1,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:3,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:5,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:7,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:9,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:11,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:13,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:15,y:0,z:3},color:"#654321"},{type:"beam2Z",position:{x:1,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:3,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:5,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:7,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:9,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:11,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:13,y:0,z:5},color:"#654321"},{type:"beam2Z",position:{x:15,y:0,z:5},color:"#654321"},...L(0,0,0,18,3,"#A0A0A0"),...J(0,0,2,18,"X","ledge","#FFD700"),{type:"grate",position:{x:8,y:0,z:1},color:"#606060"},{type:"grate",position:{x:9,y:0,z:1},color:"#606060"},...L(0,0,7,18,3,"#A0A0A0"),...J(0,0,7,18,"X","ledge","#FFD700"),{type:"column",position:{x:2,y:0,z:1},color:"#2F4F4F"},{type:"column",position:{x:2,y:1,z:1},color:"#2F4F4F"},{type:"column",position:{x:2,y:2,z:1},color:"#2F4F4F"},{type:"capital",position:{x:2,y:3,z:1},color:"#3A5A5A"},{type:"column",position:{x:7,y:0,z:1},color:"#2F4F4F"},{type:"column",position:{x:7,y:1,z:1},color:"#2F4F4F"},{type:"column",position:{x:7,y:2,z:1},color:"#2F4F4F"},{type:"capital",position:{x:7,y:3,z:1},color:"#3A5A5A"},{type:"column",position:{x:12,y:0,z:1},color:"#2F4F4F"},{type:"column",position:{x:12,y:1,z:1},color:"#2F4F4F"},{type:"column",position:{x:12,y:2,z:1},color:"#2F4F4F"},{type:"capital",position:{x:12,y:3,z:1},color:"#3A5A5A"},{type:"column",position:{x:2,y:0,z:8},color:"#2F4F4F"},{type:"column",position:{x:2,y:1,z:8},color:"#2F4F4F"},{type:"column",position:{x:2,y:2,z:8},color:"#2F4F4F"},{type:"capital",position:{x:2,y:3,z:8},color:"#3A5A5A"},{type:"column",position:{x:7,y:0,z:8},color:"#2F4F4F"},{type:"column",position:{x:7,y:1,z:8},color:"#2F4F4F"},{type:"column",position:{x:7,y:2,z:8},color:"#2F4F4F"},{type:"capital",position:{x:7,y:3,z:8},color:"#3A5A5A"},{type:"column",position:{x:12,y:0,z:8},color:"#2F4F4F"},{type:"column",position:{x:12,y:1,z:8},color:"#2F4F4F"},{type:"column",position:{x:12,y:2,z:8},color:"#2F4F4F"},{type:"capital",position:{x:12,y:3,z:8},color:"#3A5A5A"},...L(1,4,0,16,10,"#2F4F4F"),{type:"archWide",position:{x:2,y:4,z:4},color:"#3A5A5A",rotation:{x:0,y:90,z:0}},{type:"archWide",position:{x:7,y:4,z:4},color:"#3A5A5A",rotation:{x:0,y:90,z:0}},{type:"archWide",position:{x:12,y:4,z:4},color:"#3A5A5A",rotation:{x:0,y:90,z:0}},{type:"truss",position:{x:3,y:3,z:4},color:"#2F4F4F"},{type:"truss",position:{x:8,y:3,z:4},color:"#2F4F4F"},{type:"truss",position:{x:13,y:3,z:4},color:"#2F4F4F"},...L(0,0,10,8,5,"#606060"),...yt(0,1,10,8,5,"#DEB887"),...yt(0,2,10,8,5,"#DEB887"),...yt(0,3,10,8,5,"#C9B896"),...L(0,4,10,8,5,"#8B4513"),{type:"wedge",position:{x:2,y:4,z:11},color:"#704214"},{type:"wedge",position:{x:3,y:4,z:11},color:"#704214"},{type:"wedge",position:{x:4,y:4,z:11},color:"#704214"},{type:"wedge",position:{x:5,y:4,z:11},color:"#704214"},{type:"wedge",position:{x:2,y:4,z:13},color:"#704214",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:3,y:4,z:13},color:"#704214",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:4,y:4,z:13},color:"#704214",rotation:{x:0,y:180,z:0}},{type:"wedge",position:{x:5,y:4,z:13},color:"#704214",rotation:{x:0,y:180,z:0}},{type:"doorFrame",position:{x:3,y:1,z:10},color:"#654321"},{type:"doorFrame",position:{x:4,y:1,z:10},color:"#654321"},{type:"arch",position:{x:3,y:2,z:10},color:"#DEB887"},{type:"arch",position:{x:4,y:2,z:10},color:"#DEB887"},{type:"windowFrame",position:{x:1,y:2,z:10},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:2,z:10},color:"#4682B4"},{type:"windowFrame",position:{x:1,y:3,z:10},color:"#4682B4"},{type:"windowFrame",position:{x:6,y:3,z:10},color:"#4682B4"},{type:"cube",position:{x:3,y:4,z:12},color:"#8B4513"},{type:"cube",position:{x:4,y:4,z:12},color:"#8B4513"},{type:"cube",position:{x:3,y:5,z:12},color:"#704214"},{type:"cube",position:{x:4,y:5,z:12},color:"#704214"},{type:"windowFrame",position:{x:3,y:5,z:11},color:"#F5F5DC"},{type:"windowFrame",position:{x:4,y:5,z:11},color:"#F5F5DC"},{type:"pyramid",position:{x:3,y:6,z:12},color:"#2F4F4F"},{type:"finial",position:{x:3,y:7,z:12},color:"#FFD700"},{type:"bench",position:{x:4,y:0,z:0},color:"#8B4513"},{type:"bench",position:{x:9,y:0,z:0},color:"#8B4513"},{type:"bench",position:{x:14,y:0,z:0},color:"#8B4513"},{type:"bench",position:{x:4,y:0,z:9},color:"#8B4513"},{type:"bench",position:{x:9,y:0,z:9},color:"#8B4513"},{type:"bench",position:{x:14,y:0,z:9},color:"#8B4513"},{type:"pillar",position:{x:5,y:0,z:1},color:"#2F4F4F"},{type:"pillar",position:{x:5,y:1,z:1},color:"#2F4F4F"},{type:"lightFixture",position:{x:5,y:2,z:1},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:3}},{type:"pillar",position:{x:10,y:0,z:1},color:"#2F4F4F"},{type:"pillar",position:{x:10,y:1,z:1},color:"#2F4F4F"},{type:"lightFixture",position:{x:10,y:2,z:1},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:3}},{type:"pillar",position:{x:5,y:0,z:8},color:"#2F4F4F"},{type:"pillar",position:{x:5,y:1,z:8},color:"#2F4F4F"},{type:"lightFixture",position:{x:5,y:2,z:8},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:3}},{type:"pillar",position:{x:10,y:0,z:8},color:"#2F4F4F"},{type:"pillar",position:{x:10,y:1,z:8},color:"#2F4F4F"},{type:"lightFixture",position:{x:10,y:2,z:8},color:"#FFD700",emissive:{enabled:!0,color:"#FFFACD",intensity:1,radius:3}},{type:"locker",position:{x:1,y:0,z:0},color:"#2F4F4F"},{type:"locker",position:{x:16,y:0,z:9},color:"#2F4F4F"},{type:"bin",position:{x:6,y:0,z:0},color:"#404040"},{type:"bin",position:{x:11,y:0,z:9},color:"#404040"},{type:"sign",position:{x:3,y:2,z:1},color:"#000080"},{type:"sign",position:{x:3,y:2,z:8},color:"#000080"},{type:"pillar",position:{x:17,y:0,z:4},color:"#404040"},{type:"pillar",position:{x:17,y:1,z:4},color:"#404040"},{type:"pillar",position:{x:17,y:2,z:4},color:"#404040"},{type:"bulb",position:{x:17,y:3,z:4},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:1.5,radius:2}},{type:"crate",position:{x:15,y:0,z:1},color:"#8B4513"},{type:"crate",position:{x:15,y:1,z:1},color:"#A0522D"},{type:"stairs",position:{x:3,y:0,z:9},color:"#808080",rotation:{x:0,y:180,z:0}},{type:"stairs",position:{x:4,y:0,z:9},color:"#808080",rotation:{x:0,y:180,z:0}}]},solarArrayLarge:{name:"Large Solar Array",category:"energy",description:"Industrial solar panel installation",blocks:[...L(0,0,0,12,10,"#808080"),{type:"solarPanel",position:{x:0,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:1,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:2,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:3,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:4,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:5,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:6,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:7,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:8,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:9,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:10,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:11,y:0,z:0},color:"#1a237e"},{type:"solarPanel",position:{x:0,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:1,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:2,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:3,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:4,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:5,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:6,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:7,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:8,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:9,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:10,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:11,y:0,z:2},color:"#283593"},{type:"solarPanel",position:{x:0,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:1,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:2,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:3,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:4,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:5,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:6,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:7,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:8,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:9,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:10,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:11,y:0,z:4},color:"#1a237e"},{type:"solarPanel",position:{x:0,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:1,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:2,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:3,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:4,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:5,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:6,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:7,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:8,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:9,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:10,y:0,z:6},color:"#283593"},{type:"solarPanel",position:{x:11,y:0,z:6},color:"#283593"},{type:"cube",position:{x:0,y:0,z:8},color:"#606060"},{type:"cube",position:{x:1,y:0,z:8},color:"#606060"},{type:"cube",position:{x:0,y:1,z:8},color:"#505050"},{type:"cube",position:{x:1,y:1,z:8},color:"#505050"},{type:"vent",position:{x:0,y:2,z:8},color:"#404040"},{type:"vent",position:{x:1,y:2,z:8},color:"#404040"},...J(0,0,9,12,"X","fence","#808080")]},windTurbine:{name:"Wind Turbine",category:"energy",description:"Modern wind turbine with detailed nacelle, blades, and electrical infrastructure",blocks:[...L(-1,0,-1,5,5,"#808080"),{type:"cylinder",position:{x:0,y:0,z:0},color:"#606060"},{type:"cylinder",position:{x:2,y:0,z:0},color:"#606060"},{type:"cylinder",position:{x:0,y:0,z:2},color:"#606060"},{type:"cylinder",position:{x:2,y:0,z:2},color:"#606060"},{type:"cylinder",position:{x:1,y:1,z:1},color:"#E8E8E8"},{type:"cylinder",position:{x:1,y:2,z:1},color:"#E8E8E8"},{type:"cylinder",position:{x:1,y:3,z:1},color:"#E8E8E8"},{type:"cylinder",position:{x:1,y:4,z:1},color:"#F0F0F0"},{type:"cylinder",position:{x:1,y:5,z:1},color:"#F0F0F0"},{type:"cylinder",position:{x:1,y:6,z:1},color:"#F0F0F0"},{type:"cylinder",position:{x:1,y:7,z:1},color:"#F0F0F0"},{type:"cylinder",position:{x:1,y:8,z:1},color:"#F5F5F5"},{type:"cylinder",position:{x:1,y:9,z:1},color:"#F5F5F5"},{type:"cylinder",position:{x:1,y:10,z:1},color:"#F5F5F5"},{type:"cylinder",position:{x:1,y:11,z:1},color:"#F5F5F5"},{type:"cube",position:{x:1,y:12,z:1},color:"#E0E0E0"},{type:"cube",position:{x:1,y:12,z:0},color:"#E0E0E0"},{type:"slab",position:{x:1,y:12,z:-1},color:"#D0D0D0"},{type:"dome",position:{x:1,y:13,z:0},color:"#E8E8E8"},{type:"sphere",position:{x:1,y:12,z:-2},color:"#D0D0D0"},{type:"wedgeFlat",position:{x:0,y:13,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:-1,y:14,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:-2,y:15,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:-3,y:16,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:2,y:13,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:3,y:14,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:4,y:15,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:5,y:16,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:1,y:11,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:1,y:10,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:1,y:9,z:-2},color:"#FFFFFF"},{type:"wedgeFlat",position:{x:1,y:8,z:-2},color:"#FFFFFF"},{type:"sphere",position:{x:1,y:13,z:1},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:3,radius:8}},{type:"sphere",position:{x:1,y:6,z:0},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:1,radius:3}},{type:"doorFrame",position:{x:1,y:1,z:-1},color:"#606060"},{type:"transformer",position:{x:3,y:0,z:1},color:"#556B2F"},{type:"conduitX",position:{x:2,y:0,z:1},color:"#505050"},{type:"conduitX",position:{x:3,y:0,z:1},color:"#505050"},{type:"powerBox",position:{x:3,y:0,z:2},color:"#404040"},{type:"ladder",position:{x:0,y:1,z:1},color:"#FFD700"},{type:"ladder",position:{x:0,y:2,z:1},color:"#FFD700"},{type:"pillar4",position:{x:-1,y:0,z:-1},color:"#CD7F32"},{type:"antenna",position:{x:1,y:13,z:2},color:"#808080"},{type:"slab",position:{x:1,y:0,z:3},color:"#A0A0A0"},{type:"slab",position:{x:1,y:0,z:4},color:"#909090"},{type:"post",position:{x:-1,y:0,z:3},color:"#FFFF00"},{type:"post",position:{x:3,y:0,z:3},color:"#FFFF00"}]},substationYard:{name:"Electrical Substation",category:"energy",description:"High-voltage power substation with transformers, insulators, bus bars, and control building",blocks:[...L(0,0,0,14,10,"#A0A0A0"),{type:"tank",position:{x:2,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:2,y:1,z:2},color:"#556B2F"},{type:"tank",position:{x:3,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:3,y:1,z:2},color:"#556B2F"},{type:"vent",position:{x:2,y:2,z:2},color:"#708090"},{type:"vent",position:{x:3,y:2,z:2},color:"#708090"},{type:"panel",position:{x:1,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:1,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:4,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:4,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"pillar2",position:{x:2,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:2,y:3,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:3,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:3,y:3,z:2},color:"#E8DCC8"},{type:"tank",position:{x:6,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:6,y:1,z:2},color:"#556B2F"},{type:"tank",position:{x:7,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:7,y:1,z:2},color:"#556B2F"},{type:"vent",position:{x:6,y:2,z:2},color:"#708090"},{type:"vent",position:{x:7,y:2,z:2},color:"#708090"},{type:"panel",position:{x:5,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:5,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:8,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:8,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"pillar2",position:{x:6,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:6,y:3,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:7,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:7,y:3,z:2},color:"#E8DCC8"},{type:"tank",position:{x:10,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:10,y:1,z:2},color:"#556B2F"},{type:"tank",position:{x:11,y:0,z:2},color:"#556B2F"},{type:"tank",position:{x:11,y:1,z:2},color:"#556B2F"},{type:"vent",position:{x:10,y:2,z:2},color:"#708090"},{type:"vent",position:{x:11,y:2,z:2},color:"#708090"},{type:"panel",position:{x:9,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:9,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:12,y:0,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"panel",position:{x:12,y:1,z:2},color:"#4A5A4A",rotation:{x:0,y:90,z:0}},{type:"pillar2",position:{x:10,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:10,y:3,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:11,y:2,z:2},color:"#E8DCC8"},{type:"pillar2",position:{x:11,y:3,z:2},color:"#E8DCC8"},{type:"iBeam",position:{x:2,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:2,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:2,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:2,y:3,z:5},color:"#708090"},{type:"iBeam",position:{x:6,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:6,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:6,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:6,y:3,z:5},color:"#708090"},{type:"iBeam",position:{x:10,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:10,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:10,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:10,y:3,z:5},color:"#708090"},{type:"beamX",position:{x:1,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:2,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:3,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:5,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:6,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:7,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:9,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:10,y:4,z:5},color:"#708090"},{type:"beamX",position:{x:11,y:4,z:5},color:"#708090"},{type:"pillar2",position:{x:2,y:4,z:5},color:"#E8DCC8"},{type:"pillar2",position:{x:6,y:4,z:5},color:"#E8DCC8"},{type:"pillar2",position:{x:10,y:4,z:5},color:"#E8DCC8"},...J(2,5,5,10,"X","pipeX","#C0C0C0"),{type:"transformer",position:{x:2,y:0,z:4},color:"#4682B4"},{type:"transformer",position:{x:6,y:0,z:4},color:"#4682B4"},{type:"transformer",position:{x:10,y:0,z:4},color:"#4682B4"},{type:"switchBox",position:{x:3,y:0,z:4},color:"#FF4500"},{type:"switchBox",position:{x:7,y:0,z:4},color:"#FF4500"},{type:"switchBox",position:{x:11,y:0,z:4},color:"#FF4500"},{type:"pillar",position:{x:1,y:0,z:3},color:"#4682B4"},{type:"pillar",position:{x:1,y:1,z:3},color:"#E8DCC8"},{type:"pillar",position:{x:5,y:0,z:3},color:"#4682B4"},{type:"pillar",position:{x:5,y:1,z:3},color:"#E8DCC8"},{type:"pillar",position:{x:9,y:0,z:3},color:"#4682B4"},{type:"pillar",position:{x:9,y:1,z:3},color:"#E8DCC8"},...L(0,0,7,5,3,"#606060"),...yt(0,1,7,5,3,"#D3D3D3"),...yt(0,2,5,5,3,"#D3D3D3"),...L(0,3,7,5,3,"#505050"),{type:"doorFrame",position:{x:2,y:1,z:7},color:"#404040"},{type:"windowFrame",position:{x:0,y:2,z:7},color:"#4682B4"},{type:"windowFrame",position:{x:4,y:2,z:7},color:"#4682B4"},{type:"acUnit",position:{x:4,y:1,z:9},color:"#C0C0C0"},{type:"fuseBox",position:{x:1,y:1,z:8},color:"#404040"},{type:"fuseBox",position:{x:3,y:1,z:8},color:"#404040"},{type:"iBeam",position:{x:0,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:3,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:4,z:5},color:"#708090"},{type:"iBeam",position:{x:0,y:5,z:5},color:"#708090"},{type:"crossBeam",position:{x:0,y:6,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:0,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:1,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:2,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:3,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:4,z:5},color:"#708090"},{type:"iBeam",position:{x:13,y:5,z:5},color:"#708090"},{type:"crossBeam",position:{x:13,y:6,z:5},color:"#708090"},{type:"channel",position:{x:2,y:0,z:3},color:"#505050"},{type:"channel",position:{x:3,y:0,z:3},color:"#505050"},{type:"channel",position:{x:6,y:0,z:3},color:"#505050"},{type:"channel",position:{x:7,y:0,z:3},color:"#505050"},{type:"channel",position:{x:10,y:0,z:3},color:"#505050"},{type:"channel",position:{x:11,y:0,z:3},color:"#505050"},...J(0,0,0,14,"X","fence","#808080"),...J(0,1,0,14,"X","railing","#404040"),...J(0,0,9,14,"X","fence","#808080"),...J(0,1,9,14,"X","railing","#404040"),{type:"fenceZ",position:{x:0,y:0,z:1},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:2},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:3},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:4},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:5},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:6},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:7},color:"#808080"},{type:"fenceZ",position:{x:0,y:0,z:8},color:"#808080"},{type:"railingZ",position:{x:0,y:1,z:1},color:"#404040"},{type:"railingZ",position:{x:0,y:1,z:3},color:"#404040"},{type:"railingZ",position:{x:0,y:1,z:5},color:"#404040"},{type:"railingZ",position:{x:0,y:1,z:7},color:"#404040"},{type:"fenceZ",position:{x:13,y:0,z:1},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:2},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:3},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:4},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:5},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:6},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:7},color:"#808080"},{type:"fenceZ",position:{x:13,y:0,z:8},color:"#808080"},{type:"railingZ",position:{x:13,y:1,z:2},color:"#404040"},{type:"railingZ",position:{x:13,y:1,z:4},color:"#404040"},{type:"railingZ",position:{x:13,y:1,z:6},color:"#404040"},{type:"railingZ",position:{x:13,y:1,z:8},color:"#404040"},{type:"sign",position:{x:6,y:1,z:0},color:"#FFD700"},{type:"sign",position:{x:7,y:1,z:0},color:"#FFD700"},{type:"barrier",position:{x:4,y:0,z:1},color:"#FF0000"},{type:"barrier",position:{x:8,y:0,z:1},color:"#FF0000"},{type:"post",position:{x:1,y:0,z:1},color:"#B87333"},{type:"post",position:{x:12,y:0,z:1},color:"#B87333"},{type:"post",position:{x:1,y:0,z:6},color:"#B87333"},{type:"post",position:{x:12,y:0,z:6},color:"#B87333"},{type:"pillar",position:{x:4,y:0,z:6},color:"#505050"},{type:"pillar",position:{x:4,y:1,z:6},color:"#505050"},{type:"pillar",position:{x:4,y:2,z:6},color:"#505050"},{type:"spotlight",position:{x:4,y:3,z:6},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:5}},{type:"pillar",position:{x:9,y:0,z:6},color:"#505050"},{type:"pillar",position:{x:9,y:1,z:6},color:"#505050"},{type:"pillar",position:{x:9,y:2,z:6},color:"#505050"},{type:"spotlight",position:{x:9,y:3,z:6},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:5}}]},coolingTowers:{name:"Cooling Towers",category:"energy",description:"Industrial cooling tower complex with basins, pump house, and control building",blocks:[...L(0,0,0,16,16,"#505050"),...L(1,-1,1,5,5,"#2F4F4F"),...L(10,-1,1,5,5,"#2F4F4F"),...L(1,-1,10,5,5,"#2F4F4F"),...L(10,-1,10,5,5,"#2F4F4F"),{type:"cylinder",position:{x:3,y:0,z:3},color:"#C0C0C0"},{type:"cylinder",position:{x:3,y:1,z:3},color:"#C0C0C0"},{type:"cylinder",position:{x:3,y:2,z:3},color:"#B8B8B8"},{type:"cylinder",position:{x:3,y:3,z:3},color:"#B0B0B0"},{type:"cylinder",position:{x:3,y:4,z:3},color:"#A8A8A8"},{type:"cylinder",position:{x:3,y:5,z:3},color:"#A0A0A0"},{type:"cylinder",position:{x:3,y:6,z:3},color:"#989898"},{type:"tube",position:{x:3,y:7,z:3},color:"#909090"},{type:"dome",position:{x:3,y:8,z:3},color:"#E0E0E0",emissive:{enabled:!0,color:"#FFFFFF",intensity:.3,radius:2}},{type:"cylinder",position:{x:12,y:0,z:3},color:"#C0C0C0"},{type:"cylinder",position:{x:12,y:1,z:3},color:"#C0C0C0"},{type:"cylinder",position:{x:12,y:2,z:3},color:"#B8B8B8"},{type:"cylinder",position:{x:12,y:3,z:3},color:"#B0B0B0"},{type:"cylinder",position:{x:12,y:4,z:3},color:"#A8A8A8"},{type:"cylinder",position:{x:12,y:5,z:3},color:"#A0A0A0"},{type:"cylinder",position:{x:12,y:6,z:3},color:"#989898"},{type:"tube",position:{x:12,y:7,z:3},color:"#909090"},{type:"dome",position:{x:12,y:8,z:3},color:"#E0E0E0",emissive:{enabled:!0,color:"#FFFFFF",intensity:.3,radius:2}},{type:"cylinder",position:{x:3,y:0,z:12},color:"#C0C0C0"},{type:"cylinder",position:{x:3,y:1,z:12},color:"#C0C0C0"},{type:"cylinder",position:{x:3,y:2,z:12},color:"#B8B8B8"},{type:"cylinder",position:{x:3,y:3,z:12},color:"#B0B0B0"},{type:"cylinder",position:{x:3,y:4,z:12},color:"#A8A8A8"},{type:"cylinder",position:{x:3,y:5,z:12},color:"#A0A0A0"},{type:"cylinder",position:{x:3,y:6,z:12},color:"#989898"},{type:"tube",position:{x:3,y:7,z:12},color:"#909090"},{type:"dome",position:{x:3,y:8,z:12},color:"#E0E0E0",emissive:{enabled:!0,color:"#FFFFFF",intensity:.3,radius:2}},{type:"cylinder",position:{x:12,y:0,z:12},color:"#C0C0C0"},{type:"cylinder",position:{x:12,y:1,z:12},color:"#C0C0C0"},{type:"cylinder",position:{x:12,y:2,z:12},color:"#B8B8B8"},{type:"cylinder",position:{x:12,y:3,z:12},color:"#B0B0B0"},{type:"cylinder",position:{x:12,y:4,z:12},color:"#A8A8A8"},{type:"cylinder",position:{x:12,y:5,z:12},color:"#A0A0A0"},{type:"cylinder",position:{x:12,y:6,z:12},color:"#989898"},{type:"tube",position:{x:12,y:7,z:12},color:"#909090"},{type:"dome",position:{x:12,y:8,z:12},color:"#E0E0E0",emissive:{enabled:!0,color:"#FFFFFF",intensity:.3,radius:2}},{type:"pillar2",position:{x:5,y:0,z:3},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:0,z:3},color:"#4A4A4A"},{type:"pillar2",position:{x:10,y:0,z:3},color:"#4A4A4A"},{type:"pillar2",position:{x:5,y:0,z:12},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:0,z:12},color:"#4A4A4A"},{type:"pillar2",position:{x:10,y:0,z:12},color:"#4A4A4A"},{type:"pillar2",position:{x:7,y:0,z:7},color:"#4A4A4A"},{type:"pillar2",position:{x:8,y:0,z:8},color:"#4A4A4A"},...J(4,1,3,8,"X","pipeX","#708090"),...J(4,1,12,8,"X","pipeX","#708090"),...J(7,1,4,8,"Z","pipeZ","#708090"),...J(8,1,4,8,"Z","pipeZ","#708090"),{type:"pipeCross",position:{x:7,y:1,z:3},color:"#708090"},{type:"pipeCross",position:{x:8,y:1,z:3},color:"#708090"},{type:"pipeCross",position:{x:7,y:1,z:12},color:"#708090"},{type:"pipeCross",position:{x:8,y:1,z:12},color:"#708090"},{type:"valve",position:{x:5,y:1,z:3},color:"#B22222"},{type:"valve",position:{x:10,y:1,z:3},color:"#B22222"},{type:"valve",position:{x:5,y:1,z:12},color:"#B22222"},{type:"valve",position:{x:10,y:1,z:12},color:"#B22222"},{type:"valve",position:{x:7,y:1,z:7},color:"#FFD700"},{type:"valve",position:{x:8,y:1,z:8},color:"#FFD700"},...L(14,0,6,3,4,"#606060"),...st(14,1,6,4,2,"#708090"),...st(16,1,6,4,2,"#708090"),...at(14,1,6,3,2,"#708090"),...at(14,1,9,3,2,"#708090"),...L(14,3,6,3,4,"#606060"),{type:"tank",position:{x:15,y:1,z:7},color:"#4682B4"},{type:"tank",position:{x:15,y:2,z:7},color:"#4682B4"},{type:"tank",position:{x:15,y:1,z:8},color:"#4682B4"},{type:"tank",position:{x:15,y:2,z:8},color:"#4682B4"},...J(12,1,7,3,"X","pipeX","#708090"),{type:"pipeElbowXZ",position:{x:12,y:1,z:7},color:"#708090"},...L(-3,0,6,4,5,"#505050"),...st(-3,1,6,5,3,"#808080"),...st(0,1,6,5,3,"#808080"),...at(-3,1,6,4,3,"#808080"),...at(-3,1,10,4,3,"#808080"),...L(-3,4,6,4,5,"#606060"),{type:"doorFrame",position:{x:-1,y:1,z:6},color:"#4682B4"},{type:"doorFrame",position:{x:-1,y:2,z:6},color:"#4682B4"},{type:"windowFrame",position:{x:-2,y:2,z:6},color:"#87CEEB"},{type:"windowFrame",position:{x:-3,y:2,z:8},color:"#87CEEB"},{type:"desk",position:{x:-2,y:1,z:8},color:"#8B4513"},{type:"monitor",position:{x:-2,y:2,z:8},color:"#1E1E1E",emissive:{enabled:!0,color:"#00FF00",intensity:.5,radius:2}},{type:"switchBox",position:{x:-1,y:2,z:10},color:"#808080"},{type:"acUnit",position:{x:-2,y:4,z:8},color:"#C0C0C0"},{type:"post",position:{x:1,y:0,z:0},color:"#505050"},{type:"post",position:{x:1,y:1,z:0},color:"#505050"},{type:"post",position:{x:4,y:0,z:0},color:"#505050"},{type:"post",position:{x:4,y:1,z:0},color:"#505050"},{type:"post",position:{x:6,y:0,z:0},color:"#505050"},{type:"post",position:{x:6,y:1,z:0},color:"#505050"},{type:"post",position:{x:9,y:0,z:0},color:"#505050"},{type:"post",position:{x:9,y:1,z:0},color:"#505050"},{type:"post",position:{x:12,y:0,z:0},color:"#505050"},{type:"post",position:{x:12,y:1,z:0},color:"#505050"},{type:"post",position:{x:14,y:0,z:0},color:"#505050"},{type:"post",position:{x:14,y:1,z:0},color:"#505050"},{type:"post",position:{x:0,y:0,z:1},color:"#505050"},{type:"post",position:{x:0,y:1,z:1},color:"#505050"},{type:"post",position:{x:0,y:0,z:3},color:"#505050"},{type:"post",position:{x:0,y:1,z:3},color:"#505050"},{type:"post",position:{x:0,y:0,z:5},color:"#505050"},{type:"post",position:{x:0,y:1,z:5},color:"#505050"},{type:"post",position:{x:15,y:0,z:1},color:"#505050"},{type:"post",position:{x:15,y:1,z:1},color:"#505050"},{type:"post",position:{x:15,y:0,z:3},color:"#505050"},{type:"post",position:{x:15,y:1,z:3},color:"#505050"},{type:"post",position:{x:15,y:0,z:5},color:"#505050"},{type:"post",position:{x:15,y:1,z:5},color:"#505050"},...J(1,2,0,6,"X","catwalk","#404040"),...J(9,2,0,6,"X","catwalk","#404040"),...J(0,2,1,5,"Z","catwalk","#404040"),...J(15,2,1,5,"Z","catwalk","#404040"),...J(1,2,0,6,"X","railing","#606060"),...J(9,2,0,6,"X","railing","#606060"),{type:"ladder",position:{x:2,y:0,z:3},color:"#FFD700"},{type:"ladder",position:{x:2,y:1,z:3},color:"#FFD700"},{type:"ladder",position:{x:2,y:2,z:3},color:"#FFD700"},{type:"ladder",position:{x:2,y:3,z:3},color:"#FFD700"},{type:"transformer",position:{x:0,y:0,z:0},color:"#505050"},{type:"powerBox",position:{x:0,y:1,z:0},color:"#404040"},...J(1,0,0,7,"X","conduitX","#404040"),{type:"conduitElbow",position:{x:7,y:0,z:0},color:"#404040"},...J(7,0,1,5,"Z","conduitZ","#404040"),...J(-4,0,5,1,"Z","fence","#808080"),...J(-4,0,11,5,"Z","fence","#808080"),...J(-4,0,16,21,"X","fence","#808080"),...J(16,0,0,16,"Z","fence","#808080"),...J(0,0,-1,16,"X","fence","#808080"),{type:"barrier",position:{x:7,y:0,z:-1},color:"#FF0000"},{type:"barrier",position:{x:8,y:0,z:-1},color:"#FF0000"},{type:"sign",position:{x:7,y:1,z:-1},color:"#FFD700"},{type:"sign",position:{x:15,y:1,z:6},color:"#FFD700"},{type:"sphere",position:{x:3,y:9,z:3},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"sphere",position:{x:12,y:9,z:3},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"sphere",position:{x:3,y:9,z:12},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"sphere",position:{x:12,y:9,z:12},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"post",position:{x:7,y:0,z:7},color:"#404040"},{type:"post",position:{x:7,y:1,z:7},color:"#404040"},{type:"post",position:{x:7,y:2,z:7},color:"#404040"},{type:"lightFixture",position:{x:7,y:3,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}}]},powerPlant:{name:"Power Plant",category:"industrial",description:"Complete power generation facility with boiler house, turbine hall, control room, and transformer yard",blocks:[...L(0,0,0,20,16,"#505050"),...L(0,0,4,8,8,"#404040"),...at(0,1,4,8,6,"#606060"),...at(0,1,11,8,6,"#606060"),...st(0,1,5,6,6,"#606060"),...st(7,1,5,6,6,"#606060"),...L(0,7,4,8,8,"#505050"),{type:"tank",position:{x:2,y:1,z:6},color:"#8B0000"},{type:"tank",position:{x:2,y:2,z:6},color:"#8B0000"},{type:"tank",position:{x:2,y:3,z:6},color:"#8B0000"},{type:"tank",position:{x:2,y:4,z:6},color:"#8B0000"},{type:"tank",position:{x:2,y:5,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:1,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:2,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:3,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:4,z:6},color:"#8B0000"},{type:"tank",position:{x:5,y:5,z:6},color:"#8B0000"},{type:"cylinder",position:{x:2,y:7,z:6},color:"#A0522D"},{type:"cylinder",position:{x:2,y:8,z:6},color:"#A0522D"},{type:"cylinder",position:{x:2,y:9,z:6},color:"#8B4513"},{type:"cylinder",position:{x:2,y:10,z:6},color:"#8B4513"},{type:"cylinder",position:{x:2,y:11,z:6},color:"#704214"},{type:"dome",position:{x:2,y:12,z:6},color:"#808080",emissive:{enabled:!0,color:"#AAAAAA",intensity:.4,radius:2}},{type:"cylinder",position:{x:5,y:7,z:6},color:"#A0522D"},{type:"cylinder",position:{x:5,y:8,z:6},color:"#A0522D"},{type:"cylinder",position:{x:5,y:9,z:6},color:"#8B4513"},{type:"cylinder",position:{x:5,y:10,z:6},color:"#8B4513"},{type:"cylinder",position:{x:5,y:11,z:6},color:"#704214"},{type:"dome",position:{x:5,y:12,z:6},color:"#808080",emissive:{enabled:!0,color:"#AAAAAA",intensity:.4,radius:2}},...J(3,3,6,2,"X","pipeX","#708090"),{type:"valve",position:{x:3,y:3,z:6},color:"#B22222"},{type:"valve",position:{x:4,y:3,z:6},color:"#B22222"},...J(2,4,7,4,"Z","pipeZ","#C0C0C0"),...J(5,4,7,4,"Z","pipeZ","#C0C0C0"),...L(8,0,4,8,8,"#454545"),...at(8,1,4,8,5,"#707070"),...at(8,1,11,8,5,"#707070"),...st(8,1,5,6,5,"#707070"),...st(15,1,5,6,5,"#707070"),...L(8,6,4,8,8,"#505050"),{type:"cylinder",position:{x:10,y:1,z:6},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:10,y:1,z:7},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:10,y:1,z:8},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:10,y:2,z:7},color:"#4169E1"},{type:"cylinder",position:{x:13,y:1,z:6},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:13,y:1,z:7},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:13,y:1,z:8},color:"#4682B4",rotation:{x:0,y:0,z:90}},{type:"cylinder",position:{x:13,y:2,z:7},color:"#4169E1"},{type:"cube",position:{x:11,y:1,z:7},color:"#2F4F4F"},{type:"cube",position:{x:11,y:2,z:7},color:"#2F4F4F"},{type:"cube",position:{x:14,y:1,z:7},color:"#2F4F4F"},{type:"cube",position:{x:14,y:2,z:7},color:"#2F4F4F"},{type:"iBeam",position:{x:9,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:10,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:11,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:12,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:13,y:5,z:5},color:"#FFD700"},{type:"iBeam",position:{x:14,y:5,z:5},color:"#FFD700"},...L(16,0,4,5,6,"#505050"),...st(16,1,4,6,3,"#708090"),...st(20,1,4,6,3,"#708090"),...at(16,1,4,5,3,"#708090"),...at(16,1,9,5,3,"#708090"),...L(16,4,4,5,6,"#505050"),{type:"doorFrame",position:{x:16,y:1,z:6},color:"#4682B4"},{type:"doorFrame",position:{x:16,y:2,z:6},color:"#4682B4"},{type:"windowFrame",position:{x:16,y:2,z:5},color:"#87CEEB"},{type:"windowFrame",position:{x:16,y:2,z:7},color:"#87CEEB"},{type:"windowFrame",position:{x:16,y:2,z:8},color:"#87CEEB"},{type:"switchBox",position:{x:18,y:1,z:5},color:"#2F4F4F"},{type:"monitor",position:{x:18,y:2,z:5},color:"#1E1E1E",emissive:{enabled:!0,color:"#00FF00",intensity:.5,radius:2}},{type:"switchBox",position:{x:19,y:1,z:5},color:"#2F4F4F"},{type:"monitor",position:{x:19,y:2,z:5},color:"#1E1E1E",emissive:{enabled:!0,color:"#00BFFF",intensity:.5,radius:2}},{type:"desk",position:{x:17,y:1,z:7},color:"#4A4A4A"},{type:"chair",position:{x:17,y:1,z:6},color:"#2F2F2F"},{type:"acUnit",position:{x:18,y:4,z:7},color:"#C0C0C0"},...L(0,0,12,8,4,"#3A3A3A"),{type:"cube",position:{x:1,y:0,z:13},color:"#1A1A1A"},{type:"cube",position:{x:2,y:0,z:13},color:"#1A1A1A"},{type:"cube",position:{x:3,y:0,z:13},color:"#1A1A1A"},{type:"cube",position:{x:2,y:0,z:14},color:"#1A1A1A"},{type:"wedge",position:{x:1,y:1,z:13},color:"#1A1A1A"},{type:"wedge",position:{x:2,y:1,z:13},color:"#1A1A1A"},{type:"conveyor",position:{x:4,y:1,z:13},color:"#505050"},{type:"conveyor",position:{x:5,y:1,z:13},color:"#505050"},{type:"conveyor",position:{x:6,y:2,z:13},color:"#505050"},{type:"conveyor",position:{x:6,y:2,z:12},color:"#505050"},{type:"hopper",position:{x:6,y:3,z:12},color:"#696969"},...L(16,0,10,6,6,"#606060"),{type:"transformer",position:{x:17,y:0,z:11},color:"#505050"},{type:"transformer",position:{x:17,y:1,z:11},color:"#505050"},{type:"transformer",position:{x:19,y:0,z:11},color:"#505050"},{type:"transformer",position:{x:19,y:1,z:11},color:"#505050"},{type:"pillar4",position:{x:17,y:2,z:11},color:"#8B4513"},{type:"pillar4",position:{x:19,y:2,z:11},color:"#8B4513"},{type:"iBeam",position:{x:17,y:3,z:11},color:"#C0C0C0"},{type:"iBeam",position:{x:18,y:3,z:11},color:"#C0C0C0"},{type:"iBeam",position:{x:19,y:3,z:11},color:"#C0C0C0"},{type:"switchBox",position:{x:17,y:0,z:13},color:"#808080"},{type:"switchBox",position:{x:19,y:0,z:13},color:"#808080"},{type:"cableX",position:{x:20,y:3,z:11},color:"#1E1E1E"},{type:"cableX",position:{x:21,y:3,z:11},color:"#1E1E1E"},{type:"sign",position:{x:16,y:1,z:10},color:"#FFD700"},...J(16,0,15,6,"X","fence","#808080"),...J(21,0,10,5,"Z","fence","#808080"),...L(8,-1,12,6,4,"#2F4F4F"),{type:"cube",position:{x:10,y:0,z:13},color:"#708090"},{type:"cube",position:{x:11,y:0,z:13},color:"#708090"},{type:"cube",position:{x:10,y:1,z:13},color:"#708090"},{type:"cube",position:{x:11,y:1,z:13},color:"#708090"},...J(8,1,14,4,"X","pipeX","#708090"),{type:"valve",position:{x:9,y:1,z:14},color:"#B22222"},...J(0,0,0,22,"X","fence","#808080"),...J(0,0,0,16,"Z","fence","#808080"),...J(0,0,16,16,"X","fence","#808080"),{type:"barrier",position:{x:10,y:0,z:0},color:"#FF0000"},{type:"barrier",position:{x:11,y:0,z:0},color:"#FF0000"},{type:"cube",position:{x:9,y:0,z:1},color:"#808080"},{type:"cube",position:{x:9,y:1,z:1},color:"#808080"},{type:"windowFrame",position:{x:9,y:1,z:1},color:"#87CEEB"},{type:"sphere",position:{x:2,y:13,z:6},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"sphere",position:{x:5,y:13,z:6},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:2,radius:3}},{type:"pillar4",position:{x:4,y:0,z:2},color:"#404040"},{type:"pillar4",position:{x:4,y:1,z:2},color:"#404040"},{type:"pillar4",position:{x:4,y:2,z:2},color:"#404040"},{type:"pillar4",position:{x:4,y:3,z:2},color:"#404040"},{type:"lightFixture",position:{x:4,y:4,z:2},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:12,y:0,z:2},color:"#404040"},{type:"pillar4",position:{x:12,y:1,z:2},color:"#404040"},{type:"pillar4",position:{x:12,y:2,z:2},color:"#404040"},{type:"pillar4",position:{x:12,y:3,z:2},color:"#404040"},{type:"lightFixture",position:{x:12,y:4,z:2},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}},{type:"pillar4",position:{x:18,y:0,z:12},color:"#404040"},{type:"pillar4",position:{x:18,y:1,z:12},color:"#404040"},{type:"pillar4",position:{x:18,y:2,z:12},color:"#404040"},{type:"pillar4",position:{x:18,y:3,z:12},color:"#404040"},{type:"lightFixture",position:{x:18,y:4,z:12},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:1,radius:5}}]},warehouseDistrict:{name:"Warehouse District",category:"industrial",description:"Multiple warehouses with loading docks",blocks:[...L(0,0,0,15,12,"#3A3A3A"),...L(0,0,0,5,4,"#708090"),...at(0,1,0,5,2,"#808080"),...at(0,1,3,5,2,"#808080"),...st(0,1,1,2,2,"#808080"),...st(4,1,1,2,2,"#808080"),...L(0,3,0,5,4,"#606060"),{type:"doorFrame",position:{x:2,y:1,z:0},color:"#FFD700"},...L(7,0,0,5,4,"#708090"),...at(7,1,0,5,2,"#909090"),...at(7,1,3,5,2,"#909090"),...st(7,1,1,2,2,"#909090"),...st(11,1,1,2,2,"#909090"),...L(7,3,0,5,4,"#707070"),{type:"doorFrame",position:{x:9,y:1,z:0},color:"#FFD700"},...L(0,0,6,7,5,"#708090"),...at(0,1,6,7,3,"#808080"),...at(0,1,10,7,3,"#808080"),...st(0,1,7,3,3,"#808080"),...st(6,1,7,3,3,"#808080"),...L(0,4,6,7,5,"#606060"),{type:"doorFrame",position:{x:2,y:1,z:6},color:"#FFD700"},{type:"doorFrame",position:{x:3,y:1,z:6},color:"#FFD700"},{type:"doorFrame",position:{x:4,y:1,z:6},color:"#FFD700"},{type:"slab",position:{x:2,y:0,z:5},color:"#505050"},{type:"slab",position:{x:3,y:0,z:5},color:"#505050"},{type:"slab",position:{x:4,y:0,z:5},color:"#505050"},{type:"crate",position:{x:9,y:0,z:6},color:"#8B4513"},{type:"crate",position:{x:10,y:0,z:6},color:"#A0522D"},{type:"crate",position:{x:9,y:1,z:6},color:"#CD853F"},{type:"barrel",position:{x:12,y:0,z:6},color:"#2F4F4F"},{type:"barrel",position:{x:13,y:0,z:6},color:"#006400"},{type:"pillar2",position:{x:5,y:0,z:4},color:"#2F2F2F"},{type:"pillar2",position:{x:5,y:1,z:4},color:"#2F2F2F"},{type:"pillar2",position:{x:5,y:2,z:4},color:"#2F2F2F"},{type:"sphere",position:{x:5,y:3,z:4},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFE0",intensity:2,radius:5}}]},gasStation:{name:"Gas Station",category:"modern",description:"Modern fuel station with pumps, convenience store, car wash, and detailed infrastructure",blocks:[...L(0,0,0,12,10,"#2F2F2F"),{type:"slab",position:{x:0,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:1,y:0,z:4},color:"#2F2F2F"},{type:"slab",position:{x:2,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:3,y:0,z:4},color:"#2F2F2F"},{type:"slab",position:{x:4,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:2,y:0,z:2},color:"#808080"},{type:"slab",position:{x:3,y:0,z:2},color:"#808080"},{type:"pillar2",position:{x:2,y:0,z:2},color:"#FF0000"},{type:"pillar2",position:{x:2,y:1,z:2},color:"#C0C0C0"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#FF0000"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#C0C0C0"},{type:"slab",position:{x:2,y:0,z:6},color:"#808080"},{type:"slab",position:{x:3,y:0,z:6},color:"#808080"},{type:"pillar2",position:{x:2,y:0,z:6},color:"#FF0000"},{type:"pillar2",position:{x:2,y:1,z:6},color:"#C0C0C0"},{type:"pillar2",position:{x:3,y:0,z:6},color:"#FF0000"},{type:"pillar2",position:{x:3,y:1,z:6},color:"#C0C0C0"},{type:"bollard",position:{x:1,y:0,z:2},color:"#FFFF00"},{type:"bollard",position:{x:4,y:0,z:2},color:"#FFFF00"},{type:"bollard",position:{x:1,y:0,z:6},color:"#FFFF00"},{type:"bollard",position:{x:4,y:0,z:6},color:"#FFFF00"},{type:"pillar",position:{x:0,y:0,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:1,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:2,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:0,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:1,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:2,z:1},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:0,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:1,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:0,y:2,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:0,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:1,z:7},color:"#E0E0E0"},{type:"pillar",position:{x:5,y:2,z:7},color:"#E0E0E0"},...L(0,3,0,6,9,"#F0F0F0"),{type:"slab",position:{x:0,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:1,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:2,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:3,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:4,y:3,z:4},color:"#FF0000"},{type:"slab",position:{x:5,y:3,z:4},color:"#FF0000"},{type:"lightFixture",position:{x:1,y:3,z:2},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:3,radius:5}},{type:"lightFixture",position:{x:4,y:3,z:2},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:3,radius:5}},{type:"lightFixture",position:{x:1,y:3,z:6},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:3,radius:5}},{type:"lightFixture",position:{x:4,y:3,z:6},color:"#FFFACD",emissive:{enabled:!0,color:"#FFFFFF",intensity:3,radius:5}},...L(7,0,1,5,7,"#505050"),...yt(7,1,1,5,7,"#DEB887"),...yt(7,2,1,5,7,"#DEB887"),...L(7,3,1,5,7,"#8B0000"),{type:"acUnit",position:{x:8,y:3,z:3},color:"#909090"},{type:"acUnit",position:{x:10,y:3,z:5},color:"#909090"},{type:"doorFrame",position:{x:7,y:1,z:4},color:"#4682B4"},{type:"doorFrame",position:{x:7,y:2,z:4},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:2},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:3},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:5},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:1,z:6},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:2,z:2},color:"#4682B4"},{type:"windowFrame",position:{x:7,y:2,z:6},color:"#4682B4"},{type:"sign",position:{x:7,y:2,z:4},color:"#FF0000",emissive:{enabled:!0,color:"#FF0000",intensity:1,radius:2}},{type:"cube",position:{x:0,y:0,z:9},color:"#4169E1"},{type:"pillar2",position:{x:0,y:1,z:9},color:"#C0C0C0"},{type:"cableLoop",position:{x:1,y:0,z:9},color:"#1A1A1A"},{type:"cylinder",position:{x:1,y:0,z:0},color:"#FFD700"},{type:"cylinder",position:{x:3,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:0,y:0,z:0},color:"#808080"},{type:"pipeY",position:{x:0,y:1,z:0},color:"#808080"},{type:"pipeY",position:{x:0,y:2,z:0},color:"#808080"},{type:"cube",position:{x:9,y:0,z:9},color:"#4682B4"},{type:"cube",position:{x:10,y:0,z:9},color:"#4682B4"},{type:"cube",position:{x:11,y:0,z:9},color:"#4682B4"},{type:"cube",position:{x:9,y:1,z:9},color:"#87CEEB"},{type:"cube",position:{x:10,y:1,z:9},color:"#87CEEB"},{type:"cube",position:{x:11,y:1,z:9},color:"#87CEEB"},{type:"slab",position:{x:9,y:2,z:9},color:"#4682B4"},{type:"slab",position:{x:10,y:2,z:9},color:"#4682B4"},{type:"slab",position:{x:11,y:2,z:9},color:"#4682B4"},{type:"pillarRound",position:{x:9,y:0,z:9},color:"#0000CD"},{type:"pillarRound",position:{x:11,y:0,z:9},color:"#0000CD"},{type:"pillar",position:{x:-1,y:0,z:4},color:"#E0E0E0"},{type:"pillar",position:{x:-1,y:1,z:4},color:"#E0E0E0"},{type:"pillar",position:{x:-1,y:2,z:4},color:"#E0E0E0"},{type:"cube",position:{x:-1,y:3,z:4},color:"#FFFFFF"},{type:"cube",position:{x:-1,y:4,z:4},color:"#FF0000"},{type:"barrel",position:{x:6,y:0,z:2},color:"#006400"},{type:"barrel",position:{x:6,y:0,z:6},color:"#006400"},{type:"cube",position:{x:6,y:0,z:4},color:"#FFFFFF"},{type:"cube",position:{x:6,y:1,z:4},color:"#4169E1"},{type:"fence",position:{x:11,y:0,z:1},color:"#C0C0C0"},{type:"barrel",position:{x:11,y:0,z:2},color:"#87CEEB"},{type:"barrel",position:{x:11,y:0,z:3},color:"#87CEEB"}]},helipad:{name:"Helipad",category:"modern",description:"Complete heliport with control room, fuel station, fire safety, and service area",blocks:[...L(4,0,2,10,10,"#404040"),...L(6,0,4,6,6,"#353535"),{type:"slab",position:{x:7,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:8,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:9,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:10,y:0,z:4},color:"#FFFF00"},{type:"slab",position:{x:6,y:0,z:5},color:"#FFFF00"},{type:"slab",position:{x:11,y:0,z:5},color:"#FFFF00"},{type:"slab",position:{x:6,y:0,z:6},color:"#FFFF00"},{type:"slab",position:{x:11,y:0,z:6},color:"#FFFF00"},{type:"slab",position:{x:6,y:0,z:7},color:"#FFFF00"},{type:"slab",position:{x:11,y:0,z:7},color:"#FFFF00"},{type:"slab",position:{x:6,y:0,z:8},color:"#FFFF00"},{type:"slab",position:{x:11,y:0,z:8},color:"#FFFF00"},{type:"slab",position:{x:7,y:0,z:9},color:"#FFFF00"},{type:"slab",position:{x:8,y:0,z:9},color:"#FFFF00"},{type:"slab",position:{x:9,y:0,z:9},color:"#FFFF00"},{type:"slab",position:{x:10,y:0,z:9},color:"#FFFF00"},{type:"slab",position:{x:7,y:0,z:5},color:"#FFFFFF"},{type:"slab",position:{x:7,y:0,z:6},color:"#FFFFFF"},{type:"slab",position:{x:7,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:7,y:0,z:8},color:"#FFFFFF"},{type:"slab",position:{x:8,y:0,z:6},color:"#FFFFFF"},{type:"slab",position:{x:8,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:9,y:0,z:6},color:"#FFFFFF"},{type:"slab",position:{x:9,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:5},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:6},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:7},color:"#FFFFFF"},{type:"slab",position:{x:10,y:0,z:8},color:"#FFFFFF"},{type:"sphere",position:{x:4,y:0,z:2},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:8,y:0,z:2},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:13,y:0,z:2},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:4,y:0,z:11},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:8,y:0,z:11},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:13,y:0,z:11},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:4,y:0,z:6},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},{type:"sphere",position:{x:13,y:0,z:6},color:"#00FF00",emissive:{enabled:!0,color:"#00FF00",intensity:1.5,radius:3}},...L(0,0,4,4,6,"#606060"),...st(0,1,4,6,3,"#808080"),...st(3,1,4,6,3,"#808080"),...at(0,1,4,4,3,"#808080"),...at(0,1,9,4,3,"#808080"),...L(0,4,4,4,6,"#505050"),{type:"doorFrame",position:{x:3,y:1,z:6},color:"#4682B4"},{type:"doorFrame",position:{x:3,y:2,z:6},color:"#4682B4"},{type:"windowFrame",position:{x:3,y:2,z:5},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:2,z:7},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:2,z:8},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:3,z:5},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:3,z:6},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:3,z:7},color:"#87CEEB"},{type:"windowFrame",position:{x:3,y:3,z:8},color:"#87CEEB"},{type:"desk",position:{x:1,y:1,z:6},color:"#4A4A4A"},{type:"monitor",position:{x:1,y:2,z:6},color:"#1E1E1E",emissive:{enabled:!0,color:"#00BFFF",intensity:.5,radius:2}},{type:"desk",position:{x:1,y:1,z:7},color:"#4A4A4A"},{type:"monitor",position:{x:1,y:2,z:7},color:"#1E1E1E",emissive:{enabled:!0,color:"#00FF00",intensity:.5,radius:2}},{type:"chair",position:{x:2,y:1,z:6},color:"#2F2F2F"},{type:"chair",position:{x:2,y:1,z:7},color:"#2F2F2F"},{type:"antenna",position:{x:1,y:4,z:6},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:5,z:6},color:"#C0C0C0"},{type:"acUnit",position:{x:2,y:4,z:8},color:"#A0A0A0"},...L(0,0,0,4,4,"#505050"),{type:"tank",position:{x:1,y:0,z:1},color:"#FF4500"},{type:"tank",position:{x:1,y:1,z:1},color:"#FF4500"},{type:"tank",position:{x:2,y:0,z:1},color:"#FF4500"},{type:"tank",position:{x:2,y:1,z:1},color:"#FF4500"},{type:"pillar",position:{x:1,y:0,z:2},color:"#FFD700"},{type:"powerBox",position:{x:1,y:1,z:2},color:"#FFD700"},{type:"cylinder",position:{x:2,y:0,z:2},color:"#2F2F2F"},{type:"sign",position:{x:0,y:1,z:0},color:"#FF0000"},{type:"drain",position:{x:1,y:0,z:3},color:"#404040"},...L(0,0,10,4,4,"#505050"),{type:"locker",position:{x:1,y:0,z:11},color:"#FF0000"},{type:"locker",position:{x:1,y:1,z:11},color:"#FF0000"},{type:"tank",position:{x:2,y:0,z:12},color:"#FFFF00"},{type:"tank",position:{x:2,y:1,z:12},color:"#FFFF00"},{type:"cylinder",position:{x:1,y:0,z:12},color:"#B22222"},{type:"cabinet",position:{x:3,y:0,z:11},color:"#FFFFFF"},{type:"cross",position:{x:3,y:1,z:11},color:"#FF0000"},{type:"bench",position:{x:3,y:0,z:12},color:"#FF8C00"},{type:"pillar4",position:{x:14,y:0,z:7},color:"#C0C0C0"},{type:"pillar4",position:{x:14,y:1,z:7},color:"#C0C0C0"},{type:"pillar4",position:{x:14,y:2,z:7},color:"#C0C0C0"},{type:"pillar4",position:{x:14,y:3,z:7},color:"#C0C0C0"},{type:"cone",position:{x:14,y:4,z:7},color:"#FF6600",rotation:{x:0,y:0,z:90}},{type:"sphere",position:{x:8,y:0,z:0},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:3}},{type:"sphere",position:{x:9,y:0,z:0},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:3}},{type:"sphere",position:{x:8,y:0,z:1},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1,radius:2}},{type:"sphere",position:{x:9,y:0,z:1},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1,radius:2}},{type:"pillar",position:{x:4,y:0,z:0},color:"#404040"},{type:"pillar",position:{x:4,y:1,z:0},color:"#404040"},{type:"pillar",position:{x:4,y:2,z:0},color:"#404040"},{type:"spotlight",position:{x:4,y:3,z:0},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:2,radius:6}},{type:"pillar",position:{x:13,y:0,z:0},color:"#404040"},{type:"pillar",position:{x:13,y:1,z:0},color:"#404040"},{type:"pillar",position:{x:13,y:2,z:0},color:"#404040"},{type:"spotlight",position:{x:13,y:3,z:0},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:2,radius:6}},...J(4,0,12,10,"X","barrier","#FF0000"),...J(14,0,2,10,"Z","barrier","#FF0000"),{type:"cube",position:{x:14,y:0,z:10},color:"#FFD700"},{type:"seat",position:{x:14,y:1,z:10},color:"#2F2F2F"},{type:"crate",position:{x:14,y:0,z:11},color:"#4682B4"},{type:"crate",position:{x:14,y:0,z:12},color:"#B22222"}]},highway:{name:"Highway Interchange",category:"infrastructure",description:"Elevated highway with exit ramp, signage, lighting, and sound barriers",blocks:[...L(0,0,0,24,16,"#3D5C3D"),...L(2,0,6,20,4,"#2F2F2F"),...J(4,0,8,16,"X","slab","#FFFFFF"),{type:"column",position:{x:4,y:0,z:2},color:"#808080"},{type:"column",position:{x:4,y:1,z:2},color:"#808080"},{type:"column",position:{x:4,y:2,z:2},color:"#808080"},{type:"column",position:{x:4,y:3,z:2},color:"#808080"},{type:"column",position:{x:4,y:0,z:13},color:"#808080"},{type:"column",position:{x:4,y:1,z:13},color:"#808080"},{type:"column",position:{x:4,y:2,z:13},color:"#808080"},{type:"column",position:{x:4,y:3,z:13},color:"#808080"},{type:"column",position:{x:11,y:0,z:2},color:"#808080"},{type:"column",position:{x:11,y:1,z:2},color:"#808080"},{type:"column",position:{x:11,y:2,z:2},color:"#808080"},{type:"column",position:{x:11,y:3,z:2},color:"#808080"},{type:"column",position:{x:11,y:0,z:13},color:"#808080"},{type:"column",position:{x:11,y:1,z:13},color:"#808080"},{type:"column",position:{x:11,y:2,z:13},color:"#808080"},{type:"column",position:{x:11,y:3,z:13},color:"#808080"},{type:"column",position:{x:18,y:0,z:2},color:"#808080"},{type:"column",position:{x:18,y:1,z:2},color:"#808080"},{type:"column",position:{x:18,y:2,z:2},color:"#808080"},{type:"column",position:{x:18,y:3,z:2},color:"#808080"},{type:"column",position:{x:18,y:0,z:13},color:"#808080"},{type:"column",position:{x:18,y:1,z:13},color:"#808080"},{type:"column",position:{x:18,y:2,z:13},color:"#808080"},{type:"column",position:{x:18,y:3,z:13},color:"#808080"},...L(0,4,0,24,6,"#2A2A2A"),...L(0,4,10,24,6,"#2A2A2A"),...L(0,4,6,24,4,"#404040"),{type:"slab",position:{x:2,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:4,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:6,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:8,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:10,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:12,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:14,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:16,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:18,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:20,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:22,y:4,z:2},color:"#FFFFFF"},{type:"slab",position:{x:2,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:4,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:6,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:8,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:10,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:12,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:14,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:16,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:18,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:20,y:4,z:13},color:"#FFFFFF"},{type:"slab",position:{x:22,y:4,z:13},color:"#FFFFFF"},...J(0,4,5,24,"X","slab","#FFD700"),...J(0,4,10,24,"X","slab","#FFD700"),...J(0,4,0,24,"X","barrier","#C0C0C0"),...J(0,4,15,24,"X","barrier","#C0C0C0"),...J(0,4,6,24,"X","barrier","#C0C0C0"),...J(0,4,9,24,"X","barrier","#C0C0C0"),...L(16,4,16,4,4,"#2A2A2A"),...L(18,3,18,4,4,"#2A2A2A"),...L(20,2,20,4,4,"#2A2A2A"),...L(20,1,22,4,4,"#2A2A2A"),...J(16,4,19,4,"X","barrier","#C0C0C0"),...J(18,3,21,4,"X","barrier","#C0C0C0"),...J(20,2,23,4,"X","barrier","#C0C0C0"),{type:"column",position:{x:19,y:0,z:19},color:"#808080"},{type:"column",position:{x:19,y:1,z:19},color:"#808080"},{type:"column",position:{x:19,y:2,z:19},color:"#808080"},{type:"column",position:{x:8,y:4,z:-1},color:"#2F4F2F"},{type:"column",position:{x:8,y:5,z:-1},color:"#2F4F2F"},{type:"column",position:{x:8,y:6,z:-1},color:"#2F4F2F"},{type:"column",position:{x:8,y:7,z:-1},color:"#2F4F2F"},{type:"column",position:{x:8,y:4,z:16},color:"#2F4F2F"},{type:"column",position:{x:8,y:5,z:16},color:"#2F4F2F"},{type:"column",position:{x:8,y:6,z:16},color:"#2F4F2F"},{type:"column",position:{x:8,y:7,z:16},color:"#2F4F2F"},...J(8,7,0,16,"Z","iBeam","#2F4F2F"),{type:"sign",position:{x:8,y:6,z:3},color:"#006400"},{type:"sign",position:{x:8,y:6,z:4},color:"#006400"},{type:"sign",position:{x:8,y:6,z:12},color:"#006400"},{type:"sign",position:{x:8,y:6,z:13},color:"#006400"},{type:"sign",position:{x:14,y:5,z:15},color:"#228B22"},{type:"pillar4",position:{x:1,y:4,z:0},color:"#FFFFFF"},{type:"sign",position:{x:1,y:5,z:0},color:"#228B22"},{type:"pillar4",position:{x:3,y:4,z:7},color:"#404040"},{type:"pillar4",position:{x:3,y:5,z:7},color:"#404040"},{type:"pillar4",position:{x:3,y:6,z:7},color:"#404040"},{type:"lightFixture",position:{x:3,y:7,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFCC",intensity:1.5,radius:6}},{type:"pillar4",position:{x:10,y:4,z:7},color:"#404040"},{type:"pillar4",position:{x:10,y:5,z:7},color:"#404040"},{type:"pillar4",position:{x:10,y:6,z:7},color:"#404040"},{type:"lightFixture",position:{x:10,y:7,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFCC",intensity:1.5,radius:6}},{type:"pillar4",position:{x:17,y:4,z:7},color:"#404040"},{type:"pillar4",position:{x:17,y:5,z:7},color:"#404040"},{type:"pillar4",position:{x:17,y:6,z:7},color:"#404040"},{type:"lightFixture",position:{x:17,y:7,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFCC",intensity:1.5,radius:6}},{type:"post",position:{x:0,y:0,z:16},color:"#606060"},{type:"post",position:{x:0,y:1,z:16},color:"#606060"},{type:"post",position:{x:0,y:2,z:16},color:"#606060"},{type:"post",position:{x:0,y:3,z:16},color:"#606060"},{type:"post",position:{x:4,y:0,z:16},color:"#606060"},{type:"post",position:{x:4,y:1,z:16},color:"#606060"},{type:"post",position:{x:4,y:2,z:16},color:"#606060"},{type:"post",position:{x:4,y:3,z:16},color:"#606060"},{type:"post",position:{x:8,y:0,z:16},color:"#606060"},{type:"post",position:{x:8,y:1,z:16},color:"#606060"},{type:"post",position:{x:8,y:2,z:16},color:"#606060"},{type:"post",position:{x:8,y:3,z:16},color:"#606060"},{type:"post",position:{x:12,y:0,z:16},color:"#606060"},{type:"post",position:{x:12,y:1,z:16},color:"#606060"},{type:"post",position:{x:12,y:2,z:16},color:"#606060"},{type:"post",position:{x:12,y:3,z:16},color:"#606060"},{type:"post",position:{x:15,y:0,z:16},color:"#606060"},{type:"post",position:{x:15,y:1,z:16},color:"#606060"},{type:"post",position:{x:15,y:2,z:16},color:"#606060"},{type:"post",position:{x:15,y:3,z:16},color:"#606060"},...J(0,4,16,16,"X","panel","#A0A0A0"),...J(0,5,16,16,"X","panel","#909090"),...J(0,6,16,16,"X","panel","#808080"),{type:"pillar4",position:{x:6,y:4,z:0},color:"#4169E1"},{type:"powerBox",position:{x:6,y:5,z:0},color:"#4169E1"},{type:"locker",position:{x:12,y:4,z:0},color:"#FF0000"},{type:"beamZ",position:{x:8,y:3,z:6},color:"#404040"},{type:"beamZ",position:{x:8,y:3,z:7},color:"#404040"},{type:"beamZ",position:{x:8,y:3,z:8},color:"#404040"},{type:"lightFixture",position:{x:8,y:3,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:.8,radius:4}},{type:"beamZ",position:{x:14,y:3,z:6},color:"#404040"},{type:"beamZ",position:{x:14,y:3,z:7},color:"#404040"},{type:"beamZ",position:{x:14,y:3,z:8},color:"#404040"},{type:"lightFixture",position:{x:14,y:3,z:7},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFEE",intensity:.8,radius:4}},{type:"grate",position:{x:6,y:0,z:7},color:"#2F2F2F"},{type:"grate",position:{x:12,y:0,z:7},color:"#2F2F2F"},{type:"grate",position:{x:18,y:0,z:7},color:"#2F2F2F"}]},harbor:{name:"Harbor",category:"infrastructure",description:"Busy shipping harbor with crane, warehouse, lighthouse, boat, and cargo containers",blocks:[...L(0,-1,0,16,6,"#1E4D6B"),...L(0,0,0,16,1,"#1E90FF"),...L(0,0,6,16,8,"#696969"),...J(0,0,6,16,"X","ledge","#505050"),...L(0,0,6,6,3,"#8B4513"),...L(6,0,2,4,4,"#654321"),{type:"pillar",position:{x:6,y:-1,z:2},color:"#3A2A1A"},{type:"pillar",position:{x:9,y:-1,z:2},color:"#3A2A1A"},{type:"pillar",position:{x:6,y:-1,z:5},color:"#3A2A1A"},{type:"pillar",position:{x:9,y:-1,z:5},color:"#3A2A1A"},{type:"beamX",position:{x:2,y:0,z:8},color:"#505050"},{type:"beamX",position:{x:3,y:0,z:8},color:"#505050"},{type:"beamX",position:{x:4,y:0,z:8},color:"#505050"},{type:"beamX",position:{x:2,y:0,z:11},color:"#505050"},{type:"beamX",position:{x:3,y:0,z:11},color:"#505050"},{type:"beamX",position:{x:4,y:0,z:11},color:"#505050"},{type:"iBeam",position:{x:2,y:1,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:2,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:3,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:4,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:5,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:1,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:2,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:3,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:4,z:8},color:"#FFD700"},{type:"iBeam",position:{x:4,y:5,z:8},color:"#FFD700"},{type:"iBeam",position:{x:2,y:1,z:11},color:"#FFD700"},{type:"iBeam",position:{x:2,y:2,z:11},color:"#FFD700"},{type:"iBeam",position:{x:2,y:3,z:11},color:"#FFD700"},{type:"iBeam",position:{x:2,y:4,z:11},color:"#FFD700"},{type:"iBeam",position:{x:2,y:5,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:1,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:2,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:3,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:4,z:11},color:"#FFD700"},{type:"iBeam",position:{x:4,y:5,z:11},color:"#FFD700"},{type:"beamZ",position:{x:2,y:6,z:8},color:"#FFD700"},{type:"beamZ",position:{x:2,y:6,z:9},color:"#FFD700"},{type:"beamZ",position:{x:2,y:6,z:10},color:"#FFD700"},{type:"beamZ",position:{x:2,y:6,z:11},color:"#FFD700"},{type:"beamZ",position:{x:4,y:6,z:8},color:"#FFD700"},{type:"beamZ",position:{x:4,y:6,z:9},color:"#FFD700"},{type:"beamZ",position:{x:4,y:6,z:10},color:"#FFD700"},{type:"beamZ",position:{x:4,y:6,z:11},color:"#FFD700"},{type:"beamX",position:{x:2,y:6,z:9},color:"#FF8C00"},{type:"beamX",position:{x:3,y:6,z:9},color:"#FF8C00"},{type:"beamX",position:{x:4,y:6,z:9},color:"#FF8C00"},{type:"beamZ",position:{x:3,y:6,z:7},color:"#FF8C00"},{type:"beamZ",position:{x:3,y:6,z:6},color:"#FF8C00"},{type:"beamZ",position:{x:3,y:6,z:5},color:"#FF8C00"},{type:"beamZ",position:{x:3,y:6,z:4},color:"#FF8C00"},{type:"chain",position:{x:3,y:5,z:5},color:"#404040"},{type:"chain",position:{x:3,y:4,z:5},color:"#404040"},{type:"chain",position:{x:3,y:3,z:5},color:"#404040"},{type:"valve",position:{x:3,y:2,z:5},color:"#808080"},...L(10,0,7,6,6,"#505050"),...at(10,1,7,6,3,"#A0522D"),...at(10,1,12,6,3,"#A0522D"),...st(10,1,8,4,3,"#A0522D"),...st(15,1,8,4,3,"#A0522D"),...L(10,4,7,6,6,"#8B4513"),{type:"doorFrame",position:{x:12,y:1,z:7},color:"#8B4513"},{type:"doorFrame",position:{x:13,y:1,z:7},color:"#8B4513"},{type:"doorFrame",position:{x:12,y:2,z:7},color:"#8B4513"},{type:"doorFrame",position:{x:13,y:2,z:7},color:"#8B4513"},{type:"windowFrame",position:{x:11,y:2,z:7},color:"#4682B4"},{type:"windowFrame",position:{x:14,y:2,z:7},color:"#4682B4"},{type:"sign",position:{x:12,y:3,z:7},color:"#FFD700"},{type:"cylinder",position:{x:0,y:0,z:0},color:"#F5F5F5"},{type:"cylinder",position:{x:0,y:1,z:0},color:"#DC143C"},{type:"cylinder",position:{x:0,y:2,z:0},color:"#F5F5F5"},{type:"cylinder",position:{x:0,y:3,z:0},color:"#DC143C"},{type:"cylinder",position:{x:0,y:4,z:0},color:"#F5F5F5"},{type:"windowFrame",position:{x:0,y:5,z:0},color:"#1A1A1A"},{type:"bulb",position:{x:0,y:5,z:0},color:"#FFFF00",emissive:{enabled:!0,color:"#FFFF00",intensity:3,radius:8}},{type:"dome",position:{x:0,y:6,z:0},color:"#DC143C"},{type:"hull",position:{x:12,y:0,z:2},color:"#F5F5F5"},{type:"hull",position:{x:13,y:0,z:2},color:"#F5F5F5"},{type:"hull",position:{x:14,y:0,z:2},color:"#F5F5F5"},{type:"cube",position:{x:13,y:1,z:2},color:"#E6E6FA"},{type:"pillar2",position:{x:12,y:1,z:2},color:"#8B4513"},{type:"pillar2",position:{x:12,y:2,z:2},color:"#8B4513"},{type:"crateLarge",position:{x:6,y:0,z:7},color:"#B22222"},{type:"crateLarge",position:{x:6,y:1,z:7},color:"#B22222"},{type:"crateLarge",position:{x:6,y:0,z:9},color:"#4169E1"},{type:"crateLarge",position:{x:6,y:0,z:11},color:"#228B22"},{type:"crateLarge",position:{x:6,y:1,z:11},color:"#FFD700"},{type:"crate",position:{x:8,y:0,z:8},color:"#8B4513"},{type:"crate",position:{x:8,y:0,z:9},color:"#A0522D"},{type:"crate",position:{x:8,y:1,z:8},color:"#CD853F"},{type:"barrel",position:{x:8,y:0,z:10},color:"#2F4F4F"},{type:"barrel",position:{x:8,y:0,z:11},color:"#006400"},{type:"bollard",position:{x:0,y:0,z:6},color:"#404040"},{type:"bollard",position:{x:4,y:0,z:6},color:"#404040"},{type:"bollard",position:{x:8,y:0,z:6},color:"#404040"},{type:"bollard",position:{x:12,y:0,z:6},color:"#404040"},{type:"bollard",position:{x:6,y:0,z:2},color:"#404040"},{type:"bollard",position:{x:9,y:0,z:2},color:"#404040"},{type:"pillar",position:{x:2,y:0,z:12},color:"#404040"},{type:"pillar",position:{x:2,y:1,z:12},color:"#404040"},{type:"pillar",position:{x:2,y:2,z:12},color:"#404040"},{type:"spotlight",position:{x:2,y:3,z:12},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:5}},{type:"pillar",position:{x:10,y:0,z:12},color:"#404040"},{type:"pillar",position:{x:10,y:1,z:12},color:"#404040"},{type:"pillar",position:{x:10,y:2,z:12},color:"#404040"},{type:"spotlight",position:{x:10,y:3,z:12},color:"#FFFFFF",emissive:{enabled:!0,color:"#FFFFFF",intensity:1.5,radius:5}},{type:"torus",position:{x:5,y:1,z:6},color:"#FF4500"},{type:"railing",position:{x:6,y:0,z:2},color:"#FFD700"},{type:"railing",position:{x:7,y:0,z:2},color:"#FFD700"},{type:"railing",position:{x:8,y:0,z:2},color:"#FFD700"},{type:"railing",position:{x:9,y:0,z:2},color:"#FFD700"},{type:"wheel",position:{x:9,y:0,z:9},color:"#1A1A1A"},{type:"seat",position:{x:9,y:0,z:10},color:"#FFD700"}]},oilDerrick:{name:"Oil Derrick",category:"oil",description:"Classic oil drilling tower with lattice structure and drilling equipment",blocks:[...L(0,0,0,8,7,"#8B7355"),...L(2,0,1,4,4,"#606060"),{type:"iBeam",position:{x:2,y:1,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:2,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:3,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:4,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:5,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:6,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:7,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:1,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:2,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:3,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:4,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:5,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:6,z:1},color:"#8B0000"},{type:"iBeam",position:{x:5,y:7,z:1},color:"#8B0000"},{type:"iBeam",position:{x:2,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:4,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:5,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:6,z:4},color:"#8B0000"},{type:"iBeam",position:{x:2,y:7,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:4,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:5,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:6,z:4},color:"#8B0000"},{type:"iBeam",position:{x:5,y:7,z:4},color:"#8B0000"},{type:"beamX",position:{x:3,y:2,z:1},color:"#B22222"},{type:"beamX",position:{x:4,y:2,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:4,z:1},color:"#B22222"},{type:"beamX",position:{x:4,y:4,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:6,z:1},color:"#B22222"},{type:"beamX",position:{x:4,y:6,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:2,z:4},color:"#B22222"},{type:"beamX",position:{x:4,y:2,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:4,z:4},color:"#B22222"},{type:"beamX",position:{x:4,y:4,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:6,z:4},color:"#B22222"},{type:"beamX",position:{x:4,y:6,z:4},color:"#B22222"},{type:"beamZ",position:{x:2,y:2,z:2},color:"#B22222"},{type:"beamZ",position:{x:2,y:2,z:3},color:"#B22222"},{type:"beamZ",position:{x:2,y:4,z:2},color:"#B22222"},{type:"beamZ",position:{x:2,y:4,z:3},color:"#B22222"},{type:"beamZ",position:{x:2,y:6,z:2},color:"#B22222"},{type:"beamZ",position:{x:2,y:6,z:3},color:"#B22222"},{type:"beamZ",position:{x:5,y:2,z:2},color:"#B22222"},{type:"beamZ",position:{x:5,y:2,z:3},color:"#B22222"},{type:"beamZ",position:{x:5,y:4,z:2},color:"#B22222"},{type:"beamZ",position:{x:5,y:4,z:3},color:"#B22222"},{type:"beamZ",position:{x:5,y:6,z:2},color:"#B22222"},{type:"beamZ",position:{x:5,y:6,z:3},color:"#B22222"},{type:"crossBeam",position:{x:3,y:1,z:1},color:"#A52A2A"},{type:"crossBeam",position:{x:4,y:3,z:1},color:"#A52A2A"},{type:"crossBeam",position:{x:3,y:5,z:1},color:"#A52A2A"},{type:"crossBeam",position:{x:3,y:1,z:4},color:"#A52A2A"},{type:"crossBeam",position:{x:4,y:3,z:4},color:"#A52A2A"},{type:"crossBeam",position:{x:3,y:5,z:4},color:"#A52A2A"},{type:"grateFloor",position:{x:3,y:8,z:2},color:"#404040"},{type:"grateFloor",position:{x:4,y:8,z:2},color:"#404040"},{type:"grateFloor",position:{x:3,y:8,z:3},color:"#404040"},{type:"grateFloor",position:{x:4,y:8,z:3},color:"#404040"},{type:"cylinder",position:{x:3,y:8,z:2},color:"#505050"},{type:"cylinder",position:{x:4,y:8,z:3},color:"#505050"},{type:"beamZ",position:{x:2,y:5,z:2},color:"#B22222"},{type:"beamZ",position:{x:2,y:5,z:3},color:"#B22222"},{type:"beamZ",position:{x:5,y:5,z:2},color:"#B22222"},{type:"beamZ",position:{x:5,y:5,z:3},color:"#B22222"},{type:"catwalk",position:{x:3,y:5,z:2},color:"#404040"},{type:"catwalk",position:{x:4,y:5,z:2},color:"#404040"},{type:"catwalk",position:{x:3,y:5,z:3},color:"#404040"},{type:"catwalk",position:{x:4,y:5,z:3},color:"#404040"},{type:"railing",position:{x:3,y:5,z:1},color:"#FFD700"},{type:"railing",position:{x:4,y:5,z:1},color:"#FFD700"},{type:"wellHead",position:{x:3,y:0,z:2},color:"#B22222"},{type:"wellHead",position:{x:4,y:0,z:2},color:"#B22222"},{type:"wellHead",position:{x:3,y:0,z:3},color:"#B22222"},{type:"wellHead",position:{x:4,y:0,z:3},color:"#B22222"},{type:"pipeY",position:{x:3,y:1,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:2,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:3,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:4,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:5,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:6,z:2},color:"#708090"},{type:"pipeY",position:{x:3,y:7,z:2},color:"#708090"},...L(0,0,1,2,3,"#505050"),{type:"cube",position:{x:0,y:1,z:1},color:"#404040"},{type:"cube",position:{x:1,y:1,z:1},color:"#404040"},{type:"cube",position:{x:0,y:1,z:2},color:"#404040"},{type:"cube",position:{x:1,y:1,z:2},color:"#404040"},{type:"cube",position:{x:0,y:1,z:3},color:"#404040"},{type:"cube",position:{x:1,y:1,z:3},color:"#404040"},{type:"slab",position:{x:0,y:2,z:1},color:"#303030"},{type:"slab",position:{x:1,y:2,z:1},color:"#303030"},{type:"slab",position:{x:0,y:2,z:2},color:"#303030"},{type:"slab",position:{x:1,y:2,z:2},color:"#303030"},{type:"slab",position:{x:0,y:2,z:3},color:"#303030"},{type:"slab",position:{x:1,y:2,z:3},color:"#303030"},{type:"pipeY",position:{x:0,y:2,z:1},color:"#2F2F2F"},{type:"pipeY",position:{x:0,y:3,z:1},color:"#2F2F2F"},{type:"tank",position:{x:6,y:0,z:1},color:"#2F4F4F"},{type:"tank",position:{x:6,y:1,z:1},color:"#2F4F4F"},{type:"tank",position:{x:7,y:0,z:1},color:"#2F4F4F"},{type:"tank",position:{x:7,y:1,z:1},color:"#2F4F4F"},{type:"tank",position:{x:6,y:0,z:3},color:"#4A6B4A"},{type:"tank",position:{x:6,y:1,z:3},color:"#4A6B4A"},{type:"tank",position:{x:7,y:0,z:3},color:"#4A6B4A"},{type:"tank",position:{x:7,y:1,z:3},color:"#4A6B4A"},{type:"pipeX",position:{x:5,y:0,z:1},color:"#708090"},{type:"pipeX",position:{x:5,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:5,y:0,z:2},color:"#708090"},{type:"catwalk",position:{x:0,y:0,z:5},color:"#606060"},{type:"catwalk",position:{x:1,y:0,z:5},color:"#606060"},{type:"catwalk",position:{x:2,y:0,z:5},color:"#606060"},{type:"catwalk",position:{x:3,y:0,z:5},color:"#606060"},{type:"pipeX",position:{x:0,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:1,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:2,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:3,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:0,y:0,z:6},color:"#708090"},{type:"pipeX",position:{x:1,y:0,z:6},color:"#708090"},{type:"pipeX",position:{x:2,y:0,z:6},color:"#708090"},{type:"pipeX",position:{x:3,y:0,z:6},color:"#708090"},{type:"valve",position:{x:2,y:1,z:2},color:"#B22222"},{type:"valve",position:{x:2,y:1,z:3},color:"#B22222"},{type:"valve",position:{x:5,y:0,z:2},color:"#FF4500"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:7,y:0,z:0},color:"#FFD700"},{type:"trafficCone",position:{x:6,y:0,z:5},color:"#FF6600"},{type:"trafficCone",position:{x:7,y:0,z:5},color:"#FF6600"},{type:"spotlight",position:{x:2,y:4,z:1},color:"#FFFF99"},{type:"spotlight",position:{x:5,y:4,z:4},color:"#FFFF99"}]},pumpJackStation:{name:"Pump Jack Station",category:"oil",description:"Oil production site with multiple pump jacks, storage, and control systems",blocks:[...L(0,0,0,10,8,"#8B7355"),{type:"slab",position:{x:1,y:0,z:1},color:"#606060"},{type:"slab",position:{x:2,y:0,z:1},color:"#606060"},{type:"slab",position:{x:1,y:0,z:2},color:"#606060"},{type:"slab",position:{x:2,y:0,z:2},color:"#606060"},{type:"pumpJack",position:{x:1,y:0,z:1},color:"#CD5C5C"},{type:"wellHead",position:{x:2,y:0,z:2},color:"#505050"},{type:"slab",position:{x:1,y:0,z:5},color:"#606060"},{type:"slab",position:{x:2,y:0,z:5},color:"#606060"},{type:"slab",position:{x:1,y:0,z:6},color:"#606060"},{type:"slab",position:{x:2,y:0,z:6},color:"#606060"},{type:"pumpJack",position:{x:1,y:0,z:5},color:"#B22222"},{type:"wellHead",position:{x:2,y:0,z:6},color:"#505050"},{type:"oilTankSmall",position:{x:7,y:0,z:1},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:8,y:0,z:1},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:9,y:0,z:1},color:"#4A6B4A"},{type:"oilTankSmall",position:{x:7,y:0,z:3},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:8,y:0,z:3},color:"#2F4F4F"},{type:"tank",position:{x:9,y:0,z:3},color:"#4682B4"},{type:"tank",position:{x:9,y:1,z:3},color:"#4682B4"},{type:"oilTank",position:{x:5,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:5,y:1,z:2},color:"#505050"},{type:"pipeX",position:{x:3,y:0,z:2},color:"#708090"},{type:"pipeX",position:{x:4,y:0,z:2},color:"#708090"},{type:"valve",position:{x:3,y:0,z:2},color:"#B22222"},{type:"pipeX",position:{x:3,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:4,y:0,z:5},color:"#708090"},{type:"pipeZ",position:{x:4,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:4,y:0,z:4},color:"#708090"},{type:"valve",position:{x:3,y:0,z:5},color:"#B22222"},{type:"pipeX",position:{x:6,y:0,z:2},color:"#708090"},{type:"pipeZ",position:{x:6,y:0,z:1},color:"#708090"},{type:"valve",position:{x:6,y:0,z:2},color:"#FF4500"},{type:"cube",position:{x:7,y:0,z:5},color:"#F5F5DC"},{type:"cube",position:{x:8,y:0,z:5},color:"#F5F5DC"},{type:"cube",position:{x:7,y:0,z:6},color:"#F5F5DC"},{type:"cube",position:{x:8,y:0,z:6},color:"#F5F5DC"},{type:"cube",position:{x:7,y:1,z:5},color:"#F5F5DC"},{type:"cube",position:{x:8,y:1,z:5},color:"#F5F5DC"},{type:"cube",position:{x:7,y:1,z:6},color:"#F5F5DC"},{type:"cube",position:{x:8,y:1,z:6},color:"#F5F5DC"},{type:"slab",position:{x:7,y:2,z:5},color:"#696969"},{type:"slab",position:{x:8,y:2,z:5},color:"#696969"},{type:"slab",position:{x:7,y:2,z:6},color:"#696969"},{type:"slab",position:{x:8,y:2,z:6},color:"#696969"},{type:"doorFrame",position:{x:7,y:0,z:5},color:"#8B4513"},{type:"windowFrame",position:{x:8,y:1,z:5},color:"#8B4513"},{type:"acUnit",position:{x:7,y:2,z:6},color:"#C0C0C0"},{type:"transformer",position:{x:5,y:0,z:6},color:"#505050"},{type:"powerBox",position:{x:5,y:0,z:5},color:"#2F4F4F"},{type:"conduitX",position:{x:4,y:0,z:6},color:"#505050"},{type:"conduitX",position:{x:3,y:0,z:6},color:"#505050"},{type:"slab",position:{x:5,y:0,z:0},color:"#606060"},{type:"valve",position:{x:5,y:0,z:0},color:"#FFD700"},{type:"pipeX",position:{x:6,y:0,z:0},color:"#708090"},{type:"pipeX",position:{x:7,y:0,z:0},color:"#708090"},{type:"fence",position:{x:0,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:1,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:2,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:3,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:4,y:0,z:0},color:"#8B8B8B"},{type:"fence",position:{x:0,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:1,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:2,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:3,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:4,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:5,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:6,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:7,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:8,y:0,z:7},color:"#8B8B8B"},{type:"fence",position:{x:9,y:0,z:7},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:1},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:2},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:3},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:4},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:5},color:"#8B8B8B"},{type:"fenceZ",position:{x:0,y:0,z:6},color:"#8B8B8B"},{type:"fenceZ",position:{x:9,y:0,z:5},color:"#8B8B8B"},{type:"fenceZ",position:{x:9,y:0,z:6},color:"#8B8B8B"},{type:"barrier",position:{x:8,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:9,y:0,z:0},color:"#FFD700"},{type:"trafficCone",position:{x:3,y:0,z:3},color:"#FF6600"},{type:"trafficCone",position:{x:3,y:0,z:4},color:"#FF6600"},{type:"sign",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"oilBarrel",position:{x:9,y:0,z:5},color:"#1a1a1a"},{type:"oilBarrel",position:{x:9,y:0,z:6},color:"#B22222"}]},oilStorageFacility:{name:"Oil Storage Facility",category:"oil",description:"Tank farm with containment, truck loading, and fire suppression systems",blocks:[...L(0,0,0,14,12,"#707070"),{type:"slab",position:{x:1,y:0,z:1},color:"#505050"},{type:"slab",position:{x:2,y:0,z:1},color:"#505050"},{type:"slab",position:{x:3,y:0,z:1},color:"#505050"},{type:"slab",position:{x:4,y:0,z:1},color:"#505050"},{type:"slab",position:{x:1,y:0,z:4},color:"#505050"},{type:"slab",position:{x:2,y:0,z:4},color:"#505050"},{type:"slab",position:{x:3,y:0,z:4},color:"#505050"},{type:"slab",position:{x:4,y:0,z:4},color:"#505050"},{type:"oilTank",position:{x:2,y:0,z:2},color:"#1a1a1a"},{type:"oilTank",position:{x:2,y:0,z:3},color:"#1a1a1a"},{type:"slab",position:{x:6,y:0,z:1},color:"#505050"},{type:"slab",position:{x:7,y:0,z:1},color:"#505050"},{type:"slab",position:{x:8,y:0,z:1},color:"#505050"},{type:"slab",position:{x:6,y:0,z:4},color:"#505050"},{type:"slab",position:{x:7,y:0,z:4},color:"#505050"},{type:"slab",position:{x:8,y:0,z:4},color:"#505050"},{type:"tank",position:{x:6,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:6,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:6,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:8,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:8,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:8,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:6,y:0,z:3},color:"#C0C0C0"},{type:"tank",position:{x:6,y:1,z:3},color:"#C0C0C0"},{type:"tank",position:{x:6,y:2,z:3},color:"#C0C0C0"},{type:"tank",position:{x:8,y:0,z:3},color:"#C0C0C0"},{type:"tank",position:{x:8,y:1,z:3},color:"#C0C0C0"},{type:"tank",position:{x:8,y:2,z:3},color:"#C0C0C0"},{type:"stairs",position:{x:7,y:0,z:2},color:"#FFD700"},{type:"stairs",position:{x:7,y:1,z:2},color:"#FFD700"},{type:"oilTankSmall",position:{x:10,y:0,z:1},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:11,y:0,z:1},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:12,y:0,z:1},color:"#4A6B4A"},{type:"oilTankSmall",position:{x:10,y:0,z:3},color:"#4682B4"},{type:"oilTankSmall",position:{x:11,y:0,z:3},color:"#4682B4"},{type:"oilTankSmall",position:{x:12,y:0,z:3},color:"#B8860B"},{type:"pipeX",position:{x:3,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:4,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:5,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:6,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:7,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:9,y:0,z:5},color:"#708090"},{type:"pipeX",position:{x:10,y:0,z:5},color:"#708090"},{type:"pipeZ",position:{x:3,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:6,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:10,y:0,z:4},color:"#708090"},{type:"valve",position:{x:3,y:0,z:5},color:"#B22222"},{type:"valve",position:{x:6,y:0,z:5},color:"#B22222"},{type:"valve",position:{x:8,y:0,z:5},color:"#B22222"},{type:"valve",position:{x:10,y:0,z:5},color:"#B22222"},...L(1,0,6,3,2,"#606060"),{type:"cube",position:{x:1,y:1,z:6},color:"#8B8B8B"},{type:"cube",position:{x:2,y:1,z:6},color:"#8B8B8B"},{type:"cube",position:{x:3,y:1,z:6},color:"#8B8B8B"},{type:"cube",position:{x:1,y:1,z:7},color:"#8B8B8B"},{type:"cube",position:{x:2,y:1,z:7},color:"#8B8B8B"},{type:"cube",position:{x:3,y:1,z:7},color:"#8B8B8B"},{type:"slab",position:{x:1,y:2,z:6},color:"#505050"},{type:"slab",position:{x:2,y:2,z:6},color:"#505050"},{type:"slab",position:{x:3,y:2,z:6},color:"#505050"},{type:"slab",position:{x:1,y:2,z:7},color:"#505050"},{type:"slab",position:{x:2,y:2,z:7},color:"#505050"},{type:"slab",position:{x:3,y:2,z:7},color:"#505050"},{type:"doorFrame",position:{x:2,y:1,z:6},color:"#8B4513"},{type:"cylinder",position:{x:1,y:0,z:6},color:"#2F4F4F"},{type:"cylinder",position:{x:3,y:0,z:7},color:"#2F4F4F"},{type:"pipeX",position:{x:0,y:0,z:6},color:"#708090"},{type:"pipeZ",position:{x:2,y:0,z:5},color:"#708090"},...L(1,0,9,6,3,"#404040"),{type:"pipeY",position:{x:2,y:0,z:10},color:"#708090"},{type:"pipeY",position:{x:2,y:1,z:10},color:"#708090"},{type:"pipeElbowXY",position:{x:2,y:2,z:10},color:"#708090"},{type:"pipeY",position:{x:5,y:0,z:10},color:"#708090"},{type:"pipeY",position:{x:5,y:1,z:10},color:"#708090"},{type:"pipeElbowXY",position:{x:5,y:2,z:10},color:"#708090"},{type:"valve",position:{x:2,y:1,z:10},color:"#FFD700"},{type:"valve",position:{x:5,y:1,z:10},color:"#FFD700"},{type:"pillar",position:{x:1,y:0,z:9},color:"#505050"},{type:"pillar",position:{x:1,y:1,z:9},color:"#505050"},{type:"pillar",position:{x:1,y:2,z:9},color:"#505050"},{type:"pillar",position:{x:6,y:0,z:9},color:"#505050"},{type:"pillar",position:{x:6,y:1,z:9},color:"#505050"},{type:"pillar",position:{x:6,y:2,z:9},color:"#505050"},{type:"pillar",position:{x:1,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:1,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:1,y:2,z:11},color:"#505050"},{type:"pillar",position:{x:6,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:6,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:6,y:2,z:11},color:"#505050"},{type:"beamX",position:{x:2,y:3,z:9},color:"#505050"},{type:"beamX",position:{x:3,y:3,z:9},color:"#505050"},{type:"beamX",position:{x:4,y:3,z:9},color:"#505050"},{type:"beamX",position:{x:5,y:3,z:9},color:"#505050"},{type:"beamX",position:{x:2,y:3,z:11},color:"#505050"},{type:"beamX",position:{x:3,y:3,z:11},color:"#505050"},{type:"beamX",position:{x:4,y:3,z:11},color:"#505050"},{type:"beamX",position:{x:5,y:3,z:11},color:"#505050"},...L(10,0,7,4,4,"#808080"),...yt(10,1,7,4,4,"#F5F5DC"),...yt(10,2,7,4,4,"#F5F5DC"),...L(10,3,7,4,4,"#696969"),{type:"doorFrame",position:{x:11,y:1,z:7},color:"#8B4513"},{type:"windowFrame",position:{x:12,y:2,z:7},color:"#8B4513"},{type:"windowFrame",position:{x:10,y:2,z:8},color:"#8B4513"},{type:"windowFrame",position:{x:13,y:2,z:9},color:"#8B4513"},{type:"acUnit",position:{x:12,y:3,z:9},color:"#C0C0C0"},{type:"tank",position:{x:10,y:0,z:5},color:"#B22222"},{type:"tank",position:{x:10,y:1,z:5},color:"#B22222"},{type:"tank",position:{x:10,y:2,z:5},color:"#B22222"},{type:"pipeY",position:{x:4,y:0,z:0},color:"#B22222"},{type:"valve",position:{x:4,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:9,y:0,z:0},color:"#B22222"},{type:"valve",position:{x:9,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:0,y:0,z:5},color:"#B22222"},{type:"pipeY",position:{x:13,y:0,z:5},color:"#B22222"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:13,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:11},color:"#FFD700"},{type:"barrier",position:{x:13,y:0,z:11},color:"#FFD700"},{type:"trafficCone",position:{x:0,y:0,z:9},color:"#FF6600"},{type:"trafficCone",position:{x:0,y:0,z:10},color:"#FF6600"},{type:"trafficCone",position:{x:7,y:0,z:10},color:"#FF6600"},{type:"sign",position:{x:1,y:0,z:0},color:"#FFD700"},{type:"sign",position:{x:12,y:0,z:0},color:"#FFD700"},{type:"transformer",position:{x:12,y:0,z:5},color:"#505050"},{type:"powerBox",position:{x:13,y:0,z:6},color:"#2F4F4F"},{type:"lightFixture",position:{x:5,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:8,y:0,z:0},color:"#FFFF99"},{type:"oilBarrel",position:{x:12,y:0,z:10},color:"#1a1a1a"},{type:"oilBarrel",position:{x:13,y:0,z:10},color:"#1a1a1a"},{type:"oilBarrel",position:{x:12,y:0,z:11},color:"#B22222"},{type:"oilBarrel",position:{x:13,y:0,z:11},color:"#4682B4"},{type:"oilBarrel",position:{x:12,y:1,z:10},color:"#1a1a1a"}]},oilFieldSite:{name:"Oil Field Site",category:"oil",description:"Large-scale oil production facility with drilling, pumps, processing and storage",blocks:[...L(0,0,0,18,16,"#8B7355"),...L(0,0,7,4,2,"#404040"),...L(1,0,1,4,4,"#606060"),{type:"iBeam",position:{x:1,y:1,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:2,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:3,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:4,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:5,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:6,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:1,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:2,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:3,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:4,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:5,z:1},color:"#8B0000"},{type:"iBeam",position:{x:4,y:6,z:1},color:"#8B0000"},{type:"iBeam",position:{x:1,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:4,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:5,z:4},color:"#8B0000"},{type:"iBeam",position:{x:1,y:6,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:1,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:2,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:3,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:4,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:5,z:4},color:"#8B0000"},{type:"iBeam",position:{x:4,y:6,z:4},color:"#8B0000"},{type:"beamX",position:{x:2,y:2,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:2,z:1},color:"#B22222"},{type:"beamX",position:{x:2,y:4,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:4,z:1},color:"#B22222"},{type:"beamX",position:{x:2,y:6,z:1},color:"#B22222"},{type:"beamX",position:{x:3,y:6,z:1},color:"#B22222"},{type:"beamX",position:{x:2,y:2,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:2,z:4},color:"#B22222"},{type:"beamX",position:{x:2,y:4,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:4,z:4},color:"#B22222"},{type:"beamX",position:{x:2,y:6,z:4},color:"#B22222"},{type:"beamX",position:{x:3,y:6,z:4},color:"#B22222"},{type:"beamZ",position:{x:1,y:2,z:2},color:"#B22222"},{type:"beamZ",position:{x:1,y:2,z:3},color:"#B22222"},{type:"beamZ",position:{x:1,y:4,z:2},color:"#B22222"},{type:"beamZ",position:{x:1,y:4,z:3},color:"#B22222"},{type:"beamZ",position:{x:4,y:2,z:2},color:"#B22222"},{type:"beamZ",position:{x:4,y:2,z:3},color:"#B22222"},{type:"beamZ",position:{x:4,y:4,z:2},color:"#B22222"},{type:"beamZ",position:{x:4,y:4,z:3},color:"#B22222"},{type:"grateFloor",position:{x:2,y:7,z:2},color:"#404040"},{type:"grateFloor",position:{x:3,y:7,z:2},color:"#404040"},{type:"grateFloor",position:{x:2,y:7,z:3},color:"#404040"},{type:"grateFloor",position:{x:3,y:7,z:3},color:"#404040"},{type:"wellHead",position:{x:2,y:0,z:2},color:"#B22222"},{type:"wellHead",position:{x:3,y:0,z:2},color:"#B22222"},{type:"wellHead",position:{x:2,y:0,z:3},color:"#B22222"},{type:"wellHead",position:{x:3,y:0,z:3},color:"#B22222"},{type:"pipeY",position:{x:2,y:1,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:2,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:3,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:4,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:5,z:2},color:"#708090"},{type:"pipeY",position:{x:2,y:6,z:2},color:"#708090"},{type:"tank",position:{x:0,y:0,z:5},color:"#2F4F4F"},{type:"tank",position:{x:0,y:1,z:5},color:"#2F4F4F"},{type:"tank",position:{x:0,y:0,z:6},color:"#4A6B4A"},{type:"tank",position:{x:0,y:1,z:6},color:"#4A6B4A"},{type:"slab",position:{x:6,y:0,z:2},color:"#606060"},{type:"slab",position:{x:7,y:0,z:2},color:"#606060"},{type:"pumpJack",position:{x:6,y:0,z:2},color:"#CD5C5C"},{type:"wellHead",position:{x:7,y:0,z:2},color:"#505050"},{type:"slab",position:{x:6,y:0,z:5},color:"#606060"},{type:"slab",position:{x:7,y:0,z:5},color:"#606060"},{type:"pumpJack",position:{x:6,y:0,z:5},color:"#B22222"},{type:"wellHead",position:{x:7,y:0,z:5},color:"#505050"},{type:"slab",position:{x:6,y:0,z:10},color:"#606060"},{type:"slab",position:{x:7,y:0,z:10},color:"#606060"},{type:"pumpJack",position:{x:6,y:0,z:10},color:"#CD5C5C"},{type:"wellHead",position:{x:7,y:0,z:10},color:"#505050"},{type:"slab",position:{x:6,y:0,z:13},color:"#606060"},{type:"slab",position:{x:7,y:0,z:13},color:"#606060"},{type:"pumpJack",position:{x:6,y:0,z:13},color:"#B22222"},{type:"wellHead",position:{x:7,y:0,z:13},color:"#505050"},...L(9,0,1,4,5,"#707070"),{type:"oilTank",position:{x:10,y:0,z:2},color:"#708090"},{type:"oilTank",position:{x:10,y:0,z:4},color:"#708090"},{type:"tank",position:{x:12,y:0,z:2},color:"#505050"},{type:"tank",position:{x:12,y:1,z:2},color:"#505050"},{type:"pipeY",position:{x:12,y:2,z:2},color:"#2F2F2F"},{type:"pipeX",position:{x:11,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:11,y:0,z:2},color:"#708090"},{type:"pipeZ",position:{x:11,y:0,z:4},color:"#708090"},{type:"valve",position:{x:11,y:0,z:3},color:"#B22222"},{type:"pipeY",position:{x:17,y:0,z:1},color:"#505050"},{type:"pipeY",position:{x:17,y:1,z:1},color:"#505050"},{type:"pipeY",position:{x:17,y:2,z:1},color:"#505050"},{type:"pipeY",position:{x:17,y:3,z:1},color:"#505050"},{type:"pipeY",position:{x:17,y:4,z:1},color:"#505050"},{type:"cone",position:{x:17,y:5,z:1},color:"#FF4500"},...L(13,0,7,5,6,"#707070"),{type:"tank",position:{x:14,y:0,z:8},color:"#E8E8E8"},{type:"tank",position:{x:14,y:1,z:8},color:"#E8E8E8"},{type:"tank",position:{x:14,y:2,z:8},color:"#E8E8E8"},{type:"tank",position:{x:16,y:0,z:8},color:"#E8E8E8"},{type:"tank",position:{x:16,y:1,z:8},color:"#E8E8E8"},{type:"tank",position:{x:16,y:2,z:8},color:"#E8E8E8"},{type:"tank",position:{x:14,y:0,z:11},color:"#C0C0C0"},{type:"tank",position:{x:14,y:1,z:11},color:"#C0C0C0"},{type:"tank",position:{x:14,y:2,z:11},color:"#C0C0C0"},{type:"tank",position:{x:16,y:0,z:11},color:"#C0C0C0"},{type:"tank",position:{x:16,y:1,z:11},color:"#C0C0C0"},{type:"tank",position:{x:16,y:2,z:11},color:"#C0C0C0"},{type:"stairs",position:{x:15,y:0,z:8},color:"#FFD700"},{type:"stairs",position:{x:15,y:1,z:8},color:"#FFD700"},{type:"oilTankSmall",position:{x:13,y:0,z:8},color:"#4682B4"},{type:"oilTankSmall",position:{x:13,y:0,z:11},color:"#4682B4"},{type:"pipeX",position:{x:8,y:0,z:2},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:5},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:9,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:10},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:13},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:11},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:12},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:6},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:7},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:8},color:"#708090"},{type:"pipeZ",position:{x:8,y:0,z:9},color:"#708090"},{type:"pipeX",position:{x:13,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:13,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:13,y:0,z:5},color:"#708090"},{type:"pipeZ",position:{x:13,y:0,z:6},color:"#708090"},{type:"pipeZ",position:{x:13,y:0,z:7},color:"#708090"},{type:"valve",position:{x:8,y:0,z:2},color:"#B22222"},{type:"valve",position:{x:8,y:0,z:5},color:"#B22222"},{type:"valve",position:{x:8,y:0,z:10},color:"#B22222"},{type:"valve",position:{x:8,y:0,z:13},color:"#B22222"},{type:"valve",position:{x:13,y:0,z:3},color:"#FF4500"},...L(1,0,10,4,4,"#808080"),...yt(1,1,10,4,4,"#F5F5DC"),...yt(1,2,10,4,4,"#F5F5DC"),...L(1,3,10,4,4,"#696969"),{type:"doorFrame",position:{x:2,y:1,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:3,y:2,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:1,y:2,z:11},color:"#8B4513"},{type:"windowFrame",position:{x:4,y:2,z:12},color:"#8B4513"},{type:"acUnit",position:{x:3,y:3,z:12},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:3,z:10},color:"#505050"},...L(1,0,14,3,2,"#505050"),{type:"cube",position:{x:1,y:1,z:14},color:"#2F4F4F"},{type:"cube",position:{x:2,y:1,z:14},color:"#2F4F4F"},{type:"cube",position:{x:1,y:1,z:15},color:"#2F4F4F"},{type:"cube",position:{x:2,y:1,z:15},color:"#2F4F4F"},{type:"pipeY",position:{x:1,y:2,z:14},color:"#2F2F2F"},{type:"transformer",position:{x:3,y:0,z:14},color:"#505050"},{type:"powerBox",position:{x:3,y:0,z:15},color:"#2F4F4F"},{type:"oilBarrel",position:{x:10,y:0,z:13},color:"#1a1a1a"},{type:"oilBarrel",position:{x:11,y:0,z:13},color:"#1a1a1a"},{type:"oilBarrel",position:{x:12,y:0,z:13},color:"#B22222"},{type:"oilBarrel",position:{x:10,y:0,z:14},color:"#2F4F4F"},{type:"oilBarrel",position:{x:11,y:0,z:14},color:"#1a1a1a"},{type:"oilBarrel",position:{x:12,y:0,z:14},color:"#4682B4"},{type:"oilBarrel",position:{x:10,y:1,z:13},color:"#B22222"},{type:"oilBarrel",position:{x:11,y:1,z:13},color:"#1a1a1a"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:17,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:15},color:"#FFD700"},{type:"barrier",position:{x:17,y:0,z:15},color:"#FFD700"},{type:"barrier",position:{x:5,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:12,y:0,z:0},color:"#FFD700"},{type:"trafficCone",position:{x:5,y:0,z:3},color:"#FF6600"},{type:"trafficCone",position:{x:5,y:0,z:6},color:"#FF6600"},{type:"trafficCone",position:{x:5,y:0,z:9},color:"#FF6600"},{type:"trafficCone",position:{x:5,y:0,z:12},color:"#FF6600"},{type:"sign",position:{x:0,y:0,z:7},color:"#FFD700"},{type:"sign",position:{x:9,y:0,z:0},color:"#FFD700"},{type:"lightFixture",position:{x:5,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:12,y:0,z:0},color:"#FFFF99"},{type:"spotlight",position:{x:1,y:4,z:1},color:"#FFFF99"},{type:"spotlight",position:{x:4,y:4,z:4},color:"#FFFF99"},{type:"fence",position:{x:13,y:0,z:13},color:"#8B8B8B"},{type:"fence",position:{x:14,y:0,z:13},color:"#8B8B8B"},{type:"fence",position:{x:15,y:0,z:13},color:"#8B8B8B"},{type:"fence",position:{x:16,y:0,z:13},color:"#8B8B8B"},{type:"fence",position:{x:17,y:0,z:13},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:7},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:8},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:9},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:10},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:11},color:"#8B8B8B"},{type:"fenceZ",position:{x:17,y:0,z:12},color:"#8B8B8B"}]},offshorePlatform:{name:"Offshore Oil Platform",category:"oil",description:"Deep-water oil platform with helideck, crane, and living quarters",blocks:[...L(0,0,0,16,14,"#1E4D6B"),{type:"pillar",position:{x:2,y:0,z:2},color:"#505050"},{type:"pillar",position:{x:2,y:1,z:2},color:"#505050"},{type:"pillar",position:{x:2,y:2,z:2},color:"#505050"},{type:"pillar",position:{x:3,y:0,z:2},color:"#505050"},{type:"pillar",position:{x:3,y:1,z:2},color:"#505050"},{type:"pillar",position:{x:3,y:2,z:2},color:"#505050"},{type:"pillar",position:{x:2,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:2,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:2,y:2,z:3},color:"#505050"},{type:"pillar",position:{x:3,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:3,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:3,y:2,z:3},color:"#505050"},{type:"pillar",position:{x:12,y:0,z:2},color:"#505050"},{type:"pillar",position:{x:12,y:1,z:2},color:"#505050"},{type:"pillar",position:{x:12,y:2,z:2},color:"#505050"},{type:"pillar",position:{x:13,y:0,z:2},color:"#505050"},{type:"pillar",position:{x:13,y:1,z:2},color:"#505050"},{type:"pillar",position:{x:13,y:2,z:2},color:"#505050"},{type:"pillar",position:{x:12,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:12,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:12,y:2,z:3},color:"#505050"},{type:"pillar",position:{x:13,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:13,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:13,y:2,z:3},color:"#505050"},{type:"pillar",position:{x:2,y:0,z:10},color:"#505050"},{type:"pillar",position:{x:2,y:1,z:10},color:"#505050"},{type:"pillar",position:{x:2,y:2,z:10},color:"#505050"},{type:"pillar",position:{x:3,y:0,z:10},color:"#505050"},{type:"pillar",position:{x:3,y:1,z:10},color:"#505050"},{type:"pillar",position:{x:3,y:2,z:10},color:"#505050"},{type:"pillar",position:{x:2,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:2,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:2,y:2,z:11},color:"#505050"},{type:"pillar",position:{x:3,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:3,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:3,y:2,z:11},color:"#505050"},{type:"pillar",position:{x:12,y:0,z:10},color:"#505050"},{type:"pillar",position:{x:12,y:1,z:10},color:"#505050"},{type:"pillar",position:{x:12,y:2,z:10},color:"#505050"},{type:"pillar",position:{x:13,y:0,z:10},color:"#505050"},{type:"pillar",position:{x:13,y:1,z:10},color:"#505050"},{type:"pillar",position:{x:13,y:2,z:10},color:"#505050"},{type:"pillar",position:{x:12,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:12,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:12,y:2,z:11},color:"#505050"},{type:"pillar",position:{x:13,y:0,z:11},color:"#505050"},{type:"pillar",position:{x:13,y:1,z:11},color:"#505050"},{type:"pillar",position:{x:13,y:2,z:11},color:"#505050"},...L(1,3,1,14,12,"#707070"),...L(5,3,5,4,4,"#606060"),{type:"iBeam",position:{x:5,y:4,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:5,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:6,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:7,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:8,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:4,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:5,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:6,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:7,z:5},color:"#8B0000"},{type:"iBeam",position:{x:8,y:8,z:5},color:"#8B0000"},{type:"iBeam",position:{x:5,y:4,z:8},color:"#8B0000"},{type:"iBeam",position:{x:5,y:5,z:8},color:"#8B0000"},{type:"iBeam",position:{x:5,y:6,z:8},color:"#8B0000"},{type:"iBeam",position:{x:5,y:7,z:8},color:"#8B0000"},{type:"iBeam",position:{x:5,y:8,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:4,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:5,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:6,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:7,z:8},color:"#8B0000"},{type:"iBeam",position:{x:8,y:8,z:8},color:"#8B0000"},{type:"beamX",position:{x:6,y:5,z:5},color:"#B22222"},{type:"beamX",position:{x:7,y:5,z:5},color:"#B22222"},{type:"beamX",position:{x:6,y:7,z:5},color:"#B22222"},{type:"beamX",position:{x:7,y:7,z:5},color:"#B22222"},{type:"beamX",position:{x:6,y:5,z:8},color:"#B22222"},{type:"beamX",position:{x:7,y:5,z:8},color:"#B22222"},{type:"beamX",position:{x:6,y:7,z:8},color:"#B22222"},{type:"beamX",position:{x:7,y:7,z:8},color:"#B22222"},{type:"beamZ",position:{x:5,y:5,z:6},color:"#B22222"},{type:"beamZ",position:{x:5,y:5,z:7},color:"#B22222"},{type:"beamZ",position:{x:5,y:7,z:6},color:"#B22222"},{type:"beamZ",position:{x:5,y:7,z:7},color:"#B22222"},{type:"beamZ",position:{x:8,y:5,z:6},color:"#B22222"},{type:"beamZ",position:{x:8,y:5,z:7},color:"#B22222"},{type:"beamZ",position:{x:8,y:7,z:6},color:"#B22222"},{type:"beamZ",position:{x:8,y:7,z:7},color:"#B22222"},{type:"grateFloor",position:{x:6,y:9,z:6},color:"#404040"},{type:"grateFloor",position:{x:7,y:9,z:6},color:"#404040"},{type:"grateFloor",position:{x:6,y:9,z:7},color:"#404040"},{type:"grateFloor",position:{x:7,y:9,z:7},color:"#404040"},{type:"wellHead",position:{x:6,y:3,z:6},color:"#B22222"},{type:"wellHead",position:{x:7,y:3,z:7},color:"#B22222"},{type:"pipeY",position:{x:6,y:4,z:6},color:"#708090"},{type:"pipeY",position:{x:6,y:5,z:6},color:"#708090"},{type:"pipeY",position:{x:6,y:6,z:6},color:"#708090"},{type:"pipeY",position:{x:6,y:7,z:6},color:"#708090"},{type:"pipeY",position:{x:6,y:8,z:6},color:"#708090"},...L(10,3,1,4,4,"#2F4F2F"),{type:"slab",position:{x:11,y:3,z:2},color:"#FFFFFF"},{type:"slab",position:{x:12,y:3,z:2},color:"#FFFFFF"},{type:"slab",position:{x:11,y:3,z:3},color:"#FFFFFF"},{type:"slab",position:{x:12,y:3,z:3},color:"#FFFFFF"},{type:"lightFixture",position:{x:10,y:3,z:1},color:"#FF0000"},{type:"lightFixture",position:{x:13,y:3,z:1},color:"#FF0000"},{type:"lightFixture",position:{x:10,y:3,z:4},color:"#FF0000"},{type:"lightFixture",position:{x:13,y:3,z:4},color:"#FF0000"},...L(1,3,1,3,4,"#808080"),...yt(1,4,1,3,4,"#F5F5DC"),...yt(1,5,1,3,4,"#F5F5DC"),...L(1,6,1,3,4,"#696969"),{type:"doorFrame",position:{x:2,y:4,z:4},color:"#8B4513"},{type:"windowFrame",position:{x:1,y:5,z:1},color:"#8B4513"},{type:"windowFrame",position:{x:3,y:5,z:1},color:"#8B4513"},{type:"windowFrame",position:{x:1,y:5,z:3},color:"#8B4513"},{type:"acUnit",position:{x:2,y:6,z:3},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:6,z:1},color:"#505050"},{type:"cylinder",position:{x:14,y:3,z:7},color:"#FFD700"},{type:"pillar",position:{x:14,y:4,z:7},color:"#FFD700"},{type:"pillar",position:{x:14,y:5,z:7},color:"#FFD700"},{type:"pillar",position:{x:14,y:6,z:7},color:"#FFD700"},{type:"beamZ",position:{x:14,y:6,z:5},color:"#FFD700"},{type:"beamZ",position:{x:14,y:6,z:6},color:"#FFD700"},{type:"beamZ",position:{x:14,y:6,z:8},color:"#FFD700"},{type:"beamZ",position:{x:14,y:6,z:9},color:"#FFD700"},{type:"chain",position:{x:14,y:5,z:5},color:"#505050"},{type:"oilTank",position:{x:10,y:3,z:6},color:"#708090"},{type:"oilTank",position:{x:10,y:3,z:8},color:"#708090"},{type:"oilTankSmall",position:{x:10,y:3,z:10},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:11,y:3,z:10},color:"#4682B4"},{type:"pipeX",position:{x:9,y:3,z:7},color:"#708090"},{type:"pipeZ",position:{x:9,y:3,z:8},color:"#708090"},{type:"pipeZ",position:{x:9,y:3,z:9},color:"#708090"},{type:"valve",position:{x:9,y:3,z:7},color:"#B22222"},{type:"beamX",position:{x:0,y:3,z:7},color:"#505050"},{type:"pipeY",position:{x:0,y:4,z:7},color:"#505050"},{type:"pipeY",position:{x:0,y:5,z:7},color:"#505050"},{type:"cone",position:{x:0,y:6,z:7},color:"#FF4500"},{type:"hull",position:{x:1,y:3,z:10},color:"#FF6600"},{type:"hull",position:{x:1,y:3,z:12},color:"#FF6600"},{type:"railing",position:{x:1,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:2,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:3,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:4,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:5,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:6,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:7,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:8,y:3,z:0},color:"#FFD700"},{type:"railing",position:{x:9,y:3,z:0},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:1},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:2},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:3},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:4},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:5},color:"#FFD700"},{type:"railingZ",position:{x:0,y:3,z:6},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:6},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:7},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:8},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:9},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:10},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:11},color:"#FFD700"},{type:"railingZ",position:{x:15,y:3,z:12},color:"#FFD700"},{type:"spotlight",position:{x:5,y:6,z:5},color:"#FFFF99"},{type:"spotlight",position:{x:8,y:6,z:8},color:"#FFFF99"},{type:"lightFixture",position:{x:14,y:3,z:12},color:"#FFFF99"}]},oilRefinery:{name:"Oil Refinery",category:"oil",description:"Petroleum refinery with distillation columns, cooling towers, and storage",blocks:[...L(0,0,0,18,14,"#707070"),...L(1,0,1,5,6,"#606060"),{type:"tank",position:{x:2,y:0,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:1,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:2,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:3,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:4,z:2},color:"#C0C0C0"},{type:"tank",position:{x:2,y:5,z:2},color:"#C0C0C0"},{type:"dome",position:{x:2,y:6,z:2},color:"#C0C0C0"},{type:"tank",position:{x:4,y:0,z:2},color:"#B0B0B0"},{type:"tank",position:{x:4,y:1,z:2},color:"#B0B0B0"},{type:"tank",position:{x:4,y:2,z:2},color:"#B0B0B0"},{type:"tank",position:{x:4,y:3,z:2},color:"#B0B0B0"},{type:"tank",position:{x:4,y:4,z:2},color:"#B0B0B0"},{type:"dome",position:{x:4,y:5,z:2},color:"#B0B0B0"},{type:"tank",position:{x:2,y:0,z:5},color:"#A0A0A0"},{type:"tank",position:{x:2,y:1,z:5},color:"#A0A0A0"},{type:"tank",position:{x:2,y:2,z:5},color:"#A0A0A0"},{type:"tank",position:{x:2,y:3,z:5},color:"#A0A0A0"},{type:"dome",position:{x:2,y:4,z:5},color:"#A0A0A0"},{type:"tank",position:{x:4,y:0,z:5},color:"#909090"},{type:"tank",position:{x:4,y:1,z:5},color:"#909090"},{type:"tank",position:{x:4,y:2,z:5},color:"#909090"},{type:"dome",position:{x:4,y:3,z:5},color:"#909090"},{type:"pillar2",position:{x:3,y:0,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:2},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:0,z:5},color:"#4A4A4A"},{type:"pillar2",position:{x:3,y:1,z:5},color:"#4A4A4A"},{type:"catwalk",position:{x:3,y:2,z:2},color:"#404040"},{type:"catwalk",position:{x:3,y:2,z:3},color:"#404040"},{type:"catwalk",position:{x:3,y:2,z:4},color:"#404040"},{type:"catwalk",position:{x:3,y:2,z:5},color:"#404040"},{type:"stairs",position:{x:1,y:0,z:3},color:"#FFD700"},{type:"stairs",position:{x:1,y:1,z:3},color:"#FFD700"},{type:"pipeZ",position:{x:3,y:1,z:3},color:"#708090"},{type:"pipeZ",position:{x:3,y:1,z:4},color:"#708090"},{type:"pipeX",position:{x:3,y:3,z:2},color:"#708090"},{type:"valve",position:{x:3,y:3,z:2},color:"#B22222"},...L(7,0,1,4,4,"#505050"),{type:"cylinder",position:{x:8,y:0,z:2},color:"#808080"},{type:"cylinder",position:{x:8,y:1,z:2},color:"#808080"},{type:"cylinder",position:{x:8,y:2,z:2},color:"#909090"},{type:"cylinder",position:{x:8,y:3,z:2},color:"#A0A0A0"},{type:"cylinder",position:{x:8,y:0,z:4},color:"#808080"},{type:"cylinder",position:{x:8,y:1,z:4},color:"#808080"},{type:"cylinder",position:{x:8,y:2,z:4},color:"#909090"},{type:"cylinder",position:{x:8,y:3,z:4},color:"#A0A0A0"},{type:"pipeZ",position:{x:7,y:0,z:2},color:"#4682B4"},{type:"pipeZ",position:{x:7,y:0,z:3},color:"#4682B4"},{type:"pipeZ",position:{x:7,y:0,z:4},color:"#4682B4"},...L(12,0,1,6,6,"#606060"),{type:"tank",position:{x:13,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:13,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:13,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:16,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:16,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:16,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:13,y:0,z:5},color:"#D8D8D8"},{type:"tank",position:{x:13,y:1,z:5},color:"#D8D8D8"},{type:"tank",position:{x:13,y:2,z:5},color:"#D8D8D8"},{type:"tank",position:{x:16,y:0,z:5},color:"#D8D8D8"},{type:"tank",position:{x:16,y:1,z:5},color:"#D8D8D8"},{type:"tank",position:{x:16,y:2,z:5},color:"#D8D8D8"},{type:"stairs",position:{x:14,y:0,z:2},color:"#FFD700"},{type:"stairs",position:{x:14,y:1,z:2},color:"#FFD700"},{type:"pillar",position:{x:6,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:6,y:1,z:3},color:"#505050"},{type:"pillar",position:{x:11,y:0,z:3},color:"#505050"},{type:"pillar",position:{x:11,y:1,z:3},color:"#505050"},{type:"pipeX",position:{x:5,y:1,z:3},color:"#708090"},{type:"pipeX",position:{x:6,y:1,z:3},color:"#708090"},{type:"pipeX",position:{x:7,y:1,z:3},color:"#2F4F4F"},{type:"pipeX",position:{x:8,y:1,z:3},color:"#2F4F4F"},{type:"pipeX",position:{x:9,y:1,z:3},color:"#4682B4"},{type:"pipeX",position:{x:10,y:1,z:3},color:"#4682B4"},{type:"pipeX",position:{x:11,y:1,z:3},color:"#708090"},{type:"pipeX",position:{x:12,y:1,z:3},color:"#708090"},{type:"pillar",position:{x:0,y:0,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:1,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:2,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:3,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:4,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:5,z:7},color:"#505050"},{type:"pillar",position:{x:0,y:6,z:7},color:"#505050"},{type:"cone",position:{x:0,y:7,z:7},color:"#FF4500"},{type:"oilTank",position:{x:1,y:0,z:8},color:"#708090"},{type:"pipeX",position:{x:0,y:0,z:8},color:"#505050"},...L(1,0,10,5,4,"#808080"),...yt(1,1,10,5,4,"#F5F5DC"),...yt(1,2,10,5,4,"#F5F5DC"),...L(1,3,10,5,4,"#696969"),{type:"doorFrame",position:{x:3,y:1,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:2,y:2,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:4,y:2,z:10},color:"#8B4513"},{type:"windowFrame",position:{x:1,y:2,z:12},color:"#8B4513"},{type:"windowFrame",position:{x:5,y:2,z:12},color:"#8B4513"},{type:"acUnit",position:{x:3,y:3,z:12},color:"#C0C0C0"},{type:"antenna",position:{x:1,y:3,z:10},color:"#505050"},...L(8,0,9,6,5,"#404040"),{type:"pipeY",position:{x:9,y:0,z:11},color:"#708090"},{type:"pipeY",position:{x:9,y:1,z:11},color:"#708090"},{type:"pipeElbowXY",position:{x:9,y:2,z:11},color:"#708090"},{type:"pipeY",position:{x:12,y:0,z:11},color:"#708090"},{type:"pipeY",position:{x:12,y:1,z:11},color:"#708090"},{type:"pipeElbowXY",position:{x:12,y:2,z:11},color:"#708090"},{type:"valve",position:{x:9,y:1,z:11},color:"#FFD700"},{type:"valve",position:{x:12,y:1,z:11},color:"#FFD700"},{type:"oilTankSmall",position:{x:15,y:0,z:9},color:"#B22222"},{type:"oilTankSmall",position:{x:16,y:0,z:9},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:17,y:0,z:9},color:"#4A6B4A"},{type:"oilTankSmall",position:{x:15,y:0,z:11},color:"#B8860B"},{type:"oilTankSmall",position:{x:16,y:0,z:11},color:"#4682B4"},{type:"oilTankSmall",position:{x:17,y:0,z:11},color:"#1a1a1a"},{type:"transformer",position:{x:15,y:0,z:13},color:"#505050"},{type:"transformer",position:{x:16,y:0,z:13},color:"#505050"},{type:"powerBox",position:{x:17,y:0,z:13},color:"#2F4F4F"},{type:"conduitX",position:{x:14,y:0,z:13},color:"#505050"},{type:"conduitX",position:{x:13,y:0,z:13},color:"#505050"},{type:"barrier",position:{x:0,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:17,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:13},color:"#FFD700"},{type:"barrier",position:{x:7,y:0,z:13},color:"#FFD700"},{type:"trafficCone",position:{x:8,y:0,z:8},color:"#FF6600"},{type:"trafficCone",position:{x:13,y:0,z:8},color:"#FF6600"},{type:"sign",position:{x:6,y:0,z:0},color:"#FFD700"},{type:"sign",position:{x:11,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:6,y:0,z:6},color:"#B22222"},{type:"pipeY",position:{x:11,y:0,z:6},color:"#B22222"},{type:"lightFixture",position:{x:3,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:9,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:15,y:0,z:0},color:"#FFFF99"},{type:"spotlight",position:{x:2,y:4,z:2},color:"#FFFF99"},{type:"spotlight",position:{x:4,y:3,z:5},color:"#FFFF99"}]},tankerLoadingStation:{name:"Tanker Loading Station",category:"oil",description:"Truck and rail tanker loading facility with metering and safety systems",blocks:[...L(0,0,0,14,10,"#707070"),...L(0,0,4,3,2,"#404040"),...L(3,0,1,8,4,"#505050"),{type:"pillar",position:{x:4,y:0,z:1},color:"#606060"},{type:"pillar",position:{x:4,y:1,z:1},color:"#606060"},{type:"pillar",position:{x:4,y:2,z:1},color:"#606060"},{type:"pillar",position:{x:4,y:0,z:4},color:"#606060"},{type:"pillar",position:{x:4,y:1,z:4},color:"#606060"},{type:"pillar",position:{x:4,y:2,z:4},color:"#606060"},{type:"beamZ",position:{x:4,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:4,y:3,z:3},color:"#505050"},{type:"pipeY",position:{x:4,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:4,y:1,z:2},color:"#708090"},{type:"pipeElbowXY",position:{x:4,y:2,z:2},color:"#708090"},{type:"valve",position:{x:4,y:1,z:2},color:"#B22222"},{type:"pillar",position:{x:7,y:0,z:1},color:"#606060"},{type:"pillar",position:{x:7,y:1,z:1},color:"#606060"},{type:"pillar",position:{x:7,y:2,z:1},color:"#606060"},{type:"pillar",position:{x:7,y:0,z:4},color:"#606060"},{type:"pillar",position:{x:7,y:1,z:4},color:"#606060"},{type:"pillar",position:{x:7,y:2,z:4},color:"#606060"},{type:"beamZ",position:{x:7,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:7,y:3,z:3},color:"#505050"},{type:"pipeY",position:{x:7,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:7,y:1,z:2},color:"#708090"},{type:"pipeElbowXY",position:{x:7,y:2,z:2},color:"#708090"},{type:"valve",position:{x:7,y:1,z:2},color:"#B22222"},{type:"pillar",position:{x:10,y:0,z:1},color:"#606060"},{type:"pillar",position:{x:10,y:1,z:1},color:"#606060"},{type:"pillar",position:{x:10,y:2,z:1},color:"#606060"},{type:"pillar",position:{x:10,y:0,z:4},color:"#606060"},{type:"pillar",position:{x:10,y:1,z:4},color:"#606060"},{type:"pillar",position:{x:10,y:2,z:4},color:"#606060"},{type:"beamZ",position:{x:10,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:10,y:3,z:3},color:"#505050"},{type:"pipeY",position:{x:10,y:0,z:2},color:"#708090"},{type:"pipeY",position:{x:10,y:1,z:2},color:"#708090"},{type:"pipeElbowXY",position:{x:10,y:2,z:2},color:"#708090"},{type:"valve",position:{x:10,y:1,z:2},color:"#B22222"},{type:"slab",position:{x:4,y:3,z:1},color:"#404040"},{type:"slab",position:{x:5,y:3,z:1},color:"#404040"},{type:"slab",position:{x:6,y:3,z:1},color:"#404040"},{type:"slab",position:{x:7,y:3,z:1},color:"#404040"},{type:"slab",position:{x:8,y:3,z:1},color:"#404040"},{type:"slab",position:{x:9,y:3,z:1},color:"#404040"},{type:"slab",position:{x:10,y:3,z:1},color:"#404040"},{type:"slab",position:{x:4,y:3,z:4},color:"#404040"},{type:"slab",position:{x:5,y:3,z:4},color:"#404040"},{type:"slab",position:{x:6,y:3,z:4},color:"#404040"},{type:"slab",position:{x:7,y:3,z:4},color:"#404040"},{type:"slab",position:{x:8,y:3,z:4},color:"#404040"},{type:"slab",position:{x:9,y:3,z:4},color:"#404040"},{type:"slab",position:{x:10,y:3,z:4},color:"#404040"},...L(3,0,5,4,2,"#606060"),{type:"cylinder",position:{x:4,y:0,z:5},color:"#2F4F4F"},{type:"cylinder",position:{x:5,y:0,z:5},color:"#2F4F4F"},{type:"cylinder",position:{x:4,y:0,z:6},color:"#2F4F4F"},{type:"cylinder",position:{x:5,y:0,z:6},color:"#2F4F4F"},{type:"valve",position:{x:4,y:0,z:5},color:"#FFD700"},{type:"valve",position:{x:5,y:0,z:6},color:"#FFD700"},{type:"pipeZ",position:{x:4,y:0,z:4},color:"#708090"},{type:"pipeZ",position:{x:4,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:5,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:6,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:3},color:"#708090"},{type:"pipeX",position:{x:9,y:0,z:3},color:"#708090"},{type:"oilTankSmall",position:{x:8,y:0,z:6},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:9,y:0,z:6},color:"#2F4F4F"},{type:"oilTankSmall",position:{x:10,y:0,z:6},color:"#4A6B4A"},{type:"tank",position:{x:12,y:0,z:2},color:"#E8E8E8"},{type:"tank",position:{x:12,y:1,z:2},color:"#E8E8E8"},{type:"tank",position:{x:12,y:2,z:2},color:"#E8E8E8"},{type:"tank",position:{x:12,y:0,z:5},color:"#C0C0C0"},{type:"tank",position:{x:12,y:1,z:5},color:"#C0C0C0"},{type:"tank",position:{x:12,y:2,z:5},color:"#C0C0C0"},{type:"pipeZ",position:{x:11,y:0,z:3},color:"#708090"},{type:"pipeZ",position:{x:11,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:10,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:9,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:8,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:7,y:0,z:4},color:"#708090"},{type:"pipeX",position:{x:6,y:0,z:4},color:"#708090"},{type:"valve",position:{x:11,y:0,z:3},color:"#B22222"},{type:"valve",position:{x:11,y:0,z:4},color:"#B22222"},{type:"cube",position:{x:1,y:0,z:1},color:"#F5F5DC"},{type:"cube",position:{x:2,y:0,z:1},color:"#F5F5DC"},{type:"cube",position:{x:1,y:0,z:2},color:"#F5F5DC"},{type:"cube",position:{x:2,y:0,z:2},color:"#F5F5DC"},{type:"cube",position:{x:1,y:1,z:1},color:"#F5F5DC"},{type:"cube",position:{x:2,y:1,z:1},color:"#F5F5DC"},{type:"cube",position:{x:1,y:1,z:2},color:"#F5F5DC"},{type:"cube",position:{x:2,y:1,z:2},color:"#F5F5DC"},{type:"slab",position:{x:1,y:2,z:1},color:"#696969"},{type:"slab",position:{x:2,y:2,z:1},color:"#696969"},{type:"slab",position:{x:1,y:2,z:2},color:"#696969"},{type:"slab",position:{x:2,y:2,z:2},color:"#696969"},{type:"doorFrame",position:{x:1,y:0,z:1},color:"#8B4513"},{type:"windowFrame",position:{x:2,y:1,z:1},color:"#8B4513"},{type:"acUnit",position:{x:1,y:2,z:2},color:"#C0C0C0"},...L(8,0,8,3,2,"#606060"),{type:"cylinder",position:{x:8,y:0,z:8},color:"#2F4F4F"},{type:"cylinder",position:{x:9,y:0,z:8},color:"#2F4F4F"},{type:"cylinder",position:{x:10,y:0,z:8},color:"#2F4F4F"},{type:"pipeX",position:{x:7,y:0,z:8},color:"#708090"},{type:"pipeX",position:{x:11,y:0,z:8},color:"#708090"},{type:"valve",position:{x:7,y:0,z:8},color:"#FF4500"},{type:"transformer",position:{x:1,y:0,z:8},color:"#505050"},{type:"powerBox",position:{x:2,y:0,z:8},color:"#2F4F4F"},{type:"conduitX",position:{x:3,y:0,z:8},color:"#505050"},{type:"conduitX",position:{x:4,y:0,z:8},color:"#505050"},{type:"conduitX",position:{x:5,y:0,z:8},color:"#505050"},{type:"conduitX",position:{x:6,y:0,z:8},color:"#505050"},{type:"barrier",position:{x:0,y:0,z:3},color:"#FFD700"},{type:"barrier",position:{x:0,y:0,z:6},color:"#FFD700"},{type:"barrier",position:{x:13,y:0,z:0},color:"#FFD700"},{type:"barrier",position:{x:13,y:0,z:9},color:"#FFD700"},{type:"trafficCone",position:{x:3,y:0,z:2},color:"#FF6600"},{type:"trafficCone",position:{x:3,y:0,z:3},color:"#FF6600"},{type:"trafficCone",position:{x:11,y:0,z:2},color:"#FF6600"},{type:"trafficCone",position:{x:11,y:0,z:3},color:"#FF6600"},{type:"sign",position:{x:0,y:0,z:4},color:"#FFD700"},{type:"sign",position:{x:6,y:0,z:0},color:"#FFD700"},{type:"pipeY",position:{x:3,y:0,z:1},color:"#B22222"},{type:"pipeY",position:{x:11,y:0,z:1},color:"#B22222"},{type:"drain",position:{x:5,y:0,z:2},color:"#404040"},{type:"drain",position:{x:8,y:0,z:2},color:"#404040"},{type:"grate",position:{x:6,y:0,z:2},color:"#505050"},{type:"grate",position:{x:9,y:0,z:2},color:"#505050"},{type:"beamZ",position:{x:4,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:4,y:3,z:3},color:"#505050"},{type:"beamZ",position:{x:7,y:3,z:2},color:"#505050"},{type:"beamZ",position:{x:7,y:3,z:3},color:"#505050"},{type:"lightFixture",position:{x:4,y:3,z:2},color:"#FFFF99"},{type:"lightFixture",position:{x:7,y:3,z:2},color:"#FFFF99"},{type:"lightFixture",position:{x:10,y:3,z:2},color:"#FFFF99"},{type:"lightFixture",position:{x:0,y:0,z:0},color:"#FFFF99"},{type:"lightFixture",position:{x:13,y:0,z:5},color:"#FFFF99"},{type:"oilBarrel",position:{x:1,y:0,z:6},color:"#1a1a1a"},{type:"oilBarrel",position:{x:2,y:0,z:6},color:"#B22222"},{type:"oilBarrel",position:{x:1,y:0,z:7},color:"#2F4F4F"}]},nexusSpire:{name:"Spine Cathedral",category:"alien",description:"Towering biomechanical spine with ribcage arches and pulsing core",blocks:[...L(-3,0,-3,7,7,"#1a1a1a"),{type:"sphere",position:{x:-2,y:0,z:-2},color:"#0D4D4D"},{type:"sphere",position:{x:2,y:0,z:-2},color:"#0D4D4D"},{type:"sphere",position:{x:-2,y:0,z:2},color:"#0D4D4D"},{type:"sphere",position:{x:2,y:0,z:2},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:1,z:0},color:"#2a2a2a"},{type:"torus",position:{x:0,y:1,z:0},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:2,z:0},color:"#2a2a2a"},{type:"torus",position:{x:0,y:2,z:0},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:3,z:0},color:"#2a2a2a"},{type:"torus",position:{x:0,y:3,z:0},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:4,z:0},color:"#2a2a2a"},{type:"torus",position:{x:0,y:4,z:0},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:5,z:0},color:"#2a2a2a"},{type:"torus",position:{x:0,y:5,z:0},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:6,z:0},color:"#2a2a2a"},{type:"arch",position:{x:-2,y:2,z:0},color:"#1A5C5C"},{type:"arch",position:{x:2,y:2,z:0},color:"#1A5C5C"},{type:"arch",position:{x:0,y:2,z:-2},color:"#1A5C5C"},{type:"arch",position:{x:0,y:2,z:2},color:"#1A5C5C"},{type:"pipe",position:{x:-1,y:2,z:-1},color:"#0D4D4D"},{type:"pipe",position:{x:1,y:2,z:-1},color:"#0D4D4D"},{type:"pipe",position:{x:-1,y:2,z:1},color:"#0D4D4D"},{type:"pipe",position:{x:1,y:2,z:1},color:"#0D4D4D"},{type:"arch",position:{x:-2,y:4,z:0},color:"#1A5C5C"},{type:"arch",position:{x:2,y:4,z:0},color:"#1A5C5C"},{type:"arch",position:{x:0,y:4,z:-2},color:"#1A5C5C"},{type:"arch",position:{x:0,y:4,z:2},color:"#1A5C5C"},{type:"pipe",position:{x:-1,y:4,z:-1},color:"#0D4D4D"},{type:"pipe",position:{x:1,y:4,z:-1},color:"#0D4D4D"},{type:"pipe",position:{x:-1,y:4,z:1},color:"#0D4D4D"},{type:"pipe",position:{x:1,y:4,z:1},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:1,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.8,radius:5}},{type:"cylinder",position:{x:0,y:3,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.8,radius:5}},{type:"cylinder",position:{x:0,y:5,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.8,radius:5}},{type:"sphere",position:{x:0,y:7,z:0},color:"#0D4D4D"},{type:"pyramid",position:{x:-1,y:7,z:0},color:"#1A5C5C"},{type:"pyramid",position:{x:1,y:7,z:0},color:"#1A5C5C"},{type:"pyramid",position:{x:0,y:7,z:-1},color:"#1A5C5C"},{type:"pyramid",position:{x:0,y:7,z:1},color:"#1A5C5C"},{type:"crystal",position:{x:0,y:8,z:0},color:"#00FFFF",emissive:{enabled:!0,color:"#00FFFF",intensity:3,radius:8}},{type:"pipe",position:{x:-3,y:3,z:0},color:"#1A5C5C"},{type:"pipe",position:{x:3,y:3,z:0},color:"#1A5C5C"},{type:"pipe",position:{x:0,y:3,z:-3},color:"#1A5C5C"},{type:"pipe",position:{x:0,y:3,z:3},color:"#1A5C5C"},{type:"crystal",position:{x:-3,y:3,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:3}},{type:"crystal",position:{x:3,y:3,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:3}},{type:"crystal",position:{x:0,y:3,z:-3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:3}},{type:"crystal",position:{x:0,y:3,z:3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:3}}]},hiveNode:{name:"Penrose Lattice",category:"alien",description:"Impossible geometry with interlocking stairs and recursive arches",blocks:[...L(-4,0,-4,9,9,"#2a2a2a"),{type:"slab",position:{x:-3,y:0,z:-3},color:"#0D4D4D"},{type:"slab",position:{x:3,y:0,z:-3},color:"#0D4D4D"},{type:"slab",position:{x:-3,y:0,z:3},color:"#0D4D4D"},{type:"slab",position:{x:3,y:0,z:3},color:"#0D4D4D"},{type:"stairsNorth",position:{x:0,y:1,z:-3},color:"#1A5C5C"},{type:"stairsNorth",position:{x:0,y:2,z:-2},color:"#1A5C5C"},{type:"stairsNorth",position:{x:0,y:3,z:-1},color:"#1A5C5C"},{type:"stairsEast",position:{x:1,y:4,z:0},color:"#1A5C5C"},{type:"stairsEast",position:{x:2,y:3,z:0},color:"#1A5C5C"},{type:"stairsEast",position:{x:3,y:2,z:0},color:"#1A5C5C"},{type:"stairsSouth",position:{x:0,y:1,z:3},color:"#1A5C5C"},{type:"stairsSouth",position:{x:0,y:2,z:2},color:"#1A5C5C"},{type:"stairsSouth",position:{x:0,y:3,z:1},color:"#1A5C5C"},{type:"stairsWest",position:{x:-1,y:4,z:0},color:"#1A5C5C"},{type:"stairsWest",position:{x:-2,y:3,z:0},color:"#1A5C5C"},{type:"stairsWest",position:{x:-3,y:2,z:0},color:"#1A5C5C"},{type:"arch",position:{x:-2,y:2,z:0},color:"#2F4F4F"},{type:"arch",position:{x:2,y:2,z:0},color:"#2F4F4F"},{type:"arch",position:{x:0,y:2,z:-2},color:"#2F4F4F"},{type:"arch",position:{x:0,y:2,z:2},color:"#2F4F4F"},{type:"arch",position:{x:-1,y:4,z:-1},color:"#0D4D4D"},{type:"arch",position:{x:1,y:4,z:-1},color:"#0D4D4D"},{type:"arch",position:{x:-1,y:4,z:1},color:"#0D4D4D"},{type:"arch",position:{x:1,y:4,z:1},color:"#0D4D4D"},{type:"torus",position:{x:0,y:3,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:2,radius:6}},{type:"sphere",position:{x:0,y:3,z:0},color:"#00FFFF",emissive:{enabled:!0,color:"#00FFFF",intensity:3,radius:5}},{type:"cylinder",position:{x:-3,y:1,z:-3},color:"#2a2a2a"},{type:"cylinder",position:{x:-3,y:2,z:-3},color:"#2a2a2a"},{type:"cylinder",position:{x:3,y:1,z:-3},color:"#2a2a2a"},{type:"cylinder",position:{x:3,y:2,z:-3},color:"#2a2a2a"},{type:"cylinder",position:{x:-3,y:1,z:3},color:"#2a2a2a"},{type:"cylinder",position:{x:-3,y:2,z:3},color:"#2a2a2a"},{type:"cylinder",position:{x:3,y:1,z:3},color:"#2a2a2a"},{type:"cylinder",position:{x:3,y:2,z:3},color:"#2a2a2a"},{type:"pyramid",position:{x:-3,y:3,z:-3},color:"#0D4D4D"},{type:"crystal",position:{x:-3,y:4,z:-3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:3}},{type:"pyramid",position:{x:3,y:3,z:-3},color:"#0D4D4D"},{type:"crystal",position:{x:3,y:4,z:-3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:3}},{type:"pyramid",position:{x:-3,y:3,z:3},color:"#0D4D4D"},{type:"crystal",position:{x:-3,y:4,z:3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:3}},{type:"pyramid",position:{x:3,y:3,z:3},color:"#0D4D4D"},{type:"crystal",position:{x:3,y:4,z:3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:3}},{type:"pipe",position:{x:-2,y:3,z:-2},color:"#1A5C5C"},{type:"pipe",position:{x:2,y:3,z:-2},color:"#1A5C5C"},{type:"pipe",position:{x:-2,y:3,z:2},color:"#1A5C5C"},{type:"pipe",position:{x:2,y:3,z:2},color:"#1A5C5C"}]},energyPylon:{name:"Bio-Cathedral Generator",category:"alien",description:"Towering biomechanical energy cathedral with nested arches and pulsing conduits",blocks:[...L(-4,0,-4,9,9,"#1a1a1a"),{type:"cylinder",position:{x:-3,y:1,z:-3},color:"#2F4F4F"},{type:"cylinder",position:{x:-3,y:2,z:-3},color:"#2F4F4F"},{type:"torus",position:{x:-3,y:3,z:-3},color:"#0D4D4D"},{type:"crystal",position:{x:-3,y:4,z:-3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:3}},{type:"cylinder",position:{x:3,y:1,z:-3},color:"#2F4F4F"},{type:"cylinder",position:{x:3,y:2,z:-3},color:"#2F4F4F"},{type:"torus",position:{x:3,y:3,z:-3},color:"#0D4D4D"},{type:"crystal",position:{x:3,y:4,z:-3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:3}},{type:"cylinder",position:{x:-3,y:1,z:3},color:"#2F4F4F"},{type:"cylinder",position:{x:-3,y:2,z:3},color:"#2F4F4F"},{type:"torus",position:{x:-3,y:3,z:3},color:"#0D4D4D"},{type:"crystal",position:{x:-3,y:4,z:3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:3}},{type:"cylinder",position:{x:3,y:1,z:3},color:"#2F4F4F"},{type:"cylinder",position:{x:3,y:2,z:3},color:"#2F4F4F"},{type:"torus",position:{x:3,y:3,z:3},color:"#0D4D4D"},{type:"crystal",position:{x:3,y:4,z:3},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:3}},{type:"cylinder",position:{x:0,y:1,z:0},color:"#0D4D4D"},{type:"torus",position:{x:0,y:1,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.8,radius:4}},{type:"cylinder",position:{x:0,y:2,z:0},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:3,z:0},color:"#0D4D4D"},{type:"torus",position:{x:0,y:3,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.8,radius:4}},{type:"cylinder",position:{x:0,y:4,z:0},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:5,z:0},color:"#0D4D4D"},{type:"torus",position:{x:0,y:5,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.8,radius:4}},{type:"cylinder",position:{x:0,y:6,z:0},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:7,z:0},color:"#0D4D4D"},{type:"torus",position:{x:0,y:7,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:2,radius:5}},{type:"cylinder",position:{x:0,y:8,z:0},color:"#0D4D4D"},{type:"cylinder",position:{x:0,y:9,z:0},color:"#0D4D4D"},{type:"torus",position:{x:0,y:9,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:2,radius:5}},{type:"cylinder",position:{x:0,y:10,z:0},color:"#0D4D4D"},{type:"arch",position:{x:-2,y:2,z:0},color:"#1A5C5C"},{type:"arch",position:{x:2,y:2,z:0},color:"#1A5C5C"},{type:"arch",position:{x:0,y:2,z:-2},color:"#1A5C5C"},{type:"arch",position:{x:0,y:2,z:2},color:"#1A5C5C"},{type:"arch",position:{x:-2,y:5,z:0},color:"#2F4F4F"},{type:"arch",position:{x:2,y:5,z:0},color:"#2F4F4F"},{type:"arch",position:{x:0,y:5,z:-2},color:"#2F4F4F"},{type:"arch",position:{x:0,y:5,z:2},color:"#2F4F4F"},{type:"arch",position:{x:-1,y:8,z:0},color:"#1A5C5C"},{type:"arch",position:{x:1,y:8,z:0},color:"#1A5C5C"},{type:"arch",position:{x:0,y:8,z:-1},color:"#1A5C5C"},{type:"arch",position:{x:0,y:8,z:1},color:"#1A5C5C"},{type:"pipe",position:{x:-1,y:3,z:0},color:"#0D4D4D"},{type:"pipe",position:{x:1,y:3,z:0},color:"#0D4D4D"},{type:"pipe",position:{x:0,y:3,z:-1},color:"#0D4D4D"},{type:"pipe",position:{x:0,y:3,z:1},color:"#0D4D4D"},{type:"pipe",position:{x:-2,y:3,z:-2},color:"#0D4D4D"},{type:"pipe",position:{x:2,y:3,z:-2},color:"#0D4D4D"},{type:"pipe",position:{x:-2,y:3,z:2},color:"#0D4D4D"},{type:"pipe",position:{x:2,y:3,z:2},color:"#0D4D4D"},{type:"pipe",position:{x:-1,y:6,z:0},color:"#1A5C5C"},{type:"pipe",position:{x:1,y:6,z:0},color:"#1A5C5C"},{type:"pipe",position:{x:0,y:6,z:-1},color:"#1A5C5C"},{type:"pipe",position:{x:0,y:6,z:1},color:"#1A5C5C"},{type:"sphere",position:{x:0,y:11,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:2.5,radius:8}},{type:"crystal",position:{x:0,y:12,z:0},color:"#00FFFF",emissive:{enabled:!0,color:"#00FFFF",intensity:3,radius:10}},{type:"crystal",position:{x:-1,y:11,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:4}},{type:"crystal",position:{x:1,y:11,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:4}},{type:"crystal",position:{x:0,y:11,z:-1},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:4}},{type:"crystal",position:{x:0,y:11,z:1},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:4}}]},growthChamber:{name:"Growth Chamber",category:"alien",description:"Organic growth pod with membrane-like surfaces",blocks:[{type:"capsule",position:{x:0,y:1,z:0},color:"#1A5C5C"},{type:"capsule",position:{x:1,y:1,z:0},color:"#1A5C5C"},{type:"capsule",position:{x:2,y:1,z:0},color:"#1A5C5C"},{type:"sphere",position:{x:1,y:1,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:4}},{type:"pipe",position:{x:0,y:0,z:0},color:"#2F4F4F"},{type:"pipe",position:{x:2,y:0,z:0},color:"#2F4F4F"},{type:"pipe",position:{x:0,y:1,z:0},color:"#2F4F4F"},{type:"pipe",position:{x:2,y:1,z:0},color:"#2F4F4F"},{type:"pipeY",position:{x:0,y:0,z:0},color:"#0D4D4D"},{type:"pipeY",position:{x:2,y:0,z:0},color:"#0D4D4D"},{type:"crystal",position:{x:0,y:2,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:.8,radius:2}},{type:"crystal",position:{x:1,y:2,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:.8,radius:2}},{type:"crystal",position:{x:2,y:2,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:.8,radius:2}}]},scoutWisp:{name:"Scout Wisp",category:"alien",description:"Tiny floating bio-mechanical scout with energy trail",blocks:[{type:"sphere",position:{x:0,y:1,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:2,radius:3}},{type:"crystal",position:{x:0,y:2,z:0},color:"#00FFFF",emissive:{enabled:!0,color:"#00FFFF",intensity:1.5,radius:2}},{type:"pipe",position:{x:1,y:1,z:0},color:"#1A5C5C"},{type:"pipe",position:{x:-1,y:1,z:0},color:"#1A5C5C"},{type:"pipe",position:{x:0,y:1,z:1},color:"#1A5C5C"},{type:"pipe",position:{x:0,y:1,z:-1},color:"#1A5C5C"},{type:"prism",position:{x:0,y:0,z:0},color:"#0D4D4D"}]},sentinel:{name:"Sentinel",category:"alien",description:"Bio-mechanical guardian with armored plating and weapon nodes",blocks:[{type:"cube",position:{x:0,y:0,z:0},color:"#2F4F4F"},{type:"cube",position:{x:1,y:0,z:0},color:"#2F4F4F"},{type:"cube",position:{x:0,y:0,z:1},color:"#2F4F4F"},{type:"cube",position:{x:1,y:0,z:1},color:"#2F4F4F"},{type:"sphere",position:{x:0,y:1,z:0},color:"#1A5C5C"},{type:"sphere",position:{x:1,y:1,z:0},color:"#1A5C5C"},{type:"sphere",position:{x:0,y:2,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1.8,radius:4}},{type:"crystal",position:{x:-1,y:1,z:0},color:"#00FFFF",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:2}},{type:"crystal",position:{x:2,y:1,z:0},color:"#00FFFF",emissive:{enabled:!0,color:"#00FFFF",intensity:1.2,radius:2}},{type:"wedge",position:{x:0,y:1,z:-1},color:"#0D4D4D"},{type:"wedge",position:{x:1,y:1,z:2},color:"#0D4D4D"},{type:"pipe",position:{x:-1,y:0,z:0},color:"#1A5C5C"},{type:"pipe",position:{x:2,y:0,z:0},color:"#1A5C5C"},{type:"pipe",position:{x:0,y:0,z:-1},color:"#1A5C5C"},{type:"pipe",position:{x:1,y:0,z:2},color:"#1A5C5C"}]},construct:{name:"Construct",category:"alien",description:"Bio-mechanical worker with manipulator appendages",blocks:[{type:"cylinder",position:{x:0,y:1,z:0},color:"#1A5C5C"},{type:"cube",position:{x:0,y:2,z:0},color:"#2F4F4F"},{type:"crystal",position:{x:0,y:3,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:1,radius:2}},{type:"pipe",position:{x:1,y:1,z:0},color:"#0D4D4D"},{type:"prism",position:{x:2,y:1,z:0},color:"#2F4F4F"},{type:"pipe",position:{x:-1,y:1,z:0},color:"#0D4D4D"},{type:"prism",position:{x:-2,y:1,z:0},color:"#2F4F4F"},{type:"sphere",position:{x:2,y:1,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:.8,radius:1}},{type:"sphere",position:{x:-2,y:1,z:0},color:"#00CED1",emissive:{enabled:!0,color:"#00FFFF",intensity:.8,radius:1}},{type:"torus",position:{x:0,y:0,z:0},color:"#0D4D4D"},{type:"sphere",position:{x:0,y:0,z:0},color:"#1A5C5C"}]}};function L(u,t,e,o,i,s){const n=[];for(let r=0;r<o;r++)for(let a=0;a<i;a++)n.push({type:"cube",position:{x:u+r,y:t,z:e+a},color:s});return n}function yt(u,t,e,o,i,s){const n=[];for(let r=0;r<o;r++)for(let a=0;a<i;a++)(r===0||r===o-1||a===0||a===i-1)&&n.push({type:"cube",position:{x:u+r,y:t,z:e+a},color:s});return n}function wt(u,t,e,o,i,s,n){const r=[];for(let a=0;a<o;a++)for(let l=0;l<i;l++)if(a===0||a===o-1||l===0||l===i-1){const p=(a+l)%2===0;r.push({type:"cube",position:{x:u+a,y:t,z:e+l},color:p?n:s})}return r}function at(u,t,e,o,i,s){const n=[];for(let r=0;r<o;r++)for(let a=0;a<i;a++)n.push({type:"cube",position:{x:u+r,y:t+a,z:e},color:s});return n}function st(u,t,e,o,i,s){const n=[];for(let r=0;r<o;r++)for(let a=0;a<i;a++)n.push({type:"cube",position:{x:u,y:t+a,z:e+r},color:s});return n}function J(u,t,e,o,i,s,n){const r=[];for(let a=0;a<o;a++){const l=i==="X"?{x:u+a,y:t,z:e}:{x:u,y:t,z:e+a};r.push({type:s,position:l,color:n})}return r}function bl(){return Object.entries(gl).map(([u,t])=>({id:u,label:t.label,templates:t.templates.map(e=>{var o,i;return{id:e,name:((o=Ji[e])==null?void 0:o.name)||e,description:((i=Ji[e])==null?void 0:i.description)||""}})}))}function zl(u){return Ji[u]||null}function vl(u,t,e,o){const i=[],s=Math.round(o);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++)for(let a=-s;a<=s;a++)n*n+r*r+a*a<=s*s&&i.push({x:Math.floor(u)+n,y:Math.floor(t)+r,z:Math.floor(e)+a});return i}function Fl(u,t,e,o){const i=[],s=Math.floor(o/2);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++)for(let a=-s;a<=s;a++)i.push({x:Math.floor(u)+n,y:Math.floor(t)+r,z:Math.floor(e)+a});return i}function wl(u,t,e,o){const i=[],s=Math.floor(o/2);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++)for(let a=-s;a<=s;a++)(Math.abs(n)===s||Math.abs(r)===s||Math.abs(a)===s)&&i.push({x:Math.floor(u)+n,y:Math.floor(t)+r,z:Math.floor(e)+a});return i}function kl(u,t,e,o,i){const s=[],n=Math.round(o),r=Math.round(i);for(let a=0;a<r;a++)for(let l=-n;l<=n;l++)for(let p=-n;p<=n;p++)l*l+p*p<=n*n&&s.push({x:Math.floor(u)+l,y:Math.floor(t)+a,z:Math.floor(e)+p});return s}function Bl(u,t,e,o){const i=[],s=Math.round(o);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++){const a=n*n+r*r;a<=s*s&&a>(s-1)*(s-1)&&i.push({x:Math.floor(u)+n,y:Math.floor(t),z:Math.floor(e)+r})}return i}function Cl(u,t,e,o){const i=[],s=Math.round(o);for(let n=-s;n<=s;n++)for(let r=-s;r<=s;r++)n*n+r*r<=s*s&&i.push({x:Math.floor(u)+n,y:Math.floor(t),z:Math.floor(e)+r});return i}function Al(u,t,e,o){const i=[],s=Math.round(o);for(let n=-s;n<=s;n++)for(let r=0;r<=s;r++)for(let a=-s;a<=s;a++)n*n+r*r+a*a<=s*s&&i.push({x:Math.floor(u)+n,y:Math.floor(t)+r,z:Math.floor(e)+a});return i}function Ml(u,t,e,o,i,s){const n=[],r=Math.abs(o-u),a=Math.abs(i-t),l=Math.abs(s-e),p=u<o?1:-1,h=t<i?1:-1,y=e<s?1:-1,c=Math.max(r,a,l);let d=Math.floor(u),f=Math.floor(t),m=Math.floor(e),x=c/2,g=c/2,b=c/2;for(let z=0;z<=c;z++)n.push({x:d,y:f,z:m}),x-=r,g-=a,b-=l,x<0&&(x+=c,d+=p),g<0&&(g+=c,f+=h),b<0&&(b+=c,m+=y);return n}function El(u,t,e,o,i,s){const n=[],r=Math.min(Math.floor(u),Math.floor(o)),a=Math.max(Math.floor(u),Math.floor(o)),l=Math.min(Math.floor(t),Math.floor(i)),p=Math.max(Math.floor(t),Math.floor(i)),h=Math.min(Math.floor(e),Math.floor(s)),y=Math.max(Math.floor(e),Math.floor(s));for(let c=r;c<=a;c++)for(let d=l;d<=p;d++)for(let f=h;f<=y;f++)n.push({x:c,y:d,z:f});return n}function $s(u,t,e){const o=e.x-t.x,i=e.y-t.y,s=e.z-t.z,n=Math.sqrt(o*o+i*i+s*s),r=Math.max(1,Math.round(n));switch(u){case"sphere":return vl(t.x,t.y,t.z,r);case"cube":return Fl(t.x,t.y,t.z,r*2);case"hollowCube":return wl(t.x,t.y,t.z,r*2);case"cylinder":const a=Math.sqrt(o*o+s*s),l=Math.max(1,Math.round(a)),p=Math.max(1,Math.abs(Math.round(i))||l);return kl(t.x,t.y,t.z,l,p);case"circle":return Bl(t.x,t.y,t.z,r);case"disc":return Cl(t.x,t.y,t.z,r);case"dome":return Al(t.x,t.y,t.z,r);case"line3d":return Ml(t.x,t.y,t.z,e.x,e.y,e.z);case"wall":return El(t.x,t.y,t.z,e.x,e.y,e.z);default:return[]}}class Sl{constructor(){this.layers=new Map,this.activeLayerId="default",this.onLayerChange=null,this.createLayer("default","Default","#ffffff")}createLayer(t,e,o="#ffffff"){if(this.layers.has(t))return console.warn(`Layer "${t}" already exists`),this.layers.get(t);const i={id:t,name:e,color:o,visible:!0,locked:!1,opacity:1,order:this.layers.size};return this.layers.set(t,i),this.notifyChange(),i}deleteLayer(t){return t==="default"?(console.warn("Cannot delete default layer"),!1):this.layers.has(t)?(this.layers.delete(t),this.activeLayerId===t&&(this.activeLayerId="default"),this.notifyChange(),!0):!1}getLayer(t){return this.layers.get(t)||null}getAllLayers(){return Array.from(this.layers.values()).sort((t,e)=>t.order-e.order)}setActiveLayer(t){return this.layers.has(t)?(this.activeLayerId=t,this.notifyChange(),!0):(console.warn(`Layer "${t}" does not exist`),!1)}getActiveLayer(){return this.layers.get(this.activeLayerId)}setLayerVisible(t,e){const o=this.layers.get(t);return o?(o.visible=e,this.notifyChange(),!0):!1}setLayerLocked(t,e){const o=this.layers.get(t);return o?(o.locked=e,this.notifyChange(),!0):!1}setLayerOpacity(t,e){const o=this.layers.get(t);return o?(o.opacity=Math.max(0,Math.min(1,e)),this.notifyChange(),!0):!1}setLayerName(t,e){const o=this.layers.get(t);return o?(o.name=e,this.notifyChange(),!0):!1}setLayerColor(t,e){const o=this.layers.get(t);return o?(o.color=e,this.notifyChange(),!0):!1}isLayerVisible(t){const e=this.layers.get(t);return e?e.visible:!0}isLayerLocked(t){const e=this.layers.get(t);return e?e.locked:!1}canEditLayer(t){const e=this.layers.get(t);return e?e.visible&&!e.locked:!1}moveLayerUp(t){const e=this.getAllLayers(),o=e.findIndex(i=>i.id===t);if(o>0){const i=e[o].order;return e[o].order=e[o-1].order,e[o-1].order=i,this.notifyChange(),!0}return!1}moveLayerDown(t){const e=this.getAllLayers(),o=e.findIndex(i=>i.id===t);if(o<e.length-1&&o>=0){const i=e[o].order;return e[o].order=e[o+1].order,e[o+1].order=i,this.notifyChange(),!0}return!1}notifyChange(){this.onLayerChange&&this.onLayerChange(this.getAllLayers(),this.activeLayerId)}generateLayerId(){let t=1;for(;this.layers.has(`layer_${t}`);)t++;return`layer_${t}`}toJSON(){return{layers:Array.from(this.layers.values()),activeLayerId:this.activeLayerId}}fromJSON(t){if(this.layers.clear(),t.layers&&Array.isArray(t.layers))for(const e of t.layers)this.layers.set(e.id,{...e});this.layers.has("default")||this.createLayer("default","Default","#ffffff"),this.activeLayerId=t.activeLayerId||"default",this.layers.has(this.activeLayerId)||(this.activeLayerId="default"),this.notifyChange()}clear(){this.layers.clear(),this.createLayer("default","Default","#ffffff"),this.activeLayerId="default",this.notifyChange()}}function Jn(u,t,e){const o={...u};switch(t){case"x":o.x=2*e.x-u.x-1;break;case"y":o.y=2*e.y-u.y-1;break;case"z":o.z=2*e.z-u.z-1;break}return o}function Qn(u,t){const e={...u};switch(t){case"x":e.y=(360-e.y)%360,e.z=(360-e.z)%360;break;case"y":e.x=(360-e.x)%360,e.z=(360-e.z)%360;break;case"z":e.x=(360-e.x)%360,e.y=(360-e.y)%360;break}return e}function tr(u){if(u.length===0)return{x:0,y:0,z:0};let t=1/0,e=1/0,o=1/0,i=-1/0,s=-1/0,n=-1/0;for(const r of u){const a=r.gridPosition;t=Math.min(t,a.x),e=Math.min(e,a.y),o=Math.min(o,a.z),i=Math.max(i,a.x+1),s=Math.max(s,a.y+1),n=Math.max(n,a.z+1)}return{x:(t+i)/2,y:(e+s)/2,z:(o+n)/2}}function _l(u,t,e){const o=Jn(u.gridPosition,t,e),i=Qn(u.rotation,t);return{type:u.type,position:o,dimensions:{...u.dimensions},rotation:i,color:u.color,emissive:u.emissive?{...u.emissive}:null,faces:u.faces?JSON.parse(JSON.stringify(u.faces)):null,layerId:u.layerId}}function Dl(u,t,e=null){if(u.length===0)return[];const o=e||tr(u),i=[];for(const s of u)i.push(_l(s,t,o));return i}class Tl{constructor(t){this.blockManager=t,this.symmetryMode=null,this.symmetryCenter={x:0,y:0,z:0}}setSymmetryMode(t){this.symmetryMode=t}setSymmetryCenter(t){this.symmetryCenter={...t}}getSymmetricBlockData(t){return this.symmetryMode?{...t,position:Jn(t.position,this.symmetryMode,this.symmetryCenter),rotation:Qn(t.rotation||{x:0,y:0,z:0},this.symmetryMode)}:null}mirrorSelectedBlocks(t,e=!0){const o=this.blockManager.getSelectedBlocks();if(o.length===0)return[];const i=tr(o),s=Dl(o,t,i);if(e){const n=[];for(const r of s)if(!this.blockManager.wouldOverlapAt(r.type,r.position,r.dimensions)){const a=this.blockManager.addBlock(r);a&&n.push(a)}return n}return s}}class Pl{constructor(t,e){this.camera=t,this.controls=e,this.bookmarks=new Map,this.onBookmarksChange=null}saveBookmark(t){const e=`bookmark_${Date.now()}`,o={id:e,name:t,position:{x:this.camera.position.x,y:this.camera.position.y,z:this.camera.position.z},target:{x:this.controls.target.x,y:this.controls.target.y,z:this.controls.target.z},zoom:this.camera.zoom};return this.bookmarks.set(e,o),this.notifyChange(),o}restoreBookmark(t,e=!0){const o=this.bookmarks.get(t);return o?(e?this.animateTo(o.position,o.target,500):(this.camera.position.set(o.position.x,o.position.y,o.position.z),this.controls.target.set(o.target.x,o.target.y,o.target.z),this.controls.update()),!0):!1}animateTo(t,e,o=500){const i={x:this.camera.position.x,y:this.camera.position.y,z:this.camera.position.z},s={x:this.controls.target.x,y:this.controls.target.y,z:this.controls.target.z},n=performance.now(),r=()=>{const a=performance.now()-n,l=Math.min(a/o,1),p=1-Math.pow(1-l,3);this.camera.position.x=i.x+(t.x-i.x)*p,this.camera.position.y=i.y+(t.y-i.y)*p,this.camera.position.z=i.z+(t.z-i.z)*p,this.controls.target.x=s.x+(e.x-s.x)*p,this.controls.target.y=s.y+(e.y-s.y)*p,this.controls.target.z=s.z+(e.z-s.z)*p,this.controls.update(),l<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}deleteBookmark(t){return this.bookmarks.has(t)?(this.bookmarks.delete(t),this.notifyChange(),!0):!1}renameBookmark(t,e){const o=this.bookmarks.get(t);return o?(o.name=e,this.notifyChange(),!0):!1}getAllBookmarks(){return Array.from(this.bookmarks.values())}goToPreset(t){const o={front:{position:{x:0,y:5,z:15},target:{x:0,y:0,z:0}},back:{position:{x:0,y:5,z:-15},target:{x:0,y:0,z:0}},left:{position:{x:-15,y:5,z:0},target:{x:0,y:0,z:0}},right:{position:{x:15,y:5,z:0},target:{x:0,y:0,z:0}},top:{position:{x:0,y:20,z:.01},target:{x:0,y:0,z:0}},iso:{position:{x:10,y:10,z:10},target:{x:0,y:0,z:0}}}[t];o&&this.animateTo(o.position,o.target)}notifyChange(){this.onBookmarksChange&&this.onBookmarksChange(this.getAllBookmarks())}toJSON(){return{bookmarks:Array.from(this.bookmarks.values())}}fromJSON(t){if(this.bookmarks.clear(),t&&t.bookmarks&&Array.isArray(t.bookmarks))for(const e of t.bookmarks)this.bookmarks.set(e.id,e);this.notifyChange()}clear(){this.bookmarks.clear(),this.notifyChange()}}class Il{constructor(t,e,o){this.camera=t,this.controls=e,this.cameraBookmarks=o,this.isPlaying=!1,this.currentFrame=0,this.animationFrameId=null,this.curveType="easeInOut"}interpolate(t,e,o,i=null){const s=i||this.curveType;let n=o;switch(s){case"linear":n=o;break;case"easeIn":n=o*o;break;case"easeOut":n=1-Math.pow(1-o,2);break;case"easeInOut":n=o<.5?2*o*o:1-Math.pow(-2*o+2,2)/2;break;case"smoothstep":n=o*o*(3-2*o);break;default:n=o<.5?2*o*o:1-Math.pow(-2*o+2,2)/2;break}const r={x:t.position.x+(e.position.x-t.position.x)*n,y:t.position.y+(e.position.y-t.position.y)*n,z:t.position.z+(e.position.z-t.position.z)*n},a={x:t.target.x+(e.target.x-t.target.x)*n,y:t.target.y+(e.target.y-t.target.y)*n,z:t.target.z+(e.target.z-t.target.z)*n};return{position:r,target:a}}getCameraAtFrame(t,e,o){if(o.length<2)throw new Error("Need at least 2 bookmarks for camera path");t=Math.max(0,Math.min(t,e-1));const i=t/(e-1);if(o.length===2)return this.interpolate(o[0],o[1],i);const s=o.length-1,n=i*s,r=Math.floor(n),a=n-r;return r>=s?{position:{...o[o.length-1].position},target:{...o[o.length-1].target}}:this.interpolate(o[r],o[r+1],a)}setCameraState(t){this.camera.position.set(t.position.x,t.position.y,t.position.z),this.controls.target.set(t.target.x,t.target.y,t.target.z),this.controls.update()}preview(t,e=3e3,o=null){if(t.length<2){console.warn("Need at least 2 bookmarks to preview");return}this.stop();const i=performance.now(),n=Math.floor(e/1e3*60),r=()=>{const a=performance.now()-i,l=Math.min(a/e,1),p=Math.floor(l*n),h=this.getCameraAtFrame(p,n,t);this.setCameraState(h),l<1?this.animationFrameId=requestAnimationFrame(r):(this.isPlaying=!1,o&&o())};this.isPlaying=!0,this.animationFrameId=requestAnimationFrame(r)}stop(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.isPlaying=!1}async renderSequence(t,e,o,i){if(t.length<2)throw new Error("Need at least 2 bookmarks to render sequence");this.stop();for(let s=0;s<e;s++){const n=this.getCameraAtFrame(s,e,t);this.setCameraState(n),o&&await o(s,e),await this.sleep(1)}i&&i()}sleep(t){return new Promise(e=>setTimeout(e,t))}}class Eo{constructor(t,e){this.engine=t,this.blockManager=e,this.enabled=!1,this.style="clean",this.inverted=!1,this.grayscale=!1,this.threshold=.5,this.lineWidth=2,this.showFills=!0,this.quality="medium",this.targetFPS=30,this.lastRenderTime=0,this.renderInterval=1e3/this.targetFPS,this.sceneHash=null,this.cachedImageData=null,this.cacheValid=!1,this.overlayCanvas=null,this.overlayCtx=null,this._tempVec3=new X,this._tempVec3_2=new X,this._tempVec3_3=new X,this.noiseSeed=Math.random()*1e3,window.addEventListener("resize",()=>this.onResize())}onResize(){this.overlayCanvas&&(this.overlayCanvas.width=window.innerWidth,this.overlayCanvas.height=window.innerHeight,this.enabled&&this.render())}setEnabled(t){this.enabled=t,t?(this.createOverlay(),this.render()):this.removeOverlay()}setStyle(t){this.style=t,this.enabled&&this.render()}setInverted(t){this.inverted=t,this.enabled&&this.render()}setGrayscale(t){this.grayscale=t,this.invalidateCache(),this.enabled&&this.render()}setThreshold(t){this.threshold=Math.max(0,Math.min(1,t)),this.enabled&&this.render()}setLineWidth(t){this.lineWidth=t,this.enabled&&this.render()}setShowFills(t){this.showFills=t,this.enabled&&this.render()}setQuality(t){this.quality=t,this.invalidateCache(),this.enabled&&this.render()}invalidateCache(){this.cacheValid=!1,this.sceneHash=null}generateSceneHash(){const t=this.engine.camera,e=`${t.position.x.toFixed(1)},${t.position.y.toFixed(1)},${t.position.z.toFixed(1)}`,o=`${t.rotation.x.toFixed(2)},${t.rotation.y.toFixed(2)},${t.rotation.z.toFixed(2)}`,i=this.blockManager.getAllBlocks().length,s=this.blockManager.getMergedMeshes?this.blockManager.getMergedMeshes().length:0,n=`${this.style}-${this.inverted}-${this.grayscale}-${this.threshold}-${this.quality}`;return`${e}|${o}|${i}|${s}|${n}`}getQualityMultiplier(){switch(this.quality){case"low":return .5;case"high":return 1.5;default:return 1}}createOverlay(){this.overlayCanvas||(this.overlayCanvas=document.createElement("canvas"),this.overlayCanvas.id="tattoo-overlay",this.overlayCanvas.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    `,this.overlayCanvas.width=window.innerWidth,this.overlayCanvas.height=window.innerHeight,this.overlayCtx=this.overlayCanvas.getContext("2d"),document.getElementById("app").appendChild(this.overlayCanvas))}removeOverlay(){this.overlayCanvas&&this.overlayCanvas.parentNode&&this.overlayCanvas.parentNode.removeChild(this.overlayCanvas),this.overlayCanvas=null,this.overlayCtx=null}getColors(){const t={clean:{bg:"#ffffff",fg:"#000000",accent:"#000000"},sketch:{bg:"#f5f5dc",fg:"#2c2c2c",accent:"#4a4a4a"},ink:{bg:"#fffef0",fg:"#1a1a1a",accent:"#000000"},crosshatch:{bg:"#ffffff",fg:"#000000",accent:"#444444"},blueprint:{bg:"#1e3a5f",fg:"#87ceeb",accent:"#add8e6"},comic:{bg:"#ffffff",fg:"#000000",accent:"#ff0000"},saturated:{bg:"#ffffff",fg:"#000000",accent:"#333333",preserveColor:!0},neon:{bg:"#0a0a0f",fg:"#00ffff",accent:"#ff00ff",glow:!0},scifi:{bg:"#0d1117",fg:"#58a6ff",accent:"#238636",grid:!0},watercolor:{bg:"#faf8f5",fg:"#2c4a52",accent:"#8b4513",soft:!0},noir:{bg:"#000000",fg:"#ffffff",accent:"#808080",highContrast:!0},synthwave:{bg:"#1a1a2e",fg:"#ff6ec7",accent:"#00fff7",gradient:!0},ascii:{bg:"#000000",fg:"#00ff00",accent:"#00aa00",monospace:!0}};let e=t[this.style]||t.clean;return this.inverted&&(e={...e,bg:e.fg,fg:e.bg}),e}render(t=!1){if(!this.enabled||!this.overlayCanvas)return;const e=performance.now();if(!t&&e-this.lastRenderTime<this.renderInterval)return;this.lastRenderTime=e;const o=this.overlayCanvas.width,i=this.overlayCanvas.height,s=this.overlayCtx,n=this.getColors(),r=this.generateSceneHash();if(this.cacheValid&&this.sceneHash===r&&this.cachedImageData){s.putImageData(this.cachedImageData,0,0);return}s.clearRect(0,0,o,i),s.fillStyle=n.bg,s.fillRect(0,0,o,i),this.style==="blueprint"?this.drawBlueprintGrid(s,o,i,n):this.style==="sketch"?this.drawPaperTexture(s,o,i):this.style==="scifi"?this.drawScifiBackground(s,o,i,n):this.style==="synthwave"?this.drawSynthwaveBackground(s,o,i,n):this.style==="neon"?this.drawNeonBackground(s,o,i,n):this.style==="watercolor"?this.drawWatercolorBackground(s,o,i,n):this.style==="ascii"&&this.drawAsciiBackground(s,o,i,n);const a=this.engine.camera;if(a.updateMatrixWorld(),this.style==="ascii"){const y=this.blockManager.getAllBlocks(),c=this.blockManager.getMergedMeshes?this.blockManager.getMergedMeshes():[];this.renderAsciiMode(s,y,c,a,o,i,n),this.cacheRenderedFrame(s,o,i,r);return}const l=[],p=this.blockManager.getAllBlocks(),h=this.blockManager.getMergedMeshes?this.blockManager.getMergedMeshes():[];for(const y of p)y.mesh.visible&&this.collectTriangles(y,a,l);for(const y of h)y.mesh.visible&&this.collectTrianglesFromMesh(y.mesh,y.color,a,l);l.sort((y,c)=>c.depth-y.depth),this.showFills&&this.renderFills(s,l,n),this.renderStyledEdges(s,p,h,a,o,i,n),this.cacheRenderedFrame(s,o,i,r)}cacheRenderedFrame(t,e,o,i){this.cachedImageData=t.getImageData(0,0,e,o),this.sceneHash=i,this.cacheValid=!0}renderFills(t,e,o){for(const i of e){const s=this.calculateLuminance(i.color);let n;if(this.style==="crosshatch"){this.drawCrosshatchTriangle(t,i,s,o);continue}else if(this.style==="comic"){this.drawComicTriangle(t,i,s,o);continue}else if(this.style==="saturated"){this.drawSaturatedTriangle(t,i,o);continue}else if(this.style==="neon"){this.drawNeonTriangle(t,i,s,o);continue}else if(this.style==="watercolor"){this.drawWatercolorTriangle(t,i,o);continue}else if(this.style==="noir"){this.drawNoirTriangle(t,i,s,o);continue}else if(this.style==="synthwave"){this.drawSynthwaveTriangle(t,i,o);continue}else if(this.style==="scifi"){this.drawScifiTriangle(t,i,s,o);continue}if(this.grayscale){let r=Math.round(s*255);this.inverted&&(r=255-r),n=`rgb(${r}, ${r}, ${r})`}else n=s>this.threshold?o.bg:o.fg;t.fillStyle=n,t.beginPath(),t.moveTo(i.points[0].x,i.points[0].y),t.lineTo(i.points[1].x,i.points[1].y),t.lineTo(i.points[2].x,i.points[2].y),t.closePath(),t.fill()}}renderStyledEdges(t,e,o,i,s,n,r){t.strokeStyle=r.fg,t.lineCap="round",t.lineJoin="round";const a=[];for(const l of e)l.mesh.visible&&a.push(...this.getEdgesFromBlock(l,i,s,n));for(const l of o)l.mesh.visible&&a.push(...this.getEdgesFromMerged(l,i,s,n));switch(this.style){case"sketch":this.drawSketchEdges(t,a,r);break;case"ink":this.drawInkEdges(t,a,r);break;case"blueprint":this.drawBlueprintEdges(t,a,r);break;case"comic":this.drawComicEdges(t,a,r);break;case"saturated":this.drawSaturatedEdges(t,a,r);break;case"neon":this.drawNeonEdges(t,a,r);break;case"scifi":this.drawScifiEdges(t,a,r);break;case"watercolor":this.drawWatercolorEdges(t,a,r);break;case"noir":this.drawNoirEdges(t,a,r);break;case"synthwave":this.drawSynthwaveEdges(t,a,r);break;default:this.drawCleanEdges(t,a,r)}}drawCleanEdges(t,e,o){t.strokeStyle=o.fg,t.lineWidth=this.lineWidth,t.beginPath();for(const i of e)t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2);t.stroke()}drawSketchEdges(t,e,o){t.strokeStyle=o.fg;for(const i of e)for(let s=0;s<2;s++){t.lineWidth=this.lineWidth*(.8+Math.random()*.4),t.beginPath();const n=8,r=(i.x2-i.x1)/n,a=(i.y2-i.y1)/n;t.moveTo(i.x1+this.sketchNoise(i.x1,i.y1,s)*2,i.y1+this.sketchNoise(i.y1,i.x1,s)*2);for(let l=1;l<=n;l++){const p=i.x1+r*l,h=i.y1+a*l,y=this.lineWidth*.5;t.lineTo(p+this.sketchNoise(p,h,s+l)*y,h+this.sketchNoise(h,p,s+l)*y)}t.stroke()}}drawInkEdges(t,e,o){t.strokeStyle=o.fg,t.fillStyle=o.fg;for(const i of e){const s=Math.sqrt(Math.pow(i.x2-i.x1,2)+Math.pow(i.y2-i.y1,2)),n=Math.max(4,Math.floor(s/10)),r=(i.x2-i.x1)/n,a=(i.y2-i.y1)/n;t.beginPath();for(let l=0;l<=n;l++){const p=l/n,h=i.x1+r*l,y=i.y1+a*l,c=Math.sin(p*Math.PI),d=this.lineWidth*(.5+c*1.5);l===0||(t.lineWidth=d,t.lineTo(h,y),t.stroke(),t.beginPath()),t.moveTo(h,y)}}}drawBlueprintEdges(t,e,o){t.shadowColor=o.fg,t.shadowBlur=2,t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*.8,t.beginPath();for(const s of e)t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2);t.stroke(),t.shadowBlur=0,t.fillStyle=o.accent;const i=new Set;for(const s of e)i.add(`${Math.round(s.x1)},${Math.round(s.y1)}`),i.add(`${Math.round(s.x2)},${Math.round(s.y2)}`);for(const s of i){const[n,r]=s.split(",").map(Number);t.beginPath(),t.arc(n,r,this.lineWidth,0,Math.PI*2),t.fill()}}drawComicEdges(t,e,o){t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*2,t.beginPath();for(const i of e)t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2);t.stroke(),t.strokeStyle=o.bg,t.lineWidth=this.lineWidth*.5,t.beginPath();for(const i of e)t.moveTo(i.x1+1,i.y1+-1),t.lineTo(i.x2+1,i.y2+-1);t.stroke()}drawSaturatedEdges(t,e,o){t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*.75,t.beginPath();for(const i of e)t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2);t.stroke()}drawNeonEdges(t,e,o){t.shadowColor=o.fg,t.shadowBlur=15,t.strokeStyle=o.fg,t.lineWidth=this.lineWidth,t.beginPath();for(const s of e)t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2);t.stroke(),t.shadowBlur=8,t.strokeStyle="#ffffff",t.lineWidth=this.lineWidth*.3,t.beginPath();for(const s of e)t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2);t.stroke(),t.shadowColor=o.accent,t.shadowBlur=12,t.strokeStyle=o.accent,t.lineWidth=this.lineWidth*.8,t.beginPath();let i=0;for(const s of e)i++%3===0&&(t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2));t.stroke(),t.shadowBlur=0}drawScifiEdges(t,e,o){t.shadowColor=o.fg,t.shadowBlur=3,t.strokeStyle=o.fg,t.lineWidth=this.lineWidth,t.beginPath();for(const s of e)t.moveTo(s.x1,s.y1),t.lineTo(s.x2,s.y2);t.stroke(),t.shadowBlur=0,t.fillStyle=o.accent;const i=new Set;for(const s of e)i.add(`${Math.round(s.x1)},${Math.round(s.y1)}`),i.add(`${Math.round(s.x2)},${Math.round(s.y2)}`);for(const s of i){const[n,r]=s.split(",").map(Number);t.beginPath(),t.arc(n,r,this.lineWidth*.8,0,Math.PI*2),t.fill()}}drawWatercolorEdges(t,e,o){for(let i=0;i<3;i++){t.globalAlpha=.3,t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*(2-i*.5),t.beginPath();for(const s of e)t.moveTo(s.x1+(Math.random()-.5)*2,s.y1+(Math.random()-.5)*2),t.lineTo(s.x2+(Math.random()-.5)*2,s.y2+(Math.random()-.5)*2);t.stroke()}t.globalAlpha=1}drawNoirEdges(t,e,o){t.strokeStyle=o.fg,t.lineWidth=this.lineWidth*1.5,t.beginPath();for(const i of e)t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2);t.stroke()}drawSynthwaveEdges(t,e,o){t.shadowColor=o.fg,t.shadowBlur=8;for(const i of e){const s=t.createLinearGradient(i.x1,i.y1,i.x2,i.y2);s.addColorStop(0,o.fg),s.addColorStop(.5,o.accent),s.addColorStop(1,o.fg),t.strokeStyle=s,t.lineWidth=this.lineWidth,t.beginPath(),t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2),t.stroke()}t.shadowBlur=0}drawCrosshatchTriangle(t,e,o,i){t.fillStyle=i.bg,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill(),t.save(),t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.clip();const s=Math.floor((1-o)*4);t.strokeStyle=i.fg,t.lineWidth=1;const n=Math.min(e.points[0].x,e.points[1].x,e.points[2].x),r=Math.max(e.points[0].x,e.points[1].x,e.points[2].x),a=Math.min(e.points[0].y,e.points[1].y,e.points[2].y),l=Math.max(e.points[0].y,e.points[1].y,e.points[2].y),p=8-s*1.5;if(s>=1){t.beginPath();for(let h=n-(l-a);h<r+(l-a);h+=p)t.moveTo(h,l),t.lineTo(h+(l-a),a);t.stroke()}if(s>=2){t.beginPath();for(let h=n-(l-a);h<r+(l-a);h+=p)t.moveTo(h,a),t.lineTo(h+(l-a),l);t.stroke()}if(s>=3){t.beginPath();for(let h=a;h<l;h+=p*1.5)t.moveTo(n,h),t.lineTo(r,h);t.stroke()}t.restore()}drawComicTriangle(t,e,o,i){if(t.fillStyle=i.bg,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill(),o<.7){t.save(),t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.clip(),t.fillStyle=i.fg;const s=Math.min(e.points[0].x,e.points[1].x,e.points[2].x),n=Math.max(e.points[0].x,e.points[1].x,e.points[2].x),r=Math.min(e.points[0].y,e.points[1].y,e.points[2].y),a=Math.max(e.points[0].y,e.points[1].y,e.points[2].y),l=2+(1-o)*3,p=8;for(let h=s;h<n;h+=p)for(let y=r;y<a;y+=p)t.beginPath(),t.arc(h,y,l,0,Math.PI*2),t.fill();t.restore()}}drawSaturatedTriangle(t,e,o){const i=e.color.replace("#","");let s=parseInt(i.substr(0,2),16),n=parseInt(i.substr(2,2),16),r=parseInt(i.substr(4,2),16);const a=(s+n+r)/3,l=1.3;s=Math.min(255,Math.max(0,Math.round(a+(s-a)*l))),n=Math.min(255,Math.max(0,Math.round(a+(n-a)*l))),r=Math.min(255,Math.max(0,Math.round(a+(r-a)*l))),t.fillStyle=`rgb(${s}, ${n}, ${r})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill()}drawNeonTriangle(t,e,o,i){const s=e.color.replace("#","");let n=parseInt(s.substr(0,2),16),r=parseInt(s.substr(2,2),16),a=parseInt(s.substr(4,2),16);n=Math.round(n*.15),r=Math.round(r*.15),a=Math.round(a*.15),t.fillStyle=`rgb(${n}, ${r}, ${a})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill()}drawWatercolorTriangle(t,e,o){const i=e.color.replace("#","");let s=parseInt(i.substr(0,2),16),n=parseInt(i.substr(2,2),16),r=parseInt(i.substr(4,2),16);const a=(s+n+r)/3;s=Math.round(s*.7+a*.3+30),n=Math.round(n*.7+a*.3+30),r=Math.round(r*.7+a*.3+30),s=Math.min(255,s),n=Math.min(255,n),r=Math.min(255,r),t.globalAlpha=.7,t.fillStyle=`rgb(${s}, ${n}, ${r})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill(),t.globalAlpha=1}drawNoirTriangle(t,e,o,i){t.fillStyle=o>.45?i.bg:i.fg,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill()}drawSynthwaveTriangle(t,e,o){const i=e.color.replace("#","");let s=parseInt(i.substr(0,2),16),n=parseInt(i.substr(2,2),16),r=parseInt(i.substr(4,2),16);(s+n+r)/3/255>.5?(s=Math.min(255,Math.round(s*.7+100)),n=Math.round(n*.5),r=Math.min(255,Math.round(r*.7+80))):(s=Math.round(s*.4+40),n=Math.round(n*.3),r=Math.min(255,Math.round(r*.5+60))),t.fillStyle=`rgb(${s}, ${n}, ${r})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill()}drawScifiTriangle(t,e,o,i){const s=e.color.replace("#","");let n=parseInt(s.substr(0,2),16),r=parseInt(s.substr(2,2),16),a=parseInt(s.substr(4,2),16);n=Math.round(n*.4),r=Math.min(255,Math.round(r*.6+30)),a=Math.min(255,Math.round(a*.7+50)),t.globalAlpha=.85,t.fillStyle=`rgb(${n}, ${r}, ${a})`,t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y),t.lineTo(e.points[1].x,e.points[1].y),t.lineTo(e.points[2].x,e.points[2].y),t.closePath(),t.fill(),t.globalAlpha=1}drawBlueprintGrid(t,e,o,i){t.strokeStyle=i.accent,t.globalAlpha=.3,t.lineWidth=.5;const s=20;t.beginPath();for(let n=0;n<e;n+=s)t.moveTo(n,0),t.lineTo(n,o);for(let n=0;n<o;n+=s)t.moveTo(0,n),t.lineTo(e,n);t.stroke(),t.globalAlpha=.5,t.lineWidth=1,t.beginPath();for(let n=0;n<e;n+=s*5)t.moveTo(n,0),t.lineTo(n,o);for(let n=0;n<o;n+=s*5)t.moveTo(0,n),t.lineTo(e,n);t.stroke(),t.globalAlpha=1}drawPaperTexture(t,e,o){t.globalAlpha=.03,t.fillStyle="#000000";for(let i=0;i<5e3;i++){const s=Math.random()*e,n=Math.random()*o;t.fillRect(s,n,1,1)}t.globalAlpha=1}drawScifiBackground(t,e,o,i){t.strokeStyle=i.fg,t.globalAlpha=.05,t.lineWidth=1,t.beginPath();for(let r=0;r<o;r+=3)t.moveTo(0,r),t.lineTo(e,r);t.stroke(),t.globalAlpha=.1,t.lineWidth=.5;const s=40;t.beginPath();for(let r=0;r<e;r+=s)t.moveTo(r,0),t.lineTo(r,o);for(let r=0;r<o;r+=s)t.moveTo(0,r),t.lineTo(e,r);t.stroke(),t.globalAlpha=.3,t.strokeStyle=i.accent,t.lineWidth=2;const n=50;t.beginPath(),t.moveTo(10,10+n),t.lineTo(10,10),t.lineTo(10+n,10),t.stroke(),t.beginPath(),t.moveTo(e-10-n,10),t.lineTo(e-10,10),t.lineTo(e-10,10+n),t.stroke(),t.beginPath(),t.moveTo(10,o-10-n),t.lineTo(10,o-10),t.lineTo(10+n,o-10),t.stroke(),t.beginPath(),t.moveTo(e-10-n,o-10),t.lineTo(e-10,o-10),t.lineTo(e-10,o-10-n),t.stroke(),t.globalAlpha=1}drawSynthwaveBackground(t,e,o,i){const s=t.createLinearGradient(0,0,0,o);s.addColorStop(0,"#0f0f23"),s.addColorStop(.5,"#1a1a2e"),s.addColorStop(1,"#16213e"),t.fillStyle=s,t.fillRect(0,0,e,o),t.strokeStyle=i.accent,t.globalAlpha=.4,t.lineWidth=1;const n=o*.6,r=15;for(let y=0;y<=r;y++){const c=y/r,d=n+(o-n)*Math.pow(c,.7);t.globalAlpha=.2+c*.3,t.beginPath(),t.moveTo(0,d),t.lineTo(e,d),t.stroke()}t.globalAlpha=.3;const a=e/2;for(let y=-r;y<=r;y++){const c=a+y*80;t.beginPath(),t.moveTo(a,n),t.lineTo(c,o),t.stroke()}const l=n-60,p=50,h=t.createRadialGradient(e/2,l,0,e/2,l,p);h.addColorStop(0,"#ff6ec7"),h.addColorStop(.7,"#ff6ec7"),h.addColorStop(1,"transparent"),t.globalAlpha=.6,t.fillStyle=h,t.beginPath(),t.arc(e/2,l,p,0,Math.PI*2),t.fill(),t.globalAlpha=1}drawNeonBackground(t,e,o,i){t.fillStyle=i.bg,t.fillRect(0,0,e,o);const s=t.createRadialGradient(e/2,o/2,0,e/2,o/2,Math.max(e,o)*.7);s.addColorStop(0,"transparent"),s.addColorStop(1,"rgba(0, 0, 0, 0.5)"),t.fillStyle=s,t.fillRect(0,0,e,o),t.globalAlpha=.05;for(let n=0;n<20;n++){const r=Math.random()*e,a=Math.random()*o,l=20+Math.random()*40,p=t.createRadialGradient(r,a,0,r,a,l);p.addColorStop(0,n%2===0?i.fg:i.accent),p.addColorStop(1,"transparent"),t.fillStyle=p,t.beginPath(),t.arc(r,a,l,0,Math.PI*2),t.fill()}t.globalAlpha=1}drawAsciiBackground(t,e,o,i){t.globalAlpha=.05,t.strokeStyle=i.accent,t.lineWidth=1;for(let n=0;n<o;n+=4)t.beginPath(),t.moveTo(0,n),t.lineTo(e,n),t.stroke();const s=t.createRadialGradient(e/2,o/2,0,e/2,o/2,Math.max(e,o)*.6);s.addColorStop(0,"transparent"),s.addColorStop(1,"rgba(0, 0, 0, 0.4)"),t.globalAlpha=1,t.fillStyle=s,t.fillRect(0,0,e,o)}renderAsciiMode(t,e,o,i,s,n,r){const a=" .:-=+*#%@",l=this.getQualityMultiplier(),p=Math.max(6,Math.floor(12/l)),h=Math.max(8,Math.floor(16/l)),y=Math.max(8,Math.floor(14/l));t.font=`bold ${y}px monospace`,t.fillStyle=r.fg,t.textAlign="center",t.textBaseline="middle";const c=document.createElement("canvas");c.width=s,c.height=n;const d=c.getContext("2d"),f=[];for(const z of e)z.mesh.visible&&this.collectTriangles(z,i,f);for(const z of o)z.mesh.visible&&this.collectTrianglesFromMesh(z.mesh,z.color,i,f);f.sort((z,v)=>v.depth-z.depth);for(const z of f){const v=this.calculateLuminance(z.color),C=Math.round(v*255);d.fillStyle=`rgb(${C}, ${C}, ${C})`,d.beginPath(),d.moveTo(z.points[0].x,z.points[0].y),d.lineTo(z.points[1].x,z.points[1].y),d.lineTo(z.points[2].x,z.points[2].y),d.closePath(),d.fill()}const x=d.getImageData(0,0,s,n).data,g=Math.floor(s/p),b=Math.floor(n/h);for(let z=0;z<b;z++)for(let v=0;v<g;v++){const C=v*p,B=z*h,A=C+p/2,M=B+h/2;let S=0,P=0,k=0,D=0,F=0;for(let $=0;$<h&&B+$<n;$++)for(let et=0;et<p&&C+et<s;et++){const j=((B+$)*s+(C+et))*4,O=x[j],tt=x[j+1],Q=x[j+2];P+=O,k+=tt,D+=Q;const W=(.299*O+.587*tt+.114*Q)/255;S+=W,F++}const T=S/F;if(T<.01)continue;const K=Math.pow(T,.7),G=Math.floor(K*(a.length-1)),rt=a[G];if(this.grayscale)t.fillStyle=r.fg;else{const $=Math.round(P/F),et=Math.round(k/F),j=Math.round(D/F),O=($+et+j)/3,tt=1.3,Q=Math.min(255,Math.max(0,Math.round(O+($-O)*tt))),W=Math.min(255,Math.max(0,Math.round(O+(et-O)*tt))),ut=Math.min(255,Math.max(0,Math.round(O+(j-O)*tt)));t.fillStyle=`rgb(${Q}, ${W}, ${ut})`}t.fillText(rt,A,M)}}drawWatercolorBackground(t,e,o,i){t.globalAlpha=.02,t.fillStyle=i.fg;for(let s=0;s<3e3;s++){const n=Math.random()*e,r=Math.random()*o,a=Math.random()*3+1;t.beginPath(),t.arc(n,r,a,0,Math.PI*2),t.fill()}t.globalAlpha=.03;for(let s=0;s<5;s++){const n=Math.random()*e,r=Math.random()*o,a=100+Math.random()*200,l=t.createRadialGradient(n,r,0,n,r,a);l.addColorStop(0,i.accent),l.addColorStop(1,"transparent"),t.fillStyle=l,t.beginPath(),t.arc(n,r,a,0,Math.PI*2),t.fill()}t.globalAlpha=1}sketchNoise(t,e,o){const i=Math.sin(t*12.9898+e*78.233+o+this.noiseSeed)*43758.5453;return(i-Math.floor(i))*2-1}getEdgesFromBlock(t,e,o,i){const s=t.mesh;if(t.edges)return this.extractEdges(t.edges.geometry,s.matrixWorld,e,o,i);{const n=new wo(s.geometry,30),r=this.extractEdges(n,s.matrixWorld,e,o,i);return n.dispose(),r}}getEdgesFromMerged(t,e,o,i){if(t.edges)return this.extractEdges(t.edges.geometry,t.mesh.matrixWorld,e,o,i);{const s=new wo(t.mesh.geometry,30),n=this.extractEdges(s,t.mesh.matrixWorld,e,o,i);return s.dispose(),n}}extractEdges(t,e,o,i,s){const n=[],r=t.getAttribute("position");if(!r)return n;for(let a=0;a<r.count;a+=2){const l=new X(r.getX(a),r.getY(a),r.getZ(a)).applyMatrix4(e),p=new X(r.getX(a+1),r.getY(a+1),r.getZ(a+1)).applyMatrix4(e),h=l.project(o),y=p.project(o);h.z>1&&y.z>1||n.push({x1:(h.x+1)*i/2,y1:(-h.y+1)*s/2,x2:(y.x+1)*i/2,y2:(-y.y+1)*s/2})}return n}collectTriangles(t,e,o){const i=t.mesh;i.updateMatrixWorld();const s=i.geometry,n=s.getAttribute("position");if(!n)return;const r=s.index,a=i.matrixWorld,l=new X;e.getWorldDirection(l);const p=y=>{if(Array.isArray(i.material)){const c=s.groups;if(c&&c.length>0){for(const d of c)if(y*3>=d.start&&y*3<d.start+d.count)return"#"+i.material[d.materialIndex].color.getHexString()}return t.color}else return t.color},h=(y,c,d,f)=>{const m=this._tempVec3.set(n.getX(y),n.getY(y),n.getZ(y)).applyMatrix4(a),x=this._tempVec3_2.set(n.getX(c),n.getY(c),n.getZ(c)).applyMatrix4(a),g=this._tempVec3_3.set(n.getX(d),n.getY(d),n.getZ(d)).applyMatrix4(a),b=new X().subVectors(x,m),z=new X().subVectors(g,m),v=new X().crossVectors(b,z).normalize();if(v.dot(l)>.1)return;const C=m.clone().project(e),B=new X().copy(x).project(e),A=new X().copy(g).project(e);if(C.z>1||B.z>1||A.z>1)return;const M=(m.z+x.z+g.z)/3;o.push({points:[{x:(C.x+1)*window.innerWidth/2,y:(-C.y+1)*window.innerHeight/2},{x:(B.x+1)*window.innerWidth/2,y:(-B.y+1)*window.innerHeight/2},{x:(A.x+1)*window.innerWidth/2,y:(-A.y+1)*window.innerHeight/2}],depth:M,color:p(f),normal:v.clone()})};if(r)for(let y=0;y<r.count;y+=3){const c=Math.floor(y/3);h(r.getX(y),r.getX(y+1),r.getX(y+2),c)}else for(let y=0;y<n.count;y+=3){const c=Math.floor(y/3);h(y,y+1,y+2,c)}}collectTrianglesFromMesh(t,e,o,i){t.updateMatrixWorld();const s=t.geometry,n=s.getAttribute("position"),r=s.getAttribute("color");if(!n)return;const a=s.index,l=t.matrixWorld,p=new X;o.getWorldDirection(p);const h=(y,c,d)=>{const f=this._tempVec3.set(n.getX(y),n.getY(y),n.getZ(y)).applyMatrix4(l),m=this._tempVec3_2.set(n.getX(c),n.getY(c),n.getZ(c)).applyMatrix4(l),x=this._tempVec3_3.set(n.getX(d),n.getY(d),n.getZ(d)).applyMatrix4(l),g=new X().subVectors(m,f),b=new X().subVectors(x,f),z=new X().crossVectors(g,b).normalize();if(z.dot(p)>.1)return;const v=f.clone().project(o),C=new X().copy(m).project(o),B=new X().copy(x).project(o);if(v.z>1||C.z>1||B.z>1)return;const A=(f.z+m.z+x.z)/3;let M=e;if(r){const S=Math.round(r.getX(y)*255),P=Math.round(r.getY(y)*255),k=Math.round(r.getZ(y)*255);M=`#${S.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}${k.toString(16).padStart(2,"0")}`}i.push({points:[{x:(v.x+1)*window.innerWidth/2,y:(-v.y+1)*window.innerHeight/2},{x:(C.x+1)*window.innerWidth/2,y:(-C.y+1)*window.innerHeight/2},{x:(B.x+1)*window.innerWidth/2,y:(-B.y+1)*window.innerHeight/2}],depth:A,color:M,normal:z.clone()})};if(a)for(let y=0;y<a.count;y+=3)h(a.getX(y),a.getX(y+1),a.getX(y+2));else for(let y=0;y<n.count;y+=3)h(y,y+1,y+2)}calculateLuminance(t){const e=t.replace("#",""),o=parseInt(e.substr(0,2),16)/255,i=parseInt(e.substr(2,2),16)/255,s=parseInt(e.substr(4,2),16)/255;return .299*o+.587*i+.114*s}capturePNG(t="render.png"){const e=this.enabled;e||(this.createOverlay(),this.render());const o=this.overlayCanvas,i=document.createElement("a");i.download=t,i.href=o.toDataURL("image/png"),i.click(),e||this.removeOverlay()}exportSVG(t="render.svg"){const e=window.innerWidth,o=window.innerHeight,i=this.getColors();let s=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${o}" viewBox="0 0 ${e} ${o}">
  <rect width="100%" height="100%" fill="${i.bg}"/>
  <g stroke="${i.fg}" stroke-width="${this.lineWidth}" stroke-linecap="round" stroke-linejoin="round" fill="none">
`;const n=this.engine.camera;n.updateMatrixWorld();const r=this.blockManager.getAllBlocks(),a=this.blockManager.getMergedMeshes?this.blockManager.getMergedMeshes():[];for(const h of r){if(!h.mesh.visible)continue;const y=this.getEdgesFromBlock(h,n,e,o);for(const c of y)s+=`    <line x1="${c.x1.toFixed(2)}" y1="${c.y1.toFixed(2)}" x2="${c.x2.toFixed(2)}" y2="${c.y2.toFixed(2)}"/>
`}for(const h of a){if(!h.mesh.visible)continue;const y=this.getEdgesFromMerged(h,n,e,o);for(const c of y)s+=`    <line x1="${c.x1.toFixed(2)}" y1="${c.y1.toFixed(2)}" x2="${c.x2.toFixed(2)}" y2="${c.y2.toFixed(2)}"/>
`}s+=`  </g>
</svg>`;const l=new Blob([s],{type:"image/svg+xml"}),p=document.createElement("a");p.download=t,p.href=URL.createObjectURL(l),p.click(),URL.revokeObjectURL(p.href)}update(){this.enabled&&this.render()}}const er={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = opacity * texel;


		}`};class no{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const Rl=new Hr(-1,1,1,-1,0,1);class Ll extends ce{constructor(){super(),this.setAttribute("position",new _t([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new _t([0,2,0,0,2,0],2))}}const Ul=new Ll;class gs{constructor(t){this._mesh=new It(Ul,t)}dispose(){this._mesh.geometry.dispose()}render(t){t.render(this._mesh,Rl)}get material(){return this._mesh.material}set material(t){this._mesh.material=t}}class qt extends no{constructor(t,e){super(),this.textureID=e!==void 0?e:"tDiffuse",t instanceof Qe?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=ci.clone(t.uniforms),this.material=new Qe({name:t.name!==void 0?t.name:"unspecified",defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.fsQuad=new gs(this.material)}render(t,e,o){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=o.texture),this.fsQuad.material=this.material,this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class Hs extends no{constructor(t,e){super(),this.scene=t,this.camera=e,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(t,e,o){const i=t.getContext(),s=t.state;s.buffers.color.setMask(!1),s.buffers.depth.setMask(!1),s.buffers.color.setLocked(!0),s.buffers.depth.setLocked(!0);let n,r;this.inverse?(n=0,r=1):(n=1,r=0),s.buffers.stencil.setTest(!0),s.buffers.stencil.setOp(i.REPLACE,i.REPLACE,i.REPLACE),s.buffers.stencil.setFunc(i.ALWAYS,n,4294967295),s.buffers.stencil.setClear(r),s.buffers.stencil.setLocked(!0),t.setRenderTarget(o),this.clear&&t.clear(),t.render(this.scene,this.camera),t.setRenderTarget(e),this.clear&&t.clear(),t.render(this.scene,this.camera),s.buffers.color.setLocked(!1),s.buffers.depth.setLocked(!1),s.buffers.color.setMask(!0),s.buffers.depth.setMask(!0),s.buffers.stencil.setLocked(!1),s.buffers.stencil.setFunc(i.EQUAL,1,4294967295),s.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),s.buffers.stencil.setLocked(!0)}}class Ol extends no{constructor(){super(),this.needsSwap=!1}render(t){t.state.buffers.stencil.setLocked(!1),t.state.buffers.stencil.setTest(!1)}}class Ws{constructor(t,e){if(this.renderer=t,this._pixelRatio=t.getPixelRatio(),e===void 0){const o=t.getSize(new nt);this._width=o.width,this._height=o.height,e=new Ce(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Qo}),e.texture.name="EffectComposer.rt1"}else this._width=e.width,this._height=e.height;this.renderTarget1=e,this.renderTarget2=e.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new qt(er),this.copyPass.material.blending=Wr,this.clock=new Zn}swapBuffers(){const t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t}addPass(t){this.passes.push(t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(t,e){this.passes.splice(e,0,t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(t){const e=this.passes.indexOf(t);e!==-1&&this.passes.splice(e,1)}isLastEnabledPass(t){for(let e=t+1;e<this.passes.length;e++)if(this.passes[e].enabled)return!1;return!0}render(t){t===void 0&&(t=this.clock.getDelta());const e=this.renderer.getRenderTarget();let o=!1;for(let i=0,s=this.passes.length;i<s;i++){const n=this.passes[i];if(n.enabled!==!1){if(n.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(i),n.render(this.renderer,this.writeBuffer,this.readBuffer,t,o),n.needsSwap){if(o){const r=this.renderer.getContext(),a=this.renderer.state.buffers.stencil;a.setFunc(r.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),a.setFunc(r.EQUAL,1,4294967295)}this.swapBuffers()}Hs!==void 0&&(n instanceof Hs?o=!0:n instanceof Ol&&(o=!1))}}this.renderer.setRenderTarget(e)}reset(t){if(t===void 0){const e=this.renderer.getSize(new nt);this._pixelRatio=this.renderer.getPixelRatio(),this._width=e.width,this._height=e.height,t=this.renderTarget1.clone(),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(t,e){this._width=t,this._height=e;const o=this._width*this._pixelRatio,i=this._height*this._pixelRatio;this.renderTarget1.setSize(o,i),this.renderTarget2.setSize(o,i);for(let s=0;s<this.passes.length;s++)this.passes[s].setSize(o,i)}setPixelRatio(t){this._pixelRatio=t,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class Nl extends no{constructor(t,e,o=null,i=null,s=null){super(),this.scene=t,this.camera=e,this.overrideMaterial=o,this.clearColor=i,this.clearAlpha=s,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new ot}render(t,e,o){const i=t.autoClear;t.autoClear=!1;let s,n;this.overrideMaterial!==null&&(n=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor!==null&&(t.getClearColor(this._oldClearColor),t.setClearColor(this.clearColor,t.getClearAlpha())),this.clearAlpha!==null&&(s=t.getClearAlpha(),t.setClearAlpha(this.clearAlpha)),this.clearDepth==!0&&t.clearDepth(),t.setRenderTarget(this.renderToScreen?null:o),this.clear===!0&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),t.render(this.scene,this.camera),this.clearColor!==null&&t.setClearColor(this._oldClearColor),this.clearAlpha!==null&&t.setClearAlpha(s),this.overrideMaterial!==null&&(this.scene.overrideMaterial=n),t.autoClear=i}}const jl={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new ot(0)},defaultOpacity:{value:0}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform vec3 defaultColor;
		uniform float defaultOpacity;
		uniform float luminosityThreshold;
		uniform float smoothWidth;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );

			float v = luminance( texel.xyz );

			vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );

			float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );

			gl_FragColor = mix( outputColor, texel, alpha );

		}`};class Ne extends no{constructor(t,e,o,i){super(),this.strength=e!==void 0?e:1,this.radius=o,this.threshold=i,this.resolution=t!==void 0?new nt(t.x,t.y):new nt(256,256),this.clearColor=new ot(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let s=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);this.renderTargetBright=new Ce(s,n,{type:Qo}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let h=0;h<this.nMips;h++){const y=new Ce(s,n,{type:Qo});y.texture.name="UnrealBloomPass.h"+h,y.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(y);const c=new Ce(s,n,{type:Qo});c.texture.name="UnrealBloomPass.v"+h,c.texture.generateMipmaps=!1,this.renderTargetsVertical.push(c),s=Math.round(s/2),n=Math.round(n/2)}const r=jl;this.highPassUniforms=ci.clone(r.uniforms),this.highPassUniforms.luminosityThreshold.value=i,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new Qe({uniforms:this.highPassUniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader}),this.separableBlurMaterials=[];const a=[3,5,7,9,11];s=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);for(let h=0;h<this.nMips;h++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(a[h])),this.separableBlurMaterials[h].uniforms.invSize.value=new nt(1/s,1/n),s=Math.round(s/2),n=Math.round(n/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=e,this.compositeMaterial.uniforms.bloomRadius.value=.1;const l=[1,.8,.6,.4,.2];this.compositeMaterial.uniforms.bloomFactors.value=l,this.bloomTintColors=[new X(1,1,1),new X(1,1,1),new X(1,1,1),new X(1,1,1),new X(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const p=er;this.copyUniforms=ci.clone(p.uniforms),this.blendMaterial=new Qe({uniforms:this.copyUniforms,vertexShader:p.vertexShader,fragmentShader:p.fragmentShader,blending:qr,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new ot,this.oldClearAlpha=1,this.basic=new gi,this.fsQuad=new gs(null)}dispose(){for(let t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(let t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose();for(let t=0;t<this.separableBlurMaterials.length;t++)this.separableBlurMaterials[t].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(t,e){let o=Math.round(t/2),i=Math.round(e/2);this.renderTargetBright.setSize(o,i);for(let s=0;s<this.nMips;s++)this.renderTargetsHorizontal[s].setSize(o,i),this.renderTargetsVertical[s].setSize(o,i),this.separableBlurMaterials[s].uniforms.invSize.value=new nt(1/o,1/i),o=Math.round(o/2),i=Math.round(i/2)}render(t,e,o,i,s){t.getClearColor(this._oldClearColor),this.oldClearAlpha=t.getClearAlpha();const n=t.autoClear;t.autoClear=!1,t.setClearColor(this.clearColor,0),s&&t.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=o.texture,t.setRenderTarget(null),t.clear(),this.fsQuad.render(t)),this.highPassUniforms.tDiffuse.value=o.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,t.setRenderTarget(this.renderTargetBright),t.clear(),this.fsQuad.render(t);let r=this.renderTargetBright;for(let a=0;a<this.nMips;a++)this.fsQuad.material=this.separableBlurMaterials[a],this.separableBlurMaterials[a].uniforms.colorTexture.value=r.texture,this.separableBlurMaterials[a].uniforms.direction.value=Ne.BlurDirectionX,t.setRenderTarget(this.renderTargetsHorizontal[a]),t.clear(),this.fsQuad.render(t),this.separableBlurMaterials[a].uniforms.colorTexture.value=this.renderTargetsHorizontal[a].texture,this.separableBlurMaterials[a].uniforms.direction.value=Ne.BlurDirectionY,t.setRenderTarget(this.renderTargetsVertical[a]),t.clear(),this.fsQuad.render(t),r=this.renderTargetsVertical[a];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.setRenderTarget(this.renderTargetsHorizontal[0]),t.clear(),this.fsQuad.render(t),this.fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,s&&t.state.buffers.stencil.setTest(!0),this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(o),this.fsQuad.render(t)),t.setClearColor(this._oldClearColor,this.oldClearAlpha),t.autoClear=n}getSeperableBlurMaterial(t){const e=[];for(let o=0;o<t;o++)e.push(.39894*Math.exp(-.5*o*o/(t*t))/t);return new Qe({defines:{KERNEL_RADIUS:t},uniforms:{colorTexture:{value:null},invSize:{value:new nt(.5,.5)},direction:{value:new nt(.5,.5)},gaussianCoefficients:{value:e}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 invSize;
				uniform vec2 direction;
				uniform float gaussianCoefficients[KERNEL_RADIUS];

				void main() {
					float weightSum = gaussianCoefficients[0];
					vec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianCoefficients[i];
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}getCompositeMaterial(t){return new Qe({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}}Ne.BlurDirectionX=new nt(1,0);Ne.BlurDirectionY=new nt(0,1);const Xl={name:"OutputShader",uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:`
		precision highp float;

		uniform mat4 modelViewMatrix;
		uniform mat4 projectionMatrix;

		attribute vec3 position;
		attribute vec2 uv;

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`
	
		precision highp float;

		uniform sampler2D tDiffuse;

		#include <tonemapping_pars_fragment>
		#include <colorspace_pars_fragment>

		varying vec2 vUv;

		void main() {

			gl_FragColor = texture2D( tDiffuse, vUv );

			// tone mapping

			#ifdef LINEAR_TONE_MAPPING

				gl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );

			#elif defined( REINHARD_TONE_MAPPING )

				gl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );

			#elif defined( CINEON_TONE_MAPPING )

				gl_FragColor.rgb = CineonToneMapping( gl_FragColor.rgb );

			#elif defined( ACES_FILMIC_TONE_MAPPING )

				gl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );

			#elif defined( AGX_TONE_MAPPING )

				gl_FragColor.rgb = AgXToneMapping( gl_FragColor.rgb );

			#elif defined( NEUTRAL_TONE_MAPPING )

				gl_FragColor.rgb = NeutralToneMapping( gl_FragColor.rgb );

			#endif

			// color space

			#ifdef SRGB_TRANSFER

				gl_FragColor = sRGBTransferOETF( gl_FragColor );

			#endif

		}`};class Zl extends no{constructor(){super();const t=Xl;this.uniforms=ci.clone(t.uniforms),this.material=new Kr({name:t.name,uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.fsQuad=new gs(this.material),this._outputColorSpace=null,this._toneMapping=null}render(t,e,o){this.uniforms.tDiffuse.value=o.texture,this.uniforms.toneMappingExposure.value=t.toneMappingExposure,(this._outputColorSpace!==t.outputColorSpace||this._toneMapping!==t.toneMapping)&&(this._outputColorSpace=t.outputColorSpace,this._toneMapping=t.toneMapping,this.material.defines={},Jr.getTransfer(this._outputColorSpace)===Qr&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===ta?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===ea?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===oa?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===ia?this.material.defines.ACES_FILMIC_TONE_MAPPING="":this._toneMapping===sa?this.material.defines.AGX_TONE_MAPPING="":this._toneMapping===na&&(this.material.defines.NEUTRAL_TONE_MAPPING=""),this.material.needsUpdate=!0),this.renderToScreen===!0?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}new nt(1920,1080),new ot(0),new ot(16777215);const Gl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},lineColor:{value:new ot(0)},bgColor:{value:new ot(16777215)},spacing:{value:8},lineWidth:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform vec3 lineColor;
    uniform vec3 bgColor;
    uniform float spacing;
    uniform float lineWidth;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float hatchLine(vec2 uv, float angle, float sp) {
      float c = cos(angle);
      float s = sin(angle);
      vec2 rotUv = vec2(uv.x * c - uv.y * s, uv.x * s + uv.y * c);
      return step(mod(rotUv.x * resolution.x, sp), lineWidth);
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float lum = luma(texColor.rgb);
      float darkness = 1.0 - lum;

      vec2 pixelCoord = vUv * resolution;
      float hatch = 0.0;

      // Layer 1: diagonal lines (darkness > 0.25)
      if (darkness > 0.25) {
        hatch = max(hatch, hatchLine(pixelCoord, 0.785, spacing));
      }
      // Layer 2: opposite diagonal (darkness > 0.5)
      if (darkness > 0.5) {
        hatch = max(hatch, hatchLine(pixelCoord, -0.785, spacing));
      }
      // Layer 3: horizontal (darkness > 0.75)
      if (darkness > 0.75) {
        hatch = max(hatch, hatchLine(pixelCoord, 0.0, spacing * 1.5));
      }

      vec3 finalColor = mix(bgColor, lineColor, hatch);
      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Yl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},dotColor:{value:new ot(0)},bgColor:{value:new ot(16777215)},dotSize:{value:4},spacing:{value:8},thickness:{value:2},showFills:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform vec3 dotColor;
    uniform vec3 bgColor;
    uniform float dotSize;
    uniform float spacing;
    uniform float thickness;
    uniform float showFills;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness * 2.0) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.04, 0.12, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float lum = luma(texColor.rgb);
      float darkness = 1.0 - lum;

      vec2 pixelCoord = vUv * resolution;
      vec2 cell = floor(pixelCoord / spacing);
      vec2 cellCenter = (cell + 0.5) * spacing;
      float dist = length(pixelCoord - cellCenter);

      // Dot radius based on darkness
      float radius = darkness * dotSize;
      float dt = 1.0 - smoothstep(radius - 0.5, radius + 0.5, dist);

      // When fills are off, skip dots  just show bg + edges
      float dotMask = dt * showFills;
      vec3 finalColor = mix(bgColor, dotColor, dotMask);

      // Grayscale conversion
      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }

      // Bold edge overlay (comic-style thick outlines)
      float edge = detectEdge(vUv);
      finalColor = mix(finalColor, dotColor, edge);

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Vl={uniforms:{tDiffuse:{value:null},tCharacters:{value:null},resolution:{value:new nt(1920,1080)},charSize:{value:new nt(8,16)},textColor:{value:new ot(65280)},bgColor:{value:new ot(0)},colorMode:{value:0},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform sampler2D tCharacters;
    uniform vec2 resolution;
    uniform vec2 charSize;
    uniform vec3 textColor;
    uniform vec3 bgColor;
    uniform int colorMode;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    void main() {
      // Calculate which character cell we're in
      vec2 pixelCoord = vUv * resolution;
      vec2 cellCoord = floor(pixelCoord / charSize);
      vec2 cellUv = (cellCoord + 0.5) * charSize / resolution;

      // Sample the center of this cell
      vec4 texColor = texture2D(tDiffuse, cellUv);
      float lum = luma(texColor.rgb);

      // Map luminance to character index (0-9 for " .:-=+*#%@")
      int charIndex = int(lum * 9.0);

      // Position within character cell
      vec2 posInCell = mod(pixelCoord, charSize) / charSize;

      // Sample from character atlas
      float charWidth = 1.0 / 10.0; // 10 characters in atlas
      vec2 charUv = vec2(
        float(charIndex) * charWidth + posInCell.x * charWidth,
        posInCell.y
      );

      float charValue = texture2D(tCharacters, charUv).r;

      vec3 color;
      if (colorMode == 1) {
        // Colored mode - use original color boosted
        vec3 boosted = texColor.rgb * 1.3;
        color = mix(bgColor, boosted, charValue);
      } else {
        // Monochrome mode
        color = mix(bgColor, textColor, charValue);
      }

      if (grayscale > 0.5) {
        float g = luma(color);
        color = vec3(g);
      }

      gl_FragColor = vec4(color, 1.0);
    }
  `},$l={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},glowColor:{value:new ot(65535)},accentColor:{value:new ot(16711935)},bgColor:{value:new ot(657935)},glowIntensity:{value:2},thickness:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform vec3 glowColor;
    uniform vec3 accentColor;
    uniform vec3 bgColor;
    uniform float glowIntensity;
    uniform float thickness;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      // Dark base from original
      vec3 darkBase = texColor.rgb * 0.15;

      // Alternate between glow colors based on position
      float alternate = step(0.5, fract(vUv.x * 20.0 + vUv.y * 20.0));
      vec3 edgeGlow = mix(glowColor, accentColor, alternate * 0.3);

      // Combine
      vec3 finalColor = mix(darkBase + bgColor * 0.5, edgeGlow * glowIntensity, edge);

      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Hl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1},time:{value:0},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    uniform float time;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    vec3 synthwaveColor(vec3 color, vec2 uv) {
      float lum = dot(color, vec3(0.299, 0.587, 0.114));

      // Shift toward purple/cyan palette
      vec3 result;
      if (lum > 0.5) {
        // Bright: pink/cyan
        result.r = min(1.0, color.r * 0.7 + 0.4);
        result.g = color.g * 0.5;
        result.b = min(1.0, color.b * 0.7 + 0.3);
      } else {
        // Dark: deep purple
        result.r = color.r * 0.4 + 0.15;
        result.g = color.g * 0.3;
        result.b = min(1.0, color.b * 0.5 + 0.25);
      }
      return result;
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      // Background gradient
      vec3 bgTop = vec3(0.06, 0.06, 0.14);
      vec3 bgBot = vec3(0.09, 0.08, 0.15);
      vec3 bg = mix(bgBot, bgTop, vUv.y);

      // Color shift the original
      vec3 shifted = synthwaveColor(texColor.rgb, vUv);

      // Edge glow with gradient
      vec3 glowStart = vec3(1.0, 0.43, 0.78); // Pink
      vec3 glowEnd = vec3(0.0, 1.0, 0.97);    // Cyan
      vec3 edgeColor = mix(glowStart, glowEnd, vUv.y + sin(vUv.x * 10.0) * 0.2);

      vec3 finalColor = mix(shifted, bg, 0.3);
      finalColor = mix(finalColor, edgeColor * 1.5, edge);

      // Subtle grid on bottom half
      if (vUv.y < 0.5) {
        float gridX = step(0.98, fract(vUv.x * 20.0));
        float gridY = step(0.96, fract((0.5 - vUv.y) * 30.0 * (1.0 + vUv.y)));
        float grid = max(gridX, gridY) * 0.2 * (0.5 - vUv.y) * 2.0;
        finalColor += vec3(0.0, 1.0, 0.97) * grid;
      }

      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Wl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},threshold:{value:.45},thickness:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float threshold;
    uniform float thickness;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness * 1.5) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);
      float lum = luma(texColor.rgb);

      // High contrast threshold
      float bw = step(threshold, lum);

      // Add edge emphasis (white edges on black)
      bw = max(bw, edge);

      // Noir is already grayscale, so grayscale uniform has no effect
      gl_FragColor = vec4(vec3(bw), 1.0);
    }
  `},ql={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},bgColor:{value:new ot(16447733)},lineColor:{value:new ot(2902610)},thickness:{value:1},time:{value:0},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform vec3 bgColor;
    uniform vec3 lineColor;
    uniform float thickness;
    uniform float time;
    uniform float grayscale;
    varying vec2 vUv;

    float hash(vec2 p) {
      return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453);
    }

    float noise(vec2 p) {
      vec2 i = floor(p);
      vec2 f = fract(p);
      f = f * f * (3.0 - 2.0 * f);
      float a = hash(i);
      float b = hash(i + vec2(1.0, 0.0));
      float c = hash(i + vec2(0.0, 1.0));
      float d = hash(i + vec2(1.0, 1.0));
      return mix(mix(a, b, f.x), mix(c, d, f.x), f.y);
    }

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.03, 0.12, sqrt(gx*gx + gy*gy));
    }

    void main() {
      // Wobble/distortion for watercolor effect
      vec2 wobble = vec2(
        noise(vUv * 50.0) * 0.003,
        noise(vUv * 50.0 + 100.0) * 0.003
      );

      vec4 texColor = texture2D(tDiffuse, vUv + wobble);
      float edge = detectEdge(vUv);

      // Soften colors with desaturation
      float gray = luma(texColor.rgb);
      vec3 softened = mix(texColor.rgb, vec3(gray), 0.3);
      softened = softened * 0.7 + 0.25; // Lighten

      // Paper texture
      float paper = noise(vUv * resolution * 0.5) * 0.05;
      softened += paper;

      // Mix with background color
      vec3 withBg = mix(softened, bgColor, 0.15);

      // Apply edge color
      vec3 finalColor = mix(withBg, lineColor, edge * 0.5);

      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Kl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1},time:{value:0},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    uniform float time;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.2, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      vec3 techColor = vec3(texColor.r * 0.4, min(1.0, texColor.g * 0.6 + 0.12), min(1.0, texColor.b * 0.7 + 0.2));
      vec3 bg = vec3(0.05, 0.07, 0.09);
      vec3 finalColor = mix(bg, techColor, 0.85);

      float scanline = sin(vUv.y * resolution.y * 2.0) * 0.03 + 0.97;
      finalColor *= scanline;

      vec3 edgeColor = vec3(0.34, 0.65, 1.0);
      finalColor = mix(finalColor, edgeColor * 1.2, edge);

      float gridSize = 40.0;
      float grid = max(step(0.97, fract(vUv.x * resolution.x / gridSize)), step(0.97, fract(vUv.y * resolution.y / gridSize))) * 0.15;
      finalColor += edgeColor * grid;

      vec2 corner = min(vUv, 1.0 - vUv);
      float bracket = step(corner.x, 0.02) * step(corner.y, 0.05) + step(corner.y, 0.02) * step(corner.x, 0.05);
      finalColor += vec3(0.14, 0.53, 0.21) * bracket * 0.5;

      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Jl={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      float edge = detectEdge(vUv);

      vec3 bg = vec3(0.12, 0.23, 0.37);
      vec3 lineColor = vec3(0.53, 0.81, 0.92);
      vec3 accentColor = vec3(0.68, 0.85, 0.90);

      vec2 pixelCoord = vUv * resolution;
      float minorGrid = max(step(0.95, fract(pixelCoord.x / 20.0)), step(0.95, fract(pixelCoord.y / 20.0))) * 0.2;
      float majorGrid = max(step(0.98, fract(pixelCoord.x / 100.0)), step(0.98, fract(pixelCoord.y / 100.0))) * 0.4;

      vec3 finalColor = bg + accentColor * minorGrid + accentColor * majorGrid;
      finalColor = mix(finalColor, lineColor * 1.3, edge);

      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Ql={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1},time:{value:0},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    uniform float time;
    uniform float grayscale;
    varying vec2 vUv;

    float hash(vec2 p) { return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453); }
    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv, vec2 offset) {
      vec2 texel = vec2(thickness) / resolution;
      vec2 uvOff = uv + offset;
      float tl = luma(texture2D(tDiffuse, uvOff + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uvOff + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uvOff + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uvOff + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uvOff + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uvOff + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uvOff + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uvOff + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.03, 0.12, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec3 paper = vec3(0.96, 0.96, 0.86) - hash(floor(vUv * resolution)) * 0.03;

      float edge = 0.0;
      for (int i = 0; i < 3; i++) {
        vec2 offset = vec2(hash(vUv + float(i) * 0.1) - 0.5, hash(vUv + float(i) * 0.2 + 50.0) - 0.5) * 0.003;
        edge += detectEdge(vUv, offset);
      }
      edge = min(edge / 2.0, 1.0);

      vec3 finalColor = mix(paper, vec3(0.17), edge);
      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},tc={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},thickness:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float thickness;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 c) { return dot(c, vec3(0.299, 0.587, 0.114)); }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness * 1.5) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float l = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float t = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float b = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.04, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);
      float lum = luma(texColor.rgb);

      // Cream paper
      vec3 paper = vec3(1.0, 0.996, 0.94);
      vec3 ink = vec3(0.1, 0.1, 0.1);

      // Variable line width based on luminance
      float lineThickness = edge * (1.5 - lum * 0.5);

      // Ink wash for darker areas
      float wash = (1.0 - lum) * 0.15;

      vec3 finalColor = paper;
      finalColor = mix(finalColor, paper * 0.85, wash);
      finalColor = mix(finalColor, ink, min(lineThickness, 1.0));

      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},ec={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},saturation:{value:1.4},thickness:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform float saturation;
    uniform float thickness;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 color) {
      return dot(color, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(0.05, 0.15, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      // Boost saturation
      float gray = dot(texColor.rgb, vec3(0.299, 0.587, 0.114));
      vec3 saturated = mix(vec3(gray), texColor.rgb, saturation);
      saturated = clamp(saturated, 0.0, 1.0);

      // Thin dark outlines
      vec3 finalColor = mix(saturated, vec3(0.0), edge * 0.8);

      if (grayscale > 0.5) {
        float g = luma(finalColor);
        finalColor = vec3(g);
      }
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},qs={uniforms:{tDiffuse:{value:null},resolution:{value:new nt(1920,1080)},bgColor:{value:new ot(1,1,1)},lineColor:{value:new ot(0,0,0)},sceneBg:{value:new ot(1710638)},threshold:{value:.1},thickness:{value:1},showFills:{value:1},grayscale:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    uniform vec3 bgColor;
    uniform vec3 lineColor;
    uniform vec3 sceneBg;
    uniform float threshold;
    uniform float thickness;
    uniform float showFills;
    uniform float grayscale;
    varying vec2 vUv;

    float luma(vec3 color) {
      vec3 c = clamp(color, 0.0, 1.0);
      return dot(c, vec3(0.299, 0.587, 0.114));
    }

    float detectEdge(vec2 uv) {
      if (resolution.x < 1.0 || resolution.y < 1.0) return 0.0;
      vec2 texel = vec2(thickness) / resolution;
      float tl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, texel.y)).rgb);
      float t  = luma(texture2D(tDiffuse, uv + vec2(0.0, texel.y)).rgb);
      float tr = luma(texture2D(tDiffuse, uv + vec2(texel.x, texel.y)).rgb);
      float l  = luma(texture2D(tDiffuse, uv + vec2(-texel.x, 0.0)).rgb);
      float r  = luma(texture2D(tDiffuse, uv + vec2(texel.x, 0.0)).rgb);
      float bl = luma(texture2D(tDiffuse, uv + vec2(-texel.x, -texel.y)).rgb);
      float b  = luma(texture2D(tDiffuse, uv + vec2(0.0, -texel.y)).rgb);
      float br = luma(texture2D(tDiffuse, uv + vec2(texel.x, -texel.y)).rgb);
      float gx = -tl - 2.0*l - bl + tr + 2.0*r + br;
      float gy = -tl - 2.0*t - tr + bl + 2.0*b + br;
      return smoothstep(threshold, threshold + 0.1, sqrt(gx*gx + gy*gy));
    }

    void main() {
      vec4 texColor = texture2D(tDiffuse, vUv);
      float edge = detectEdge(vUv);

      // Detect background vs geometry by comparing to scene clear color
      float dist = length(texColor.rgb - sceneBg);
      float isGeometry = smoothstep(0.02, 0.08, dist);

      // Show block fills where geometry exists, style bgColor otherwise
      vec3 fills = mix(bgColor, texColor.rgb, isGeometry);

      // When fills are off, just show bgColor everywhere (edges-only mode)
      fills = mix(bgColor, fills, showFills);

      // Grayscale conversion
      if (grayscale > 0.5) {
        float g = luma(fills);
        fills = vec3(g);
      }

      // Overlay edge lines
      vec3 finalColor = mix(fills, lineColor, edge);
      gl_FragColor = vec4(finalColor, 1.0);
    }
  `};class Ks{constructor(t,e){console.log("[GPUStyleRenderer] Constructor called - initializing GPU-accelerated renderer"),this.engine=t,this.blockManager=e,this.renderer=t.renderer,this.scene=t.scene,this.camera=t.camera,this.enabled=!1,this.style="clean",this.inverted=!1,this.grayscale=!1,this.threshold=.5,this.lineWidth=2,this.showFills=!0,this.quality="medium",this.width=window.innerWidth,this.height=window.innerHeight,this.setupRenderTargets(),this.setupComposers(),this.createCharacterTexture(),this.time=0,this.lastLogTime=0,window.addEventListener("resize",()=>this.onResize())}setupRenderTargets(){const t={minFilter:ko,magFilter:ko,format:ds};this.sceneTarget=new Ce(this.width,this.height,t),this.edgeTarget=new Ce(this.width,this.height,t)}setupComposers(){this.composer=new Ws(this.renderer),this.stylePass=null}createCharacterTexture(){const t=document.createElement("canvas"),e=" .:-=+*#%@",o=16,i=24;t.width=o*e.length,t.height=i;const s=t.getContext("2d");s.fillStyle="#000000",s.fillRect(0,0,t.width,t.height),s.fillStyle="#ffffff",s.font="bold 20px monospace",s.textAlign="center",s.textBaseline="middle";for(let n=0;n<e.length;n++)s.fillText(e[n],n*o+o/2,i/2);this.charTexture=new fs(t),this.charTexture.minFilter=xe,this.charTexture.magFilter=xe}setEnabled(t){console.log(`[GPUStyleRenderer] setEnabled(${t}), style: ${this.style}`),this.enabled=t,t?(this.updateStyle(),this.engine.customRender=()=>this.render(),console.log("[GPUStyleRenderer] GPU rendering enabled, customRender hook set")):(this.engine.customRender=null,console.log("[GPUStyleRenderer] GPU rendering disabled, customRender hook cleared"))}setStyle(t){this.style=t,this.enabled&&this.updateStyle()}setInverted(t){this.inverted=t,this.updateStyleUniforms()}setGrayscale(t){this.grayscale=t,this.updateStyleUniforms()}setThreshold(t){this.threshold=t,this.updateStyleUniforms()}setLineWidth(t){this.lineWidth=t,this.updateStyleUniforms()}setShowFills(t){this.showFills=t,this.updateStyleUniforms()}setQuality(t){this.quality=t}updateStyle(){console.log(`[GPUStyleRenderer] updateStyle() called for style: ${this.style}`),this.composer&&(this.composer.dispose(),this.composer=null),this.composer=new Ws(this.renderer),this.composer.setSize(this.width,this.height),this.renderPass=new Nl(this.engine.scene,this.engine.camera),this.composer.addPass(this.renderPass);const e={clean:qs,sketch:Ql,ink:tc,crosshatch:Gl,blueprint:Jl,comic:Yl,saturated:ec,neon:$l,scifi:Kl,watercolor:ql,noir:Wl,synthwave:Hl,ascii:Vl}[this.style]||qs;if(console.log(`[GPUStyleRenderer] Using shader for style: ${this.style}`,e?"found":"NOT FOUND"),this.stylePass=new qt(e),this.composer.addPass(this.stylePass),["neon","synthwave","scifi"].includes(this.style)){const i=new Ne(new nt(this.width,this.height),.5,.4,.85);this.composer.addPass(i),console.log(`[GPUStyleRenderer] Added bloom pass for ${this.style}`)}const o=new Zl;o.renderToScreen=!0,this.composer.addPass(o),this.updateStyleUniforms(),console.log(`[GPUStyleRenderer] Composer setup complete. Passes: RenderPass -> StylePass -> ${["neon","synthwave","scifi"].includes(this.style)?"BloomPass -> ":""}OutputPass`)}updateStyleUniforms(){if(!this.stylePass)return;const t=this.getColors(),e=this.stylePass.uniforms;switch(e.resolution&&e.resolution.value.set(this.width,this.height),e.bgColor&&e.bgColor.value.set(t.bg),e.lineColor&&e.lineColor.value.set(t.fg),e.threshold&&(e.threshold.value=this.threshold*.3),e.thickness&&(e.thickness.value=this.lineWidth),e.showFills&&(e.showFills.value=this.showFills?1:0),e.grayscale&&(e.grayscale.value=this.grayscale?1:0),this.style){case"clean":break;case"crosshatch":e.spacing&&(e.spacing.value=10-this.lineWidth),e.lineWidth&&(e.lineWidth.value=this.lineWidth*.5);break;case"comic":e.dotSize.value=this.lineWidth*2,e.spacing.value=this.lineWidth*4,e.dotColor.value.set(t.fg);break;case"ascii":e.tCharacters.value=this.charTexture,e.charSize.value.set(8,16),e.textColor.value.set(t.fg),e.colorMode.value=this.grayscale?0:1;break;case"neon":e.glowColor.value.set(t.fg),e.accentColor.value.set(t.accent||16711935);break;case"noir":e.threshold.value=this.threshold;break;case"saturated":e.saturation.value=1.4;break}}getColors(){const t={clean:{bg:"#ffffff",fg:"#000000",accent:"#000000"},sketch:{bg:"#f5f5dc",fg:"#2c2c2c",accent:"#4a4a4a"},ink:{bg:"#fffef0",fg:"#1a1a1a",accent:"#000000"},crosshatch:{bg:"#ffffff",fg:"#000000",accent:"#444444"},blueprint:{bg:"#1e3a5f",fg:"#87ceeb",accent:"#add8e6"},comic:{bg:"#ffffff",fg:"#000000",accent:"#ff0000"},saturated:{bg:"#ffffff",fg:"#000000",accent:"#333333"},neon:{bg:"#0a0a0f",fg:"#00ffff",accent:"#ff00ff"},scifi:{bg:"#0d1117",fg:"#58a6ff",accent:"#238636"},watercolor:{bg:"#faf8f5",fg:"#2c4a52",accent:"#8b4513"},noir:{bg:"#000000",fg:"#ffffff",accent:"#808080"},synthwave:{bg:"#1a1a2e",fg:"#ff6ec7",accent:"#00fff7"},ascii:{bg:"#000000",fg:"#00ff00",accent:"#00aa00"}};let e=t[this.style]||t.clean;return this.inverted&&(e={...e,bg:e.fg,fg:e.bg}),e}onResize(){this.width=window.innerWidth,this.height=window.innerHeight,this.sceneTarget.setSize(this.width,this.height),this.edgeTarget.setSize(this.width,this.height),this.composer&&this.composer.setSize(this.width,this.height),this.sobelPass&&this.sobelPass.uniforms.resolution.value.set(this.width,this.height),this.updateStyleUniforms()}render(t=!1){if(!this.enabled){this.renderer.render(this.engine.scene,this.engine.camera);return}const e=Date.now();(!this.lastLogTime||e-this.lastLogTime>1e3)&&(console.log(`[GPUStyleRenderer] render() called (style: ${this.style}, composer: ${!!this.composer}, stylePass: ${!!this.stylePass})`),this.lastLogTime=e),this.time+=.016,this.stylePass&&this.stylePass.uniforms.time&&(this.stylePass.uniforms.time.value=this.time),this.renderer.setRenderTarget(null),this.composer.render()}update(){this.enabled&&this.render()}invalidateCache(){}capturePNG(t="render.png"){this.render(!0);const e=this.renderer.domElement,o=document.createElement("a");o.download=t,o.href=e.toDataURL("image/png"),o.click()}exportSVG(t="render.svg"){console.warn("SVG export not fully supported in GPU mode")}dispose(){this.composer&&(this.composer.dispose(),this.composer=null),this.sceneTarget.dispose(),this.edgeTarget.dispose(),this.charTexture&&this.charTexture.dispose()}}class oc{constructor(t){this.engine=t,this.frames=[],this.isCapturing=!1,this.onProgress=null}async captureFrame(t,e="image/jpeg",o=.92){var p;const i=(p=window.appInstance)==null?void 0:p.tattooRenderer,s=i&&i.constructor.name==="GPUStyleRenderer",n=i&&i.constructor.name==="TattooRenderer";s&&i.enabled?(console.log(`[FrameSequencer] Capturing frame ${t} with GPU style: ${i.style}`),i.render(!0),this.engine.renderer.getContext().finish(),console.log(`[FrameSequencer] GPU render complete for frame ${t}`)):n&&i.enabled?(this.engine.renderer.render(this.engine.scene,this.engine.camera),i.render(!0)):(this.engine.renderer.render(this.engine.scene,this.engine.camera),this.engine.renderer.getContext().finish());let r=this.engine.canvas;const a=document.getElementById("tattoo-overlay");if(n&&a&&a.style.display!=="none"){const h=document.createElement("canvas");h.width=this.engine.canvas.width,h.height=this.engine.canvas.height;const y=h.getContext("2d");y.drawImage(this.engine.canvas,0,0),y.drawImage(a,0,0),r=h}return new Promise(h=>{r.toBlob(y=>{h({frameNumber:t,blob:y,dataUrl:URL.createObjectURL(y),timestamp:Date.now()})},e,o)})}async captureSequence(t){const{animator:e,bookmarks:o,totalFrames:i,onProgress:s,format:n="image/jpeg",quality:r=.92}=t;if(o.length<2)throw new Error("Need at least 2 bookmarks to capture sequence");return this.frames=[],this.isCapturing=!0,await e.renderSequence(o,i,async(a,l)=>{const p=await this.captureFrame(a,n,r);this.frames.push(p),s&&s({current:a+1,total:l,percent:((a+1)/l*100).toFixed(1)})},()=>{this.isCapturing=!1}),this.frames}async exportIndividualFrames(t=null,e="frame_"){const o=t||this.frames;for(let i=0;i<o.length;i++){const s=o[i],n=document.createElement("a"),r=String(s.frameNumber).padStart(4,"0");n.download=`${e}${r}.jpg`,n.href=s.dataUrl,n.click(),await this.sleep(100)}}async exportAsZip(t=null,e="camera_sequence.zip"){const o=t||this.frames;if(!window.JSZip)throw new Error("JSZip library not loaded. Please include it in your project.");const i=window.JSZip,s=new i;for(const r of o){const a=String(r.frameNumber).padStart(4,"0"),l=r.blob.type==="image/png"?"png":"jpg";s.file(`frame_${a}.${l}`,r.blob)}const n=await s.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}});return this.downloadBlob(n,e),n}async exportAsMP4Realtime(t,e,o=3e3,i="camera_path.webm",s=null){const r=Math.floor(o/1e3*30);return console.log(`Exporting video: ${r} frames at 30 FPS`),this.exportAsMP4FrameByFrame(t,e,r,30,i,s)}async exportAsMP4FrameByFrame(t,e,o,i,s="camera_path.webm",n=null){var g;const r=(g=window.appInstance)==null?void 0:g.tattooRenderer,a=r&&r.constructor.name==="GPUStyleRenderer",l=r&&r.constructor.name==="TattooRenderer",p=document.getElementById("tattoo-overlay"),h=l&&p&&p.style.display!=="none",y=document.createElement("canvas");y.width=this.engine.canvas.width,y.height=this.engine.canvas.height;const c=y.getContext("2d",{willReadFrequently:!0});console.log(`Starting WebM export: ${o} frames at ${i} FPS`);const d=y.captureStream(i);let f="video/webm;codecs=vp9";MediaRecorder.isTypeSupported(f)||(f="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(f)||(f="video/webm"));const m=new MediaRecorder(d,{mimeType:f,videoBitsPerSecond:8e6}),x=[];return new Promise((b,z)=>{m.ondataavailable=M=>{M.data.size>0&&(x.push(M.data),console.log(`Chunk received: ${M.data.size} bytes (total chunks: ${x.length})`))},m.onstop=()=>{console.log(`Recording stopped. Total chunks: ${x.length}, total size: ${x.reduce((S,P)=>S+P.size,0)} bytes`);const M=new Blob(x,{type:f});if(console.log(`Final video blob size: ${M.size} bytes`),M.size<1e4){console.error("Video blob is suspiciously small - recording may have failed"),z(new Error("Video recording failed - file too small. Try using JPG Sequence export instead."));return}this.downloadBlob(M,s),b(M)},m.onerror=z,m.start(100);let v=0;const C=1e3/i;let B=performance.now();const A=()=>{if(v>=o){setTimeout(()=>{m.stop()},1e3);return}const M=t.getCameraAtFrame(v,o,e);t.setCameraState(M),a&&r&&r.enabled?(v%30===0&&console.log(`[FrameSequencer] Video frame ${v} using GPU style: ${r.style}`),r.render(!0),this.engine.renderer.getContext().finish()):l&&r&&r.enabled?(this.engine.renderer.render(this.engine.scene,this.engine.camera),r.render(!0)):(this.engine.renderer.render(this.engine.scene,this.engine.camera),this.engine.renderer.getContext().finish()),c.fillStyle=`rgb(${v%255}, 0, 0)`,c.fillRect(0,0,1,1),c.clearRect(0,0,y.width,y.height),c.drawImage(this.engine.canvas,0,0),h&&p&&c.drawImage(p,0,0),v%30===0&&console.log(`Frame ${v}/${o} rendered, camera:`,t.camera.position.x.toFixed(1),t.camera.position.y.toFixed(1),t.camera.position.z.toFixed(1)),v++,n&&n({current:v,total:o,percent:(v/o*100).toFixed(1)});const P=performance.now()-B,k=v*C,D=Math.max(0,k-P);setTimeout(()=>{requestAnimationFrame(A)},D)};requestAnimationFrame(A)})}async exportAsMP4RealtimeOld(t,e,o=3e3,i="camera_path.webm"){let s,n,r;if(hasTattooOverlay)n=document.createElement("canvas"),n.width=this.engine.canvas.width,n.height=this.engine.canvas.height,r=n.getContext("2d"),s=n.captureStream(30);else{if(!this.engine.canvas.captureStream)throw new Error("Canvas.captureStream() not supported in this browser");s=this.engine.canvas.captureStream(30)}let a="video/webm;codecs=vp9";MediaRecorder.isTypeSupported(a)||(a="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(a)||(a="video/webm"));const l=new MediaRecorder(s,{mimeType:a,videoBitsPerSecond:8e6}),p=[];return new Promise((h,y)=>{var c;if(l.ondataavailable=d=>{d.data.size>0&&p.push(d.data)},l.onstop=()=>{const d=new Blob(p,{type:a});this.downloadBlob(d,i),h(d)},l.onerror=d=>{y(d)},l.start(),n&&r){const d=(c=window.appInstance)==null?void 0:c.tattooRenderer,f=this.engine.onUpdate;this.engine.onUpdate=m=>{f&&f(m),d&&d.enabled&&d.render(),r.clearRect(0,0,n.width,n.height),r.drawImage(this.engine.canvas,0,0),tattooOverlay&&r.drawImage(tattooOverlay,0,0)},t.preview(e,o,()=>{this.engine.onUpdate=f,setTimeout(()=>{l.stop()},500)})}else t.preview(e,o,()=>{setTimeout(()=>{l.stop()},500)})})}downloadBlob(t,e){const o=URL.createObjectURL(t),i=document.createElement("a");i.href=o,i.download=e,i.click(),setTimeout(()=>URL.revokeObjectURL(o),100)}clear(){this.frames.forEach(t=>{t.dataUrl&&URL.revokeObjectURL(t.dataUrl)}),this.frames=[]}getMemoryUsage(){return(this.frames.reduce((e,o)=>e+o.blob.size,0)/1024/1024).toFixed(2)}sleep(t){return new Promise(e=>setTimeout(e,t))}}const or=0,ic=1,sc=2,Js=2,Mi=1.25,Qs=1,Rt=32,Et=Rt/4,ir=65535,ti=Math.pow(2,-24),bs=Symbol("SKIP_GENERATION"),sr={strategy:or,maxDepth:40,maxLeafSize:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null,[bs]:!1};function vt(u,t,e){return e.min.x=t[u],e.min.y=t[u+1],e.min.z=t[u+2],e.max.x=t[u+3],e.max.y=t[u+4],e.max.z=t[u+5],e}function tn(u){let t=-1,e=-1/0;for(let o=0;o<3;o++){const i=u[o+3]-u[o];i>e&&(e=i,t=o)}return t}function en(u,t){t.set(u)}function on(u,t,e){let o,i;for(let s=0;s<3;s++){const n=s+3;o=u[s],i=t[s],e[s]=o<i?o:i,o=u[n],i=t[n],e[n]=o>i?o:i}}function So(u,t,e){for(let o=0;o<3;o++){const i=t[u+2*o],s=t[u+2*o+1],n=i-s,r=i+s;n<e[o]&&(e[o]=n),r>e[o+3]&&(e[o+3]=r)}}function po(u){const t=u[3]-u[0],e=u[4]-u[1],o=u[5]-u[2];return 2*(t*e+e*o+o*t)}function St(u,t){return t[u+15]===ir}function Lt(u,t){return t[u+6]}function jt(u,t){return t[u+14]}function Dt(u){return u+Et}function Tt(u,t){const e=t[u+6];return u+e*Et}function zs(u,t){return t[u+7]}function Ei(u,t,e,o,i){let s=1/0,n=1/0,r=1/0,a=-1/0,l=-1/0,p=-1/0,h=1/0,y=1/0,c=1/0,d=-1/0,f=-1/0,m=-1/0;const x=u.offset||0;for(let g=(t-x)*6,b=(t+e-x)*6;g<b;g+=6){const z=u[g+0],v=u[g+1],C=z-v,B=z+v;C<s&&(s=C),B>a&&(a=B),z<h&&(h=z),z>d&&(d=z);const A=u[g+2],M=u[g+3],S=A-M,P=A+M;S<n&&(n=S),P>l&&(l=P),A<y&&(y=A),A>f&&(f=A);const k=u[g+4],D=u[g+5],F=k-D,T=k+D;F<r&&(r=F),T>p&&(p=T),k<c&&(c=k),k>m&&(m=k)}o[0]=s,o[1]=n,o[2]=r,o[3]=a,o[4]=l,o[5]=p,i[0]=h,i[1]=y,i[2]=c,i[3]=d,i[4]=f,i[5]=m}const fe=32,nc=(u,t)=>u.candidate-t.candidate,be=new Array(fe).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),_o=new Float32Array(6);function rc(u,t,e,o,i,s){let n=-1,r=0;if(s===or)n=tn(t),n!==-1&&(r=(t[n]+t[n+3])/2);else if(s===ic)n=tn(u),n!==-1&&(r=ac(e,o,i,n));else if(s===sc){const a=po(u);let l=Mi*i;const p=e.offset||0,h=(o-p)*6,y=(o+i-p)*6;for(let c=0;c<3;c++){const d=t[c],x=(t[c+3]-d)/fe;if(i<fe/4){const g=[...be];g.length=i;let b=0;for(let v=h;v<y;v+=6,b++){const C=g[b];C.candidate=e[v+2*c],C.count=0;const{bounds:B,leftCacheBounds:A,rightCacheBounds:M}=C;for(let S=0;S<3;S++)M[S]=1/0,M[S+3]=-1/0,A[S]=1/0,A[S+3]=-1/0,B[S]=1/0,B[S+3]=-1/0;So(v,e,B)}g.sort(nc);let z=i;for(let v=0;v<z;v++){const C=g[v];for(;v+1<z&&g[v+1].candidate===C.candidate;)g.splice(v+1,1),z--}for(let v=h;v<y;v+=6){const C=e[v+2*c];for(let B=0;B<z;B++){const A=g[B];C>=A.candidate?So(v,e,A.rightCacheBounds):(So(v,e,A.leftCacheBounds),A.count++)}}for(let v=0;v<z;v++){const C=g[v],B=C.count,A=i-C.count,M=C.leftCacheBounds,S=C.rightCacheBounds;let P=0;B!==0&&(P=po(M)/a);let k=0;A!==0&&(k=po(S)/a);const D=Qs+Mi*(P*B+k*A);D<l&&(n=c,l=D,r=C.candidate)}}else{for(let z=0;z<fe;z++){const v=be[z];v.count=0,v.candidate=d+x+z*x;const C=v.bounds;for(let B=0;B<3;B++)C[B]=1/0,C[B+3]=-1/0}for(let z=h;z<y;z+=6){let B=~~((e[z+2*c]-d)/x);B>=fe&&(B=fe-1);const A=be[B];A.count++,So(z,e,A.bounds)}const g=be[fe-1];en(g.bounds,g.rightCacheBounds);for(let z=fe-2;z>=0;z--){const v=be[z],C=be[z+1];on(v.bounds,C.rightCacheBounds,v.rightCacheBounds)}let b=0;for(let z=0;z<fe-1;z++){const v=be[z],C=v.count,B=v.bounds,M=be[z+1].rightCacheBounds;C!==0&&(b===0?en(B,_o):on(B,_o,_o)),b+=C;let S=0,P=0;b!==0&&(S=po(_o)/a);const k=i-b;k!==0&&(P=po(M)/a);const D=Qs+Mi*(S*b+P*k);D<l&&(n=c,l=D,r=v.candidate)}}}}else console.warn(`BVH: Invalid build strategy value ${s} used.`);return{axis:n,pos:r}}function ac(u,t,e,o){let i=0;const s=u.offset;for(let n=t,r=t+e;n<r;n++)i+=u[(n-s)*6+o*2];return i/e}class Si{constructor(){this.boundingData=new Float32Array(6)}}function lc(u,t,e,o,i,s){let n=o,r=o+i-1;const a=s.pos,l=s.axis*2,p=e.offset||0;for(;;){for(;n<=r&&e[(n-p)*6+l]<a;)n++;for(;n<=r&&e[(r-p)*6+l]>=a;)r--;if(n<r){for(let h=0;h<t;h++){let y=u[n*t+h];u[n*t+h]=u[r*t+h],u[r*t+h]=y}for(let h=0;h<6;h++){const y=n-p,c=r-p,d=e[y*6+h];e[y*6+h]=e[c*6+h],e[c*6+h]=d}n++,r--}else return n}}let nr,ei,Qi,rr;const cc=Math.pow(2,32);function ts(u){return"count"in u?1:1+ts(u.left)+ts(u.right)}function pc(u,t,e){return nr=new Float32Array(e),ei=new Uint32Array(e),Qi=new Uint16Array(e),rr=new Uint8Array(e),es(u,t)}function es(u,t){const e=u/4,o=u/2,i="count"in t,s=t.boundingData;for(let n=0;n<6;n++)nr[e+n]=s[n];if(i)return t.buffer?(rr.set(new Uint8Array(t.buffer),u),u+t.buffer.byteLength):(ei[e+6]=t.offset,Qi[o+14]=t.count,Qi[o+15]=ir,u+Rt);{const{left:n,right:r,splitAxis:a}=t,l=u+Rt;let p=es(l,n);const h=u/Rt,c=p/Rt-h;if(c>cc)throw new Error("MeshBVH: Cannot store relative child node offset greater than 32 bits.");return ei[e+6]=c,ei[e+7]=a,es(p,r)}}function hc(u,t,e,o,i){const{maxDepth:s,verbose:n,maxLeafSize:r,strategy:a,onProgress:l}=i,p=u.primitiveBuffer,h=u.primitiveBufferStride,y=new Float32Array(6);let c=!1;const d=new Si;return Ei(t,e,o,d.boundingData,y),m(d,e,o,y),d;function f(x){l&&l(x/o)}function m(x,g,b,z=null,v=0){if(!c&&v>=s&&(c=!0,n&&console.warn(`BVH: Max depth of ${s} reached when generating BVH. Consider increasing maxDepth.`)),b<=r||v>=s)return f(g+b),x.offset=g,x.count=b,x;const C=rc(x.boundingData,z,t,g,b,a);if(C.axis===-1)return f(g+b),x.offset=g,x.count=b,x;const B=lc(p,h,t,g,b,C);if(B===g||B===g+b)f(g+b),x.offset=g,x.count=b;else{x.splitAxis=C.axis;const A=new Si,M=g,S=B-g;x.left=A,Ei(t,M,S,A.boundingData,y),m(A,M,S,y,v+1);const P=new Si,k=B,D=b-S;x.right=P,Ei(t,k,D,P.boundingData,y),m(P,k,D,y,v+1)}return x}}function yc(u,t){const e=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,o=u.getRootRanges(t.range),i=o[0],s=o[o.length-1],n={offset:i.offset,count:s.offset+s.count-i.offset},r=new Float32Array(6*n.count);r.offset=n.offset,u.computePrimitiveBounds(n.offset,n.count,r),u._roots=o.map(a=>{const l=hc(u,r,a.offset,a.count,t),p=ts(l),h=new e(Rt*p);return pc(0,l,h),h})}class vs{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return t.length===0?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class uc{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=o=>{e&&t.push(e),e=o,this.float32Array=new Float32Array(o),this.uint16Array=new Uint16Array(o),this.uint32Array=new Uint32Array(o)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,t.length!==0&&this.setBuffer(t.pop())}}}const xt=new uc;let ke,to;const Ge=[],Do=new vs(()=>new ne);function dc(u,t,e,o,i,s){ke=Do.getPrimitive(),to=Do.getPrimitive(),Ge.push(ke,to),xt.setBuffer(u._roots[t]);const n=os(0,u.geometry,e,o,i,s);xt.clearBuffer(),Do.releasePrimitive(ke),Do.releasePrimitive(to),Ge.pop(),Ge.pop();const r=Ge.length;return r>0&&(to=Ge[r-1],ke=Ge[r-2]),n}function os(u,t,e,o,i=null,s=0,n=0){const{float32Array:r,uint16Array:a,uint32Array:l}=xt;let p=u*2;if(St(p,a)){const y=Lt(u,l),c=jt(p,a);return vt(u,r,ke),o(y,c,!1,n,s+u/Et,ke)}else{let S=function(k){const{uint16Array:D,uint32Array:F}=xt;let T=k*2;for(;!St(T,D);)k=Dt(k),T=k*2;return Lt(k,F)},P=function(k){const{uint16Array:D,uint32Array:F}=xt;let T=k*2;for(;!St(T,D);)k=Tt(k,F),T=k*2;return Lt(k,F)+jt(T,D)};const y=Dt(u),c=Tt(u,l);let d=y,f=c,m,x,g,b;if(i&&(g=ke,b=to,vt(d,r,g),vt(f,r,b),m=i(g),x=i(b),x<m)){d=c,f=y;const k=m;m=x,x=k,g=b}g||(g=ke,vt(d,r,g));const z=St(d*2,a),v=e(g,z,m,n+1,s+d/Et);let C;if(v===Js){const k=S(d),F=P(d)-k;C=o(k,F,!0,n+1,s+d/Et,g)}else C=v&&os(d,t,e,o,i,s,n+1);if(C)return!0;b=to,vt(f,r,b);const B=St(f*2,a),A=e(b,B,x,n+1,s+f/Et);let M;if(A===Js){const k=S(f),F=P(f)-k;M=o(k,F,!0,n+1,s+f/Et,b)}else M=A&&os(f,t,e,o,i,s,n+1);return!!M}}const vo=new xt.constructor,yi=new xt.constructor,Fe=new vs(()=>new ne),Ye=new ne,Ve=new ne,_i=new ne,Di=new ne;let Ti=!1;function fc(u,t,e,o){if(Ti)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Ti=!0;const i=u._roots,s=t._roots;let n,r=0,a=0;const l=new Ut().copy(e).invert();for(let p=0,h=i.length;p<h;p++){vo.setBuffer(i[p]),a=0;const y=Fe.getPrimitive();vt(0,vo.float32Array,y),y.applyMatrix4(l);for(let c=0,d=s.length;c<d&&(yi.setBuffer(s[c]),n=ie(0,0,e,l,o,r,a,0,0,y),yi.clearBuffer(),a+=s[c].byteLength/Rt,!n);c++);if(Fe.releasePrimitive(y),vo.clearBuffer(),r+=i[p].byteLength/Rt,n)break}return Ti=!1,n}function ie(u,t,e,o,i,s=0,n=0,r=0,a=0,l=null,p=!1){let h,y;p?(h=yi,y=vo):(h=vo,y=yi);const c=h.float32Array,d=h.uint32Array,f=h.uint16Array,m=y.float32Array,x=y.uint32Array,g=y.uint16Array,b=u*2,z=t*2,v=St(b,f),C=St(z,g);let B=!1;if(C&&v)p?B=i(Lt(t,x),jt(t*2,g),Lt(u,d),jt(u*2,f),a,n+t/Et,r,s+u/Et):B=i(Lt(u,d),jt(u*2,f),Lt(t,x),jt(t*2,g),r,s+u/Et,a,n+t/Et);else if(C){const A=Fe.getPrimitive();vt(t,m,A),A.applyMatrix4(e);const M=Dt(u),S=Tt(u,d);vt(M,c,Ye),vt(S,c,Ve);const P=A.intersectsBox(Ye),k=A.intersectsBox(Ve);B=P&&ie(t,M,o,e,i,n,s,a,r+1,A,!p)||k&&ie(t,S,o,e,i,n,s,a,r+1,A,!p),Fe.releasePrimitive(A)}else{const A=Dt(t),M=Tt(t,x);vt(A,m,_i),vt(M,m,Di);const S=l.intersectsBox(_i),P=l.intersectsBox(Di);if(S&&P)B=ie(u,A,e,o,i,s,n,r,a+1,l,p)||ie(u,M,e,o,i,s,n,r,a+1,l,p);else if(S)if(v)B=ie(u,A,e,o,i,s,n,r,a+1,l,p);else{const k=Fe.getPrimitive();k.copy(_i).applyMatrix4(e);const D=Dt(u),F=Tt(u,d);vt(D,c,Ye),vt(F,c,Ve);const T=k.intersectsBox(Ye),K=k.intersectsBox(Ve);B=T&&ie(A,D,o,e,i,n,s,a,r+1,k,!p)||K&&ie(A,F,o,e,i,n,s,a,r+1,k,!p),Fe.releasePrimitive(k)}else if(P)if(v)B=ie(u,M,e,o,i,s,n,r,a+1,l,p);else{const k=Fe.getPrimitive();k.copy(Di).applyMatrix4(e);const D=Dt(u),F=Tt(u,d);vt(D,c,Ye),vt(F,c,Ve);const T=k.intersectsBox(Ye),K=k.intersectsBox(Ve);B=T&&ie(M,D,o,e,i,n,s,a,r+1,k,!p)||K&&ie(M,F,o,e,i,n,s,a,r+1,k,!p),Fe.releasePrimitive(k)}}return B}const sn=new ne,$e=new Float32Array(6);class mc{constructor(){this._roots=null,this.primitiveBuffer=null,this.primitiveBufferStride=null}init(t){t={...sr,...t},yc(this,t)}getRootRanges(){throw new Error("BVH: getRootRanges() not implemented")}writePrimitiveBounds(){throw new Error("BVH: writePrimitiveBounds() not implemented")}writePrimitiveRangeBounds(t,e,o,i){let s=1/0,n=1/0,r=1/0,a=-1/0,l=-1/0,p=-1/0;for(let h=t,y=t+e;h<y;h++){this.writePrimitiveBounds(h,$e,0);const[c,d,f,m,x,g]=$e;c<s&&(s=c),m>a&&(a=m),d<n&&(n=d),x>l&&(l=x),f<r&&(r=f),g>p&&(p=g)}return o[i+0]=s,o[i+1]=n,o[i+2]=r,o[i+3]=a,o[i+4]=l,o[i+5]=p,o}computePrimitiveBounds(t,e,o){const i=o.offset||0;for(let s=t,n=t+e;s<n;s++){this.writePrimitiveBounds(s,$e,0);const[r,a,l,p,h,y]=$e,c=(r+p)/2,d=(a+h)/2,f=(l+y)/2,m=(p-r)/2,x=(h-a)/2,g=(y-l)/2,b=(s-i)*6;o[b+0]=c,o[b+1]=m+(Math.abs(c)+m)*ti,o[b+2]=d,o[b+3]=x+(Math.abs(d)+x)*ti,o[b+4]=f,o[b+5]=g+(Math.abs(f)+g)*ti}return o}shiftPrimitiveOffsets(t){const e=this._indirectBuffer;if(e)for(let o=0,i=e.length;o<i;o++)e[o]+=t;else{const o=this._roots;for(let i=0;i<o.length;i++){const s=o[i],n=new Uint32Array(s),r=new Uint16Array(s),a=s.byteLength/Rt;for(let l=0;l<a;l++){const p=Et*l,h=2*p;St(h,r)&&(n[p+6]+=t)}}}}traverse(t,e=0){const o=this._roots[e],i=new Uint32Array(o),s=new Uint16Array(o);n(0);function n(r,a=0){const l=r*2,p=St(l,s);if(p){const h=i[r+6],y=s[l+14];t(a,p,new Float32Array(o,r*4,6),h,y)}else{const h=Dt(r),y=Tt(r,i),c=zs(r,i);t(a,p,new Float32Array(o,r*4,6),c)||(n(h,a+1),n(y,a+1))}}}refit(){const t=this._roots;for(let e=0,o=t.length;e<o;e++){const i=t[e],s=new Uint32Array(i),n=new Uint16Array(i),r=new Float32Array(i),a=i.byteLength/Rt;for(let l=a-1;l>=0;l--){const p=l*Et,h=p*2;if(St(h,n)){const c=Lt(p,s),d=jt(h,n);this.writePrimitiveRangeBounds(c,d,$e,0),r.set($e,p)}else{const c=Dt(p),d=Tt(p,s);for(let f=0;f<3;f++){const m=r[c+f],x=r[c+f+3],g=r[d+f],b=r[d+f+3];r[p+f]=m<g?m:g,r[p+f+3]=x>b?x:b}}}}}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(o=>{vt(0,new Float32Array(o),sn),t.union(sn)}),t}shapecast(t){let{boundsTraverseOrder:e,intersectsBounds:o,intersectsRange:i,intersectsPrimitive:s,scratchPrimitive:n,iterate:r}=t;if(i&&s){const h=i;i=(y,c,d,f,m)=>h(y,c,d,f,m)?!0:r(y,c,this,s,d,f,n)}else i||(s?i=(h,y,c,d)=>r(h,y,this,s,c,d,n):i=(h,y,c)=>c);let a=!1,l=0;const p=this._roots;for(let h=0,y=p.length;h<y;h++){const c=p[h];if(a=dc(this,h,o,i,e,l),a)break;l+=c.byteLength/Rt}return a}bvhcast(t,e,o){let{intersectsRanges:i}=o;return fc(this,t,e,i)}}function xc(){return typeof SharedArrayBuffer<"u"}function Fs(u){return u.index?u.index.count:u.attributes.position.count}function zi(u){return Fs(u)/3}function gc(u,t=ArrayBuffer){return u>65535?new Uint32Array(new t(4*u)):new Uint16Array(new t(2*u))}function bc(u,t){if(!u.index){const e=u.attributes.position.count,o=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=gc(e,o);u.setIndex(new Nt(i,1));for(let s=0;s<e;s++)i[s]=s}}function zc(u,t,e){const o=Fs(u)/e,i=t||u.drawRange,s=i.start/e,n=(i.start+i.count)/e,r=Math.max(0,s),a=Math.min(o,n)-r;return{offset:Math.floor(r),count:Math.floor(a)}}function vc(u,t){return u.groups.map(e=>({offset:e.start/t,count:e.count/t}))}function nn(u,t,e){const o=zc(u,t,e),i=vc(u,e);if(!i.length)return[o];const s=[],n=o.offset,r=o.offset+o.count,a=Fs(u)/e,l=[];for(const y of i){const{offset:c,count:d}=y,f=c,m=isFinite(d)?d:a-c,x=c+m;f<r&&x>n&&(l.push({pos:Math.max(n,f),isStart:!0}),l.push({pos:Math.min(r,x),isStart:!1}))}l.sort((y,c)=>y.pos!==c.pos?y.pos-c.pos:y.type==="end"?-1:1);let p=0,h=null;for(const y of l){const c=y.pos;p!==0&&c!==h&&s.push({offset:h,count:c-h}),p+=y.isStart?1:-1,h=c}return s}function Fc(u,t){const e=u[u.length-1],o=e.offset+e.count>2**16,i=u.reduce((l,p)=>l+p.count,0),s=o?4:2,n=t?new SharedArrayBuffer(i*s):new ArrayBuffer(i*s),r=o?new Uint32Array(n):new Uint16Array(n);let a=0;for(let l=0;l<u.length;l++){const{offset:p,count:h}=u[l];for(let y=0;y<h;y++)r[a+y]=p+y;a+=h}return r}class wc extends mc{get indirect(){return!!this._indirectBuffer}get primitiveStride(){return null}get primitiveBufferStride(){return this.indirect?1:this.primitiveStride}set primitiveBufferStride(t){}get primitiveBuffer(){return this.indirect?this._indirectBuffer:this.geometry.index.array}set primitiveBuffer(t){}constructor(t,e={}){if(t.isBufferGeometry){if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("BVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("BVH: Only BufferGeometries are supported.");if(e.useSharedArrayBuffer&&!xc())throw new Error("BVH: SharedArrayBuffer is not available.");super(),this.geometry=t,this.resolvePrimitiveIndex=e.indirect?o=>this._indirectBuffer[o]:o=>o,this.primitiveBuffer=null,this.primitiveBufferStride=null,this._indirectBuffer=null,e={...sr,...e},e[bs]||this.init(e)}init(t){const{geometry:e,primitiveStride:o}=this;if(t.indirect){const i=nn(e,t.range,o),s=Fc(i,t.useSharedArrayBuffer);this._indirectBuffer=s}else bc(e,t);super.init(t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new ne))}getRootRanges(t){return this.indirect?[{offset:0,count:this._indirectBuffer.length}]:nn(this.geometry,t,this.primitiveStride)}raycastObject3D(){throw new Error("BVH: raycastObject3D() not implemented")}}class ge{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let o=1/0,i=-1/0;for(let s=0,n=t.length;s<n;s++){const a=t[s][e];o=a<o?a:o,i=a>i?a:i}this.min=o,this.max=i}setFromPoints(t,e){let o=1/0,i=-1/0;for(let s=0,n=e.length;s<n;s++){const r=e[s],a=t.dot(r);o=a<o?a:o,i=a>i?a:i}this.min=o,this.max=i}isSeparated(t){return this.min>t.max||t.min>this.max}}ge.prototype.setFromBox=(function(){const u=new X;return function(e,o){const i=o.min,s=o.max;let n=1/0,r=-1/0;for(let a=0;a<=1;a++)for(let l=0;l<=1;l++)for(let p=0;p<=1;p++){u.x=i.x*a+s.x*(1-a),u.y=i.y*l+s.y*(1-l),u.z=i.z*p+s.z*(1-p);const h=e.dot(u);n=Math.min(h,n),r=Math.max(h,r)}this.min=n,this.max=r}})();const kc=(function(){const u=new X,t=new X,e=new X;return function(i,s,n){const r=i.start,a=u,l=s.start,p=t;e.subVectors(r,l),u.subVectors(i.end,i.start),t.subVectors(s.end,s.start);const h=e.dot(p),y=p.dot(a),c=p.dot(p),d=e.dot(a),m=a.dot(a)*c-y*y;let x,g;m!==0?x=(h*y-d*c)/m:x=0,g=(h+x*y)/c,n.x=x,n.y=g}})(),ws=(function(){const u=new nt,t=new X,e=new X;return function(i,s,n,r){kc(i,s,u);let a=u.x,l=u.y;if(a>=0&&a<=1&&l>=0&&l<=1){i.at(a,n),s.at(l,r);return}else if(a>=0&&a<=1){l<0?s.at(0,r):s.at(1,r),i.closestPointToPoint(r,!0,n);return}else if(l>=0&&l<=1){a<0?i.at(0,n):i.at(1,n),s.closestPointToPoint(n,!0,r);return}else{let p;a<0?p=i.start:p=i.end;let h;l<0?h=s.start:h=s.end;const y=t,c=e;if(i.closestPointToPoint(h,!0,t),s.closestPointToPoint(p,!0,e),y.distanceToSquared(h)<=c.distanceToSquared(p)){n.copy(y),r.copy(h);return}else{n.copy(p),r.copy(c);return}}}})(),Bc=(function(){const u=new X,t=new X,e=new xi,o=new Qt;return function(s,n){const{radius:r,center:a}=s,{a:l,b:p,c:h}=n;if(o.start=l,o.end=p,o.closestPointToPoint(a,!0,u).distanceTo(a)<=r||(o.start=l,o.end=h,o.closestPointToPoint(a,!0,u).distanceTo(a)<=r)||(o.start=p,o.end=h,o.closestPointToPoint(a,!0,u).distanceTo(a)<=r))return!0;const f=n.getPlane(e);if(Math.abs(f.distanceToPoint(a))<=r){const x=f.projectPoint(a,t);if(n.containsPoint(x))return!0}return!1}})(),Cc=["x","y","z"],me=1e-15,rn=me*me;function $t(u){return Math.abs(u)<me}class te extends Gt{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new X),this.satBounds=new Array(4).fill().map(()=>new ge),this.points=[this.a,this.b,this.c],this.plane=new xi,this.isDegenerateIntoSegment=!1,this.isDegenerateIntoPoint=!1,this.degenerateSegment=new Qt,this.needsUpdate=!0}intersectsSphere(t){return Bc(t,this)}update(){const t=this.a,e=this.b,o=this.c,i=this.points,s=this.satAxes,n=this.satBounds,r=s[0],a=n[0];this.getNormal(r),a.setFromPoints(r,i);const l=s[1],p=n[1];l.subVectors(t,e),p.setFromPoints(l,i);const h=s[2],y=n[2];h.subVectors(e,o),y.setFromPoints(h,i);const c=s[3],d=n[3];c.subVectors(o,t),d.setFromPoints(c,i);const f=l.length(),m=h.length(),x=c.length();this.isDegenerateIntoPoint=!1,this.isDegenerateIntoSegment=!1,f<me?m<me||x<me?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(t),this.degenerateSegment.end.copy(o)):m<me?x<me?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(e),this.degenerateSegment.end.copy(t)):x<me&&(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(o),this.degenerateSegment.end.copy(e)),this.plane.setFromNormalAndCoplanarPoint(r,t),this.needsUpdate=!1}}te.prototype.closestPointToSegment=(function(){const u=new X,t=new X,e=new Qt;return function(i,s=null,n=null){const{start:r,end:a}=i,l=this.points;let p,h=1/0;for(let y=0;y<3;y++){const c=(y+1)%3;e.start.copy(l[y]),e.end.copy(l[c]),ws(e,i,u,t),p=u.distanceToSquared(t),p<h&&(h=p,s&&s.copy(u),n&&n.copy(t))}return this.closestPointToPoint(r,u),p=r.distanceToSquared(u),p<h&&(h=p,s&&s.copy(u),n&&n.copy(r)),this.closestPointToPoint(a,u),p=a.distanceToSquared(u),p<h&&(h=p,s&&s.copy(u),n&&n.copy(a)),Math.sqrt(h)}})();te.prototype.intersectsTriangle=(function(){const u=new te,t=new ge,e=new ge,o=new X,i=new X,s=new X,n=new X,r=new Qt,a=new Qt,l=new X,p=new nt,h=new nt;function y(b,z,v,C){const B=o;!b.isDegenerateIntoPoint&&!b.isDegenerateIntoSegment?B.copy(b.plane.normal):B.copy(z.plane.normal);const A=b.satBounds,M=b.satAxes;for(let k=1;k<4;k++){const D=A[k],F=M[k];if(t.setFromPoints(F,z.points),D.isSeparated(t)||(n.copy(B).cross(F),t.setFromPoints(n,b.points),e.setFromPoints(n,z.points),t.isSeparated(e)))return!1}const S=z.satBounds,P=z.satAxes;for(let k=1;k<4;k++){const D=S[k],F=P[k];if(t.setFromPoints(F,b.points),D.isSeparated(t)||(n.crossVectors(B,F),t.setFromPoints(n,b.points),e.setFromPoints(n,z.points),t.isSeparated(e)))return!1}return v&&(C||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),v.start.set(0,0,0),v.end.set(0,0,0)),!0}function c(b,z,v,C,B,A,M,S,P,k,D){let F=M/(M-S);k.x=C+(B-C)*F,D.start.subVectors(z,b).multiplyScalar(F).add(b),F=M/(M-P),k.y=C+(A-C)*F,D.end.subVectors(v,b).multiplyScalar(F).add(b)}function d(b,z,v,C,B,A,M,S,P,k,D){if(B>0)c(b.c,b.a,b.b,C,z,v,P,M,S,k,D);else if(A>0)c(b.b,b.a,b.c,v,z,C,S,M,P,k,D);else if(S*P>0||M!=0)c(b.a,b.b,b.c,z,v,C,M,S,P,k,D);else if(S!=0)c(b.b,b.a,b.c,v,z,C,S,M,P,k,D);else if(P!=0)c(b.c,b.a,b.b,C,z,v,P,M,S,k,D);else return!0;return!1}function f(b,z,v,C){const B=z.degenerateSegment,A=b.plane.distanceToPoint(B.start),M=b.plane.distanceToPoint(B.end);return $t(A)?$t(M)?y(b,z,v,C):(v&&(v.start.copy(B.start),v.end.copy(B.start)),b.containsPoint(B.start)):$t(M)?(v&&(v.start.copy(B.end),v.end.copy(B.end)),b.containsPoint(B.end)):b.plane.intersectLine(B,o)!=null?(v&&(v.start.copy(o),v.end.copy(o)),b.containsPoint(o)):!1}function m(b,z,v){const C=z.a;return $t(b.plane.distanceToPoint(C))&&b.containsPoint(C)?(v&&(v.start.copy(C),v.end.copy(C)),!0):!1}function x(b,z,v){const C=b.degenerateSegment,B=z.a;return C.closestPointToPoint(B,!0,o),B.distanceToSquared(o)<rn?(v&&(v.start.copy(B),v.end.copy(B)),!0):!1}function g(b,z,v,C){if(b.isDegenerateIntoSegment)if(z.isDegenerateIntoSegment){const B=b.degenerateSegment,A=z.degenerateSegment,M=i,S=s;B.delta(M),A.delta(S);const P=o.subVectors(A.start,B.start),k=M.x*S.y-M.y*S.x;if($t(k))return!1;const D=(P.x*S.y-P.y*S.x)/k,F=-(M.x*P.y-M.y*P.x)/k;if(D<0||D>1||F<0||F>1)return!1;const T=B.start.z+M.z*D,K=A.start.z+S.z*F;return $t(T-K)?(v&&(v.start.copy(B.start).addScaledVector(M,D),v.end.copy(B.start).addScaledVector(M,D)),!0):!1}else return z.isDegenerateIntoPoint?x(b,z,v):f(z,b,v,C);else{if(b.isDegenerateIntoPoint)return z.isDegenerateIntoPoint?z.a.distanceToSquared(b.a)<rn?(v&&(v.start.copy(b.a),v.end.copy(b.a)),!0):!1:z.isDegenerateIntoSegment?x(z,b,v):m(z,b,v);if(z.isDegenerateIntoPoint)return m(b,z,v);if(z.isDegenerateIntoSegment)return f(b,z,v,C)}}return function(z,v=null,C=!1){this.needsUpdate&&this.update(),z.isExtendedTriangle?z.needsUpdate&&z.update():(u.copy(z),u.update(),z=u);const B=g(this,z,v,C);if(B!==void 0)return B;const A=this.plane,M=z.plane;let S=M.distanceToPoint(this.a),P=M.distanceToPoint(this.b),k=M.distanceToPoint(this.c);$t(S)&&(S=0),$t(P)&&(P=0),$t(k)&&(k=0);const D=S*P,F=S*k;if(D>0&&F>0)return!1;let T=A.distanceToPoint(z.a),K=A.distanceToPoint(z.b),G=A.distanceToPoint(z.c);$t(T)&&(T=0),$t(K)&&(K=0),$t(G)&&(G=0);const rt=T*K,$=T*G;if(rt>0&&$>0)return!1;i.copy(A.normal),s.copy(M.normal);const et=i.cross(s);let j=0,O=Math.abs(et.x);const tt=Math.abs(et.y);tt>O&&(O=tt,j=1),Math.abs(et.z)>O&&(j=2);const W=Cc[j],ut=this.a[W],Bt=this.b[W],lt=this.c[W],ht=z.a[W],gt=z.b[W],mt=z.c[W];if(d(this,ut,Bt,lt,D,F,S,P,k,p,r))return y(this,z,v,C);if(d(z,ht,gt,mt,rt,$,T,K,G,h,a))return y(this,z,v,C);if(p.y<p.x){const Pt=p.y;p.y=p.x,p.x=Pt,l.copy(r.start),r.start.copy(r.end),r.end.copy(l)}if(h.y<h.x){const Pt=h.y;h.y=h.x,h.x=Pt,l.copy(a.start),a.start.copy(a.end),a.end.copy(l)}return p.y<h.x||h.y<p.x?!1:(v&&(h.x>p.x?v.start.copy(a.start):v.start.copy(r.start),h.y<p.y?v.end.copy(a.end):v.end.copy(r.end)),!0)}})();te.prototype.distanceToPoint=(function(){const u=new X;return function(e){return this.closestPointToPoint(e,u),e.distanceTo(u)}})();te.prototype.distanceToTriangle=(function(){const u=new X,t=new X,e=["a","b","c"],o=new Qt,i=new Qt;return function(n,r=null,a=null){const l=r||a?o:null;if(this.intersectsTriangle(n,l))return(r||a)&&(r&&l.getCenter(r),a&&l.getCenter(a)),0;let p=1/0;for(let h=0;h<3;h++){let y;const c=e[h],d=n[c];this.closestPointToPoint(d,u),y=d.distanceToSquared(u),y<p&&(p=y,r&&r.copy(u),a&&a.copy(d));const f=this[c];n.closestPointToPoint(f,u),y=f.distanceToSquared(u),y<p&&(p=y,r&&r.copy(f),a&&a.copy(u))}for(let h=0;h<3;h++){const y=e[h],c=e[(h+1)%3];o.set(this[y],this[c]);for(let d=0;d<3;d++){const f=e[d],m=e[(d+1)%3];i.set(n[f],n[m]),ws(o,i,u,t);const x=u.distanceToSquared(t);x<p&&(p=x,r&&r.copy(u),a&&a.copy(t))}}return Math.sqrt(p)}})();class Xt{constructor(t,e,o){this.isOrientedBox=!0,this.min=new X,this.max=new X,this.matrix=new Ut,this.invMatrix=new Ut,this.points=new Array(8).fill().map(()=>new X),this.satAxes=new Array(3).fill().map(()=>new X),this.satBounds=new Array(3).fill().map(()=>new ge),this.alignedSatBounds=new Array(3).fill().map(()=>new ge),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),o&&this.matrix.copy(o)}set(t,e,o){this.min.copy(t),this.max.copy(e),this.matrix.copy(o),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}Xt.prototype.update=(function(){return function(){const t=this.matrix,e=this.min,o=this.max,i=this.points;for(let l=0;l<=1;l++)for(let p=0;p<=1;p++)for(let h=0;h<=1;h++){const y=1*l|2*p|4*h,c=i[y];c.x=l?o.x:e.x,c.y=p?o.y:e.y,c.z=h?o.z:e.z,c.applyMatrix4(t)}const s=this.satBounds,n=this.satAxes,r=i[0];for(let l=0;l<3;l++){const p=n[l],h=s[l],y=1<<l,c=i[y];p.subVectors(r,c),h.setFromPoints(p,i)}const a=this.alignedSatBounds;a[0].setFromPointsField(i,"x"),a[1].setFromPointsField(i,"y"),a[2].setFromPointsField(i,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}})();Xt.prototype.intersectsBox=(function(){const u=new ge;return function(e){this.needsUpdate&&this.update();const o=e.min,i=e.max,s=this.satBounds,n=this.satAxes,r=this.alignedSatBounds;if(u.min=o.x,u.max=i.x,r[0].isSeparated(u)||(u.min=o.y,u.max=i.y,r[1].isSeparated(u))||(u.min=o.z,u.max=i.z,r[2].isSeparated(u)))return!1;for(let a=0;a<3;a++){const l=n[a],p=s[a];if(u.setFromBox(l,e),p.isSeparated(u))return!1}return!0}})();Xt.prototype.intersectsTriangle=(function(){const u=new te,t=new Array(3),e=new ge,o=new ge,i=new X;return function(n){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(u.copy(n),u.update(),n=u);const r=this.satBounds,a=this.satAxes;t[0]=n.a,t[1]=n.b,t[2]=n.c;for(let y=0;y<3;y++){const c=r[y],d=a[y];if(e.setFromPoints(d,t),c.isSeparated(e))return!1}const l=n.satBounds,p=n.satAxes,h=this.points;for(let y=0;y<3;y++){const c=l[y],d=p[y];if(e.setFromPoints(d,h),c.isSeparated(e))return!1}for(let y=0;y<3;y++){const c=a[y];for(let d=0;d<4;d++){const f=p[d];if(i.crossVectors(c,f),e.setFromPoints(i,t),o.setFromPoints(i,h),e.isSeparated(o))return!1}}return!0}})();Xt.prototype.closestPointToPoint=(function(){return function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}})();Xt.prototype.distanceToPoint=(function(){const u=new X;return function(e){return this.closestPointToPoint(e,u),e.distanceTo(u)}})();Xt.prototype.distanceToBox=(function(){const u=["x","y","z"],t=new Array(12).fill().map(()=>new Qt),e=new Array(12).fill().map(()=>new Qt),o=new X,i=new X;return function(n,r=0,a=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(n))return(a||l)&&(n.getCenter(i),this.closestPointToPoint(i,o),n.closestPointToPoint(o,i),a&&a.copy(o),l&&l.copy(i)),0;const p=r*r,h=n.min,y=n.max,c=this.points;let d=1/0;for(let m=0;m<8;m++){const x=c[m];i.copy(x).clamp(h,y);const g=x.distanceToSquared(i);if(g<d&&(d=g,a&&a.copy(x),l&&l.copy(i),g<p))return Math.sqrt(g)}let f=0;for(let m=0;m<3;m++)for(let x=0;x<=1;x++)for(let g=0;g<=1;g++){const b=(m+1)%3,z=(m+2)%3,v=x<<b|g<<z,C=1<<m|x<<b|g<<z,B=c[v],A=c[C];t[f].set(B,A);const S=u[m],P=u[b],k=u[z],D=e[f],F=D.start,T=D.end;F[S]=h[S],F[P]=x?h[P]:y[P],F[k]=g?h[k]:y[P],T[S]=y[S],T[P]=x?h[P]:y[P],T[k]=g?h[k]:y[P],f++}for(let m=0;m<=1;m++)for(let x=0;x<=1;x++)for(let g=0;g<=1;g++){i.x=m?y.x:h.x,i.y=x?y.y:h.y,i.z=g?y.z:h.z,this.closestPointToPoint(i,o);const b=i.distanceToSquared(o);if(b<d&&(d=b,a&&a.copy(o),l&&l.copy(i),b<p))return Math.sqrt(b)}for(let m=0;m<12;m++){const x=t[m];for(let g=0;g<12;g++){const b=e[g];ws(x,b,o,i);const z=o.distanceToSquared(i);if(z<d&&(d=z,a&&a.copy(o),l&&l.copy(i),z<p))return Math.sqrt(z)}}return Math.sqrt(d)}})();class Ac extends vs{constructor(){super(()=>new te)}}const Jt=new Ac,ho=new X,Pi=new X;function Mc(u,t,e={},o=0,i=1/0){const s=o*o,n=i*i;let r=1/0,a=null;if(u.shapecast({boundsTraverseOrder:p=>(ho.copy(t).clamp(p.min,p.max),ho.distanceToSquared(t)),intersectsBounds:(p,h,y)=>y<r&&y<n,intersectsTriangle:(p,h)=>{p.closestPointToPoint(t,ho);const y=t.distanceToSquared(ho);return y<r&&(Pi.copy(ho),r=y,a=h),y<s}}),r===1/0)return null;const l=Math.sqrt(r);return e.point?e.point.copy(Pi):e.point=Pi.clone(),e.distance=l,e.faceIndex=a,e}const To=parseInt(us)>=169,Ec=parseInt(us)<=161,Ee=new X,Se=new X,_e=new X,Po=new nt,Io=new nt,Ro=new nt,an=new X,ln=new X,cn=new X,yo=new X;function Sc(u,t,e,o,i,s,n,r){let a;if(s===ra?a=u.intersectTriangle(o,e,t,!0,i):a=u.intersectTriangle(t,e,o,s!==Ae,i),a===null)return null;const l=u.origin.distanceTo(i);return l<n||l>r?null:{distance:l,point:i.clone()}}function pn(u,t,e,o,i,s,n,r,a,l,p){Ee.fromBufferAttribute(t,s),Se.fromBufferAttribute(t,n),_e.fromBufferAttribute(t,r);const h=Sc(u,Ee,Se,_e,yo,a,l,p);if(h){if(o){Po.fromBufferAttribute(o,s),Io.fromBufferAttribute(o,n),Ro.fromBufferAttribute(o,r),h.uv=new nt;const c=Gt.getInterpolation(yo,Ee,Se,_e,Po,Io,Ro,h.uv);To||(h.uv=c)}if(i){Po.fromBufferAttribute(i,s),Io.fromBufferAttribute(i,n),Ro.fromBufferAttribute(i,r),h.uv1=new nt;const c=Gt.getInterpolation(yo,Ee,Se,_e,Po,Io,Ro,h.uv1);To||(h.uv1=c),Ec&&(h.uv2=h.uv1)}if(e){an.fromBufferAttribute(e,s),ln.fromBufferAttribute(e,n),cn.fromBufferAttribute(e,r),h.normal=new X;const c=Gt.getInterpolation(yo,Ee,Se,_e,an,ln,cn,h.normal);h.normal.dot(u.direction)>0&&h.normal.multiplyScalar(-1),To||(h.normal=c)}const y={a:s,b:n,c:r,normal:new X,materialIndex:0};if(Gt.getNormal(Ee,Se,_e,y.normal),h.face=y,h.faceIndex=s,To){const c=new X;Gt.getBarycoord(yo,Ee,Se,_e,c),h.barycoord=c}}return h}function hn(u){return u&&u.isMaterial?u.side:u}function vi(u,t,e,o,i,s,n){const r=o*3;let a=r+0,l=r+1,p=r+2;const{index:h,groups:y}=u;u.index&&(a=h.getX(a),l=h.getX(l),p=h.getX(p));const{position:c,normal:d,uv:f,uv1:m}=u.attributes;if(Array.isArray(t)){const x=o*3;for(let g=0,b=y.length;g<b;g++){const{start:z,count:v,materialIndex:C}=y[g];if(x>=z&&x<z+v){const B=hn(t[C]),A=pn(e,c,d,f,m,a,l,p,B,s,n);if(A)if(A.faceIndex=o,A.face.materialIndex=C,i)i.push(A);else return A}}}else{const x=hn(t),g=pn(e,c,d,f,m,a,l,p,x,s,n);if(g)if(g.faceIndex=o,g.face.materialIndex=0,i)i.push(g);else return g}return null}function At(u,t,e,o){const i=u.a,s=u.b,n=u.c;let r=t,a=t+1,l=t+2;e&&(r=e.getX(r),a=e.getX(a),l=e.getX(l)),i.x=o.getX(r),i.y=o.getY(r),i.z=o.getZ(r),s.x=o.getX(a),s.y=o.getY(a),s.z=o.getZ(a),n.x=o.getX(l),n.y=o.getY(l),n.z=o.getZ(l)}function _c(u,t,e,o,i,s,n,r){const{geometry:a,_indirectBuffer:l}=u;for(let p=o,h=o+i;p<h;p++)vi(a,t,e,p,s,n,r)}function Dc(u,t,e,o,i,s,n){const{geometry:r,_indirectBuffer:a}=u;let l=1/0,p=null;for(let h=o,y=o+i;h<y;h++){let c;c=vi(r,t,e,h,null,s,n),c&&c.distance<l&&(p=c,l=c.distance)}return p}function Tc(u,t,e,o,i,s,n){const{geometry:r}=e,{index:a}=r,l=r.attributes.position;for(let p=u,h=t+u;p<h;p++){let y;if(y=p,At(n,y*3,a,l),n.needsUpdate=!0,o(n,y,i,s))return!0}return!1}function Pc(u,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=u.geometry,o=e.index?e.index.array:null,i=e.attributes.position;let s,n,r,a,l=0;const p=u._roots;for(let y=0,c=p.length;y<c;y++)s=p[y],n=new Uint32Array(s),r=new Uint16Array(s),a=new Float32Array(s),h(0,l),l+=s.byteLength;function h(y,c,d=!1){const f=y*2;if(St(f,r)){const m=Lt(y,n),x=jt(f,r);let g=1/0,b=1/0,z=1/0,v=-1/0,C=-1/0,B=-1/0;for(let A=3*m,M=3*(m+x);A<M;A++){let S=o[A];const P=i.getX(S),k=i.getY(S),D=i.getZ(S);P<g&&(g=P),P>v&&(v=P),k<b&&(b=k),k>C&&(C=k),D<z&&(z=D),D>B&&(B=D)}return a[y+0]!==g||a[y+1]!==b||a[y+2]!==z||a[y+3]!==v||a[y+4]!==C||a[y+5]!==B?(a[y+0]=g,a[y+1]=b,a[y+2]=z,a[y+3]=v,a[y+4]=C,a[y+5]=B,!0):!1}else{const m=Dt(y),x=Tt(y,n);let g=d,b=!1,z=!1;if(t){if(!g){const S=m/Et+c/Rt,P=x/Et+c/Rt;b=t.has(S),z=t.has(P),g=!b&&!z}}else b=!0,z=!0;const v=g||b,C=g||z;let B=!1;v&&(B=h(m,c,g));let A=!1;C&&(A=h(x,c,g));const M=B||A;if(M)for(let S=0;S<3;S++){const P=m+S,k=x+S,D=a[P],F=a[P+3],T=a[k],K=a[k+3];a[y+S]=D<T?D:T,a[y+S+3]=F>K?F:K}return M}}}function Me(u,t,e,o,i){let s,n,r,a,l,p;const h=1/e.direction.x,y=1/e.direction.y,c=1/e.direction.z,d=e.origin.x,f=e.origin.y,m=e.origin.z;let x=t[u],g=t[u+3],b=t[u+1],z=t[u+3+1],v=t[u+2],C=t[u+3+2];return h>=0?(s=(x-d)*h,n=(g-d)*h):(s=(g-d)*h,n=(x-d)*h),y>=0?(r=(b-f)*y,a=(z-f)*y):(r=(z-f)*y,a=(b-f)*y),s>a||r>n||((r>s||isNaN(s))&&(s=r),(a<n||isNaN(n))&&(n=a),c>=0?(l=(v-m)*c,p=(C-m)*c):(l=(C-m)*c,p=(v-m)*c),s>p||l>n)?!1:((l>s||s!==s)&&(s=l),(p<n||n!==n)&&(n=p),s<=i&&n>=o)}function Ic(u,t,e,o,i,s,n,r){const{geometry:a,_indirectBuffer:l}=u;for(let p=o,h=o+i;p<h;p++){let y=l?l[p]:p;vi(a,t,e,y,s,n,r)}}function Rc(u,t,e,o,i,s,n){const{geometry:r,_indirectBuffer:a}=u;let l=1/0,p=null;for(let h=o,y=o+i;h<y;h++){let c;c=vi(r,t,e,a?a[h]:h,null,s,n),c&&c.distance<l&&(p=c,l=c.distance)}return p}function Lc(u,t,e,o,i,s,n){const{geometry:r}=e,{index:a}=r,l=r.attributes.position;for(let p=u,h=t+u;p<h;p++){let y;if(y=e.resolveTriangleIndex(p),At(n,y*3,a,l),n.needsUpdate=!0,o(n,y,i,s))return!0}return!1}function Uc(u,t,e,o,i,s,n){xt.setBuffer(u._roots[t]),is(0,u,e,o,i,s,n),xt.clearBuffer()}function is(u,t,e,o,i,s,n){const{float32Array:r,uint16Array:a,uint32Array:l}=xt,p=u*2;if(St(p,a)){const y=Lt(u,l),c=jt(p,a);_c(t,e,o,y,c,i,s,n)}else{const y=Dt(u);Me(y,r,o,s,n)&&is(y,t,e,o,i,s,n);const c=Tt(u,l);Me(c,r,o,s,n)&&is(c,t,e,o,i,s,n)}}const Oc=["x","y","z"];function Nc(u,t,e,o,i,s){xt.setBuffer(u._roots[t]);const n=ss(0,u,e,o,i,s);return xt.clearBuffer(),n}function ss(u,t,e,o,i,s){const{float32Array:n,uint16Array:r,uint32Array:a}=xt;let l=u*2;if(St(l,r)){const h=Lt(u,a),y=jt(l,r);return Dc(t,e,o,h,y,i,s)}else{const h=zs(u,a),y=Oc[h],d=o.direction[y]>=0;let f,m;d?(f=Dt(u),m=Tt(u,a)):(f=Tt(u,a),m=Dt(u));const g=Me(f,n,o,i,s)?ss(f,t,e,o,i,s):null;if(g){const v=g.point[y];if(d?v<=n[m+h]:v>=n[m+h+3])return g}const z=Me(m,n,o,i,s)?ss(m,t,e,o,i,s):null;return g&&z?g.distance<=z.distance?g:z:g||z||null}}const Lo=new ne,He=new te,We=new te,uo=new Ut,yn=new Xt,Uo=new Xt;function jc(u,t,e,o){xt.setBuffer(u._roots[t]);const i=ns(0,u,e,o);return xt.clearBuffer(),i}function ns(u,t,e,o,i=null){const{float32Array:s,uint16Array:n,uint32Array:r}=xt;let a=u*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),yn.set(e.boundingBox.min,e.boundingBox.max,o),i=yn),St(a,n)){const p=t.geometry,h=p.index,y=p.attributes.position,c=e.index,d=e.attributes.position,f=Lt(u,r),m=jt(a,n);if(uo.copy(o).invert(),e.boundsTree)return vt(u,s,Uo),Uo.matrix.copy(uo),Uo.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:g=>Uo.intersectsBox(g),intersectsTriangle:g=>{g.a.applyMatrix4(o),g.b.applyMatrix4(o),g.c.applyMatrix4(o),g.needsUpdate=!0;for(let b=f*3,z=(m+f)*3;b<z;b+=3)if(At(We,b,h,y),We.needsUpdate=!0,g.intersectsTriangle(We))return!0;return!1}});{const x=zi(e);for(let g=f*3,b=(m+f)*3;g<b;g+=3){At(He,g,h,y),He.a.applyMatrix4(uo),He.b.applyMatrix4(uo),He.c.applyMatrix4(uo),He.needsUpdate=!0;for(let z=0,v=x*3;z<v;z+=3)if(At(We,z,c,d),We.needsUpdate=!0,He.intersectsTriangle(We))return!0}}}else{const p=Dt(u),h=Tt(u,r);return vt(p,s,Lo),!!(i.intersectsBox(Lo)&&ns(p,t,e,o,i)||(vt(h,s,Lo),i.intersectsBox(Lo)&&ns(h,t,e,o,i)))}}const Oo=new Ut,Ii=new Xt,fo=new Xt,Xc=new X,Zc=new X,Gc=new X,Yc=new X;function Vc(u,t,e,o={},i={},s=0,n=1/0){t.boundingBox||t.computeBoundingBox(),Ii.set(t.boundingBox.min,t.boundingBox.max,e),Ii.needsUpdate=!0;const r=u.geometry,a=r.attributes.position,l=r.index,p=t.attributes.position,h=t.index,y=Jt.getPrimitive(),c=Jt.getPrimitive();let d=Xc,f=Zc,m=null,x=null;i&&(m=Gc,x=Yc);let g=1/0,b=null,z=null;return Oo.copy(e).invert(),fo.matrix.copy(Oo),u.shapecast({boundsTraverseOrder:v=>Ii.distanceToBox(v),intersectsBounds:(v,C,B)=>B<g&&B<n?(C&&(fo.min.copy(v.min),fo.max.copy(v.max),fo.needsUpdate=!0),!0):!1,intersectsRange:(v,C)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:A=>fo.distanceToBox(A),intersectsBounds:(A,M,S)=>S<g&&S<n,intersectsRange:(A,M)=>{for(let S=A,P=A+M;S<P;S++){At(c,3*S,h,p),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let k=v,D=v+C;k<D;k++){At(y,3*k,l,a),y.needsUpdate=!0;const F=y.distanceToTriangle(c,d,m);if(F<g&&(f.copy(d),x&&x.copy(m),g=F,b=k,z=S),F<s)return!0}}}});{const B=zi(t);for(let A=0,M=B;A<M;A++){At(c,3*A,h,p),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let S=v,P=v+C;S<P;S++){At(y,3*S,l,a),y.needsUpdate=!0;const k=y.distanceToTriangle(c,d,m);if(k<g&&(f.copy(d),x&&x.copy(m),g=k,b=S,z=A),k<s)return!0}}}}}),Jt.releasePrimitive(y),Jt.releasePrimitive(c),g===1/0?null:(o.point?o.point.copy(f):o.point=f.clone(),o.distance=g,o.faceIndex=b,i&&(i.point?i.point.copy(x):i.point=x.clone(),i.point.applyMatrix4(Oo),f.applyMatrix4(Oo),i.distance=f.sub(i.point).length(),i.faceIndex=z),o)}function $c(u,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=u.geometry,o=e.index?e.index.array:null,i=e.attributes.position;let s,n,r,a,l=0;const p=u._roots;for(let y=0,c=p.length;y<c;y++)s=p[y],n=new Uint32Array(s),r=new Uint16Array(s),a=new Float32Array(s),h(0,l),l+=s.byteLength;function h(y,c,d=!1){const f=y*2;if(St(f,r)){const m=Lt(y,n),x=jt(f,r);let g=1/0,b=1/0,z=1/0,v=-1/0,C=-1/0,B=-1/0;for(let A=m,M=m+x;A<M;A++){const S=3*u.resolveTriangleIndex(A);for(let P=0;P<3;P++){let k=S+P;k=o?o[k]:k;const D=i.getX(k),F=i.getY(k),T=i.getZ(k);D<g&&(g=D),D>v&&(v=D),F<b&&(b=F),F>C&&(C=F),T<z&&(z=T),T>B&&(B=T)}}return a[y+0]!==g||a[y+1]!==b||a[y+2]!==z||a[y+3]!==v||a[y+4]!==C||a[y+5]!==B?(a[y+0]=g,a[y+1]=b,a[y+2]=z,a[y+3]=v,a[y+4]=C,a[y+5]=B,!0):!1}else{const m=Dt(y),x=Tt(y,n);let g=d,b=!1,z=!1;if(t){if(!g){const S=m/Et+c/Rt,P=x/Et+c/Rt;b=t.has(S),z=t.has(P),g=!b&&!z}}else b=!0,z=!0;const v=g||b,C=g||z;let B=!1;v&&(B=h(m,c,g));let A=!1;C&&(A=h(x,c,g));const M=B||A;if(M)for(let S=0;S<3;S++){const P=m+S,k=x+S,D=a[P],F=a[P+3],T=a[k],K=a[k+3];a[y+S]=D<T?D:T,a[y+S+3]=F>K?F:K}return M}}}function Hc(u,t,e,o,i,s,n){xt.setBuffer(u._roots[t]),rs(0,u,e,o,i,s,n),xt.clearBuffer()}function rs(u,t,e,o,i,s,n){const{float32Array:r,uint16Array:a,uint32Array:l}=xt,p=u*2;if(St(p,a)){const y=Lt(u,l),c=jt(p,a);Ic(t,e,o,y,c,i,s,n)}else{const y=Dt(u);Me(y,r,o,s,n)&&rs(y,t,e,o,i,s,n);const c=Tt(u,l);Me(c,r,o,s,n)&&rs(c,t,e,o,i,s,n)}}const Wc=["x","y","z"];function qc(u,t,e,o,i,s){xt.setBuffer(u._roots[t]);const n=as(0,u,e,o,i,s);return xt.clearBuffer(),n}function as(u,t,e,o,i,s){const{float32Array:n,uint16Array:r,uint32Array:a}=xt;let l=u*2;if(St(l,r)){const h=Lt(u,a),y=jt(l,r);return Rc(t,e,o,h,y,i,s)}else{const h=zs(u,a),y=Wc[h],d=o.direction[y]>=0;let f,m;d?(f=Dt(u),m=Tt(u,a)):(f=Tt(u,a),m=Dt(u));const g=Me(f,n,o,i,s)?as(f,t,e,o,i,s):null;if(g){const v=g.point[y];if(d?v<=n[m+h]:v>=n[m+h+3])return g}const z=Me(m,n,o,i,s)?as(m,t,e,o,i,s):null;return g&&z?g.distance<=z.distance?g:z:g||z||null}}const No=new ne,qe=new te,Ke=new te,mo=new Ut,un=new Xt,jo=new Xt;function Kc(u,t,e,o){xt.setBuffer(u._roots[t]);const i=ls(0,u,e,o);return xt.clearBuffer(),i}function ls(u,t,e,o,i=null){const{float32Array:s,uint16Array:n,uint32Array:r}=xt;let a=u*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),un.set(e.boundingBox.min,e.boundingBox.max,o),i=un),St(a,n)){const p=t.geometry,h=p.index,y=p.attributes.position,c=e.index,d=e.attributes.position,f=Lt(u,r),m=jt(a,n);if(mo.copy(o).invert(),e.boundsTree)return vt(u,s,jo),jo.matrix.copy(mo),jo.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:g=>jo.intersectsBox(g),intersectsTriangle:g=>{g.a.applyMatrix4(o),g.b.applyMatrix4(o),g.c.applyMatrix4(o),g.needsUpdate=!0;for(let b=f,z=m+f;b<z;b++)if(At(Ke,3*t.resolveTriangleIndex(b),h,y),Ke.needsUpdate=!0,g.intersectsTriangle(Ke))return!0;return!1}});{const x=zi(e);for(let g=f,b=m+f;g<b;g++){const z=t.resolveTriangleIndex(g);At(qe,3*z,h,y),qe.a.applyMatrix4(mo),qe.b.applyMatrix4(mo),qe.c.applyMatrix4(mo),qe.needsUpdate=!0;for(let v=0,C=x*3;v<C;v+=3)if(At(Ke,v,c,d),Ke.needsUpdate=!0,qe.intersectsTriangle(Ke))return!0}}}else{const p=Dt(u),h=Tt(u,r);return vt(p,s,No),!!(i.intersectsBox(No)&&ls(p,t,e,o,i)||(vt(h,s,No),i.intersectsBox(No)&&ls(h,t,e,o,i)))}}const Xo=new Ut,Ri=new Xt,xo=new Xt,Jc=new X,Qc=new X,tp=new X,ep=new X;function op(u,t,e,o={},i={},s=0,n=1/0){t.boundingBox||t.computeBoundingBox(),Ri.set(t.boundingBox.min,t.boundingBox.max,e),Ri.needsUpdate=!0;const r=u.geometry,a=r.attributes.position,l=r.index,p=t.attributes.position,h=t.index,y=Jt.getPrimitive(),c=Jt.getPrimitive();let d=Jc,f=Qc,m=null,x=null;i&&(m=tp,x=ep);let g=1/0,b=null,z=null;return Xo.copy(e).invert(),xo.matrix.copy(Xo),u.shapecast({boundsTraverseOrder:v=>Ri.distanceToBox(v),intersectsBounds:(v,C,B)=>B<g&&B<n?(C&&(xo.min.copy(v.min),xo.max.copy(v.max),xo.needsUpdate=!0),!0):!1,intersectsRange:(v,C)=>{if(t.boundsTree){const B=t.boundsTree;return B.shapecast({boundsTraverseOrder:A=>xo.distanceToBox(A),intersectsBounds:(A,M,S)=>S<g&&S<n,intersectsRange:(A,M)=>{for(let S=A,P=A+M;S<P;S++){const k=B.resolveTriangleIndex(S);At(c,3*k,h,p),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let D=v,F=v+C;D<F;D++){const T=u.resolveTriangleIndex(D);At(y,3*T,l,a),y.needsUpdate=!0;const K=y.distanceToTriangle(c,d,m);if(K<g&&(f.copy(d),x&&x.copy(m),g=K,b=D,z=S),K<s)return!0}}}})}else{const B=zi(t);for(let A=0,M=B;A<M;A++){At(c,3*A,h,p),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let S=v,P=v+C;S<P;S++){const k=u.resolveTriangleIndex(S);At(y,3*k,l,a),y.needsUpdate=!0;const D=y.distanceToTriangle(c,d,m);if(D<g&&(f.copy(d),x&&x.copy(m),g=D,b=S,z=A),D<s)return!0}}}}}),Jt.releasePrimitive(y),Jt.releasePrimitive(c),g===1/0?null:(o.point?o.point.copy(f):o.point=f.clone(),o.distance=g,o.faceIndex=b,i&&(i.point?i.point.copy(x):i.point=x.clone(),i.point.applyMatrix4(Xo),f.applyMatrix4(Xo),i.distance=f.sub(i.point).length(),i.faceIndex=z),o)}function dn(u,t,e){return u===null?null:(u.point.applyMatrix4(t.matrixWorld),u.distance=u.point.distanceTo(e.ray.origin),u.object=t,u)}const Zo=new Xt,Go=new mi,fn=new X,mn=new Ut,xn=new X,Li=["getX","getY","getZ"];class ui extends wc{static serialize(t,e={}){e={cloneBuffers:!0,...e};const o=t.geometry,i=t._roots,s=t._indirectBuffer,n=o.getIndex(),r={version:1,roots:null,index:null,indirectBuffer:null};return e.cloneBuffers?(r.roots=i.map(a=>a.slice()),r.index=n?n.array.slice():null,r.indirectBuffer=s?s.slice():null):(r.roots=i,r.index=n?n.array:null,r.indirectBuffer=s),r}static deserialize(t,e,o={}){o={setIndex:!0,indirect:!!t.indirectBuffer,...o};const{index:i,roots:s,indirectBuffer:n}=t;t.version||(console.warn("MeshBVH.deserialize: Serialization format has been changed and will be fixed up. It is recommended to regenerate any stored serialized data."),a(s));const r=new ui(e,{...o,[bs]:!0});if(r._roots=s,r._indirectBuffer=n||null,o.setIndex){const l=e.getIndex();if(l===null){const p=new Nt(t.index,1,!1);e.setIndex(p)}else l.array!==i&&(l.array.set(i),l.needsUpdate=!0)}return r;function a(l){for(let p=0;p<l.length;p++){const h=l[p],y=new Uint32Array(h),c=new Uint16Array(h);for(let d=0,f=h.byteLength/Rt;d<f;d++){const m=Et*d,x=2*m;St(x,c)||(y[m+6]=y[m+6]/Et-d)}}}}get primitiveStride(){return 3}get resolveTriangleIndex(){return this.resolvePrimitiveIndex}constructor(t,e={}){e.maxLeafTris&&(console.warn('MeshBVH: "maxLeafTris" option has been deprecated. Use maxLeafSize, instead.'),e={...e,maxLeafSize:e.maxLeafTris}),super(t,e)}shiftTriangleOffsets(t){return super.shiftPrimitiveOffsets(t)}writePrimitiveBounds(t,e,o){const i=this.geometry,s=this._indirectBuffer,n=i.attributes.position,r=i.index?i.index.array:null,l=(s?s[t]:t)*3;let p=l+0,h=l+1,y=l+2;r&&(p=r[p],h=r[h],y=r[y]);for(let c=0;c<3;c++){const d=n[Li[c]](p),f=n[Li[c]](h),m=n[Li[c]](y);let x=d;f<x&&(x=f),m<x&&(x=m);let g=d;f>g&&(g=f),m>g&&(g=m),e[o+c]=x,e[o+c+3]=g}return e}computePrimitiveBounds(t,e,o){const i=this.geometry,s=this._indirectBuffer,n=i.attributes.position,r=i.index?i.index.array:null,a=n.normalized;if(t<0||e+t-o.offset>o.length/6)throw new Error("MeshBVH: compute triangle bounds range is invalid.");const l=n.array,p=n.offset||0;let h=3;n.isInterleavedBufferAttribute&&(h=n.data.stride);const y=["getX","getY","getZ"],c=o.offset;for(let d=t,f=t+e;d<f;d++){const x=(s?s[d]:d)*3,g=(d-c)*6;let b=x+0,z=x+1,v=x+2;r&&(b=r[b],z=r[z],v=r[v]),a||(b=b*h+p,z=z*h+p,v=v*h+p);for(let C=0;C<3;C++){let B,A,M;a?(B=n[y[C]](b),A=n[y[C]](z),M=n[y[C]](v)):(B=l[b+C],A=l[z+C],M=l[v+C]);let S=B;A<S&&(S=A),M<S&&(S=M);let P=B;A>P&&(P=A),M>P&&(P=M);const k=(P-S)/2,D=C*2;o[g+D+0]=S+k,o[g+D+1]=k+(Math.abs(S)+k)*ti}}return o}raycastObject3D(t,e,o=[]){const{material:i}=t;if(i===void 0)return;mn.copy(t.matrixWorld).invert(),Go.copy(e.ray).applyMatrix4(mn),xn.setFromMatrixScale(t.matrixWorld),fn.copy(Go.direction).multiply(xn);const s=fn.length(),n=e.near/s,r=e.far/s;if(e.firstHitOnly===!0){let a=this.raycastFirst(Go,i,n,r);a=dn(a,t,e),a&&o.push(a)}else{const a=this.raycast(Go,i,n,r);for(let l=0,p=a.length;l<p;l++){const h=dn(a[l],t,e);h&&o.push(h)}}return o}refit(t=null){return(this.indirect?$c:Pc)(this,t)}raycast(t,e=Ss,o=0,i=1/0){const s=this._roots,n=[],r=this.indirect?Hc:Uc;for(let a=0,l=s.length;a<l;a++)r(this,a,e,t,n,o,i);return n}raycastFirst(t,e=Ss,o=0,i=1/0){const s=this._roots;let n=null;const r=this.indirect?qc:Nc;for(let a=0,l=s.length;a<l;a++){const p=r(this,a,e,t,o,i);p!=null&&(n==null||p.distance<n.distance)&&(n=p)}return n}intersectsGeometry(t,e){let o=!1;const i=this._roots,s=this.indirect?Kc:jc;for(let n=0,r=i.length;n<r&&(o=s(this,n,t,e),!o);n++);return o}shapecast(t){const e=Jt.getPrimitive(),o=super.shapecast({...t,intersectsPrimitive:t.intersectsTriangle,scratchPrimitive:e,iterate:this.indirect?Lc:Tc});return Jt.releasePrimitive(e),o}bvhcast(t,e,o){let{intersectsRanges:i,intersectsTriangles:s}=o;const n=Jt.getPrimitive(),r=this.geometry.index,a=this.geometry.attributes.position,l=this.indirect?d=>{const f=this.resolveTriangleIndex(d);At(n,f*3,r,a)}:d=>{At(n,d*3,r,a)},p=Jt.getPrimitive(),h=t.geometry.index,y=t.geometry.attributes.position,c=t.indirect?d=>{const f=t.resolveTriangleIndex(d);At(p,f*3,h,y)}:d=>{At(p,d*3,h,y)};if(s){if(!(t instanceof ui))throw new Error('MeshBVH: "intersectsTriangles" callback can only be used with another MeshBVH.');const d=(f,m,x,g,b,z,v,C)=>{for(let B=x,A=x+g;B<A;B++){c(B),p.a.applyMatrix4(e),p.b.applyMatrix4(e),p.c.applyMatrix4(e),p.needsUpdate=!0;for(let M=f,S=f+m;M<S;M++)if(l(M),n.needsUpdate=!0,s(n,p,M,B,b,z,v,C))return!0}return!1};if(i){const f=i;i=function(m,x,g,b,z,v,C,B){return f(m,x,g,b,z,v,C,B)?!0:d(m,x,g,b,z,v,C,B)}}else i=d}return super.bvhcast(t,e,{intersectsRanges:i})}intersectsBox(t,e){return Zo.set(t.min,t.max,e),Zo.needsUpdate=!0,this.shapecast({intersectsBounds:o=>Zo.intersectsBox(o),intersectsTriangle:o=>Zo.intersectsTriangle(o)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,o={},i={},s=0,n=1/0){return(this.indirect?op:Vc)(this,t,e,o,i,s,n)}closestPointToPoint(t,e={},o=0,i=1/0){return Mc(this,t,e,o,i)}}const ar=1e-6,ip=ar*.5,lr=Math.pow(10,-Math.log10(ar)),sp=ip*lr;function pe(u){return~~(u*lr+sp)}function np(u){return`${pe(u.x)},${pe(u.y)}`}function gn(u){return`${pe(u.x)},${pe(u.y)},${pe(u.z)}`}function rp(u){return`${pe(u.x)},${pe(u.y)},${pe(u.z)},${pe(u.w)}`}function ap(u,t,e){e.direction.subVectors(t,u).normalize();const o=u.dot(e.direction);return e.origin.copy(u).addScaledVector(e.direction,-o),e}function cr(){return typeof SharedArrayBuffer<"u"}function lp(u){if(u.buffer instanceof SharedArrayBuffer)return u;const t=u.constructor,e=u.buffer,o=new SharedArrayBuffer(e.byteLength),i=new Uint8Array(e);return new Uint8Array(o).set(i,0),new t(o)}function cp(u,t=ArrayBuffer){return u>65535?new Uint32Array(new t(4*u)):new Uint16Array(new t(2*u))}function pp(u,t){if(!u.index){const e=u.attributes.position.count,o=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=cp(e,o);u.setIndex(new Nt(i,1));for(let s=0;s<e;s++)i[s]=s}}function hp(u){return u.index?u.index.count:u.attributes.position.count}function ks(u){return hp(u)/3}const yp=1e-8,up=new X;function dp(u){return~~(u/3)}function fp(u){return u%3}function bn(u,t){return u.start-t.start}function zn(u,t){return up.subVectors(t,u.origin).dot(u.direction)}function mp(u,t,e,o=yp){u.sort(bn),t.sort(bn);for(let r=0;r<u.length;r++){const a=u[r];for(let l=0;l<t.length;l++){const p=t[l];if(!(p.start>a.end)){if(a.end<p.start||p.end<a.start)continue;if(a.start<=p.start&&a.end>=p.end)s(p.end,a.end)||u.splice(r+1,0,{start:p.end,end:a.end,index:a.index}),a.end=p.start,p.start=0,p.end=0;else if(a.start>=p.start&&a.end<=p.end)s(a.end,p.end)||t.splice(l+1,0,{start:a.end,end:p.end,index:p.index}),p.end=a.start,a.start=0,a.end=0;else if(a.start<=p.start&&a.end<=p.end){const h=a.end;a.end=p.start,p.start=h}else if(a.start>=p.start&&a.end>=p.end){const h=p.end;p.end=a.start,a.start=h}else throw new Error}if(e.has(a.index)||e.set(a.index,[]),e.has(p.index)||e.set(p.index,[]),e.get(a.index).push(p.index),e.get(p.index).push(a.index),n(p)&&(t.splice(l,1),l--),n(a)){u.splice(r,1),r--;break}}}i(u),i(t);function i(r){for(let a=0;a<r.length;a++)n(r[a])&&(r.splice(a,1),a--)}function s(r,a){return Math.abs(a-r)<o}function n(r){return Math.abs(r.end-r.start)<o}}const vn=1e-5,Fn=1e-4;class xp{constructor(){this._rays=[]}addRay(t){this._rays.push(t)}findClosestRay(t){const e=this._rays,o=t.clone();o.direction.multiplyScalar(-1);let i=1/0,s=null;for(let a=0,l=e.length;a<l;a++){const p=e[a];if(n(p,t)&&n(p,o))continue;const h=r(p,t),y=r(p,o),c=Math.min(h,y);c<i&&(i=c,s=p)}return s;function n(a,l){const p=a.origin.distanceTo(l.origin)>vn;return a.direction.angleTo(l.direction)>Fn||p}function r(a,l){const p=a.origin.distanceTo(l.origin),h=a.direction.angleTo(l.direction);return p/vn+h/Fn}}}const Ui=new X,Oi=new X,Yo=new mi;function gp(u,t,e){const o=u.attributes,i=u.index,s=o.position,n=new Map,r=new Map,a=Array.from(t),l=new xp;for(let p=0,h=a.length;p<h;p++){const y=a[p],c=dp(y),d=fp(y);let f=3*c+d,m=3*c+(d+1)%3;i&&(f=i.getX(f),m=i.getX(m)),Ui.fromBufferAttribute(s,f),Oi.fromBufferAttribute(s,m),ap(Ui,Oi,Yo);let x,g=l.findClosestRay(Yo);g===null&&(g=Yo.clone(),l.addRay(g)),r.has(g)||r.set(g,{forward:[],reverse:[],ray:g}),x=r.get(g);let b=zn(g,Ui),z=zn(g,Oi);b>z&&([b,z]=[z,b]),Yo.direction.dot(g.direction)<0?x.reverse.push({start:b,end:z,index:y}):x.forward.push({start:b,end:z,index:y})}return r.forEach(({forward:p,reverse:h},y)=>{mp(p,h,n,e),p.length===0&&h.length===0&&r.delete(y)}),{disjointConnectivityMap:n,fragmentMap:r}}const bp=new nt,Ni=new X,zp=new je,ji=["","",""];class vp{constructor(t=null){this.data=null,this.disjointConnections=null,this.unmatchedDisjointEdges=null,this.unmatchedEdges=-1,this.matchedEdges=-1,this.useDrawRange=!0,this.useAllAttributes=!1,this.matchDisjointEdges=!1,this.degenerateEpsilon=1e-8,t&&this.updateFrom(t)}getSiblingTriangleIndex(t,e){const o=this.data[t*3+e];return o===-1?-1:~~(o/3)}getSiblingEdgeIndex(t,e){const o=this.data[t*3+e];return o===-1?-1:o%3}getDisjointSiblingTriangleIndices(t,e){const o=t*3+e,i=this.disjointConnections.get(o);return i?i.map(s=>~~(s/3)):[]}getDisjointSiblingEdgeIndices(t,e){const o=t*3+e,i=this.disjointConnections.get(o);return i?i.map(s=>s%3):[]}isFullyConnected(){return this.unmatchedEdges===0}updateFrom(t){const{useAllAttributes:e,useDrawRange:o,matchDisjointEdges:i,degenerateEpsilon:s}=this,n=e?b:g,r=new Map,{attributes:a}=t,l=e?Object.keys(a):null,p=t.index,h=a.position;let y=ks(t);const c=y;let d=0;o&&(d=t.drawRange.start,t.drawRange.count!==1/0&&(y=~~(t.drawRange.count/3)));let f=this.data;(!f||f.length<3*c)&&(f=new Int32Array(3*c)),f.fill(-1);let m=0,x=new Set;for(let z=d,v=y*3+d;z<v;z+=3){const C=z;for(let B=0;B<3;B++){let A=C+B;p&&(A=p.getX(A)),ji[B]=n(A)}for(let B=0;B<3;B++){const A=(B+1)%3,M=ji[B],S=ji[A],P=`${S}_${M}`;if(r.has(P)){const k=C+B,D=r.get(P);f[k]=D,f[D]=k,r.delete(P),m+=2,x.delete(D)}else{const k=`${M}_${S}`,D=C+B;r.set(k,D),x.add(D)}}}if(i){const{fragmentMap:z,disjointConnectivityMap:v}=gp(t,x,s);x.clear(),z.forEach(({forward:C,reverse:B})=>{C.forEach(({index:A})=>x.add(A)),B.forEach(({index:A})=>x.add(A))}),this.unmatchedDisjointEdges=z,this.disjointConnections=v,m=y*3-x.size}this.matchedEdges=m,this.unmatchedEdges=x.size,this.data=f;function g(z){return Ni.fromBufferAttribute(h,z),gn(Ni)}function b(z){let v="";for(let C=0,B=l.length;C<B;C++){const A=a[l[C]];let M;switch(A.itemSize){case 1:M=pe(A.getX(z));break;case 2:M=np(bp.fromBufferAttribute(A,z));break;case 3:M=gn(Ni.fromBufferAttribute(A,z));break;case 4:M=rp(zp.fromBufferAttribute(A,z));break}v!==""&&(v+="|"),v+=M}return v}}}class cs extends It{constructor(...t){super(...t),this.isBrush=!0,this._previousMatrix=new Ut,this._previousMatrix.elements.fill(0)}markUpdated(){this._previousMatrix.copy(this.matrix)}isDirty(){const{matrix:t,_previousMatrix:e}=this,o=t.elements,i=e.elements;for(let s=0;s<16;s++)if(o[s]!==i[s])return!0;return!1}prepareGeometry(){const t=this.geometry,e=t.attributes,o=cr();if(o)for(const i in e){const s=e[i];if(s.isInterleavedBufferAttribute)throw new Error("Brush: InterleavedBufferAttributes are not supported.");s.array=lp(s.array)}if(t.boundsTree||(pp(t,{useSharedArrayBuffer:o}),t.boundsTree=new ui(t,{maxLeafTris:3,indirect:!0,useSharedArrayBuffer:o})),t.halfEdges||(t.halfEdges=new vp(t)),!t.groupIndices){const i=ks(t),s=new Uint16Array(i),n=t.groups;for(let r=0,a=n.length;r<a;r++){const{start:l,count:p}=n[r];for(let h=l/3,y=(l+p)/3;h<y;h++)s[h]=r}t.groupIndices=s}}disposeCacheData(){const{geometry:t}=this;t.halfEdges=null,t.boundsTree=null,t.groupIndices=null}}const Fp=1e-14,Xi=new X,wn=new X,kn=new X;function we(u,t=Fp){Xi.subVectors(u.b,u.a),wn.subVectors(u.c,u.a),kn.subVectors(u.b,u.c);const e=Xi.angleTo(wn),o=Xi.angleTo(kn),i=Math.PI-e-o;return Math.abs(e)<t||Math.abs(o)<t||Math.abs(i)<t||u.a.distanceToSquared(u.b)<t||u.a.distanceToSquared(u.c)<t||u.b.distanceToSquared(u.c)<t}const Zi=1e-10,go=1e-10,wp=1e-10,ye=new Qt,kt=new Qt,ue=new X,Gi=new X,Bn=new X,Vo=new xi,Yi=new te;class kp{constructor(){this._pool=[],this._index=0}getTriangle(){return this._index>=this._pool.length&&this._pool.push(new Gt),this._pool[this._index++]}clear(){this._index=0}reset(){this._pool.length=0,this._index=0}}class Bp{constructor(){this.trianglePool=new kp,this.triangles=[],this.normal=new X,this.coplanarTriangleUsed=!1}initialize(t){this.reset();const{triangles:e,trianglePool:o,normal:i}=this;if(Array.isArray(t))for(let s=0,n=t.length;s<n;s++){const r=t[s];if(s===0)r.getNormal(i);else if(Math.abs(1-r.getNormal(ue).dot(i))>Zi)throw new Error("Triangle Splitter: Cannot initialize with triangles that have different normals.");const a=o.getTriangle();a.copy(r),e.push(a)}else{t.getNormal(i);const s=o.getTriangle();s.copy(t),e.push(s)}}splitByTriangle(t){const{normal:e,triangles:o}=this;if(t.getNormal(Gi).normalize(),Math.abs(1-Math.abs(Gi.dot(e)))<wp){this.coplanarTriangleUsed=!0;for(let s=0,n=o.length;s<n;s++){const r=o[s];r.coplanarCount=0}const i=[t.a,t.b,t.c];for(let s=0;s<3;s++){const n=(s+1)%3,r=i[s],a=i[n];ue.subVectors(a,r).normalize(),Bn.crossVectors(Gi,ue),Vo.setFromNormalAndCoplanarPoint(Bn,r),this.splitByPlane(Vo,t)}}else t.getPlane(Vo),this.splitByPlane(Vo,t)}splitByPlane(t,e){const{triangles:o,trianglePool:i}=this;Yi.copy(e),Yi.needsUpdate=!0;for(let s=0,n=o.length;s<n;s++){const r=o[s];if(!Yi.intersectsTriangle(r,ye,!0))continue;const{a,b:l,c:p}=r;let h=0,y=-1,c=!1,d=[],f=[];const m=[a,l,p];for(let x=0;x<3;x++){const g=(x+1)%3;ye.start.copy(m[x]),ye.end.copy(m[g]);const b=t.distanceToPoint(ye.start),z=t.distanceToPoint(ye.end);if(Math.abs(b)<go&&Math.abs(z)<go){c=!0;break}if(b>0?d.push(x):f.push(x),Math.abs(b)<go)continue;let v=!!t.intersectLine(ye,ue);!v&&Math.abs(z)<go&&(ue.copy(ye.end),v=!0),v&&!(ue.distanceTo(ye.start)<Zi)&&(ue.distanceTo(ye.end)<Zi&&(y=x),h===0?kt.start.copy(ue):kt.end.copy(ue),h++)}if(!c&&h===2&&kt.distance()>go)if(y!==-1){y=(y+1)%3;let x=0;x===y&&(x=(x+1)%3);let g=x+1;g===y&&(g=(g+1)%3);const b=i.getTriangle();b.a.copy(m[g]),b.b.copy(kt.end),b.c.copy(kt.start),we(b)||o.push(b),r.a.copy(m[x]),r.b.copy(kt.start),r.c.copy(kt.end),we(r)&&(o.splice(s,1),s--,n--)}else{const x=d.length>=2?f[0]:d[0];if(x===0){let C=kt.start;kt.start=kt.end,kt.end=C}const g=(x+1)%3,b=(x+2)%3,z=i.getTriangle(),v=i.getTriangle();m[g].distanceToSquared(kt.start)<m[b].distanceToSquared(kt.end)?(z.a.copy(m[g]),z.b.copy(kt.start),z.c.copy(kt.end),v.a.copy(m[g]),v.b.copy(m[b]),v.c.copy(kt.start)):(z.a.copy(m[b]),z.b.copy(kt.start),z.c.copy(kt.end),v.a.copy(m[g]),v.b.copy(m[b]),v.c.copy(kt.end)),r.a.copy(m[x]),r.b.copy(kt.end),r.c.copy(kt.start),we(z)||o.push(z),we(v)||o.push(v),we(r)&&(o.splice(s,1),s--,n--)}else h===3&&console.warn("TriangleClipper: Coplanar clip not handled")}}reset(){this.triangles.length=0,this.trianglePool.clear(),this.coplanarTriangleUsed=!1}}function Cp(u){return u=~~u,u+4-u%4}class Cn{constructor(t,e=500){this.expansionFactor=1.5,this.type=t,this.length=0,this.array=null,this.setSize(e)}setType(t){if(this.length!==0)throw new Error("TypeBackedArray: Cannot change the type while there is used data in the buffer.");const e=this.array.buffer;this.array=new t(e),this.type=t}setSize(t){if(this.array&&t===this.array.length)return;const e=this.type,o=cr()?SharedArrayBuffer:ArrayBuffer,i=new e(new o(Cp(t*e.BYTES_PER_ELEMENT)));this.array&&i.set(this.array,0),this.array=i}expand(){const{array:t,expansionFactor:e}=this;this.setSize(t.length*e)}push(...t){let{array:e,length:o}=this;o+t.length>e.length&&(this.expand(),e=this.array);for(let i=0,s=t.length;i<s;i++)e[o+i]=t[i];this.length+=t.length}clear(){this.length=0}}class Ap{constructor(){this.groupAttributes=[{}],this.groupCount=0}getType(t){return this.groupAttributes[0][t].type}getItemSize(t){return this.groupAttributes[0][t].itemSize}getNormalized(t){return this.groupAttributes[0][t].normalized}getCount(t){if(this.groupCount<=t)return 0;const e=this.getGroupAttrArray("position",t);return e.length/e.itemSize}getTotalLength(t){const{groupCount:e,groupAttributes:o}=this;let i=0;for(let s=0;s<e;s++){const n=o[s];i+=n[t].length}return i}getGroupAttrSet(t=0){const{groupAttributes:e}=this;if(e[t])return this.groupCount=Math.max(this.groupCount,t+1),e[t];const o=e[0];for(this.groupCount=Math.max(this.groupCount,t+1);t>=e.length;){const i={};e.push(i);for(const s in o){const n=o[s],r=new Cn(n.type);r.itemSize=n.itemSize,r.normalized=n.normalized,i[s]=r}}return e[t]}getGroupAttrArray(t,e=0){const{groupAttributes:o}=this;if(!o[0][t])throw new Error(`TypedAttributeData: Attribute with "${t}" has not been initialized`);return this.getGroupAttrSet(e)[t]}initializeArray(t,e,o,i){const{groupAttributes:s}=this,r=s[0][t];if(r){if(r.type!==e)for(let a=0,l=s.length;a<l;a++){const p=s[a][t];p.setType(e),p.itemSize=o,p.normalized=i}}else for(let a=0,l=s.length;a<l;a++){const p=new Cn(e);p.itemSize=o,p.normalized=i,s[a][t]=p}}clear(){this.groupCount=0;const{groupAttributes:t}=this;t.forEach(e=>{for(const o in e)e[o].clear()})}delete(t){this.groupAttributes.forEach(e=>{delete e[t]})}reset(){this.groupAttributes=[],this.groupCount=0}}class An{constructor(){this.intersectionSet={},this.ids=[]}add(t,e){const{intersectionSet:o,ids:i}=this;o[t]||(o[t]=[],i.push(t)),o[t].push(e)}}const pr=0,Mp=1,Ep=2,Sp=3,_p=4,hr=5,yr=6,Kt=new mi,Mn=new Ut,Ot=new Gt,de=new X,En=new je,Sn=new je,_n=new je,Vi=new je,$o=new je,Ho=new je,Dn=new Qt,$i=new X,Hi=1e-8,Dp=1e-15,Re=-1,Le=1,oi=-2,ii=2,Fo=0,De=1,Bs=2,Tp=1e-14;let si=null;function Tn(u){si=u}function ur(u,t){u.getMidpoint(Kt.origin),u.getNormal(Kt.direction);const e=t.raycastFirst(Kt,Ae);return!!(e&&Kt.direction.dot(e.face.normal)>0)?Re:Le}function Pp(u,t){function e(){return Math.random()-.5}u.getNormal($i),Kt.direction.copy($i),u.getMidpoint(Kt.origin);const o=3;let i=0,s=1/0;for(let n=0;n<o;n++){Kt.direction.x+=e()*Hi,Kt.direction.y+=e()*Hi,Kt.direction.z+=e()*Hi,Kt.direction.multiplyScalar(-1);const r=t.raycastFirst(Kt,Ae);if(!!(r&&Kt.direction.dot(r.face.normal)>0)&&i++,r!==null&&(s=Math.min(s,r.distance)),s<=Dp)return r.face.normal.dot($i)>0?ii:oi;if(i/o>.5||(n-i+1)/o>.5)break}return i/o>.5?Re:Le}function Ip(u,t){const e=new An,o=new An;return Mn.copy(u.matrixWorld).invert().multiply(t.matrixWorld),u.geometry.boundsTree.bvhcast(t.geometry.boundsTree,Mn,{intersectsTriangles(i,s,n,r){if(!we(i)&&!we(s)){let a=i.intersectsTriangle(s,Dn,!0);if(!a){const l=i.plane,p=s.plane,h=l.normal,y=p.normal;h.dot(y)===1&&Math.abs(l.constant-p.constant)<Tp&&(a=!0)}if(a){let l=u.geometry.boundsTree.resolveTriangleIndex(n),p=t.geometry.boundsTree.resolveTriangleIndex(r);e.add(l,p),o.add(p,l),si&&(si.addEdge(Dn),si.addIntersectingTriangles(n,i,r,s))}}return!1}}),{aIntersections:e,bIntersections:o}}function Rp(u,t,e,o,i,s,n=!1){const r=e.attributes,a=e.index,l=u*3,p=a.getX(l+0),h=a.getX(l+1),y=a.getX(l+2);for(const c in s){const d=r[c],f=s[c];if(!(c in r))throw new Error(`CSG Operations: Attribute ${c} not available on geometry.`);const m=d.itemSize;c==="position"?(Ot.a.fromBufferAttribute(d,p).applyMatrix4(o),Ot.b.fromBufferAttribute(d,h).applyMatrix4(o),Ot.c.fromBufferAttribute(d,y).applyMatrix4(o),Wi(Ot.a,Ot.b,Ot.c,t,3,f,n)):c==="normal"?(Ot.a.fromBufferAttribute(d,p).applyNormalMatrix(i),Ot.b.fromBufferAttribute(d,h).applyNormalMatrix(i),Ot.c.fromBufferAttribute(d,y).applyNormalMatrix(i),n&&(Ot.a.multiplyScalar(-1),Ot.b.multiplyScalar(-1),Ot.c.multiplyScalar(-1)),Wi(Ot.a,Ot.b,Ot.c,t,3,f,n,!0)):(En.fromBufferAttribute(d,p),Sn.fromBufferAttribute(d,h),_n.fromBufferAttribute(d,y),Wi(En,Sn,_n,t,m,f,n))}}function Lp(u,t,e,o,i,s,n,r=!1){qi(u,o,i,s,n,r),qi(r?e:t,o,i,s,n,r),qi(r?t:e,o,i,s,n,r)}function dr(u,t,e=!1){switch(u){case pr:if(t===Le||t===ii&&!e)return De;break;case Mp:if(e){if(t===Re)return Fo}else if(t===Le||t===oi)return De;break;case Ep:if(e){if(t===Le||t===oi)return De}else if(t===Re)return Fo;break;case _p:if(t===Re)return Fo;if(t===Le)return De;break;case Sp:if(t===Re||t===ii&&!e)return De;break;case hr:if(!e&&(t===Le||t===oi))return De;break;case yr:if(!e&&(t===Re||t===ii))return De;break;default:throw new Error(`Unrecognized CSG operation enum "${u}".`)}return Bs}function Wi(u,t,e,o,i,s,n=!1,r=!1){const a=l=>{s.push(l.x),i>1&&s.push(l.y),i>2&&s.push(l.z),i>3&&s.push(l.w)};Vi.set(0,0,0,0).addScaledVector(u,o.a.x).addScaledVector(t,o.a.y).addScaledVector(e,o.a.z),$o.set(0,0,0,0).addScaledVector(u,o.b.x).addScaledVector(t,o.b.y).addScaledVector(e,o.b.z),Ho.set(0,0,0,0).addScaledVector(u,o.c.x).addScaledVector(t,o.c.y).addScaledVector(e,o.c.z),r&&(Vi.normalize(),$o.normalize(),Ho.normalize()),a(Vi),n?(a(Ho),a($o)):(a($o),a(Ho))}function qi(u,t,e,o,i,s=!1){for(const n in i){const r=t[n],a=i[n];if(!(n in t))throw new Error(`CSG Operations: Attribute ${n} no available on geometry.`);const l=r.itemSize;n==="position"?(de.fromBufferAttribute(r,u).applyMatrix4(e),a.push(de.x,de.y,de.z)):n==="normal"?(de.fromBufferAttribute(r,u).applyNormalMatrix(o),s&&de.multiplyScalar(-1),a.push(de.x,de.y,de.z)):(a.push(r.getX(u)),l>1&&a.push(r.getY(u)),l>2&&a.push(r.getZ(u)),l>3&&a.push(r.getW(u)))}}class Up{constructor(t){this.triangle=new Gt().copy(t),this.intersects={}}addTriangle(t,e){this.intersects[t]=new Gt().copy(e)}getIntersectArray(){const t=[],{intersects:e}=this;for(const o in e)t.push(e[o]);return t}}class Pn{constructor(){this.data={}}addTriangleIntersection(t,e,o,i){const{data:s}=this;s[t]||(s[t]=new Up(e)),s[t].addTriangle(o,i)}getTrianglesAsArray(t=null){const{data:e}=this,o=[];if(t!==null)t in e&&o.push(e[t].triangle);else for(const i in e)o.push(e[i].triangle);return o}getTriangleIndices(){return Object.keys(this.data).map(t=>parseInt(t))}getIntersectionIndices(t){const{data:e}=this;return e[t]?Object.keys(e[t].intersects).map(o=>parseInt(o)):[]}getIntersectionsAsArray(t=null,e=null){const{data:o}=this,i=new Set,s=[],n=r=>{if(o[r])if(e!==null)o[r].intersects[e]&&s.push(o[r].intersects[e]);else{const a=o[r].intersects;for(const l in a)i.has(l)||(i.add(l),s.push(a[l]))}};if(t!==null)n(t);else for(const r in o)n(r);return s}reset(){this.data={}}}class Op{constructor(){this.enabled=!1,this.triangleIntersectsA=new Pn,this.triangleIntersectsB=new Pn,this.intersectionEdges=[]}addIntersectingTriangles(t,e,o,i){const{triangleIntersectsA:s,triangleIntersectsB:n}=this;s.addTriangleIntersection(t,e,o,i),n.addTriangleIntersection(o,i,t,e)}addEdge(t){this.intersectionEdges.push(t.clone())}reset(){this.triangleIntersectsA.reset(),this.triangleIntersectsB.reset(),this.intersectionEdges=[]}init(){this.enabled&&(this.reset(),Tn(this))}complete(){this.enabled&&Tn(null)}}const Be=new Ut,di=new Vn,Te=new Gt,Wo=new Gt,ze=new Gt,qo=new Gt,se=[],Ue=[];function Np(u){for(const t of u)return t}function jp(u,t,e,o,i,s={}){const{useGroups:n=!0}=s,{aIntersections:r,bIntersections:a}=Ip(u,t),l=[];let p=null,h;return h=n?0:-1,In(u,t,r,e,!1,o,i,h),Rn(u,t,r,e,!1,i,h),e.findIndex(c=>c!==yr&&c!==hr)!==-1&&(h=n?u.geometry.groups.length||1:-1,In(t,u,a,e,!0,o,i,h),Rn(t,u,a,e,!0,i,h)),se.length=0,Ue.length=0,{groups:l,materials:p}}function In(u,t,e,o,i,s,n,r=0){const a=u.matrixWorld.determinant()<0;Be.copy(t.matrixWorld).invert().multiply(u.matrixWorld),di.getNormalMatrix(u.matrixWorld).multiplyScalar(a?-1:1);const l=u.geometry.groupIndices,p=u.geometry.index,h=u.geometry.attributes.position,y=t.geometry.boundsTree,c=t.geometry.index,d=t.geometry.attributes.position,f=e.ids,m=e.intersectionSet;for(let x=0,g=f.length;x<g;x++){const b=f[x],z=r===-1?0:l[b]+r,v=3*b,C=p.getX(v+0),B=p.getX(v+1),A=p.getX(v+2);Te.a.fromBufferAttribute(h,C).applyMatrix4(Be),Te.b.fromBufferAttribute(h,B).applyMatrix4(Be),Te.c.fromBufferAttribute(h,A).applyMatrix4(Be),s.reset(),s.initialize(Te);const M=m[b];for(let P=0,k=M.length;P<k;P++){const D=3*M[P],F=c.getX(D+0),T=c.getX(D+1),K=c.getX(D+2);Wo.a.fromBufferAttribute(d,F),Wo.b.fromBufferAttribute(d,T),Wo.c.fromBufferAttribute(d,K),s.splitByTriangle(Wo)}const S=s.triangles;for(let P=0,k=S.length;P<k;P++){const D=S[P],F=s.coplanarTriangleUsed?Pp(D,y):ur(D,y);se.length=0,Ue.length=0;for(let T=0,K=o.length;T<K;T++){const G=dr(o[T],F,i);G!==Bs&&(Ue.push(G),se.push(n[T].getGroupAttrSet(z)))}if(se.length!==0){Te.getBarycoord(D.a,qo.a),Te.getBarycoord(D.b,qo.b),Te.getBarycoord(D.c,qo.c);for(let T=0,K=se.length;T<K;T++){const G=se[T],$=Ue[T]===Fo;Rp(b,qo,u.geometry,u.matrixWorld,di,G,a!==$)}}}}return f.length}function Rn(u,t,e,o,i,s,n=0){const r=u.matrixWorld.determinant()<0;Be.copy(t.matrixWorld).invert().multiply(u.matrixWorld),di.getNormalMatrix(u.matrixWorld).multiplyScalar(r?-1:1);const a=t.geometry.boundsTree,l=u.geometry.groupIndices,p=u.geometry.index,h=u.geometry.attributes,y=h.position,c=[],d=u.geometry.halfEdges,f=new Set,m=ks(u.geometry);for(let x=0,g=m;x<g;x++)x in e.intersectionSet||f.add(x);for(;f.size>0;){const x=Np(f);f.delete(x),c.push(x);const g=3*x,b=p.getX(g+0),z=p.getX(g+1),v=p.getX(g+2);ze.a.fromBufferAttribute(y,b).applyMatrix4(Be),ze.b.fromBufferAttribute(y,z).applyMatrix4(Be),ze.c.fromBufferAttribute(y,v).applyMatrix4(Be);const C=ur(ze,a);Ue.length=0,se.length=0;for(let B=0,A=o.length;B<A;B++){const M=dr(o[B],C,i);M!==Bs&&(Ue.push(M),se.push(s[B]))}for(;c.length>0;){const B=c.pop();for(let A=0;A<3;A++){const M=d.getSiblingTriangleIndex(B,A);M!==-1&&f.has(M)&&(c.push(M),f.delete(M))}if(se.length!==0){const A=3*B,M=p.getX(A+0),S=p.getX(A+1),P=p.getX(A+2),k=n===-1?0:l[B]+n;if(ze.a.fromBufferAttribute(y,M),ze.b.fromBufferAttribute(y,S),ze.c.fromBufferAttribute(y,P),!we(ze))for(let D=0,F=se.length;D<F;D++){const T=Ue[D],K=se[D].getGroupAttrSet(k),G=T===Fo;Lp(M,S,P,h,u.matrixWorld,di,K,G!==r)}}}}}function Xp(u){for(let t=0;t<u.length-1;t++){const e=u[t],o=u[t+1];if(e.materialIndex===o.materialIndex){const i=e.start,s=o.start+o.count;o.start=i,o.count=s-i,u.splice(t,1),t--}}}function Zp(u,t,e,o){e.clear();const i=u.attributes;for(let s=0,n=o.length;s<n;s++){const r=o[s],a=i[r];e.initializeArray(r,a.array.constructor,a.itemSize,a.normalized)}for(const s in e.attributes)o.includes(s)||e.delete(s);for(const s in t.attributes)o.includes(s)||(t.deleteAttribute(s),t.dispose())}function Gp(u,t,e){let o=!1,i=-1;const s=u.attributes,n=t.groupAttributes[0];for(const a in n){const l=t.getTotalLength(a),p=t.getType(a),h=t.getItemSize(a),y=t.getNormalized(a);let c=s[a];(!c||c.array.length<l)&&(c=new Nt(new p(l),h,y),u.setAttribute(a,c),o=!0);let d=0;for(let f=0,m=Math.min(e.length,t.groupCount);f<m;f++){const x=e[f].index,{array:g,type:b,length:z}=t.groupAttributes[x][a],v=new b(g.buffer,0,z);c.array.set(v,d),d+=v.length}c.needsUpdate=!0,i=l/c.itemSize}if(u.index){const a=u.index.array;if(a.length<i)u.index=null,o=!0;else for(let l=0,p=a.length;l<p;l++)a[l]=l}let r=0;u.clearGroups();for(let a=0,l=Math.min(e.length,t.groupCount);a<l;a++){const{index:p,materialIndex:h}=e[a],y=t.getCount(p);y!==0&&(u.addGroup(r,y,h),r+=y)}u.setDrawRange(0,i),u.boundsTree=null,o&&u.dispose()}function Ln(u,t){let e=t;return Array.isArray(t)||(e=[],u.forEach(o=>{e[o.materialIndex]=t})),e}class Yp{constructor(){this.triangleSplitter=new Bp,this.attributeData=[],this.attributes=["position","uv","normal"],this.useGroups=!0,this.consolidateGroups=!0,this.debug=new Op}getGroupRanges(t){return!this.useGroups||t.groups.length===0?[{start:0,count:1/0,materialIndex:0}]:t.groups.map(e=>({...e}))}evaluate(t,e,o,i=new cs){let s=!0;if(Array.isArray(o)||(o=[o]),Array.isArray(i)||(i=[i],s=!1),i.length!==o.length)throw new Error("Evaluator: operations and target array passed as different sizes.");t.prepareGeometry(),e.prepareGeometry();const{triangleSplitter:n,attributeData:r,attributes:a,useGroups:l,consolidateGroups:p,debug:h}=this;for(;r.length<i.length;)r.push(new Ap);i.forEach((x,g)=>{Zp(t.geometry,x.geometry,r[g],a)}),h.init(),jp(t,e,o,n,r,{useGroups:l}),h.complete();const y=this.getGroupRanges(t.geometry),c=Ln(y,t.material),d=this.getGroupRanges(e.geometry),f=Ln(d,e.material);d.forEach(x=>x.materialIndex+=c.length);let m=[...y,...d].map((x,g)=>({...x,index:g}));if(l){const x=[...c,...f];p&&(m=m.map(b=>{const z=x[b.materialIndex];return b.materialIndex=x.indexOf(z),b}).sort((b,z)=>b.materialIndex-z.materialIndex));const g=[];for(let b=0,z=x.length;b<z;b++){let v=!1;for(let C=0,B=m.length;C<B;C++){const A=m[C];A.materialIndex===b&&(v=!0,A.materialIndex=g.length)}v&&g.push(x[b])}i.forEach(b=>{b.material=g})}else m=[{start:0,count:1/0,index:0,materialIndex:0}],i.forEach(x=>{x.material=c[0]});return i.forEach((x,g)=>{const b=x.geometry;Gp(b,r[g],m),p&&Xp(b.groups)}),s?i:i[0]}evaluateHierarchy(t,e=new cs){t.updateMatrixWorld(!0);const o=(s,n)=>{const r=s.children;for(let a=0,l=r.length;a<l;a++){const p=r[a];p.isOperationGroup?o(p,n):n(p)}},i=s=>{const n=s.children;let r=!1;for(let l=0,p=n.length;l<p;l++){const h=n[l];r=i(h)||r}const a=s.isDirty();if(a&&s.markUpdated(),r&&!s.isOperationGroup){let l;return o(s,p=>{l?l=this.evaluate(l,p,p.operation):l=this.evaluate(s,p,p.operation)}),s._cachedGeometry=l.geometry,s._cachedMaterials=l.material,!0}else return r||a};return i(t),e.geometry=t._cachedGeometry,e.material=t._cachedMaterials,e}reset(){this.triangleSplitter.reset()}}let Vp=0;class Un{constructor(t={}){this.id=t.id||`merged_${++Vp}`,this.type="merged",this.color=t.color||"#888888",this.layerId=t.layerId||"default",this.sourceBlocks=t.sourceBlocks||[],this.mesh=null,this.edges=null,this.boundingBox=new ne,t.geometry&&this.createFromGeometry(t.geometry,t.material)}createFromGeometry(t,e){this.mesh=new It(t,e||new Ct({color:this.color,roughness:.7,metalness:.1,vertexColors:t.hasAttribute("color")})),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.mesh.userData.mergedId=this.id,this.mesh.userData.merged=this,this.createEdges(t),t.computeBoundingBox(),this.boundingBox.copy(t.boundingBox)}createEdges(t){const e=new wo(t,30),o=new eo({color:0,transparent:!0,opacity:.3});this.edges=new oo(e,o),this.mesh.add(this.edges)}setEdgesVisible(t){this.edges&&(this.edges.visible=t)}setEdgesOpacity(t){this.edges&&(this.edges.material.opacity=t)}setSelected(t){this.mesh.material.emissive&&this.mesh.material.emissive.set(t?3355443:0)}get gridPosition(){const t=new X;return this.boundingBox.getCenter(t),{x:Math.floor(t.x),y:Math.floor(t.y),z:Math.floor(t.z)}}toJSON(){return{id:this.id,type:"merged",color:this.color,layerId:this.layerId,sourceBlocks:this.sourceBlocks}}dispose(){this.edges&&(this.edges.geometry.dispose(),this.edges.material.dispose()),this.mesh&&(this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach(t=>t.dispose()):this.mesh.material.dispose())}}class $p{constructor(t){this.blockManager=t,this.evaluator=new Yp}areBoundsTouching(t,e){const i=t.min.x<=e.max.x+.01&&t.max.x>=e.min.x-.01,s=t.min.y<=e.max.y+.01&&t.max.y>=e.min.y-.01,n=t.min.z<=e.max.z+.01&&t.max.z>=e.min.z-.01;if(i&&s&&n){const r=Math.abs(t.max.x-e.min.x)<.01||Math.abs(e.max.x-t.min.x)<.01||t.min.x<e.max.x&&t.max.x>e.min.x,a=Math.abs(t.max.y-e.min.y)<.01||Math.abs(e.max.y-t.min.y)<.01||t.min.y<e.max.y&&t.max.y>e.min.y,l=Math.abs(t.max.z-e.min.z)<.01||Math.abs(e.max.z-t.min.z)<.01||t.min.z<e.max.z&&t.max.z>e.min.z;return r&&a&&l}return!1}findIslands(t){if(t.length===0)return[];const e=new Map;for(const n of t)e.set(n.id,bo(n));const o=new Map;for(const n of t)o.set(n.id,[]);for(let n=0;n<t.length;n++){const r=t[n],a=e.get(r.id);for(let l=n+1;l<t.length;l++){const p=t[l],h=e.get(p.id);this.areBoundsTouching(a,h)&&(o.get(r.id).push(p),o.get(p.id).push(r))}}const i=new Set,s=[];for(const n of t){if(i.has(n.id))continue;const r=[],a=[n];for(;a.length>0;){const l=a.shift();if(!i.has(l.id)){i.add(l.id),r.push(l);for(const p of o.get(l.id))i.has(p.id)||a.push(p)}}r.length>0&&s.push(r)}return s}createBrushFromBlock(t){const e=t.mesh;e.updateMatrixWorld();const o=e.geometry.clone();if(o.applyMatrix4(e.matrixWorld),!o.index){const s=o.getAttribute("position"),n=[];for(let r=0;r<s.count;r++)n.push(r);o.setIndex(n)}const i=new cs(o);return i.updateMatrixWorld(),i}mergeIsland(t){if(t.length===0)return null;const e=t[0].color;if(t.length===1){const r=t[0];r.mesh.updateMatrixWorld();const a=r.mesh.geometry.clone();a.applyMatrix4(r.mesh.matrixWorld),this.addVertexColors(a,r.color);const l=new Ct({color:16777215,vertexColors:!0,roughness:.7,metalness:.1});return new Un({geometry:a,material:l,color:e,layerId:r.layerId,sourceBlocks:[r.toJSON()]})}const o=new Map;for(const r of t){const a=r.color.toLowerCase();o.has(a)||o.set(a,[]),o.get(a).push(r)}const i=[];for(const[r,a]of o)try{const l=this.csgMergeBlocks(a);l&&(this.addVertexColors(l,r),i.push({geometry:l,color:r}))}catch(l){console.error(`CSG merge failed for color ${r}:`,l);const p=this.simpleMergeBlocks(a);this.addVertexColors(p,r),i.push({geometry:p,color:r})}if(i.length===0)return null;const s=this.combineGeometriesWithColors(i),n=new Ct({color:16777215,vertexColors:!0,roughness:.7,metalness:.1});return new Un({geometry:s,material:n,color:e,layerId:t[0].layerId,sourceBlocks:t.map(r=>r.toJSON())})}csgMergeBlocks(t){if(t.length===0)return null;if(t.length===1){const i=t[0];i.mesh.updateMatrixWorld();const s=i.mesh.geometry.clone();return s.applyMatrix4(i.mesh.matrixWorld),s}let e=this.createBrushFromBlock(t[0]);for(let i=1;i<t.length;i++){const s=this.createBrushFromBlock(t[i]),n=this.evaluator.evaluate(e,s,pr);e.geometry&&e.geometry.dispose(),s.geometry&&s.geometry.dispose(),e=n}const o=e.geometry;return o.getAttribute("normal")||o.computeVertexNormals(),o}simpleMergeBlocks(t){const e=[];for(const i of t){const s=i.mesh;s.updateMatrixWorld();const n=s.geometry.clone();n.applyMatrix4(s.matrixWorld),e.push(n)}const o=this.mergeGeometries(e);return e.forEach(i=>i.dispose()),o}addVertexColors(t,e){const o=new ot(e),i=t.getAttribute("position"),s=new Float32Array(i.count*3);for(let n=0;n<i.count;n++)s[n*3]=o.r,s[n*3+1]=o.g,s[n*3+2]=o.b;t.setAttribute("color",new Nt(s,3))}combineGeometriesWithColors(t){const e=[],o=[],i=[],s=[];let n=0;for(const{geometry:a}of t){const l=a.getAttribute("position"),p=a.getAttribute("normal"),h=a.getAttribute("color"),y=a.getIndex();for(let c=0;c<l.count;c++)e.push(l.getX(c),l.getY(c),l.getZ(c)),p&&o.push(p.getX(c),p.getY(c),p.getZ(c)),h&&i.push(h.getX(c),h.getY(c),h.getZ(c));if(y)for(let c=0;c<y.count;c++)s.push(y.getX(c)+n);else for(let c=0;c<l.count;c++)s.push(c+n);n+=l.count,a.dispose()}const r=new ce;return r.setAttribute("position",new _t(e,3)),o.length>0?r.setAttribute("normal",new _t(o,3)):r.computeVertexNormals(),i.length>0&&r.setAttribute("color",new _t(i,3)),r.setIndex(s),r}mergeGeometries(t){const e=[],o=[],i=[];let s=0;for(const r of t){const a=r.getAttribute("position"),l=r.getAttribute("normal"),p=r.getIndex();for(let h=0;h<a.count;h++)e.push(a.getX(h),a.getY(h),a.getZ(h)),l&&o.push(l.getX(h),l.getY(h),l.getZ(h));if(p)for(let h=0;h<p.count;h++)i.push(p.getX(h)+s);else for(let h=0;h<a.count;h++)i.push(h+s);s+=a.count}const n=new ce;return n.setAttribute("position",new _t(e,3)),o.length>0?n.setAttribute("normal",new _t(o,3)):n.computeVertexNormals(),n.setIndex(i),n}flatten(t=null){const e=t||this.blockManager.getAllBlocks();if(e.length===0)return{mergedMeshes:[],removedBlockIds:[]};const o=this.findIslands(e),i=[],s=[];for(const n of o){const r=this.mergeIsland(n);r&&(i.push(r),s.push(...n.map(a=>a.id)))}return{mergedMeshes:i,removedBlockIds:s}}flattenAndApply(t=null){const{mergedMeshes:e,removedBlockIds:o}=this.flatten(t);for(const i of o)this.blockManager.removeBlock(i);for(const i of e)this.blockManager.addMergedMesh(i);return{mergedCount:e.length,blocksRemoved:o.length,mergedMeshes:e}}}const fi={pipes:{label:"Pipes",straight:{X:"pipeX",Y:"pipeY",Z:"pipeZ"},elbows:{"X+_Z+":{type:"pipeElbowXZ3",rotation:0},"X+_Z-":{type:"pipeElbowXZ2",rotation:0},"X-_Z+":{type:"pipeElbowXZ4",rotation:0},"X-_Z-":{type:"pipeElbowXZ",rotation:0},"Z+_X+":{type:"pipeElbowXZ3",rotation:0},"Z+_X-":{type:"pipeElbowXZ4",rotation:0},"Z-_X+":{type:"pipeElbowXZ2",rotation:0},"Z-_X-":{type:"pipeElbowXZ",rotation:0},"X+_Y+":{type:"pipeElbowXY",rotation:0},"X+_Y-":{type:"pipeElbowXY",rotation:180},"X-_Y+":{type:"pipeElbowXY2",rotation:0},"X-_Y-":{type:"pipeElbowXY2",rotation:180},"Y+_X+":{type:"pipeElbowXY",rotation:0},"Y+_X-":{type:"pipeElbowXY2",rotation:0},"Y-_X+":{type:"pipeElbowXY",rotation:180},"Y-_X-":{type:"pipeElbowXY2",rotation:180},"Z+_Y+":{type:"pipeElbowYZ",rotation:0},"Z+_Y-":{type:"pipeElbowYZ",rotation:180},"Z-_Y+":{type:"pipeElbowYZ2",rotation:0},"Z-_Y-":{type:"pipeElbowYZ2",rotation:180},"Y+_Z+":{type:"pipeElbowYZ",rotation:0},"Y+_Z-":{type:"pipeElbowYZ2",rotation:0},"Y-_Z+":{type:"pipeElbowYZ",rotation:180},"Y-_Z-":{type:"pipeElbowYZ2",rotation:180}},junctions:{cross:"pipeCross",tXZ:"pipeT",tXY:"pipeTY",tYZ:"pipeTZ"},decorative:["downspout"],allowedScales:[1,2,4],clusterBased:!1},cables:{label:"Cables",straight:{X:"cableX",Y:"cableY",Z:"cableZ"},elbows:{"X+_Z+":{type:"cableElbow",rotation:180},"X+_Z-":{type:"cableElbow",rotation:90},"X-_Z+":{type:"cableElbow",rotation:270},"X-_Z-":{type:"cableElbow",rotation:0},"Z+_X+":{type:"cableElbow",rotation:180},"Z+_X-":{type:"cableElbow",rotation:270},"Z-_X+":{type:"cableElbow",rotation:90},"Z-_X-":{type:"cableElbow",rotation:0},"X+_Y+":{type:"cableElbowY",rotation:0},"X-_Y+":{type:"cableElbowY",rotation:180},"Z+_Y+":{type:"cableElbowY",rotation:90},"Z-_Y+":{type:"cableElbowY",rotation:270},"Y+_X+":{type:"cableElbowY",rotation:0},"Y+_X-":{type:"cableElbowY",rotation:180},"Y+_Z+":{type:"cableElbowY",rotation:90},"Y+_Z-":{type:"cableElbowY",rotation:270}},junctions:{tXZ:"cableT"},decorative:["cableHanging","cableDroop","cableLoop"],allowedScales:[1,2,4],clusterBased:!1},conduits:{label:"Conduits",straight:{X:"conduitX",Y:"conduitY",Z:"conduitZ"},elbows:{"X+_Z+":{type:"conduitElbow",rotation:180},"X+_Z-":{type:"conduitElbow",rotation:90},"X-_Z+":{type:"conduitElbow",rotation:270},"X-_Z-":{type:"conduitElbow",rotation:0},"Z+_X+":{type:"conduitElbow",rotation:180},"Z+_X-":{type:"conduitElbow",rotation:270},"Z-_X+":{type:"conduitElbow",rotation:90},"Z-_X-":{type:"conduitElbow",rotation:0},"X+_Y+":{type:"conduitElbowY",rotation:0},"X-_Y+":{type:"conduitElbowY",rotation:180},"Z+_Y+":{type:"conduitElbowY",rotation:90},"Z-_Y+":{type:"conduitElbowY",rotation:270},"Y+_X+":{type:"conduitElbowY",rotation:0},"Y+_X-":{type:"conduitElbowY",rotation:180},"Y+_Z+":{type:"conduitElbowY",rotation:90},"Y+_Z-":{type:"conduitElbowY",rotation:270}},junctions:{tXZ:"conduitT"},decorative:[],allowedScales:[1,2,4],clusterBased:!1},industrial:{label:"Industrial",straight:{X:"ductX",Y:"iBeam",Z:"ductZ"},elbows:{"X+_Z+":{type:"ductCorner",rotation:180},"X+_Z-":{type:"ductCorner",rotation:90},"X-_Z+":{type:"ductCorner",rotation:270},"X-_Z-":{type:"ductCorner",rotation:0},"Z+_X+":{type:"ductCorner",rotation:180},"Z+_X-":{type:"ductCorner",rotation:270},"Z-_X+":{type:"ductCorner",rotation:90},"Z-_X-":{type:"ductCorner",rotation:0}},junctions:{},decorative:["tank","valve","vent","catwalk","grateFloor"],allowedScales:[1,2,4],clusterBased:!1},natural:{label:"Natural",blocks:["rock","bush","logX","logZ","stump","boulder","grass","flower","rockSmall","rockLarge","rockFlat","rockTall","rockJagged","rockCluster","rockPile","pebbles","slate","crystalSmall","crystalLarge","crystalCluster","crystalSpike","crystalFlat","crystalShard","crystalFormation","stalactite","stalagmite","mushroom","mushroomCluster","moss","vine","coral"],allowedScales:[1,2,4],clusterBased:!0},abstract:{label:"Abstract",blocks:["cube","sphere","cylinder","cone","pyramid","octagon","gem","crystal","prism"],allowedScales:[1,2,4],clusterBased:!0},beams:{label:"Beams",straight:{X:"beamX",Y:"pillar",Z:"beamZ"},elbows:{},junctions:{cross:"crossBeam"},decorative:["truss","post"],allowedScales:[1,2,4],clusterBased:!1},fences:{label:"Fences",straight:{X:"fence",Y:"fencePost",Z:"fenceZ"},elbows:{"X+_Z+":{type:"fenceCorner",rotation:180},"X+_Z-":{type:"fenceCorner",rotation:90},"X-_Z+":{type:"fenceCorner",rotation:270},"X-_Z-":{type:"fenceCorner",rotation:0},"Z+_X+":{type:"fenceCorner",rotation:180},"Z+_X-":{type:"fenceCorner",rotation:270},"Z-_X+":{type:"fenceCorner",rotation:90},"Z-_X-":{type:"fenceCorner",rotation:0}},junctions:{tXZ:"fenceT",cross:"fenceCross"},decorative:["gate","gateArch"],allowedScales:[1,2,4],clusterBased:!1},mixedTech:{label:"Tech Mix",blocks:["pipeX","pipeY","pipeZ","pipeElbowXZ","pipeCross","pipeT","cableX","cableY","cableZ","cableHanging","cableLoop","conduitX","conduitY","conduitZ","tank","valve","vent","antenna","ductX","ductZ"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedOrganic:{label:"Organic Mix",blocks:["rock","bush","logX","logZ","stump","boulder","grass","flower","rockSmall","rockLarge","rockFlat","rockJagged","rockCluster","pebbles","crystalSmall","crystalLarge","crystalCluster","crystalFormation","mushroom","mushroomCluster","moss","vine","coral","sphere","crystal","gem","prism","pillar","pillarRound","post"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedArchitecture:{label:"Architecture Mix",blocks:["cube","slab","slabTop","pillar","pillarRound","arch","archHalf","beamX","beamZ","crossBeam","truss","stairs","stairsCorner","ramp","dome","domeLow","halfX","halfZ","quarter","wedge"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedGeometric:{label:"Geometric Mix",blocks:["cube","sphere","cylinder","cone","pyramid","octagon","prism","gem","crystal","wedge","wedgeCorner","wedgeInner","slab","slabTop","quarter"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedChaos:{label:"Chaos Mix",blocks:["cube","sphere","cylinder","cone","pyramid","gem","pipeX","pipeY","pipeZ","tank","valve","rock","bush","crystal","pillar","arch","dome","stairs","beamX","beamZ","truss","wedge","slab","octagon"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedSciFi:{label:"Sci-Fi Mix",blocks:["pipeX","pipeY","pipeZ","pipeCross","antenna","tank","vent","valve","octagon","cylinder","dome","domeLow","slab","slabTop","grateFloor","catwalk","pillar","pillar2","iBeam"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},mixedRuins:{label:"Ruins Mix",blocks:["cube","slab","quarter","wedge","wedgeCorner","pillar","arch","archHalf","stairs","rock","boulder","bush","grass","moss","vine","rockSmall","rockFlat","rockCluster","pebbles","slate","halfX","halfZ","stump"],allowedScales:[1,2,4],clusterBased:!0,mixed:!0},cave:{label:"Cave",blocks:["rock","boulder","rockSmall","rockLarge","rockFlat","rockTall","rockJagged","rockCluster","rockPile","pebbles","slate","crystalSmall","crystalLarge","crystalCluster","crystalSpike","crystalFlat","crystalShard","crystalFormation","stalactite","stalagmite","mushroom","mushroomCluster","moss"],allowedScales:[1,2,4],clusterBased:!0},crystals:{label:"Crystals",blocks:["crystal","gem","prism","crystalSmall","crystalLarge","crystalCluster","crystalSpike","crystalFlat","crystalShard","crystalFormation"],allowedScales:[1,2,4],clusterBased:!0},rocks:{label:"Rocks",blocks:["rock","boulder","rockSmall","rockLarge","rockFlat","rockTall","rockJagged","rockCluster","rockPile","pebbles","slate"],allowedScales:[1,2,4],clusterBased:!0}};function Hp(u,t,e){if(!u.elbows)return null;const o=`${t}_${e}`;return u.elbows[o]||null}function On(u,t){return u.straight&&u.straight[t]||null}function Nn(u){return!u.decorative||u.decorative.length===0?null:u.decorative[Math.floor(Math.random()*u.decorative.length)]}function Wp(u){return!u.blocks||u.blocks.length===0?null:u.blocks[Math.floor(Math.random()*u.blocks.length)]}const ni={walk:{label:"Random Walk",description:"Connected directional growth"},cluster:{label:"Cluster",description:"Organic blob spreading"},lsystem:{label:"L-System",description:"Fractal rule-based growth"},spiral:{label:"Spiral",description:"Spiral tower patterns"},tree:{label:"Tree",description:"Branching tree structures"},wave:{label:"Wave",description:"Sine wave patterns"},drunk:{label:"Drunkard's Walk",description:"Chaotic random movement"},crystal:{label:"Crystal",description:"Geometric crystalline growth"},vine:{label:"Vine",description:"Climbing vine patterns"},layers:{label:"Layered",description:"Stacked layers of different blocks"},scatter3d:{label:"Scatter 3D",description:"Random 3D cloud of mixed blocks"},radial:{label:"Radial Burst",description:"Exploding outward pattern"},gradient:{label:"Gradient",description:"Block types change with distance"},terrain:{label:"Terrain",description:"Heightmap-based mixed terrain"},galaxy:{label:"Galaxy",description:"Spiral arms with mixed blocks"},cavern:{label:"Cavern",description:"Cave with stalactites and stalagmites"},rockField:{label:"Rock Field",description:"Scattered rock landscape"},mushroomGrove:{label:"Mushroom Grove",description:"Forest of mushrooms"},crystalCave:{label:"Crystal Cave",description:"Crystalline cave formation"},coralReef:{label:"Coral Reef",description:"Underwater coral structures"},boulderPile:{label:"Boulder Pile",description:"Piled rocks and stones"}};class fr{constructor(t){this.blockManager=t,this.preset="pipes",this.algorithm="walk",this.maxBlocks=50,this.branchChance=.2,this.turnChance=.3,this.scaleRatio=.8,this.colorHarmony="analogous",this.verticalBias=.1,this.decorativeChance=.05,this.placedPositions=new Set,this.audioReactive=!1,this.baseMaxBlocks=50,this.baseBranchChance=.2,this.baseTurnChance=.3,this.baseVerticalBias=.1,this.baseDecorativeChance=.05,this.baseScaleRatio=.8}updateFromAudio(t){if(!this.audioReactive)return!1;const e=t.bands.bass,o=t.bands.mid,i=t.bands.high;return t.energy,this.scaleRatio=.9-e*.6,this.branchChance=this.baseBranchChance+o*.4,this.turnChance=this.baseTurnChance+o*.4,this.verticalBias=i*.5,this.decorativeChance=.02+i*.18,t.beat}setAudioReactive(t){this.audioReactive=t,t&&(this.baseMaxBlocks=this.maxBlocks,this.baseBranchChance=this.branchChance,this.baseTurnChance=this.turnChance,this.baseVerticalBias=this.verticalBias,this.baseDecorativeChance=this.decorativeChance,this.baseScaleRatio=this.scaleRatio)}generate(t,e={}){const o=fi[this.preset];if(!o)return console.warn(`Unknown scatter preset: ${this.preset}`),[];const i={maxBlocks:e.maxBlocks??this.maxBlocks,branchChance:e.branchChance??this.branchChance,turnChance:e.turnChance??this.turnChance,scaleRatio:e.scaleRatio??this.scaleRatio,baseColor:e.baseColor||"#5588cc",colorHarmony:e.colorHarmony??this.colorHarmony,verticalBias:e.verticalBias??this.verticalBias,decorativeChance:e.decorativeChance??this.decorativeChance},s=this.generateColorPalette(i.baseColor,i.colorHarmony);switch(this.placedPositions.clear(),this.algorithm){case"walk":return this.generateDirectional(t,o,i,s);case"cluster":return this.generateCluster(t,o,i,s);case"lsystem":return this.generateLSystem(t,o,i,s);case"spiral":return this.generateSpiral(t,o,i,s);case"tree":return this.generateTree(t,o,i,s);case"wave":return this.generateWave(t,o,i,s);case"drunk":return this.generateDrunkard(t,o,i,s);case"crystal":return this.generateCrystal(t,o,i,s);case"vine":return this.generateVine(t,o,i,s);case"layers":return this.generateLayers(t,o,i,s);case"scatter3d":return this.generateScatter3D(t,o,i,s);case"radial":return this.generateRadial(t,o,i,s);case"gradient":return this.generateGradient(t,o,i,s);case"terrain":return this.generateTerrain(t,o,i,s);case"galaxy":return this.generateGalaxy(t,o,i,s);case"cavern":return this.generateCavern(t,o,i,s);case"rockField":return this.generateRockField(t,o,i,s);case"mushroomGrove":return this.generateMushroomGrove(t,o,i,s);case"crystalCave":return this.generateCrystalCave(t,o,i,s);case"coralReef":return this.generateCoralReef(t,o,i,s);case"boulderPile":return this.generateBoulderPile(t,o,i,s);default:return o.clusterBased?this.generateCluster(t,o,i,s):this.generateDirectional(t,o,i,s)}}generateDirectional(t,e,o,i){const s=[],n=[],r=["X+","X-","Z+","Z-"],a=r[Math.floor(Math.random()*r.length)];for(n.push({position:{...t},direction:a,previousDirection:null,depth:0});n.length>0&&s.length<o.maxBlocks;){const l=n.shift(),p=this.posKey(l.position);if(this.placedPositions.has(p))continue;const h=this.pickScale(e,o.scaleRatio);if(h>1&&(l.position.x=Math.floor(l.position.x/h)*h,l.position.z=Math.floor(l.position.z/h)*h),this.blockManager.wouldOverlapAt("cube",l.position,{w:1,h:1,d:1},null,h))continue;let y=null,c=0;if(l.previousDirection&&l.previousDirection!==l.direction&&this.getAxisFromDirection(l.previousDirection)!==this.getAxisFromDirection(l.direction)){const g=Hp(e,l.previousDirection,l.direction);if(g)y=g.type,c=g.rotation;else{const b=this.getAxisFromDirection(l.direction);y=On(e,b)}}else{const g=this.getAxisFromDirection(l.direction);y=On(e,g)}if(!y&&(y=Nn(e),!y))continue;const f=i[Math.floor(Math.random()*i.length)];s.push({type:y,position:{...l.position},color:f,rotation:{x:0,y:c,z:0},scale:h}),this.placedPositions.add(p);const m=this.moveInDirection(l.position,l.direction,h);let x=l.direction;if(Math.random()<o.turnChance&&(Math.random()<o.verticalBias&&l.direction.charAt(0)!=="Y"?x="Y+":x=this.getPerpendicularDirection(l.direction,o.verticalBias)),n.push({position:m,direction:x,previousDirection:l.direction,depth:l.depth+1}),Math.random()<o.branchChance&&s.length<o.maxBlocks-5){const g=this.getPerpendicularDirection(l.direction,o.verticalBias),b=this.moveInDirection(l.position,g,h);n.push({position:b,direction:g,previousDirection:l.direction,depth:l.depth+1})}if(Math.random()<o.decorativeChance){const g=Nn(e);if(g){const b=this.getPerpendicularDirection(l.direction,0),z=this.moveInDirection(l.position,b,1),v=this.posKey(z);!this.placedPositions.has(v)&&!this.blockManager.wouldOverlapAt(g,z)&&(s.push({type:g,position:z,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}}return s}generateCluster(t,e,o,i){const s=[],n=[{...t}];for(;n.length>0&&s.length<o.maxBlocks;){const r=n.shift(),a=this.posKey(r);if(this.placedPositions.has(a))continue;const l=this.pickScale(e,o.scaleRatio),p={...r};if(l>1&&(p.x=Math.floor(r.x/l)*l,p.z=Math.floor(r.z/l)*l),this.blockManager.wouldOverlapAt("cube",p,{w:1,h:1,d:1},null,l))continue;const h=Wp(e);if(!h)continue;const y=i[Math.floor(Math.random()*i.length)];s.push({type:h,position:p,color:y,rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:l}),this.placedPositions.add(a);const c=this.getNeighbors(r);for(const d of c){const f=.7-s.length/o.maxBlocks*.4;Math.random()<f&&n.push(d)}}return s}generateLSystem(t,e,o,i){const s=[],r={F:"F[+F]F[-F]F"},a=Math.min(4,Math.floor(Math.log2(o.maxBlocks/5)));let l="F";for(let d=0;d<a;d++){let f="";for(const m of l)f+=r[m]||m;l=f}const p=[];let h={...t},y=0;const c=25+Math.random()*20;for(const d of l){if(s.length>=o.maxBlocks)break;switch(d){case"F":{const f=this.posKey(h);if(!this.placedPositions.has(f)){const x=this.pickScale(e,o.scaleRatio),g=this.getBlockForPreset(e,"straight");this.blockManager.wouldOverlapAt(g,h,{w:1,h:1,d:1},null,x)||(s.push({type:g,position:{...h},color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.round(y/90)*90,z:0},scale:x}),this.placedPositions.add(f))}const m=y*Math.PI/180;h={x:h.x+Math.round(Math.sin(m)),y:h.y+(Math.random()<o.verticalBias?1:0),z:h.z+Math.round(Math.cos(m))};break}case"+":y+=c;break;case"-":y-=c;break;case"[":p.push({pos:{...h},angle:y});break;case"]":if(p.length>0){const f=p.pop();h=f.pos,y=f.angle}break}}return s}generateSpiral(t,e,o,i){const s=[],n=3+Math.random()*4,r=2+Math.random()*3,a=o.maxBlocks/(2*Math.PI*n);for(let l=0;l<o.maxBlocks;l++){const p=l/o.maxBlocks*a*2*Math.PI,h=n*(1-l/o.maxBlocks*.3),y={x:Math.round(t.x+Math.cos(p)*h),y:Math.round(t.y+p/(2*Math.PI)*r),z:Math.round(t.z+Math.sin(p)*h)},c=this.posKey(y);if(this.placedPositions.has(c))continue;const d=this.pickScale(e,o.scaleRatio),f=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(f,y,{w:1,h:1,d:1},null,d)||(s.push({type:f,position:y,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.round(p*180/Math.PI)%360,z:0},scale:d}),this.placedPositions.add(c))}return s}generateTree(t,e,o,i){const s=[],n=3+Math.floor(Math.random()*5),r=2+Math.floor(Math.random()*3);for(let p=0;p<n&&s.length<o.maxBlocks;p++){const h={x:t.x,y:t.y+p,z:t.z},y=this.posKey(h);if(!this.placedPositions.has(y)){const c=this.getBlockForPreset(e,"vertical");s.push({type:c,position:h,color:i[0],rotation:{x:0,y:0,z:0},scale:1}),this.placedPositions.add(y)}}const a=t.y+n,l=[{dx:1,dz:0},{dx:-1,dz:0},{dx:0,dz:1},{dx:0,dz:-1},{dx:1,dz:1},{dx:-1,dz:1},{dx:1,dz:-1},{dx:-1,dz:-1}];for(const p of l)if(!(Math.random()>o.branchChance*2+.3)){if(s.length>=o.maxBlocks)break;for(let h=1;h<=r;h++){const y={x:t.x+p.dx*h,y:a+Math.floor(h*.5)-1,z:t.z+p.dz*h},c=this.posKey(y);if(!this.placedPositions.has(c)&&s.length<o.maxBlocks){const d=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(d,y)||(s.push({type:d,position:y,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(c))}if(Math.random()<o.branchChance&&s.length<o.maxBlocks){const d={...y,y:y.y+1},f=this.posKey(d);if(!this.placedPositions.has(f)){const m=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(m,d)||(s.push({type:m,position:d,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(f))}}}}return s}generateWave(t,e,o,i){const s=[],n=4+Math.random()*4,r=2+Math.random()*3,a=Math.ceil(Math.sqrt(o.maxBlocks)),l=Math.ceil(o.maxBlocks/a);for(let p=0;p<l&&s.length<o.maxBlocks;p++)for(let h=0;h<a&&s.length<o.maxBlocks;h++){const y=Math.sin(p/n*2*Math.PI),c=Math.sin(h/n*2*Math.PI)*.5,d=Math.round((y+c)*r),f={x:t.x+p-Math.floor(l/2),y:t.y+d+Math.round(r),z:t.z+h-Math.floor(a/2)},m=this.posKey(f);if(this.placedPositions.has(m))continue;const x=this.pickScale(e,o.scaleRatio),g=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(g,f,{w:1,h:1,d:1},null,x)||(s.push({type:g,position:f,color:i[Math.floor((d+r)/(2*r)*i.length)%i.length],rotation:{x:0,y:0,z:0},scale:x}),this.placedPositions.add(m))}return s}generateDrunkard(t,e,o,i){const s=[];let n={...t};const r=[{dx:1,dy:0,dz:0},{dx:-1,dy:0,dz:0},{dx:0,dy:1,dz:0},{dx:0,dy:-1,dz:0},{dx:0,dy:0,dz:1},{dx:0,dy:0,dz:-1}];let a=0;const l=50;for(;s.length<o.maxBlocks&&a<l;){const p=this.posKey(n);if(!this.placedPositions.has(p)){const c=this.pickScale(e,o.scaleRatio),d=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(d,n,{w:1,h:1,d:1},null,c)?a++:(s.push({type:d,position:{...n},color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:c}),this.placedPositions.add(p),a=0)}const h=r[Math.floor(Math.random()*r.length)],y=Math.random()<.3?2:1;n={x:n.x+h.dx*y,y:Math.max(0,n.y+h.dy*y),z:n.z+h.dz*y}}return s}generateCrystal(t,e,o,i){const s=[],n=4+Math.floor(Math.random()*4),r=5+Math.floor(Math.random()*8),a=3+Math.random()*3;for(let l=0;l<r&&s.length<o.maxBlocks;l++){const p=l/r,h=a*(1-p*.8);for(let y=0;y<n;y++){const c=y/n*2*Math.PI,d=h*(.8+Math.random()*.4),f={x:Math.round(t.x+Math.cos(c)*d),y:t.y+l,z:Math.round(t.z+Math.sin(c)*d)},m=this.posKey(f);if(this.placedPositions.has(m))continue;if(s.length>=o.maxBlocks)break;const x=this.getBlockForPreset(e,"any");if(!this.blockManager.wouldOverlapAt(x,f)){const g=Math.floor(p*(i.length-1));s.push({type:x,position:f,color:i[g],rotation:{x:0,y:Math.round(c*180/Math.PI),z:0},scale:1}),this.placedPositions.add(m)}}if(p<.5&&s.length<o.maxBlocks){const y=this.posKey({...t,y:t.y+l});if(!this.placedPositions.has(y)){const c=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(c,{...t,y:t.y+l})||(s.push({type:c,position:{...t,y:t.y+l},color:i[0],rotation:{x:0,y:0,z:0},scale:1}),this.placedPositions.add(y))}}}return s}generateVine(t,e,o,i){const s=[],n=2+Math.floor(Math.random()*3);for(let r=0;r<n;r++){let a={x:t.x+Math.floor(Math.random()*3)-1,y:t.y,z:t.z+Math.floor(Math.random()*3)-1};const l=Math.floor(o.maxBlocks/n);let p=0,h=Math.floor(Math.random()*4)*90;for(;p<l&&s.length<o.maxBlocks;){const y=this.posKey(a);if(!this.placedPositions.has(y)){const c=this.getBlockForPreset(e,"vertical");this.blockManager.wouldOverlapAt(c,a)||(s.push({type:c,position:{...a},color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:h,z:0},scale:1}),this.placedPositions.add(y),p++)}if(Math.random()<.7)a.y++;else{const c=h*Math.PI/180;Math.random()<.5&&(a.x+=Math.round(Math.cos(c)),a.z+=Math.round(Math.sin(c))),Math.random()<o.turnChance&&(h=(h+(Math.random()<.5?90:-90)+360)%360)}if(Math.random()<o.branchChance*.5&&s.length<o.maxBlocks){const c=(h+(Math.random()<.5?90:-90))%360,d=c*Math.PI/180,f={x:a.x+Math.round(Math.cos(d)),y:a.y,z:a.z+Math.round(Math.sin(d))},m=this.posKey(f);if(!this.placedPositions.has(m)){const x=this.getBlockForPreset(e,"any");this.blockManager.wouldOverlapAt(x,f)||(s.push({type:x,position:f,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:c,z:0},scale:1}),this.placedPositions.add(m))}}}}return s}generateLayers(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.ceil(o.maxBlocks/n.length),a=Math.ceil(Math.sqrt(r/Math.PI));for(let l=0;l<n.length&&s.length<o.maxBlocks;l++){const p=n[l],h=t.y+l;for(let y=-a;y<=a&&s.length<o.maxBlocks;y++)for(let c=-a;c<=a&&s.length<o.maxBlocks;c++){const d=Math.sqrt(y*y+c*c);if(d>a||Math.random()>.7+.3*(1-d/a))continue;const f={x:t.x+y,y:h,z:t.z+c},m=this.posKey(f);!this.placedPositions.has(m)&&!this.blockManager.wouldOverlapAt(p,f)&&(s.push({type:p,position:f,color:i[l%i.length],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(m))}}return s}generateScatter3D(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.cbrt(o.maxBlocks)*1.5;let a=0;const l=o.maxBlocks*3;for(;s.length<o.maxBlocks&&a<l;){a++;const p=Math.random()*2*Math.PI,h=Math.acos(2*Math.random()-1),y=Math.cbrt(Math.random())*r,c={x:Math.round(t.x+y*Math.sin(h)*Math.cos(p)),y:Math.round(t.y+y*Math.cos(h)),z:Math.round(t.z+y*Math.sin(h)*Math.sin(p))};if(c.y<0)continue;const d=this.posKey(c);if(this.placedPositions.has(d))continue;const f=n[Math.floor(Math.random()*n.length)],m=this.pickScale(e,o.scaleRatio);this.blockManager.wouldOverlapAt(f,c,{w:1,h:1,d:1},null,m)||(s.push({type:f,position:c,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:m}),this.placedPositions.add(d))}return s}generateRadial(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.cbrt(o.maxBlocks)*2,a=8+Math.floor(Math.random()*8);for(let l=0;l<a&&s.length<o.maxBlocks;l++){const p=l/a*2*Math.PI,h=(Math.random()-.3)*Math.PI*.5;for(let y=0;y<=r&&s.length<o.maxBlocks;y++){const c=Math.floor(y/r*n.length),d=n[Math.min(c,n.length-1)],f={x:Math.round(t.x+y*Math.cos(p)*Math.cos(h)),y:Math.round(t.y+y*Math.sin(h)),z:Math.round(t.z+y*Math.sin(p)*Math.cos(h))};if(f.y<0)continue;const m=this.posKey(f);this.placedPositions.has(m)||Math.random()>.8-y/r*.5||this.blockManager.wouldOverlapAt(d,f)||(s.push({type:d,position:f,color:i[c%i.length],rotation:{x:0,y:Math.round(p*180/Math.PI),z:0},scale:1}),this.placedPositions.add(m))}}return s}generateGradient(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.ceil(Math.cbrt(o.maxBlocks));for(let a=-r;a<=r&&s.length<o.maxBlocks;a++)for(let l=0;l<=r&&s.length<o.maxBlocks;l++)for(let p=-r;p<=r&&s.length<o.maxBlocks;p++){const h=Math.sqrt(a*a+l*l+p*p);if(h>r)continue;const y=Math.sin(a*.5)*Math.cos(p*.5)*Math.sin(l*.7);if(Math.random()>.3+y*.2)continue;const c={x:t.x+a,y:t.y+l,z:t.z+p},d=this.posKey(c);if(this.placedPositions.has(d))continue;const f=Math.floor(h/r*n.length),m=n[Math.min(f,n.length-1)];this.blockManager.wouldOverlapAt(m,c)||(s.push({type:m,position:c,color:i[f%i.length],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(d))}return s}generateTerrain(t,e,o,i){const s=[],n=this.getBlockList(e),r=Math.ceil(Math.sqrt(o.maxBlocks)),a=6,l=(p,h)=>{const y=Math.sin(p*.3)*Math.cos(h*.3),c=Math.sin(p*.7+1)*Math.cos(h*.5+2),d=Math.sin(p*.15)*Math.cos(h*.15);return(y+c*.5+d*2)/3.5};for(let p=0;p<r&&s.length<o.maxBlocks;p++)for(let h=0;h<r&&s.length<o.maxBlocks;h++){const y=Math.round((l(p,h)+1)*a/2);for(let c=0;c<=y&&s.length<o.maxBlocks;c++){const d={x:t.x+p-Math.floor(r/2),y:t.y+c,z:t.z+h-Math.floor(r/2)},f=this.posKey(d);if(this.placedPositions.has(f))continue;const m=c/a,x=Math.floor(m*n.length),g=n[Math.min(x,n.length-1)];this.blockManager.wouldOverlapAt(g,d)||(s.push({type:g,position:d,color:i[x%i.length],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(f))}}return s}generateGalaxy(t,e,o,i){const s=[],n=this.getBlockList(e),r=2+Math.floor(Math.random()*3),a=Math.floor(o.maxBlocks/r);for(let l=0;l<r&&s.length<o.maxBlocks;l++){const p=l/r*2*Math.PI,h=n[l%n.length];for(let y=0;y<a&&s.length<o.maxBlocks;y++){const c=y/a,d=p+c*3*Math.PI,f=1+c*8,m=(Math.random()-.5)*2*(1+c),x=d+Math.PI/2,g={x:Math.round(t.x+Math.cos(d)*f+Math.cos(x)*m),y:Math.round(t.y+(Math.random()-.5)*2),z:Math.round(t.z+Math.sin(d)*f+Math.sin(x)*m)};g.y<0&&(g.y=0);const b=this.posKey(g);if(this.placedPositions.has(b))continue;const z=Math.random()<.3,v=z?n[Math.floor(Math.random()*n.length)]:h;this.blockManager.wouldOverlapAt(v,g)||(s.push({type:v,position:g,color:i[(l+(z?1:0))%i.length],rotation:{x:0,y:Math.round(d*180/Math.PI),z:0},scale:1}),this.placedPositions.add(b))}}return s}generateCavern(t,e,o,i){const s=[],n=Math.ceil(Math.sqrt(o.maxBlocks/2)),r=6+Math.floor(Math.random()*4),a=["stalactite","crystalSpike","crystalShard"],l=["stalagmite","rockTall","crystalSpike"],p=["rock","rockSmall","rockFlat","pebbles","moss"],h=["rockFlat","slate","moss"],y=["crystalSmall","crystalCluster","crystalFormation"];for(let c=-n;c<=n&&s.length<o.maxBlocks;c++)for(let d=-n;d<=n&&s.length<o.maxBlocks;d++){const f=Math.sqrt(c*c+d*d);if(f>n*1.2)continue;const m={x:t.x+c,y:t.y,z:t.z+d},x=this.posKey(m);if(!this.placedPositions.has(x)&&Math.random()<.4){const g=p[Math.floor(Math.random()*p.length)];this.blockManager.wouldOverlapAt(g,m)||(s.push({type:g,position:m,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(x))}if(Math.random()<.15&&s.length<o.maxBlocks){const g=1+Math.floor(Math.random()*3);for(let b=0;b<g&&s.length<o.maxBlocks;b++){const z={x:m.x,y:t.y+b,z:m.z},v=this.posKey(z);if(!this.placedPositions.has(v)){const C=b===g-1?l[Math.floor(Math.random()*l.length)]:"rockTall";this.blockManager.wouldOverlapAt(C,z)||(s.push({type:C,position:z,color:i[0],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}}if(Math.random()<.2&&s.length<o.maxBlocks){const g=1+Math.floor(Math.random()*3);for(let b=0;b<g&&s.length<o.maxBlocks;b++){const z={x:m.x,y:t.y+r-b,z:m.z},v=this.posKey(z);if(!this.placedPositions.has(v)){const C=b===g-1?a[Math.floor(Math.random()*a.length)]:h[Math.floor(Math.random()*h.length)];this.blockManager.wouldOverlapAt(C,z)||(s.push({type:C,position:z,color:i[Math.min(1,Math.floor(Math.random()*i.length))],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}}if(f>n*.7&&Math.random()<.3&&s.length<o.maxBlocks){const g=t.y+1+Math.floor(Math.random()*(r-2)),b={x:m.x,y:g,z:m.z},z=this.posKey(b);if(!this.placedPositions.has(z)){const v=y[Math.floor(Math.random()*y.length)];this.blockManager.wouldOverlapAt(v,b)||(s.push({type:v,position:b,color:i[2%i.length],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(z))}}}return s}generateRockField(t,e,o,i){const s=[],n=Math.ceil(Math.sqrt(o.maxBlocks)),r=["rockSmall","pebbles","slate"],a=["rock","rockFlat","rockCluster"],l=["rockLarge","rockTall","rockJagged","boulder","rockPile"],p=(h,y)=>Math.sin(h*.4)*Math.cos(y*.4)+Math.sin(h*.8+1)*Math.cos(y*.6)*.5;for(let h=-n;h<=n&&s.length<o.maxBlocks;h++)for(let y=-n;y<=n&&s.length<o.maxBlocks;y++){const c=p(h,y);if(Math.random()>.3+c*.3)continue;const d={x:t.x+h,y:t.y,z:t.z+y},f=this.posKey(d);if(this.placedPositions.has(f))continue;let m;const x=Math.random()+c*.3;x<.4?m=r:x<.8?m=a:m=l;const g=m[Math.floor(Math.random()*m.length)],b=l.includes(g)&&Math.random()>o.scaleRatio?2:1;if(!this.blockManager.wouldOverlapAt(g,d,{w:1,h:1,d:1},null,b)&&(s.push({type:g,position:d,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:b}),this.placedPositions.add(f),Math.random()<.2&&s.length<o.maxBlocks)){const z=[{dx:1,dz:0},{dx:-1,dz:0},{dx:0,dz:1},{dx:0,dz:-1}][Math.floor(Math.random()*4)],v={x:d.x+z.dx,y:t.y,z:d.z+z.dz},C=this.posKey(v);if(!this.placedPositions.has(C)){const B=Math.random()<.5?"moss":"pebbles";this.blockManager.wouldOverlapAt(B,v)||(s.push({type:B,position:v,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(C))}}}return s}generateMushroomGrove(t,e,o,i){const s=[],n=Math.ceil(Math.sqrt(o.maxBlocks)),r=["mushroom","mushroomCluster"],a=["moss","grass","pebbles"];let l=0;const p=o.maxBlocks*3;for(;s.length<o.maxBlocks&&l<p;){l++;const h={x:t.x+(Math.random()-.5)*n*2,z:t.z+(Math.random()-.5)*n*2},y=1+Math.floor(Math.random()*4);for(let c=0;c<y&&s.length<o.maxBlocks;c++){const d=c===0?{x:0,z:0}:{x:Math.floor((Math.random()-.5)*4),z:Math.floor((Math.random()-.5)*4)},f={x:Math.round(h.x+d.x),y:t.y,z:Math.round(h.z+d.z)},m=this.posKey(f);if(this.placedPositions.has(m))continue;const x=c===0&&y>2?"mushroomCluster":r[Math.floor(Math.random()*r.length)],g=x==="mushroomCluster"&&Math.random()>o.scaleRatio?2:1;if(!this.blockManager.wouldOverlapAt(x,f,{w:1,h:1,d:1},null,g)&&(s.push({type:x,position:f,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:g}),this.placedPositions.add(m),Math.random()<.4&&s.length<o.maxBlocks)){const b=[{dx:1,dz:0},{dx:-1,dz:0},{dx:0,dz:1},{dx:0,dz:-1}][Math.floor(Math.random()*4)],z={x:f.x+b.dx,y:t.y,z:f.z+b.dz},v=this.posKey(z);if(!this.placedPositions.has(v)){const C=a[Math.floor(Math.random()*a.length)];this.blockManager.wouldOverlapAt(C,z)||(s.push({type:C,position:z,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}}}return s}generateCrystalCave(t,e,o,i){const s=[],n=Math.ceil(Math.cbrt(o.maxBlocks)*1.5),r=["crystalSmall","crystalShard","gem"],a=["crystal","crystalFlat","crystalSpike"],l=["crystalLarge","crystalCluster","crystalFormation"],p=[{dir:"floor",yBase:0,yMod:1},{dir:"ceiling",yBase:n,yMod:-1},{dir:"wall",yBase:Math.floor(n/2),yMod:0}];for(const h of p){const y=Math.floor(o.maxBlocks/3);let c=0;for(;c<y&&s.length<o.maxBlocks;){const d=Math.random()*2*Math.PI,f=Math.random()*n,m={x:Math.round(t.x+Math.cos(d)*f),y:t.y+h.yBase+(h.yMod!==0?Math.floor(Math.random()*3)*h.yMod:0),z:Math.round(t.z+Math.sin(d)*f)};if(h.dir==="wall"){const B=n*(.8+Math.random()*.2);m.x=Math.round(t.x+Math.cos(d)*B),m.z=Math.round(t.z+Math.sin(d)*B),m.y=t.y+Math.floor(Math.random()*n)}const x=this.posKey(m);if(this.placedPositions.has(x)){c++;continue}const g=Math.sqrt(Math.pow(m.x-t.x,2)+Math.pow(m.z-t.z,2)),b=Math.random()+(1-g/n)*.5;let z;b<.4?z=r:b<.75?z=a:z=l;const v=z[Math.floor(Math.random()*z.length)],C=l.includes(v)&&Math.random()>o.scaleRatio?2:1;if(!this.blockManager.wouldOverlapAt(v,m,{w:1,h:1,d:1},null,C)){const B=Math.floor(d/(2*Math.PI)*i.length);s.push({type:v,position:m,color:i[B%i.length],rotation:{x:0,y:Math.round(d*180/Math.PI),z:0},scale:C}),this.placedPositions.add(x)}c++}}return s}generateCoralReef(t,e,o,i){const s=[],n=Math.ceil(Math.sqrt(o.maxBlocks)),r=["coral","crystalCluster","crystalFormation"],a=["vine","grass","moss"],l=["rockSmall","rockFlat","pebbles"],p=3+Math.floor(Math.random()*3),h=Math.floor(o.maxBlocks/p);for(let y=0;y<p&&s.length<o.maxBlocks;y++){const c={x:t.x+(Math.random()-.5)*n*1.5,z:t.z+(Math.random()-.5)*n*1.5},d=2+Math.random()*3,f=2+Math.floor(Math.random()*3);for(let m=0;m<h&&s.length<o.maxBlocks;m++){const x=Math.random()*2*Math.PI,g=Math.random()*d,b=1-g/d,z={x:Math.round(c.x+Math.cos(x)*g),y:t.y+Math.floor(Math.random()*f*b),z:Math.round(c.z+Math.sin(x)*g)},v=this.posKey(z);if(this.placedPositions.has(v))continue;let C;if(z.y===t.y)C=l[Math.floor(Math.random()*l.length)];else if(z.y>=t.y+f-1)C=r[Math.floor(Math.random()*r.length)];else{const B=Math.random();B<.5?C=r[Math.floor(Math.random()*r.length)]:B<.8?C=a[Math.floor(Math.random()*a.length)]:C=l[Math.floor(Math.random()*l.length)]}this.blockManager.wouldOverlapAt(C,z)||(s.push({type:C,position:z,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:1}),this.placedPositions.add(v))}}return s}generateBoulderPile(t,e,o,i){const s=[],n=Math.ceil(Math.cbrt(o.maxBlocks)*1.5),r=Math.ceil(n*.8),a=["boulder","rockLarge","rockPile"],l=["rock","rockJagged","rockCluster"],p=["rockFlat","rockSmall","pebbles","slate"];for(let h=0;h<r&&s.length<o.maxBlocks;h++){const y=n*(1-h/r*.7),c=h/r,d=.7-c*.4;for(let f=-Math.ceil(y);f<=Math.ceil(y)&&s.length<o.maxBlocks;f++)for(let m=-Math.ceil(y);m<=Math.ceil(y)&&s.length<o.maxBlocks;m++){if(Math.sqrt(f*f+m*m)>y||Math.random()>d)continue;const g={x:t.x+f,y:t.y+h,z:t.z+m},b=this.posKey(g);if(this.placedPositions.has(b))continue;let z;c<.3?z=Math.random()<.6?a:l:c<.7?z=Math.random()<.5?l:p:z=Math.random()<.7?p:l;const v=z[Math.floor(Math.random()*z.length)],C=a.includes(v)&&h<2&&Math.random()>o.scaleRatio?2:1;this.blockManager.wouldOverlapAt(v,g,{w:1,h:1,d:1},null,C)||(s.push({type:v,position:g,color:i[Math.floor(Math.random()*i.length)],rotation:{x:0,y:Math.floor(Math.random()*4)*90,z:0},scale:C}),this.placedPositions.add(b))}}return s}getBlockList(t){if(t.blocks&&t.blocks.length>0)return t.blocks;const e=[];return t.straight&&e.push(...Object.values(t.straight)),t.decorative&&e.push(...t.decorative),t.junctions&&e.push(...Object.values(t.junctions)),e.length>0?e:["cube"]}getBlockForPreset(t,e="any"){var o;if(t.clusterBased&&t.blocks)return t.blocks[Math.floor(Math.random()*t.blocks.length)];if(e==="vertical"&&((o=t.straight)!=null&&o.Y))return t.straight.Y;if(e==="straight"&&t.straight){const i=Object.keys(t.straight);return t.straight[i[Math.floor(Math.random()*i.length)]]}if(t.straight){const i=Object.keys(t.straight);return t.straight[i[Math.floor(Math.random()*i.length)]]}return t.decorative&&t.decorative.length>0?t.decorative[Math.floor(Math.random()*t.decorative.length)]:"cube"}getAxisFromDirection(t){return t.charAt(0)}getSignFromDirection(t){return t.charAt(1)==="+"?1:-1}moveInDirection(t,e,o=1){const i={...t},s=this.getSignFromDirection(e),n=this.getAxisFromDirection(e).toLowerCase();return i[n]+=s*o,i}getPerpendicularDirection(t,e=0){const o=this.getAxisFromDirection(t);let i;return o==="X"?(i=["Z+","Z-"],e>0&&Math.random()<e&&i.push("Y+","Y-")):o==="Z"?(i=["X+","X-"],e>0&&Math.random()<e&&i.push("Y+","Y-")):i=["X+","X-","Z+","Z-"],i[Math.floor(Math.random()*i.length)]}pickScale(t,e){const o=t.allowedScales||[1],i=o.includes(2),s=o.includes(4);if(!i&&!s)return 1;const n=Math.random();if(s&&i){const r=.3+e*.7,a=Math.max(0,(1-e)*.3),l=1-r-a;return n<r?1:n<r+l?2:4}else{if(i)return n>e?2:1;if(s)return n>e?4:1}return 1}getNeighbors(t){return[{x:t.x+1,y:t.y,z:t.z},{x:t.x-1,y:t.y,z:t.z},{x:t.x,y:t.y+1,z:t.z},{x:t.x,y:t.y-1,z:t.z},{x:t.x,y:t.y,z:t.z+1},{x:t.x,y:t.y,z:t.z-1}]}posKey(t){return`${Math.floor(t.x)},${Math.floor(t.y)},${Math.floor(t.z)}`}generateColorPalette(t,e){const o=new ot(t),i={h:0,s:0,l:0};o.getHSL(i);const s=[t];switch(e){case"analogous":s.push(this.hslToHex(i.h+.083,i.s,i.l),this.hslToHex(i.h-.083,i.s,i.l),this.hslToHex(i.h+.042,i.s,i.l*.7),this.hslToHex(i.h-.042,i.s*.8,Math.min(1,i.l*1.2)));break;case"complementary":s.push(this.hslToHex(i.h+.5,i.s,i.l),this.hslToHex(i.h,i.s*.6,i.l),this.hslToHex(i.h+.5,i.s*.6,i.l));break;case"triadic":s.push(this.hslToHex(i.h+.333,i.s,i.l),this.hslToHex(i.h+.666,i.s,i.l),this.hslToHex(i.h,i.s,i.l*.7));break;case"monochrome":s.push(this.hslToHex(i.h,i.s,i.l*.5),this.hslToHex(i.h,i.s,i.l*.7),this.hslToHex(i.h,i.s*.5,Math.min(1,i.l*1.2)),this.hslToHex(i.h,i.s*.3,Math.min(1,i.l*1.4)));break;case"split":s.push(this.hslToHex(i.h+.417,i.s,i.l),this.hslToHex(i.h+.583,i.s,i.l),this.hslToHex(i.h,i.s*.7,i.l*.8));break;default:for(let n=0;n<4;n++)s.push(this.hslToHex(i.h+(Math.random()-.5)*.2,Math.max(.2,i.s+(Math.random()-.5)*.3),Math.max(.2,Math.min(.9,i.l+(Math.random()-.5)*.3))))}return s}hslToHex(t,e,o){t=(t%1+1)%1,e=Math.max(0,Math.min(1,e)),o=Math.max(0,Math.min(1,o));const i=new ot;return i.setHSL(t,e,o),"#"+i.getHexString()}setPreset(t){fi[t]&&(this.preset=t)}setMaxBlocks(t){this.maxBlocks=Math.max(1,Math.min(500,t))}setBranchChance(t){this.branchChance=Math.max(0,Math.min(1,t))}setScaleRatio(t){this.scaleRatio=Math.max(0,Math.min(1,t))}setColorHarmony(t){this.colorHarmony=t}setAlgorithm(t){ni[t]&&(this.algorithm=t)}}var Ko=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function qp(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}function Jo(u){throw new Error('Could not dynamically require "'+u+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ki={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/var jn;function Kp(){return jn||(jn=1,(function(u,t){(function(e){u.exports=e()})(function(){return(function e(o,i,s){function n(l,p){if(!i[l]){if(!o[l]){var h=typeof Jo=="function"&&Jo;if(!p&&h)return h(l,!0);if(r)return r(l,!0);var y=new Error("Cannot find module '"+l+"'");throw y.code="MODULE_NOT_FOUND",y}var c=i[l]={exports:{}};o[l][0].call(c.exports,function(d){var f=o[l][1][d];return n(f||d)},c,c.exports,e,o,i,s)}return i[l].exports}for(var r=typeof Jo=="function"&&Jo,a=0;a<s.length;a++)n(s[a]);return n})({1:[function(e,o,i){var s=e("./utils"),n=e("./support"),r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(a){for(var l,p,h,y,c,d,f,m=[],x=0,g=a.length,b=g,z=s.getTypeOf(a)!=="string";x<a.length;)b=g-x,h=z?(l=a[x++],p=x<g?a[x++]:0,x<g?a[x++]:0):(l=a.charCodeAt(x++),p=x<g?a.charCodeAt(x++):0,x<g?a.charCodeAt(x++):0),y=l>>2,c=(3&l)<<4|p>>4,d=1<b?(15&p)<<2|h>>6:64,f=2<b?63&h:64,m.push(r.charAt(y)+r.charAt(c)+r.charAt(d)+r.charAt(f));return m.join("")},i.decode=function(a){var l,p,h,y,c,d,f=0,m=0,x="data:";if(a.substr(0,x.length)===x)throw new Error("Invalid base64 input, it looks like a data url.");var g,b=3*(a=a.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(a.charAt(a.length-1)===r.charAt(64)&&b--,a.charAt(a.length-2)===r.charAt(64)&&b--,b%1!=0)throw new Error("Invalid base64 input, bad content length.");for(g=n.uint8array?new Uint8Array(0|b):new Array(0|b);f<a.length;)l=r.indexOf(a.charAt(f++))<<2|(y=r.indexOf(a.charAt(f++)))>>4,p=(15&y)<<4|(c=r.indexOf(a.charAt(f++)))>>2,h=(3&c)<<6|(d=r.indexOf(a.charAt(f++))),g[m++]=l,c!==64&&(g[m++]=p),d!==64&&(g[m++]=h);return g}},{"./support":30,"./utils":32}],2:[function(e,o,i){var s=e("./external"),n=e("./stream/DataWorker"),r=e("./stream/Crc32Probe"),a=e("./stream/DataLengthProbe");function l(p,h,y,c,d){this.compressedSize=p,this.uncompressedSize=h,this.crc32=y,this.compression=c,this.compressedContent=d}l.prototype={getContentWorker:function(){var p=new n(s.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new a("data_length")),h=this;return p.on("end",function(){if(this.streamInfo.data_length!==h.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),p},getCompressedWorker:function(){return new n(s.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(p,h,y){return p.pipe(new r).pipe(new a("uncompressedSize")).pipe(h.compressWorker(y)).pipe(new a("compressedSize")).withStreamInfo("compression",h)},o.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,o,i){var s=e("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new s("STORE compression")},uncompressWorker:function(){return new s("STORE decompression")}},i.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,o,i){var s=e("./utils"),n=(function(){for(var r,a=[],l=0;l<256;l++){r=l;for(var p=0;p<8;p++)r=1&r?3988292384^r>>>1:r>>>1;a[l]=r}return a})();o.exports=function(r,a){return r!==void 0&&r.length?s.getTypeOf(r)!=="string"?(function(l,p,h,y){var c=n,d=y+h;l^=-1;for(var f=y;f<d;f++)l=l>>>8^c[255&(l^p[f])];return-1^l})(0|a,r,r.length,0):(function(l,p,h,y){var c=n,d=y+h;l^=-1;for(var f=y;f<d;f++)l=l>>>8^c[255&(l^p.charCodeAt(f))];return-1^l})(0|a,r,r.length,0):0}},{"./utils":32}],5:[function(e,o,i){i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(e,o,i){var s=null;s=typeof Promise<"u"?Promise:e("lie"),o.exports={Promise:s}},{lie:37}],7:[function(e,o,i){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",n=e("pako"),r=e("./utils"),a=e("./stream/GenericWorker"),l=s?"uint8array":"array";function p(h,y){a.call(this,"FlateWorker/"+h),this._pako=null,this._pakoAction=h,this._pakoOptions=y,this.meta={}}i.magic="\b\0",r.inherits(p,a),p.prototype.processChunk=function(h){this.meta=h.meta,this._pako===null&&this._createPako(),this._pako.push(r.transformTo(l,h.data),!1)},p.prototype.flush=function(){a.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},p.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this._pako=null},p.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var h=this;this._pako.onData=function(y){h.push({data:y,meta:h.meta})}},i.compressWorker=function(h){return new p("Deflate",h)},i.uncompressWorker=function(){return new p("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,o,i){function s(c,d){var f,m="";for(f=0;f<d;f++)m+=String.fromCharCode(255&c),c>>>=8;return m}function n(c,d,f,m,x,g){var b,z,v=c.file,C=c.compression,B=g!==l.utf8encode,A=r.transformTo("string",g(v.name)),M=r.transformTo("string",l.utf8encode(v.name)),S=v.comment,P=r.transformTo("string",g(S)),k=r.transformTo("string",l.utf8encode(S)),D=M.length!==v.name.length,F=k.length!==S.length,T="",K="",G="",rt=v.dir,$=v.date,et={crc32:0,compressedSize:0,uncompressedSize:0};d&&!f||(et.crc32=c.crc32,et.compressedSize=c.compressedSize,et.uncompressedSize=c.uncompressedSize);var j=0;d&&(j|=8),B||!D&&!F||(j|=2048);var O=0,tt=0;rt&&(O|=16),x==="UNIX"?(tt=798,O|=(function(W,ut){var Bt=W;return W||(Bt=ut?16893:33204),(65535&Bt)<<16})(v.unixPermissions,rt)):(tt=20,O|=(function(W){return 63&(W||0)})(v.dosPermissions)),b=$.getUTCHours(),b<<=6,b|=$.getUTCMinutes(),b<<=5,b|=$.getUTCSeconds()/2,z=$.getUTCFullYear()-1980,z<<=4,z|=$.getUTCMonth()+1,z<<=5,z|=$.getUTCDate(),D&&(K=s(1,1)+s(p(A),4)+M,T+="up"+s(K.length,2)+K),F&&(G=s(1,1)+s(p(P),4)+k,T+="uc"+s(G.length,2)+G);var Q="";return Q+=`
\0`,Q+=s(j,2),Q+=C.magic,Q+=s(b,2),Q+=s(z,2),Q+=s(et.crc32,4),Q+=s(et.compressedSize,4),Q+=s(et.uncompressedSize,4),Q+=s(A.length,2),Q+=s(T.length,2),{fileRecord:h.LOCAL_FILE_HEADER+Q+A+T,dirRecord:h.CENTRAL_FILE_HEADER+s(tt,2)+Q+s(P.length,2)+"\0\0\0\0"+s(O,4)+s(m,4)+A+T+P}}var r=e("../utils"),a=e("../stream/GenericWorker"),l=e("../utf8"),p=e("../crc32"),h=e("../signature");function y(c,d,f,m){a.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=d,this.zipPlatform=f,this.encodeFileName=m,this.streamFiles=c,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}r.inherits(y,a),y.prototype.push=function(c){var d=c.meta.percent||0,f=this.entriesCount,m=this._sources.length;this.accumulate?this.contentBuffer.push(c):(this.bytesWritten+=c.data.length,a.prototype.push.call(this,{data:c.data,meta:{currentFile:this.currentFile,percent:f?(d+100*(f-m-1))/f:100}}))},y.prototype.openedSource=function(c){this.currentSourceOffset=this.bytesWritten,this.currentFile=c.file.name;var d=this.streamFiles&&!c.file.dir;if(d){var f=n(c,d,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:f.fileRecord,meta:{percent:0}})}else this.accumulate=!0},y.prototype.closedSource=function(c){this.accumulate=!1;var d=this.streamFiles&&!c.file.dir,f=n(c,d,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(f.dirRecord),d)this.push({data:(function(m){return h.DATA_DESCRIPTOR+s(m.crc32,4)+s(m.compressedSize,4)+s(m.uncompressedSize,4)})(c),meta:{percent:100}});else for(this.push({data:f.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},y.prototype.flush=function(){for(var c=this.bytesWritten,d=0;d<this.dirRecords.length;d++)this.push({data:this.dirRecords[d],meta:{percent:100}});var f=this.bytesWritten-c,m=(function(x,g,b,z,v){var C=r.transformTo("string",v(z));return h.CENTRAL_DIRECTORY_END+"\0\0\0\0"+s(x,2)+s(x,2)+s(g,4)+s(b,4)+s(C.length,2)+C})(this.dirRecords.length,f,c,this.zipComment,this.encodeFileName);this.push({data:m,meta:{percent:100}})},y.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},y.prototype.registerPrevious=function(c){this._sources.push(c);var d=this;return c.on("data",function(f){d.processChunk(f)}),c.on("end",function(){d.closedSource(d.previous.streamInfo),d._sources.length?d.prepareNextSource():d.end()}),c.on("error",function(f){d.error(f)}),this},y.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},y.prototype.error=function(c){var d=this._sources;if(!a.prototype.error.call(this,c))return!1;for(var f=0;f<d.length;f++)try{d[f].error(c)}catch{}return!0},y.prototype.lock=function(){a.prototype.lock.call(this);for(var c=this._sources,d=0;d<c.length;d++)c[d].lock()},o.exports=y},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,o,i){var s=e("../compressions"),n=e("./ZipFileWorker");i.generateWorker=function(r,a,l){var p=new n(a.streamFiles,l,a.platform,a.encodeFileName),h=0;try{r.forEach(function(y,c){h++;var d=(function(g,b){var z=g||b,v=s[z];if(!v)throw new Error(z+" is not a valid compression method !");return v})(c.options.compression,a.compression),f=c.options.compressionOptions||a.compressionOptions||{},m=c.dir,x=c.date;c._compressWorker(d,f).withStreamInfo("file",{name:y,dir:m,date:x,comment:c.comment||"",unixPermissions:c.unixPermissions,dosPermissions:c.dosPermissions}).pipe(p)}),p.entriesCount=h}catch(y){p.error(y)}return p}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,o,i){function s(){if(!(this instanceof s))return new s;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var n=new s;for(var r in this)typeof this[r]!="function"&&(n[r]=this[r]);return n}}(s.prototype=e("./object")).loadAsync=e("./load"),s.support=e("./support"),s.defaults=e("./defaults"),s.version="3.10.1",s.loadAsync=function(n,r){return new s().loadAsync(n,r)},s.external=e("./external"),o.exports=s},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,o,i){var s=e("./utils"),n=e("./external"),r=e("./utf8"),a=e("./zipEntries"),l=e("./stream/Crc32Probe"),p=e("./nodejsUtils");function h(y){return new n.Promise(function(c,d){var f=y.decompressed.getContentWorker().pipe(new l);f.on("error",function(m){d(m)}).on("end",function(){f.streamInfo.crc32!==y.decompressed.crc32?d(new Error("Corrupted zip : CRC32 mismatch")):c()}).resume()})}o.exports=function(y,c){var d=this;return c=s.extend(c||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:r.utf8decode}),p.isNode&&p.isStream(y)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):s.prepareContent("the loaded zip file",y,!0,c.optimizedBinaryString,c.base64).then(function(f){var m=new a(c);return m.load(f),m}).then(function(f){var m=[n.Promise.resolve(f)],x=f.files;if(c.checkCRC32)for(var g=0;g<x.length;g++)m.push(h(x[g]));return n.Promise.all(m)}).then(function(f){for(var m=f.shift(),x=m.files,g=0;g<x.length;g++){var b=x[g],z=b.fileNameStr,v=s.resolve(b.fileNameStr);d.file(v,b.decompressed,{binary:!0,optimizedBinaryString:!0,date:b.date,dir:b.dir,comment:b.fileCommentStr.length?b.fileCommentStr:null,unixPermissions:b.unixPermissions,dosPermissions:b.dosPermissions,createFolders:c.createFolders}),b.dir||(d.file(v).unsafeOriginalName=z)}return m.zipComment.length&&(d.comment=m.zipComment),d})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,o,i){var s=e("../utils"),n=e("../stream/GenericWorker");function r(a,l){n.call(this,"Nodejs stream input adapter for "+a),this._upstreamEnded=!1,this._bindStream(l)}s.inherits(r,n),r.prototype._bindStream=function(a){var l=this;(this._stream=a).pause(),a.on("data",function(p){l.push({data:p,meta:{percent:0}})}).on("error",function(p){l.isPaused?this.generatedError=p:l.error(p)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},r.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},o.exports=r},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,o,i){var s=e("readable-stream").Readable;function n(r,a,l){s.call(this,a),this._helper=r;var p=this;r.on("data",function(h,y){p.push(h)||p._helper.pause(),l&&l(y)}).on("error",function(h){p.emit("error",h)}).on("end",function(){p.push(null)})}e("../utils").inherits(n,s),n.prototype._read=function(){this._helper.resume()},o.exports=n},{"../utils":32,"readable-stream":16}],14:[function(e,o,i){o.exports={isNode:typeof Buffer<"u",newBufferFrom:function(s,n){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(s,n);if(typeof s=="number")throw new Error('The "data" argument must not be a number');return new Buffer(s,n)},allocBuffer:function(s){if(Buffer.alloc)return Buffer.alloc(s);var n=new Buffer(s);return n.fill(0),n},isBuffer:function(s){return Buffer.isBuffer(s)},isStream:function(s){return s&&typeof s.on=="function"&&typeof s.pause=="function"&&typeof s.resume=="function"}}},{}],15:[function(e,o,i){function s(v,C,B){var A,M=r.getTypeOf(C),S=r.extend(B||{},p);S.date=S.date||new Date,S.compression!==null&&(S.compression=S.compression.toUpperCase()),typeof S.unixPermissions=="string"&&(S.unixPermissions=parseInt(S.unixPermissions,8)),S.unixPermissions&&16384&S.unixPermissions&&(S.dir=!0),S.dosPermissions&&16&S.dosPermissions&&(S.dir=!0),S.dir&&(v=x(v)),S.createFolders&&(A=m(v))&&g.call(this,A,!0);var P=M==="string"&&S.binary===!1&&S.base64===!1;B&&B.binary!==void 0||(S.binary=!P),(C instanceof h&&C.uncompressedSize===0||S.dir||!C||C.length===0)&&(S.base64=!1,S.binary=!0,C="",S.compression="STORE",M="string");var k=null;k=C instanceof h||C instanceof a?C:d.isNode&&d.isStream(C)?new f(v,C):r.prepareContent(v,C,S.binary,S.optimizedBinaryString,S.base64);var D=new y(v,k,S);this.files[v]=D}var n=e("./utf8"),r=e("./utils"),a=e("./stream/GenericWorker"),l=e("./stream/StreamHelper"),p=e("./defaults"),h=e("./compressedObject"),y=e("./zipObject"),c=e("./generate"),d=e("./nodejsUtils"),f=e("./nodejs/NodejsStreamInputAdapter"),m=function(v){v.slice(-1)==="/"&&(v=v.substring(0,v.length-1));var C=v.lastIndexOf("/");return 0<C?v.substring(0,C):""},x=function(v){return v.slice(-1)!=="/"&&(v+="/"),v},g=function(v,C){return C=C!==void 0?C:p.createFolders,v=x(v),this.files[v]||s.call(this,v,null,{dir:!0,createFolders:C}),this.files[v]};function b(v){return Object.prototype.toString.call(v)==="[object RegExp]"}var z={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(v){var C,B,A;for(C in this.files)A=this.files[C],(B=C.slice(this.root.length,C.length))&&C.slice(0,this.root.length)===this.root&&v(B,A)},filter:function(v){var C=[];return this.forEach(function(B,A){v(B,A)&&C.push(A)}),C},file:function(v,C,B){if(arguments.length!==1)return v=this.root+v,s.call(this,v,C,B),this;if(b(v)){var A=v;return this.filter(function(S,P){return!P.dir&&A.test(S)})}var M=this.files[this.root+v];return M&&!M.dir?M:null},folder:function(v){if(!v)return this;if(b(v))return this.filter(function(M,S){return S.dir&&v.test(M)});var C=this.root+v,B=g.call(this,C),A=this.clone();return A.root=B.name,A},remove:function(v){v=this.root+v;var C=this.files[v];if(C||(v.slice(-1)!=="/"&&(v+="/"),C=this.files[v]),C&&!C.dir)delete this.files[v];else for(var B=this.filter(function(M,S){return S.name.slice(0,v.length)===v}),A=0;A<B.length;A++)delete this.files[B[A].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(v){var C,B={};try{if((B=r.extend(v||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=B.type.toLowerCase(),B.compression=B.compression.toUpperCase(),B.type==="binarystring"&&(B.type="string"),!B.type)throw new Error("No output type specified.");r.checkSupport(B.type),B.platform!=="darwin"&&B.platform!=="freebsd"&&B.platform!=="linux"&&B.platform!=="sunos"||(B.platform="UNIX"),B.platform==="win32"&&(B.platform="DOS");var A=B.comment||this.comment||"";C=c.generateWorker(this,B,A)}catch(M){(C=new a("error")).error(M)}return new l(C,B.type||"string",B.mimeType)},generateAsync:function(v,C){return this.generateInternalStream(v).accumulate(C)},generateNodeStream:function(v,C){return(v=v||{}).type||(v.type="nodebuffer"),this.generateInternalStream(v).toNodejsStream(C)}};o.exports=z},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,o,i){o.exports=e("stream")},{stream:void 0}],17:[function(e,o,i){var s=e("./DataReader");function n(r){s.call(this,r);for(var a=0;a<this.data.length;a++)r[a]=255&r[a]}e("../utils").inherits(n,s),n.prototype.byteAt=function(r){return this.data[this.zero+r]},n.prototype.lastIndexOfSignature=function(r){for(var a=r.charCodeAt(0),l=r.charCodeAt(1),p=r.charCodeAt(2),h=r.charCodeAt(3),y=this.length-4;0<=y;--y)if(this.data[y]===a&&this.data[y+1]===l&&this.data[y+2]===p&&this.data[y+3]===h)return y-this.zero;return-1},n.prototype.readAndCheckSignature=function(r){var a=r.charCodeAt(0),l=r.charCodeAt(1),p=r.charCodeAt(2),h=r.charCodeAt(3),y=this.readData(4);return a===y[0]&&l===y[1]&&p===y[2]&&h===y[3]},n.prototype.readData=function(r){if(this.checkOffset(r),r===0)return[];var a=this.data.slice(this.zero+this.index,this.zero+this.index+r);return this.index+=r,a},o.exports=n},{"../utils":32,"./DataReader":18}],18:[function(e,o,i){var s=e("../utils");function n(r){this.data=r,this.length=r.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(r){this.checkIndex(this.index+r)},checkIndex:function(r){if(this.length<this.zero+r||r<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+r+"). Corrupted zip ?")},setIndex:function(r){this.checkIndex(r),this.index=r},skip:function(r){this.setIndex(this.index+r)},byteAt:function(){},readInt:function(r){var a,l=0;for(this.checkOffset(r),a=this.index+r-1;a>=this.index;a--)l=(l<<8)+this.byteAt(a);return this.index+=r,l},readString:function(r){return s.transformTo("string",this.readData(r))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var r=this.readInt(4);return new Date(Date.UTC(1980+(r>>25&127),(r>>21&15)-1,r>>16&31,r>>11&31,r>>5&63,(31&r)<<1))}},o.exports=n},{"../utils":32}],19:[function(e,o,i){var s=e("./Uint8ArrayReader");function n(r){s.call(this,r)}e("../utils").inherits(n,s),n.prototype.readData=function(r){this.checkOffset(r);var a=this.data.slice(this.zero+this.index,this.zero+this.index+r);return this.index+=r,a},o.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,o,i){var s=e("./DataReader");function n(r){s.call(this,r)}e("../utils").inherits(n,s),n.prototype.byteAt=function(r){return this.data.charCodeAt(this.zero+r)},n.prototype.lastIndexOfSignature=function(r){return this.data.lastIndexOf(r)-this.zero},n.prototype.readAndCheckSignature=function(r){return r===this.readData(4)},n.prototype.readData=function(r){this.checkOffset(r);var a=this.data.slice(this.zero+this.index,this.zero+this.index+r);return this.index+=r,a},o.exports=n},{"../utils":32,"./DataReader":18}],21:[function(e,o,i){var s=e("./ArrayReader");function n(r){s.call(this,r)}e("../utils").inherits(n,s),n.prototype.readData=function(r){if(this.checkOffset(r),r===0)return new Uint8Array(0);var a=this.data.subarray(this.zero+this.index,this.zero+this.index+r);return this.index+=r,a},o.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(e,o,i){var s=e("../utils"),n=e("../support"),r=e("./ArrayReader"),a=e("./StringReader"),l=e("./NodeBufferReader"),p=e("./Uint8ArrayReader");o.exports=function(h){var y=s.getTypeOf(h);return s.checkSupport(y),y!=="string"||n.uint8array?y==="nodebuffer"?new l(h):n.uint8array?new p(s.transformTo("uint8array",h)):new r(s.transformTo("array",h)):new a(h)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,o,i){i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,o,i){var s=e("./GenericWorker"),n=e("../utils");function r(a){s.call(this,"ConvertWorker to "+a),this.destType=a}n.inherits(r,s),r.prototype.processChunk=function(a){this.push({data:n.transformTo(this.destType,a.data),meta:a.meta})},o.exports=r},{"../utils":32,"./GenericWorker":28}],25:[function(e,o,i){var s=e("./GenericWorker"),n=e("../crc32");function r(){s.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(r,s),r.prototype.processChunk=function(a){this.streamInfo.crc32=n(a.data,this.streamInfo.crc32||0),this.push(a)},o.exports=r},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,o,i){var s=e("../utils"),n=e("./GenericWorker");function r(a){n.call(this,"DataLengthProbe for "+a),this.propName=a,this.withStreamInfo(a,0)}s.inherits(r,n),r.prototype.processChunk=function(a){if(a){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+a.data.length}n.prototype.processChunk.call(this,a)},o.exports=r},{"../utils":32,"./GenericWorker":28}],27:[function(e,o,i){var s=e("../utils"),n=e("./GenericWorker");function r(a){n.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,a.then(function(p){l.dataIsReady=!0,l.data=p,l.max=p&&p.length||0,l.type=s.getTypeOf(p),l.isPaused||l._tickAndRepeat()},function(p){l.error(p)})}s.inherits(r,n),r.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,s.delay(this._tickAndRepeat,[],this)),!0)},r.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(s.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},r.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var a=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":a=this.data.substring(this.index,l);break;case"uint8array":a=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":a=this.data.slice(this.index,l)}return this.index=l,this.push({data:a,meta:{percent:this.max?this.index/this.max*100:0}})},o.exports=r},{"../utils":32,"./GenericWorker":28}],28:[function(e,o,i){function s(n){this.name=n||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}s.prototype={push:function(n){this.emit("data",n)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(n){this.emit("error",n)}return!0},error:function(n){return!this.isFinished&&(this.isPaused?this.generatedError=n:(this.isFinished=!0,this.emit("error",n),this.previous&&this.previous.error(n),this.cleanUp()),!0)},on:function(n,r){return this._listeners[n].push(r),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(n,r){if(this._listeners[n])for(var a=0;a<this._listeners[n].length;a++)this._listeners[n][a].call(this,r)},pipe:function(n){return n.registerPrevious(this)},registerPrevious:function(n){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=n.streamInfo,this.mergeStreamInfo(),this.previous=n;var r=this;return n.on("data",function(a){r.processChunk(a)}),n.on("end",function(){r.end()}),n.on("error",function(a){r.error(a)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var n=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),n=!0),this.previous&&this.previous.resume(),!n},flush:function(){},processChunk:function(n){this.push(n)},withStreamInfo:function(n,r){return this.extraStreamInfo[n]=r,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var n in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,n)&&(this.streamInfo[n]=this.extraStreamInfo[n])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var n="Worker "+this.name;return this.previous?this.previous+" -> "+n:n}},o.exports=s},{}],29:[function(e,o,i){var s=e("../utils"),n=e("./ConvertWorker"),r=e("./GenericWorker"),a=e("../base64"),l=e("../support"),p=e("../external"),h=null;if(l.nodestream)try{h=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function y(d,f){return new p.Promise(function(m,x){var g=[],b=d._internalType,z=d._outputType,v=d._mimeType;d.on("data",function(C,B){g.push(C),f&&f(B)}).on("error",function(C){g=[],x(C)}).on("end",function(){try{var C=(function(B,A,M){switch(B){case"blob":return s.newBlob(s.transformTo("arraybuffer",A),M);case"base64":return a.encode(A);default:return s.transformTo(B,A)}})(z,(function(B,A){var M,S=0,P=null,k=0;for(M=0;M<A.length;M++)k+=A[M].length;switch(B){case"string":return A.join("");case"array":return Array.prototype.concat.apply([],A);case"uint8array":for(P=new Uint8Array(k),M=0;M<A.length;M++)P.set(A[M],S),S+=A[M].length;return P;case"nodebuffer":return Buffer.concat(A);default:throw new Error("concat : unsupported type '"+B+"'")}})(b,g),v);m(C)}catch(B){x(B)}g=[]}).resume()})}function c(d,f,m){var x=f;switch(f){case"blob":case"arraybuffer":x="uint8array";break;case"base64":x="string"}try{this._internalType=x,this._outputType=f,this._mimeType=m,s.checkSupport(x),this._worker=d.pipe(new n(x)),d.lock()}catch(g){this._worker=new r("error"),this._worker.error(g)}}c.prototype={accumulate:function(d){return y(this,d)},on:function(d,f){var m=this;return d==="data"?this._worker.on(d,function(x){f.call(m,x.data,x.meta)}):this._worker.on(d,function(){s.delay(f,arguments,m)}),this},resume:function(){return s.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(d){if(s.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new h(this,{objectMode:this._outputType!=="nodebuffer"},d)}},o.exports=c},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,o,i){if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",i.nodebuffer=typeof Buffer<"u",i.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")i.blob=!1;else{var s=new ArrayBuffer(0);try{i.blob=new Blob([s],{type:"application/zip"}).size===0}catch{try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(s),i.blob=n.getBlob("application/zip").size===0}catch{i.blob=!1}}}try{i.nodestream=!!e("readable-stream").Readable}catch{i.nodestream=!1}},{"readable-stream":16}],31:[function(e,o,i){for(var s=e("./utils"),n=e("./support"),r=e("./nodejsUtils"),a=e("./stream/GenericWorker"),l=new Array(256),p=0;p<256;p++)l[p]=252<=p?6:248<=p?5:240<=p?4:224<=p?3:192<=p?2:1;l[254]=l[254]=1;function h(){a.call(this,"utf-8 decode"),this.leftOver=null}function y(){a.call(this,"utf-8 encode")}i.utf8encode=function(c){return n.nodebuffer?r.newBufferFrom(c,"utf-8"):(function(d){var f,m,x,g,b,z=d.length,v=0;for(g=0;g<z;g++)(64512&(m=d.charCodeAt(g)))==55296&&g+1<z&&(64512&(x=d.charCodeAt(g+1)))==56320&&(m=65536+(m-55296<<10)+(x-56320),g++),v+=m<128?1:m<2048?2:m<65536?3:4;for(f=n.uint8array?new Uint8Array(v):new Array(v),g=b=0;b<v;g++)(64512&(m=d.charCodeAt(g)))==55296&&g+1<z&&(64512&(x=d.charCodeAt(g+1)))==56320&&(m=65536+(m-55296<<10)+(x-56320),g++),m<128?f[b++]=m:(m<2048?f[b++]=192|m>>>6:(m<65536?f[b++]=224|m>>>12:(f[b++]=240|m>>>18,f[b++]=128|m>>>12&63),f[b++]=128|m>>>6&63),f[b++]=128|63&m);return f})(c)},i.utf8decode=function(c){return n.nodebuffer?s.transformTo("nodebuffer",c).toString("utf-8"):(function(d){var f,m,x,g,b=d.length,z=new Array(2*b);for(f=m=0;f<b;)if((x=d[f++])<128)z[m++]=x;else if(4<(g=l[x]))z[m++]=65533,f+=g-1;else{for(x&=g===2?31:g===3?15:7;1<g&&f<b;)x=x<<6|63&d[f++],g--;1<g?z[m++]=65533:x<65536?z[m++]=x:(x-=65536,z[m++]=55296|x>>10&1023,z[m++]=56320|1023&x)}return z.length!==m&&(z.subarray?z=z.subarray(0,m):z.length=m),s.applyFromCharCode(z)})(c=s.transformTo(n.uint8array?"uint8array":"array",c))},s.inherits(h,a),h.prototype.processChunk=function(c){var d=s.transformTo(n.uint8array?"uint8array":"array",c.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var f=d;(d=new Uint8Array(f.length+this.leftOver.length)).set(this.leftOver,0),d.set(f,this.leftOver.length)}else d=this.leftOver.concat(d);this.leftOver=null}var m=(function(g,b){var z;for((b=b||g.length)>g.length&&(b=g.length),z=b-1;0<=z&&(192&g[z])==128;)z--;return z<0||z===0?b:z+l[g[z]]>b?z:b})(d),x=d;m!==d.length&&(n.uint8array?(x=d.subarray(0,m),this.leftOver=d.subarray(m,d.length)):(x=d.slice(0,m),this.leftOver=d.slice(m,d.length))),this.push({data:i.utf8decode(x),meta:c.meta})},h.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=h,s.inherits(y,a),y.prototype.processChunk=function(c){this.push({data:i.utf8encode(c.data),meta:c.meta})},i.Utf8EncodeWorker=y},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,o,i){var s=e("./support"),n=e("./base64"),r=e("./nodejsUtils"),a=e("./external");function l(f){return f}function p(f,m){for(var x=0;x<f.length;++x)m[x]=255&f.charCodeAt(x);return m}e("setimmediate"),i.newBlob=function(f,m){i.checkSupport("blob");try{return new Blob([f],{type:m})}catch{try{var x=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return x.append(f),x.getBlob(m)}catch{throw new Error("Bug : can't construct the Blob.")}}};var h={stringifyByChunk:function(f,m,x){var g=[],b=0,z=f.length;if(z<=x)return String.fromCharCode.apply(null,f);for(;b<z;)m==="array"||m==="nodebuffer"?g.push(String.fromCharCode.apply(null,f.slice(b,Math.min(b+x,z)))):g.push(String.fromCharCode.apply(null,f.subarray(b,Math.min(b+x,z)))),b+=x;return g.join("")},stringifyByChar:function(f){for(var m="",x=0;x<f.length;x++)m+=String.fromCharCode(f[x]);return m},applyCanBeUsed:{uint8array:(function(){try{return s.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}})(),nodebuffer:(function(){try{return s.nodebuffer&&String.fromCharCode.apply(null,r.allocBuffer(1)).length===1}catch{return!1}})()}};function y(f){var m=65536,x=i.getTypeOf(f),g=!0;if(x==="uint8array"?g=h.applyCanBeUsed.uint8array:x==="nodebuffer"&&(g=h.applyCanBeUsed.nodebuffer),g)for(;1<m;)try{return h.stringifyByChunk(f,x,m)}catch{m=Math.floor(m/2)}return h.stringifyByChar(f)}function c(f,m){for(var x=0;x<f.length;x++)m[x]=f[x];return m}i.applyFromCharCode=y;var d={};d.string={string:l,array:function(f){return p(f,new Array(f.length))},arraybuffer:function(f){return d.string.uint8array(f).buffer},uint8array:function(f){return p(f,new Uint8Array(f.length))},nodebuffer:function(f){return p(f,r.allocBuffer(f.length))}},d.array={string:y,array:l,arraybuffer:function(f){return new Uint8Array(f).buffer},uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return r.newBufferFrom(f)}},d.arraybuffer={string:function(f){return y(new Uint8Array(f))},array:function(f){return c(new Uint8Array(f),new Array(f.byteLength))},arraybuffer:l,uint8array:function(f){return new Uint8Array(f)},nodebuffer:function(f){return r.newBufferFrom(new Uint8Array(f))}},d.uint8array={string:y,array:function(f){return c(f,new Array(f.length))},arraybuffer:function(f){return f.buffer},uint8array:l,nodebuffer:function(f){return r.newBufferFrom(f)}},d.nodebuffer={string:y,array:function(f){return c(f,new Array(f.length))},arraybuffer:function(f){return d.nodebuffer.uint8array(f).buffer},uint8array:function(f){return c(f,new Uint8Array(f.length))},nodebuffer:l},i.transformTo=function(f,m){if(m=m||"",!f)return m;i.checkSupport(f);var x=i.getTypeOf(m);return d[x][f](m)},i.resolve=function(f){for(var m=f.split("/"),x=[],g=0;g<m.length;g++){var b=m[g];b==="."||b===""&&g!==0&&g!==m.length-1||(b===".."?x.pop():x.push(b))}return x.join("/")},i.getTypeOf=function(f){return typeof f=="string"?"string":Object.prototype.toString.call(f)==="[object Array]"?"array":s.nodebuffer&&r.isBuffer(f)?"nodebuffer":s.uint8array&&f instanceof Uint8Array?"uint8array":s.arraybuffer&&f instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(f){if(!s[f.toLowerCase()])throw new Error(f+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(f){var m,x,g="";for(x=0;x<(f||"").length;x++)g+="\\x"+((m=f.charCodeAt(x))<16?"0":"")+m.toString(16).toUpperCase();return g},i.delay=function(f,m,x){setImmediate(function(){f.apply(x||null,m||[])})},i.inherits=function(f,m){function x(){}x.prototype=m.prototype,f.prototype=new x},i.extend=function(){var f,m,x={};for(f=0;f<arguments.length;f++)for(m in arguments[f])Object.prototype.hasOwnProperty.call(arguments[f],m)&&x[m]===void 0&&(x[m]=arguments[f][m]);return x},i.prepareContent=function(f,m,x,g,b){return a.Promise.resolve(m).then(function(z){return s.blob&&(z instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(z))!==-1)&&typeof FileReader<"u"?new a.Promise(function(v,C){var B=new FileReader;B.onload=function(A){v(A.target.result)},B.onerror=function(A){C(A.target.error)},B.readAsArrayBuffer(z)}):z}).then(function(z){var v=i.getTypeOf(z);return v?(v==="arraybuffer"?z=i.transformTo("uint8array",z):v==="string"&&(b?z=n.decode(z):x&&g!==!0&&(z=(function(C){return p(C,s.uint8array?new Uint8Array(C.length):new Array(C.length))})(z))),z):a.Promise.reject(new Error("Can't read the data of '"+f+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,o,i){var s=e("./reader/readerFor"),n=e("./utils"),r=e("./signature"),a=e("./zipEntry"),l=e("./support");function p(h){this.files=[],this.loadOptions=h}p.prototype={checkSignature:function(h){if(!this.reader.readAndCheckSignature(h)){this.reader.index-=4;var y=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(y)+", expected "+n.pretty(h)+")")}},isSignature:function(h,y){var c=this.reader.index;this.reader.setIndex(h);var d=this.reader.readString(4)===y;return this.reader.setIndex(c),d},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var h=this.reader.readData(this.zipCommentLength),y=l.uint8array?"uint8array":"array",c=n.transformTo(y,h);this.zipComment=this.loadOptions.decodeFileName(c)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var h,y,c,d=this.zip64EndOfCentralSize-44;0<d;)h=this.reader.readInt(2),y=this.reader.readInt(4),c=this.reader.readData(y),this.zip64ExtensibleData[h]={id:h,length:y,value:c}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var h,y;for(h=0;h<this.files.length;h++)y=this.files[h],this.reader.setIndex(y.localHeaderOffset),this.checkSignature(r.LOCAL_FILE_HEADER),y.readLocalPart(this.reader),y.handleUTF8(),y.processAttributes()},readCentralDir:function(){var h;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(r.CENTRAL_FILE_HEADER);)(h=new a({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(h);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var h=this.reader.lastIndexOfSignature(r.CENTRAL_DIRECTORY_END);if(h<0)throw this.isSignature(0,r.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(h);var y=h;if(this.checkSignature(r.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(h=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(h),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,r.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var c=this.centralDirOffset+this.centralDirSize;this.zip64&&(c+=20,c+=12+this.zip64EndOfCentralSize);var d=y-c;if(0<d)this.isSignature(y,r.CENTRAL_FILE_HEADER)||(this.reader.zero=d);else if(d<0)throw new Error("Corrupted zip: missing "+Math.abs(d)+" bytes.")},prepareReader:function(h){this.reader=s(h)},load:function(h){this.prepareReader(h),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},o.exports=p},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,o,i){var s=e("./reader/readerFor"),n=e("./utils"),r=e("./compressedObject"),a=e("./crc32"),l=e("./utf8"),p=e("./compressions"),h=e("./support");function y(c,d){this.options=c,this.loadOptions=d}y.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(c){var d,f;if(c.skip(22),this.fileNameLength=c.readInt(2),f=c.readInt(2),this.fileName=c.readData(this.fileNameLength),c.skip(f),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((d=(function(m){for(var x in p)if(Object.prototype.hasOwnProperty.call(p,x)&&p[x].magic===m)return p[x];return null})(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new r(this.compressedSize,this.uncompressedSize,this.crc32,d,c.readData(this.compressedSize))},readCentralPart:function(c){this.versionMadeBy=c.readInt(2),c.skip(2),this.bitFlag=c.readInt(2),this.compressionMethod=c.readString(2),this.date=c.readDate(),this.crc32=c.readInt(4),this.compressedSize=c.readInt(4),this.uncompressedSize=c.readInt(4);var d=c.readInt(2);if(this.extraFieldsLength=c.readInt(2),this.fileCommentLength=c.readInt(2),this.diskNumberStart=c.readInt(2),this.internalFileAttributes=c.readInt(2),this.externalFileAttributes=c.readInt(4),this.localHeaderOffset=c.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");c.skip(d),this.readExtraFields(c),this.parseZIP64ExtraField(c),this.fileComment=c.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var c=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),c==0&&(this.dosPermissions=63&this.externalFileAttributes),c==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var c=s(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=c.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=c.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=c.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=c.readInt(4))}},readExtraFields:function(c){var d,f,m,x=c.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});c.index+4<x;)d=c.readInt(2),f=c.readInt(2),m=c.readData(f),this.extraFields[d]={id:d,length:f,value:m};c.setIndex(x)},handleUTF8:function(){var c=h.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var d=this.findExtraFieldUnicodePath();if(d!==null)this.fileNameStr=d;else{var f=n.transformTo(c,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(f)}var m=this.findExtraFieldUnicodeComment();if(m!==null)this.fileCommentStr=m;else{var x=n.transformTo(c,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(x)}}},findExtraFieldUnicodePath:function(){var c=this.extraFields[28789];if(c){var d=s(c.value);return d.readInt(1)!==1||a(this.fileName)!==d.readInt(4)?null:l.utf8decode(d.readData(c.length-5))}return null},findExtraFieldUnicodeComment:function(){var c=this.extraFields[25461];if(c){var d=s(c.value);return d.readInt(1)!==1||a(this.fileComment)!==d.readInt(4)?null:l.utf8decode(d.readData(c.length-5))}return null}},o.exports=y},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,o,i){function s(d,f,m){this.name=d,this.dir=m.dir,this.date=m.date,this.comment=m.comment,this.unixPermissions=m.unixPermissions,this.dosPermissions=m.dosPermissions,this._data=f,this._dataBinary=m.binary,this.options={compression:m.compression,compressionOptions:m.compressionOptions}}var n=e("./stream/StreamHelper"),r=e("./stream/DataWorker"),a=e("./utf8"),l=e("./compressedObject"),p=e("./stream/GenericWorker");s.prototype={internalStream:function(d){var f=null,m="string";try{if(!d)throw new Error("No output type specified.");var x=(m=d.toLowerCase())==="string"||m==="text";m!=="binarystring"&&m!=="text"||(m="string"),f=this._decompressWorker();var g=!this._dataBinary;g&&!x&&(f=f.pipe(new a.Utf8EncodeWorker)),!g&&x&&(f=f.pipe(new a.Utf8DecodeWorker))}catch(b){(f=new p("error")).error(b)}return new n(f,m,"")},async:function(d,f){return this.internalStream(d).accumulate(f)},nodeStream:function(d,f){return this.internalStream(d||"nodebuffer").toNodejsStream(f)},_compressWorker:function(d,f){if(this._data instanceof l&&this._data.compression.magic===d.magic)return this._data.getCompressedWorker();var m=this._decompressWorker();return this._dataBinary||(m=m.pipe(new a.Utf8EncodeWorker)),l.createWorkerFrom(m,d,f)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof p?this._data:new r(this._data)}};for(var h=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],y=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},c=0;c<h.length;c++)s.prototype[h[c]]=y;o.exports=s},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,o,i){(function(s){var n,r,a=s.MutationObserver||s.WebKitMutationObserver;if(a){var l=0,p=new a(d),h=s.document.createTextNode("");p.observe(h,{characterData:!0}),n=function(){h.data=l=++l%2}}else if(s.setImmediate||s.MessageChannel===void 0)n="document"in s&&"onreadystatechange"in s.document.createElement("script")?function(){var f=s.document.createElement("script");f.onreadystatechange=function(){d(),f.onreadystatechange=null,f.parentNode.removeChild(f),f=null},s.document.documentElement.appendChild(f)}:function(){setTimeout(d,0)};else{var y=new s.MessageChannel;y.port1.onmessage=d,n=function(){y.port2.postMessage(0)}}var c=[];function d(){var f,m;r=!0;for(var x=c.length;x;){for(m=c,c=[],f=-1;++f<x;)m[f]();x=c.length}r=!1}o.exports=function(f){c.push(f)!==1||r||n()}}).call(this,typeof Ko<"u"?Ko:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,o,i){var s=e("immediate");function n(){}var r={},a=["REJECTED"],l=["FULFILLED"],p=["PENDING"];function h(x){if(typeof x!="function")throw new TypeError("resolver must be a function");this.state=p,this.queue=[],this.outcome=void 0,x!==n&&f(this,x)}function y(x,g,b){this.promise=x,typeof g=="function"&&(this.onFulfilled=g,this.callFulfilled=this.otherCallFulfilled),typeof b=="function"&&(this.onRejected=b,this.callRejected=this.otherCallRejected)}function c(x,g,b){s(function(){var z;try{z=g(b)}catch(v){return r.reject(x,v)}z===x?r.reject(x,new TypeError("Cannot resolve promise with itself")):r.resolve(x,z)})}function d(x){var g=x&&x.then;if(x&&(typeof x=="object"||typeof x=="function")&&typeof g=="function")return function(){g.apply(x,arguments)}}function f(x,g){var b=!1;function z(B){b||(b=!0,r.reject(x,B))}function v(B){b||(b=!0,r.resolve(x,B))}var C=m(function(){g(v,z)});C.status==="error"&&z(C.value)}function m(x,g){var b={};try{b.value=x(g),b.status="success"}catch(z){b.status="error",b.value=z}return b}(o.exports=h).prototype.finally=function(x){if(typeof x!="function")return this;var g=this.constructor;return this.then(function(b){return g.resolve(x()).then(function(){return b})},function(b){return g.resolve(x()).then(function(){throw b})})},h.prototype.catch=function(x){return this.then(null,x)},h.prototype.then=function(x,g){if(typeof x!="function"&&this.state===l||typeof g!="function"&&this.state===a)return this;var b=new this.constructor(n);return this.state!==p?c(b,this.state===l?x:g,this.outcome):this.queue.push(new y(b,x,g)),b},y.prototype.callFulfilled=function(x){r.resolve(this.promise,x)},y.prototype.otherCallFulfilled=function(x){c(this.promise,this.onFulfilled,x)},y.prototype.callRejected=function(x){r.reject(this.promise,x)},y.prototype.otherCallRejected=function(x){c(this.promise,this.onRejected,x)},r.resolve=function(x,g){var b=m(d,g);if(b.status==="error")return r.reject(x,b.value);var z=b.value;if(z)f(x,z);else{x.state=l,x.outcome=g;for(var v=-1,C=x.queue.length;++v<C;)x.queue[v].callFulfilled(g)}return x},r.reject=function(x,g){x.state=a,x.outcome=g;for(var b=-1,z=x.queue.length;++b<z;)x.queue[b].callRejected(g);return x},h.resolve=function(x){return x instanceof this?x:r.resolve(new this(n),x)},h.reject=function(x){var g=new this(n);return r.reject(g,x)},h.all=function(x){var g=this;if(Object.prototype.toString.call(x)!=="[object Array]")return this.reject(new TypeError("must be an array"));var b=x.length,z=!1;if(!b)return this.resolve([]);for(var v=new Array(b),C=0,B=-1,A=new this(n);++B<b;)M(x[B],B);return A;function M(S,P){g.resolve(S).then(function(k){v[P]=k,++C!==b||z||(z=!0,r.resolve(A,v))},function(k){z||(z=!0,r.reject(A,k))})}},h.race=function(x){var g=this;if(Object.prototype.toString.call(x)!=="[object Array]")return this.reject(new TypeError("must be an array"));var b=x.length,z=!1;if(!b)return this.resolve([]);for(var v=-1,C=new this(n);++v<b;)B=x[v],g.resolve(B).then(function(A){z||(z=!0,r.resolve(C,A))},function(A){z||(z=!0,r.reject(C,A))});var B;return C}},{immediate:36}],38:[function(e,o,i){var s={};(0,e("./lib/utils/common").assign)(s,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),o.exports=s},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,o,i){var s=e("./zlib/deflate"),n=e("./utils/common"),r=e("./utils/strings"),a=e("./zlib/messages"),l=e("./zlib/zstream"),p=Object.prototype.toString,h=0,y=-1,c=0,d=8;function f(x){if(!(this instanceof f))return new f(x);this.options=n.assign({level:y,method:d,chunkSize:16384,windowBits:15,memLevel:8,strategy:c,to:""},x||{});var g=this.options;g.raw&&0<g.windowBits?g.windowBits=-g.windowBits:g.gzip&&0<g.windowBits&&g.windowBits<16&&(g.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var b=s.deflateInit2(this.strm,g.level,g.method,g.windowBits,g.memLevel,g.strategy);if(b!==h)throw new Error(a[b]);if(g.header&&s.deflateSetHeader(this.strm,g.header),g.dictionary){var z;if(z=typeof g.dictionary=="string"?r.string2buf(g.dictionary):p.call(g.dictionary)==="[object ArrayBuffer]"?new Uint8Array(g.dictionary):g.dictionary,(b=s.deflateSetDictionary(this.strm,z))!==h)throw new Error(a[b]);this._dict_set=!0}}function m(x,g){var b=new f(g);if(b.push(x,!0),b.err)throw b.msg||a[b.err];return b.result}f.prototype.push=function(x,g){var b,z,v=this.strm,C=this.options.chunkSize;if(this.ended)return!1;z=g===~~g?g:g===!0?4:0,typeof x=="string"?v.input=r.string2buf(x):p.call(x)==="[object ArrayBuffer]"?v.input=new Uint8Array(x):v.input=x,v.next_in=0,v.avail_in=v.input.length;do{if(v.avail_out===0&&(v.output=new n.Buf8(C),v.next_out=0,v.avail_out=C),(b=s.deflate(v,z))!==1&&b!==h)return this.onEnd(b),!(this.ended=!0);v.avail_out!==0&&(v.avail_in!==0||z!==4&&z!==2)||(this.options.to==="string"?this.onData(r.buf2binstring(n.shrinkBuf(v.output,v.next_out))):this.onData(n.shrinkBuf(v.output,v.next_out)))}while((0<v.avail_in||v.avail_out===0)&&b!==1);return z===4?(b=s.deflateEnd(this.strm),this.onEnd(b),this.ended=!0,b===h):z!==2||(this.onEnd(h),!(v.avail_out=0))},f.prototype.onData=function(x){this.chunks.push(x)},f.prototype.onEnd=function(x){x===h&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=x,this.msg=this.strm.msg},i.Deflate=f,i.deflate=m,i.deflateRaw=function(x,g){return(g=g||{}).raw=!0,m(x,g)},i.gzip=function(x,g){return(g=g||{}).gzip=!0,m(x,g)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,o,i){var s=e("./zlib/inflate"),n=e("./utils/common"),r=e("./utils/strings"),a=e("./zlib/constants"),l=e("./zlib/messages"),p=e("./zlib/zstream"),h=e("./zlib/gzheader"),y=Object.prototype.toString;function c(f){if(!(this instanceof c))return new c(f);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},f||{});var m=this.options;m.raw&&0<=m.windowBits&&m.windowBits<16&&(m.windowBits=-m.windowBits,m.windowBits===0&&(m.windowBits=-15)),!(0<=m.windowBits&&m.windowBits<16)||f&&f.windowBits||(m.windowBits+=32),15<m.windowBits&&m.windowBits<48&&(15&m.windowBits)==0&&(m.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new p,this.strm.avail_out=0;var x=s.inflateInit2(this.strm,m.windowBits);if(x!==a.Z_OK)throw new Error(l[x]);this.header=new h,s.inflateGetHeader(this.strm,this.header)}function d(f,m){var x=new c(m);if(x.push(f,!0),x.err)throw x.msg||l[x.err];return x.result}c.prototype.push=function(f,m){var x,g,b,z,v,C,B=this.strm,A=this.options.chunkSize,M=this.options.dictionary,S=!1;if(this.ended)return!1;g=m===~~m?m:m===!0?a.Z_FINISH:a.Z_NO_FLUSH,typeof f=="string"?B.input=r.binstring2buf(f):y.call(f)==="[object ArrayBuffer]"?B.input=new Uint8Array(f):B.input=f,B.next_in=0,B.avail_in=B.input.length;do{if(B.avail_out===0&&(B.output=new n.Buf8(A),B.next_out=0,B.avail_out=A),(x=s.inflate(B,a.Z_NO_FLUSH))===a.Z_NEED_DICT&&M&&(C=typeof M=="string"?r.string2buf(M):y.call(M)==="[object ArrayBuffer]"?new Uint8Array(M):M,x=s.inflateSetDictionary(this.strm,C)),x===a.Z_BUF_ERROR&&S===!0&&(x=a.Z_OK,S=!1),x!==a.Z_STREAM_END&&x!==a.Z_OK)return this.onEnd(x),!(this.ended=!0);B.next_out&&(B.avail_out!==0&&x!==a.Z_STREAM_END&&(B.avail_in!==0||g!==a.Z_FINISH&&g!==a.Z_SYNC_FLUSH)||(this.options.to==="string"?(b=r.utf8border(B.output,B.next_out),z=B.next_out-b,v=r.buf2string(B.output,b),B.next_out=z,B.avail_out=A-z,z&&n.arraySet(B.output,B.output,b,z,0),this.onData(v)):this.onData(n.shrinkBuf(B.output,B.next_out)))),B.avail_in===0&&B.avail_out===0&&(S=!0)}while((0<B.avail_in||B.avail_out===0)&&x!==a.Z_STREAM_END);return x===a.Z_STREAM_END&&(g=a.Z_FINISH),g===a.Z_FINISH?(x=s.inflateEnd(this.strm),this.onEnd(x),this.ended=!0,x===a.Z_OK):g!==a.Z_SYNC_FLUSH||(this.onEnd(a.Z_OK),!(B.avail_out=0))},c.prototype.onData=function(f){this.chunks.push(f)},c.prototype.onEnd=function(f){f===a.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg},i.Inflate=c,i.inflate=d,i.inflateRaw=function(f,m){return(m=m||{}).raw=!0,d(f,m)},i.ungzip=d},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,o,i){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";i.assign=function(a){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var p=l.shift();if(p){if(typeof p!="object")throw new TypeError(p+"must be non-object");for(var h in p)p.hasOwnProperty(h)&&(a[h]=p[h])}}return a},i.shrinkBuf=function(a,l){return a.length===l?a:a.subarray?a.subarray(0,l):(a.length=l,a)};var n={arraySet:function(a,l,p,h,y){if(l.subarray&&a.subarray)a.set(l.subarray(p,p+h),y);else for(var c=0;c<h;c++)a[y+c]=l[p+c]},flattenChunks:function(a){var l,p,h,y,c,d;for(l=h=0,p=a.length;l<p;l++)h+=a[l].length;for(d=new Uint8Array(h),l=y=0,p=a.length;l<p;l++)c=a[l],d.set(c,y),y+=c.length;return d}},r={arraySet:function(a,l,p,h,y){for(var c=0;c<h;c++)a[y+c]=l[p+c]},flattenChunks:function(a){return[].concat.apply([],a)}};i.setTyped=function(a){a?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,n)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,r))},i.setTyped(s)},{}],42:[function(e,o,i){var s=e("./common"),n=!0,r=!0;try{String.fromCharCode.apply(null,[0])}catch{n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{r=!1}for(var a=new s.Buf8(256),l=0;l<256;l++)a[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function p(h,y){if(y<65537&&(h.subarray&&r||!h.subarray&&n))return String.fromCharCode.apply(null,s.shrinkBuf(h,y));for(var c="",d=0;d<y;d++)c+=String.fromCharCode(h[d]);return c}a[254]=a[254]=1,i.string2buf=function(h){var y,c,d,f,m,x=h.length,g=0;for(f=0;f<x;f++)(64512&(c=h.charCodeAt(f)))==55296&&f+1<x&&(64512&(d=h.charCodeAt(f+1)))==56320&&(c=65536+(c-55296<<10)+(d-56320),f++),g+=c<128?1:c<2048?2:c<65536?3:4;for(y=new s.Buf8(g),f=m=0;m<g;f++)(64512&(c=h.charCodeAt(f)))==55296&&f+1<x&&(64512&(d=h.charCodeAt(f+1)))==56320&&(c=65536+(c-55296<<10)+(d-56320),f++),c<128?y[m++]=c:(c<2048?y[m++]=192|c>>>6:(c<65536?y[m++]=224|c>>>12:(y[m++]=240|c>>>18,y[m++]=128|c>>>12&63),y[m++]=128|c>>>6&63),y[m++]=128|63&c);return y},i.buf2binstring=function(h){return p(h,h.length)},i.binstring2buf=function(h){for(var y=new s.Buf8(h.length),c=0,d=y.length;c<d;c++)y[c]=h.charCodeAt(c);return y},i.buf2string=function(h,y){var c,d,f,m,x=y||h.length,g=new Array(2*x);for(c=d=0;c<x;)if((f=h[c++])<128)g[d++]=f;else if(4<(m=a[f]))g[d++]=65533,c+=m-1;else{for(f&=m===2?31:m===3?15:7;1<m&&c<x;)f=f<<6|63&h[c++],m--;1<m?g[d++]=65533:f<65536?g[d++]=f:(f-=65536,g[d++]=55296|f>>10&1023,g[d++]=56320|1023&f)}return p(g,d)},i.utf8border=function(h,y){var c;for((y=y||h.length)>h.length&&(y=h.length),c=y-1;0<=c&&(192&h[c])==128;)c--;return c<0||c===0?y:c+a[h[c]]>y?c:y}},{"./common":41}],43:[function(e,o,i){o.exports=function(s,n,r,a){for(var l=65535&s|0,p=s>>>16&65535|0,h=0;r!==0;){for(r-=h=2e3<r?2e3:r;p=p+(l=l+n[a++]|0)|0,--h;);l%=65521,p%=65521}return l|p<<16|0}},{}],44:[function(e,o,i){o.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,o,i){var s=(function(){for(var n,r=[],a=0;a<256;a++){n=a;for(var l=0;l<8;l++)n=1&n?3988292384^n>>>1:n>>>1;r[a]=n}return r})();o.exports=function(n,r,a,l){var p=s,h=l+a;n^=-1;for(var y=l;y<h;y++)n=n>>>8^p[255&(n^r[y])];return-1^n}},{}],46:[function(e,o,i){var s,n=e("../utils/common"),r=e("./trees"),a=e("./adler32"),l=e("./crc32"),p=e("./messages"),h=0,y=4,c=0,d=-2,f=-1,m=4,x=2,g=8,b=9,z=286,v=30,C=19,B=2*z+1,A=15,M=3,S=258,P=S+M+1,k=42,D=113,F=1,T=2,K=3,G=4;function rt(w,Y){return w.msg=p[Y],Y}function $(w){return(w<<1)-(4<w?9:0)}function et(w){for(var Y=w.length;0<=--Y;)w[Y]=0}function j(w){var Y=w.state,Z=Y.pending;Z>w.avail_out&&(Z=w.avail_out),Z!==0&&(n.arraySet(w.output,Y.pending_buf,Y.pending_out,Z,w.next_out),w.next_out+=Z,Y.pending_out+=Z,w.total_out+=Z,w.avail_out-=Z,Y.pending-=Z,Y.pending===0&&(Y.pending_out=0))}function O(w,Y){r._tr_flush_block(w,0<=w.block_start?w.block_start:-1,w.strstart-w.block_start,Y),w.block_start=w.strstart,j(w.strm)}function tt(w,Y){w.pending_buf[w.pending++]=Y}function Q(w,Y){w.pending_buf[w.pending++]=Y>>>8&255,w.pending_buf[w.pending++]=255&Y}function W(w,Y){var Z,_,E=w.max_chain_length,I=w.strstart,V=w.prev_length,H=w.nice_match,U=w.strstart>w.w_size-P?w.strstart-(w.w_size-P):0,q=w.window,R=w.w_mask,N=w.prev,it=w.strstart+S,dt=q[I+V-1],ct=q[I+V];w.prev_length>=w.good_match&&(E>>=2),H>w.lookahead&&(H=w.lookahead);do if(q[(Z=Y)+V]===ct&&q[Z+V-1]===dt&&q[Z]===q[I]&&q[++Z]===q[I+1]){I+=2,Z++;do;while(q[++I]===q[++Z]&&q[++I]===q[++Z]&&q[++I]===q[++Z]&&q[++I]===q[++Z]&&q[++I]===q[++Z]&&q[++I]===q[++Z]&&q[++I]===q[++Z]&&q[++I]===q[++Z]&&I<it);if(_=S-(it-I),I=it-S,V<_){if(w.match_start=Y,H<=(V=_))break;dt=q[I+V-1],ct=q[I+V]}}while((Y=N[Y&R])>U&&--E!=0);return V<=w.lookahead?V:w.lookahead}function ut(w){var Y,Z,_,E,I,V,H,U,q,R,N=w.w_size;do{if(E=w.window_size-w.lookahead-w.strstart,w.strstart>=N+(N-P)){for(n.arraySet(w.window,w.window,N,N,0),w.match_start-=N,w.strstart-=N,w.block_start-=N,Y=Z=w.hash_size;_=w.head[--Y],w.head[Y]=N<=_?_-N:0,--Z;);for(Y=Z=N;_=w.prev[--Y],w.prev[Y]=N<=_?_-N:0,--Z;);E+=N}if(w.strm.avail_in===0)break;if(V=w.strm,H=w.window,U=w.strstart+w.lookahead,q=E,R=void 0,R=V.avail_in,q<R&&(R=q),Z=R===0?0:(V.avail_in-=R,n.arraySet(H,V.input,V.next_in,R,U),V.state.wrap===1?V.adler=a(V.adler,H,R,U):V.state.wrap===2&&(V.adler=l(V.adler,H,R,U)),V.next_in+=R,V.total_in+=R,R),w.lookahead+=Z,w.lookahead+w.insert>=M)for(I=w.strstart-w.insert,w.ins_h=w.window[I],w.ins_h=(w.ins_h<<w.hash_shift^w.window[I+1])&w.hash_mask;w.insert&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[I+M-1])&w.hash_mask,w.prev[I&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=I,I++,w.insert--,!(w.lookahead+w.insert<M)););}while(w.lookahead<P&&w.strm.avail_in!==0)}function Bt(w,Y){for(var Z,_;;){if(w.lookahead<P){if(ut(w),w.lookahead<P&&Y===h)return F;if(w.lookahead===0)break}if(Z=0,w.lookahead>=M&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,Z=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),Z!==0&&w.strstart-Z<=w.w_size-P&&(w.match_length=W(w,Z)),w.match_length>=M)if(_=r._tr_tally(w,w.strstart-w.match_start,w.match_length-M),w.lookahead-=w.match_length,w.match_length<=w.max_lazy_match&&w.lookahead>=M){for(w.match_length--;w.strstart++,w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,Z=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart,--w.match_length!=0;);w.strstart++}else w.strstart+=w.match_length,w.match_length=0,w.ins_h=w.window[w.strstart],w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+1])&w.hash_mask;else _=r._tr_tally(w,0,w.window[w.strstart]),w.lookahead--,w.strstart++;if(_&&(O(w,!1),w.strm.avail_out===0))return F}return w.insert=w.strstart<M-1?w.strstart:M-1,Y===y?(O(w,!0),w.strm.avail_out===0?K:G):w.last_lit&&(O(w,!1),w.strm.avail_out===0)?F:T}function lt(w,Y){for(var Z,_,E;;){if(w.lookahead<P){if(ut(w),w.lookahead<P&&Y===h)return F;if(w.lookahead===0)break}if(Z=0,w.lookahead>=M&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,Z=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),w.prev_length=w.match_length,w.prev_match=w.match_start,w.match_length=M-1,Z!==0&&w.prev_length<w.max_lazy_match&&w.strstart-Z<=w.w_size-P&&(w.match_length=W(w,Z),w.match_length<=5&&(w.strategy===1||w.match_length===M&&4096<w.strstart-w.match_start)&&(w.match_length=M-1)),w.prev_length>=M&&w.match_length<=w.prev_length){for(E=w.strstart+w.lookahead-M,_=r._tr_tally(w,w.strstart-1-w.prev_match,w.prev_length-M),w.lookahead-=w.prev_length-1,w.prev_length-=2;++w.strstart<=E&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,Z=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),--w.prev_length!=0;);if(w.match_available=0,w.match_length=M-1,w.strstart++,_&&(O(w,!1),w.strm.avail_out===0))return F}else if(w.match_available){if((_=r._tr_tally(w,0,w.window[w.strstart-1]))&&O(w,!1),w.strstart++,w.lookahead--,w.strm.avail_out===0)return F}else w.match_available=1,w.strstart++,w.lookahead--}return w.match_available&&(_=r._tr_tally(w,0,w.window[w.strstart-1]),w.match_available=0),w.insert=w.strstart<M-1?w.strstart:M-1,Y===y?(O(w,!0),w.strm.avail_out===0?K:G):w.last_lit&&(O(w,!1),w.strm.avail_out===0)?F:T}function ht(w,Y,Z,_,E){this.good_length=w,this.max_lazy=Y,this.nice_length=Z,this.max_chain=_,this.func=E}function gt(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=g,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*B),this.dyn_dtree=new n.Buf16(2*(2*v+1)),this.bl_tree=new n.Buf16(2*(2*C+1)),et(this.dyn_ltree),et(this.dyn_dtree),et(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(A+1),this.heap=new n.Buf16(2*z+1),et(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*z+1),et(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function mt(w){var Y;return w&&w.state?(w.total_in=w.total_out=0,w.data_type=x,(Y=w.state).pending=0,Y.pending_out=0,Y.wrap<0&&(Y.wrap=-Y.wrap),Y.status=Y.wrap?k:D,w.adler=Y.wrap===2?0:1,Y.last_flush=h,r._tr_init(Y),c):rt(w,d)}function Pt(w){var Y=mt(w);return Y===c&&(function(Z){Z.window_size=2*Z.w_size,et(Z.head),Z.max_lazy_match=s[Z.level].max_lazy,Z.good_match=s[Z.level].good_length,Z.nice_match=s[Z.level].nice_length,Z.max_chain_length=s[Z.level].max_chain,Z.strstart=0,Z.block_start=0,Z.lookahead=0,Z.insert=0,Z.match_length=Z.prev_length=M-1,Z.match_available=0,Z.ins_h=0})(w.state),Y}function bt(w,Y,Z,_,E,I){if(!w)return d;var V=1;if(Y===f&&(Y=6),_<0?(V=0,_=-_):15<_&&(V=2,_-=16),E<1||b<E||Z!==g||_<8||15<_||Y<0||9<Y||I<0||m<I)return rt(w,d);_===8&&(_=9);var H=new gt;return(w.state=H).strm=w,H.wrap=V,H.gzhead=null,H.w_bits=_,H.w_size=1<<H.w_bits,H.w_mask=H.w_size-1,H.hash_bits=E+7,H.hash_size=1<<H.hash_bits,H.hash_mask=H.hash_size-1,H.hash_shift=~~((H.hash_bits+M-1)/M),H.window=new n.Buf8(2*H.w_size),H.head=new n.Buf16(H.hash_size),H.prev=new n.Buf16(H.w_size),H.lit_bufsize=1<<E+6,H.pending_buf_size=4*H.lit_bufsize,H.pending_buf=new n.Buf8(H.pending_buf_size),H.d_buf=1*H.lit_bufsize,H.l_buf=3*H.lit_bufsize,H.level=Y,H.strategy=I,H.method=Z,Pt(w)}s=[new ht(0,0,0,0,function(w,Y){var Z=65535;for(Z>w.pending_buf_size-5&&(Z=w.pending_buf_size-5);;){if(w.lookahead<=1){if(ut(w),w.lookahead===0&&Y===h)return F;if(w.lookahead===0)break}w.strstart+=w.lookahead,w.lookahead=0;var _=w.block_start+Z;if((w.strstart===0||w.strstart>=_)&&(w.lookahead=w.strstart-_,w.strstart=_,O(w,!1),w.strm.avail_out===0)||w.strstart-w.block_start>=w.w_size-P&&(O(w,!1),w.strm.avail_out===0))return F}return w.insert=0,Y===y?(O(w,!0),w.strm.avail_out===0?K:G):(w.strstart>w.block_start&&(O(w,!1),w.strm.avail_out),F)}),new ht(4,4,8,4,Bt),new ht(4,5,16,8,Bt),new ht(4,6,32,32,Bt),new ht(4,4,16,16,lt),new ht(8,16,32,32,lt),new ht(8,16,128,128,lt),new ht(8,32,128,256,lt),new ht(32,128,258,1024,lt),new ht(32,258,258,4096,lt)],i.deflateInit=function(w,Y){return bt(w,Y,g,15,8,0)},i.deflateInit2=bt,i.deflateReset=Pt,i.deflateResetKeep=mt,i.deflateSetHeader=function(w,Y){return w&&w.state?w.state.wrap!==2?d:(w.state.gzhead=Y,c):d},i.deflate=function(w,Y){var Z,_,E,I;if(!w||!w.state||5<Y||Y<0)return w?rt(w,d):d;if(_=w.state,!w.output||!w.input&&w.avail_in!==0||_.status===666&&Y!==y)return rt(w,w.avail_out===0?-5:d);if(_.strm=w,Z=_.last_flush,_.last_flush=Y,_.status===k)if(_.wrap===2)w.adler=0,tt(_,31),tt(_,139),tt(_,8),_.gzhead?(tt(_,(_.gzhead.text?1:0)+(_.gzhead.hcrc?2:0)+(_.gzhead.extra?4:0)+(_.gzhead.name?8:0)+(_.gzhead.comment?16:0)),tt(_,255&_.gzhead.time),tt(_,_.gzhead.time>>8&255),tt(_,_.gzhead.time>>16&255),tt(_,_.gzhead.time>>24&255),tt(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),tt(_,255&_.gzhead.os),_.gzhead.extra&&_.gzhead.extra.length&&(tt(_,255&_.gzhead.extra.length),tt(_,_.gzhead.extra.length>>8&255)),_.gzhead.hcrc&&(w.adler=l(w.adler,_.pending_buf,_.pending,0)),_.gzindex=0,_.status=69):(tt(_,0),tt(_,0),tt(_,0),tt(_,0),tt(_,0),tt(_,_.level===9?2:2<=_.strategy||_.level<2?4:0),tt(_,3),_.status=D);else{var V=g+(_.w_bits-8<<4)<<8;V|=(2<=_.strategy||_.level<2?0:_.level<6?1:_.level===6?2:3)<<6,_.strstart!==0&&(V|=32),V+=31-V%31,_.status=D,Q(_,V),_.strstart!==0&&(Q(_,w.adler>>>16),Q(_,65535&w.adler)),w.adler=1}if(_.status===69)if(_.gzhead.extra){for(E=_.pending;_.gzindex<(65535&_.gzhead.extra.length)&&(_.pending!==_.pending_buf_size||(_.gzhead.hcrc&&_.pending>E&&(w.adler=l(w.adler,_.pending_buf,_.pending-E,E)),j(w),E=_.pending,_.pending!==_.pending_buf_size));)tt(_,255&_.gzhead.extra[_.gzindex]),_.gzindex++;_.gzhead.hcrc&&_.pending>E&&(w.adler=l(w.adler,_.pending_buf,_.pending-E,E)),_.gzindex===_.gzhead.extra.length&&(_.gzindex=0,_.status=73)}else _.status=73;if(_.status===73)if(_.gzhead.name){E=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>E&&(w.adler=l(w.adler,_.pending_buf,_.pending-E,E)),j(w),E=_.pending,_.pending===_.pending_buf_size)){I=1;break}I=_.gzindex<_.gzhead.name.length?255&_.gzhead.name.charCodeAt(_.gzindex++):0,tt(_,I)}while(I!==0);_.gzhead.hcrc&&_.pending>E&&(w.adler=l(w.adler,_.pending_buf,_.pending-E,E)),I===0&&(_.gzindex=0,_.status=91)}else _.status=91;if(_.status===91)if(_.gzhead.comment){E=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>E&&(w.adler=l(w.adler,_.pending_buf,_.pending-E,E)),j(w),E=_.pending,_.pending===_.pending_buf_size)){I=1;break}I=_.gzindex<_.gzhead.comment.length?255&_.gzhead.comment.charCodeAt(_.gzindex++):0,tt(_,I)}while(I!==0);_.gzhead.hcrc&&_.pending>E&&(w.adler=l(w.adler,_.pending_buf,_.pending-E,E)),I===0&&(_.status=103)}else _.status=103;if(_.status===103&&(_.gzhead.hcrc?(_.pending+2>_.pending_buf_size&&j(w),_.pending+2<=_.pending_buf_size&&(tt(_,255&w.adler),tt(_,w.adler>>8&255),w.adler=0,_.status=D)):_.status=D),_.pending!==0){if(j(w),w.avail_out===0)return _.last_flush=-1,c}else if(w.avail_in===0&&$(Y)<=$(Z)&&Y!==y)return rt(w,-5);if(_.status===666&&w.avail_in!==0)return rt(w,-5);if(w.avail_in!==0||_.lookahead!==0||Y!==h&&_.status!==666){var H=_.strategy===2?(function(U,q){for(var R;;){if(U.lookahead===0&&(ut(U),U.lookahead===0)){if(q===h)return F;break}if(U.match_length=0,R=r._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++,R&&(O(U,!1),U.strm.avail_out===0))return F}return U.insert=0,q===y?(O(U,!0),U.strm.avail_out===0?K:G):U.last_lit&&(O(U,!1),U.strm.avail_out===0)?F:T})(_,Y):_.strategy===3?(function(U,q){for(var R,N,it,dt,ct=U.window;;){if(U.lookahead<=S){if(ut(U),U.lookahead<=S&&q===h)return F;if(U.lookahead===0)break}if(U.match_length=0,U.lookahead>=M&&0<U.strstart&&(N=ct[it=U.strstart-1])===ct[++it]&&N===ct[++it]&&N===ct[++it]){dt=U.strstart+S;do;while(N===ct[++it]&&N===ct[++it]&&N===ct[++it]&&N===ct[++it]&&N===ct[++it]&&N===ct[++it]&&N===ct[++it]&&N===ct[++it]&&it<dt);U.match_length=S-(dt-it),U.match_length>U.lookahead&&(U.match_length=U.lookahead)}if(U.match_length>=M?(R=r._tr_tally(U,1,U.match_length-M),U.lookahead-=U.match_length,U.strstart+=U.match_length,U.match_length=0):(R=r._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++),R&&(O(U,!1),U.strm.avail_out===0))return F}return U.insert=0,q===y?(O(U,!0),U.strm.avail_out===0?K:G):U.last_lit&&(O(U,!1),U.strm.avail_out===0)?F:T})(_,Y):s[_.level].func(_,Y);if(H!==K&&H!==G||(_.status=666),H===F||H===K)return w.avail_out===0&&(_.last_flush=-1),c;if(H===T&&(Y===1?r._tr_align(_):Y!==5&&(r._tr_stored_block(_,0,0,!1),Y===3&&(et(_.head),_.lookahead===0&&(_.strstart=0,_.block_start=0,_.insert=0))),j(w),w.avail_out===0))return _.last_flush=-1,c}return Y!==y?c:_.wrap<=0?1:(_.wrap===2?(tt(_,255&w.adler),tt(_,w.adler>>8&255),tt(_,w.adler>>16&255),tt(_,w.adler>>24&255),tt(_,255&w.total_in),tt(_,w.total_in>>8&255),tt(_,w.total_in>>16&255),tt(_,w.total_in>>24&255)):(Q(_,w.adler>>>16),Q(_,65535&w.adler)),j(w),0<_.wrap&&(_.wrap=-_.wrap),_.pending!==0?c:1)},i.deflateEnd=function(w){var Y;return w&&w.state?(Y=w.state.status)!==k&&Y!==69&&Y!==73&&Y!==91&&Y!==103&&Y!==D&&Y!==666?rt(w,d):(w.state=null,Y===D?rt(w,-3):c):d},i.deflateSetDictionary=function(w,Y){var Z,_,E,I,V,H,U,q,R=Y.length;if(!w||!w.state||(I=(Z=w.state).wrap)===2||I===1&&Z.status!==k||Z.lookahead)return d;for(I===1&&(w.adler=a(w.adler,Y,R,0)),Z.wrap=0,R>=Z.w_size&&(I===0&&(et(Z.head),Z.strstart=0,Z.block_start=0,Z.insert=0),q=new n.Buf8(Z.w_size),n.arraySet(q,Y,R-Z.w_size,Z.w_size,0),Y=q,R=Z.w_size),V=w.avail_in,H=w.next_in,U=w.input,w.avail_in=R,w.next_in=0,w.input=Y,ut(Z);Z.lookahead>=M;){for(_=Z.strstart,E=Z.lookahead-(M-1);Z.ins_h=(Z.ins_h<<Z.hash_shift^Z.window[_+M-1])&Z.hash_mask,Z.prev[_&Z.w_mask]=Z.head[Z.ins_h],Z.head[Z.ins_h]=_,_++,--E;);Z.strstart=_,Z.lookahead=M-1,ut(Z)}return Z.strstart+=Z.lookahead,Z.block_start=Z.strstart,Z.insert=Z.lookahead,Z.lookahead=0,Z.match_length=Z.prev_length=M-1,Z.match_available=0,w.next_in=H,w.input=U,w.avail_in=V,Z.wrap=I,c},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,o,i){o.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,o,i){o.exports=function(s,n){var r,a,l,p,h,y,c,d,f,m,x,g,b,z,v,C,B,A,M,S,P,k,D,F,T;r=s.state,a=s.next_in,F=s.input,l=a+(s.avail_in-5),p=s.next_out,T=s.output,h=p-(n-s.avail_out),y=p+(s.avail_out-257),c=r.dmax,d=r.wsize,f=r.whave,m=r.wnext,x=r.window,g=r.hold,b=r.bits,z=r.lencode,v=r.distcode,C=(1<<r.lenbits)-1,B=(1<<r.distbits)-1;t:do{b<15&&(g+=F[a++]<<b,b+=8,g+=F[a++]<<b,b+=8),A=z[g&C];e:for(;;){if(g>>>=M=A>>>24,b-=M,(M=A>>>16&255)===0)T[p++]=65535&A;else{if(!(16&M)){if((64&M)==0){A=z[(65535&A)+(g&(1<<M)-1)];continue e}if(32&M){r.mode=12;break t}s.msg="invalid literal/length code",r.mode=30;break t}S=65535&A,(M&=15)&&(b<M&&(g+=F[a++]<<b,b+=8),S+=g&(1<<M)-1,g>>>=M,b-=M),b<15&&(g+=F[a++]<<b,b+=8,g+=F[a++]<<b,b+=8),A=v[g&B];o:for(;;){if(g>>>=M=A>>>24,b-=M,!(16&(M=A>>>16&255))){if((64&M)==0){A=v[(65535&A)+(g&(1<<M)-1)];continue o}s.msg="invalid distance code",r.mode=30;break t}if(P=65535&A,b<(M&=15)&&(g+=F[a++]<<b,(b+=8)<M&&(g+=F[a++]<<b,b+=8)),c<(P+=g&(1<<M)-1)){s.msg="invalid distance too far back",r.mode=30;break t}if(g>>>=M,b-=M,(M=p-h)<P){if(f<(M=P-M)&&r.sane){s.msg="invalid distance too far back",r.mode=30;break t}if(D=x,(k=0)===m){if(k+=d-M,M<S){for(S-=M;T[p++]=x[k++],--M;);k=p-P,D=T}}else if(m<M){if(k+=d+m-M,(M-=m)<S){for(S-=M;T[p++]=x[k++],--M;);if(k=0,m<S){for(S-=M=m;T[p++]=x[k++],--M;);k=p-P,D=T}}}else if(k+=m-M,M<S){for(S-=M;T[p++]=x[k++],--M;);k=p-P,D=T}for(;2<S;)T[p++]=D[k++],T[p++]=D[k++],T[p++]=D[k++],S-=3;S&&(T[p++]=D[k++],1<S&&(T[p++]=D[k++]))}else{for(k=p-P;T[p++]=T[k++],T[p++]=T[k++],T[p++]=T[k++],2<(S-=3););S&&(T[p++]=T[k++],1<S&&(T[p++]=T[k++]))}break}}break}}while(a<l&&p<y);a-=S=b>>3,g&=(1<<(b-=S<<3))-1,s.next_in=a,s.next_out=p,s.avail_in=a<l?l-a+5:5-(a-l),s.avail_out=p<y?y-p+257:257-(p-y),r.hold=g,r.bits=b}},{}],49:[function(e,o,i){var s=e("../utils/common"),n=e("./adler32"),r=e("./crc32"),a=e("./inffast"),l=e("./inftrees"),p=1,h=2,y=0,c=-2,d=1,f=852,m=592;function x(k){return(k>>>24&255)+(k>>>8&65280)+((65280&k)<<8)+((255&k)<<24)}function g(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function b(k){var D;return k&&k.state?(D=k.state,k.total_in=k.total_out=D.total=0,k.msg="",D.wrap&&(k.adler=1&D.wrap),D.mode=d,D.last=0,D.havedict=0,D.dmax=32768,D.head=null,D.hold=0,D.bits=0,D.lencode=D.lendyn=new s.Buf32(f),D.distcode=D.distdyn=new s.Buf32(m),D.sane=1,D.back=-1,y):c}function z(k){var D;return k&&k.state?((D=k.state).wsize=0,D.whave=0,D.wnext=0,b(k)):c}function v(k,D){var F,T;return k&&k.state?(T=k.state,D<0?(F=0,D=-D):(F=1+(D>>4),D<48&&(D&=15)),D&&(D<8||15<D)?c:(T.window!==null&&T.wbits!==D&&(T.window=null),T.wrap=F,T.wbits=D,z(k))):c}function C(k,D){var F,T;return k?(T=new g,(k.state=T).window=null,(F=v(k,D))!==y&&(k.state=null),F):c}var B,A,M=!0;function S(k){if(M){var D;for(B=new s.Buf32(512),A=new s.Buf32(32),D=0;D<144;)k.lens[D++]=8;for(;D<256;)k.lens[D++]=9;for(;D<280;)k.lens[D++]=7;for(;D<288;)k.lens[D++]=8;for(l(p,k.lens,0,288,B,0,k.work,{bits:9}),D=0;D<32;)k.lens[D++]=5;l(h,k.lens,0,32,A,0,k.work,{bits:5}),M=!1}k.lencode=B,k.lenbits=9,k.distcode=A,k.distbits=5}function P(k,D,F,T){var K,G=k.state;return G.window===null&&(G.wsize=1<<G.wbits,G.wnext=0,G.whave=0,G.window=new s.Buf8(G.wsize)),T>=G.wsize?(s.arraySet(G.window,D,F-G.wsize,G.wsize,0),G.wnext=0,G.whave=G.wsize):(T<(K=G.wsize-G.wnext)&&(K=T),s.arraySet(G.window,D,F-T,K,G.wnext),(T-=K)?(s.arraySet(G.window,D,F-T,T,0),G.wnext=T,G.whave=G.wsize):(G.wnext+=K,G.wnext===G.wsize&&(G.wnext=0),G.whave<G.wsize&&(G.whave+=K))),0}i.inflateReset=z,i.inflateReset2=v,i.inflateResetKeep=b,i.inflateInit=function(k){return C(k,15)},i.inflateInit2=C,i.inflate=function(k,D){var F,T,K,G,rt,$,et,j,O,tt,Q,W,ut,Bt,lt,ht,gt,mt,Pt,bt,w,Y,Z,_,E=0,I=new s.Buf8(4),V=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!k||!k.state||!k.output||!k.input&&k.avail_in!==0)return c;(F=k.state).mode===12&&(F.mode=13),rt=k.next_out,K=k.output,et=k.avail_out,G=k.next_in,T=k.input,$=k.avail_in,j=F.hold,O=F.bits,tt=$,Q=et,Y=y;t:for(;;)switch(F.mode){case d:if(F.wrap===0){F.mode=13;break}for(;O<16;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if(2&F.wrap&&j===35615){I[F.check=0]=255&j,I[1]=j>>>8&255,F.check=r(F.check,I,2,0),O=j=0,F.mode=2;break}if(F.flags=0,F.head&&(F.head.done=!1),!(1&F.wrap)||(((255&j)<<8)+(j>>8))%31){k.msg="incorrect header check",F.mode=30;break}if((15&j)!=8){k.msg="unknown compression method",F.mode=30;break}if(O-=4,w=8+(15&(j>>>=4)),F.wbits===0)F.wbits=w;else if(w>F.wbits){k.msg="invalid window size",F.mode=30;break}F.dmax=1<<w,k.adler=F.check=1,F.mode=512&j?10:12,O=j=0;break;case 2:for(;O<16;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if(F.flags=j,(255&F.flags)!=8){k.msg="unknown compression method",F.mode=30;break}if(57344&F.flags){k.msg="unknown header flags set",F.mode=30;break}F.head&&(F.head.text=j>>8&1),512&F.flags&&(I[0]=255&j,I[1]=j>>>8&255,F.check=r(F.check,I,2,0)),O=j=0,F.mode=3;case 3:for(;O<32;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}F.head&&(F.head.time=j),512&F.flags&&(I[0]=255&j,I[1]=j>>>8&255,I[2]=j>>>16&255,I[3]=j>>>24&255,F.check=r(F.check,I,4,0)),O=j=0,F.mode=4;case 4:for(;O<16;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}F.head&&(F.head.xflags=255&j,F.head.os=j>>8),512&F.flags&&(I[0]=255&j,I[1]=j>>>8&255,F.check=r(F.check,I,2,0)),O=j=0,F.mode=5;case 5:if(1024&F.flags){for(;O<16;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}F.length=j,F.head&&(F.head.extra_len=j),512&F.flags&&(I[0]=255&j,I[1]=j>>>8&255,F.check=r(F.check,I,2,0)),O=j=0}else F.head&&(F.head.extra=null);F.mode=6;case 6:if(1024&F.flags&&($<(W=F.length)&&(W=$),W&&(F.head&&(w=F.head.extra_len-F.length,F.head.extra||(F.head.extra=new Array(F.head.extra_len)),s.arraySet(F.head.extra,T,G,W,w)),512&F.flags&&(F.check=r(F.check,T,W,G)),$-=W,G+=W,F.length-=W),F.length))break t;F.length=0,F.mode=7;case 7:if(2048&F.flags){if($===0)break t;for(W=0;w=T[G+W++],F.head&&w&&F.length<65536&&(F.head.name+=String.fromCharCode(w)),w&&W<$;);if(512&F.flags&&(F.check=r(F.check,T,W,G)),$-=W,G+=W,w)break t}else F.head&&(F.head.name=null);F.length=0,F.mode=8;case 8:if(4096&F.flags){if($===0)break t;for(W=0;w=T[G+W++],F.head&&w&&F.length<65536&&(F.head.comment+=String.fromCharCode(w)),w&&W<$;);if(512&F.flags&&(F.check=r(F.check,T,W,G)),$-=W,G+=W,w)break t}else F.head&&(F.head.comment=null);F.mode=9;case 9:if(512&F.flags){for(;O<16;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if(j!==(65535&F.check)){k.msg="header crc mismatch",F.mode=30;break}O=j=0}F.head&&(F.head.hcrc=F.flags>>9&1,F.head.done=!0),k.adler=F.check=0,F.mode=12;break;case 10:for(;O<32;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}k.adler=F.check=x(j),O=j=0,F.mode=11;case 11:if(F.havedict===0)return k.next_out=rt,k.avail_out=et,k.next_in=G,k.avail_in=$,F.hold=j,F.bits=O,2;k.adler=F.check=1,F.mode=12;case 12:if(D===5||D===6)break t;case 13:if(F.last){j>>>=7&O,O-=7&O,F.mode=27;break}for(;O<3;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}switch(F.last=1&j,O-=1,3&(j>>>=1)){case 0:F.mode=14;break;case 1:if(S(F),F.mode=20,D!==6)break;j>>>=2,O-=2;break t;case 2:F.mode=17;break;case 3:k.msg="invalid block type",F.mode=30}j>>>=2,O-=2;break;case 14:for(j>>>=7&O,O-=7&O;O<32;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if((65535&j)!=(j>>>16^65535)){k.msg="invalid stored block lengths",F.mode=30;break}if(F.length=65535&j,O=j=0,F.mode=15,D===6)break t;case 15:F.mode=16;case 16:if(W=F.length){if($<W&&(W=$),et<W&&(W=et),W===0)break t;s.arraySet(K,T,G,W,rt),$-=W,G+=W,et-=W,rt+=W,F.length-=W;break}F.mode=12;break;case 17:for(;O<14;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if(F.nlen=257+(31&j),j>>>=5,O-=5,F.ndist=1+(31&j),j>>>=5,O-=5,F.ncode=4+(15&j),j>>>=4,O-=4,286<F.nlen||30<F.ndist){k.msg="too many length or distance symbols",F.mode=30;break}F.have=0,F.mode=18;case 18:for(;F.have<F.ncode;){for(;O<3;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}F.lens[V[F.have++]]=7&j,j>>>=3,O-=3}for(;F.have<19;)F.lens[V[F.have++]]=0;if(F.lencode=F.lendyn,F.lenbits=7,Z={bits:F.lenbits},Y=l(0,F.lens,0,19,F.lencode,0,F.work,Z),F.lenbits=Z.bits,Y){k.msg="invalid code lengths set",F.mode=30;break}F.have=0,F.mode=19;case 19:for(;F.have<F.nlen+F.ndist;){for(;ht=(E=F.lencode[j&(1<<F.lenbits)-1])>>>16&255,gt=65535&E,!((lt=E>>>24)<=O);){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if(gt<16)j>>>=lt,O-=lt,F.lens[F.have++]=gt;else{if(gt===16){for(_=lt+2;O<_;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if(j>>>=lt,O-=lt,F.have===0){k.msg="invalid bit length repeat",F.mode=30;break}w=F.lens[F.have-1],W=3+(3&j),j>>>=2,O-=2}else if(gt===17){for(_=lt+3;O<_;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}O-=lt,w=0,W=3+(7&(j>>>=lt)),j>>>=3,O-=3}else{for(_=lt+7;O<_;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}O-=lt,w=0,W=11+(127&(j>>>=lt)),j>>>=7,O-=7}if(F.have+W>F.nlen+F.ndist){k.msg="invalid bit length repeat",F.mode=30;break}for(;W--;)F.lens[F.have++]=w}}if(F.mode===30)break;if(F.lens[256]===0){k.msg="invalid code -- missing end-of-block",F.mode=30;break}if(F.lenbits=9,Z={bits:F.lenbits},Y=l(p,F.lens,0,F.nlen,F.lencode,0,F.work,Z),F.lenbits=Z.bits,Y){k.msg="invalid literal/lengths set",F.mode=30;break}if(F.distbits=6,F.distcode=F.distdyn,Z={bits:F.distbits},Y=l(h,F.lens,F.nlen,F.ndist,F.distcode,0,F.work,Z),F.distbits=Z.bits,Y){k.msg="invalid distances set",F.mode=30;break}if(F.mode=20,D===6)break t;case 20:F.mode=21;case 21:if(6<=$&&258<=et){k.next_out=rt,k.avail_out=et,k.next_in=G,k.avail_in=$,F.hold=j,F.bits=O,a(k,Q),rt=k.next_out,K=k.output,et=k.avail_out,G=k.next_in,T=k.input,$=k.avail_in,j=F.hold,O=F.bits,F.mode===12&&(F.back=-1);break}for(F.back=0;ht=(E=F.lencode[j&(1<<F.lenbits)-1])>>>16&255,gt=65535&E,!((lt=E>>>24)<=O);){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if(ht&&(240&ht)==0){for(mt=lt,Pt=ht,bt=gt;ht=(E=F.lencode[bt+((j&(1<<mt+Pt)-1)>>mt)])>>>16&255,gt=65535&E,!(mt+(lt=E>>>24)<=O);){if($===0)break t;$--,j+=T[G++]<<O,O+=8}j>>>=mt,O-=mt,F.back+=mt}if(j>>>=lt,O-=lt,F.back+=lt,F.length=gt,ht===0){F.mode=26;break}if(32&ht){F.back=-1,F.mode=12;break}if(64&ht){k.msg="invalid literal/length code",F.mode=30;break}F.extra=15&ht,F.mode=22;case 22:if(F.extra){for(_=F.extra;O<_;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}F.length+=j&(1<<F.extra)-1,j>>>=F.extra,O-=F.extra,F.back+=F.extra}F.was=F.length,F.mode=23;case 23:for(;ht=(E=F.distcode[j&(1<<F.distbits)-1])>>>16&255,gt=65535&E,!((lt=E>>>24)<=O);){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if((240&ht)==0){for(mt=lt,Pt=ht,bt=gt;ht=(E=F.distcode[bt+((j&(1<<mt+Pt)-1)>>mt)])>>>16&255,gt=65535&E,!(mt+(lt=E>>>24)<=O);){if($===0)break t;$--,j+=T[G++]<<O,O+=8}j>>>=mt,O-=mt,F.back+=mt}if(j>>>=lt,O-=lt,F.back+=lt,64&ht){k.msg="invalid distance code",F.mode=30;break}F.offset=gt,F.extra=15&ht,F.mode=24;case 24:if(F.extra){for(_=F.extra;O<_;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}F.offset+=j&(1<<F.extra)-1,j>>>=F.extra,O-=F.extra,F.back+=F.extra}if(F.offset>F.dmax){k.msg="invalid distance too far back",F.mode=30;break}F.mode=25;case 25:if(et===0)break t;if(W=Q-et,F.offset>W){if((W=F.offset-W)>F.whave&&F.sane){k.msg="invalid distance too far back",F.mode=30;break}ut=W>F.wnext?(W-=F.wnext,F.wsize-W):F.wnext-W,W>F.length&&(W=F.length),Bt=F.window}else Bt=K,ut=rt-F.offset,W=F.length;for(et<W&&(W=et),et-=W,F.length-=W;K[rt++]=Bt[ut++],--W;);F.length===0&&(F.mode=21);break;case 26:if(et===0)break t;K[rt++]=F.length,et--,F.mode=21;break;case 27:if(F.wrap){for(;O<32;){if($===0)break t;$--,j|=T[G++]<<O,O+=8}if(Q-=et,k.total_out+=Q,F.total+=Q,Q&&(k.adler=F.check=F.flags?r(F.check,K,Q,rt-Q):n(F.check,K,Q,rt-Q)),Q=et,(F.flags?j:x(j))!==F.check){k.msg="incorrect data check",F.mode=30;break}O=j=0}F.mode=28;case 28:if(F.wrap&&F.flags){for(;O<32;){if($===0)break t;$--,j+=T[G++]<<O,O+=8}if(j!==(4294967295&F.total)){k.msg="incorrect length check",F.mode=30;break}O=j=0}F.mode=29;case 29:Y=1;break t;case 30:Y=-3;break t;case 31:return-4;case 32:default:return c}return k.next_out=rt,k.avail_out=et,k.next_in=G,k.avail_in=$,F.hold=j,F.bits=O,(F.wsize||Q!==k.avail_out&&F.mode<30&&(F.mode<27||D!==4))&&P(k,k.output,k.next_out,Q-k.avail_out)?(F.mode=31,-4):(tt-=k.avail_in,Q-=k.avail_out,k.total_in+=tt,k.total_out+=Q,F.total+=Q,F.wrap&&Q&&(k.adler=F.check=F.flags?r(F.check,K,Q,k.next_out-Q):n(F.check,K,Q,k.next_out-Q)),k.data_type=F.bits+(F.last?64:0)+(F.mode===12?128:0)+(F.mode===20||F.mode===15?256:0),(tt==0&&Q===0||D===4)&&Y===y&&(Y=-5),Y)},i.inflateEnd=function(k){if(!k||!k.state)return c;var D=k.state;return D.window&&(D.window=null),k.state=null,y},i.inflateGetHeader=function(k,D){var F;return k&&k.state?(2&(F=k.state).wrap)==0?c:((F.head=D).done=!1,y):c},i.inflateSetDictionary=function(k,D){var F,T=D.length;return k&&k.state?(F=k.state).wrap!==0&&F.mode!==11?c:F.mode===11&&n(1,D,T,0)!==F.check?-3:P(k,D,T,T)?(F.mode=31,-4):(F.havedict=1,y):c},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,o,i){var s=e("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],a=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];o.exports=function(p,h,y,c,d,f,m,x){var g,b,z,v,C,B,A,M,S,P=x.bits,k=0,D=0,F=0,T=0,K=0,G=0,rt=0,$=0,et=0,j=0,O=null,tt=0,Q=new s.Buf16(16),W=new s.Buf16(16),ut=null,Bt=0;for(k=0;k<=15;k++)Q[k]=0;for(D=0;D<c;D++)Q[h[y+D]]++;for(K=P,T=15;1<=T&&Q[T]===0;T--);if(T<K&&(K=T),T===0)return d[f++]=20971520,d[f++]=20971520,x.bits=1,0;for(F=1;F<T&&Q[F]===0;F++);for(K<F&&(K=F),k=$=1;k<=15;k++)if($<<=1,($-=Q[k])<0)return-1;if(0<$&&(p===0||T!==1))return-1;for(W[1]=0,k=1;k<15;k++)W[k+1]=W[k]+Q[k];for(D=0;D<c;D++)h[y+D]!==0&&(m[W[h[y+D]]++]=D);if(B=p===0?(O=ut=m,19):p===1?(O=n,tt-=257,ut=r,Bt-=257,256):(O=a,ut=l,-1),k=F,C=f,rt=D=j=0,z=-1,v=(et=1<<(G=K))-1,p===1&&852<et||p===2&&592<et)return 1;for(;;){for(A=k-rt,S=m[D]<B?(M=0,m[D]):m[D]>B?(M=ut[Bt+m[D]],O[tt+m[D]]):(M=96,0),g=1<<k-rt,F=b=1<<G;d[C+(j>>rt)+(b-=g)]=A<<24|M<<16|S|0,b!==0;);for(g=1<<k-1;j&g;)g>>=1;if(g!==0?(j&=g-1,j+=g):j=0,D++,--Q[k]==0){if(k===T)break;k=h[y+m[D]]}if(K<k&&(j&v)!==z){for(rt===0&&(rt=K),C+=F,$=1<<(G=k-rt);G+rt<T&&!(($-=Q[G+rt])<=0);)G++,$<<=1;if(et+=1<<G,p===1&&852<et||p===2&&592<et)return 1;d[z=j&v]=K<<24|G<<16|C-f|0}}return j!==0&&(d[C+j]=k-rt<<24|64<<16|0),x.bits=K,0}},{"../utils/common":41}],51:[function(e,o,i){o.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,o,i){var s=e("../utils/common"),n=0,r=1;function a(E){for(var I=E.length;0<=--I;)E[I]=0}var l=0,p=29,h=256,y=h+1+p,c=30,d=19,f=2*y+1,m=15,x=16,g=7,b=256,z=16,v=17,C=18,B=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],A=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],M=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],S=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],P=new Array(2*(y+2));a(P);var k=new Array(2*c);a(k);var D=new Array(512);a(D);var F=new Array(256);a(F);var T=new Array(p);a(T);var K,G,rt,$=new Array(c);function et(E,I,V,H,U){this.static_tree=E,this.extra_bits=I,this.extra_base=V,this.elems=H,this.max_length=U,this.has_stree=E&&E.length}function j(E,I){this.dyn_tree=E,this.max_code=0,this.stat_desc=I}function O(E){return E<256?D[E]:D[256+(E>>>7)]}function tt(E,I){E.pending_buf[E.pending++]=255&I,E.pending_buf[E.pending++]=I>>>8&255}function Q(E,I,V){E.bi_valid>x-V?(E.bi_buf|=I<<E.bi_valid&65535,tt(E,E.bi_buf),E.bi_buf=I>>x-E.bi_valid,E.bi_valid+=V-x):(E.bi_buf|=I<<E.bi_valid&65535,E.bi_valid+=V)}function W(E,I,V){Q(E,V[2*I],V[2*I+1])}function ut(E,I){for(var V=0;V|=1&E,E>>>=1,V<<=1,0<--I;);return V>>>1}function Bt(E,I,V){var H,U,q=new Array(m+1),R=0;for(H=1;H<=m;H++)q[H]=R=R+V[H-1]<<1;for(U=0;U<=I;U++){var N=E[2*U+1];N!==0&&(E[2*U]=ut(q[N]++,N))}}function lt(E){var I;for(I=0;I<y;I++)E.dyn_ltree[2*I]=0;for(I=0;I<c;I++)E.dyn_dtree[2*I]=0;for(I=0;I<d;I++)E.bl_tree[2*I]=0;E.dyn_ltree[2*b]=1,E.opt_len=E.static_len=0,E.last_lit=E.matches=0}function ht(E){8<E.bi_valid?tt(E,E.bi_buf):0<E.bi_valid&&(E.pending_buf[E.pending++]=E.bi_buf),E.bi_buf=0,E.bi_valid=0}function gt(E,I,V,H){var U=2*I,q=2*V;return E[U]<E[q]||E[U]===E[q]&&H[I]<=H[V]}function mt(E,I,V){for(var H=E.heap[V],U=V<<1;U<=E.heap_len&&(U<E.heap_len&&gt(I,E.heap[U+1],E.heap[U],E.depth)&&U++,!gt(I,H,E.heap[U],E.depth));)E.heap[V]=E.heap[U],V=U,U<<=1;E.heap[V]=H}function Pt(E,I,V){var H,U,q,R,N=0;if(E.last_lit!==0)for(;H=E.pending_buf[E.d_buf+2*N]<<8|E.pending_buf[E.d_buf+2*N+1],U=E.pending_buf[E.l_buf+N],N++,H===0?W(E,U,I):(W(E,(q=F[U])+h+1,I),(R=B[q])!==0&&Q(E,U-=T[q],R),W(E,q=O(--H),V),(R=A[q])!==0&&Q(E,H-=$[q],R)),N<E.last_lit;);W(E,b,I)}function bt(E,I){var V,H,U,q=I.dyn_tree,R=I.stat_desc.static_tree,N=I.stat_desc.has_stree,it=I.stat_desc.elems,dt=-1;for(E.heap_len=0,E.heap_max=f,V=0;V<it;V++)q[2*V]!==0?(E.heap[++E.heap_len]=dt=V,E.depth[V]=0):q[2*V+1]=0;for(;E.heap_len<2;)q[2*(U=E.heap[++E.heap_len]=dt<2?++dt:0)]=1,E.depth[U]=0,E.opt_len--,N&&(E.static_len-=R[2*U+1]);for(I.max_code=dt,V=E.heap_len>>1;1<=V;V--)mt(E,q,V);for(U=it;V=E.heap[1],E.heap[1]=E.heap[E.heap_len--],mt(E,q,1),H=E.heap[1],E.heap[--E.heap_max]=V,E.heap[--E.heap_max]=H,q[2*U]=q[2*V]+q[2*H],E.depth[U]=(E.depth[V]>=E.depth[H]?E.depth[V]:E.depth[H])+1,q[2*V+1]=q[2*H+1]=U,E.heap[1]=U++,mt(E,q,1),2<=E.heap_len;);E.heap[--E.heap_max]=E.heap[1],(function(ct,Vt){var ro,re,ao,Ft,Co,Fi,he=Vt.dyn_tree,Cs=Vt.max_code,mr=Vt.stat_desc.static_tree,xr=Vt.stat_desc.has_stree,gr=Vt.stat_desc.extra_bits,As=Vt.stat_desc.extra_base,lo=Vt.stat_desc.max_length,Ao=0;for(Ft=0;Ft<=m;Ft++)ct.bl_count[Ft]=0;for(he[2*ct.heap[ct.heap_max]+1]=0,ro=ct.heap_max+1;ro<f;ro++)lo<(Ft=he[2*he[2*(re=ct.heap[ro])+1]+1]+1)&&(Ft=lo,Ao++),he[2*re+1]=Ft,Cs<re||(ct.bl_count[Ft]++,Co=0,As<=re&&(Co=gr[re-As]),Fi=he[2*re],ct.opt_len+=Fi*(Ft+Co),xr&&(ct.static_len+=Fi*(mr[2*re+1]+Co)));if(Ao!==0){do{for(Ft=lo-1;ct.bl_count[Ft]===0;)Ft--;ct.bl_count[Ft]--,ct.bl_count[Ft+1]+=2,ct.bl_count[lo]--,Ao-=2}while(0<Ao);for(Ft=lo;Ft!==0;Ft--)for(re=ct.bl_count[Ft];re!==0;)Cs<(ao=ct.heap[--ro])||(he[2*ao+1]!==Ft&&(ct.opt_len+=(Ft-he[2*ao+1])*he[2*ao],he[2*ao+1]=Ft),re--)}})(E,I),Bt(q,dt,E.bl_count)}function w(E,I,V){var H,U,q=-1,R=I[1],N=0,it=7,dt=4;for(R===0&&(it=138,dt=3),I[2*(V+1)+1]=65535,H=0;H<=V;H++)U=R,R=I[2*(H+1)+1],++N<it&&U===R||(N<dt?E.bl_tree[2*U]+=N:U!==0?(U!==q&&E.bl_tree[2*U]++,E.bl_tree[2*z]++):N<=10?E.bl_tree[2*v]++:E.bl_tree[2*C]++,q=U,dt=(N=0)===R?(it=138,3):U===R?(it=6,3):(it=7,4))}function Y(E,I,V){var H,U,q=-1,R=I[1],N=0,it=7,dt=4;for(R===0&&(it=138,dt=3),H=0;H<=V;H++)if(U=R,R=I[2*(H+1)+1],!(++N<it&&U===R)){if(N<dt)for(;W(E,U,E.bl_tree),--N!=0;);else U!==0?(U!==q&&(W(E,U,E.bl_tree),N--),W(E,z,E.bl_tree),Q(E,N-3,2)):N<=10?(W(E,v,E.bl_tree),Q(E,N-3,3)):(W(E,C,E.bl_tree),Q(E,N-11,7));q=U,dt=(N=0)===R?(it=138,3):U===R?(it=6,3):(it=7,4)}}a($);var Z=!1;function _(E,I,V,H){Q(E,(l<<1)+(H?1:0),3),(function(U,q,R,N){ht(U),tt(U,R),tt(U,~R),s.arraySet(U.pending_buf,U.window,q,R,U.pending),U.pending+=R})(E,I,V)}i._tr_init=function(E){Z||((function(){var I,V,H,U,q,R=new Array(m+1);for(U=H=0;U<p-1;U++)for(T[U]=H,I=0;I<1<<B[U];I++)F[H++]=U;for(F[H-1]=U,U=q=0;U<16;U++)for($[U]=q,I=0;I<1<<A[U];I++)D[q++]=U;for(q>>=7;U<c;U++)for($[U]=q<<7,I=0;I<1<<A[U]-7;I++)D[256+q++]=U;for(V=0;V<=m;V++)R[V]=0;for(I=0;I<=143;)P[2*I+1]=8,I++,R[8]++;for(;I<=255;)P[2*I+1]=9,I++,R[9]++;for(;I<=279;)P[2*I+1]=7,I++,R[7]++;for(;I<=287;)P[2*I+1]=8,I++,R[8]++;for(Bt(P,y+1,R),I=0;I<c;I++)k[2*I+1]=5,k[2*I]=ut(I,5);K=new et(P,B,h+1,y,m),G=new et(k,A,0,c,m),rt=new et(new Array(0),M,0,d,g)})(),Z=!0),E.l_desc=new j(E.dyn_ltree,K),E.d_desc=new j(E.dyn_dtree,G),E.bl_desc=new j(E.bl_tree,rt),E.bi_buf=0,E.bi_valid=0,lt(E)},i._tr_stored_block=_,i._tr_flush_block=function(E,I,V,H){var U,q,R=0;0<E.level?(E.strm.data_type===2&&(E.strm.data_type=(function(N){var it,dt=4093624447;for(it=0;it<=31;it++,dt>>>=1)if(1&dt&&N.dyn_ltree[2*it]!==0)return n;if(N.dyn_ltree[18]!==0||N.dyn_ltree[20]!==0||N.dyn_ltree[26]!==0)return r;for(it=32;it<h;it++)if(N.dyn_ltree[2*it]!==0)return r;return n})(E)),bt(E,E.l_desc),bt(E,E.d_desc),R=(function(N){var it;for(w(N,N.dyn_ltree,N.l_desc.max_code),w(N,N.dyn_dtree,N.d_desc.max_code),bt(N,N.bl_desc),it=d-1;3<=it&&N.bl_tree[2*S[it]+1]===0;it--);return N.opt_len+=3*(it+1)+5+5+4,it})(E),U=E.opt_len+3+7>>>3,(q=E.static_len+3+7>>>3)<=U&&(U=q)):U=q=V+5,V+4<=U&&I!==-1?_(E,I,V,H):E.strategy===4||q===U?(Q(E,2+(H?1:0),3),Pt(E,P,k)):(Q(E,4+(H?1:0),3),(function(N,it,dt,ct){var Vt;for(Q(N,it-257,5),Q(N,dt-1,5),Q(N,ct-4,4),Vt=0;Vt<ct;Vt++)Q(N,N.bl_tree[2*S[Vt]+1],3);Y(N,N.dyn_ltree,it-1),Y(N,N.dyn_dtree,dt-1)})(E,E.l_desc.max_code+1,E.d_desc.max_code+1,R+1),Pt(E,E.dyn_ltree,E.dyn_dtree)),lt(E),H&&ht(E)},i._tr_tally=function(E,I,V){return E.pending_buf[E.d_buf+2*E.last_lit]=I>>>8&255,E.pending_buf[E.d_buf+2*E.last_lit+1]=255&I,E.pending_buf[E.l_buf+E.last_lit]=255&V,E.last_lit++,I===0?E.dyn_ltree[2*V]++:(E.matches++,I--,E.dyn_ltree[2*(F[V]+h+1)]++,E.dyn_dtree[2*O(I)]++),E.last_lit===E.lit_bufsize-1},i._tr_align=function(E){Q(E,2,3),W(E,b,P),(function(I){I.bi_valid===16?(tt(I,I.bi_buf),I.bi_buf=0,I.bi_valid=0):8<=I.bi_valid&&(I.pending_buf[I.pending++]=255&I.bi_buf,I.bi_buf>>=8,I.bi_valid-=8)})(E)}},{"../utils/common":41}],53:[function(e,o,i){o.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,o,i){(function(s){(function(n,r){if(!n.setImmediate){var a,l,p,h,y=1,c={},d=!1,f=n.document,m=Object.getPrototypeOf&&Object.getPrototypeOf(n);m=m&&m.setTimeout?m:n,a={}.toString.call(n.process)==="[object process]"?function(z){process.nextTick(function(){g(z)})}:(function(){if(n.postMessage&&!n.importScripts){var z=!0,v=n.onmessage;return n.onmessage=function(){z=!1},n.postMessage("","*"),n.onmessage=v,z}})()?(h="setImmediate$"+Math.random()+"$",n.addEventListener?n.addEventListener("message",b,!1):n.attachEvent("onmessage",b),function(z){n.postMessage(h+z,"*")}):n.MessageChannel?((p=new MessageChannel).port1.onmessage=function(z){g(z.data)},function(z){p.port2.postMessage(z)}):f&&"onreadystatechange"in f.createElement("script")?(l=f.documentElement,function(z){var v=f.createElement("script");v.onreadystatechange=function(){g(z),v.onreadystatechange=null,l.removeChild(v),v=null},l.appendChild(v)}):function(z){setTimeout(g,0,z)},m.setImmediate=function(z){typeof z!="function"&&(z=new Function(""+z));for(var v=new Array(arguments.length-1),C=0;C<v.length;C++)v[C]=arguments[C+1];var B={callback:z,args:v};return c[y]=B,a(y),y++},m.clearImmediate=x}function x(z){delete c[z]}function g(z){if(d)setTimeout(g,0,z);else{var v=c[z];if(v){d=!0;try{(function(C){var B=C.callback,A=C.args;switch(A.length){case 0:B();break;case 1:B(A[0]);break;case 2:B(A[0],A[1]);break;case 3:B(A[0],A[1],A[2]);break;default:B.apply(r,A)}})(v)}finally{x(z),d=!1}}}}function b(z){z.source===n&&typeof z.data=="string"&&z.data.indexOf(h)===0&&g(+z.data.slice(h.length))}})(typeof self>"u"?s===void 0?this:s:self)}).call(this,typeof Ko<"u"?Ko:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Ki)),Ki.exports}var Jp=Kp();const Qp=qp(Jp);class t0{constructor(){this.context=null,this.analyser=null,this.source=null,this.gainNode=null,this.stream=null,this.fftSize=1024,this.freqData=null,this.timeData=null,this.bands={sub:0,bass:0,mid:0,high:0,presence:0},this.energy=0,this.beat=!1,this.onset=0,this.beatThreshold=1.3,this.beatDecay=.98,this.beatAverage=0,this.beatHoldFrames=0,this.beatHoldMax=10,this.prevEnergy=0,this.onsetDecay=.92,this.smoothing=.7,this.smoothedBands={sub:0,bass:0,mid:0,high:0,presence:0},this.smoothedEnergy=0,this.gain=1,this.sensitivity=1,this.running=!1}async start(){if(!this.running)try{this.context=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=this.fftSize,this.analyser.smoothingTimeConstant=.8,this.gainNode=this.context.createGain(),this.gainNode.gain.value=this.gain,this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.source=this.context.createMediaStreamSource(this.stream),this.source.connect(this.gainNode),this.gainNode.connect(this.analyser),this.freqData=new Uint8Array(this.analyser.frequencyBinCount),this.timeData=new Uint8Array(this.analyser.fftSize),this.running=!0}catch(t){throw console.warn("AudioReactor: Failed to start mic capture:",t),t}}stop(){this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null),this.source&&(this.source.disconnect(),this.source=null),this.context&&this.context.state!=="closed"&&this.context.close(),this.context=null,this.analyser=null,this.running=!1,this.bands={sub:0,bass:0,mid:0,high:0,presence:0},this.energy=0,this.beat=!1,this.onset=0}setGain(t){this.gain=t,this.gainNode&&(this.gainNode.gain.value=t)}setSensitivity(t){this.sensitivity=Math.max(.1,t)}setSmoothing(t){this.smoothing=Math.max(0,Math.min(.95,t))}update(){if(!this.running||!this.analyser)return;this.analyser.getByteFrequencyData(this.freqData),this.analyser.getByteTimeDomainData(this.timeData);const t=this.analyser.frequencyBinCount,o=this.context.sampleRate/2/t;this.bands.sub=this._bandEnergy(20,60,o,t),this.bands.bass=this._bandEnergy(60,250,o,t),this.bands.mid=this._bandEnergy(250,2e3,o,t),this.bands.high=this._bandEnergy(2e3,6e3,o,t),this.bands.presence=this._bandEnergy(6e3,2e4,o,t);for(const l in this.bands)this.bands[l]=Math.min(1,this.bands[l]*this.sensitivity);const i=this.smoothing;for(const l in this.bands)this.smoothedBands[l]=this.smoothedBands[l]*i+this.bands[l]*(1-i),this.bands[l]=this.smoothedBands[l];let s=0;for(let l=0;l<this.timeData.length;l++){const p=(this.timeData[l]-128)/128;s+=p*p}const n=Math.min(1,Math.sqrt(s/this.timeData.length)*3*this.sensitivity);this.smoothedEnergy=this.smoothedEnergy*this.smoothing+n*(1-this.smoothing),this.energy=this.smoothedEnergy;const r=(this.bands.sub+this.bands.bass)*.5;this.beatAverage=this.beatAverage*this.beatDecay+r*(1-this.beatDecay),this.beatHoldFrames>0?(this.beatHoldFrames--,this.beat=!0):r>this.beatAverage*this.beatThreshold&&r>.15?(this.beat=!0,this.beatHoldFrames=this.beatHoldMax):this.beat=!1;const a=Math.max(0,this.energy-this.prevEnergy);this.onset=Math.max(this.onset*this.onsetDecay,a*3),this.onset=Math.min(1,this.onset),this.prevEnergy=this.energy}_bandEnergy(t,e,o,i){const s=Math.max(0,Math.floor(t/o)),n=Math.min(i-1,Math.floor(e/o));if(s>=n)return 0;let r=0,a=0;for(let l=s;l<=n;l++)r+=this.freqData[l],a++;return a>0?r/a/255:0}getSource(t){switch(t){case"sub":return this.bands.sub;case"bass":return this.bands.bass;case"mid":return this.bands.mid;case"high":return this.bands.high;case"presence":return this.bands.presence;case"energy":return this.energy;case"beat":return this.beat?1:0;case"onset":return this.onset;default:return 0}}dispose(){this.stop()}}class e0{constructor(){this.mappings=[],this.smoothedValues=new Map,this.triggerStates=new Map}addMapping(t){const e={id:t.id||`map_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,source:t.source||"energy",target:t.target||"",range:t.range||[0,1],smooth:t.smooth??.15,curve:t.curve||"linear",trigger:t.trigger||!1,enabled:t.enabled??!0};return this.mappings.push(e),this.smoothedValues.set(e.id,e.range[0]),e}removeMapping(t){this.mappings=this.mappings.filter(e=>e.id!==t),this.smoothedValues.delete(t)}setMapping(t,e){const o=this.mappings.find(i=>i.id===t);o&&Object.assign(o,e)}update(t,e){const o=new Map;for(const i of this.mappings){if(!i.enabled)continue;const s=t.getSource(i.source);if(i.trigger){const c=this.triggerStates.get(i.id)||!1,d=s>.5;this.triggerStates.set(i.id,d),d&&!c&&o.set(i.target,{value:1,trigger:!0});continue}const n=this._applyCurve(s,i.curve),[r,a]=i.range,l=r+n*(a-r),p=this.smoothedValues.get(i.id)??l,h=1-Math.pow(1-i.smooth,e*60),y=p+(l-p)*h;this.smoothedValues.set(i.id,y),o.set(i.target,{value:y,trigger:!1})}return o}_applyCurve(t,e){switch(e){case"exponential":return t*t;case"step":return t>.5?1:0;case"sqrt":return Math.sqrt(t);case"linear":default:return t}}loadPreset(t){this.mappings=[],this.smoothedValues.clear(),this.triggerStates.clear();const o=this._getPresets()[t];if(o)for(const i of o)this.addMapping(i)}savePreset(t){const e=`vj_preset_${t}`;localStorage.setItem(e,JSON.stringify(this.mappings))}loadCustomPreset(t){const e=`vj_preset_${t}`,o=localStorage.getItem(e);if(!o)return!1;this.mappings=[],this.smoothedValues.clear(),this.triggerStates.clear();const i=JSON.parse(o);for(const s of i)this.addMapping(s);return!0}_getPresets(){return{chill:[{source:"bass",target:"shader.thickness",range:[1,3],smooth:.08,curve:"sqrt"},{source:"energy",target:"emissive.intensity",range:[.5,2],smooth:.1},{source:"energy",target:"camera.orbitSpeed",range:[.3,1.5],smooth:.05},{source:"bass",target:"mesh.vertexDistort",range:[0,.08],smooth:.06},{source:"mid",target:"shader.chromatic",range:[0,.002],smooth:.08},{source:"high",target:"shader.vignette",range:[0,.4],smooth:.1},{source:"energy",target:"bloom.strength",range:[.2,.7],smooth:.08}],hard:[{source:"bass",target:"shader.thickness",range:[1,6],smooth:.25,curve:"exponential"},{source:"energy",target:"emissive.intensity",range:[.5,4],smooth:.3},{source:"onset",target:"camera.shake",range:[0,.5],smooth:.05},{source:"energy",target:"camera.orbitSpeed",range:[.5,4],smooth:.2},{source:"bass",target:"mesh.vertexDistort",range:[0,.2],smooth:.2},{source:"bass",target:"mesh.blockBounce",range:[0,.5],smooth:.15},{source:"mid",target:"shader.chromatic",range:[0,.008],smooth:.15},{source:"beat",target:"shader.fills",range:[0,1],trigger:!0},{source:"high",target:"shader.vignette",range:[0,1],smooth:.2},{source:"energy",target:"bloom.strength",range:[.3,1.5],smooth:.2}],psychedelic:[{source:"bass",target:"shader.thickness",range:[1,8],smooth:.2,curve:"exponential"},{source:"energy",target:"emissive.intensity",range:[1,5],smooth:.25},{source:"onset",target:"camera.shake",range:[0,.4],smooth:.05},{source:"energy",target:"camera.orbitSpeed",range:[1,5],smooth:.15},{source:"bass",target:"mesh.vertexDistort",range:[0,.25],smooth:.15},{source:"bass",target:"mesh.blockBounce",range:[0,.6],smooth:.12},{source:"mid",target:"shader.chromatic",range:[0,.012],smooth:.12},{source:"beat",target:"shader.fills",range:[0,1],trigger:!0},{source:"high",target:"shader.vignette",range:[0,1.2],smooth:.15},{source:"energy",target:"shader.bloom",range:[.5,2],smooth:.15},{source:"mid",target:"shader.hueShift",range:[0,1],smooth:.05},{source:"onset",target:"shader.glitch",range:[0,.5],smooth:.03},{source:"energy",target:"shader.feedback",range:[0,.5],smooth:.1}],trippy:[{source:"bass",target:"shader.thickness",range:[2,10],smooth:.3,curve:"exponential"},{source:"energy",target:"emissive.intensity",range:[2,8],smooth:.3},{source:"onset",target:"camera.shake",range:[0,.8],smooth:.03},{source:"energy",target:"camera.orbitSpeed",range:[2,8],smooth:.2},{source:"bass",target:"mesh.vertexDistort",range:[0,.4],smooth:.2},{source:"bass",target:"mesh.blockBounce",range:[0,.8],smooth:.15},{source:"mid",target:"shader.chromatic",range:[0,.02],smooth:.1},{source:"high",target:"shader.rgbSplit",range:[0,1],smooth:.1},{source:"beat",target:"shader.fills",range:[0,1],trigger:!0},{source:"beat",target:"shader.mirror",range:[0,1],trigger:!0},{source:"beat",target:"shader.invert",range:[0,1],trigger:!0},{source:"high",target:"shader.vignette",range:[0,1.5],smooth:.15},{source:"energy",target:"shader.bloom",range:[1,3],smooth:.2},{source:"mid",target:"shader.hueShift",range:[0,2],smooth:.03},{source:"onset",target:"shader.glitch",range:[0,.8],smooth:.02},{source:"energy",target:"shader.feedback",range:[0,.85],smooth:.12},{source:"bass",target:"shader.pixelate",range:[0,.5],smooth:.1}]}}setReactivity(t){for(const e of this.mappings)e.smooth=Math.min(.5,e.smooth*t)}dispose(){this.mappings=[],this.smoothedValues.clear(),this.triggerStates.clear()}}class o0{constructor(t,e){this.engine=t,this.camera=t.camera,this.controls=t.controls,this.bookmarks=e,this.mode="orbit",this.enabled=!1,this.time=0,this.shake=0,this.orbitSpeed=1,this.zoomPulse=0,this.fovTarget=60,this.baseDistance=0,this.baseFov=60,this.shakeOffset=new X,this.beatRotationH=0,this.beatRotationV=0,this.beatRotationTargetH=0,this.beatRotationTargetV=0,this.orbitDirection=1,this.orbitChangeTimer=0,this.orbitChangeDuration=3,this.driftTarget=new X(10,10,10),this.driftLookAt=new X(0,0,0),this.driftTimer=0,this.driftDuration=5,this.railProgress=0,this.railSpeed=.1,this.chaosTimer=0,this.chaosInterval=2,this.flyVelocity=new X,this.flyDirection=new X(1,0,.5).normalize(),this.flySpeed=5,this.flyTurnTimer=0,this.flyTurnDuration=3}setMode(t){this.mode=t,this.baseDistance=this.camera.position.distanceTo(this.controls.target),this.baseFov=this.camera.fov,this.controls.maxPolarAngle=Math.PI,this.controls.minPolarAngle=0,t==="orbit"?this.controls.autoRotate=!0:this.controls.autoRotate=!1,t==="drift"&&this._pickDriftTarget()}setEnabled(t){this.enabled=t,t||(this.controls.autoRotate=!1,this.camera.fov=this.baseFov,this.camera.updateProjectionMatrix())}update(t,e){if(this.enabled)switch(this.time+=e,this._applyBeatRotation(t,e),this._applyShake(e),this._applyFOVBreathing(t,e),this._applyZoomPulse(t,e),this.mode){case"orbit":this._updateOrbit(t,e);break;case"drift":this._updateDrift(t,e);break;case"lock":break;case"rail":this._updateRail(t,e);break;case"chaos":this._updateChaos(t,e);break;case"fly":this._updateFly(t,e);break}}_applyBeatRotation(t,e){if(t.beat){const o=t.energy,i=40+Math.random()*50+o*40,s=Math.random()>.5?1:-1,n=Math.random()>.5?1:-1;this.beatRotationTargetH=i*s,this.beatRotationTargetV=i*.8*n}if(this.beatRotationH+=(this.beatRotationTargetH-this.beatRotationH)*e*12,this.beatRotationV+=(this.beatRotationTargetV-this.beatRotationV)*e*12,this.beatRotationTargetH*=Math.pow(.03,e),this.beatRotationTargetV*=Math.pow(.03,e),Math.abs(this.beatRotationH)>.1||Math.abs(this.beatRotationV)>.1){const o=this.controls.target,i=new X().subVectors(this.camera.position,o),s=i.length(),n=Math.atan2(i.z,i.x),r=Math.acos(Math.max(-1,Math.min(1,i.y/s))),a=n+this.beatRotationH*Math.PI/180*e*2,l=Math.max(.1,Math.min(Math.PI-.1,r+this.beatRotationV*Math.PI/180*e*2));this.camera.position.x=o.x+s*Math.sin(l)*Math.cos(a),this.camera.position.y=o.y+s*Math.cos(l),this.camera.position.z=o.z+s*Math.sin(l)*Math.sin(a),this.camera.lookAt(o)}}_applyShake(t){this.shake<.001||(this.shakeOffset.set((Math.random()-.5)*this.shake*3,(Math.random()-.5)*this.shake*3,(Math.random()-.5)*this.shake*3),this.camera.position.add(this.shakeOffset))}_applyFOVBreathing(t,e){const o=t.bands.bass*50,i=t.energy*t.energy*30,s=30+o+i,n=8+t.energy*12;this.camera.fov+=(s-this.camera.fov)*e*n,this.camera.updateProjectionMatrix()}_applyZoomPulse(t,e){if(!t.beat)return;const o=new X().subVectors(this.controls.target,this.camera.position).normalize(),i=.8+t.energy*1.2;this.camera.position.addScaledVector(o,i)}_updateOrbit(t,e){this.orbitChangeTimer+=e;const o=2+Math.random()*2;(t.beat&&t.energy>.6||this.orbitChangeTimer>=o)&&(this.orbitDirection*=-1,this.orbitChangeTimer=0);const i=5+t.energy*7;this.controls.autoRotateSpeed=this.orbitSpeed*i*this.orbitDirection,this.controls.update()}_updateDrift(t,e){this.driftTimer+=e,(t.beat&&t.energy>.7||this.driftTimer>=this.driftDuration)&&(this._pickDriftTarget(),this.driftTimer=0);const o=2.5,i=t.energy*3,s=e*(o+i);this.camera.position.lerp(this.driftTarget,Math.min(s,1)),this.controls.target.lerp(this.driftLookAt,Math.min(s,1)),this.controls.update()}_pickDriftTarget(){const t=this.bookmarks?Array.from(this.bookmarks.bookmarks.values()):[];if(t.length>1){const e=t[Math.floor(Math.random()*t.length)];this.driftTarget.set(e.position.x,e.position.y,e.position.z),this.driftLookAt.set(e.target.x,e.target.y,e.target.z)}else{const e=Math.random()*Math.PI*2,o=20+Math.random()*40,i=5+Math.random()*25;this.driftTarget.set(Math.cos(e)*o,i,Math.sin(e)*o),this.driftLookAt.set(0,2,0)}this.driftDuration=1+Math.random()*2}_updateRail(t,e){const o=this.bookmarks?Array.from(this.bookmarks.bookmarks.values()):[];if(o.length<2)return;t.beat&&t.energy>.6&&(this.railProgress=Math.floor(this.railProgress)+1),this.railProgress+=e*this.railSpeed*(1.5+t.energy*2),this.railProgress>=o.length-1&&(this.railProgress=0);const i=Math.floor(this.railProgress),s=this.railProgress-i,n=o[i],r=o[Math.min(i+1,o.length-1)],a=s*s*s*(s*(s*6-15)+10);this.camera.position.set(n.position.x+(r.position.x-n.position.x)*a,n.position.y+(r.position.y-n.position.y)*a,n.position.z+(r.position.z-n.position.z)*a),this.controls.target.set(n.target.x+(r.target.x-n.target.x)*a,n.target.y+(r.target.y-n.target.y)*a,n.target.z+(r.target.z-n.target.z)*a),this.controls.update()}_updateChaos(t,e){this.chaosTimer+=e;const o=.3+Math.random()*.5;if(t.beat||this.chaosTimer>=o){this.chaosTimer=0;const i=Math.random()*Math.PI*2,s=10+Math.random()*70,n=-10+Math.random()*50,r=Math.random()>.4?{x:(Math.random()-.5)*20,y:Math.random()*15-5,z:(Math.random()-.5)*20}:{x:0,y:2,z:0};this.camera.position.set(Math.cos(i)*s,n,Math.sin(i)*s),this.camera.lookAt(r.x,r.y,r.z),this.controls.target.set(r.x,r.y,r.z),this.controls.update()}}_updateFly(t,e){if(this.flyTurnTimer+=e,this.flyTurnTimer>=this.flyTurnDuration||t.beat&&t.energy>.5){this.flyTurnTimer=0;const n=Math.random()*Math.PI*2,r=(Math.random()-.5)*Math.PI*.9;this.flyDirection.set(Math.cos(r)*Math.cos(n),Math.sin(r),Math.cos(r)*Math.sin(n)).normalize(),this.flyTurnDuration=1+Math.random()*2}const o=this.flySpeed*(1.5+t.energy*2.5);this.flyVelocity.copy(this.flyDirection).multiplyScalar(o*e),this.camera.position.add(this.flyVelocity);const i=new X().copy(this.camera.position).add(this.flyDirection.clone().multiplyScalar(10));this.camera.lookAt(i),this.controls.target.copy(i),this.controls.update(),this.camera.position.length()>100&&(this.flyDirection.negate(),this.flyTurnTimer=0)}dispose(){this.setEnabled(!1)}}const Xn=new ot,Ht={h:0,s:0,l:0};class i0{constructor(t,e){this.blockManager=t,this.engine=e,this.enabled=!1,this.time=0,this.blockDistortion=.5,this.vertexDistortion=.5,this.colorReactivity=.5,this.movementMode="bounce",this.originalState=new Map,this.lastBeat=!1,this.beatTime=0,this.vertexUniforms={uBass:{value:0},uEnergy:{value:0},uTime:{value:0},uDistortAmount:{value:0}},this.patchedMaterials=new WeakSet}setEnabled(t){this.enabled=t,t?(this._captureOriginalState(),this._patchExistingMaterials()):this._restoreOriginalState()}setBlockDistortion(t){this.blockDistortion=t}setVertexDistortion(t){this.vertexDistortion=t}setColorReactivity(t){this.colorReactivity=t}setMovementMode(t){this.movementMode=t;for(const[e,o]of this.originalState)o.impulseY=0,o.velX=0,o.velZ=0,o.pushX=0,o.pushZ=0,o.rotImpulse=0}update(t,e){if(!this.enabled)return;this.time+=e;const o=t.beat;o&&!this.lastBeat&&(this.beatTime=this.time),this.lastBeat=o,this.vertexUniforms.uBass.value=t.bands.bass,this.vertexUniforms.uEnergy.value=t.energy,this.vertexUniforms.uTime.value=this.time,this.vertexUniforms.uDistortAmount.value=this.vertexDistortion,this.blockDistortion>.01&&this._updateBlocks(t,e),this.colorReactivity>.01&&this._updateBlockColors(t,e),this.vertexDistortion>.01&&this._patchNewMaterials()}_captureOriginalState(){this.originalState.clear();const t=this.blockManager.getAllBlocks();for(const e of t)this._captureBlock(e)}_captureBlock(t){const o=(Array.isArray(t.mesh.material)?t.mesh.material:[t.mesh.material]).map(i=>i.color.getHex());this.originalState.set(t.id,{y:t.mesh.position.y,x:t.mesh.position.x,z:t.mesh.position.z,scaleX:t.mesh.scale.x,scaleY:t.mesh.scale.y,scaleZ:t.mesh.scale.z,rotY:t.mesh.rotation.y,colors:o,impulseY:0,velX:0,velZ:0,pushX:0,pushZ:0,rotImpulse:0})}_restoreOriginalState(){const t=this.blockManager.getAllBlocks();for(const e of t){const o=this.originalState.get(e.id);if(o){e.mesh.position.set(o.x,o.y,o.z),e.mesh.scale.set(o.scaleX,o.scaleY,o.scaleZ),e.mesh.rotation.y=o.rotY;const i=Array.isArray(e.mesh.material)?e.mesh.material:[e.mesh.material];for(let s=0;s<i.length;s++)o.colors[s]!==void 0&&i[s].color.setHex(o.colors[s])}}this.originalState.clear()}_updateBlocks(t,e){const o=this.blockManager.getAllBlocks(),i=t.bands.bass,s=t.energy,n=t.onset;t.beat&&this.lastBeat;const r=this.blockDistortion;for(const a of o){let l=this.originalState.get(a.id);if(!l){this._captureBlock(a);continue}switch(this.movementMode){case"bounce":this._moveBounce(a,l,i,s,r);break;case"jump":this._moveJump(a,l,i,s,n,r,e);break;case"wave":this._moveWave(a,l,i,s,r);break;case"scatter":this._moveScatter(a,l,i,s,n,r,e);break}const p=1+s*r*.25,h=1+i*r*.4;if(a.mesh.scale.set(l.scaleX*p,l.scaleY*h,l.scaleZ*p),a.emissive&&a.emissive.enabled){const y=Array.isArray(a.mesh.material)?a.mesh.material:[a.mesh.material];for(const c of y)c.emissiveIntensity=a.emissive.intensity*(1+n*r*4)}}}_moveBounce(t,e,o,i,s){const n=t.gridPosition.x*.7+t.gridPosition.z*.5+this.time*3,r=Math.sin(n)*o*s*1.5;t.mesh.position.y=e.y+r;const a=t.gridPosition.x*.5-t.gridPosition.z*.3+this.time*2;t.mesh.position.x=e.x+Math.sin(a)*i*s*.3,t.mesh.position.z=e.z+Math.cos(a*.7)*i*s*.3}_moveJump(t,e,o,i,s,n,r){if(s>.2){const a=(t.gridPosition.x*.3+t.gridPosition.z*.2)%1;Math.random()<s*.6+(1-a)*.3&&(e.impulseY=Math.max(e.impulseY,s*n*3.5))}e.impulseY*=.85,t.mesh.position.y=e.y+e.impulseY,t.mesh.position.x=e.x+(Math.random()-.5)*o*n*.4,t.mesh.position.z=e.z+(Math.random()-.5)*o*n*.4,s>.25&&(e.rotImpulse+=s*n*.6),e.rotImpulse*=.88,t.mesh.rotation.y=e.rotY+e.rotImpulse}_moveWave(t,e,o,i,s){const n=t.gridPosition.x,r=t.gridPosition.z,a=Math.sqrt(n*n+r*r),l=a*.1,p=this.time-this.beatTime,h=(p-l)*6,y=Math.max(0,1-p*.5),c=Math.sin(h)*y*o*s*2.5;if(t.mesh.position.y=e.y+(p>l?c:0),p>l&&y>.1){const d=a>.1?1/a:0,f=Math.sin(h)*y*s*.4;t.mesh.position.x=e.x+n*d*f,t.mesh.position.z=e.z+r*d*f}}_moveScatter(t,e,o,i,s,n,r){const a=t.gridPosition.x,l=t.gridPosition.z,p=Math.max(.5,Math.sqrt(a*a+l*l));if(s>.2){const d=s*n*1.5;e.velX+=a/p*d,e.velZ+=l/p*d}const h=5,y=3;e.velX+=-e.pushX*h*r,e.velZ+=-e.pushZ*h*r,e.velX*=Math.max(0,1-y*r),e.velZ*=Math.max(0,1-y*r),e.pushX+=e.velX*r,e.pushZ+=e.velZ*r,t.mesh.position.x=e.x+e.pushX,t.mesh.position.z=e.z+e.pushZ;const c=o*n*1.2;t.mesh.position.y=e.y+c,t.mesh.rotation.y=e.rotY+e.pushX*.3}_updateBlockColors(t,e){const o=this.blockManager.getAllBlocks(),i=t.bands.mid,s=t.energy,n=t.bands.bass,r=t.bands.high,a=this.colorReactivity;for(const l of o){let p=this.originalState.get(l.id);if(!p&&(this._captureBlock(l),p=this.originalState.get(l.id),!p))continue;const h=Array.isArray(l.mesh.material)?l.mesh.material:[l.mesh.material],y=l.gridPosition.x*.4+l.gridPosition.z*.3+l.gridPosition.y*.2;for(let c=0;c<h.length;c++)p.colors[c]!==void 0&&(Xn.setHex(p.colors[c]),Xn.getHSL(Ht),Ht.h=(Ht.h+i*a*.3+Math.sin(this.time*.5+y)*a*.1)%1,Ht.h<0&&(Ht.h+=1),Ht.s=Math.min(1,Ht.s+s*a*.2),Ht.l=Math.min(.9,Math.max(.1,Ht.l+n*a*.15-r*a*.05)),h[c].color.setHSL(Ht.h,Ht.s,Ht.l))}}_patchExistingMaterials(){const t=this.blockManager.getAllBlocks();for(const e of t)this._patchBlockMaterial(e)}_patchNewMaterials(){const t=this.blockManager.getAllBlocks();for(const e of t){const o=Array.isArray(e.mesh.material)?e.mesh.material:[e.mesh.material];for(const i of o)this.patchedMaterials.has(i)||this._patchMaterial(i)}}_patchBlockMaterial(t){const e=Array.isArray(t.mesh.material)?t.mesh.material:[t.mesh.material];for(const o of e)this._patchMaterial(o)}_patchMaterial(t){if(this.patchedMaterials.has(t))return;this.patchedMaterials.add(t);const e=this.vertexUniforms;t.onBeforeCompile=o=>{o.uniforms.uBass=e.uBass,o.uniforms.uEnergy=e.uEnergy,o.uniforms.uTime=e.uTime,o.uniforms.uDistortAmount=e.uDistortAmount,o.vertexShader=o.vertexShader.replace("#include <common>",`#include <common>
        uniform float uBass;
        uniform float uEnergy;
        uniform float uTime;
        uniform float uDistortAmount;

        // Simplex-style hash noise
        vec3 mod289(vec3 x) { return x - floor(x * (1.0/289.0)) * 289.0; }
        vec4 mod289(vec4 x) { return x - floor(x * (1.0/289.0)) * 289.0; }
        vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
        vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }
        float snoise(vec3 v) {
          const vec2 C = vec2(1.0/6.0, 1.0/3.0);
          const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);
          vec3 i = floor(v + dot(v, C.yyy));
          vec3 x0 = v - i + dot(i, C.xxx);
          vec3 g = step(x0.yzx, x0.xyz);
          vec3 l = 1.0 - g;
          vec3 i1 = min(g.xyz, l.zxy);
          vec3 i2 = max(g.xyz, l.zxy);
          vec3 x1 = x0 - i1 + C.xxx;
          vec3 x2 = x0 - i2 + C.yyy;
          vec3 x3 = x0 - D.yyy;
          i = mod289(i);
          vec4 p = permute(permute(permute(
            i.z + vec4(0.0, i1.z, i2.z, 1.0))
            + i.y + vec4(0.0, i1.y, i2.y, 1.0))
            + i.x + vec4(0.0, i1.x, i2.x, 1.0));
          float n_ = 0.142857142857;
          vec3 ns = n_ * D.wyz - D.xzx;
          vec4 j = p - 49.0 * floor(p * ns.z * ns.z);
          vec4 x_ = floor(j * ns.z);
          vec4 y_ = floor(j - 7.0 * x_);
          vec4 x = x_ * ns.x + ns.yyyy;
          vec4 y = y_ * ns.x + ns.yyyy;
          vec4 h = 1.0 - abs(x) - abs(y);
          vec4 b0 = vec4(x.xy, y.xy);
          vec4 b1 = vec4(x.zw, y.zw);
          vec4 s0 = floor(b0) * 2.0 + 1.0;
          vec4 s1 = floor(b1) * 2.0 + 1.0;
          vec4 sh = -step(h, vec4(0.0));
          vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy;
          vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww;
          vec3 p0 = vec3(a0.xy, h.x);
          vec3 p1 = vec3(a0.zw, h.y);
          vec3 p2 = vec3(a1.xy, h.z);
          vec3 p3 = vec3(a1.zw, h.w);
          vec4 norm = taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));
          p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w;
          vec4 m = max(0.6 - vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)), 0.0);
          m = m * m;
          return 42.0 * dot(m*m, vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));
        }
        `),o.vertexShader=o.vertexShader.replace("#include <begin_vertex>",`#include <begin_vertex>
        if (uDistortAmount > 0.001) {
          // Radial breathing on bass
          float breath = sin(uTime * 2.0) * uBass * uDistortAmount * 0.5;
          transformed *= 1.0 + breath;

          // Noise displacement along normal
          float noise = snoise(transformed * 2.0 + uTime * 0.5);
          transformed += normal * noise * uBass * uDistortAmount * 0.6;

          // Energy-driven expansion
          transformed *= 1.0 + uEnergy * uDistortAmount * 0.15;
        }
        `)},t.needsUpdate=!0}dispose(){this.enabled&&this._restoreOriginalState(),this.enabled=!1,this.patchedMaterials=new WeakSet}}class s0{constructor(t){this.scene=t,this.enabled=!1,this.poolSize=64,this.pool=[],this.active=[],this.geometry=new bi(1,1,1),this.sceneCenter=new X(0,2,0),this.sceneRadius=8,this._built=!1}setEnabled(t){this.enabled=t,t&&!this._built&&this._buildPool(),t||this._returnAll()}setPoolSize(t){t===this.poolSize&&this._built||(this._dispose(),this.poolSize=t,this.enabled&&this._buildPool())}updateSceneBounds(t){const e=t.getAllBlocks();if(e.length===0)return;let o=1/0,i=-1/0,s=1/0,n=-1/0,r=1/0,a=-1/0;for(const l of e){const p=l.gridPosition;o=Math.min(o,p.x),i=Math.max(i,p.x),s=Math.min(s,p.y),n=Math.max(n,p.y),r=Math.min(r,p.z),a=Math.max(a,p.z)}this.sceneCenter.set((o+i)/2,(s+n)/2+1,(r+a)/2),this.sceneRadius=Math.max(3,Math.sqrt(Math.pow(i-o,2)+Math.pow(a-r,2))/2+2)}spawn(t,e){if(!this.enabled){console.warn("[ParticleSpawner] spawn() called but spawner is disabled");return}if(this.pool.length===0){console.warn("[ParticleSpawner] spawn() called but pool is empty (all particles active)");return}const o=this.pool.pop();o.visible=!0;const i=Math.random()*Math.PI*2,s=Math.random()*this.sceneRadius;o.position.set(this.sceneCenter.x+Math.cos(i)*s,this.sceneCenter.y+Math.random()*3,this.sceneCenter.z+Math.sin(i)*s),console.log(`[ParticleSpawner] Spawned particle at (${o.position.x.toFixed(1)}, ${o.position.y.toFixed(1)}, ${o.position.z.toFixed(1)}), pool: ${this.pool.length}, active: ${this.active.length+1}`);const n=.3+t*.7;o.scale.set(.01,.01,.01),o.material.color.setHex(e||this._randomColor()),o.material.opacity=.9,o.userData.life=0,o.userData.maxLife=.8+Math.random()*.8,o.userData.targetScale=n,o.userData.velocityY=1.5+t*2,o.userData.rotSpeed=(Math.random()-.5)*4,this.active.push(o)}update(t){if(this.enabled)for(let e=this.active.length-1;e>=0;e--){const o=this.active[e],i=o.userData;i.life+=t;const s=i.life/i.maxLife;if(s>=1){o.visible=!1,this.pool.push(o),this.active.splice(e,1);continue}const n=s<.2?s/.2:1-(s-.2)/.8,r=i.targetScale*n;o.scale.set(r,r,r),o.position.y+=i.velocityY*t*(1-s*.5),o.rotation.y+=i.rotSpeed*t,o.rotation.x+=i.rotSpeed*.5*t,o.material.opacity=Math.max(0,.9*(1-s))}}_buildPool(){this._dispose();for(let t=0;t<this.poolSize;t++){const e=new Ct({roughness:.6,metalness:.2,transparent:!0,opacity:.9}),o=new It(this.geometry,e);o.visible=!1,o.castShadow=!0,o.receiveShadow=!0,this.scene.add(o),this.pool.push(o)}this._built=!0,console.log(`ParticleSpawner: Built pool of ${this.poolSize} particles`)}_returnAll(){for(const t of this.active)t.visible=!1,this.pool.push(t);this.active.length=0}_randomColor(){const t=Math.random(),e=new ot;return e.setHSL(t,.8,.6),e.getHex()}_dispose(){for(const t of[...this.pool,...this.active])this.scene.remove(t),t.material.dispose();this.pool.length=0,this.active.length=0,this._built=!1}dispose(){this._dispose(),this.geometry.dispose()}}class n0{constructor(){this.scenes=[],this.currentIndex=-1,this.onSceneChange=null}get count(){return this.scenes.length}get currentName(){return this.currentIndex>=0&&this.currentIndex<this.scenes.length?this.scenes[this.currentIndex].name:null}async loadFolder(t){this.scenes=[],this.currentIndex=-1;const e=Array.from(t).filter(o=>o.name.endsWith(".blocks"));e.sort((o,i)=>o.name.localeCompare(i.name));for(const o of e)try{const i=await o.text(),s=JSON.parse(i);s.blocks&&Array.isArray(s.blocks)&&this.scenes.push({name:o.name.replace(".blocks",""),data:s})}catch(i){console.warn(`SceneBank: skipped invalid file ${o.name}:`,i.message)}return this.scenes.length}switchTo(t,e,o){if(this.scenes.length===0)return!1;t=(t%this.scenes.length+this.scenes.length)%this.scenes.length;const i=this.scenes[t];this.currentIndex=t;const s=e.getAllBlocks();for(const n of[...s])e.removeBlock(n.id);return e.fromJSON(i.data.blocks),o&&i.data.layers&&o.fromJSON(i.data.layers),this.onSceneChange&&this.onSceneChange(t,i.name,this.scenes.length),!0}next(t,e){return this.switchTo(this.currentIndex+1,t,e)}previous(t,e){return this.switchTo(this.currentIndex-1,t,e)}random(t,e){if(this.scenes.length<=1)return this.switchTo(0,t,e);let o;do o=Math.floor(Math.random()*this.scenes.length);while(o===this.currentIndex);return this.switchTo(o,t,e)}}const Pe=512,Wt=new Ut,ee=new X,oe=new X,ae=new Oe,ve=new ot;class r0{constructor(t){this.scene=t,this.enabled=!1,this.count=0,this.maxInstances=Pe,this.headIndex=0,this.instanceData=new Array(Pe);for(let e=0;e<Pe;e++)this.instanceData[e]={birthTime:0,ttl:0,alive:!1,baseY:0};this.cursors=[],this.maxCursors=8,this.growthRate=3,this.branchProb=.25,this.ttl=20,this.blockScale=1,this.verticalBias=.7,this.time=0,this.lastBeat=!1,this.mesh=null,this._built=!1}setEnabled(t){this.enabled=t,t&&!this._built&&this._build(),t&&this._resetCursors(),this.mesh&&(this.mesh.visible=t)}setMaxInstances(t){t===this.maxInstances&&this._built||(this.maxInstances=Math.min(t,Pe))}setTTL(t){this.ttl=t}setGrowthRate(t){this.growthRate=t}initFromScene(t){const e=t.getAllBlocks();if(e.length===0){this._resetCursors();return}const o=new Map;for(const s of e){const n=`${s.gridPosition.x},${s.gridPosition.z}`,r=o.get(n);(!r||s.gridPosition.y>r.gridPosition.y)&&o.set(n,s)}const i=Array.from(o.values()).sort((s,n)=>n.gridPosition.y-s.gridPosition.y).slice(0,this.maxCursors);for(this.cursors=i.map(s=>({x:s.gridPosition.x,y:s.gridPosition.y+1,z:s.gridPosition.z,direction:"up",energy:1}));this.cursors.length<3;)this.cursors.push({x:Math.floor(Math.random()*6-3),y:0,z:Math.floor(Math.random()*6-3),direction:"up",energy:1})}update(t,e){if(!this.enabled||!this.mesh)return;this.time+=e;const o=t.beat&&!this.lastBeat;this.lastBeat=t.beat,o&&this._grow(t),this._animate(t,e),this._expire(),this.mesh.instanceMatrix.needsUpdate=!0,this.mesh.instanceColor.needsUpdate=!0}_grow(t){const e=t.bands.bass,o=t.bands.mid,i=t.bands.high,s=t.energy,n=t.onset,r=Math.min(Math.ceil(s*this.growthRate),this.growthRate);for(let a=0;a<r&&this.cursors.length!==0;a++){const l=Math.floor(Math.random()*this.cursors.length),p=this.cursors[l];this._placeInstance(p.x,p.y,p.z,t),this._advanceCursor(p,e,o,i,n),o>.3&&Math.random()<this.branchProb*o&&this._branchCursor(p,o),n>.5&&this.cursors.length<this.maxCursors&&Math.random()<.4&&this.cursors.push({x:p.x+Math.floor(Math.random()*5-2),y:0,z:p.z+Math.floor(Math.random()*5-2),direction:"up",energy:n})}this.cursors=this.cursors.filter(a=>a.y<30&&Math.abs(a.x)<20&&Math.abs(a.z)<20),this.cursors.length===0&&this._resetCursors()}_advanceCursor(t,e,o,i,s){if(Math.random()<this.verticalBias*(.5+e*.5))t.y+=1;else switch(Math.floor(Math.random()*4)){case 0:t.x+=1;break;case 1:t.x-=1;break;case 2:t.z+=1;break;case 3:t.z-=1;break}}_branchCursor(t,e){if(this.cursors.length>=this.maxCursors)return;const o=Math.floor(Math.random()*4),i={x:t.x,y:t.y,z:t.z,direction:"side",energy:e};switch(o){case 0:i.x+=1;break;case 1:i.x-=1;break;case 2:i.z+=1;break;case 3:i.z-=1;break}this.cursors.push(i)}_placeInstance(t,e,o,i){const s=this.headIndex;this.headIndex=(this.headIndex+1)%this.maxInstances,this.count<this.maxInstances&&this.count++;const n=i.bands.high,r=this.blockScale*(.6+(1-n)*.6);ee.set(t,e,o),oe.set(r,r,r),ae.identity(),Wt.compose(ee,ae,oe),this.mesh.setMatrixAt(s,Wt);const a=(i.bands.bass*.3+i.bands.mid*.4+this.time*.02)%1,l=.5+i.energy*.4,p=.35+i.bands.bass*.25;ve.setHSL(a,l,p),this.mesh.setColorAt(s,ve),this.instanceData[s].birthTime=this.time,this.instanceData[s].ttl=this.ttl,this.instanceData[s].alive=!0,this.instanceData[s].baseY=e,this.mesh.count=this.count}_animate(t,e){const o=t.bands.bass,i=t.energy;for(let s=0;s<this.maxInstances;s++){const n=this.instanceData[s];if(!n.alive)continue;const r=this.time-n.birthTime,a=Math.min(1,r/n.ttl);this.mesh.getMatrixAt(s,Wt),Wt.decompose(ee,ae,oe),ee.y=n.baseY+r*.15;const l=1+Math.sin(this.time*3+s*.5)*o*.3,p=a>.7?(1-a)/.3:1,h=Math.min(1,r*4),y=this.blockScale*l*p*h;oe.set(y,y,y),Wt.compose(ee,ae,oe),this.mesh.setMatrixAt(s,Wt),this.mesh.getColorAt(s,ve);const c={};ve.getHSL(c),c.h=(c.h+e*.05)%1,c.l=Math.max(.1,c.l*(.99+i*.01)),ve.setHSL(c.h,c.s,c.l),this.mesh.setColorAt(s,ve)}}_expire(){for(let t=0;t<this.maxInstances;t++){const e=this.instanceData[t];e.alive&&this.time-e.birthTime>e.ttl&&(e.alive=!1,oe.set(0,0,0),ee.set(0,-100,0),ae.identity(),Wt.compose(ee,ae,oe),this.mesh.setMatrixAt(t,Wt))}}_resetCursors(){this.cursors=[];for(let t=0;t<3;t++)this.cursors.push({x:Math.floor(Math.random()*4-2),y:0,z:Math.floor(Math.random()*4-2),direction:"up",energy:1})}_build(){if(this._built)return;const t=new bi(.95,.95,.95),e=new Ct({roughness:.5,metalness:.3,vertexColors:!0});this.mesh=new Yn(t,e,Pe),this.mesh.count=0,this.mesh.instanceMatrix.setUsage(aa),this.mesh.frustumCulled=!1,this.mesh.visible=!1,ve.set(.5,.5,.5);for(let o=0;o<Pe;o++)ee.set(0,-100,0),oe.set(0,0,0),ae.identity(),Wt.compose(ee,ae,oe),this.mesh.setMatrixAt(o,Wt),this.mesh.setColorAt(o,ve);this.mesh.instanceMatrix.needsUpdate=!0,this.mesh.instanceColor&&(this.mesh.instanceColor.needsUpdate=!0),this.scene.add(this.mesh),this._built=!0}clear(){this.count=0,this.headIndex=0;for(let t=0;t<Pe;t++)this.instanceData[t].alive=!1,ee.set(0,-100,0),oe.set(0,0,0),ae.identity(),Wt.compose(ee,ae,oe),this.mesh&&this.mesh.setMatrixAt(t,Wt);this.mesh&&(this.mesh.count=0,this.mesh.instanceMatrix.needsUpdate=!0),this._resetCursors()}dispose(){this.mesh&&(this.scene.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.mesh=null),this._built=!1}}class a0{constructor(t){this.blockManager=t,this.enabled=!1,this.spawnRate=3,this.spawnRadius=8,this.maxHeight=12,this.spawnCenter=new X(0,0,0),this.bassTypes=["cube","slab","cylinder","prism","wedge"],this.midTypes=["cube","sphere","capsule","torus","arch"],this.highTypes=["crystal","sphere","pipe","cone","pyramid"],this.bassColors=["#8B0000","#4B0082","#2F4F4F","#0D4D4D"],this.midColors=["#FF6B6B","#4ECDC4","#45B7D1","#FFA07A"],this.highColors=["#FFD700","#00CED1","#FF69B4","#7FFFD4"],this.lastBeat=!1,this.spawnCooldown=0,this.minCooldown=.05}setEnabled(t){this.enabled=t}setSpawnRate(t){this.spawnRate=Math.max(1,Math.min(10,t))}setSpawnRadius(t){this.spawnRadius=Math.max(5,Math.min(30,t))}updateSpawnCenter(){const t=this.blockManager.getAllBlocks();if(t.length===0){this.spawnCenter.set(0,0,0);return}let e=0,o=0;for(const i of t)e+=i.gridPosition.x,o+=i.gridPosition.z;this.spawnCenter.set(Math.round(e/t.length),0,Math.round(o/t.length))}update(t,e){if(!this.enabled)return;this.spawnCooldown-=e;const o=t.beat&&!this.lastBeat;this.lastBeat=t.beat,o&&this.spawnCooldown<=0&&(this._spawnBurst(t),this.spawnCooldown=this.minCooldown)}_spawnBurst(t){const e=t.bands.bass,o=t.bands.mid,i=t.bands.high,s=t.energy,n=Math.ceil(this.spawnRate*s);for(let r=0;r<n;r++){const a=Math.max(e,o,i);let l,p,h,y;a===e&&e>.3?(l=this.bassTypes[Math.floor(Math.random()*this.bassTypes.length)],p=this.bassColors[Math.floor(Math.random()*this.bassColors.length)],h=1+e*2,y=Math.floor(e*3)):a===o&&o>.3?(l=this.midTypes[Math.floor(Math.random()*this.midTypes.length)],p=this.midColors[Math.floor(Math.random()*this.midColors.length)],h=1+o*1,y=2+Math.floor(o*4)):a===i&&i>.3?(l=this.highTypes[Math.floor(Math.random()*this.highTypes.length)],p=this.highColors[Math.floor(Math.random()*this.highColors.length)],h=.5+i*.5,y=4+Math.floor(i*8)):(l="cube",p="#808080",h=1,y=Math.floor(Math.random()*6));const c=Math.random()*Math.PI*2,d=Math.random()*this.spawnRadius,f=Math.round(this.spawnCenter.x+Math.cos(c)*d),m=Math.round(this.spawnCenter.z+Math.sin(c)*d),x=Math.max(0,y);if(!this.blockManager.getBlockAtPosition({x:f,y:x,z:m}))try{this.blockManager.addBlock({type:l,position:{x:f,y:x,z:m},color:p,scale:h})}catch(g){console.warn(`[AudioBlockSpawner] Failed to spawn block at (${f},${x},${m}):`,g.message)}}}clear(){}dispose(){this.enabled=!1}}class l0{constructor(t){this.blockManager=t,this.blocks=new Map,this.enabled=!1,this.baseTTL=30,this.maxEphemeralBlocks=1e3,this.decayDuration=.3,this.decayMode="fadeAndShrink"}setEnabled(t){this.enabled=t,t||this.clear()}setBaseTTL(t){this.baseTTL=Math.max(5,Math.min(120,t))}setDecayMode(t){this.decayMode=t}spawn(t,e=1){if(!this.enabled)return null;this.blocks.size>=this.maxEphemeralBlocks&&this._removeOldest();const o=this.blockManager.addBlock(t);if(!o)return null;const i=this.baseTTL*(.5+e*1.5);return this.blocks.set(o.id,{block:o,birthTime:performance.now()/1e3,ttl:i,decayMode:this.decayMode,originalScale:o.scale,originalOpacity:o.mesh.material.opacity||1}),o}update(t){if(!this.enabled)return;const e=[];for(const[o,i]of this.blocks){const n=(t-i.birthTime)/i.ttl;if(n>=1)e.push(o);else if(n>1-this.decayDuration){const r=(n-(1-this.decayDuration))/this.decayDuration;this._applyDecay(i,r)}}for(const o of e){const i=this.blocks.get(o);this.blockManager.removeBlock(i.block.id),this.blocks.delete(o)}}_applyDecay(t,e){const{block:o,decayMode:i,originalScale:s,originalOpacity:n}=t;switch(i){case"fadeAndShrink":{const r=n*(1-e),a=s*(1-e*.5);Array.isArray(o.mesh.material)?o.mesh.material.forEach(l=>{l.opacity=r,l.transparent=!0,l.needsUpdate=!0}):(o.mesh.material.opacity=r,o.mesh.material.transparent=!0,o.mesh.material.needsUpdate=!0),o.mesh.scale.setScalar(a);break}case"floatUp":{const r=e*3,a=n*(1-e);o.mesh.position.y=o.gridPosition.y+r,Array.isArray(o.mesh.material)?o.mesh.material.forEach(l=>{l.opacity=a,l.transparent=!0,l.needsUpdate=!0}):(o.mesh.material.opacity=a,o.mesh.material.transparent=!0,o.mesh.material.needsUpdate=!0);break}case"dissolve":{const r=n*(1-e),a=e*.5,l=s*(1+(Math.random()-.5)*a),p=s*(1+(Math.random()-.5)*a),h=s*(1+(Math.random()-.5)*a);o.mesh.scale.set(l,p,h),Array.isArray(o.mesh.material)?o.mesh.material.forEach(y=>{y.opacity=r,y.transparent=!0,y.needsUpdate=!0}):(o.mesh.material.opacity=r,o.mesh.material.transparent=!0,o.mesh.material.needsUpdate=!0);break}case"shrink":{const r=s*(1-e);o.mesh.scale.setScalar(r);break}case"fade":{const r=n*(1-e);Array.isArray(o.mesh.material)?o.mesh.material.forEach(a=>{a.opacity=r,a.transparent=!0,a.needsUpdate=!0}):(o.mesh.material.opacity=r,o.mesh.material.transparent=!0,o.mesh.material.needsUpdate=!0);break}}}_removeOldest(){let t=null,e=1/0;for(const[o,i]of this.blocks)i.birthTime<e&&(e=i.birthTime,t=o);if(t){const o=this.blocks.get(t);this.blockManager.removeBlock(o.block.id),this.blocks.delete(t)}}clear(){for(const[t,e]of this.blocks)this.blockManager.removeBlock(e.block.id);this.blocks.clear()}getCount(){return this.blocks.size}dispose(){this.clear(),this.enabled=!1}}const c0={uniforms:{tDiffuse:{value:null},uAmount:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uAmount;
    varying vec2 vUv;

    void main() {
      vec2 dir = vUv - 0.5;
      float dist = length(dir);
      vec2 offset = dir * uAmount * dist;

      float r = texture2D(tDiffuse, vUv + offset).r;
      float g = texture2D(tDiffuse, vUv).g;
      float b = texture2D(tDiffuse, vUv - offset).b;

      gl_FragColor = vec4(r, g, b, 1.0);
    }
  `},p0={uniforms:{tDiffuse:{value:null},uGlitch:{value:0},uTime:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uGlitch;
    uniform float uTime;
    varying vec2 vUv;

    float hash(float n) {
      return fract(sin(n) * 43758.5453);
    }

    void main() {
      vec2 uv = vUv;

      if (uGlitch > 0.01) {
        // Horizontal slice displacement
        float sliceY = floor(uv.y * 20.0) / 20.0;
        float sliceRand = hash(sliceY + floor(uTime * 10.0));

        if (sliceRand > 1.0 - uGlitch) {
          uv.x += (hash(sliceY + uTime) - 0.5) * uGlitch * 0.3;
        }

        // Color channel split on glitch
        float shift = uGlitch * 0.01 * hash(uTime);
        float r = texture2D(tDiffuse, uv + vec2(shift, 0.0)).r;
        float g = texture2D(tDiffuse, uv).g;
        float b = texture2D(tDiffuse, uv - vec2(shift, 0.0)).b;
        gl_FragColor = vec4(r, g, b, 1.0);
      } else {
        gl_FragColor = texture2D(tDiffuse, uv);
      }
    }
  `},h0={uniforms:{tDiffuse:{value:null},uShift:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uShift;
    varying vec2 vUv;

    vec3 rgb2hsv(vec3 c) {
      vec4 K = vec4(0.0, -1.0/3.0, 2.0/3.0, -1.0);
      vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
      vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
      float d = q.x - min(q.w, q.y);
      float e = 1.0e-10;
      return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
    }

    vec3 hsv2rgb(vec3 c) {
      vec4 K = vec4(1.0, 2.0/3.0, 1.0/3.0, 3.0);
      vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
      return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
    }

    void main() {
      vec4 color = texture2D(tDiffuse, vUv);

      if (uShift > 0.001) {
        vec3 hsv = rgb2hsv(color.rgb);
        hsv.x = fract(hsv.x + uShift);
        color.rgb = hsv2rgb(hsv);
      }

      gl_FragColor = color;
    }
  `},y0={uniforms:{tDiffuse:{value:null},uIntensity:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uIntensity;
    varying vec2 vUv;

    void main() {
      vec4 color = texture2D(tDiffuse, vUv);
      float dist = length(vUv - 0.5) * 1.414; // 0 at center, ~1 at corners
      float vignette = 1.0 - dist * dist * uIntensity;
      color.rgb *= max(0.0, vignette);
      gl_FragColor = color;
    }
  `},u0={uniforms:{tDiffuse:{value:null},tPrevFrame:{value:null},uFeedback:{value:0},uZoom:{value:1},uRotation:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform sampler2D tPrevFrame;
    uniform float uFeedback;
    uniform float uZoom;
    uniform float uRotation;
    varying vec2 vUv;

    void main() {
      vec4 current = texture2D(tDiffuse, vUv);

      // Apply zoom and rotation to feedback for trippy effects
      vec2 center = vec2(0.5, 0.5);
      vec2 uv = vUv - center;

      // Rotate
      float s = sin(uRotation);
      float c = cos(uRotation);
      mat2 rot = mat2(c, -s, s, c);
      uv = rot * uv;

      // Zoom
      uv *= uZoom;
      uv += center;

      vec4 prev = texture2D(tPrevFrame, uv);

      // Blend current frame with transformed previous for motion trail effect
      gl_FragColor = mix(current, prev, uFeedback);
    }
  `},d0={uniforms:{tDiffuse:{value:null},uSegments:{value:6},uAngle:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uSegments;
    uniform float uAngle;
    varying vec2 vUv;

    #define PI 3.14159265359

    void main() {
      vec2 uv = vUv - 0.5;
      float r = length(uv);
      float theta = atan(uv.y, uv.x) + uAngle;

      // Mirror around segments
      float segment = PI * 2.0 / uSegments;
      theta = mod(theta, segment);
      theta = abs(theta - segment * 0.5);

      uv = vec2(cos(theta), sin(theta)) * r + 0.5;

      gl_FragColor = texture2D(tDiffuse, uv);
    }
  `},f0={uniforms:{tDiffuse:{value:null},uMode:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform int uMode;
    varying vec2 vUv;

    void main() {
      vec2 uv = vUv;

      if (uMode == 1) {
        // Horizontal mirror
        uv.x = abs(uv.x - 0.5) * 2.0;
      } else if (uMode == 2) {
        // Vertical mirror
        uv.y = abs(uv.y - 0.5) * 2.0;
      } else if (uMode == 3) {
        // Quad mirror
        uv = abs(uv - 0.5) * 2.0;
      }

      gl_FragColor = texture2D(tDiffuse, uv);
    }
  `},m0={uniforms:{tDiffuse:{value:null},uPixelSize:{value:1},uResolution:{value:new nt(512,512)}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uPixelSize;
    uniform vec2 uResolution;
    varying vec2 vUv;

    void main() {
      vec2 pixelSize = vec2(uPixelSize) / uResolution;
      vec2 coord = floor(vUv / pixelSize) * pixelSize;
      gl_FragColor = texture2D(tDiffuse, coord);
    }
  `},x0={uniforms:{tDiffuse:{value:null},uAmount:{value:0},uAngle:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uAmount;
    uniform float uAngle;
    varying vec2 vUv;

    void main() {
      vec2 offset = vec2(cos(uAngle), sin(uAngle)) * uAmount;

      float r = texture2D(tDiffuse, vUv + offset).r;
      float g = texture2D(tDiffuse, vUv).g;
      float b = texture2D(tDiffuse, vUv - offset).b;

      gl_FragColor = vec4(r, g, b, 1.0);
    }
  `},g0={uniforms:{tDiffuse:{value:null},uAmount:{value:0}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float uAmount;
    varying vec2 vUv;

    void main() {
      vec4 color = texture2D(tDiffuse, vUv);
      vec3 inverted = vec3(1.0) - color.rgb;
      gl_FragColor = vec4(mix(color.rgb, inverted, uAmount), color.a);
    }
  `};class b0{constructor(t,e,o,i){this.engine=t,this.blockManager=e,this.gpuRenderer=o,this.cameraBookmarks=i,this.audioReactor=new t0,this.parameterBus=new e0,this.cameraModes=new o0(t,i),this.meshReactor=new i0(e,t),this.particleSpawner=new s0(t.scene),this.audioBlockSpawner=new a0(e),this.sceneBank=new n0,this.audioGenerative=new r0(t.scene),this.ephemeralBlockManager=new l0(e),this.generativeScatter=new fr(e),this.generativePaintEnabled=!1,this.generativePaintDensity=10,this.lastBeatState=!1,this.vjPasses={},this.vjPassesActive=!1,this.feedbackTargetA=null,this.feedbackTargetB=null,this.feedbackFlip=!1,this.active=!1,this.performanceMode=!1,this.currentPreset="hard",this.styles=["clean","sketch","ink","crosshatch","blueprint","comic","saturated","neon","scifi","watercolor","noir","synthwave","ascii"],this.currentStyleIndex=0,this.cameraModeNames=["orbit","drift","fly","lock","rail","chaos"],this.currentCameraModeIndex=0,this.fillsOn=!0,this.reactivity=1,this._keyHandler=s=>this._handleKeyboard(s),this._layerManager=null,this.onStateChange=null}async start(){if(!this.active){try{await this.audioReactor.start()}catch(t){throw console.warn("VJController: Audio start failed:",t),t}this.parameterBus.loadPreset(this.currentPreset),this.gpuRenderer.enabled||this.gpuRenderer.setEnabled(!0),this._setupVJPasses(),this.cameraModes.setMode("orbit"),this.cameraModes.setEnabled(!0),this.meshReactor.setEnabled(!0),this.particleSpawner.updateSceneBounds(this.blockManager),this.audioBlockSpawner.updateSpawnCenter(),this.engine.onVJUpdate=t=>this.update(t),window.addEventListener("keydown",this._keyHandler),this.active=!0,this.onStateChange&&this.onStateChange(!0)}}stop(){this.active&&(this.engine.onVJUpdate=null,this.audioReactor.stop(),this.cameraModes.setEnabled(!1),this.meshReactor.setEnabled(!1),this.particleSpawner.setEnabled(!1),this.audioGenerative.setEnabled(!1),this.setGenerativePaintEnabled(!1),this._removeVJPasses(),this.performanceMode&&this.exitPerformanceMode(),window.removeEventListener("keydown",this._keyHandler),this.active=!1,this.onStateChange&&this.onStateChange(!1))}update(t){if(!this.active)return;this.audioReactor.update();const e=this.parameterBus.update(this.audioReactor,t);if(this._applyParams(e,t),this.cameraModes.update(this.audioReactor,t),this.meshReactor.update(this.audioReactor,t),this._updateVJPasses(t),this.particleSpawner.enabled){if(this.audioReactor.beat){const o=2+Math.floor(this.audioReactor.energy*8);console.log(`[VJController] Beat detected! Spawning ${o} particles (energy: ${this.audioReactor.energy.toFixed(2)})`);for(let i=0;i<o;i++)this.particleSpawner.spawn(this.audioReactor.energy)}this.particleSpawner.update(t)}if(this.audioBlockSpawner.enabled&&this.audioBlockSpawner.update(this.audioReactor,t),this.audioGenerative.enabled&&this.audioGenerative.update(this.audioReactor,t),this.generativePaintEnabled){this.ephemeralBlockManager.update(performance.now()/1e3);const o=this.audioReactor.beat,i=o&&!this.lastBeatState;this.lastBeatState=o,this._beatDebugCount||(this._beatDebugCount=0),this._beatDebugCount++,this._beatDebugCount%60===0&&console.log(`[VJController] Paint active | Beat: ${o} | Energy: ${this.audioReactor.energy.toFixed(2)} | Bass: ${this.audioReactor.bands.bass.toFixed(2)}`),i&&(this.generativeScatter.updateFromAudio(this.audioReactor),this._spawnGenerativePaint())}}_applyParams(t,e){for(const[o,i]of t){const{value:s,trigger:n}=i,r=n?s:s*this.reactivity;switch(o){case"shader.thickness":this.gpuRenderer.setLineWidth(r);break;case"shader.threshold":this.gpuRenderer.setThreshold(r);break;case"shader.fills":n&&(this.fillsOn=!this.fillsOn,this.gpuRenderer.setShowFills(this.fillsOn));break;case"shader.chromatic":this.vjPasses.chromatic&&(this.vjPasses.chromatic.uniforms.uAmount.value=r);break;case"shader.glitch":this.vjPasses.glitch&&(this.vjPasses.glitch.uniforms.uGlitch.value=r);break;case"shader.hueShift":this.vjPasses.hueShift&&(this.vjPasses.hueShift.uniforms.uShift.value=r);break;case"shader.vignette":this.vjPasses.vignette&&(this.vjPasses.vignette.uniforms.uIntensity.value=r);break;case"shader.feedback":this.vjPasses.feedback&&(this.vjPasses.feedback.uniforms.uFeedback.value=r);break;case"shader.kaleidoscope":this.vjPasses.kaleidoscope&&(this.vjPasses.kaleidoscope.uniforms.uSegments.value=3+Math.floor(r*9));break;case"shader.mirror":if(this.vjPasses.mirror&&n){const a=this.vjPasses.mirror.uniforms.uMode.value;this.vjPasses.mirror.uniforms.uMode.value=(a+1)%4}break;case"shader.pixelate":this.vjPasses.pixelate&&(this.vjPasses.pixelate.uniforms.uPixelSize.value=1+r*20);break;case"shader.rgbSplit":this.vjPasses.rgbSplit&&(this.vjPasses.rgbSplit.uniforms.uAmount.value=r*.02);break;case"shader.invert":if(this.vjPasses.invert&&n){const a=this.vjPasses.invert.uniforms.uAmount.value;this.vjPasses.invert.uniforms.uAmount.value=a>.5?0:1}break;case"shader.bloom":this.vjPasses.bloom&&(this.vjPasses.bloom.strength=r*2);break;case"camera.shake":this.cameraModes.shake=r;break;case"camera.orbitSpeed":this.cameraModes.orbitSpeed=r;break;case"mesh.vertexDistort":this.meshReactor.setVertexDistortion(r);break;case"mesh.blockBounce":this.meshReactor.setBlockDistortion(r);break;case"emissive.intensity":this._setGlobalEmissiveIntensity(r);break;case"bloom.strength":this._setBloomStrength(r);break}}}_setGlobalEmissiveIntensity(t){const e=this.blockManager.getAllBlocks();for(const o of e)if(o.emissive&&o.emissive.enabled){const i=Array.isArray(o.mesh.material)?o.mesh.material:[o.mesh.material];for(const s of i)s.emissiveIntensity=t}}_setBloomStrength(t){if(!this.gpuRenderer.composer)return;const e=this.gpuRenderer.composer.passes;for(const o of e)o.strength!==void 0&&(o.strength=t)}_setupVJPasses(){if(this.vjPassesActive)return;this.vjPasses.chromatic=new qt(c0),this.vjPasses.glitch=new qt(p0),this.vjPasses.hueShift=new qt(h0),this.vjPasses.vignette=new qt(y0),this.vjPasses.feedback=new qt(u0),this.vjPasses.kaleidoscope=new qt(d0),this.vjPasses.mirror=new qt(f0),this.vjPasses.pixelate=new qt(m0),this.vjPasses.rgbSplit=new qt(x0),this.vjPasses.invert=new qt(g0);const t=window.innerWidth,e=window.innerHeight;this.vjPasses.bloom=new Ne(new nt(t,e),0,.4,.85);const o={minFilter:ko,magFilter:ko,format:ds};this.feedbackTargetA=new Ce(t,e,o),this.feedbackTargetB=new Ce(t,e,o),this.vjPasses.pixelate.uniforms.uResolution.value.set(t,e),this.vjPasses.chromatic.enabled=!1,this.vjPasses.glitch.enabled=!1,this.vjPasses.hueShift.enabled=!1,this.vjPasses.vignette.enabled=!1,this.vjPasses.feedback.enabled=!1,this.vjPasses.kaleidoscope.enabled=!1,this.vjPasses.mirror.enabled=!1,this.vjPasses.pixelate.enabled=!1,this.vjPasses.rgbSplit.enabled=!1,this.vjPasses.invert.enabled=!1,this.vjPasses.bloom.enabled=!1,this.vjPassesActive=!0,this._injectVJPasses()}_injectVJPasses(){if(!this.gpuRenderer.composer||!this.vjPassesActive)return;const t=this.gpuRenderer.composer,e=t.passes,o=e.length-1,i=[this.vjPasses.feedback,this.vjPasses.kaleidoscope,this.vjPasses.mirror,this.vjPasses.pixelate,this.vjPasses.rgbSplit,this.vjPasses.chromatic,this.vjPasses.glitch,this.vjPasses.hueShift,this.vjPasses.bloom,this.vjPasses.vignette,this.vjPasses.invert],s=e[o];e.splice(o,1);for(const n of i)t.addPass(n);t.addPass(s),console.log("[VJController] Injected VJ post-processing passes:",i.length)}_removeVJPasses(){this.vjPassesActive&&(this.feedbackTargetA&&this.feedbackTargetA.dispose(),this.feedbackTargetB&&this.feedbackTargetB.dispose(),this.feedbackTargetA=null,this.feedbackTargetB=null,this.vjPasses.bloom&&this.vjPasses.bloom.dispose(),this.vjPasses={},this.vjPassesActive=!1,this.gpuRenderer.enabled&&this.gpuRenderer.updateStyle())}_updateVJPasses(t){var o;if(!this.vjPassesActive)return;const e=performance.now()*.001;if(this.vjPasses.glitch&&(this.vjPasses.glitch.uniforms.uTime.value+=t),this.vjPasses.kaleidoscope&&(this.vjPasses.kaleidoscope.uniforms.uAngle.value=e*.5),this.vjPasses.rgbSplit&&(this.vjPasses.rgbSplit.uniforms.uAngle.value=e*2),this.vjPasses.feedback&&this.vjPasses.feedback.uniforms.uFeedback.value>.01){const s=((o=this.audioReactor)==null?void 0:o.energy)||0;this.vjPasses.feedback.uniforms.uZoom.value=1+s*.02,this.vjPasses.feedback.uniforms.uRotation.value=Math.sin(e*.5)*.01,this.feedbackFlip?this.feedbackTargetA:this.feedbackTargetB;const n=this.feedbackFlip?this.feedbackTargetB:this.feedbackTargetA;this.vjPasses.feedback.uniforms.tPrevFrame.value=n.texture,this.feedbackFlip=!this.feedbackFlip}}onStyleChanged(){this.vjPassesActive&&this._injectVJPasses()}enterPerformanceMode(){this.performanceMode=!0;const t=document.documentElement;t.requestFullscreen&&t.requestFullscreen(),document.querySelectorAll("#right-panel, #bottom-toolbar, #top-menu, #timeline-panel, .modal").forEach(o=>{o.dataset.vjHidden=o.style.display,o.style.display="none"});const e=document.getElementById("vj-overlay");e&&(e.style.display="flex")}exitPerformanceMode(){this.performanceMode=!1,document.fullscreenElement&&document.exitFullscreen(),document.querySelectorAll("#right-panel, #bottom-toolbar, #top-menu, #timeline-panel").forEach(e=>{e.style.display=e.dataset.vjHidden||"",delete e.dataset.vjHidden});const t=document.getElementById("vj-overlay");t&&(t.style.display="none")}_handleKeyboard(t){if(this.active&&!(t.target.tagName==="INPUT"||t.target.tagName==="SELECT"||t.target.tagName==="TEXTAREA"))switch(t.key){case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{const s=parseInt(t.key)-1;s<this.styles.length&&(this.currentStyleIndex=s,this.gpuRenderer.setStyle(this.styles[s]),setTimeout(()=>this.onStyleChanged(),50)),t.preventDefault();break}case" ":this.fillsOn=!this.fillsOn,this.gpuRenderer.setShowFills(this.fillsOn),this._showOverlayMessage(this.fillsOn?"Fills ON":"Fills OFF"),t.preventDefault();break;case"g":this.gpuRenderer.grayscale=!this.gpuRenderer.grayscale,this.gpuRenderer.updateStyleUniforms(),this._showOverlayMessage(this.gpuRenderer.grayscale?"Grayscale":"Color");break;case"i":this.gpuRenderer.setInverted(!this.gpuRenderer.inverted),this._showOverlayMessage(this.gpuRenderer.inverted?"Inverted":"Normal");break;case"c":this.currentCameraModeIndex=(this.currentCameraModeIndex+1)%this.cameraModeNames.length;const e=this.cameraModeNames[this.currentCameraModeIndex];this.cameraModes.setMode(e),this._showOverlayMessage(`Camera: ${e}`);break;case"f":this.performanceMode?this.exitPerformanceMode():this.enterPerformanceMode();break;case"m":this.audioReactor.running&&(this.audioReactor.setGain(this.audioReactor.gain>0?0:1),this._showOverlayMessage(this.audioReactor.gain>0?"Audio ON":"Audio MUTED"));break;case"r":this.currentStyleIndex=Math.floor(Math.random()*this.styles.length),this.gpuRenderer.setStyle(this.styles[this.currentStyleIndex]),setTimeout(()=>this.onStyleChanged(),50);break;case"+":case"=":this.reactivity=Math.min(3,this.reactivity+.1),this._showOverlayMessage(`Reactivity: ${this.reactivity.toFixed(1)}`);break;case"-":this.reactivity=Math.max(.1,this.reactivity-.1),this._showOverlayMessage(`Reactivity: ${this.reactivity.toFixed(1)}`);break;case"[":this._adjustAllSmoothing(-.02),this._showOverlayMessage("Smoother");break;case"]":this._adjustAllSmoothing(.02),this._showOverlayMessage("Snappier");break;case"0":this.reactivity=1,this.parameterBus.loadPreset(this.currentPreset),this._showOverlayMessage("Reset");break;case"p":const o=["chill","hard","psychedelic"],i=o.indexOf(this.currentPreset);this.currentPreset=o[(i+1)%o.length],this.parameterBus.loadPreset(this.currentPreset),this._showOverlayMessage(`Preset: ${this.currentPreset}`);break;case"n":this.sceneBank.count>0&&(this.sceneBank.next(this.blockManager,this._layerManager),this.meshReactor.setEnabled(!0),this.particleSpawner.updateSceneBounds(this.blockManager),this.audioBlockSpawner.updateSpawnCenter(),this._showOverlayMessage(`Scene: ${this.sceneBank.currentName} (${this.sceneBank.currentIndex+1}/${this.sceneBank.count})`));break;case"b":this.sceneBank.count>0&&(this.sceneBank.previous(this.blockManager,this._layerManager),this.meshReactor.setEnabled(!0),this.particleSpawner.updateSceneBounds(this.blockManager),this.audioBlockSpawner.updateSpawnCenter(),this._showOverlayMessage(`Scene: ${this.sceneBank.currentName} (${this.sceneBank.currentIndex+1}/${this.sceneBank.count})`));break;case"v":{const s=["bounce","jump","wave","scatter"],n=s.indexOf(this.meshReactor.movementMode),r=s[(n+1)%s.length];this.meshReactor.setMovementMode(r),this._showOverlayMessage(`Move: ${r}`);break}case"x":{const s=this.audioGenerative;s.enabled?(s.setEnabled(!1),this._showOverlayMessage("Generative OFF")):(s.initFromScene(this.blockManager),s.setEnabled(!0),this._showOverlayMessage("Generative ON"));break}case"g":{this.setGenerativePaintEnabled(!this.generativePaintEnabled),this._showOverlayMessage(this.generativePaintEnabled?"Generative Paint ON":"Generative Paint OFF");break}case"t":{this.generativePaintEnabled&&(console.log("[VJController] Manual test spawn triggered"),this.generativeScatter.updateFromAudio(this.audioReactor),this._spawnGenerativePaint(),this._showOverlayMessage("Test Spawn"));break}}}_adjustAllSmoothing(t){for(const e of this.parameterBus.mappings)e.smooth=Math.max(.01,Math.min(.5,e.smooth+t))}_showOverlayMessage(t){const e=document.getElementById("vj-message");e&&(e.textContent=t,e.style.opacity="1",clearTimeout(this._messageTimeout),this._messageTimeout=setTimeout(()=>{e.style.opacity="0"},1200))}getAudioData(){return{bands:{...this.audioReactor.bands},energy:this.audioReactor.energy,beat:this.audioReactor.beat,onset:this.audioReactor.onset}}setPreset(t){this.currentPreset=t,this.parameterBus.loadPreset(t)}setCameraMode(t){const e=this.cameraModeNames.indexOf(t);e>=0&&(this.currentCameraModeIndex=e),this.cameraModes.setMode(t)}setGenerativePaintEnabled(t){this.generativePaintEnabled=t,t?(this.generativeScatter.setAudioReactive(!0),this.ephemeralBlockManager.setEnabled(!0),this.lastBeatState=!1,this.generativeScatter.setMaxBlocks(this.generativePaintDensity),console.log(`[VJController] Generative Paint ENABLED (density: ${this.generativePaintDensity} blocks/beat, preset: ${this.generativeScatter.preset}, algorithm: ${this.generativeScatter.algorithm})`)):(this.generativeScatter.setAudioReactive(!1),this.ephemeralBlockManager.setEnabled(!1),console.log("[VJController] Generative Paint DISABLED"))}setGenerativePaintDensity(t){this.generativePaintDensity=Math.max(3,Math.min(30,t)),this.generativeScatter.setMaxBlocks(this.generativePaintDensity),console.log(`[VJController] Generative density: ${this.generativePaintDensity} blocks/beat`)}setGenerativePreset(t){this.generativeScatter.setPreset(t),console.log(`[VJController] Generative preset: ${t}`)}setGenerativeAlgorithm(t){this.generativeScatter.setAlgorithm(t),console.log(`[VJController] Generative algorithm: ${t}`)}setEphemeralLifetime(t){this.ephemeralBlockManager.setBaseTTL(t),console.log(`[VJController] Ephemeral lifetime: ${t}s`)}setEphemeralDecayMode(t){this.ephemeralBlockManager.setDecayMode(t),console.log(`[VJController] Decay mode: ${t}`)}_spawnGenerativePaint(){const t={x:0,y:0,z:0};if(this.cameraModes.target)t.x=Math.round(this.cameraModes.target.x),t.y=Math.round(this.cameraModes.target.y),t.z=Math.round(this.cameraModes.target.z);else{const s=this.blockManager.getAllBlocks();if(s.length>0){const n=s[Math.floor(Math.random()*s.length)];t.x=n.gridPosition.x,t.y=n.gridPosition.y,t.z=n.gridPosition.z}}const e=this.generativeScatter.generate(t);if(e.length===0){console.warn("[VJController] GenerativeScatter returned 0 blocks!");return}const o=this.audioReactor.energy;let i=0;for(const s of e)try{this.ephemeralBlockManager.spawn(s,o),i++}catch(n){console.warn("[VJController] Failed to spawn ephemeral block:",n.message)}console.log(`[VJController] BEAT! Spawned ${i} blocks at (${t.x},${t.y},${t.z}) | Energy: ${o.toFixed(2)} | Active: ${this.ephemeralBlockManager.getCount()}`)}dispose(){this.stop(),this.audioReactor.dispose(),this.meshReactor.dispose(),this.cameraModes.dispose(),this.parameterBus.dispose(),this.particleSpawner.dispose(),this.audioBlockSpawner.dispose(),this.audioGenerative.dispose(),this.ephemeralBlockManager.dispose()}}function z0(u,t){let e;return function(...i){const s=()=>{clearTimeout(e),u(...i)};clearTimeout(e),e=setTimeout(s,t)}}class v0{constructor(){this.canvas=document.getElementById("viewport"),this.gridPosEl=document.getElementById("grid-pos"),this.blockCountEl=document.getElementById("block-count"),this.colorInput=document.getElementById("current-color"),this.colorPalette=document.getElementById("color-palette"),this.selectionProps=document.getElementById("selection-props"),this.fileInput=document.getElementById("file-input"),this.debouncedAutoSave=z0(()=>this.autoSave(),2e3),this.engine=new Fa(this.canvas),this.grid=new wa(this.engine.scene,{gridSize:20,cellSize:1}),this.blockManager=new Ia(this.engine.scene),this.ghostBlock=new La(this.engine.scene),this.history=new Oa,this.textureManager=new Ua,this.facePainter=new Ba(this.textureManager),this.animator=new Za(this.blockManager),this.projectManager=new Ga(this.blockManager,this.animator,this.textureManager),this.projectManager.onError=t=>this.showNotification(t,"error"),this.exporter=new fl,this.layerManager=new Sl,this.layerManager.onLayerChange=()=>this.updateLayerUI(),this.projectManager.setLayerManager(this.layerManager),this.symmetryTool=new Tl(this.blockManager),this.cameraBookmarks=new Pl(this.engine.camera,this.engine.controls),this.cameraBookmarks.onBookmarksChange=()=>this.updateCameraBookmarksUI(),this.cameraPathAnimator=new Il(this.engine.camera,this.engine.controls,this.cameraBookmarks),this.frameSequencer=new oc(this.engine),window.JSZip=Qp,this.lightBaker=new ml,this.textureBaker=new xl,this.useGPURenderer=!0;try{this.useGPURenderer?(this.tattooRenderer=new Ks(this.engine,this.blockManager),console.log("Using GPU-accelerated style renderer")):(this.tattooRenderer=new Eo(this.engine,this.blockManager),console.log("Using CPU style renderer"))}catch(t){console.warn("GPU renderer failed, falling back to CPU:",t),this.tattooRenderer=new Eo(this.engine,this.blockManager)}this.blockFlattener=new $p(this.blockManager),this.scatterTool=new fr(this.blockManager),this.vjController=new b0(this.engine,this.blockManager,this.tattooRenderer,this.cameraBookmarks),this.notificationsEl=document.getElementById("notifications"),this.bakedTexture=null,this.bakedUVData=null,this.inputManager=new Ra(this.canvas,this.engine.camera),this.inputManager.setGridPlane(this.grid.getRaycastPlane()),this.currentColor="#5588cc",this.currentBlockType="cube",this.currentRotation=0,this.clipboard=null,this.emissiveEnabled=!1,this.emissiveColor="#ffaa00",this.emissiveIntensity=1,this.emissiveRadius=3,this.showEdges=!0,this.edgeOpacity=.3,this.currentShape="sphere",this.shapeGhosts=[],this.paintMode="face",this.currentBlockScale=1,this.setupCallbacks(),this.setupToolbar(),this.setupPaintMode(),this.setupShapeBrush(),this.setupMoveControls(),this.setupColorPalette(),this.setupEmissiveControls(),this.setupEdgeControls(),this.setupPlacementControls(),this.setupMenuBar(),this.setupTimeline(),this.setupLayerPanel(),this.setupSymmetryTools(),this.setupCameraBookmarks(),this.setupCameraAnimation(),this.setupTattooMode(),this.setupScatterTool(),this.setupVJ(),this.setupKeyboardShortcuts(),this.engine.onUpdate=t=>{if(this.animator.update(t),!this.useGPURenderer&&this.tattooRenderer.update&&this.tattooRenderer.update(),this.vjController&&this.vjController.active){const e=this.vjController.audioReactor.energy,o=Math.min(100,e*100);this._vjMeterBar&&(this._vjMeterBar.style.width=o+"%"),this._vjOverlayMeterBar&&(this._vjOverlayMeterBar.style.width=o+"%"),this._vjStyleNameEl&&(this._vjStyleNameEl.textContent=this.vjController.styles[this.vjController.currentStyleIndex]),this._vjCameraNameEl&&(this._vjCameraNameEl.textContent=this.vjController.cameraModeNames[this.vjController.currentCameraModeIndex]),this._vjPresetNameEl&&(this._vjPresetNameEl.textContent=this.vjController.currentPreset)}},this.engine.start(),this.autoLoad()}setupCallbacks(){this.blockManager.onBlockCountChange=c=>{this.blockCountEl.textContent=`Blocks: ${c}`,this.inputManager.setRaycastTargets(this.blockManager.getBlockMeshes()),this.debouncedAutoSave()},this.engine.controls.addEventListener("change",()=>{this.debouncedAutoSave()}),this.history.onChange=({canUndo:c,canRedo:d})=>{document.getElementById("btn-undo").disabled=!c,document.getElementById("btn-redo").disabled=!d},this.history.notify();const t={slab:"slabTop",wedgeLow:"wedgeLowTop",wedgeFlat:"wedgeFlatTop",slabSlope:"slabSlopeTop"},e=(c,d)=>{const f={x:c.placementPosition.x,y:c.placementPosition.y,z:c.placementPosition.z};if(c.placementPosition.surfaceY!==void 0){const m=c.placementPosition.surfaceY,x=m%1;if(x!==0){const b=t[d];b&&Math.abs(x-.5)<.1?(f.y=Math.floor(m),f.useUpperVariant=b):f.y=Math.ceil(m)}}return f},o=(c,d)=>d<=1?c:{x:Math.floor(c.x/d)*d,y:c.y,z:Math.floor(c.z/d)*d};this.inputManager.onMouseMove=c=>{if(this.inputManager.currentTool==="place"&&c){let d=e(c,this.currentBlockType);const f=d.useUpperVariant||this.currentBlockType;d=o(d,this.currentBlockScale),this.ghostBlock.show(),this.ghostBlock.setPosition(d),this.ghostBlock.setBlockType(f),this.ghostBlock.setRotation(this.currentRotation);const m=this.blockManager.wouldOverlapAt(f,d,{w:1,h:1,d:1},null,this.currentBlockScale,{x:0,y:this.currentRotation,z:0});this.ghostBlock.setValid(!m),this.gridPosEl.textContent=`Grid: ${d.x}, ${d.y}, ${d.z}`}else this.ghostBlock.hide()};let i=null;const s=(c,d)=>{const f=[],m=Math.abs(d.x-c.x),x=Math.abs(d.y-c.y),g=Math.abs(d.z-c.z),b=c.x===d.x,z=c.y===d.y,v=c.z===d.z;if(b&&z||b&&v||z&&v){const C=c.x<d.x?1:c.x>d.x?-1:0,B=c.y<d.y?1:c.y>d.y?-1:0,A=c.z<d.z?1:c.z>d.z?-1:0,M=Math.max(m,x,g);for(let S=0;S<=M;S++)f.push({x:c.x+C*S,y:c.y+B*S,z:c.z+A*S})}else{const C=Math.min(c.x,d.x),B=Math.max(c.x,d.x),A=Math.min(c.y,d.y),M=Math.max(c.y,d.y),S=Math.min(c.z,d.z),P=Math.max(c.z,d.z);for(let k=C;k<=B;k++)for(let D=A;D<=M;D++)for(let F=S;F<=P;F++)f.push({x:k,y:D,z:F})}return f};this.inputManager.onPlace=(c,d)=>{if(!c)return;if(!this.canEditCurrentLayer()){this.showNotification("Layer is locked or hidden","warning");return}let f=e(c,this.currentBlockType);const m=f.useUpperVariant||this.currentBlockType;if(f=o(f,this.currentBlockScale),d&&i){const b=s(i,f);let z=!1;for(const v of b){if(this.blockManager.wouldOverlapAt(m,v,{w:1,h:1,d:1},null,this.currentBlockScale,{x:0,y:this.currentRotation,z:0}))continue;const C={type:m,position:{...v},color:this.currentColor,rotation:{x:0,y:this.currentRotation,z:0},layerId:this.getActiveLayerId(),scale:this.currentBlockScale,emissive:{enabled:this.emissiveEnabled,color:this.emissiveColor,intensity:this.emissiveIntensity,radius:this.emissiveRadius}},B=this.blockManager.addBlock(C);B&&(this.history.push(co(this.blockManager,C,B)),z=!0)}z&&(i={...f});return}if(this.blockManager.wouldOverlapAt(m,f,{w:1,h:1,d:1},null,this.currentBlockScale,{x:0,y:this.currentRotation,z:0}))return;const x={type:m,position:f,color:this.currentColor,rotation:{x:0,y:this.currentRotation,z:0},layerId:this.getActiveLayerId(),scale:this.currentBlockScale,emissive:{enabled:this.emissiveEnabled,color:this.emissiveColor,intensity:this.emissiveIntensity,radius:this.emissiveRadius}},g=this.blockManager.addBlock(x);g&&(this.history.push(co(this.blockManager,x,g)),i={...f})},this.inputManager.onDelete=c=>{c&&(this.history.push(Bi(this.blockManager,c)),this.blockManager.removeBlock(c.id))},this.inputManager.onSelect=(c,d)=>{d&&c?this.blockManager.toggleSelection(c):this.blockManager.selectBlock(c),this.updateSelectionUI()};const n=(c,d)=>{const f=new Bo(zt.degToRad(d.rotation.x),zt.degToRad(d.rotation.y),zt.degToRad(d.rotation.z)),x=new Oe().setFromEuler(f).clone().invert(),g=c.clone().applyQuaternion(x);return this.facePainter.getFaceFromNormal(g)};let r=null,a=[],l=!1,p=0;const h=(c,d)=>{const f=this.paintMode==="face"&&!c.supportsPerFacePainting();if(f){const m=Date.now();if(m-p>2e3){p=m;const x=document.getElementById("tool-hint"),g=x.textContent;x.textContent=`Complex block "${c.type}" - painting entire block (face mode not supported)`,x.style.color="#ffaa00",setTimeout(()=>{x.textContent=g,x.style.color=""},2e3)}}if(this.paintMode==="block"||f){const m=c.color,x={};return Object.entries(c.faces).forEach(([g,b])=>{b&&b.color&&(x[g]={color:b.color})}),c.setColor(this.currentColor),ja(c,m,this.currentColor,x)}else{const m=n(d,c),x=c.getFaceColor(m),g=c.faces[m]&&c.faces[m].color!==null;return c.setFaceColor(m,this.currentColor),Na(c,m,g?x:null,this.currentColor)}},y=(c,d,f)=>{const m=[],x=Math.abs(d.x-c.x),g=Math.abs(d.y-c.y),b=Math.abs(d.z-c.z);let z,v,C,B;x>=g&&x>=b?(z=x,v=c.x<d.x?1:-1,C=0,B=0):g>=x&&g>=b?(z=g,v=0,C=c.y<d.y?1:-1,B=0):(z=b,v=0,C=0,B=c.z<d.z?1:-1);for(let A=0;A<=z;A++){const M={x:c.x+v*A,y:c.y+C*A,z:c.z+B*A},S=this.blockManager.getBlockAtPosition(M);S&&m.push({block:S,normal:f})}return m};this.inputManager.onPaint=(c,d)=>{if(!c||!c.block)return;const f=c.block.gridPosition;if(d&&r){const m=y(r,f,c.normal),x=[];m.forEach(({block:g,normal:b})=>{const z=h(g,b);x.push(z)}),x.length>0&&this.history.push(Ns(x))}else{const m=h(c.block,c.normal);this.inputManager.isPainting&&!l?(l=!0,a=[m]):this.inputManager.isPainting&&l?a.push(m):this.history.push(m)}r={...f},c.normal.clone()},this.canvas.onmouseup,this.canvas.addEventListener("mouseup",()=>{l&&a.length>0&&(a.length===1?this.history.push(a[0]):this.history.push(Ns(a)),a=[]),l=!1}),this.inputManager.onPick=c=>{if(c&&c.block){const d=n(c.normal,c.block);this.currentColor=c.block.getFaceColor(d),this.colorInput.value=this.currentColor,this.updateColorSwatchSelection()}},this.inputManager.onPickBlock=c=>{this.pickBlock(c)},this.inputManager.onReplace=c=>{if(!c)return;const d=c.gridPosition;this.history.push(Bi(this.blockManager,c)),this.blockManager.removeBlock(c.id);const f=this.emissiveEnabled?{enabled:!0,color:this.emissiveColor,intensity:this.emissiveIntensity,radius:this.emissiveRadius}:null,m={type:this.currentBlockType,position:{x:d.x,y:d.y,z:d.z},color:this.currentColor,rotation:{x:0,y:this.currentRotation,z:0},emissive:f},x=this.blockManager.addBlock(m);x&&this.history.push(co(this.blockManager,m,x))}}findMaterialIdByColor(t){for(const e of this.textureManager.getColorMaterials())if(e.baseColor.toLowerCase()===t.toLowerCase())return e.id;return null}setupToolbar(){document.querySelectorAll(".tool").forEach(a=>{a.addEventListener("click",()=>{const l=a.dataset.tool;this.setTool(l)})}),this.generateBlockPalette(),this.setupBlockSearch(),document.getElementById("btn-rotate").addEventListener("click",()=>{this.rotateBlock()});const t=document.getElementById("btn-scale-1x"),e=document.getElementById("btn-scale-2x"),o=document.getElementById("btn-scale-4x"),i=document.getElementById("btn-scale-6x"),s=document.getElementById("btn-scale-8x"),n=[t,e,o,i,s],r=a=>{n.forEach(l=>l.classList.remove("active")),a.classList.add("active")};t.addEventListener("click",()=>{this.setBlockScale(1),r(t)}),e.addEventListener("click",()=>{this.setBlockScale(2),r(e)}),o.addEventListener("click",()=>{this.setBlockScale(4),r(o)}),i.addEventListener("click",()=>{this.setBlockScale(6),r(i)}),s.addEventListener("click",()=>{this.setBlockScale(8),r(s)})}setBlockScale(t){this.currentBlockScale=t,this.ghostBlock.setScale(t)}generateBlockPalette(){const t=document.getElementById("block-palette");if(!t)return;t.innerHTML="";const e=["decorative","details","architectural","furniture","storage","industrial","electrical","natural","modern","medieval"];for(const[o,i]of Object.entries(Gn)){const s=document.createElement("div");s.className="block-category",e.includes(o)&&s.classList.add("collapsed");const n=document.createElement("div");n.className="block-category-header",n.innerHTML=`
        <span class="arrow"></span>
        <span class="label">${i.label}</span>
        <span class="count">${i.types.length}</span>
      `,n.addEventListener("click",()=>{s.classList.toggle("collapsed")}),s.appendChild(n);const r=document.createElement("div");r.className="block-category-content";for(const a of i.types){const l=_s[a]||{icon:"?",label:a},p=document.createElement("button");p.className="block-type",p.dataset.type=a,p.title=l.label,p.textContent=l.icon,a==="cube"&&p.classList.add("active"),p.addEventListener("click",()=>{this.setBlockType(a)}),r.appendChild(p)}s.appendChild(r),t.appendChild(s)}}setupBlockSearch(){const t=document.getElementById("block-search");t&&(t.addEventListener("input",e=>{this.filterBlocks(e.target.value)}),t.addEventListener("keydown",e=>{e.key==="Escape"&&(t.value="",this.filterBlocks(""),t.blur())}))}filterBlocks(t){const e=t.toLowerCase().trim();document.querySelectorAll(".block-category").forEach(i=>{const s=i.querySelectorAll(".block-type");let n=!1;s.forEach(r=>{const a=r.dataset.type,p=(_s[a]||{label:a}).label.toLowerCase(),h=!e||a.toLowerCase().includes(e)||p.includes(e);r.classList.toggle("search-hidden",!h),h&&(n=!0)}),i.classList.toggle("search-hidden",!n),i.classList.toggle("search-match",n&&e.length>0)})}setTool(t){this.inputManager.setTool(t),document.querySelectorAll(".tool").forEach(r=>{r.classList.toggle("active",r.dataset.tool===t)}),t!=="place"&&t!=="shape"&&this.ghostBlock.hide();const e=document.getElementById("shape-section");e&&(e.style.display=t==="shape"?"":"none");const o=document.getElementById("paint-section");o&&(o.style.display=t==="paint"?"":"none");const i=document.getElementById("scatter-section");i&&(i.style.display=t==="scatter"?"":"none"),t!=="shape"&&this.clearShapeGhosts();const n={place:"Left-click: place | Alt+click: pick block | Ctrl+click: replace",delete:"Left-click: delete | Alt+click: pick block",select:"Left-click: select | Shift+click: add | +/-: keyframe | Space: play",paint:`Click+drag: ${this.paintMode==="block"?"paint block":"paint face"} | Shift+click: paint line | Alt+click: pick block`,pick:"Left-click: pick color | Alt+click: pick block",shape:"Click+drag: define shape size | Release: place blocks",scatter:"Click: generate organic structure from point"};document.getElementById("tool-hint").textContent=n[t]||""}setBlockType(t){this.currentBlockType=t,document.querySelectorAll(".block-type").forEach(e=>{e.classList.toggle("active",e.dataset.type===t)})}rotateBlock(){this.currentRotation=(this.currentRotation+90)%360;const t=this.blockManager.getSelectedBlocks();for(const e of t)e.rotateY(90);t.length>0&&this.updateSelectionUI()}setupPaintMode(){document.querySelectorAll(".paint-mode").forEach(t=>{t.addEventListener("click",()=>{this.paintMode=t.dataset.mode,document.querySelectorAll(".paint-mode").forEach(e=>{e.classList.toggle("active",e.dataset.mode===this.paintMode)}),this.setTool("paint")})})}pickBlock(t){t&&(this.setTool("place"),this.setBlockType(t.type),this.currentColor=t.color,this.colorInput.value=t.color,this.currentRotation=t.rotation.y,this.ghostBlock.setBlockType(t.type),this.ghostBlock.setColor(t.color),this.ghostBlock.setRotation(this.currentRotation))}setupShapeBrush(){document.querySelectorAll(".shape-type").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.shape;this.currentShape=e,document.querySelectorAll(".shape-type").forEach(o=>{o.classList.toggle("active",o.dataset.shape===e)})})}),this.inputManager.onShapeDrag=(t,e)=>{this.updateShapePreview(t,e)},this.inputManager.onShapePlace=(t,e)=>{this.placeShape(t,e),this.clearShapeGhosts()}}updateShapePreview(t,e){this.clearShapeGhosts();const o=$s(this.currentShape,t,e),i=500,s=o.slice(0,i),n=new gi({color:this.currentColor,transparent:!0,opacity:.4,side:Ae}),r=new bi(.95,.95,.95);s.forEach(l=>{const p=new It(r,n);p.position.set(l.x+.5,l.y+.5,l.z+.5),this.engine.scene.add(p),this.shapeGhosts.push(p)});const a=document.getElementById("tool-hint");o.length>i?a.textContent=`Shape: ${o.length} blocks (showing ${i}) | Release to place`:a.textContent=`Shape: ${o.length} blocks | Release to place`}clearShapeGhosts(){this.shapeGhosts.forEach(t=>{this.engine.scene.remove(t),t.geometry.dispose(),t.material.dispose()}),this.shapeGhosts=[]}placeShape(t,e){if(!this.canEditCurrentLayer()){this.showNotification("Layer is locked or hidden","warning");return}const o=$s(this.currentShape,t,e),i=1e3;if(o.length>i){alert(`Shape too large (${o.length} blocks). Maximum is ${i}.`);return}const s=this.emissiveEnabled?{color:this.emissiveColor,intensity:this.emissiveIntensity,radius:this.emissiveRadius}:null,n=[],r={x:0,y:this.currentRotation,z:0};if(o.forEach(a=>{if(!this.blockManager.wouldOverlapAt(this.currentBlockType,a,{w:1,h:1,d:1},null,1,r)){const l={type:this.currentBlockType,position:{...a},color:this.currentColor,rotation:{...r},layerId:this.getActiveLayerId(),emissive:s},p=this.blockManager.addBlock(l);p&&n.push(p)}}),n.length>0){const a=n.map(l=>l.id);this.history.push({undo:()=>{a.forEach(l=>this.blockManager.removeBlock(l))},redo:()=>{o.forEach(l=>{this.blockManager.wouldOverlapAt(this.currentBlockType,l,{w:1,h:1,d:1},null,1,r)||this.blockManager.addBlock({type:this.currentBlockType,position:{...l},color:this.currentColor,rotation:{...r},emissive:s})})}})}}setupScatterTool(){const t=document.getElementById("scatter-preset");Object.keys(fi).forEach(p=>{const h=document.createElement("option");h.value=p,h.textContent=fi[p].label||p,t.appendChild(h)}),t.addEventListener("change",p=>{this.scatterTool.setPreset(p.target.value)});const e=document.getElementById("scatter-algorithm");Object.keys(ni).forEach(p=>{const h=document.createElement("option");h.value=p,h.textContent=ni[p].label,h.title=ni[p].description,e.appendChild(h)}),e.addEventListener("change",p=>{this.scatterTool.setAlgorithm(p.target.value)});const o=document.getElementById("scatter-count"),i=document.getElementById("scatter-count-val");o.addEventListener("input",p=>{const h=parseInt(p.target.value);this.scatterTool.setMaxBlocks(h),i.textContent=h});const s=document.getElementById("scatter-branch"),n=document.getElementById("scatter-branch-val");s.addEventListener("input",p=>{const h=parseFloat(p.target.value);this.scatterTool.setBranchChance(h),n.textContent=Math.round(h*100)+"%"});const r=document.getElementById("scatter-scale-ratio"),a=document.getElementById("scatter-scale-ratio-val");r.addEventListener("input",p=>{const h=parseFloat(p.target.value);this.scatterTool.setScaleRatio(h);const y=Math.round((.3+h*.7)*100),c=Math.round(Math.max(0,(1-h)*.3)*100),d=100-y-c;c>0?a.textContent=`${y}% 1 / ${d}% 2 / ${c}% 4`:a.textContent=`${y}% 1 / ${d}% 2`}),document.getElementById("scatter-harmony").addEventListener("change",p=>{this.scatterTool.setColorHarmony(p.target.value)}),this.inputManager.onScatterPlace=p=>{this.executeScatter(p)}}executeScatter(t){if(!this.canEditCurrentLayer()){this.showNotification("Layer is locked or hidden","warning");return}const e=t.placementPosition,o=this.scatterTool.generate(e,{baseColor:this.currentColor});if(o.length===0){this.showNotification("No blocks generated","warning");return}const i=[],s=[];if(o.forEach(n=>{if(!this.blockManager.wouldOverlapAt(n.type,n.position,{w:1,h:1,d:1},null,n.scale,n.rotation)){const r={type:n.type,position:{...n.position},color:n.color,rotation:n.rotation,scale:n.scale,layerId:this.getActiveLayerId()},a=this.blockManager.addBlock(r);a&&(i.push(a),s.push(r))}}),i.length>0){const n=i.map(r=>r.id);this.history.push({undo:()=>{n.forEach(r=>this.blockManager.removeBlock(r))},redo:()=>{s.forEach(r=>{this.blockManager.wouldOverlapAt(r.type,r.position,{w:1,h:1,d:1},null,r.scale,r.rotation)||this.blockManager.addBlock(r)})}}),this.showNotification(`Scattered ${i.length} blocks`,"success")}}moveSelectedBlocks(t,e,o){const i=this.blockManager.getSelectedBlocks();if(i.length===0)return;const s=new Set(i.map(n=>n.id));for(const n of i){const r={x:n.gridPosition.x+t,y:n.gridPosition.y+e,z:n.gridPosition.z+o};if(this.blockManager.wouldOverlapAt(n.type,r,n.dimensions,s,n.scale||1,n.rotation||{x:0,y:0,z:0}))return}for(const n of i){const r={x:n.gridPosition.x+t,y:n.gridPosition.y+e,z:n.gridPosition.z+o};n.setPosition(r)}this.updateSelectionUI()}moveSelectedBlock(t,e,o){this.moveSelectedBlocks(t,e,o)}setupMoveControls(){document.querySelectorAll(".move-btn").forEach(t=>{t.addEventListener("click",()=>{switch(t.dataset.dir){case"up":this.moveSelectedBlock(0,0,-1);break;case"down":this.moveSelectedBlock(0,0,1);break;case"left":this.moveSelectedBlock(-1,0,0);break;case"right":this.moveSelectedBlock(1,0,0);break;case"raise":this.moveSelectedBlock(0,1,0);break;case"lower":this.moveSelectedBlock(0,-1,0);break}})})}setupColorPalette(){["#ffffff","#d0d0d0","#a0a0a0","#707070","#404040","#1a1a1a","#000000","#ffcccc","#ff6666","#e74c3c","#c0392b","#8b0000","#4a0000","#ffe0cc","#ffaa66","#e67e22","#d35400","#a04000","#602800","#ffffcc","#ffff66","#f1c40f","#d4ac0d","#b8860b","#806000","#ccffcc","#66ff66","#2ecc71","#27ae60","#1e8449","#145a32","#ccffff","#66ffff","#1abc9c","#16a085","#0e6655","#0a4a3a","#cce0ff","#66b3ff","#3498db","#2980b9","#1a5276","#0d2840","#e0ccff","#b366ff","#9b59b6","#8e44ad","#6c3483","#4a235a","#ffccee","#ff66cc","#e91e63","#c2185b","#880e4f","#4a0728","#e6d5c3","#c4a484","#a0522d","#795548","#5d4037","#3e2723","#ffd700","#c0c0c0","#cd7f32","#b87333","#4682b4","#708090"].forEach(e=>{const o=document.createElement("div");o.className="color-swatch",o.style.background=e,o.addEventListener("click",()=>{this.currentColor=e,this.colorInput.value=e,this.updateColorSwatchSelection()}),this.colorPalette.appendChild(o)}),this.colorInput.addEventListener("input",e=>{this.currentColor=e.target.value,this.updateColorSwatchSelection()}),this.updateColorSwatchSelection()}setupEmissiveControls(){const t=document.getElementById("emissive-enabled"),e=document.getElementById("emissive-color"),o=document.getElementById("emissive-intensity"),i=document.getElementById("emissive-intensity-val"),s=document.getElementById("emissive-radius"),n=document.getElementById("emissive-radius-val");t.addEventListener("change",r=>{this.emissiveEnabled=r.target.checked,this.ghostBlock.setColor(this.emissiveEnabled?this.emissiveColor:this.currentColor)}),e.addEventListener("input",r=>{this.emissiveColor=r.target.value,this.emissiveEnabled&&this.ghostBlock.setColor(this.emissiveColor)}),o.addEventListener("input",r=>{this.emissiveIntensity=parseFloat(r.target.value),i.textContent=this.emissiveIntensity.toFixed(1)}),s.addEventListener("input",r=>{this.emissiveRadius=parseFloat(r.target.value),n.textContent=this.emissiveRadius.toFixed(1)})}setupEdgeControls(){const t=document.getElementById("show-edges"),e=document.getElementById("edge-opacity");t.addEventListener("change",o=>{this.showEdges=o.target.checked,this.updateAllBlockEdges()}),e.addEventListener("input",o=>{this.edgeOpacity=parseFloat(o.target.value),this.updateAllBlockEdges()})}setupPlacementControls(){const t=document.getElementById("free-placement"),e=document.getElementById("grid-snap-increment");t.addEventListener("change",o=>{this.blockManager.freePlacementMode=o.target.checked,console.log("[Placement] Free placement mode:",o.target.checked)}),e.addEventListener("change",o=>{this.grid.snapIncrement=parseFloat(o.target.value),console.log("[Placement] Grid snap increment:",this.grid.snapIncrement)})}updateAllBlockEdges(){for(const t of this.blockManager.getAllBlocks())t.setEdgesVisible(this.showEdges),t.setEdgesOpacity(this.edgeOpacity)}setupLayerPanel(){document.getElementById("btn-add-layer").addEventListener("click",()=>{const e=prompt("Layer name:",`Layer ${this.layerManager.layers.size}`);if(e){const o=this.layerManager.generateLayerId();this.layerManager.createLayer(o,e),this.layerManager.setActiveLayer(o)}}),this.updateLayerUI()}updateLayerUI(){const t=document.getElementById("layer-list");if(!t)return;t.innerHTML="";const e=this.layerManager.getAllLayers(),o=this.layerManager.activeLayerId;e.forEach(i=>{const s=document.createElement("div");s.className="layer-item"+(i.id===o?" active":""),s.innerHTML=`
        <div class="layer-color" style="background: ${i.color}"></div>
        <span class="layer-name">${i.name}</span>
        <div class="layer-controls">
          <button class="layer-btn ${i.visible?"":"off"}" data-action="visibility" title="Toggle Visibility">
            ${i.visible?"":""}
          </button>
          <button class="layer-btn ${i.locked?"locked":""}" data-action="lock" title="Toggle Lock">
            ${i.locked?"":""}
          </button>
        </div>
      `,s.addEventListener("click",n=>{n.target.closest(".layer-btn")||this.layerManager.setActiveLayer(i.id)}),s.addEventListener("dblclick",n=>{if(n.target.closest(".layer-btn"))return;const r=prompt("Rename layer:",i.name);r&&this.layerManager.setLayerName(i.id,r)}),s.querySelector('[data-action="visibility"]').addEventListener("click",n=>{n.stopPropagation(),this.layerManager.setLayerVisible(i.id,!i.visible),this.updateBlockVisibility()}),s.querySelector('[data-action="lock"]').addEventListener("click",n=>{n.stopPropagation(),this.layerManager.setLayerLocked(i.id,!i.locked)}),t.appendChild(s)})}updateBlockVisibility(){for(const t of this.blockManager.getAllBlocks()){const e=this.layerManager.isLayerVisible(t.layerId);t.mesh.visible=e}}getActiveLayerId(){return this.layerManager.activeLayerId}canEditCurrentLayer(){return this.layerManager.canEditLayer(this.layerManager.activeLayerId)}setupSymmetryTools(){document.getElementById("btn-mirror-x").addEventListener("click",()=>{this.mirrorSelectedBlocks("x")}),document.getElementById("btn-mirror-y").addEventListener("click",()=>{this.mirrorSelectedBlocks("y")}),document.getElementById("btn-mirror-z").addEventListener("click",()=>{this.mirrorSelectedBlocks("z")})}mirrorSelectedBlocks(t){if(this.blockManager.getSelectedBlocks().length===0){this.showNotification("Select blocks to mirror","warning");return}const o=this.symmetryTool.mirrorSelectedBlocks(t,!0);if(o.length>0){this.showNotification(`Mirrored ${o.length} block(s) across ${t.toUpperCase()} axis`,"success");const i=o.map(s=>s.id);this.history.push({undo:()=>{i.forEach(s=>this.blockManager.removeBlock(s))},redo:()=>{this.symmetryTool.mirrorSelectedBlocks(t,!0)}})}else this.showNotification("Could not mirror - blocks may overlap","warning")}setupCameraBookmarks(){document.querySelectorAll(".preset-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.preset;this.cameraBookmarks.goToPreset(e)})}),document.getElementById("btn-save-view").addEventListener("click",()=>{const t=prompt("Bookmark name:",`View ${this.cameraBookmarks.bookmarks.size+1}`);t&&(this.cameraBookmarks.saveBookmark(t),this.showNotification(`View "${t}" saved`,"success"))}),this.updateCameraBookmarksUI()}updateCameraBookmarksUI(){const t=document.getElementById("camera-bookmarks");if(!t)return;t.innerHTML="",this.cameraBookmarks.getAllBookmarks().forEach(o=>{const i=document.createElement("div");i.className="bookmark-item",i.innerHTML=`
        <span class="bookmark-name">${o.name}</span>
        <button class="bookmark-delete" title="Delete">&times;</button>
      `,i.addEventListener("click",s=>{s.target.closest(".bookmark-delete")||this.cameraBookmarks.restoreBookmark(o.id)}),i.addEventListener("dblclick",s=>{if(s.target.closest(".bookmark-delete"))return;const n=prompt("Rename bookmark:",o.name);n&&this.cameraBookmarks.renameBookmark(o.id,n)}),i.querySelector(".bookmark-delete").addEventListener("click",s=>{s.stopPropagation(),this.cameraBookmarks.deleteBookmark(o.id)}),t.appendChild(i)})}setupCameraAnimation(){const t=document.getElementById("camera-anim-frames"),e=document.getElementById("camera-anim-fps"),o=document.getElementById("camera-anim-curve"),i=document.getElementById("camera-anim-duration"),s=document.getElementById("btn-camera-preview"),n=document.getElementById("btn-camera-export-jpg"),r=document.getElementById("btn-camera-export-mp4"),a=document.getElementById("camera-anim-progress"),l=document.getElementById("camera-anim-progress-bar"),p=document.getElementById("camera-anim-progress-text"),h=()=>{const y=parseInt(t.value),c=parseInt(e.value),d=(y/c).toFixed(1);i.textContent=`${d}s`};t.addEventListener("input",h),e.addEventListener("input",h),o.addEventListener("change",()=>{this.cameraPathAnimator.curveType=o.value}),s.addEventListener("click",()=>{const y=this.cameraBookmarks.getAllBookmarks();if(y.length<2){this.showNotification("Save at least 2 camera views to preview animation","warning",3e3);return}const c=parseInt(t.value),d=parseInt(e.value),f=c/d*1e3;this.showNotification("Previewing camera animation...","info",2e3),this.cameraPathAnimator.preview(y,f,()=>{this.showNotification("Preview complete","success",2e3)})}),n.addEventListener("click",async()=>{const y=this.cameraBookmarks.getAllBookmarks();if(y.length<2){this.showNotification("Save at least 2 camera views to export animation","warning",3e3);return}const c=parseInt(t.value);parseInt(e.value),n.disabled=!0,r.disabled=!0,s.disabled=!0,a.style.display="block",l.style.width="0%",p.textContent="0%";try{this.showNotification(`Rendering ${c} frames...`,"info");const d=await this.frameSequencer.captureSequence({animator:this.cameraPathAnimator,bookmarks:y,totalFrames:c,onProgress:m=>{l.style.width=`${m.percent}%`,p.textContent=`${m.percent}% (${m.current}/${m.total})`}});this.showNotification("Creating ZIP archive...","info"),await this.frameSequencer.exportAsZip(d);const f=this.frameSequencer.getMemoryUsage();this.showNotification(`Exported ${c} frames (${f}MB)`,"success",4e3),this.frameSequencer.clear()}catch(d){console.error("Export failed:",d),this.showNotification(`Export failed: ${d.message}`,"error",4e3)}finally{n.disabled=!1,r.disabled=!1,s.disabled=!1,a.style.display="none"}}),r.addEventListener("click",async()=>{const y=this.cameraBookmarks.getAllBookmarks();if(y.length<2){this.showNotification("Save at least 2 camera views to export video","warning",3e3);return}const c=parseInt(t.value),d=parseInt(e.value),f=c/d*1e3;n.disabled=!0,r.disabled=!0,s.disabled=!0,a.style.display="block",l.style.width="0%",p.textContent="Starting...";try{const m=Math.floor(f/1e3*d);this.showNotification(`Rendering ${m} frames for video...`,"info"),await this.frameSequencer.exportAsMP4Realtime(this.cameraPathAnimator,y,f,"camera_path.webm",x=>{l.style.width=`${x.percent}%`,p.textContent=`${x.percent}% (${x.current}/${x.total})`}),this.showNotification("Video exported successfully","success",3e3)}catch(m){console.error("Video export failed:",m),this.showNotification(`Video export failed: ${m.message}`,"error",4e3)}finally{n.disabled=!1,r.disabled=!1,s.disabled=!1,a.style.display="none"}})}setupTattooMode(){const t=document.getElementById("tattoo-enabled"),e=document.getElementById("gpu-acceleration"),o=document.getElementById("render-style"),i=document.getElementById("tattoo-inverted"),s=document.getElementById("tattoo-grayscale"),n=document.getElementById("tattoo-fills"),r=document.getElementById("render-quality"),a=document.getElementById("tattoo-threshold"),l=document.getElementById("tattoo-threshold-val"),p=document.getElementById("tattoo-line-width"),h=document.getElementById("tattoo-line-width-val"),y=document.getElementById("btn-tattoo-png"),c=document.getElementById("btn-tattoo-svg");(()=>{e.checked=this.useGPURenderer,t.checked=this.tattooRenderer.enabled,i.checked=this.tattooRenderer.inverted,s.checked=this.tattooRenderer.grayscale,n.checked=this.tattooRenderer.showFills,o.value=this.tattooRenderer.style,a.value=this.tattooRenderer.threshold,l.textContent=this.tattooRenderer.threshold.toFixed(2),p.value=this.tattooRenderer.lineWidth,h.textContent=this.tattooRenderer.lineWidth.toFixed(1)})(),e.addEventListener("change",m=>{const x=this.tattooRenderer.enabled;x&&this.tattooRenderer.setEnabled(!1),this.tattooRenderer.dispose&&this.tattooRenderer.dispose(),this.useGPURenderer=m.target.checked;try{this.useGPURenderer?(this.tattooRenderer=new Ks(this.engine,this.blockManager),this.showNotification("GPU acceleration enabled","success",2e3)):(this.tattooRenderer=new Eo(this.engine,this.blockManager),this.showNotification("CPU rendering enabled","info",2e3))}catch(g){console.warn("Renderer switch failed:",g),this.tattooRenderer=new Eo(this.engine,this.blockManager),e.checked=!1,this.useGPURenderer=!1,this.showNotification("GPU not available, using CPU","warning",3e3)}this.vjController&&(this.vjController.gpuRenderer=this.tattooRenderer),this.tattooRenderer.setStyle(o.value),this.tattooRenderer.setInverted(i.checked),this.tattooRenderer.setGrayscale(s.checked),this.tattooRenderer.setShowFills(n.checked),this.tattooRenderer.setQuality(r.value),this.tattooRenderer.setThreshold(parseFloat(a.value)),this.tattooRenderer.setLineWidth(parseFloat(p.value)),x&&this.tattooRenderer.setEnabled(!0)}),t.addEventListener("change",m=>{if(this.tattooRenderer.setEnabled(m.target.checked),m.target.checked){const x=this.useGPURenderer?"GPU":"CPU";this.showNotification(`Stylized view enabled (${x})`,"info",2e3)}}),o.addEventListener("change",m=>{this.tattooRenderer.setStyle(m.target.value)}),i.addEventListener("change",m=>{this.tattooRenderer.setInverted(m.target.checked)}),s.addEventListener("change",m=>{this.tattooRenderer.setGrayscale(m.target.checked)}),n.addEventListener("change",m=>{this.tattooRenderer.setShowFills(m.target.checked)}),r.addEventListener("change",m=>{this.tattooRenderer.setQuality(m.target.value)}),a.addEventListener("input",m=>{const x=parseFloat(m.target.value);this.tattooRenderer.setThreshold(x),l.textContent=x.toFixed(2)}),p.addEventListener("input",m=>{const x=parseFloat(m.target.value);this.tattooRenderer.setLineWidth(x),h.textContent=x.toFixed(1)}),y.addEventListener("click",()=>{this.tattooRenderer.capturePNG("tattoo-design.png"),this.showNotification("PNG saved","success",2e3)}),c.addEventListener("click",()=>{this.tattooRenderer.exportSVG("tattoo-design.svg"),this.showNotification("SVG exported","success",2e3)}),document.getElementById("btn-flatten").addEventListener("click",()=>{this.flattenBlocks()})}flattenBlocks(){const t=this.blockManager.getAllBlocks();if(t.length===0){this.showNotification("No blocks to flatten","warning",2e3);return}const e=t.map(i=>i.toJSON()),o=this.blockFlattener.flattenAndApply();if(o.mergedCount>0){const i=o.mergedMeshes.map(s=>s.id);this.history.push(Xa(this.blockManager,e,i)),this.showNotification(`Flattened ${o.blocksRemoved} blocks into ${o.mergedCount} merged mesh(es)`,"success",3e3),this.updateBlockCount(),this.debouncedAutoSave(),this.tattooRenderer.enabled&&this.tattooRenderer.render()}else this.showNotification("No blocks were flattened","info",2e3)}updateColorSwatchSelection(){document.querySelectorAll(".color-swatch").forEach(t=>{const e=this.rgbToHex(t.style.background);t.classList.toggle("active",e===this.currentColor.toLowerCase())})}rgbToHex(t){if(t.startsWith("#"))return t.toLowerCase();const e=t.match(/\d+/g);return e?"#"+e.slice(0,3).map(o=>{const i=parseInt(o).toString(16);return i.length===1?"0"+i:i}).join(""):t}generateColorPalette(){var p;const t=new Set;for(const h of this.blockManager.getAllBlocks())t.add(h.color.toLowerCase()),(p=h.emissive)!=null&&p.enabled&&t.add(h.emissive.color.toLowerCase());const e=Array.from(t),o=32,i=8,s=Math.ceil(e.length/i),n=i*o,r=Math.max(s*o+20,o+20),a=document.createElement("canvas");a.width=n,a.height=r;const l=a.getContext("2d");return l.fillStyle="#1a1a1a",l.fillRect(0,0,n,r),l.fillStyle="#ffffff",l.font="12px monospace",l.fillText(`Color Palette (${e.length} colors)`,4,14),e.forEach((h,y)=>{const c=y%i,d=Math.floor(y/i),f=c*o,m=20+d*o;l.fillStyle=h,l.fillRect(f+2,m+2,o-4,o-4),l.strokeStyle="#333333",l.strokeRect(f+2,m+2,o-4,o-4)}),a}updateSelectionUI(t=null){const e=this.blockManager.getSelectedBlocks(),o=e.length;if(o===0){this.selectionProps.style.display="none";return}if(this.selectionProps.style.display="block",o===1){const i=e[0];document.getElementById("prop-type").textContent=i.type,document.getElementById("prop-position").textContent=`${i.gridPosition.x}, ${i.gridPosition.y}, ${i.gridPosition.z}`,document.getElementById("prop-rotation").textContent=`${i.rotation.y}`}else document.getElementById("prop-type").textContent=`${o} blocks`,document.getElementById("prop-position").textContent="multiple",document.getElementById("prop-rotation").textContent="various";document.getElementById("btn-copy").onclick=()=>{o===1?this.clipboard=e[0].toJSON():this.clipboard=e.map(i=>i.toJSON())},document.getElementById("btn-delete-sel").onclick=()=>{this.deleteSelectedBlocks()},this.updateKeyframeMarkers()}deleteSelectedBlocks(){const t=this.blockManager.getSelectedBlocks();if(t.length!==0){for(const e of t)this.history.push(Bi(this.blockManager,e)),this.blockManager.removeBlock(e.id);this.updateSelectionUI()}}setupMenuBar(){document.getElementById("btn-new").addEventListener("click",()=>{confirm("Create new project? Unsaved changes will be lost.")&&(this.projectManager.newProject(),this.updateAnimationSelect(),this.updateLayerUI())}),document.getElementById("btn-save").addEventListener("click",()=>{this.projectManager.save()}),document.getElementById("btn-load").addEventListener("click",()=>{this.fileInput.click()}),document.getElementById("btn-clear").addEventListener("click",()=>{this.clearProject()}),this.setupTemplateMenu(),this.fileInput.addEventListener("change",async r=>{const a=r.target.files[0];if(a)try{await this.projectManager.load(a),this.updateAnimationSelect(),this.updateLayerUI(),this.updateBlockVisibility(),this.showNotification(`Project "${this.projectManager.currentProjectName}" loaded successfully`,"success")}catch{}this.fileInput.value=""}),document.getElementById("btn-export").addEventListener("click",()=>{this.showExportModal()}),this.setupExportModal(),document.getElementById("btn-bake").addEventListener("click",()=>{const r=this.blockManager.getAllBlocks().filter(f=>{var m;return(m=f.emissive)==null?void 0:m.enabled});if(r.length===0){alert('No emissive blocks found. Add blocks with "Enable Glow" checked to bake lighting.');return}console.log("Starting texture-based light bake...");const a=performance.now(),{texture:l,uvData:p,atlasWidth:h,atlasHeight:y}=this.textureBaker.bake(this.blockManager);this.bakedTexture=l,this.bakedUVData=p;const c=this.lightBaker.bake(this.blockManager);this.lightBaker.apply(this.blockManager,c);const d=(performance.now()-a).toFixed(1);console.log(`Light bake completed in ${d}ms (atlas: ${h}x${y})`),alert(`Lighting baked from ${r.length} emissive block(s) in ${d}ms.
Texture atlas: ${h}x${y}
Export to see the result in Blender/Godot.`)}),document.getElementById("btn-clear-bake").addEventListener("click",()=>{this.lightBaker.clear(this.blockManager),this.bakedTexture=null,this.bakedUVData=null,console.log("Baked lighting cleared")}),document.getElementById("btn-undo").addEventListener("click",()=>{this.history.undo()}),document.getElementById("btn-redo").addEventListener("click",()=>{this.history.redo()});const t=document.getElementById("timeline-panel"),e=document.getElementById("btn-toggle-timeline");localStorage.getItem("timelineHidden")==="true"?(t.style.display="none",e.classList.remove("active")):e.classList.add("active"),e.addEventListener("click",()=>{const r=t.style.display==="none";t.style.display=r?"":"none",e.classList.toggle("active",r),localStorage.setItem("timelineHidden",!r)});const i=document.getElementById("right-panel"),s=document.getElementById("btn-toggle-panel");localStorage.getItem("rightPanelHidden")==="true"?(i.classList.add("hidden"),s.classList.remove("active")):s.classList.add("active"),s.addEventListener("click",()=>{const r=i.classList.contains("hidden");i.classList.toggle("hidden",!r),s.classList.toggle("active",r),localStorage.setItem("rightPanelHidden",!r)}),document.getElementById("btn-about").addEventListener("click",()=>{this.showAboutModal()}),this.setupSplashScreen(),this.setupAboutModal(),this.setupCollapsibleSections()}setupSplashScreen(){const t=document.getElementById("splash-screen"),e=document.getElementById("splash-continue");localStorage.getItem("hasSeenSplash")&&(t.style.display="none"),e.addEventListener("click",()=>{t.classList.add("fade-out"),setTimeout(()=>{t.style.display="none",localStorage.setItem("hasSeenSplash","true")},500)})}setupAboutModal(){const t=document.getElementById("about-modal");document.getElementById("about-modal-close").addEventListener("click",()=>{t.style.display="none"}),t.addEventListener("click",o=>{o.target===t&&(t.style.display="none")})}showAboutModal(){const t=document.getElementById("about-modal");t.style.display="flex"}setupCollapsibleSections(){const t=document.querySelectorAll(".panel-section.collapsible"),e=JSON.parse(localStorage.getItem("collapsedSections")||"{}");t.forEach(o=>{const i=o.dataset.section,s=o.querySelector(".collapsible-header");e[i]&&o.classList.add("collapsed"),s.addEventListener("click",n=>{if(n.target.tagName==="BUTTON")return;o.classList.toggle("collapsed");const r=JSON.parse(localStorage.getItem("collapsedSections")||"{}");r[i]=o.classList.contains("collapsed"),localStorage.setItem("collapsedSections",JSON.stringify(r))})})}toggleUIVisibility(){this.uiHidden===void 0&&(this.uiHidden=!1),this.uiHidden=!this.uiHidden;const t=this.uiHidden?"none":"";["menubar","toolbar","right-panel","timeline-panel","info","vj-panel"].forEach(o=>{const i=document.getElementById(o);i&&(i.style.display=t)}),localStorage.setItem("uiHidden",this.uiHidden),this.uiHidden&&this.showNotification("UI hidden. Press U to restore.","info",3e3)}setupTimeline(){const t=document.getElementById("anim-select"),e=document.getElementById("timeline-slider"),o=document.getElementById("time-display"),i=document.getElementById("anim-loop");document.getElementById("keyframes-container");const s=document.getElementById("anim-duration"),n=document.getElementById("anim-speed"),r=document.getElementById("anim-curve");document.getElementById("btn-add-anim").addEventListener("click",()=>{const a=prompt("Animation name:","Animation");if(a){const l=parseInt(s.value)||2e3,p=this.animator.createAnimation(a,l);this.updateAnimationSelect(),t.value=p.id,this.animator.setCurrentAnimation(p.id),e.max=p.duration,this.showNotification(`Created animation "${a}"`,"success",2e3)}}),document.getElementById("btn-delete-anim").addEventListener("click",()=>{if(this.animator.currentAnimation){const a=this.animator.currentAnimation.name;confirm(`Delete animation "${a}"?`)&&(this.animator.deleteAnimation(this.animator.currentAnimation.id),this.updateAnimationSelect(),t.value="",this.updateKeyframeMarkers(),this.showNotification(`Deleted animation "${a}"`,"info",2e3))}else this.showNotification("No animation selected","warning",2e3)}),t.addEventListener("change",()=>{const a=t.value;if(a){this.animator.setCurrentAnimation(a);const l=this.animator.currentAnimation;e.max=l.duration,s.value=l.duration,i.checked=l.loop,r.value=l.curve||"easeInOut",this.updateKeyframeMarkers()}else this.animator.currentAnimation=null,this.updateKeyframeMarkers()}),s.addEventListener("change",()=>{if(this.animator.currentAnimation){const a=Math.max(100,parseInt(s.value)||2e3);s.value=a,this.animator.currentAnimation.duration=a,e.max=a,this.updateKeyframeMarkers()}}),n.addEventListener("change",()=>{this.animator.playbackSpeed=parseFloat(n.value)}),document.getElementById("btn-play").addEventListener("click",()=>{this.animator.isPlaying?this.animator.pause():this.animator.play()}),document.getElementById("btn-stop").addEventListener("click",()=>{this.animator.stop()}),i.addEventListener("change",()=>{this.animator.currentAnimation&&(this.animator.currentAnimation.loop=i.checked)}),r.addEventListener("change",()=>{this.animator.currentAnimation&&(this.animator.currentAnimation.curve=r.value)}),e.addEventListener("input",()=>{this.animator.setTime(parseInt(e.value))}),document.getElementById("btn-add-keyframe").addEventListener("click",()=>{if(this.animator.currentAnimation){const a=this.blockManager.getSelectedBlocks();if(a.length>0){const l=this.animator.addKeyframesForSelection(a);this.updateKeyframeMarkers();const p=(this.animator.currentTime/1e3).toFixed(2);this.showNotification(`Added keyframe${l>1?"s":""} for ${l} block${l>1?"s":""} at ${p}s`,"success",2e3)}else this.showNotification("Select blocks to add keyframes","warning",2e3)}else this.showNotification("Create an animation first","warning",2e3)}),document.getElementById("btn-remove-keyframe").addEventListener("click",()=>{if(this.animator.currentAnimation){const a=this.blockManager.getSelectedBlocks();if(a.length>0){const l=a.map(h=>h.id),p=this.animator.removeKeyframesForSelection(l);if(this.updateKeyframeMarkers(),p>0){const h=(this.animator.currentTime/1e3).toFixed(2);this.showNotification(`Removed ${p} keyframe${p>1?"s":""} at ${h}s`,"info",2e3)}else this.showNotification("No keyframes at current time for selected blocks","warning",2e3)}else this.showNotification("Select blocks to remove keyframes","warning",2e3)}}),this.animator.onTimeUpdate=a=>{e.value=a,o.textContent=(a/1e3).toFixed(2)+"s"},this.animator.onPlayStateChange=a=>{document.getElementById("btn-play").textContent=a?"":""}}updateAnimationSelect(){const t=document.getElementById("anim-select");t.innerHTML='<option value="">-- No Animation --</option>';for(const e of this.animator.getAllAnimations()){const o=document.createElement("option");o.value=e.id,o.textContent=e.name,t.appendChild(o)}}updateKeyframeMarkers(){const t=document.getElementById("keyframes-container");if(t.innerHTML="",!this.animator.currentAnimation)return;const e=this.animator.currentAnimation.duration,o=this.animator.currentAnimation.keyframes,i=new Set(this.blockManager.getSelectedBlocks().map(n=>n.id)),s=new Map;for(const n of o){s.has(n.time)||s.set(n.time,{total:0,selected:0});const r=s.get(n.time);r.total++,i.has(n.blockId)&&r.selected++}for(const[n,r]of s){const a=document.createElement("div");a.className="keyframe-marker",r.selected>0&&a.classList.add("selected"),a.style.left=`${n/e*100}%`,a.title=`${n}ms - ${r.total} block${r.total>1?"s":""}${r.selected>0?` (${r.selected} selected)`:""}`,a.addEventListener("click",()=>{this.animator.setTime(n)}),t.appendChild(a)}}setupVJ(){const t=document.getElementById("btn-vj"),e=document.getElementById("vj-panel"),o=document.getElementById("vj-preset"),i=document.getElementById("vj-camera-mode"),s=document.getElementById("vj-gain"),n=document.getElementById("vj-sensitivity"),r=document.getElementById("vj-meter-bar"),a=document.getElementById("vj-overlay-meter-bar"),l=document.getElementById("vj-block-distort"),p=document.getElementById("vj-block-distort-val"),h=document.getElementById("vj-vertex-distort"),y=document.getElementById("vj-vertex-distort-val"),c=document.getElementById("vj-reactivity"),d=document.getElementById("vj-reactivity-val"),f=document.getElementById("vj-fullscreen"),m=document.getElementById("vj-exit-fullscreen"),x=document.getElementById("vj-style-name"),g=document.getElementById("vj-camera-name"),b=document.getElementById("vj-preset-name");document.getElementById("toolbar");const z=document.getElementById("timeline-panel");t.addEventListener("click",async()=>{if(this.vjController.active)this.vjController.stop(),t.classList.remove("active"),e.style.display="none",z.style.display="",this.grid.gridGroup.visible=!0,this.showNotification("VJ Mode stopped","info",2e3);else try{if(!this.tattooRenderer.enabled){this.tattooRenderer.setEnabled(!0);const R=document.getElementById("tattoo-enabled");R&&(R.checked=!0)}await this.vjController.start(),t.classList.add("active"),e.style.display="",z.style.display="none",this.grid.gridGroup.visible=!1,this.showNotification("VJ Mode started  use mic audio","success",3e3)}catch(R){console.error("VJ start failed:",R),this.showNotification("VJ Mode failed: "+R.message,"error",4e3)}}),o.addEventListener("change",R=>{this.vjController.setPreset(R.target.value)}),i.addEventListener("change",R=>{this.vjController.setCameraMode(R.target.value)}),s.addEventListener("input",R=>{this.vjController.audioReactor.setGain(parseFloat(R.target.value))}),n.addEventListener("input",R=>{this.vjController.audioReactor.setSensitivity(parseFloat(R.target.value))}),l.addEventListener("input",R=>{const N=parseFloat(R.target.value);this.vjController.meshReactor.setBlockDistortion(N),p.textContent=N.toFixed(2)}),h.addEventListener("input",R=>{const N=parseFloat(R.target.value);this.vjController.meshReactor.setVertexDistortion(N),y.textContent=N.toFixed(2)}),document.getElementById("vj-movement-mode").addEventListener("change",R=>{this.vjController.meshReactor.setMovementMode(R.target.value)});const C=document.getElementById("vj-color-react"),B=document.getElementById("vj-color-react-val");C.addEventListener("input",R=>{const N=parseFloat(R.target.value);this.vjController.meshReactor.setColorReactivity(N),B.textContent=N.toFixed(2)});const A=document.getElementById("vj-scene-folder"),M=document.getElementById("vj-load-scenes"),S=document.getElementById("vj-scene-label"),P=document.getElementById("vj-scene-index"),k=document.getElementById("vj-scene-prev"),D=document.getElementById("vj-scene-next");this.vjController._layerManager=this.layerManager,M.addEventListener("click",()=>A.click()),A.addEventListener("change",async R=>{const N=await this.vjController.sceneBank.loadFolder(R.target.files);S.textContent=`${N} scene${N!==1?"s":""}`,P.textContent=(N>0,"-"),N>0?this.showNotification(`Loaded ${N} scene${N!==1?"s":""}`,"success",2e3):this.showNotification("No valid .blocks files found","warning",3e3)}),this.vjController.sceneBank.onSceneChange=(R,N,it)=>{P.textContent=`${R+1}/${it}`,S.textContent=N,this.vjController.meshReactor.enabled&&this.vjController.meshReactor.setEnabled(!0),this.vjController.particleSpawner.updateSceneBounds(this.blockManager),this.updateBlockCount()},k.addEventListener("click",()=>{this.vjController.sceneBank.previous(this.blockManager,this.layerManager)}),D.addEventListener("click",()=>{this.vjController.sceneBank.next(this.blockManager,this.layerManager)});const F=document.getElementById("vj-block-spawn-enabled"),T=document.getElementById("vj-block-spawn-rate"),K=document.getElementById("vj-block-spawn-rate-val"),G=document.getElementById("vj-block-spawn-radius"),rt=document.getElementById("vj-block-spawn-radius-val");F.addEventListener("change",R=>{this.vjController.audioBlockSpawner.setEnabled(R.target.checked),T.disabled=!R.target.checked,G.disabled=!R.target.checked,R.target.checked&&this.vjController.audioBlockSpawner.updateSpawnCenter()}),T.addEventListener("input",R=>{const N=parseInt(R.target.value);this.vjController.audioBlockSpawner.setSpawnRate(N),K.textContent=N}),G.addEventListener("input",R=>{const N=parseInt(R.target.value);this.vjController.audioBlockSpawner.setSpawnRadius(N),rt.textContent=N});const $=document.getElementById("vj-generative-enabled"),et=document.getElementById("vj-generative-clear"),j=document.getElementById("vj-gen-rate"),O=document.getElementById("vj-gen-rate-val"),tt=document.getElementById("vj-gen-ttl"),Q=document.getElementById("vj-gen-ttl-val");$.addEventListener("change",R=>{const N=this.vjController.audioGenerative;R.target.checked?(N.initFromScene(this.blockManager),N.setEnabled(!0)):N.setEnabled(!1)}),et.addEventListener("click",()=>{this.vjController.audioGenerative.clear()}),j.addEventListener("input",R=>{const N=parseInt(R.target.value);this.vjController.audioGenerative.setGrowthRate(N),O.textContent=N}),tt.addEventListener("input",R=>{const N=parseInt(R.target.value);this.vjController.audioGenerative.setTTL(N),Q.textContent=N+"s"});const W=document.getElementById("vj-paint-enabled"),ut=document.getElementById("vj-paint-density"),Bt=document.getElementById("vj-paint-density-val"),lt=document.getElementById("vj-paint-preset"),ht=document.getElementById("vj-paint-algorithm"),gt=document.getElementById("vj-paint-lifetime"),mt=document.getElementById("vj-paint-lifetime-val"),Pt=document.getElementById("vj-paint-decay");W.addEventListener("change",R=>{const N=R.target.checked;this.vjController.setGenerativePaintEnabled(N),ut.disabled=!N,lt.disabled=!N,ht.disabled=!N,gt.disabled=!N,Pt.disabled=!N}),ut.addEventListener("input",R=>{const N=parseInt(R.target.value);this.vjController.setGenerativePaintDensity(N),Bt.textContent=N}),lt.addEventListener("change",R=>{this.vjController.setGenerativePreset(R.target.value)}),ht.addEventListener("change",R=>{this.vjController.setGenerativeAlgorithm(R.target.value)}),gt.addEventListener("input",R=>{const N=parseInt(R.target.value);this.vjController.setEphemeralLifetime(N),mt.textContent=N+"s"}),Pt.addEventListener("change",R=>{this.vjController.setEphemeralDecayMode(R.target.value)}),c.addEventListener("input",R=>{const N=parseFloat(R.target.value);this.vjController.reactivity=N,d.textContent=N.toFixed(1)});const bt={bloom:document.getElementById("vj-effect-bloom"),feedback:document.getElementById("vj-effect-feedback"),chromatic:document.getElementById("vj-effect-chromatic"),glitch:document.getElementById("vj-effect-glitch"),hueshift:document.getElementById("vj-effect-hueshift"),vignette:document.getElementById("vj-effect-vignette"),kaleidoscope:document.getElementById("vj-effect-kaleidoscope"),mirror:document.getElementById("vj-effect-mirror"),pixelate:document.getElementById("vj-effect-pixelate"),rgbsplit:document.getElementById("vj-effect-rgbsplit"),invert:document.getElementById("vj-effect-invert")},w=document.getElementById("vj-bloom-strength"),Y=document.getElementById("vj-bloom-val"),Z=document.getElementById("vj-feedback-amount"),_=document.getElementById("vj-feedback-val"),E=document.getElementById("vj-kaleidoscope-segments"),I=document.getElementById("vj-kaleidoscope-val"),V=document.getElementById("vj-pixelate-size"),H=document.getElementById("vj-pixelate-val"),U=(R,N)=>{const it=this.vjController;if(!it.vjPasses||!it.vjPassesActive)return;const dt={bloom:"bloom",feedback:"feedback",chromatic:"chromatic",glitch:"glitch",hueshift:"hueShift",vignette:"vignette",kaleidoscope:"kaleidoscope",mirror:"mirror",pixelate:"pixelate",rgbsplit:"rgbSplit",invert:"invert"},ct=it.vjPasses[dt[R]];ct&&(ct.enabled=N)};bt.bloom.addEventListener("change",R=>{if(U("bloom",R.target.checked),w.disabled=!R.target.checked,R.target.checked&&this.vjController.vjPasses.bloom){const N=parseFloat(w.value);this.vjController.vjPasses.bloom.strength=N>0?N:1,N===0&&(w.value=1,Y.textContent="1.0")}else this.vjController.vjPasses.bloom&&(this.vjController.vjPasses.bloom.strength=0)}),w.addEventListener("input",R=>{const N=parseFloat(R.target.value);this.vjController.vjPasses.bloom&&(this.vjController.vjPasses.bloom.strength=N),Y.textContent=N.toFixed(1)}),bt.feedback.addEventListener("change",R=>{if(U("feedback",R.target.checked),Z.disabled=!R.target.checked,R.target.checked&&this.vjController.vjPasses.feedback){const N=parseFloat(Z.value);this.vjController.vjPasses.feedback.uniforms.uFeedback.value=N>0?N:.5,N===0&&(Z.value=.5,_.textContent="0.50")}else this.vjController.vjPasses.feedback&&(this.vjController.vjPasses.feedback.uniforms.uFeedback.value=0)}),Z.addEventListener("input",R=>{const N=parseFloat(R.target.value);this.vjController.vjPasses.feedback&&(this.vjController.vjPasses.feedback.uniforms.uFeedback.value=N),_.textContent=N.toFixed(2)}),bt.kaleidoscope.addEventListener("change",R=>{U("kaleidoscope",R.target.checked),E.disabled=!R.target.checked}),E.addEventListener("input",R=>{const N=parseInt(R.target.value);this.vjController.vjPasses.kaleidoscope&&(this.vjController.vjPasses.kaleidoscope.uniforms.uSegments.value=N),I.textContent=N}),bt.pixelate.addEventListener("change",R=>{U("pixelate",R.target.checked),V.disabled=!R.target.checked,!R.target.checked&&this.vjController.vjPasses.pixelate&&(this.vjController.vjPasses.pixelate.uniforms.uPixelSize.value=1)}),V.addEventListener("input",R=>{const N=parseInt(R.target.value);this.vjController.vjPasses.pixelate&&(this.vjController.vjPasses.pixelate.uniforms.uPixelSize.value=N),H.textContent=N}),bt.chromatic.addEventListener("change",R=>{U("chromatic",R.target.checked),R.target.checked&&this.vjController.vjPasses.chromatic?this.vjController.vjPasses.chromatic.uniforms.uAmount.value=.005:this.vjController.vjPasses.chromatic&&(this.vjController.vjPasses.chromatic.uniforms.uAmount.value=0)}),bt.glitch.addEventListener("change",R=>{U("glitch",R.target.checked),R.target.checked&&this.vjController.vjPasses.glitch?this.vjController.vjPasses.glitch.uniforms.uGlitch.value=.3:this.vjController.vjPasses.glitch&&(this.vjController.vjPasses.glitch.uniforms.uGlitch.value=0)}),bt.hueshift.addEventListener("change",R=>{U("hueshift",R.target.checked),R.target.checked&&this.vjController.vjPasses.hueShift?this.vjController.vjPasses.hueShift.uniforms.uShift.value=.5:this.vjController.vjPasses.hueShift&&(this.vjController.vjPasses.hueShift.uniforms.uShift.value=0)}),bt.vignette.addEventListener("change",R=>{U("vignette",R.target.checked),R.target.checked&&this.vjController.vjPasses.vignette?this.vjController.vjPasses.vignette.uniforms.uIntensity.value=.6:this.vjController.vjPasses.vignette&&(this.vjController.vjPasses.vignette.uniforms.uIntensity.value=0)}),bt.mirror.addEventListener("change",R=>{U("mirror",R.target.checked),R.target.checked&&this.vjController.vjPasses.mirror?this.vjController.vjPasses.mirror.uniforms.uMode.value=3:this.vjController.vjPasses.mirror&&(this.vjController.vjPasses.mirror.uniforms.uMode.value=0)}),bt.rgbsplit.addEventListener("change",R=>{U("rgbsplit",R.target.checked),R.target.checked&&this.vjController.vjPasses.rgbSplit?this.vjController.vjPasses.rgbSplit.uniforms.uAmount.value=.01:this.vjController.vjPasses.rgbSplit&&(this.vjController.vjPasses.rgbSplit.uniforms.uAmount.value=0)}),bt.invert.addEventListener("change",R=>{U("invert",R.target.checked),R.target.checked&&this.vjController.vjPasses.invert?this.vjController.vjPasses.invert.uniforms.uAmount.value=1:this.vjController.vjPasses.invert&&(this.vjController.vjPasses.invert.uniforms.uAmount.value=0)}),f.addEventListener("click",()=>{this.vjController.enterPerformanceMode()}),m.addEventListener("click",()=>{this.vjController.exitPerformanceMode()}),this._vjMeterBar=r,this._vjOverlayMeterBar=a,this._vjStyleNameEl=x,this._vjCameraNameEl=g,this._vjPresetNameEl=b,this.vjController.onStateChange=R=>{t.classList.toggle("active",R),e.style.display=R?"":"none",z.style.display=R?"none":"",this.grid.gridGroup.visible=!R};const q=document.getElementById("render-style");q&&q.addEventListener("change",()=>{this.vjController.active&&setTimeout(()=>this.vjController.onStyleChanged(),50)})}setupKeyboardShortcuts(){window.addEventListener("keydown",t=>{if(!(t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA")){switch(t.key.toLowerCase()){case"1":this.setTool("place");break;case"2":this.setTool("delete");break;case"3":this.setTool("select");break;case"4":this.setTool("paint");break;case"5":this.setTool("pick");break;case"6":this.setTool("shape");break;case"r":this.rotateBlock();break;case"u":this.toggleUIVisibility();break;case"p":document.getElementById("btn-toggle-panel").click();break;case"z":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.history.undo());break;case"y":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.history.redo());break;case"c":if((t.ctrlKey||t.metaKey)&&this.blockManager.getSelectionCount()>0){const e=this.blockManager.getSelectedBlocks();e.length===1?this.clipboard=e[0].toJSON():this.clipboard=e.map(o=>o.toJSON())}break;case"v":if((t.ctrlKey||t.metaKey)&&this.clipboard)if(Array.isArray(this.clipboard))for(const e of this.clipboard){const o={...e};o.position={x:o.position.x+1,y:o.position.y,z:o.position.z+1},delete o.id;const i=this.blockManager.addBlock(o);i&&this.history.push(co(this.blockManager,o,i))}else{const e={...this.clipboard};e.position={x:e.position.x+1,y:e.position.y,z:e.position.z+1},delete e.id;const o=this.blockManager.addBlock(e);o&&this.history.push(co(this.blockManager,e,o))}break;case"delete":case"backspace":this.blockManager.getSelectionCount()>0&&(t.preventDefault(),this.deleteSelectedBlocks());break;case" ":t.preventDefault(),this.animator.currentAnimation&&(this.animator.isPlaying?this.animator.pause():this.animator.play());break;case"k":case"+":case"=":if(this.animator.currentAnimation){const e=this.blockManager.getSelectedBlocks();if(e.length>0){const o=this.animator.addKeyframesForSelection(e);this.updateKeyframeMarkers();const i=(this.animator.currentTime/1e3).toFixed(2);this.showNotification(`Added keyframe${o>1?"s":""} for ${o} block${o>1?"s":""} at ${i}s`,"success",2e3)}else this.showNotification("Select blocks to add keyframes","warning",2e3)}else this.showNotification("Create an animation first (+ Anim button)","warning",2e3);break;case"-":case"_":if(this.animator.currentAnimation){const e=this.blockManager.getSelectedBlocks();if(e.length>0){const o=e.map(s=>s.id),i=this.animator.removeKeyframesForSelection(o);if(this.updateKeyframeMarkers(),i>0){const s=(this.animator.currentTime/1e3).toFixed(2);this.showNotification(`Removed ${i} keyframe${i>1?"s":""} at ${s}s`,"info",2e3)}else this.showNotification("No keyframes at current time for selected blocks","warning",2e3)}else this.showNotification("Select blocks to remove keyframes","warning",2e3)}break}switch(t.key){case"ArrowUp":t.preventDefault(),this.moveSelectedBlock(0,0,-1);break;case"ArrowDown":t.preventDefault(),this.moveSelectedBlock(0,0,1);break;case"ArrowLeft":t.preventDefault(),this.moveSelectedBlock(-1,0,0);break;case"ArrowRight":t.preventDefault(),this.moveSelectedBlock(1,0,0);break;case"PageUp":t.preventDefault(),this.moveSelectedBlock(0,1,0);break;case"PageDown":t.preventDefault(),this.moveSelectedBlock(0,-1,0);break}}})}autoSave(){try{const t=this.engine.camera,e=this.engine.controls.target,o={blocks:this.blockManager.toJSON(),animations:this.animator.toJSON(),layers:this.layerManager.toJSON(),cameraBookmarks:this.cameraBookmarks.toJSON(),currentColor:this.currentColor,currentBlockType:this.currentBlockType,currentRotation:this.currentRotation,camera:{position:{x:t.position.x,y:t.position.y,z:t.position.z},target:{x:e.x,y:e.y,z:e.z}}};localStorage.setItem("blocksProject",JSON.stringify(o))}catch(t){console.warn("Auto-save failed:",t)}}autoLoad(){try{const t=localStorage.getItem("blocksProject");if(!t)return;const e=JSON.parse(t);if(e.layers&&(this.layerManager.fromJSON(e.layers),this.updateLayerUI()),e.blocks&&e.blocks.length>0&&(this.blockManager.fromJSON(e.blocks),this.updateBlockVisibility()),e.animations&&(this.animator.fromJSON(e.animations),this.updateAnimationSelect()),e.cameraBookmarks&&(this.cameraBookmarks.fromJSON(e.cameraBookmarks),this.updateCameraBookmarksUI()),e.currentColor&&(this.currentColor=e.currentColor,this.colorInput.value=e.currentColor),e.currentBlockType&&(this.currentBlockType=e.currentBlockType,this.setBlockType(e.currentBlockType)),e.currentRotation!==void 0&&(this.currentRotation=e.currentRotation),e.camera){const o=e.camera.position,i=e.camera.target;o&&this.engine.camera.position.set(o.x,o.y,o.z),i&&this.engine.controls.target.set(i.x,i.y,i.z),this.engine.controls.update()}console.log("Project loaded from localStorage")}catch(t){console.warn("Auto-load failed:",t)}}showNotification(t,e="info",o=5e3){if(!this.notificationsEl)return;const i={info:"i",success:"",warning:"!",error:""},s=document.createElement("div");return s.className=`notification ${e}`,s.innerHTML=`
      <span class="icon">${i[e]||i.info}</span>
      <span class="message">${t}</span>
      <button class="close-btn">&times;</button>
    `,s.querySelector(".close-btn").addEventListener("click",()=>{this.dismissNotification(s)}),this.notificationsEl.appendChild(s),o>0&&setTimeout(()=>{this.dismissNotification(s)},o),s}dismissNotification(t){!t||!t.parentNode||(t.classList.add("fade-out"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))}clearProject(){confirm("Clear all blocks? This cannot be undone.")&&(this.blockManager.clear(),this.animator.clear(),this.layerManager.clear(),this.cameraBookmarks.clear(),this.history.clear(),localStorage.removeItem("blocksProject"),this.updateAnimationSelect(),this.updateLayerUI(),this.updateCameraBookmarksUI(),this.updateSelectionUI(null))}setupTemplateMenu(){const t=document.getElementById("templates-modal"),e=document.getElementById("templates-list");bl().forEach((i,s)=>{const n=document.createElement("div");n.className="template-category",s>2&&n.classList.add("collapsed");const r=document.createElement("div");r.className="template-category-header",r.innerHTML=`
        <span class="arrow"></span>
        <span class="label">${i.label}</span>
        <span class="count">${i.templates.length}</span>
      `,r.addEventListener("click",()=>{n.classList.toggle("collapsed")}),n.appendChild(r);const a=document.createElement("div");a.className="template-category-content",i.templates.forEach(l=>{const p=document.createElement("button");p.className="template-item",p.innerHTML=`
          <span class="template-name">${l.name}</span>
          <span class="template-desc">${l.description}</span>
        `,p.addEventListener("click",()=>{this.loadTemplate(l.id),this.hideTemplatesModal()}),a.appendChild(p)}),n.appendChild(a),e.appendChild(n)}),document.getElementById("btn-templates").addEventListener("click",()=>{this.showTemplatesModal()}),document.getElementById("templates-modal-close").addEventListener("click",()=>{this.hideTemplatesModal()}),t.addEventListener("click",i=>{i.target===t&&this.hideTemplatesModal()})}showTemplatesModal(){document.getElementById("templates-modal").style.display="flex"}hideTemplatesModal(){document.getElementById("templates-modal").style.display="none"}loadTemplate(t){const e=zl(t);if(!e)return;(this.blockManager.getBlockCount()>0?confirm(`Add "${e.name}" to existing blocks?

Click OK to add, Cancel to replace all.`):!1)||(this.blockManager.clear(),this.history.clear());let i=0;for(const s of e.blocks){const n={type:s.type||"cube",position:{...s.position},color:s.color||this.currentColor,rotation:s.rotation||{x:0,y:0,z:0},emissive:s.emissive||null};this.blockManager.wouldOverlapAt(n.type,n.position,{w:1,h:1,d:1},null,1,n.rotation)||this.blockManager.addBlock(n)&&i++}console.log(`Placed ${i}/${e.blocks.length} blocks from template "${e.name}"`)}showExportModal(){const t=document.getElementById("export-modal");t.style.display="flex",this.updateExportStats()}hideExportModal(){const t=document.getElementById("export-modal");t.style.display="none"}updateExportStats(){const t=document.getElementById("opt-face-cull").checked,e=document.getElementById("opt-merge-cubes").checked,o=this.exporter.getOptimizationStats(this.blockManager,{cullFaces:t,mergeCubes:e});document.getElementById("stat-blocks").textContent=o.blockCount,document.getElementById("stat-faces").textContent=o.originalFaces,document.getElementById("stat-optimized").textContent=`${o.optimizedFaces} (-${o.reduction}%)`}setupExportModal(){const t=document.getElementById("export-modal");document.getElementById("export-modal-close").addEventListener("click",()=>{this.hideExportModal()}),document.getElementById("export-cancel").addEventListener("click",()=>{this.hideExportModal()}),t.addEventListener("click",e=>{e.target===t&&this.hideExportModal()}),document.getElementById("opt-face-cull").addEventListener("change",()=>{this.updateExportStats()}),document.getElementById("opt-merge-cubes").addEventListener("change",()=>{this.updateExportStats()}),document.getElementById("export-confirm").addEventListener("click",async()=>{await this.performExport()})}async performExport(){const t=document.querySelector('input[name="export-format"][value="glb"]').checked,e=document.getElementById("opt-face-cull").checked,o=document.getElementById("opt-merge-cubes").checked,i=document.getElementById("opt-material-batch").checked,s=document.getElementById("opt-deduplicate").checked,n=document.getElementById("opt-merge-all").checked,r=document.getElementById("opt-instancing").checked,a=document.getElementById("inc-animations").checked,l=document.getElementById("inc-baked-lighting").checked,p=document.getElementById("dbg-lightmap").checked,h=document.getElementById("dbg-colors").checked,y=document.getElementById("dbg-palette").checked,c=document.getElementById("dbg-json").checked,d=document.getElementById("export-confirm"),f=d.textContent;d.textContent="Exporting...",d.disabled=!0;try{const m=await this.exporter.exportScene(this.blockManager,{binary:t,includeAnimations:a,animator:this.animator,bakedTexture:l?this.bakedTexture:null,uvData:l?this.bakedUVData:null,cullFaces:e,mergeCubes:o,batchMaterials:i,deduplicateVertices:s,mergeAll:n,useInstancing:r}),x=t?"model.glb":"model.gltf";if(this.exporter.downloadFile(m,x,t),c&&t){const g=await this.exporter.exportScene(this.blockManager,{binary:!1,includeAnimations:a,animator:this.animator,bakedTexture:l?this.bakedTexture:null,uvData:l?this.bakedUVData:null});this.exporter.downloadFile(g,"model.gltf",!1)}if(p&&this.bakedTexture&&this.lightBaker.downloadCanvasAsPNG(this.bakedTexture,"baked_lightmap.png"),h){const g=this.lightBaker.generateDebugTexture(this.blockManager);this.lightBaker.downloadCanvasAsPNG(g,"debug_colors.png")}if(y){const g=this.generateColorPalette();this.lightBaker.downloadCanvasAsPNG(g,"color_palette.png")}console.log("Export completed successfully"),this.hideExportModal(),this.showNotification("Export completed successfully","success")}catch(m){this.showNotification("Export failed: "+m.message,"error"),console.error("Export error:",m)}finally{d.textContent=f,d.disabled=!1}}}const F0=new v0;window.appInstance=F0;
